<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.24.7"/><style data-href="/styles.178380a10784f7949ccc.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-cyrillic-ext-400-normal-80c010be16bde8b7e613a74066e2b9ef.woff2) format("woff2"),url(/static/ubuntu-all-400-normal-8629f83ad2c45e75a914dd97fd21746d.woff) format("woff");unicode-range:u+0460-052f,u+1c80-1c88,u+20b4,u+2de0-2dff,u+a640-a69f,u+fe2e-fe2f}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-cyrillic-400-normal-5baf1f37de97e50ab654c46ecdfa687b.woff2) format("woff2"),url(/static/ubuntu-all-400-normal-8629f83ad2c45e75a914dd97fd21746d.woff) format("woff");unicode-range:u+0301,u+0400-045f,u+0490-0491,u+04b0-04b1,u+2116}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-greek-ext-400-normal-7f5049065c02fb5e06282aeab839cbb2.woff2) format("woff2"),url(/static/ubuntu-all-400-normal-8629f83ad2c45e75a914dd97fd21746d.woff) format("woff");unicode-range:u+1f??}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-greek-400-normal-038ee74fde7a2c872ee2f9a62edb69d8.woff2) format("woff2"),url(/static/ubuntu-all-400-normal-8629f83ad2c45e75a914dd97fd21746d.woff) format("woff");unicode-range:u+0370-03ff}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-latin-ext-400-normal-9967dbf10fc3cb92edfb247472a17ec0.woff2) format("woff2"),url(/static/ubuntu-all-400-normal-8629f83ad2c45e75a914dd97fd21746d.woff) format("woff");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-latin-400-normal-2f02effe392a63dc07a5cdf187b2ef09.woff2) format("woff2"),url(/static/ubuntu-all-400-normal-8629f83ad2c45e75a914dd97fd21746d.woff) format("woff");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,d09GMgABAAAAAAOwABAAAAAAB1wAAANVAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGhQbIBwqBmA/U1RBVF4ARBEICoMggmsLEAABNgIkAxAEIAWFAAcgDAcbAwZILgpsm7F1KvWgWakUD5ozK/4WXcgHEY2ls3sXBL5PicmRZXaVaWSBVWQB0Abcw9Vc7s9bIot8cY+sgAsUwMtcNoXxFbIVur6hqN0evmrGTRQYZVKR5lfh//xfUy9KD/xuFYDDoUWlyD4trAJobwZRZdOjBdBGNqGp0w2lzLMwqwQNpYQdMjlHgEgAQFAEQYBw4iWS0WM3e/AAYAECASBAOKnSKbM6tFegATEAoQD0fKsL5SRBoId1PsCkOFiWQnKAQhiupvyJiQuAx7bP/jde/yswXqnMRW58fQtarB+AXEEIQigKJDJAId23TkIXsOE+a64YhGDSlVNAxcpJkKWAPAUM9ut9BMviWAAEAAWMwC6RttTCwdMEtbfs/0DYPvuv+UFJh0LCYqa8Y6AYAEIAiAYigB2Aa0AkkAjA8D5mPApijYmJCQuLDwtLiAiKsiujglZv8kSYhRELLl1LunAjY1HEfF1x+I2YQ28jjrxGD756NffIW5FwDr5eGCGH3oQffsUrjUGiM42pQMyNzWlprefSJeS7cqX67MVcnw9L6io7egLl9koCcR8HlpysuP0iJf7j9rGKJSA1Dipm5TbzZXny0ZdxznJIli4hbmq7a5T7HjTojeqeP4iu29vR0TwOEm3cUlK/1PPjIUsubZy75xoWu1/H5SiuB+pulx8ucT2jekaGC3qAt6P9WBP/v/O06G6f9vG3Pwl15/Y61G4QdNBghPB+wVAKKIA26Qc6/0YztRgBtNmuTNcby/ydI6HG/AP4+OLmZYCPH54NbvO/sqeNFwSjAAj8N4/tJyjfiSYIniw6n6u0xRfq9M8JECK32cohOHOYQYFIzmMQGwbchzsrZLrPKtG8Yw2d/rCWyvLZINKbygZT3nommuZOSwlEykDYUuuVmCf81W2xhMs3RqFMXxiZSIIS6tWOaK7ZEOa5m4iHRphnMoMlYQrKQCVMx1AK3iuU4GFDEorR9tLqKDJBdkuNGuvI1HdsL2pWoXR1UX5sUjdenCy6xe/KNs0zhgjXq1Ono9WRdnWNar7wrVaiZx/xGIvMhBPUJVLm/q74Lq8LAk3IUhN4aXH1NoyobpqZjRN+iT9qCT3TyF5tUbpnBjcABNZAgODgbQnot8cAAAA=) format("woff2"),url(/static/jetbrains-mono-all-400-normal-2346733ac7062d6402c0c859ccbf227e.woff) format("woff");unicode-range:u+0460-052f,u+1c80-1c88,u+20b4,u+2de0-2dff,u+a640-a69f,u+fe2e-fe2f}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(/static/jetbrains-mono-all-400-normal-2346733ac7062d6402c0c859ccbf227e.woff) format("woff");unicode-range:u+0301,u+0400-045f,u+0490-0491,u+04b0-04b1,u+2116}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(/static/jetbrains-mono-all-400-normal-2346733ac7062d6402c0c859ccbf227e.woff) format("woff");unicode-range:u+0370-03ff}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(/static/jetbrains-mono-all-400-normal-2346733ac7062d6402c0c859ccbf227e.woff) format("woff");unicode-range:u+0102-0103,u+0110-0111,u+0128-0129,u+0168-0169,u+01a0-01a1,u+01af-01b0,u+1ea0-1ef9,u+20ab}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(/static/jetbrains-mono-all-400-normal-2346733ac7062d6402c0c859ccbf227e.woff) format("woff");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(/static/jetbrains-mono-latin-400-normal-d0b41bd1d599bc0a52b733fd39c8cc06.woff2) format("woff2"),url(/static/jetbrains-mono-all-400-normal-2346733ac7062d6402c0c859ccbf227e.woff) format("woff");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@media (prefers-color-scheme:light){code[class*=language-],pre[class*=language-]{background:#fafafa;color:#383a42;direction:ltr;font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#e5e5e6;color:inherit}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#e5e5e6;color:inherit}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.2em .3em;white-space:normal}.token.cdata,.token.comment,.token.prolog{color:#a0a1a7}.token.doctype,.token.entity,.token.punctuation{color:#383a42}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#b76b01}.token.keyword{color:#a626a4}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e45649}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#50a14f}.token.function,.token.operator,.token.variable{color:#4078f2}.token.url{color:#0184bc}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#383a42}.language-css .token.selector{color:#e45649}.language-css .token.property{color:#383a42}.language-css .token.function,.language-css .token.url>.token.function{color:#0184bc}.language-css .token.url>.token.string.url{color:#50a14f}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#a626a4}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#ca1243}.language-json .token.operator{color:#383a42}.language-json .token.null.keyword{color:#b76b01}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#383a42}.language-markdown .token.url>.token.content{color:#4078f2}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#0184bc}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#a0a1a7;font-style:italic}.language-markdown .token.code-snippet{color:#50a14f}.language-markdown .token.bold .token.content{color:#b76b01}.language-markdown .token.italic .token.content{color:#a626a4}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e45649}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(56,58,66,.2)}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#e5e5e6;border-radius:.3em;color:#696c77;padding:.1em .4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#c6c7c7;color:#383a42}.line-highlight.line-highlight{background:rgba(56,58,66,.05)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#e5e5e6;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2);color:#383a42;padding:.1em .6em}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(56,58,66,.05)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(56,58,66,.2)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#9d9d9f}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e45649}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#50a14f}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#4078f2}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#a626a4}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(25,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(56,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(56,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:hsl(0,0,95%)}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:hsl(0,0,95%)}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:hsl(0,0,95%)}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#fff}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#383a42;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#383a42}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}}@media (prefers-color-scheme:dark){code[class*=language-],pre[class*=language-]{background:#282c34;color:#abb2bf;direction:ltr;font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#3e4451;color:inherit;text-shadow:none}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#3e4451;color:inherit;text-shadow:none}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.2em .3em;white-space:normal}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}.token.cdata,.token.comment,.token.prolog{color:#5c6370}.token.doctype,.token.entity,.token.punctuation{color:#abb2bf}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#d19a66}.token.keyword{color:#c678dd}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e06c75}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#98c379}.token.function,.token.operator,.token.variable{color:#61afef}.token.url{color:#56b6c2}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#abb2bf}.language-css .token.selector{color:#e06c75}.language-css .token.property{color:#abb2bf}.language-css .token.function,.language-css .token.url>.token.function{color:#56b6c2}.language-css .token.url>.token.string.url{color:#98c379}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#c678dd}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#be5046}.language-json .token.operator{color:#abb2bf}.language-json .token.null.keyword{color:#d19a66}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#abb2bf}.language-markdown .token.url>.token.content{color:#61afef}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#56b6c2}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#5c6370;font-style:italic}.language-markdown .token.code-snippet{color:#98c379}.language-markdown .token.bold .token.content{color:#d19a66}.language-markdown .token.italic .token.content{color:#c678dd}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e06c75}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(171,178,191,.15);text-shadow:none}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#3a3f4b;border-radius:.3em;color:#828997;padding:.1em .4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#3e4451;color:#abb2bf}.line-highlight.line-highlight{background:rgba(153,187,255,.04)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#3a3f4b;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2);color:#abb2bf;padding:.1em .6em}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(153,187,255,.04)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(171,178,191,.15)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#636d83}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e06c75}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#98c379}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#61afef}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#c678dd}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(25,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(56,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(56,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:#262931}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:#262931}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:#262931}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#31363f}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#abb2bf;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#abb2bf}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}}:root{--foreground:#24292f;--background:#fff}a{color:#0969da}a.visited,a:visited{color:#57606a}.green{color:#1a7f37}.red{color:#cf222e}@media (prefers-color-scheme:dark){:root{--foreground:#adbac7;--background:#22272e}a{color:#539bf5}a.visited,a:visited{color:#768390}.green{color:#57ab5a}.red{color:#e5534b}}a{text-decoration:none}a:hover{text-decoration:underline}html{font-family:Ubuntu,sans-serif}body{background-color:var(--background);color:var(--foreground);margin:0;padding:0}#top{box-sizing:border-box;display:grid;grid-template-rows:1fr 2em;margin:0;min-height:100vh;padding:1em 2em}.graph polygon{fill:transparent}.graph g ellipse[stroke="#000"],.graph g ellipse[stroke="#000000"],.graph g ellipse[stroke=black],.graph g path[stroke="#000"],.graph g path[stroke="#000000"],.graph g path[stroke=black],.graph g polygon[stroke="#000"],.graph g polygon[stroke="#000000"],.graph g polygon[stroke=black]{stroke:var(--foreground)}.graph g text[fill="#000"],.graph g text[fill="#000000"],.graph g text[fill=black]{fill:var(--foreground)}code,pre{font-family:JetBrains Mono,monospace}pre[class*=language-]{word-wrap:break-word;border-radius:0;box-sizing:border-box;margin:1em -2em;max-width:100vw;padding:1em 2em}footer a{line-height:2em;margin-right:.5em}.delta{line-height:1;margin-left:1em;white-space:nowrap}.columns{display:grid;grid-template-columns:repeat(2,1fr)}@media only screen and (max-width:1024px){.columns{grid-template-columns:repeat(1,1fr)}}.pie{text-align:center}.pie figure{display:inline-block}.pie figcaption{font-size:80%;margin-top:.25em}</style><title data-gatsby-head="true">OAuth2 Proxy in Kubernetes</title><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=f721a5d7266d14d92ad4cfcedfe44a7c" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div id="top"><main><div><h1>OAuth2 Proxy in Kubernetes</h1>
<p>Step by step guide of how to get up and running with <a href="https://oauth2-proxy.github.io/oauth2-proxy/">oauth2-proxy</a> and securing services in Kubernetes</p>
<p>First of all, before doing anything else, make sure your config is correct by running proxy locally without any kubernetes stuff, e.g. here is example for Azure App Registration:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>oauth2-proxy <span class="token parameter variable">-p</span> <span class="token number">4180</span>:4180 quay.io/oauth2-proxy/oauth2-proxy <span class="token punctuation">\</span>
    <span class="token parameter variable">--provider</span><span class="token operator">=</span>oidc <span class="token punctuation">\</span>
    --email-domain<span class="token operator">=</span>* <span class="token punctuation">\</span>
    <span class="token parameter variable">--upstream</span><span class="token operator">=</span>file:///dev/null <span class="token punctuation">\</span>
    --http-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0:4180 <span class="token punctuation">\</span>
    --provider-display-name<span class="token operator">=</span>azure <span class="token punctuation">\</span>
    --client-id<span class="token operator">=</span>********-****-****-****-************ <span class="token punctuation">\</span>
    --client-secret<span class="token operator">=</span>**_*********-************************ <span class="token punctuation">\</span>
    --redirect-url<span class="token operator">=</span>http://localhost:4180/oauth2/callback <span class="token punctuation">\</span>
    --oidc-issuer-url<span class="token operator">=</span>https://login.microsoftonline.com/********-****-****-****-************/v2.0 <span class="token punctuation">\</span>
    --cookie-secret<span class="token operator">=</span>********************************</code></pre></div>
<p>And here is example for GitHub App:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>oauth2-proxy <span class="token parameter variable">-p</span> <span class="token number">4180</span>:4180 quay.io/oauth2-proxy/oauth2-proxy <span class="token punctuation">\</span>
    <span class="token parameter variable">--provider</span><span class="token operator">=</span>github <span class="token punctuation">\</span>
    --email-domain<span class="token operator">=</span>* <span class="token punctuation">\</span>
    <span class="token parameter variable">--upstream</span><span class="token operator">=</span>file:///dev/null <span class="token punctuation">\</span>
    --http-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0:4180 <span class="token punctuation">\</span>
    --client-id<span class="token operator">=</span>******************** <span class="token punctuation">\</span>
    --client-secret<span class="token operator">=</span>**************************************** <span class="token punctuation">\</span>
    --redirect-url<span class="token operator">=</span>http://localhost:4180/oauth2/callback <span class="token punctuation">\</span>
    --cookie-secret<span class="token operator">=</span>********************************</code></pre></div>
<p>Note: for cookie secret use:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-ti</span> <span class="token parameter variable">--rm</span> python:3-alpine python <span class="token parameter variable">-c</span> <span class="token string">'import secrets,base64; print(base64.b64encode(base64.b64encode(secrets.token_bytes(16))));'</span></code></pre></div>
<p>And just open <a href="localhost:4180/oauth2/start">localhost:4180/oauth2/start</a></p>
<p>And only after successfull registration and redirection to a home page (which will show you 404 page not found) proceed further. Believe or not it will save you hours.</p>
<h2>Nginx Ingress or how it all works</h2>
<p>There are two key annotations for an external authentication in nginx ingress:</p>
<ul>
<li><code class="language-text">nginx.ingress.kubernetes.io/auth-url</code> - is an url which will be called to see if current request is authenticated or not</li>
<li><code class="language-text">nginx.ingress.kubernetes.io/auth-signin</code> - is an url to which anonymous user will be redirected to authenticate</li>
</ul>
<p>Before moving further we need to see how it actually works (otherwise it will be black magic)</p>
<p>Suppose we have following app which we want to hide behind authorization (nothing fancy, simple deployment, service and ingress):</p>
<p><div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> app1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> app1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
          <span class="token key atrule">image</span><span class="token punctuation">:</span> mendhak/http<span class="token punctuation">-</span>https<span class="token punctuation">-</span>echo
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> app1.cub.marchenko.net.ua
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">pathType</span><span class="token punctuation">:</span> ImplementationSpecific
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre></div></p>
<p>For very first experiment we going to use <a href="https://httpbin.org/">httpbin.org</a> which has endpoints we need</p>
<p>Add following annotations to ingress:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">nginx.ingress.kubernetes.io/auth-url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//httpbin.org/status/200
<span class="token key atrule">nginx.ingress.kubernetes.io/auth-signin</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//httpbin.org/html</code></pre></div>
<p>Whenever request is comming to our app, underneath nginx will call <code class="language-text">https://httpbin.org/status/200</code> which will return <code class="language-text">200 OK</code>, so ingress will think that user is authenticated and proceed</p>
<p>We can test it:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-s</span> http://app1.cub.marchenko.net.ua <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">1</span>
<span class="token comment"># HTTP/1.1 200 OK</span></code></pre></div>
<p>Now lets flip that and pretend we are not authenticated:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">nginx.ingress.kubernetes.io/auth-url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//httpbin.org/status/401
<span class="token key atrule">nginx.ingress.kubernetes.io/auth-signin</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//httpbin.org/html</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-s</span> http://app1.cub.marchenko.net.ua <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"Location|HTTP"</span>
HTTP/1.1 <span class="token number">302</span> Moved Temporarily
Location: https://httpbin.org/html?rd<span class="token operator">=</span>http://app1.cub.marchenko.net.ua%2F</code></pre></div>
<p>As you can see, ingress is trying to redirect us to our fake signin page, also note that <code class="language-text">rd</code> query string parameter added</p>
<p>Lets make some bashify on top on nginx config:</p>
<p><div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">default.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    server {
      location = /check {
        # if there is no "authorization" cookie we pretend that user is not logged in
        if ($cookie_authorization = "") {
          return 401;
        }</span>

        <span class="token comment"># demo for authorization header</span>
        <span class="token comment"># if ($http_authorization != "Bearer 123") {</span>
        <span class="token comment">#   return 401;</span>
        <span class="token comment"># }</span>

        <span class="token comment"># if we land here then "authorization" cookie is present</span>
        add_header Content<span class="token punctuation">-</span>Type text/plain;
        return 200 "OK";
      <span class="token punctuation">}</span>

      location = /login <span class="token punctuation">{</span>
        add_header Set<span class="token punctuation">-</span>Cookie "authorization=123;Domain=.cub.marchenko.net.ua;Path=/;Max<span class="token punctuation">-</span>Age=100000";
        return 302 http<span class="token punctuation">:</span>//app1.cub.marchenko.net.ua;

        <span class="token comment"># https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps#parameters</span>
        <span class="token comment"># note that we are redirecting back to auth</span>
        <span class="token comment"># $arg_rd - stands for "rd" query string parameter</span>
        <span class="token comment"># do not forget to replace "client_id"</span>
        <span class="token comment"># we are cheating with "state" to pass "rd" query string back to callback</span>
        <span class="token comment"># return 302 https://github.com/login/oauth/authorize?client_id=********************&amp;redirect_uri=http://auth.cub.marchenko.net.ua/callback&amp;state=$arg_rd;</span>
      <span class="token punctuation">}</span>

      <span class="token comment"># because of "redirect_uri" after successfull login we will be redirected here</span>
      <span class="token comment"># and because we have passed "rd" query string in "redirect_uri" we could use it here</span>
      location = /callback <span class="token punctuation">{</span>
        <span class="token comment"># note domain - we need that so cookie will be available on all subdomain</span>
        add_header Set<span class="token punctuation">-</span>Cookie "authorization=123;Domain=.cub.marchenko.net.ua;Path=/;Max<span class="token punctuation">-</span>Age=100000";
        <span class="token comment"># $arg_state - stands for "state" query string parameter</span>
        
        <span class="token comment"># did not work, variable is encoded and nginx redirect us to root of auth app</span>
        <span class="token comment"># return 302 $agr_state;</span>
        return 302 http<span class="token punctuation">:</span>//app1.cub.marchenko.net.ua;
      <span class="token punctuation">}</span>

      location = /logout <span class="token punctuation">{</span>
        <span class="token comment"># remove cookie</span>
        add_header Set<span class="token punctuation">-</span>Cookie "authorization=;Domain=.cub.marchenko.net.ua;Path=/;Max<span class="token punctuation">-</span>Age=0";
        <span class="token comment"># idea was to redirect back to app1, which will see that we are anonymous and send us back to login</span>
        <span class="token comment"># but it did not worked out, github remembers our decision and automatically logs us back</span>
        <span class="token comment"># return 302 http://app1.cub.marchenko.net.ua;</span>
        return 302 http<span class="token punctuation">:</span>//auth.cub.marchenko.net.ua;
      <span class="token punctuation">}</span>

      location / <span class="token punctuation">{</span>
        add_header Content<span class="token punctuation">-</span>Type text/plain;
        return 200 "Auth Home Page\n";
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> auth
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> auth
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/conf.d/default.conf
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> default.conf
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> auth.cub.marchenko.net.ua
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">pathType</span><span class="token punctuation">:</span> ImplementationSpecific
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre></div></p>
<p>Config is self explanatory and commented so lets give it a try:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Check home page</span>
<span class="token function">curl</span> auth.cub.marchenko.net.ua
<span class="token comment"># Auth Home Page</span>

<span class="token comment"># Check anonymous user, should return 401</span>
<span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-i</span> auth.cub.marchenko.net.ua/check <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">1</span>
<span class="token comment"># HTTP/1.1 401 Unauthorized</span>

<span class="token comment"># Check logged int, should return 200</span>
<span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-H</span> <span class="token string">"Cookie: authorization=123"</span> auth.cub.marchenko.net.ua/check <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">1</span>
<span class="token comment"># HTTP/1.1 200 OK</span>

<span class="token comment"># Check login, should return 302</span>
<span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-i</span> auth.cub.marchenko.net.ua/login?rd<span class="token operator">=</span>https://mac-blog.org.ua/ <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"Location|HTTP"</span>
<span class="token comment"># HTTP/1.1 302 Moved Temporarily</span>
<span class="token comment"># Location: https://github.com/login/oauth/authorize?client_id=********************&amp;redirect_uri=https://auth.cub.marchenko.net.ua/callback&amp;state=https://mac-blog.org.ua/</span>

<span class="token comment"># Check callback, should return 302</span>
<span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-i</span> <span class="token string">'http://auth.cub.marchenko.net.ua/callback?code=1234567890&amp;state=https://mac-blog.org.ua/'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"Location|HTTP"</span>
<span class="token comment"># HTTP/1.1 302 Moved Temporarily</span>
<span class="token comment"># Location: https://mac-blog.org.ua/</span>

<span class="token comment"># Check logout, should return 302</span>
<span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-i</span>  <span class="token parameter variable">-H</span> <span class="token string">"Cookie: authorization=123"</span> auth.cub.marchenko.net.ua/logout <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"Location|HTTP"</span>
<span class="token comment"># HTTP/1.1 302 Moved Temporarily</span>
<span class="token comment"># Location: http://app1.cub.marchenko.net.ua</span></code></pre></div>
<p>So we almost implemented our own auth proxy, the last thing is to change annotations:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">nginx.ingress.kubernetes.io/auth-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//auth.cub.marchenko.net.ua/check
<span class="token key atrule">nginx.ingress.kubernetes.io/auth-signin</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//auth.cub.marchenko.net.ua/login</code></pre></div>
<p>Navigate to yours <a href="http://app1.cub.marchenko.net.ua">app1.cub.marchenko.net.ua</a> and you should be redirected to login pages, after successfull login back to callback and back to app. Also you should see your cookie being set.</p>
<p>Technically it is how everything work underneath and is enought to move further, except one bonus point which is good to check right now</p>
<p>There are few other <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#external-authentication">external annotations</a> available which we might be interested in:</p>
<ul>
<li><code class="language-text">nginx.ingress.kubernetes.io/auth-signin-redirect-param: redirect_uri</code> - rename <code class="language-text">rd</code> query string parameter to <code class="language-text">redirect_uri</code>, which will hold url from where we have come to login page</li>
<li><code class="language-text">nginx.ingress.kubernetes.io/auth-cache-key: $cookie_authorization</code> - will cache check results based on given cookie</li>
<li><code class="language-text">nginx.ingress.kubernetes.io/auth-cache-duration: 200 202 401 5m</code> - how long cache should be valid, <code class="language-text">200 202 401 5m</code> is default value and will cache responses with given status codes for 5 minutes</li>
</ul>
<p>Try to see <code class="language-text">kubectl logs -l app=auth -f</code> and after logging in refresh app few times, you should not see new requests</p>
<h2>How oauth2-proxy is deployed</h2>
<p>We gonna need to apply:</p>
<ul>
<li><code class="language-text">oauth2-proxy</code> deployment</li>
<li><code class="language-text">oauth2-proxy</code> service</li>
</ul>
<p>For each of our apps we will apply:</p>
<ul>
<li><code class="language-text">app1</code> deployment</li>
<li><code class="language-text">app1</code> service</li>
<li><code class="language-text">app1-oauth2-proxy</code> ingress for <code class="language-text">/oauth2/*</code></li>
<li><code class="language-text">app1</code> ingress for <code class="language-text">/*</code></li>
</ul>
<p>Note that there is no ingress for proxy, but two ingresses per app, one is usual ingress we all applied many times, and second one is to catch all requests to <code class="language-text">/oauth2</code> and route them to our proxy service</p>
<h2>oaut-proxy.yml</h2>
<p><div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy
          <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/oauth2<span class="token punctuation">-</span>proxy/oauth2<span class="token punctuation">-</span>proxy<span class="token punctuation">:</span>latest
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>provider=oidc
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>email<span class="token punctuation">-</span>domain=*
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>upstream=file<span class="token punctuation">:</span>///dev/null
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>http<span class="token punctuation">-</span>address=0.0.0.0<span class="token punctuation">:</span><span class="token number">4180</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>provider<span class="token punctuation">-</span>display<span class="token punctuation">-</span>name=azure
            <span class="token comment"># do not forget to change this</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>id=<span class="token important">********-****-****-****-************</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>secret=<span class="token important">**_*********-************************</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>redirect<span class="token punctuation">-</span>url=http<span class="token punctuation">:</span>//app1.cub.marchenko.net.ua/oauth2/callback
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>oidc<span class="token punctuation">-</span>issuer<span class="token punctuation">-</span>url=https<span class="token punctuation">:</span>//login.microsoftonline.com/<span class="token important">********-****-****-****-************/v2.0</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cookie<span class="token punctuation">-</span>secret=<span class="token important">********************************</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">4180</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">4180</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">4180</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy</code></pre></div></p>
<h2>app2.yml</h2>
<p><div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> app2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> app2
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> app2
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app2
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app2
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> app2
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app2
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token comment"># technically it is same as saying redirect to "/oauth2/auth"</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-url</span><span class="token punctuation">:</span> <span class="token string">'http://$host/oauth2/auth'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-signin</span><span class="token punctuation">:</span> <span class="token string">'http://$host/oauth2/start?rd=$escaped_request_uri'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> app2.cub.marchenko.net.ua
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> app2
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">pathType</span><span class="token punctuation">:</span> ImplementationSpecific
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app2<span class="token punctuation">-</span>oauth2<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token comment"># IMPORTANT</span>
    <span class="token comment"># ---------</span>
    <span class="token comment"># For Azure if you gonna get id_token it will be too big for nginx feaults and nothing will work, that is why you need to make sure proxy is working localy without any external stuff like nginx</span>
    <span class="token comment"># Fix for:</span>
    <span class="token comment"># WARNING: Multiple cookies are required for this session as it exceeds the 4kb cookie limit. Please use server side session storage (eg. Redis) instead.</span>
    <span class="token comment"># Which leads to:</span>
    <span class="token comment"># Error redeeming code during OAuth2 callback: token exchange failed: oauth2: cannot fetch token: 400 Bad Request</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-buffer-size</span><span class="token punctuation">:</span> <span class="token string">'8k'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-buffers-number</span><span class="token punctuation">:</span> <span class="token string">'4'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> app2.cub.marchenko.net.ua
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /oauth2
            <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>proxy
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">4180</span></code></pre></div></p>
<p>Note that for everything to work you gonna need https so need to deal with cert manager or cover with cloudflare</p>
<h1>Custom Proxy</h1>
<p>There is one issue with GitHub integration, because it has only one callback URL we are forced to register new apps for all our services which makes no sense at all (Azure from the other had has as many callbacks as you wish)</p>
<p><a href="https://www.callumpember.com/Kubernetes-A-Single-OAuth2-Proxy-For-Multiple-Ingresses/">https://www.callumpember.com/Kubernetes-A-Single-OAuth2-Proxy-For-Multiple-Ingresses/</a> - really good article describing possible workaround with nginx sidecar</p>
<p>But we are going to go even further and just implement our own proxy (why not, after playing with nginx configs it seems to be not so hard)</p>
<p>So it needs to be a service implementing the same logic as in nginx config, also we gonna need to encrypt cookie</p>
<p>Because I do not want to deal with docker images we gonna put whole service into config map it will be fun</p>
<p>So here is a starting point:</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span>

assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span> <span class="token string">'CLIENT_ID environment variable is missing'</span><span class="token punctuation">)</span>
assert<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLIENT_SECRET</span><span class="token punctuation">,</span> <span class="token string">'CLIENT_SECRET environment variable is missing'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ENCRYPTION_KEY</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ENCRYPTION_KEY</span> <span class="token operator">||</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span class="token comment">// process.env.COOKIE_DOMAIN = process.env.COOKIE_DOMAIN || null</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_MAX_AGE</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_MAX_AGE</span> <span class="token operator">||</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span> <span class="token operator">||</span> <span class="token string">'oauth3-proxy'</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOPE</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOPE</span> <span class="token operator">||</span> <span class="token string">'read:user,user:email'</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIRECT_URL</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIRECT_URL</span> <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/callback</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">function</span> <span class="token function">exchange</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">client_id</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
    <span class="token literal-property property">client_secret</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLIENT_SECRET</span><span class="token punctuation">,</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> code
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">curl -s -i -X POST -H 'Accept: application/json' -H 'Content-Type: application/json' https://github.com/login/oauth/access_token -d '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://github.com/login/oauth/access_token'</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> <span class="token string">'POST'</span>
    <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">Accept</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> req <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> headers<span class="token punctuation">,</span> method <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>statusCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>statusMessage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span>
      res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>data <span class="token operator">+=</span> chunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">client_id</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
        <span class="token literal-property property">client_secret</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLIENT_SECRET</span><span class="token punctuation">,</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> code
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">encrypt</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ENCRYPTION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> iv <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// for AES this is always 16</span>
  <span class="token keyword">const</span> cipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createCipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
  <span class="token keyword">const</span> encrypted <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> iv<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> encrypted<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">decrypt</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ENCRYPTION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> iv <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> decipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDecipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> decrypted <span class="token operator">=</span> decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>iv<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>decrypted<span class="token punctuation">,</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span><span class="token class-name">ServerResponse</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">status<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span><span class="token class-name">ServerResponse</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">redirect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">location</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

http
  <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">,</span> <span class="token string">'Method Not Allowed'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> path <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> encrypted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token operator">?.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">; *</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span>
          res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'&lt;h1>oauth3-proxy&lt;/h1>&lt;form action="/logout">&lt;input type="submit" value="logout"/>&lt;/form>'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unable to decrypt cookie "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>encrypted<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>name<span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
          res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=;Max-Age=0;HttpOnly</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'&lt;h1>oauth3-proxy&lt;/h1>&lt;form action="/login">&lt;input type="submit" value="login"/>&lt;/form>'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">'/check'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> encrypted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token operator">?.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">; *</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encrypted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unauthorized - can not find "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" cookie in given cookies "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">'Unauthorized'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'OK'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unable to decrypt cookie "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>encrypted<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>name<span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">'/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://github.com/login/oauth/authorize'</span><span class="token punctuation">)</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CLIENT_ID</span><span class="token punctuation">)</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIRECT_URL</span><span class="token punctuation">)</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOPE</span><span class="token punctuation">)</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'rd'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">'/callback'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> code <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> state <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> accessToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exchange</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
        <span class="token keyword">const</span> encrypted <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span>
        <span class="token keyword">const</span> domain <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_DOMAIN</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">;Domain=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_DOMAIN</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>
          <span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>encrypted<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;Path=/;Max-Age=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_MAX_AGE</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;HttpOnly</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>domain<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">'/logout'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=;Max-Age=0;HttpOnly</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'Not Found'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Listening: 0.0.0.0:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></p>
<p>And here is our deployment:</p>
<p><div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">oauth3-proxy.js</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    const http = require('http')
    const https = require('https')
    const crypto = require('crypto')
    const assert = require('assert')</span>

    assert.ok(process.env.CLIENT_ID<span class="token punctuation">,</span> 'CLIENT_ID environment variable is missing')
    assert.ok(process.env.CLIENT_SECRET<span class="token punctuation">,</span> 'CLIENT_SECRET environment variable is missing')

    process.env.ENCRYPTION_KEY = process.env.ENCRYPTION_KEY <span class="token punctuation">|</span><span class="token punctuation">|</span> crypto.randomBytes(16).toString('hex')
    // process.env.COOKIE_DOMAIN = process.env.COOKIE_DOMAIN <span class="token punctuation">|</span><span class="token punctuation">|</span> null
    process.env.COOKIE_MAX_AGE = process.env.COOKIE_MAX_AGE <span class="token punctuation">|</span><span class="token punctuation">|</span> 60 * 60
    process.env.COOKIE_NAME = process.env.COOKIE_NAME <span class="token punctuation">|</span><span class="token punctuation">|</span> 'oauth3<span class="token punctuation">-</span>proxy'
    process.env.SCOPE = process.env.SCOPE <span class="token punctuation">|</span><span class="token punctuation">|</span> 'read<span class="token punctuation">:</span>user<span class="token punctuation">,</span>user<span class="token punctuation">:</span>email'
    process.env.PORT = process.env.PORT <span class="token punctuation">|</span><span class="token punctuation">|</span> 3000
    process.env.REDIRECT_URL = process.env.REDIRECT_URL <span class="token punctuation">|</span><span class="token punctuation">|</span> `http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>$<span class="token punctuation">{</span>process.env.PORT<span class="token punctuation">}</span>/callback`

    function exchange(code) <span class="token punctuation">{</span>
      const data = JSON.stringify(<span class="token punctuation">{</span>
        <span class="token key atrule">client_id</span><span class="token punctuation">:</span> process.env.CLIENT_ID<span class="token punctuation">,</span>
        <span class="token key atrule">client_secret</span><span class="token punctuation">:</span> process.env.CLIENT_SECRET<span class="token punctuation">,</span>
        <span class="token key atrule">code</span><span class="token punctuation">:</span> code
      <span class="token punctuation">}</span>)
      console.log(
        `curl <span class="token punctuation">-</span><span class="token key atrule">s -i -X POST -H 'Accept</span><span class="token punctuation">:</span> <span class="token key atrule">application/json' -H 'Content-Type</span><span class="token punctuation">:</span> application/json' https<span class="token punctuation">:</span>//github.com/login/oauth/access_token <span class="token punctuation">-</span>d '$<span class="token punctuation">{</span>data<span class="token punctuation">}</span>'`
      )
      return new Promise((resolve<span class="token punctuation">,</span> reject) =<span class="token punctuation">></span> <span class="token punctuation">{</span>
        const url = 'https<span class="token punctuation">:</span>//github.com/login/oauth/access_token'
        const method = 'POST'
        const headers = <span class="token punctuation">{</span>
          <span class="token key atrule">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
          <span class="token key atrule">Accept</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span>
        <span class="token punctuation">}</span>
        const req = https.request(url<span class="token punctuation">,</span> <span class="token punctuation">{</span> headers<span class="token punctuation">,</span> method <span class="token punctuation">}</span><span class="token punctuation">,</span> (res) =<span class="token punctuation">></span> <span class="token punctuation">{</span>
          console.log(`$<span class="token punctuation">{</span>res.statusCode<span class="token punctuation">}</span> $<span class="token punctuation">{</span>res.statusMessage<span class="token punctuation">}</span>`)
          let data = ''
          res.on('data'<span class="token punctuation">,</span> (chunk) =<span class="token punctuation">></span> (data += chunk))
          res.on('end'<span class="token punctuation">,</span> () =<span class="token punctuation">></span> <span class="token punctuation">{</span>
            console.log(data)
            try <span class="token punctuation">{</span>
              const json = JSON.parse(data)
              if (res.statusCode &lt; 400) <span class="token punctuation">{</span>
                resolve(json.access_token)
              <span class="token punctuation">}</span> else <span class="token punctuation">{</span>
                reject(json)
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> catch (error) <span class="token punctuation">{</span>
              reject(error)
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>)
        <span class="token punctuation">}</span>)
        req.on('error'<span class="token punctuation">,</span> (error) =<span class="token punctuation">></span> <span class="token punctuation">{</span>
          console.error(error)
          reject(error)
        <span class="token punctuation">}</span>)
        req.write(
          JSON.stringify(<span class="token punctuation">{</span>
            <span class="token key atrule">client_id</span><span class="token punctuation">:</span> process.env.CLIENT_ID<span class="token punctuation">,</span>
            <span class="token key atrule">client_secret</span><span class="token punctuation">:</span> process.env.CLIENT_SECRET<span class="token punctuation">,</span>
            <span class="token key atrule">code</span><span class="token punctuation">:</span> code
          <span class="token punctuation">}</span>)
        )
        req.end()
      <span class="token punctuation">}</span>)
    <span class="token punctuation">}</span>

    function encrypt(text) <span class="token punctuation">{</span>
      const key = crypto.createHash('sha256').update(process.env.ENCRYPTION_KEY).digest('hex').substring(0<span class="token punctuation">,</span> 32)
      const iv = crypto.randomBytes(16) // for AES this is always 16
      const cipher = crypto.createCipheriv('aes<span class="token punctuation">-</span>256<span class="token punctuation">-</span>cbc'<span class="token punctuation">,</span> Buffer.from(key)<span class="token punctuation">,</span> iv)
      const encrypted = Buffer.concat(<span class="token punctuation">[</span>cipher.update(text)<span class="token punctuation">,</span> cipher.final()<span class="token punctuation">]</span>)
      return iv.toString('hex') + '<span class="token punctuation">:</span>' + encrypted.toString('hex')
    <span class="token punctuation">}</span>

    function decrypt(text) <span class="token punctuation">{</span>
      const key = crypto.createHash('sha256').update(process.env.ENCRYPTION_KEY).digest('hex').substring(0<span class="token punctuation">,</span> 32)
      const iv = text.split('<span class="token punctuation">:</span>').shift()
      const decipher = crypto.createDecipheriv('aes<span class="token punctuation">-</span>256<span class="token punctuation">-</span>cbc'<span class="token punctuation">,</span> Buffer.from(key)<span class="token punctuation">,</span> Buffer.from(iv<span class="token punctuation">,</span> 'hex'))
      const decrypted = decipher.update(Buffer.from(text.substring(iv.length + 1)<span class="token punctuation">,</span> 'hex'))
      return Buffer.concat(<span class="token punctuation">[</span>decrypted<span class="token punctuation">,</span> decipher.final()<span class="token punctuation">]</span>).toString()
    <span class="token punctuation">}</span>

    http.ServerResponse.prototype.send = function (status<span class="token punctuation">,</span> data) <span class="token punctuation">{</span>
      this.writeHead(status<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token key atrule">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span>)
      this.write(data)
      this.write('\n')
      this.end()
    <span class="token punctuation">}</span>

    http.ServerResponse.prototype.redirect = function (location) <span class="token punctuation">{</span>
      this.setHeader('Location'<span class="token punctuation">,</span> location)
      this.writeHead(302)
      this.end()
    <span class="token punctuation">}</span>

    http
      .createServer(async (req<span class="token punctuation">,</span> res) =<span class="token punctuation">></span> <span class="token punctuation">{</span>
        if (req.method <span class="token tag">!==</span> 'GET') <span class="token punctuation">{</span>
          res.send(405<span class="token punctuation">,</span> 'Method Not Allowed')
          return
        <span class="token punctuation">}</span>

        const path = req.url.split('<span class="token punctuation">?</span>').shift()
        if (path === '/') <span class="token punctuation">{</span>
          const encrypted = new URLSearchParams(req.headers.cookie<span class="token punctuation">?</span>.replace(/; <span class="token important">*/g</span><span class="token punctuation">,</span> '<span class="token important">&amp;')).get(process.env.COOKIE_NAME)</span>
          if (encrypted) <span class="token punctuation">{</span>
            try <span class="token punctuation">{</span>
              decrypt(encrypted)
              res.send(200<span class="token punctuation">,</span> '&lt;h1<span class="token punctuation">></span>oauth3<span class="token punctuation">-</span>proxy&lt;/h1<span class="token punctuation">></span>&lt;form action="/logout"<span class="token punctuation">></span>&lt;input type="submit" value="logout"/<span class="token punctuation">></span>&lt;/form<span class="token punctuation">></span>')
            <span class="token punctuation">}</span> catch (error) <span class="token punctuation">{</span>
              console.warn(`Unable to decrypt cookie "$<span class="token punctuation">{</span>encrypted<span class="token punctuation">}</span>"`)
              console.warn(error.name<span class="token punctuation">,</span> error.message)
              res.setHeader('Set<span class="token punctuation">-</span>Cookie'<span class="token punctuation">,</span> `$<span class="token punctuation">{</span>process.env.COOKIE_NAME<span class="token punctuation">}</span>=;Max<span class="token punctuation">-</span>Age=0;HttpOnly`)
              res.send(401<span class="token punctuation">,</span> error.message)
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> else <span class="token punctuation">{</span>
            res.send(200<span class="token punctuation">,</span> '&lt;h1<span class="token punctuation">></span>oauth3<span class="token punctuation">-</span>proxy&lt;/h1<span class="token punctuation">></span>&lt;form action="/login"<span class="token punctuation">></span>&lt;input type="submit" value="login"/<span class="token punctuation">></span>&lt;/form<span class="token punctuation">></span>')
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> else if (path === '/check') <span class="token punctuation">{</span>
          const encrypted = new URLSearchParams(req.headers.cookie<span class="token punctuation">?</span>.replace(/; <span class="token important">*/g</span><span class="token punctuation">,</span> '<span class="token important">&amp;')).get(process.env.COOKIE_NAME)</span>
          if (<span class="token tag">!encrypted)</span> <span class="token punctuation">{</span>
            console.log(`Unauthorized <span class="token punctuation">-</span> can not find "$<span class="token punctuation">{</span>process.env.COOKIE_NAME<span class="token punctuation">}</span>" cookie in given cookies "$<span class="token punctuation">{</span>req.headers.cookie<span class="token punctuation">}</span>"`)
            res.send(401<span class="token punctuation">,</span> 'Unauthorized')
            return
          <span class="token punctuation">}</span>
          try <span class="token punctuation">{</span>
            decrypt(encrypted)
            res.send(200<span class="token punctuation">,</span> 'OK')
          <span class="token punctuation">}</span> catch (error) <span class="token punctuation">{</span>
            console.warn(`Unable to decrypt cookie "$<span class="token punctuation">{</span>encrypted<span class="token punctuation">}</span>"`)
            console.warn(error.name<span class="token punctuation">,</span> error.message)
            res.send(401<span class="token punctuation">,</span> error.message)
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> else if (path === '/login') <span class="token punctuation">{</span>
          const url = new URL('https<span class="token punctuation">:</span>//github.com/login/oauth/authorize')
          url.searchParams.set('client_id'<span class="token punctuation">,</span> process.env.CLIENT_ID)
          url.searchParams.set('redirect_uri'<span class="token punctuation">,</span> process.env.REDIRECT_URL)
          url.searchParams.set('scope'<span class="token punctuation">,</span> process.env.SCOPE)
          url.searchParams.set('state'<span class="token punctuation">,</span> new URL(`http<span class="token punctuation">:</span>//localhost$<span class="token punctuation">{</span>req.url<span class="token punctuation">}</span>`).searchParams.get('rd') <span class="token punctuation">|</span><span class="token punctuation">|</span> '/')
          res.redirect(url)
        <span class="token punctuation">}</span> else if (path === '/callback') <span class="token punctuation">{</span>
          const query = new URL(`http<span class="token punctuation">:</span>//localhost$<span class="token punctuation">{</span>req.url<span class="token punctuation">}</span>`).searchParams
          const code = query.get('code')
          const state = query.get('state') <span class="token punctuation">|</span><span class="token punctuation">|</span> '/'
          try <span class="token punctuation">{</span>
            const accessToken = await exchange(code)
            const encrypted = encrypt(accessToken)
            const domain = process.env.COOKIE_DOMAIN <span class="token punctuation">?</span> `;Domain=$<span class="token punctuation">{</span>process.env.COOKIE_DOMAIN<span class="token punctuation">}</span>` <span class="token punctuation">:</span> <span class="token string">''</span>
            res.setHeader(
              'Set<span class="token punctuation">-</span>Cookie'<span class="token punctuation">,</span>
              `$<span class="token punctuation">{</span>process.env.COOKIE_NAME<span class="token punctuation">}</span>=$<span class="token punctuation">{</span>encrypted<span class="token punctuation">}</span>;Path=/;Max<span class="token punctuation">-</span>Age=$<span class="token punctuation">{</span>process.env.COOKIE_MAX_AGE<span class="token punctuation">}</span>;HttpOnly$<span class="token punctuation">{</span>domain<span class="token punctuation">}</span>`
            )
            res.redirect(state)
          <span class="token punctuation">}</span> catch (error) <span class="token punctuation">{</span>
            res.send(500<span class="token punctuation">,</span> JSON.stringify(error<span class="token punctuation">,</span> <span class="token null important">null</span><span class="token punctuation">,</span> 4))
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> else if (path === '/logout') <span class="token punctuation">{</span>
          res.setHeader('Set<span class="token punctuation">-</span>Cookie'<span class="token punctuation">,</span> `$<span class="token punctuation">{</span>process.env.COOKIE_NAME<span class="token punctuation">}</span>=;Max<span class="token punctuation">-</span>Age=0;HttpOnly`)
          res.redirect('/')
        <span class="token punctuation">}</span> else <span class="token punctuation">{</span>
          res.send(404<span class="token punctuation">,</span> 'Not Found')
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>)
      .listen(process.env.PORT<span class="token punctuation">,</span> <span class="token key atrule">() => console.log(`Listening</span><span class="token punctuation">:</span> 0.0.0.0<span class="token punctuation">:</span>$<span class="token punctuation">{</span>process.env.PORT<span class="token punctuation">}</span>`))
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> auth
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> auth
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
          <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>16<span class="token punctuation">-</span>alpine
          <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> node
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /oauth3<span class="token punctuation">-</span>proxy.js
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CLIENT_ID
              <span class="token key atrule">value</span><span class="token punctuation">:</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CLIENT_SECRET
              <span class="token key atrule">value</span><span class="token punctuation">:</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ENCRYPTION_KEY
              <span class="token key atrule">value</span><span class="token punctuation">:</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> COOKIE_DOMAIN
              <span class="token key atrule">value</span><span class="token punctuation">:</span> .cub.marchenko.net.ua
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIRECT_URL
              <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//auth.cub.marchenko.net.ua/callback
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PORT
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'80'</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /oauth3<span class="token punctuation">-</span>proxy.js
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> oauth3<span class="token punctuation">-</span>proxy.js
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> auth.cub.marchenko.net.ua
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">pathType</span><span class="token punctuation">:</span> ImplementationSpecific
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre></div></p>
<p>And sample app:</p>
<p><div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app3
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> app3
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> app3
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> app3
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app3
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app3
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app3
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> app3
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app3
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app3
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-url</span><span class="token punctuation">:</span> <span class="token string">'http://auth.cub.marchenko.net.ua/check'</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-signin</span><span class="token punctuation">:</span> <span class="token string">'http://auth.cub.marchenko.net.ua/login'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> app3.cub.marchenko.net.ua
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> app3
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">pathType</span><span class="token punctuation">:</span> ImplementationSpecific</code></pre></div></p>
<p>If everything is ok inside proxy logs you will see something like:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Listening: 0.0.0.0:80
Unauthorized - can not find "oauth3-proxy" cookie in given cookies "undefined"
Unauthorized - can not find "oauth3-proxy" cookie in given cookies "undefined"
curl -s -i -X POST -H 'Accept: application/json' -H 'Content-Type: application/json' https://github.com/login/oauth/access_token -d '{"client_id":"***********","client_secret":"***********","code":"***********"}'
200 OK
{"access_token":"gho_***********","token_type":"bearer","scope":"read:user,user:email"}</code></pre></div>
<p>And see something like this screenshot on a home page:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/600b911547ddd4ce5610080bdca3df49/d9b5d/oauth3-proxy.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 79.6875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACdklEQVQ4y62QUUhTYRTHj2EvvRSlWGrM7Tqdbq7p7t2UtLzL5Eo62yZzli2IgVEmBEFB6Isi+OpzMvRl7UJIWKRSoOtBBhd8SqrBUHwduK23ffe7J76rqVBhkgd+fOc79//9OFyAM5UAZWaY916H10utYBnuhPnYR1hYXIG3C5/gw9JneL+YgFj8HbyKxuHh42fA1digtt4BJrMV7A43DN6PQEWlAc6eKwGosDTBhXKDs7W+7g3vrokbbRZZ4Ftk3tUi80KzLOydTU6XTr3VLhuqONloqparjJxs4syyze6Il10sN9darACuzj4ouXT5kWCpQ3ujGasbrOhubsPWNhHbrnmwXexA0dOp906+GR2NAl5xONFoMqOJq0GOq8Um3o2lpWU+XrgKgIjgdrcM998JYzA4WAjfe0B6vD7S0+snvbcDpOOmRG51e4m3109EsYP0h+6S5y9ekkAgSAYGBlmm0N3jQ6u1Iaisf90VTk9PjySTSVxeXqIrq6taIpFABpvt7OxgPp/HXC6nn796Rjab1fL5HzSXy+PY2Fg/c+nCmZmZkXQ6jRsbG3R7e1tLpVK4ubmJW1tbeERpiEhZMzk5eSCMRqO6MJPJ0L3QwQtNQ0rpPux+aKZpmkZVVcWJiYkD4dzc3EihUEBVVXcTfxD8BX1DlvtNuPsNdeERkn8TsuGJCk90w9nZ2Sfsx1JKCT1+qYQQHB8fD+4LY7HYU/zPmpqaGtgXjo6O9imK8m1tbY3x/bgoivIlEonc0IWSJBUBQCkAuABABID2PcQjOJxzAsD5oaGhIn1Dv99/KhQKFUuSdLqrq+tYsDfhcLjY4/EUsQ1/At5ZV0F5vsEuAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="screenshot"
        title="screenshot"
        src="/static/600b911547ddd4ce5610080bdca3df49/2bef9/oauth3-proxy.png"
        srcset="/static/600b911547ddd4ce5610080bdca3df49/6f3f2/oauth3-proxy.png 256w,
/static/600b911547ddd4ce5610080bdca3df49/01e7c/oauth3-proxy.png 512w,
/static/600b911547ddd4ce5610080bdca3df49/2bef9/oauth3-proxy.png 1024w,
/static/600b911547ddd4ce5610080bdca3df49/d9b5d/oauth3-proxy.png 1224w"
        sizes="(max-width: 1024px) 100vw, 1024px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h1>Azure Active Directory Proxy</h1>
<p>Here is one more example of <strong>aad-proxy</strong></p>
<p><div class="gatsby-highlight" data-language="go"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"crypto/rand"</span>
	<span class="token string">"encoding/base64"</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"io"</span>
	<span class="token string">"log"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"os"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/coreos/go-oidc/v3/oidc"</span>
	<span class="token string">"golang.org/x/oauth2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	clientId <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"AAD_CLIEN_ID"</span><span class="token punctuation">)</span>
	clientSecret <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"AAD_CLIEN_SECRET"</span><span class="token punctuation">)</span>
	tenantId <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"AAD_TENANT_ID"</span><span class="token punctuation">)</span>
	callbackUrl <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"AAD_CALLBACK_URL"</span><span class="token punctuation">)</span>
	cookieDomain <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"AAD_COOKIE_DOMAIN"</span><span class="token punctuation">)</span>

	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	provider<span class="token punctuation">,</span> err <span class="token operator">:=</span> oidc<span class="token punctuation">.</span><span class="token function">NewProvider</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"https://sts.windows.net/%s/"</span><span class="token punctuation">,</span> tenantId<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	verifier <span class="token operator">:=</span> provider<span class="token punctuation">.</span><span class="token function">Verifier</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oidc<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>ClientID<span class="token punctuation">:</span> clientId<span class="token punctuation">}</span><span class="token punctuation">)</span>
	config <span class="token operator">:=</span> oauth2<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		ClientID<span class="token punctuation">:</span>     clientId<span class="token punctuation">,</span>
		ClientSecret<span class="token punctuation">:</span> clientSecret<span class="token punctuation">,</span>
		Endpoint<span class="token punctuation">:</span>     provider<span class="token punctuation">.</span><span class="token function">Endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		RedirectURL<span class="token punctuation">:</span>  callbackUrl<span class="token punctuation">,</span>
		Scopes<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>oidc<span class="token punctuation">.</span>ScopeOpenID<span class="token punctuation">,</span> <span class="token string">"profile"</span><span class="token punctuation">,</span> <span class="token string">"email"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cookie<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">"id_token"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"home handler, unable to retrieve id_token cookie: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

			<span class="token comment">// TODO: its not an error - render home page html for anonymous user</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		idToken<span class="token punctuation">,</span> err <span class="token operator">:=</span> verifier<span class="token punctuation">.</span><span class="token function">Verify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cookie<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"home handler, unable to verify id_token: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// TODO: render html page</span>
		user <span class="token operator">:=</span> User<span class="token punctuation">{</span><span class="token punctuation">}</span>
		idToken<span class="token punctuation">.</span><span class="token function">Claims</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
		data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/check"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cookie<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">"id_token"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"check handler, unable to get id_token cookis: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		idToken<span class="token punctuation">,</span> err <span class="token operator">:=</span> verifier<span class="token punctuation">.</span><span class="token function">Verify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cookie<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"check handler, unable to verify id token: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		user <span class="token operator">:=</span> User<span class="token punctuation">{</span><span class="token punctuation">}</span>
		idToken<span class="token punctuation">.</span><span class="token function">Claims</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"check handler, success: "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>Email<span class="token punctuation">)</span>

		fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		rd <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"rd"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> rd <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
			rd <span class="token operator">=</span> <span class="token string">"/"</span>
		<span class="token punctuation">}</span>

		state<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">randString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"login handler, unable create state: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Internal error"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		nonce<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">randString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"login handler, unable create nonce: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Internal error"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		ttl <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token function">setCallbackCookie</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">"rd"</span><span class="token punctuation">,</span> rd<span class="token punctuation">,</span> cookieDomain<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span>
		<span class="token function">setCallbackCookie</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">"state"</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> cookieDomain<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span>
		<span class="token function">setCallbackCookie</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">"nonce"</span><span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> cookieDomain<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span>

		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"login handler, rd: "</span> <span class="token operator">+</span> rd<span class="token punctuation">)</span>

		url <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">AuthCodeURL</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> oidc<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"login handler, redirecting to: "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>
		http<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> url<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusFound<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/callback"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		state<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"callback handler, unable to get state from cookie: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"state not found"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> state<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"callback handler, state from cookie and identity provider did not match"</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"state did not match"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		oauth2Token<span class="token punctuation">,</span> err <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"callback handler, unable to exchange code for access token: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Failed to exchange token: "</span><span class="token operator">+</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		rawIDToken<span class="token punctuation">,</span> ok <span class="token operator">:=</span> oauth2Token<span class="token punctuation">.</span><span class="token function">Extra</span><span class="token punctuation">(</span><span class="token string">"id_token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"callback handler, unable to get id_token from oauth2 token"</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"No id_token field in oauth2 token."</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		idToken<span class="token punctuation">,</span> err <span class="token operator">:=</span> verifier<span class="token punctuation">.</span><span class="token function">Verify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> rawIDToken<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"callback handler, unable to verify id_token: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Failed to verify ID Token: "</span><span class="token operator">+</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		nonce<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">"nonce"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"callback handler, unable get nonce from cookie: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"nonce not found"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> idToken<span class="token punctuation">.</span>Nonce <span class="token operator">!=</span> nonce<span class="token punctuation">.</span>Value <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"callback handler, nonce in cookie and id_token did not match"</span><span class="token punctuation">)</span>
			<span class="token comment">// TODO: user facing page, need html representation</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"nonce did not match"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		user <span class="token operator">:=</span> User<span class="token punctuation">{</span><span class="token punctuation">}</span>
		idToken<span class="token punctuation">.</span><span class="token function">Claims</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

		<span class="token function">setCallbackCookie</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">"id_token"</span><span class="token punctuation">,</span> rawIDToken<span class="token punctuation">,</span> cookieDomain<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>oauth2Token<span class="token punctuation">.</span>Expiry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"callback handler, successfully logged in "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>Email<span class="token punctuation">)</span>

		rd<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">"rd"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> rd<span class="token punctuation">.</span>Value <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
			rd<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">"/"</span>
		<span class="token punctuation">}</span>

		http<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> rd<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusFound<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setCallbackCookie</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token string">"id_token"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> cookieDomain<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

		rd <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"rd"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> rd <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
			rd <span class="token operator">=</span> <span class="token string">"/"</span>
		<span class="token punctuation">}</span>

		http<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> rd<span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusFound<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"listening on http://0.0.0.0:8080"</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Id    string   `json:"sub"`</span>
	Name  <span class="token builtin">string</span>   <span class="token string">`json:"name"`</span>
	Email <span class="token builtin">string</span>   <span class="token string">`json:"unique_name"`</span> <span class="token comment">// unique_name, upn</span>
	Roles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"roles`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">randString</span><span class="token punctuation">(</span>nByte <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> nByte<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> base64<span class="token punctuation">.</span>RawURLEncoding<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">setCallbackCookie</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> domain <span class="token builtin">string</span><span class="token punctuation">,</span> ttl <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">{</span>
		Name<span class="token punctuation">:</span>     name<span class="token punctuation">,</span>
		Value<span class="token punctuation">:</span>    value<span class="token punctuation">,</span>
		Domain<span class="token punctuation">:</span>   domain<span class="token punctuation">,</span>
		MaxAge<span class="token punctuation">:</span>   ttl<span class="token punctuation">,</span>
		Secure<span class="token punctuation">:</span>   r<span class="token punctuation">.</span>TLS <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
		HttpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	http<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></p>
<p>And its demo deployment</p>
<p><div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token comment"># TODO: for leanup do not forget to remove mac-temp-2021-11-21-auth and mac-temp-2021-11-21-app domains</span>

<span class="token comment"># namespace, just for demo and easier cleanup</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mac

<span class="token comment"># aad-proxy deployment, service and ingress</span>
<span class="token comment"># availables at: https://mac-temp-2021-11-21-auth.mac-blog.org.ua/</span>
<span class="token comment"># endpoints: /         - home page will show if you are logged in or not</span>
<span class="token comment">#            /login    - will redirect to azure login</span>
<span class="token comment">#            /callback - handle login, verify tokens, extract claims, save cookie, redirect to app</span>
<span class="token comment">#            /logout   - handle logout, removes cookie and redirect user to app</span>
<span class="token comment">#            /check    - internal, used by ingress to decide whether user logged in or not</span>
<span class="token comment"># usage:</span>
<span class="token comment"># after applying aad-proxy just add following annotations to any ingress you wish to protect:</span>
<span class="token comment">#</span>
<span class="token comment">#   nginx.ingress.kubernetes.io/auth-url: "https://mac-temp-2021-11-21-auth.mac-blog.org.ua/check"</span>
<span class="token comment">#   nginx.ingress.kubernetes.io/auth-signin: "https://mac-temp-2021-11-21-auth.mac-blog.org.ua/login"</span>
<span class="token comment">#   nginx.ingress.kubernetes.io/auth-cache-key: $cookie_id_token</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mac
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
          <span class="token key atrule">image</span><span class="token punctuation">:</span> mac2000/aad<span class="token punctuation">-</span>proxy
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AAD_CLIEN_ID
              <span class="token key atrule">value</span><span class="token punctuation">:</span> xxxxxxxx<span class="token punctuation">-</span>xxxx<span class="token punctuation">-</span>xxxx<span class="token punctuation">-</span>xxxx<span class="token punctuation">-</span>xxxxxxxxxxxx
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AAD_CLIEN_SECRET
              <span class="token key atrule">value</span><span class="token punctuation">:</span> xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AAD_TENANT_ID
              <span class="token key atrule">value</span><span class="token punctuation">:</span> xxxxxxxx<span class="token punctuation">-</span>xxxx<span class="token punctuation">-</span>xxxx<span class="token punctuation">-</span>xxxx<span class="token punctuation">-</span>xxxxxxxxxxxx
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AAD_CALLBACK_URL
              <span class="token key atrule">value</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//mac<span class="token punctuation">-</span>temp<span class="token punctuation">-</span>2021<span class="token punctuation">-</span>11<span class="token punctuation">-</span>21<span class="token punctuation">-</span>auth.mac<span class="token punctuation">-</span>blog.org.ua/callback
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AAD_COOKIE_DOMAIN
              <span class="token key atrule">value</span><span class="token punctuation">:</span> .mac<span class="token punctuation">-</span>blog.org.ua
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mac
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mac
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token comment"># IMPORTANT - azure gives us really big cookies which wont fit into default ingress configs</span>
    <span class="token comment"># -----------------------------------------------------------------------------------------</span>
    <span class="token comment"># Fix for: WARNING: Multiple cookies are required for this session as it exceeds the 4kb cookie limit. Please use server side session storage (eg. Redis) instead.</span>
    <span class="token comment"># Which leads to: Error redeeming code during OAuth2 callback: token exchange failed: oauth2: cannot fetch token: 400 Bad Request</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-buffer-size</span><span class="token punctuation">:</span> <span class="token string">"8k"</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-buffers-number</span><span class="token punctuation">:</span> <span class="token string">"4"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> mac<span class="token punctuation">-</span>temp<span class="token punctuation">-</span>2021<span class="token punctuation">-</span>11<span class="token punctuation">-</span>21<span class="token punctuation">-</span>auth.mac<span class="token punctuation">-</span>blog.org.ua
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">pathType</span><span class="token punctuation">:</span> ImplementationSpecific
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> aad<span class="token punctuation">-</span>proxy
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>

<span class="token comment"># Usage demo, sample app</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mac
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> app1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> app1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mac
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mac
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token comment"># POI: all we need to do to protect any app</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-url</span><span class="token punctuation">:</span> <span class="token string">"https://mac-temp-2021-11-21-auth.mac-blog.org.ua/check"</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-signin</span><span class="token punctuation">:</span> <span class="token string">"https://mac-temp-2021-11-21-auth.mac-blog.org.ua/login"</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-cache-key</span><span class="token punctuation">:</span> $cookie_id_token
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> mac<span class="token punctuation">-</span>temp<span class="token punctuation">-</span>2021<span class="token punctuation">-</span>11<span class="token punctuation">-</span>21<span class="token punctuation">-</span>app.mac<span class="token punctuation">-</span>blog.org.ua
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">pathType</span><span class="token punctuation">:</span> ImplementationSpecific
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">service</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> app1
                <span class="token key atrule">port</span><span class="token punctuation">:</span>
                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre></div></p></div></main><footer><a href="#top">top</a><a href="/">home</a><a href="/search">search</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/kubernetes-oauth2-proxy";window.___webpackCompilationHash="f25e81a179fb326a8cc8";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-b4bb882d10635d85fa25.js"],"app":["/app-1529e4490e31717bdc91.js"],"component---src-pages-404-js":["/component---src-pages-404-js-2652c435d8decd31b8ef.js"],"component---src-pages-index-js":["/component---src-pages-index-js-1c707dd70333cdef2ccb.js"],"component---src-pages-search-js":["/component---src-pages-search-js-078619e3aef857102623.js"],"component---src-templates-note-js":["/component---src-templates-note-js-b005c02681f20ea28edd.js"]};/*]]>*/</script><script src="/polyfill-b4bb882d10635d85fa25.js" nomodule=""></script><script src="/app-1529e4490e31717bdc91.js" async=""></script><script src="/framework-2ce620c91826a79f925c.js" async=""></script><script src="/webpack-runtime-c8083bc4cc67445e30af.js" async=""></script></body></html>