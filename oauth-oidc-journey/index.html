<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.12.11"/><style data-href="/styles.a4941d77683624f26ff4.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-cyrillic-ext-400-normal-80c010be16bde8b7e613a74066e2b9ef.woff2) format("woff2"),url(/static/ubuntu-cyrillic-ext-400-normal-fe8ca02775a36a7640cb6bc815f2a5f4.woff) format("woff");unicode-range:u+0460-052f,u+1c80-1c88,u+20b4,u+2de0-2dff,u+a640-a69f,u+fe2e-fe2f}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-cyrillic-400-normal-5baf1f37de97e50ab654c46ecdfa687b.woff2) format("woff2"),url(data:font/woff;base64,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) format("woff");unicode-range:u+0301,u+0400-045f,u+0490-0491,u+04b0-04b1,u+2116}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-greek-ext-400-normal-7f5049065c02fb5e06282aeab839cbb2.woff2) format("woff2"),url(data:font/woff;base64,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) format("woff");unicode-range:u+1f??}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-greek-400-normal-038ee74fde7a2c872ee2f9a62edb69d8.woff2) format("woff2"),url(data:font/woff;base64,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) format("woff");unicode-range:u+0370-03ff}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-latin-ext-400-normal-9967dbf10fc3cb92edfb247472a17ec0.woff2) format("woff2"),url(/static/ubuntu-latin-ext-400-normal-da2e1b790a2d4c962274feaf7f0f518f.woff) format("woff");unicode-range:u+0100-02af,u+0304,u+0308,u+0329,u+1e00-1e9f,u+1ef2-1eff,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:Ubuntu;font-style:normal;font-weight:400;src:url(/static/ubuntu-latin-400-normal-2f02effe392a63dc07a5cdf187b2ef09.woff2) format("woff2"),url(/static/ubuntu-latin-400-normal-933b7e9d7979ff75be23b575df798149.woff) format("woff");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+0304,u+0308,u+0329,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,d09GMgABAAAAAARsABAAAAAACMwAAAQRAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGhwbHhwoBmA/U1RBVF4AXBEICoRkg3oLGgABNgIkAy4EIAWFAAeBAwwHGy8HyI7Cca8UYSlFWGJzMUTEQ/1+r2f33Q+oAgAFVkiO0LMiG92pzNTWmEogIUHV6LrA3+vU9yUZFWCUyyYpAGzHxMo5cgl5YpzSCUM8NWtp6sXT3zttbOqD96hLoIAijvawNWhs2hMogzEXBdQFssAy6shdkO6VPDXsvEGgCwihJoRAvaBtQgx0vqymBYQK7HoBasgsSYO9G/Rcy7nAD9pML9mFjgKPfId1ALiW9o7HQAUNkLR49NmAP3T1LIDvcKYsVP8XB0G1hXJmAH2cGQG5lOOYwRNCU2IAjgXYW7OFQ8CTV1oH8oewJAxfJWQEAAQqZBDoKEB+BpBwZjwGiJ8gUY0sCREiXJZ0Z5xVnPERYcR9YmHXCwDxHvHzot3vXmY3QADqmqhp5Ikhdr38OX/dCICxm8BvYCH0UMn7GeAIgauF0qTguFDk7y8SBckPFlz8SJ4vofPlGew+ZC+pEreJW7rJtuvDYZuDCR28i+w8dyn0zJXobrID0+4fRvi2EfLAEOTG4GDbgRGExLDxt4tE24bF+weByZRhiC0zZSqYNu2tUI+nPHcOqi9cGNO3BzbcIVs2dDMjcutbRfQlWX6wa/zmuKowR6r0Zq/KAerL2Lo3Y935H6eCJozvi+Wz3sDWmBhZuQjZkIkB1dHsF9/Dh+dfHMpWgeBA2S0d26erjNSsTjymkqHUKoquk8qL6V2/dtGKYkXHL46WF0mlnIhu2YRWU5SaOcVQqqwJTaskkh76NC1pj5MoYYpm6X/SaWWx8u+fZCVQSVdpS8Li4yefUh+ucay5uzkR4ODLF2bO0Y0d8wl8z2VZD2hdByDoV+rl9nqmPN2bkemffokxXwJsCUJde4rDdejqUOJFLY4CDoFcqp6l8OTYoznu+G5NxvTaNI+Vmn8L13v9Zf+FOP4T/n2/fT61j3/9JbmdaGm/7qAuQXAZlHm3BrezpAbEs3eyA7rCYipEJ8O75LL0p4A/8B5C1wLcNHwkWdbAP8RGEQGfI68EYSKCQOoHASrHDYBij4ugZsx2ULemg9R3TBIFAl1DgIB+EMAfutr3CiDGdSwnLZdKHC0HK712RlZmFlzYlNOn3yr58qV2PTcrJuJEKE//czjkYbmZ5atXpkYVI04RNy0rl361WC6sXE2MzDwctNzaGLn1s9Z9KwElD6VQYX9FgkorQdCjrkhVKSKdPRVkP2NiMVafddwnw16rpCDUJGjB4MYc1rxJAzeWjZEeJwHDc8JalrtVTRlOW2dmrf2eh04ePZZT/gzV5u/XlgnjMbprRAHhpi4WfEYYHA8cEYiH+EiAhEjEZ3T/A4gSeFzWgiVMaUooXcGC6LL3V/LMWqdT66fVezjj9znYL+kQ+zB0koJlTuAL5N31gDgEAA==) format("woff2"),url(data:font/woff;base64,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) format("woff");unicode-range:u+0460-052f,u+1c80-1c88,u+20b4,u+2de0-2dff,u+a640-a69f,u+fe2e-fe2f}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(data:font/woff;base64,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) format("woff");unicode-range:u+0301,u+0400-045f,u+0490-0491,u+04b0-04b1,u+2116}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(data:font/woff;base64,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) format("woff");unicode-range:u+0370-03ff}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(data:font/woff;base64,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) format("woff");unicode-range:u+0102-0103,u+0110-0111,u+0128-0129,u+0168-0169,u+01a0-01a1,u+01af-01b0,u+0300-0301,u+0303-0304,u+0308-0309,u+0323,u+0329,u+1ea0-1ef9,u+20ab}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(data:font/woff;base64,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) format("woff");unicode-range:u+0100-02af,u+0300-0301,u+0303-0304,u+0308-0309,u+0323,u+0329,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:JetBrains Mono;font-style:normal;font-weight:400;src:url(/static/jetbrains-mono-latin-400-normal-4163112e566ed7697acf3d261319e506.woff2) format("woff2"),url(/static/jetbrains-mono-latin-400-normal-6c1a3008005254946aef57ceab632806.woff) format("woff");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+0300-0301,u+0303-0304,u+0308-0309,u+0323,u+0329,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@media (prefers-color-scheme:light){code[class*=language-],pre[class*=language-]{background:#fafafa;color:#383a42;direction:ltr;font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#e5e5e6;color:inherit}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#e5e5e6;color:inherit}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.2em .3em;white-space:normal}.token.cdata,.token.comment,.token.prolog{color:#a0a1a7}.token.doctype,.token.entity,.token.punctuation{color:#383a42}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#b76b01}.token.keyword{color:#a626a4}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e45649}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#50a14f}.token.function,.token.operator,.token.variable{color:#4078f2}.token.url{color:#0184bc}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#383a42}.language-css .token.selector{color:#e45649}.language-css .token.property{color:#383a42}.language-css .token.function,.language-css .token.url>.token.function{color:#0184bc}.language-css .token.url>.token.string.url{color:#50a14f}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#a626a4}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#ca1243}.language-json .token.operator{color:#383a42}.language-json .token.null.keyword{color:#b76b01}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#383a42}.language-markdown .token.url>.token.content{color:#4078f2}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#0184bc}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#a0a1a7;font-style:italic}.language-markdown .token.code-snippet{color:#50a14f}.language-markdown .token.bold .token.content{color:#b76b01}.language-markdown .token.italic .token.content{color:#a626a4}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e45649}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(56,58,66,.2)}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#e5e5e6;border-radius:.3em;color:#696c77;padding:.1em .4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#c6c7c7;color:#383a42}.line-highlight.line-highlight{background:rgba(56,58,66,.05)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#e5e5e6;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2);color:#383a42;padding:.1em .6em}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(56,58,66,.05)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(56,58,66,.2)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#9d9d9f}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e45649}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#50a14f}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#4078f2}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#a626a4}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(25,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(56,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(56,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:hsl(0,0,95%)}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:hsl(0,0,95%)}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:hsl(0,0,95%)}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#fff}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#383a42;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#383a42}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}}@media (prefers-color-scheme:dark){code[class*=language-],pre[class*=language-]{background:#282c34;color:#abb2bf;direction:ltr;font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#3e4451;color:inherit;text-shadow:none}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#3e4451;color:inherit;text-shadow:none}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.2em .3em;white-space:normal}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}.token.cdata,.token.comment,.token.prolog{color:#5c6370}.token.doctype,.token.entity,.token.punctuation{color:#abb2bf}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#d19a66}.token.keyword{color:#c678dd}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e06c75}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#98c379}.token.function,.token.operator,.token.variable{color:#61afef}.token.url{color:#56b6c2}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#abb2bf}.language-css .token.selector{color:#e06c75}.language-css .token.property{color:#abb2bf}.language-css .token.function,.language-css .token.url>.token.function{color:#56b6c2}.language-css .token.url>.token.string.url{color:#98c379}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#c678dd}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#be5046}.language-json .token.operator{color:#abb2bf}.language-json .token.null.keyword{color:#d19a66}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#abb2bf}.language-markdown .token.url>.token.content{color:#61afef}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#56b6c2}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#5c6370;font-style:italic}.language-markdown .token.code-snippet{color:#98c379}.language-markdown .token.bold .token.content{color:#d19a66}.language-markdown .token.italic .token.content{color:#c678dd}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e06c75}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(171,178,191,.15);text-shadow:none}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#3a3f4b;border-radius:.3em;color:#828997;padding:.1em .4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#3e4451;color:#abb2bf}.line-highlight.line-highlight{background:rgba(153,187,255,.04)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#3a3f4b;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2);color:#abb2bf;padding:.1em .6em}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(153,187,255,.04)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(171,178,191,.15)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#636d83}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e06c75}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#98c379}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#61afef}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#c678dd}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(25,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(56,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(56,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:#262931}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:#262931}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:#262931}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#31363f}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#abb2bf;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#abb2bf}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}}:root{--foreground:#24292f;--background:#fff}a{color:#0969da}a.visited,a:visited{color:#57606a}.green{color:#1a7f37}.red{color:#cf222e}@media (prefers-color-scheme:dark){:root{--foreground:#adbac7;--background:#22272e}a{color:#539bf5}a.visited,a:visited{color:#768390}.green{color:#57ab5a}.red{color:#e5534b}}a{text-decoration:none}a:hover{text-decoration:underline}html{font-family:Ubuntu,sans-serif}body{background-color:var(--background);color:var(--foreground);margin:0;padding:0}#top{box-sizing:border-box;display:grid;grid-template-rows:1fr 2em;margin:0;min-height:100vh;padding:1em 2em}.graph polygon{fill:transparent}.graph g ellipse[stroke="#000"],.graph g ellipse[stroke="#000000"],.graph g ellipse[stroke=black],.graph g path[stroke="#000"],.graph g path[stroke="#000000"],.graph g path[stroke=black],.graph g polygon[stroke="#000"],.graph g polygon[stroke="#000000"],.graph g polygon[stroke=black]{stroke:var(--foreground)}.graph g text[fill="#000"],.graph g text[fill="#000000"],.graph g text[fill=black]{fill:var(--foreground)}code,pre{font-family:JetBrains Mono,monospace}pre[class*=language-]{word-wrap:break-word;border-radius:0;box-sizing:border-box;margin:1em -2em;max-width:100vw;padding:1em 2em}footer a{line-height:2em;margin-right:.5em}.delta{line-height:1;margin-left:1em;white-space:nowrap}.columns{display:grid;grid-template-columns:repeat(2,1fr)}@media only screen and (max-width:1024px){.columns{grid-template-columns:repeat(1,1fr)}}.pie{text-align:center}.pie figure{display:inline-block}.pie figcaption{font-size:80%;margin-top:.25em}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=f721a5d7266d14d92ad4cfcedfe44a7c" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=f721a5d7266d14d92ad4cfcedfe44a7c"/><title data-gatsby-head="true">OAuth 2.0 and OpenID Connect journey</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div id="top"><main><div><h1>OAuth 2.0 and OpenID Connect journey</h1>
<p>Goal: step by step implement the spec</p>
<p>Addtions: for seamless integration we are going to add JWKS and OIDC discovery endpoints so clients will be able to verify tokens without knowing sign secret</p>
<p>At the very end integrating should be as easy as</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=></span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>Authority <span class="token operator">=</span> <span class="token string">"https://auth.localhost.direct"</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>Audience <span class="token operator">=</span> <span class="token string">"my-awesome-api"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> user<span class="token punctuation">)</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>c <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyValuePair<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>so our service is discover JWKS from wellknown OIDC endpoint of our authority, retrieve public keys and validate incomming requests</p>
<blockquote>
<p>Note: If that's not clear then everything below won't make any sense</p>
</blockquote>
<p>Next we are going to have some oversimplified and short notes about the spec itself, but even so it will be veryyyyy long</p>
<p>Also before doing anything we will prepare some examples for providers like Google, Microsoft just to see how it supposed to work</p>
<p>And only after we are going to mimique something similar</p>
<p>In our first attempts we will start with something oversimplified - aka HSA256 and without validation at all, and only after will move to hardcoded RSA and then to JWKS</p>
<p>Whenever possible everything will be stored in memory, so storage is implementation detail, as well as basic CRUD for it</p>
<p>Please remember this is a note written by me for me, not an tutorial</p>
<h1>1. OAuth 2.0 Spec - Introduction</h1>
<h2>1.1. Roles</h2>
<ul>
<li><strong>resource owner</strong> - human, knows login and password, owns some data on resource server</li>
<li><strong>resource server</strong> - service that holds user data</li>
<li><strong>client</strong> - our frontend, mobile app, 3rd party integrations</li>
<li><strong>authorization server</strong> - accepts credentials from user, generates access tokens, the thing we are going to implement</li>
</ul>
<h2>1.2. Flow</h2>
<p>Taken from the <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-1.2">spec</a> as is</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">     +--------+                               +---------------+
     |        |--(A)- Authorization Request ->|   Resource    |
     |        |                               |     Owner     |
     |        |&lt;-(B)-- Authorization Grant ---|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant -->| Authorization |
     | Client |                               |     Server    |
     |        |&lt;-(D)----- Access Token -------|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------>|    Resource   |
     |        |                               |     Server    |
     |        |&lt;-(F)--- Protected Resource ---|               |
     +--------+                               +---------------+

                     Figure 1: Abstract Protocol Flow</code></pre></div>
<h2>1.3. Authorization Grant</h2>
<h3>1.3.1. Authorization Code</h3>
<p>Most common approach, whenever you click on "Login with Whatever" button, popup shows with login form of authorization server</p>
<p>This approach is preferred because anyone except auth service does not see user credentials</p>
<p>If everything went fine auth service responds with code that later will be exchanged to access token</p>
<h3>1.3.2. Implicit</h3>
<p>The same as above, except instead of responding with code our auth service responds with access token</p>
<p>Used for SPA when there is no back channel</p>
<h3>1.3.3. Resource Owner Password Credentials</h3>
<p>Something similar to implicit but we own the login form, may be used in case of mobile app where we do not want to use webview</p>
<h3>1.3.4. Client Credentials</h3>
<p>Used for server to server communication, usually does not touch user data</p>
<h3>TODO</h3>
<p>There are many other flows, liky hybrid one, also there is a way to extend flows with something custom, need to figure out how to allow some services to act on behalf of user, technically it is done with authorization code with offline access</p>
<h2>1.4. Access Token</h2>
<p>Usually we are talking about JWT that is passed as authorization bearer request header</p>
<p>Described in details in <a href="https://datatracker.ietf.org/doc/html/rfc6750">RFC6750</a></p>
<h2>1.5. Refresh Token</h2>
<p>chart taken from <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-1.5">spec</a> as is</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">
  +--------+                                           +---------------+
  |        |--(A)------- Authorization Grant --------->|               |
  |        |                                           |               |
  |        |&lt;-(B)----------- Access Token -------------|               |
  |        |               &amp; Refresh Token             |               |
  |        |                                           |               |
  |        |                            +----------+   |               |
  |        |--(C)---- Access Token ---->|          |   |               |
  |        |                            |          |   |               |
  |        |&lt;-(D)- Protected Resource --| Resource |   | Authorization |
  | Client |                            |  Server  |   |     Server    |
  |        |--(E)---- Access Token ---->|          |   |               |
  |        |                            |          |   |               |
  |        |&lt;-(F)- Invalid Token Error -|          |   |               |
  |        |                            +----------+   |               |
  |        |                                           |               |
  |        |--(G)----------- Refresh Token ----------->|               |
  |        |                                           |               |
  |        |&lt;-(H)----------- Access Token -------------|               |
  +--------+           &amp; Optional Refresh Token        +---------------+

               Figure 2: Refreshing an Expired Access Token</code></pre></div>
<h2>1.6. TLS Version</h2>
<p>Whenever you playing with any OAuth or OIDC usually you are forced to use https</p>
<p>The exceptions may be for develpment when you set your callback urls to localhost</p>
<h2>1.7. HTTP Redirections</h2>
<p>Whenever redirection is used it is supposed to be 302</p>
<h2>1.8. Interoperability</h2>
<p>This spec does not touch following topics at all:</p>
<ul>
<li>client registration</li>
<li>authorization server capabilities</li>
<li>endpoint discovery</li>
</ul>
<h1>2. Client Registration</h1>
<p>Spec does not describe how to implement this</p>
<p>Think of following - whenever you intergrated "Login with something" button - as the very first steps all guides describe that you need go to you provider, create new "app" and define its allowed redirect urls - this is exactly the "client registration"</p>
<h2>2.1. Client Types</h2>
<ul>
<li><strong>confidential</strong> - clients having "backend"</li>
<li><strong>public</strong> - clients without backends, aka SPA</li>
</ul>
<p>Later in spec you may see following client profiles:</p>
<ul>
<li><strong>web application</strong> - confidential web site</li>
<li><strong>user-agent-based application</strong> - public SPA</li>
<li><strong>native application</strong> - public mobile apps</li>
</ul>
<h2>2.2. Client Identifier</h2>
<p>When you play with all this, often you will deal with <code class="language-text">client_id</code> and <code class="language-text">client_secret</code>, the first one is our client identifier, usual some kind of GUID, unique to auth server</p>
<h2>2.3. Client Authentication</h2>
<p>And this one is about <code class="language-text">client_secret</code> which is used by confidential clients, not shared, keeped in secrcet</p>
<h2>2.3.1. Client Password</h2>
<p>Sounds little bit missleading but all it is is a pair of two previous parts together, where <code class="language-text">client_id</code> becomes username and <code class="language-text">client_secret</code> - password</p>
<p>Spec describes that it can be used in one of two ways:</p>
<ul>
<li>as basic authorization header, aka <code class="language-text">Authorization: Basic {base64(client_id + ":" + client_scert)}</code></li>
<li>as form url encoded <code class="language-text">client_id</code> and <code class="language-text">client_password</code> params</li>
</ul>
<p>Notes:</p>
<ul>
<li>only one approach may be used at same time</li>
<li>passing via query string is not allowed</li>
</ul>
<h1>3. Protocol Endpoints</h1>
<p>The cool part - whole OAuth is just following endpoints:</p>
<ul>
<li><strong>authorization endpoint</strong> - will show you login form, perform redirects, etc</li>
<li><strong>token endpoint</strong> - exchange <code class="language-text">code</code> to <code class="language-text">access_token</code></li>
</ul>
<h2>3.1. Authorization Endpoint</h2>
<p>Section describes that it shold be an endpoint to identify user (aka via his username and password), as result it is expected to have GET method handler to draw login form as well as POST handler</p>
<h3>3.1.1. Response Type</h3>
<p>There is one required parameter</p>
<p><strong>response_type</strong> - the value MUST be one of <code class="language-text">code</code> for requesting an authorization code, <code class="language-text">token</code> for requesting an access token (implicit grant)</p>
<p>there can be other types, they are space delimited, order does not matter</p>
<h3>3.1.2. Redirection Endpoint</h3>
<p>The URL where we should redirect user after login</p>
<p>Must be absolute, may have query string params, must not include fragment</p>
<p>If we are adding our query strign params we should keep those were given to us</p>
<h4>3.1.2.1. Endpoint Request Confidentiality</h4>
<p>As usual - require https</p>
<h4>3.1.2.2. Registration Requirements</h4>
<p>Redirect URL are required for:</p>
<ul>
<li>public clients</li>
<li>confidential clients utilizing the implicit grant type</li>
</ul>
<p>Client is required to provide full redirect url with optional <code class="language-text">state</code> query strign parameter</p>
<p>Client may have more than one redirect url registered</p>
<h4>3.1.2.3. Dynamic Configuration</h4>
<p>In case of multiple redirect urls being registered client must provide redirect url to authorization endpoint, otherwise how it should choose one</p>
<h4>3.1.2.4. Invalid Endpoint</h4>
<p>It is more like a note - if no redirect url provided or it is not found - auth service must not redirect user anywhere and should warn him about the error</p>
<h4>3.1.2.5. Endpoint Content</h4>
<p>Is is more like a note to not add any 3rd party scripts anywhere in the chain and urls</p>
<h2>3.2. Token Endpoint</h2>
<p>This endpoint is used to exchange <code class="language-text">code</code> or <code class="language-text">refresh_token</code> to <code class="language-text">access_token</code></p>
<p>This endpoint used with all flows except implicit (which receives access token directly)</p>
<p>It should accept only POST requests, parse only wellknown parameters and treat empty values as missing ones</p>
<h3>3.2.1. Client Authentication</h3>
<p>While talking to token endpoint clients should authenticate themselves with <code class="language-text">client_id</code> and <code class="language-text">client_password</code> especially for flows with refresh tokens</p>
<h2>3.3. Access Token Scope</h2>
<p>Space delimited case sensitive scopes, where order does not matter</p>
<p>If, for some reasone final access token will have less scopes the auth service should notify client about that by providing <code class="language-text">scope</code> parameter</p>
<p>Scopes are optional and if client did not passed one, default shuld be used</p>
<h1>4. Obtaining Authorization</h1>
<p>Here the actual fun stuff begins with endpoints and examples of how it all works</p>
<h2>4.1. Authorization Code Grant</h2>
<p>chart is taken from <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.1">spec</a> as is</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">     +----------+
     | Resource |
     |   Owner  |
     |          |
     +----------+
          ^
          |
         (B)
     +----|-----+          Client Identifier      +---------------+
     |         -+----(A)-- &amp; Redirection URI ---->|               |
     |  User-   |                                 | Authorization |
     |  Agent  -+----(B)-- User authenticates --->|     Server    |
     |          |                                 |               |
     |         -+----(C)-- Authorization Code ---&lt;|               |
     +-|----|---+                                 +---------------+
       |    |                                         ^      v
      (A)  (C)                                        |      |
       |    |                                         |      |
       ^    v                                         |      |
     +---------+                                      |      |
     |         |>---(D)-- Authorization Code ---------'      |
     |  Client |          &amp; Redirection URI                  |
     |         |                                             |
     |         |&lt;---(E)----- Access Token -------------------'
     +---------+       (w/ Optional Refresh Token)

   Note: The lines illustrating steps (A), (B), and (C) are broken into
   two parts as they pass through the user-agent.

                     Figure 3: Authorization Code Flow</code></pre></div>
<h3>4.1.1. Authorization Request</h3>
<ul>
<li><strong>response_type</strong> - REQUIRED. Value MUST be set to <code class="language-text">code</code></li>
<li><strong>client_id</strong> - REQUIRED. The client identifier</li>
<li><strong>redirect_uri</strong> - OPTIONAL. Required if client, for example have more than one redirect uri</li>
<li><strong>scope</strong> - OPTIONAL. The scope of the access request</li>
<li><strong>state</strong> - RECOMMENDED. Some value, used by client to track the user, auth service should include it in redirect response</li>
</ul>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1
Host: server.example.com</code></pre></div>
<h3>4.1.2. Authorization Response</h3>
<ul>
<li><strong>code</strong> REQUIRED. Short lived (~10min) one time code that will be used by client to exchange it to access token. If possible and second attempt detected auth service should revoke all tokens previously issued for this code</li>
<li><strong>state</strong> - REQUIRED if the "state" parameter was present in the client request.</li>
</ul>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 302 Found
Location: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&amp;state=xyz</code></pre></div>
<h4>4.1.2.1. Error Response</h4>
<p>If <code class="language-text">client_id</code> or <code class="language-text">redirect_uri</code> are missing, invalid, mismatching - auth service must warn user and must not redirect him anywhere</p>
<p>If user did not allow access or some other error auth service redirects user to redirect uri with additional query string params</p>
<ul>
<li><strong>error</strong> - REQUIRED. enum:
<ul>
<li>invalid_request - validation error</li>
<li>unauthorized_client - client is not authorized for authorization code with given method</li>
<li>access_denied - either user or auth service denied request</li>
<li>unsupported_response_type - unsupported flow</li>
<li>invalid_scope - requested scope is invalid, unknown, or malformed.</li>
<li>server_error - unexpected error, aka 500</li>
<li>temporarily_unavailable - aka 503</li>
</ul>
</li>
<li><strong>error_description</strong> - OPTIONAL. Human-readable description.</li>
<li><strong>error_uri</strong> - OPTIONAL. URL where user may read details about such error</li>
<li><strong>state</strong> - REQUIRED if a "state" parameter was present in request</li>
</ul>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 302 Found
Location: https://client.example.com/cb?error=access_denied&amp;state=xyz</code></pre></div>
<h3>4.1.3.  Access Token Request</h3>
<p>Exchange code or refresh token to access token</p>
<ul>
<li><strong>grant_type</strong> - REQUIRED. Value MUST be set to "authorization_code".</li>
<li><strong>code</strong> - REQUIRED. The authorization code received from the authorization server.</li>
<li><strong>redirect_uri</strong> - REQUIRED, if the "redirect_uri" parameter was included in the authorization request, and their values MUST be identical. (aka additional layer of security)</li>
<li><strong>client_id</strong> - REQUIRED, if the client is not authenticating with the authorization server</li>
</ul>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb</code></pre></div>
<p>The authorization server MUST:</p>
<ul>
<li>require client authentication for confidential clients or for any client that was issued client credentials</li>
<li>authenticate the client if client authentication is included</li>
<li>ensure that the authorization code was issued to the authenticated confidential client, or if the client is public, ensure that the code was issued to "client_id" in the request</li>
<li>verify that the authorization code is valid, and</li>
<li>ensure that the "redirect_uri" parameter is present if the "redirect_uri" parameter was included in the initial authorization request, and if included ensure that their values are identical.</li>
</ul>
<h3>4.1.4. Access Token Response</h3>
<p>Example</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
  "access_token":"2YotnFZFEjr1zCsicMWpAA",
  "token_type":"example",
  "expires_in":3600,
  "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
  "example_parameter":"example_value"
}</code></pre></div>
<h2>4.2. Implicit Grant</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"> +----------+
     | Resource |
     |  Owner   |
     |          |
     +----------+
          ^
          |
         (B)
     +----|-----+          Client Identifier     +---------------+
     |         -+----(A)-- &amp; Redirection URI --->|               |
     |  User-   |                                | Authorization |
     |  Agent  -|----(B)-- User authenticates -->|     Server    |
     |          |                                |               |
     |          |&lt;---(C)--- Redirection URI ----&lt;|               |
     |          |          with Access Token     +---------------+
     |          |            in Fragment
     |          |                                +---------------+
     |          |----(D)--- Redirection URI ---->|   Web-Hosted  |
     |          |          without Fragment      |     Client    |
     |          |                                |    Resource   |
     |     (F)  |&lt;---(E)------- Script ---------&lt;|               |
     |          |                                +---------------+
     +-|--------+
       |    |
      (A)  (G) Access Token
       |    |
       ^    v
     +---------+
     |         |
     |  Client |
     |         |
     +---------+

   Note: The lines illustrating steps (A) and (B) are broken into two
   parts as they pass through the user-agent.

                       Figure 4: Implicit Grant Flow</code></pre></div>
<h3>4.2.1. Authorization Request</h3>
<ul>
<li><strong>response_type</strong> - REQUIRED. Value MUST be set to <code class="language-text">token</code>.</li>
<li><strong>client_id</strong> - REQUIRED. The client identifier</li>
<li><strong>redirect_uri</strong> - OPTIONAL.</li>
<li><strong>scope</strong> - OPTIONAL. The scope of the access request</li>
<li><strong>state</strong> - RECOMMENDED. state that will be passed to response</li>
</ul>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">GET /authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1
Host: server.example.com</code></pre></div>
<h3>4.2.2. Access Token Response</h3>
<ul>
<li><strong>access_token</strong> - REQUIRED. actual access token</li>
<li><strong>token_type</strong> - REQUIRED. The type of the token usually bearer</li>
<li><strong>expires_in</strong> - RECOMMENDED. The lifetime in seconds of the access token. For example, the value "3600" denotes that the access token will expire in one hour from the time the response was generated.</li>
<li><strong>scope</strong> - OPTIONAL, if identical to the scope requested by the client; otherwise, REQUIRED.</li>
<li><strong>state</strong> - REQUIRED if the "state" parameter was present in request</li>
</ul>
<p>The authorization server MUST NOT issue a refresh token.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 302 Found
Location: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA&amp;state=xyz&amp;token_type=example&amp;expires_in=3600</code></pre></div>
<h4>4.2.2.1. Error Response</h4>
<ul>
<li><strong>error</strong> - REQUIRED. enum
<ul>
<li>invalid_request - validation</li>
<li>unauthorized_client - aka unknown client id</li>
<li>access_denied - access denied by user or auth</li>
<li>unsupported_response_type - not supported method</li>
<li>invalid_scope - scope invalid, unknown or malformed</li>
<li>server_error - aka 500</li>
<li>temporarily_unavailable - aka 503E.</li>
</ul>
</li>
<li><strong>error_description</strong> - OPTIONAL. Human-readable description</li>
<li><strong>error_uri</strong> - OPTIONAL. url for details</li>
<li><strong>state</strong> - REQUIRED if a "state" parameter was present in request</li>
</ul>
<p>Example</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 302 Found
Location: https://client.example.com/cb#error=access_denied&amp;state=xyz</code></pre></div>
<h2>4.3. Resource Owner Password Credentials Grant</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">     +----------+
     | Resource |
     |  Owner   |
     |          |
     +----------+
          v
          |    Resource Owner
         (A) Password Credentials
          |
          v
     +---------+                                  +---------------+
     |         |>--(B)---- Resource Owner ------->|               |
     |         |         Password Credentials     | Authorization |
     | Client  |                                  |     Server    |
     |         |&lt;--(C)---- Access Token ---------&lt;|               |
     |         |    (w/ Optional Refresh Token)   |               |
     +---------+                                  +---------------+

            Figure 5: Resource Owner Password Credentials Flow</code></pre></div>
<h3>4.3.1. Authorization Request and Response</h3>
<h3>4.3.2.  Access Token Request</h3>
<ul>
<li><strong>grant_type</strong> - REQUIRED. Value MUST be set to <code class="language-text">password</code>.</li>
<li><strong>username</strong> - REQUIRED. The resource owner username.</li>
<li><strong>password</strong> - REQUIRED. The resource owner password.</li>
<li><strong>scope</strong> - OPTIONAL. The scope of the access request.</li>
</ul>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=password&amp;username=johndoe&amp;password=A3ddj3w</code></pre></div>
<p>The authorization server MUST:</p>
<ul>
<li>require client authentication for confidential clients or for any client that was issued client credentials</li>
<li>authenticate the client if client authentication is included, and</li>
<li>validate the resource owner password credentials using its existing password validation algorithm.</li>
</ul>
<p>Protect this endpoint by rate limiter</p>
<h3>4.3.3. Access Token Response</h3>
<p>Example</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
  "access_token":"2YotnFZFEjr1zCsicMWpAA",
  "token_type":"example",
  "expires_in":3600,
  "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
  "example_parameter":"example_value"
}</code></pre></div>
<h2>4.4. Client Credentials Grant</h2>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">     +---------+                                  +---------------+
     |         |                                  |               |
     |         |>--(A)- Client Authentication --->| Authorization |
     | Client  |                                  |     Server    |
     |         |&lt;--(B)---- Access Token ---------&lt;|               |
     |         |                                  |               |
     +---------+                                  +---------------+

                     Figure 6: Client Credentials Flow</code></pre></div>
<h3>4.4.1. Authorization Request and Response</h3>
<h3>4.4.2. Access Token Request</h3>
<ul>
<li><strong>grant_type</strong> - REQUIRED. Value MUST be set to <code class="language-text">client_credentials</code>.</li>
<li><strong>scope</strong> - OPTIONAL. The scope of the access request.</li>
</ul>
<p>The client MUST authenticate with the authorization server.</p>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials</code></pre></div>
<h3>4.4.3. Access Token Response</h3>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
  "access_token":"2YotnFZFEjr1zCsicMWpAA",
  "token_type":"example",
  "expires_in":3600,
  "example_parameter":"example_value"
}</code></pre></div>
<h2>4.5. Extension Grants</h2>
<p>Custom grant types if supported may be passewd as uri</p>
<p>example</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /token HTTP/1.1
Host: server.example.com
Content-Type: application/x-www-form-urlencoded

grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Asaml2-
bearer&amp;assertion=PEFzc2VydGlvbiBJc3N1ZUluc3RhbnQ9IjIwMTEtMDU
[...omitted for brevity...]aG5TdGF0ZW1lbnQ-PC9Bc3NlcnRpb24-</code></pre></div>
<h1>5. Issuing an Access Token</h1>
<p>If everything fine - return access token and optionally refresh token, if something fails - return error response</p>
<h2>5.1. Successful Response</h2>
<ul>
<li><strong>access_token</strong> - REQUIRED. access token.</li>
<li><strong>token_type</strong> - REQUIRED. usually bearer</li>
<li><strong>expires_in</strong> - RECOMMENDED. The lifetime in seconds of the access token. For example, the value "3600" denotes that the access token will expire in one hour from the time the response was generated.</li>
<li><strong>refresh_token</strong> - OPTIONAL. The refresh token, which can be used to obtain new access tokens using the same authorization grant.</li>
<li><strong>scope</strong> - OPTIONAL, if identical to the scope requested by the client; otherwise, REQUIRED.</li>
</ul>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
  "access_token":"2YotnFZFEjr1zCsicMWpAA",
  "token_type":"example",
  "expires_in":3600,
  "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
  "example_parameter":"example_value"
}</code></pre></div>
<h2>5.2. Error Response</h2>
<ul>
<li><strong>error</strong> - REQUIRED. enum:
<ul>
<li>invalid_request - validation</li>
<li>invalid_client - Client authentication failed (e.g., unknown client, no client authentication included, or unsupported authentication method).  The authorization server MAY return an HTTP 401 (Unauthorized) status code to indicate which HTTP authentication schemes are supported.  If the client attempted to authenticate via the "Authorization" request header field, the authorization server MUST respond with an HTTP 401 (Unauthorized) status code and include the "WWW-Authenticate" response header field matching the authentication scheme used by the client.</li>
<li>invalid_grant - The provided authorization grant (e.g., authorization code, resource owner credentials) or refresh token is invalid, expired, revoked, does not match the redirection URI used in the authorization request, or was issued to another client.</li>
<li>unauthorized_client - The authenticated client is not authorized to use this authorization grant type.</li>
<li>unsupported_grant_type - The authorization grant type is not supported by the authorization server.</li>
<li>invalid_scope - The requested scope is invalid, unknown, malformed, or exceeds the scope granted by the resource owner.</li>
</ul>
</li>
<li><strong>error_description</strong> - OPTIONAL. Human-readable description</li>
<li><strong>error_uri</strong> - OPTIONAL. URL with details</li>
</ul>
<p>Example</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">HTTP/1.1 400 Bad Request
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
  "error":"invalid_request"
}</code></pre></div>
<h1>6. Refreshing an Access Token</h1>
<ul>
<li><strong>grant_type</strong> - REQUIRED. Value MUST be set to <code class="language-text">refresh_token</code>.</li>
<li><strong>refresh_token</strong> - REQUIRED. The refresh token issued to the client.</li>
<li><strong>scope</strong> - OPTIONAL. If provided will be passed to response.</li>
</ul>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&amp;refresh_token=tGzv3JOkF0XG5Qx2TlKWIA</code></pre></div>
<p>The authorization server MUST:</p>
<ul>
<li>require client authentication for confidential clients or for any client that was issued client credentials (or with other authentication requirements),</li>
<li>authenticate the client if client authentication is included and ensure that the refresh token was issued to the authenticated client, and</li>
<li>validate the refresh token.</li>
</ul>
<p>The authorization server MAY issue a new refresh token, in which case the client MUST discard the old refresh token and replace it with the new refresh token.  The authorization server MAY revoke the old refresh token after issuing a new refresh token to the client.  If a new refresh token is issued, the refresh token scope MUST be identical to that of the refresh token included by the client in the request.</p>
<h1>7. Accessing Protected Resources</h1>
<h2>7.1. Access Token Types</h2>
<p>Example bearer</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">GET /resource/1 HTTP/1.1
Host: example.com
Authorization: Bearer mF_9.B5f-4.1JqM</code></pre></div>
<p>Example mac</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">GET /resource/1 HTTP/1.1
Host: example.com
Authorization: MAC id="h480djs93hd8", nonce="274312:dj83hs9s", mac="kDZvddkndxvhGRXZhvuDjEWhGeE="</code></pre></div>
<h2>7.2. Error Response</h2>
<p>Not much details here, except the recommendation to provide error, its description and optionally url</p>
<h1>10. Security Considerations</h1>
<h2>10.1. Client Authentication</h2>
<p>Client secret should be keeped secret, do not embed it to mobile apps or SPA</p>
<h2>10.2. Client Impersonation</h2>
<p>whenever possible we should authenticate client by his client id and secret</p>
<p>if that's not possible make sure to check client id</p>
<p>and in all cases check redirect urls</p>
<h2>10.3. Access Tokens</h2>
<p>must be transfered only via https</p>
<h2>10.4. Refresh Tokens</h2>
<p>We should keep track client id to whom refresh token was issued</p>
<p>Only via https</p>
<p>Whenever client authenticated we must check if refresh token was issued for this client or not</p>
<p>Example: For example, the authorization server could employ refresh token rotation in which a new refresh token is issued with every access token refresh response.  The previous refresh token is invalidated but retained by the authorization server.  If a refresh token is compromised and subsequently used by both the attacker and the legitimate client, one of them will present an invalidated refresh token, which will inform the authorization server of the breach.</p>
<h2>10.5. Authorization Codes</h2>
<p>Authorization codes MUST be short lived and single-use.</p>
<h2>10.6. Authorization Code Redirection URI Manipulation</h2>
<p>We must check if redirection uri is the same that was used to authenticate</p>
<h2>10.7. Resource Owner Password Credentials</h2>
<p>is is not recommended to use this flow it was added for legacy apps</p>
<h2>10.8. Request Confidentiality</h2>
<p>everything should be transmitted over https</p>
<p>state and scope parameters should not include confidential data</p>
<h2>10.9. Ensuring Endpoint Authenticity</h2>
<p>tls verification should be enabled</p>
<h2>10.10. Credentials-Guessing Attacks</h2>
<p>all secrets should be big so guessing won't be possible in reasonable time</p>
<h2>10.11. Phishing Attacks</h2>
<p>valid https</p>
<h2>10.12. Cross-Site Request Forgery</h2>
<p>client should implement CSRF and pass state</p>
<p>auth service should alos implement CSRF for its auth endpoint</p>
<h2>10.13. Clickjacking</h2>
<p>use x-frame-options to prevent embeding in iframes</p>
<h2>10.14. Code Injection and Input Validation</h2>
<p>The authorization server and client MUST sanitize (and validate when possible) any value received -- in particular, the value of the "state" and "redirect_uri" parameters.</p>
<h2>10.15. Open Redirectors</h2>
<p>Make suer that auth service can not be used as redirector without any validations</p>
<h2>10.16. Misuse of Access Token to Impersonate Resource Owner in Implicit Flow</h2>
<p>if possible - do not use implicit flow</p>
<h1>Login with X</h1>
<p>Now it is time to check how it looks like and works in providers</p>
<p>Each time we need to register an app, I will left here full examples but they won't be workfing because after checking things I will remove them</p>
<p>Steps:</p>
<ul>
<li>register client and receive its credentials</li>
<li>retrieve access token from auth service</li>
<li>check scopes</li>
<li>send API call</li>
<li>refresh token</li>
</ul>
<p>Scenarious:</p>
<p>Web Applications (WebForms, MVC)</p>
<p><img src="https://developers.google.com/identity/protocols/oauth2/images/flows/authorization-code.png" alt="web applications flow"></p>
<p>Mobile apps (Android, iOS)</p>
<p><img src="https://developers.google.com/identity/protocols/oauth2/images/flows/authorization-code.png" alt="mobile apps"></p>
<p>Client apps (SPA)</p>
<p><img src="https://developers.google.com/identity/protocols/oauth2/images/flows/implicit.png" alt="client apps"></p>
<p>Devices (TV, XBOX)</p>
<p><img src="blob:https://rabota.atlassian.net/3f5f13ff-04c0-4469-987c-76f3b6675fe1" alt="devices"></p>
<p>Service Accounts</p>
<p><img src="https://developers.google.com/identity/protocols/oauth2/images/flows/jwt.png" alt="sa"></p>
<h2>Google</h2>
<p><a href="https://developers.google.com/identity/openid-connect/openid-connect">Docs</a></p>
<ul>
<li>client registration: <a href="https://console.cloud.google.com/apis/credentials?project=your-project-id">https://console.cloud.google.com/apis/credentials?project=your-project-id</a></li>
<li>discovery: <a href="https://accounts.google.com/.well-known/openid-configuration">https://accounts.google.com/.well-known/openid-configuration</a></li>
<li>authorization: <a href="https://accounts.google.com/o/oauth2/v2/auth">https://accounts.google.com/o/oauth2/v2/auth</a></li>
<li>token: <a href="https://oauth2.googleapis.com/token">https://oauth2.googleapis.com/token</a></li>
</ul>
<p>So I have filled up the registration form with minimal required fields and received identity for my client</p>
<ul>
<li>client_id: <code class="language-text">98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com</code></li>
<li>client_secret: <code class="language-text">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</code></li>
</ul>
<h3>Authorization Code Grant</h3>
<p>From 4.1.1 we know that it is required to pass <code class="language-text">response_type=code</code> and our client id, everything else is optional</p>
<p>From discovery document we know the authorization endpoint</p>
<p>So the end url we should open to user when he clicks login with button will be:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com&amp;redirect_uri=http%3A%2F%2Flocalhost%3A5000%2Fcallback&amp;scope=email%20profile</code></pre></div>
<p>Notes: Google requires scope, so I have added email and profile</p>
<p>Opening this link should show google login page, and after user logs in you will be redirected back to:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">http://localhost:5000/callback?code=4%2F0Adeu5BWehrhh2fFclFQn8_cwWuukfLYXMBVXAIsRNXgDbW66aAI39W-nDDL-EM7i-CoTqA&amp;scope=email+profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile+openid&amp;authuser=0&amp;prompt=consent#</code></pre></div>
<p>Now we can exchange received <code class="language-text">code</code> to <code class="language-text">access_token</code> by passing it to token endpoint we have found in discovery url</p>
<p>From 4.1.3 we know that it is required to authenticate client by providing client id and password, also we need to pass code we received and redirect_uri that was used, so the request will be:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" "https://oauth2.googleapis.com/token" -d "code=4%2F0Adeu5BWehrhh2fFclFQn8_cwWuukfLYXMBVXAIsRNXgDbW66aAI39W-nDDL-EM7i-CoTqA&amp;client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com&amp;client_secret=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&amp;grant_type=authorization_code&amp;redirect_uri=http://localhost:5000/callback"</code></pre></div>
<p>And indeed we received our response with access token</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"access_token"</span><span class="token operator">:</span> <span class="token string">"ya29.a0AfB_byD5HIEUFeALUFpqJ2AUM4tlbOioFuZeeftBvsh-8Y8Xl2dotb8xSwd10LN5iBOn2Lbbi2D0QftPKnJIqwaSJCBjJSBA8vtOMXDTanov19wvqKvHaOQHYgvcbp4_bSf2xpPOuaurqDzWaIuwObnGMgNXaCgYKAXISARASFQHsvYls1sBqtXDt-sJ6djCS_6ki6g0163"</span><span class="token punctuation">,</span>
  <span class="token property">"expires_in"</span><span class="token operator">:</span> <span class="token number">3599</span><span class="token punctuation">,</span>
  <span class="token property">"scope"</span><span class="token operator">:</span> <span class="token string">"https://www.googleapis.com/auth/userinfo.profile openid https://www.googleapis.com/auth/userinfo.email"</span><span class="token punctuation">,</span>
  <span class="token property">"token_type"</span><span class="token operator">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token property">"id_token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJSUzI1NiIsImtpZCI6IjkxMWUzOWUyNzkyOGFlOWYxZTlkMWUyMTY0NmRlOTJkMTkzNTFiNDQiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJhenAiOiI5ODQ0NzgyNzI1Mi1sMDlzOGhvZnAwZWs2dHNoaG5jNWw5M2U3MWxpNW12di5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsImF1ZCI6Ijk4NDQ3ODI3MjUyLWwwOXM4aG9mcDBlazZ0c2hobmM1bDkzZTcxbGk1bXZ2LmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tIiwic3ViIjoiMTE0MjU5MDY0MTkxNzkwNjk2ODEzIiwiZW1haWwiOiJtYXJjaGVua28uYWxleGFuZHJAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImF0X2hhc2giOiIzekFfNVZUVzY2dlNpeGhMLU9QR3h3IiwibmFtZSI6IkFsZXhhbmRyIE1hcmNoZW5rbyIsInBpY3R1cmUiOiJodHRwczovL2xoMy5nb29nbGV1c2VyY29udGVudC5jb20vYS9BQWNIVHRkWTRXR29oek5TNXZJaG9neEF5aVRta0Rvc2FLYy00MFZoVGw1RUY4am5fanc9czk2LWMiLCJnaXZlbl9uYW1lIjoiQWxleGFuZHIiLCJmYW1pbHlfbmFtZSI6Ik1hcmNoZW5rbyIsImxvY2FsZSI6ImVuIiwiaWF0IjoxNjkxMjM3MjQ1LCJleHAiOjE2OTEyNDA4NDV9.4cqF51TwCPwuICYVADIGBqxYbyMesbo-Bhu8yZ9hSEoOwbi0C0GeNnyWJqV3lOIAkMaDRs2E51AnIkBGXRqD1eM75OoRkEnz0C_EdbuXA48QHmTyOWpF9Ia3u1LumTx5v6fo_NJAbbUdjgJaYgk80EhbtFuOh1kzy57YAOSMNHQWmtSgviDXZfHe4PaQueGsqv6hkk7s5Qoskgph5p_AeOWToSXEx-RaEACldKqqRDMok_lNc7pRZhtUxJrMaMs8e4VS1zPjtGLN1uT8-j80L-k5T09luTNufllmTM3o5X0R4dRVddREdnfJ46D67oJ2DP7aE2-EMBt91uRhqC2TMw"</span>
<span class="token punctuation">}</span></code></pre></div>
<h1>OAuth 2.0 in nodejs</h1>
<p>Before jumping into dotnet I wan't to build something really simple in nodejs</p>
<p>The reasons are:</p>
<ul>
<li>no typing is good for prototyping</li>
<li>node has pretty good support for crypto stuff which will be helpful later</li>
<li>by intent all validations and etc are skipped to keep it small</li>
<li>each next eample is full version which should be runnable as is, it will make whole text bigger, but from my side is is just an embedding of yet another demo file that is runnable by itself, so just keep track of whats changed in comparison to previous step</li>
</ul>
<p>So our starting point is kind of analog to dotnet minimal api:</p>
<h2>HTTPS</h2>
<p>For HTTP we are going to use <a href="https://get.localhost.direct">get.localhost.direct</a> its github can be found <a href="https://github.com/Upinel/localhost.direct">here</a>, at moment of writing download link is <a href="https://aka.re/localhost">aka.re/localhost</a> and password is <code class="language-text">localhost</code></p>
<p>Inside archive there is <code class="language-text">localhost.direct.crt</code> and <code class="language-text">localhost.direct.key</code> files that may be used to serve our services under <code class="language-text">*.localhost.direct</code> with valid certs, which will be helpfull to have fully working demo without the need to figure out how to disable HTTPS checks everywhere</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'HTTPS'</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'HTTPS\n'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span></code></pre></div></p>
<h2>Authorization Endpoint - Code</h2>
<p>So lets try to implement both endpoints in minimal way</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

<span class="token comment">// As described in "2. Client Registration" and "2.3 Client Authentication" we should have at least `client_id` and `client_secret`, also `redirect_uris`, other possible settings will be `enabled`, `allowed_scopes`, etc</span>
<span class="token keyword">const</span> clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_secret</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uris</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/authorization'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Token'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not implemented\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Handle not found</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not Found\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span>

<span class="token comment">// Responsible for interaction with user, display authorization form, consent, etc</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unsupported response_type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response_type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Invalid request&lt;/h1>&lt;p>Unsupported &lt;code>response_type&lt;/code>&lt;/p>\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.1. Authorization Code Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> code <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// as described - code should have short lifetime (~10min) and if possible be one time use, also we are saving everything we can about request to validate it in future when exchanging</span>
      codes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        client_id<span class="token punctuation">,</span>
        response_type<span class="token punctuation">,</span>
        redirect_uri<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div></p>
<p>And if everything fine we should be able to access</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://auth.localhost.direct/authorization?response_type=code&amp;client_id=client1&amp;redirect_uri=https%3A%2F%2Fspa.localhost.direct%3A4200%2Fcallback</code></pre></div>
<p>Just enter any username and password and submit the form, you should be redirected to</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://spa.localhost.direct:4200/callback?code=0f38ec84-39d0-4682-b3bf-6fcbecd174e0</code></pre></div>
<p>Notes:</p>
<ul>
<li>in this demo we did not validate anthything at all - it is really important to not forget about this</li>
<li>only code grant is implemented, as you can gues implementing implicit flow will be even simpler, but we postnote it by intent, so we can build our exchange endpoint first</li>
</ul>
<p>After redirecting back, client uses received code in its backchannel to exchange it to access token</p>
<p>Here is another implementation where token endpoint added, once again as minimal as possible</p>
<h2>Token Endpoint</h2>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

<span class="token comment">// As described in "2. Client Registration" and "2.3 Client Authentication" we should have at least `client_id` and `client_secret`, also `redirect_uris`, other possible settings will be `enabled`, `allowed_scopes`, etc</span>
<span class="token keyword">const</span> clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_secret</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uris</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token comment">// for demo purposes, single code is hardcoded so we may skip authorization and call token directly</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'mac'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">60</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/authorization'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">token</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not Found\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span>

<span class="token comment">// Responsible for interaction with user, display authorization form, consent, etc</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unsupported response_type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response_type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Invalid request&lt;/h1>&lt;p>Unsupported &lt;code>response_type&lt;/code>&lt;/p>\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.1. Authorization Code Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> code <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// as described - code should have short lifetime (~10min) and if possible be one time use, also we are saving everything we can about request to validate it in future when exchanging</span>
      codes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        client_id<span class="token punctuation">,</span>
        response_type<span class="token punctuation">,</span>
        redirect_uri<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token comment">// const grant_type = body.get('grant_type')</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token comment">// const code = body.get('code')</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> codes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// validate everything, do not forget that code is short lived and should be one time used</span>

      <span class="token comment">// for simplicity we are using HS256, later it will be RSA and then JWKS, for not to keep things simple</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> code<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></p>
<p>Once again, we do not have checks, but still need go via authorization endpoint and then use the code like so:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST https://auth.localhost.direct/token <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"grant_type=authorization_code"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"code=123"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"redirect_uri=https://spa.localhost.direct:4200/callback"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"client_id=1"</span>
</code></pre></div>
<p>If everything fine, response will be something like:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"access_token"</span><span class="token operator">:</span><span class="token string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJtYWMiLCJuYmYiOjE2OTEzMDczMzMwNTIsImlhdCI6MTY5MTMwNzMzMzA4MiwiZXhwIjoxNjkxMzA3MzM2NjgyLCJpc3MiOiJodHRwczovL2F1dGgubG9jYWxob3N0LmRpcmVjdCIsImF1ZCI6IjEifQ.DcRud510QNoZCYGPVnoaZQEyKeD6oZyUa2PJt2onWeI"</span><span class="token punctuation">,</span>
  <span class="token property">"token_type"</span><span class="token operator">:</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token property">"expires_in"</span><span class="token operator">:</span><span class="token number">3600</span>
<span class="token punctuation">}</span></code></pre></div>
<p>and our token holds</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"mac"</span><span class="token punctuation">,</span>
  <span class="token property">"nbf"</span><span class="token operator">:</span> <span class="token number">1691307224585</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1691307224615</span><span class="token punctuation">,</span>
  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1691307228215</span><span class="token punctuation">,</span>
  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://auth.localhost.direct"</span><span class="token punctuation">,</span>
  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"1"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>So, technically that's it, literally that's is whole OAuth 2.0</p>
<p>Before moving further lets implmenet other flows</p>
<p>not sure if we will need all of them but from now it seems to be easy</p>
<h2>Authorization Endpoint - Implicit</h2>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

<span class="token comment">// As described in "2. Client Registration" and "2.3 Client Authentication" we should have at least `client_id` and `client_secret`, also `redirect_uris`, other possible settings will be `enabled`, `allowed_scopes`, etc</span>
<span class="token keyword">const</span> clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_secret</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uris</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token comment">// for demo purposes, single code is hardcoded so we may skip authorization and call token directly</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'mac'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">60</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/authorization'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">token</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not Found\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span>

<span class="token comment">// Responsible for interaction with user, display authorization form, consent, etc</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unsupported response_type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response_type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Invalid request&lt;/h1>&lt;p>Unsupported &lt;code>response_type&lt;/code>&lt;/p>\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.1. Authorization Code Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> code <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// as described - code should have short lifetime (~10min) and if possible be one time use, also we are saving everything we can about request to validate it in future when exchanging</span>
      codes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        client_id<span class="token punctuation">,</span>
        response_type<span class="token punctuation">,</span>
        redirect_uri<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.2. Implicit Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>

    <span class="token comment">// it is the same as in code flow</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>

      <span class="token comment">// the difference here is that we are not storing/dealing with code anymore and goind to redirect to url passinng access token in url fragment</span>
      <span class="token comment">// token generation copy pasted from token endpoint, later will be extracted, do not bother</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'token_type'</span><span class="token punctuation">,</span> <span class="token string">'Bearer'</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'expires_in'</span><span class="token punctuation">,</span> expires<span class="token punctuation">)</span>

      url<span class="token punctuation">.</span>hash <span class="token operator">=</span> fragment

      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token comment">// const grant_type = body.get('grant_type')</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token comment">// const code = body.get('code')</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> codes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// validate everything, do not forget that code is short lived and should be one time used</span>

      <span class="token comment">// for simplicity we are using HS256, later it will be RSA and then JWKS, for not to keep things simple</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> code<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></p>
<p>Notes:</p>
<ul>
<li>as usual all validations/etc skipped</li>
<li>authorization endpoint login form is totally the same as in code grant</li>
<li>handling of post request is different, instead of dealing with code we create access token and add it to redirect url hash</li>
</ul>
<p>If everything fine we should be able to open</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://auth.localhost.direct/authorization?response_type=token&amp;client_id=1&amp;redirect_uri=https%3A%2F%2Fspa.localhost.direct%3A4200%2Fcallback</code></pre></div>
<p>and after login we will be redirected to</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://spa.localhost.direct:4200/callback#access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhYWEiLCJuYmYiOjE2OTEzMDg2NTk2MjcsImlhdCI6MTY5MTMwODY1OTY1NywiZXhwIjoxNjkxMzA4NjYzMjU3LCJpc3MiOiJodHRwczovL2F1dGgubG9jYWxob3N0LmRpcmVjdCIsImF1ZCI6IjEifQ.9EWlJF8abRX8aTmNQ8JsPFQ7W6P6NUS2syNe9LM6Qi0&amp;token_type=Bearer&amp;expires_in=3600</code></pre></div>
<p>So it is kind of the same as code grant except of skipping intermediate step with code exchange</p>
<p>Last two flows probably wont be used at all so I am skipping them for now, it should be really clear how to implement them following the spec</p>
<h1>RSA asymmetric sign and verify</h1>
<p>So far our token was signed by symmetric algo which requires us to share secret between parties to verify token which makes it useless if we want to give access to 3rd party clients</p>
<p>Instead we are going to use private public key pairs to sign the token</p>
<p>Public key will be shared to all 3rd party clients so they can verify the token</p>
<p>Here is an minimal outline of how it works</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>

<span class="token comment">// just for example we are generating keys on the fly, there is quadrillion ways to create them, find more at https://github.com/mac2000/cryptography</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>privateKey<span class="token punctuation">,</span> publicKey<span class="token punctuation">}</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">modulusLength</span><span class="token operator">:</span> <span class="token number">2048</span><span class="token punctuation">,</span>
  <span class="token literal-property property">publicKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">privateKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token string">'The string that we want to sign with our private key'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>

<span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'signature'</span><span class="token punctuation">,</span> signature<span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> publicKey<span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>signature<span class="token punctuation">,</span> <span class="token string">'base64url'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span></code></pre></div></p>
<p>And here is something similar in plain bash</p>
<p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token comment"># create keys</span>
openssl genrsa <span class="token parameter variable">-out</span> private.pem <span class="token number">2048</span>
openssl rsa <span class="token parameter variable">-in</span> private.pem <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> public.pem

<span class="token comment"># the payload we are going to sign</span>
<span class="token builtin class-name">echo</span> <span class="token string">"The string that we want to sign with our private key"</span> <span class="token operator">></span> text.txt

<span class="token comment"># sign</span>
openssl dgst <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-sign</span> private.pem <span class="token parameter variable">-out</span> text.sign text.txt

<span class="token comment"># verify</span>
openssl dgst <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-verify</span> public.pem <span class="token parameter variable">-signature</span> text.sign text.txt</code></pre></div></p>
<p>Pretty good description can be found <a href="https://medium.com/@bn121rajesh/rsa-sign-and-verify-using-openssl-behind-the-scene-bf3cac0aade2">here</a></p>
<p>Notes:</p>
<ul>
<li>in bash you can try to play with base64 or hex to not store files but it is not purpose here and is left just for demo</li>
<li>in nodejs to read keys use something like <code class="language-text">crypto.createPublicKey(fs.readFileSync('public.pem', 'utf8'))</code></li>
<li>do not forget about paddings and other settings</li>
<li>do not forget to check your settings in other languages - aka how will you verify it in dotnet, golang, etc</li>
<li>in node to export keys use <code class="language-text">fs.writeFileSync('private.pem', privateKey, 'utf8')</code> but do not forget to set key format to <code class="language-text">pem</code></li>
</ul>
<p>With that in place, we can replace our token sign from <code class="language-text">HS256</code> to <code class="language-text">RSA256</code>, sign tokens with private keys, and share public key to everyone, including 3rd party clients - it will allow them to use our services without the need to share secrets</p>
<h1>JWKS</h1>
<p>Here is the dilema - even so we have private public keys, how can we rotate them without disturbing 3rd party clients</p>
<p>The easier approach will be to have more than one pair of keys</p>
<p>So whenever we need rotate them - we will just add new pair to the list and little bit later remove old one from the list</p>
<p>Our clients expected to not hardcode public keys but instead receive them from well known endpoint</p>
<h1>OpenId Connect Discovery Endpoint</h1>
<p>Before proceeding to JWKS we need to have oidc discovery endpoint, so clients will be able</p>
<p>List of parameters can be found here:</p>
<p><a href="https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata">https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata</a></p>
<p>Expected path is: <code class="language-text">/.well-known/openid-configuration</code></p>
<p>So lets create one with minial required params by looking at <a href="https://accounts.google.com/.well-known/openid-configuration">Goole endpoint</a> as example</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

<span class="token comment">// As described in "2. Client Registration" and "2.3 Client Authentication" we should have at least `client_id` and `client_secret`, also `redirect_uris`, other possible settings will be `enabled`, `allowed_scopes`, etc</span>
<span class="token keyword">const</span> clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_secret</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uris</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token comment">// for demo purposes, single code is hardcoded so we may skip authorization and call token directly</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'mac'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">60</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/.well-known/openid-configuration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">oidc</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/authorization'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">token</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not Found\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span>

<span class="token comment">// Responsible for interaction with user, display authorization form, consent, etc</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unsupported response_type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response_type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Invalid request&lt;/h1>&lt;p>Unsupported &lt;code>response_type&lt;/code>&lt;/p>\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.1. Authorization Code Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> code <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// as described - code should have short lifetime (~10min) and if possible be one time use, also we are saving everything we can about request to validate it in future when exchanging</span>
      codes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        client_id<span class="token punctuation">,</span>
        response_type<span class="token punctuation">,</span>
        redirect_uri<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.2. Implicit Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>

    <span class="token comment">// it is the same as in code flow</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>

      <span class="token comment">// the difference here is that we are not storing/dealing with code anymore and goind to redirect to url passinng access token in url fragment</span>
      <span class="token comment">// token generation copy pasted from token endpoint, later will be extracted, do not bother</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'token_type'</span><span class="token punctuation">,</span> <span class="token string">'Bearer'</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'expires_in'</span><span class="token punctuation">,</span> expires<span class="token punctuation">)</span>

      url<span class="token punctuation">.</span>hash <span class="token operator">=</span> fragment

      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token comment">// const grant_type = body.get('grant_type')</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token comment">// const code = body.get('code')</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> codes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// validate everything, do not forget that code is short lived and should be one time used</span>

      <span class="token comment">// for simplicity we are using HS256, later it will be RSA and then JWKS, for not to keep things simple</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> code<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3. OpenID Provider Metadata</span>
<span class="token comment">// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">oidc</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">issuer</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">authorization_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/authorization'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">token_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/token'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">jwks_uri</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/jwks'</span><span class="token punctuation">,</span> <span class="token comment">// TODO: we need to implement this in next step</span>
    <span class="token literal-property property">response_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "code", "token", "id_token", "code token", "code id_token", "token id_token", "code token id_token", "none" ]</span>
    <span class="token literal-property property">subject_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "public", "pairwise" ]</span>
    <span class="token literal-property property">id_token_signing_alg_values_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'RS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "RS256", "ES256" ]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></p>
<p>Now we should be able to access:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://auth.localhost.direct/.well-known/openid-configuration</code></pre></div>
<p>and see</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"issuer"</span><span class="token operator">:</span> <span class="token string">"https://auth.localhost.direct"</span><span class="token punctuation">,</span>
    <span class="token property">"authorization_endpoint"</span><span class="token operator">:</span> <span class="token string">"https://auth.localhost.direct/authorization"</span><span class="token punctuation">,</span>
    <span class="token property">"token_endpoint"</span><span class="token operator">:</span> <span class="token string">"https://auth.localhost.direct/token"</span><span class="token punctuation">,</span>
    <span class="token property">"jwks_uri"</span><span class="token operator">:</span> <span class="token string">"https://auth.localhost.direct/jwks"</span><span class="token punctuation">,</span>
    <span class="token property">"response_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"code"</span><span class="token punctuation">,</span>
        <span class="token string">"token"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"subject_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"public"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"id_token_signing_alg_values_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"RS256"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The idea behind this - our services will discover this endpoint, find jwks endpoint from it, read public keys and use them to verify incomming requests</p>
<h1>JWKS Endpoint</h1>
<p>Now it is turn to implement JWKS endpoint</p>
<p>Before doing it, lets see what Google have, from it <a href="https://accounts.google.com/.well-known/openid-configuration">discovery</a> endpoint we see that jwks endpoint is:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://www.googleapis.com/oauth2/v3/certs</code></pre></div>
<p>It responds with following json</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"n"</span><span class="token operator">:</span> <span class="token string">"8KImylelEspnZ0X-ekZb9VPbUFhgB_yEPJuLKOhXOWJLVsU0hJP6B_mQOfVk0CHm66UsAhqV8qrINk-RXgwVaaFLMA827pbOOBhyvHsThcyo7AY5s6M7qbftFKKnkfVHO6c9TsQ9wpIfmhCVL3QgTlqlgFQWcNsY-qemSKpqvVi-We9I3kPvbTf0PKJ_rWA7GQQnU_GA5JRU46uvw4I1ODf0icNBHw7pWc7oTvmSl1G8OWABEyiFakcUG2Xd4qZnmWaKwLHBvifPuIyy2vK-yHH91mVZCuleVu53Vzj77RgUtF2EEuB-zizwC-fzaBmvnfx1kgQLsdK22J0Ivgu4Xw"</span><span class="token punctuation">,</span>
      <span class="token property">"kty"</span><span class="token operator">:</span> <span class="token string">"RSA"</span><span class="token punctuation">,</span>
      <span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"RS256"</span><span class="token punctuation">,</span>
      <span class="token property">"kid"</span><span class="token operator">:</span> <span class="token string">"fd48a75138d9d48f0aa635ef569c4e196f7ae8d6"</span><span class="token punctuation">,</span>
      <span class="token property">"use"</span><span class="token operator">:</span> <span class="token string">"sig"</span><span class="token punctuation">,</span>
      <span class="token property">"e"</span><span class="token operator">:</span> <span class="token string">"AQAB"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"n"</span><span class="token operator">:</span> <span class="token string">"4kGxcWQdTW43aszLmftsGswmwDDKdfcse-lKeT_zjZTB2KGw9E6LVY6IThJVxzYF6mcyU-Z5_jDAW_yi7D_gXep2rxchZvoFayXynbhxyfjK6RtJ6_k30j-WpsXCSAiNAkupYHUyDIBNocvUcrDJsC3U65l8jl1I3nW98X6d-IlAfEb2In2f0fR6d-_lhIQZjXLupjymJduPjjA8oXCUZ9bfAYPhGYj3ZELUHkAyDpZNrnSi8hFVMSUSnorAt9F7cKMUJDM4-Uopzaqcl_f-HxeKvxN7NjiLSiIYaHdgtTpCEuNvsch6q6JTsllJNr3c__BxrG4UMlJ3_KsPxbcvXw"</span><span class="token punctuation">,</span>
      <span class="token property">"kid"</span><span class="token operator">:</span> <span class="token string">"911e39e27928ae9f1e9d1e21646de92d19351b44"</span><span class="token punctuation">,</span>
      <span class="token property">"e"</span><span class="token operator">:</span> <span class="token string">"AQAB"</span><span class="token punctuation">,</span>
      <span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"RS256"</span><span class="token punctuation">,</span>
      <span class="token property">"use"</span><span class="token operator">:</span> <span class="token string">"sig"</span><span class="token punctuation">,</span>
      <span class="token property">"kty"</span><span class="token operator">:</span> <span class="token string">"RSA"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And here is one for Microsoft</p>
<p><a href="https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration">https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration</a></p>
<p><a href="https://login.microsoftonline.com/common/discovery/v2.0/keys">https://login.microsoftonline.com/common/discovery/v2.0/keys</a></p>
<p>In addition to properties from Google it has:</p>
<ul>
<li><code class="language-text">issuer</code> - will be absolute url to our auth service</li>
<li><code class="language-text">x5t</code> - thumbprint of the x.509 cert (SHA-1 thumbprint)</li>
<li><code class="language-text">x5c</code> - x.509 certificate chain. The first entry in the array is the certificate to use for token verification; the other certificates can be used to verify this first certificate</li>
</ul>
<p>But it seems that they are optional, otherwise how should everything work with Google for example</p>
<p>The spec for JWKS is here</p>
<p><a href="https://datatracker.ietf.org/doc/html/rfc7517">https://datatracker.ietf.org/doc/html/rfc7517</a></p>
<p>Also there is pretty good description from OAuth0</p>
<p><a href="https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-key-set-properties">https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-key-set-properties</a></p>
<p>So we gonna need at least following properties:</p>
<ul>
<li><strong>kid</strong> - our key id, something unique per key, aka <code class="language-text">crypto.randomUUID()</code> or in our case just hardcode something like <code class="language-text">key1</code></li>
<li><strong>kty</strong> - <code class="language-text">RSA</code></li>
<li><strong>alg</strong> - <code class="language-text">RSA256</code></li>
<li><strong>use</strong> - <code class="language-text">sig</code></li>
<li><strong>n</strong> - base64url modulus of public key</li>
<li><strong>e</strong> - base64url exponent of public key</li>
</ul>
<p>Note: according to spec it is required to have <code class="language-text">RSA256</code> that's why we do not bother and just implementing it</p>
<p>As about modulus and exponent here is how to retrieve them in nodejs</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>

<span class="token comment">// just for example we are generating keys on the fly, there is quadrillion ways to create them, find more at https://github.com/mac2000/cryptography</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>privateKey<span class="token punctuation">,</span> publicKey<span class="token punctuation">}</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">modulusLength</span><span class="token operator">:</span> <span class="token number">2048</span><span class="token punctuation">,</span>
  <span class="token literal-property property">publicKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">privateKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// const publicKey = fs.readFileSync('public.pem');</span>

<span class="token keyword">const</span> rsa <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> modulus <span class="token operator">=</span> rsa<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs1'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">+</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> exponent <span class="token operator">=</span> rsa<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs1'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">n</span><span class="token operator">:</span> modulus<span class="token punctuation">,</span> <span class="token literal-property property">e</span><span class="token operator">:</span> exponent<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// -------------------------------------</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'jwk'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></p>
<p>Will definitely need a way to extract this info in other languages</p>
<p>Note: that values are expected to be base64url encoded</p>
<p>So having all that in place lets first implement jwks endpoint</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

<span class="token comment">// here are our keys that we will use to sign keys, also we will expose public key to the world</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>privateKey<span class="token punctuation">,</span> publicKey<span class="token punctuation">}</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">modulusLength</span><span class="token operator">:</span> <span class="token number">2048</span><span class="token punctuation">,</span>
  <span class="token literal-property property">publicKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">privateKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// As described in "2. Client Registration" and "2.3 Client Authentication" we should have at least `client_id` and `client_secret`, also `redirect_uris`, other possible settings will be `enabled`, `allowed_scopes`, etc</span>
<span class="token keyword">const</span> clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_secret</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uris</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token comment">// for demo purposes, single code is hardcoded so we may skip authorization and call token directly</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'mac'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">60</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/.well-known/openid-configuration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">oidc</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/jwks'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">jwks</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/authorization'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">token</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not Found\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span>

<span class="token comment">// Responsible for interaction with user, display authorization form, consent, etc</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unsupported response_type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response_type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Invalid request&lt;/h1>&lt;p>Unsupported &lt;code>response_type&lt;/code>&lt;/p>\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.1. Authorization Code Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> code <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// as described - code should have short lifetime (~10min) and if possible be one time use, also we are saving everything we can about request to validate it in future when exchanging</span>
      codes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        client_id<span class="token punctuation">,</span>
        response_type<span class="token punctuation">,</span>
        redirect_uri<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.2. Implicit Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>

    <span class="token comment">// it is the same as in code flow</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>

      <span class="token comment">// the difference here is that we are not storing/dealing with code anymore and goind to redirect to url passinng access token in url fragment</span>
      <span class="token comment">// token generation copy pasted from token endpoint, later will be extracted, do not bother</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'token_type'</span><span class="token punctuation">,</span> <span class="token string">'Bearer'</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'expires_in'</span><span class="token punctuation">,</span> expires<span class="token punctuation">)</span>

      url<span class="token punctuation">.</span>hash <span class="token operator">=</span> fragment

      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token comment">// const grant_type = body.get('grant_type')</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token comment">// const code = body.get('code')</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> codes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// validate everything, do not forget that code is short lived and should be one time used</span>

      <span class="token comment">// for simplicity we are using HS256, later it will be RSA and then JWKS, for not to keep things simple</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'HS256'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> code<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3. OpenID Provider Metadata</span>
<span class="token comment">// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">oidc</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">issuer</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">authorization_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/authorization'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">token_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/token'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">jwks_uri</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/jwks'</span><span class="token punctuation">,</span> <span class="token comment">// TODO: we need to implement this in next step</span>
    <span class="token literal-property property">response_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "code", "token", "id_token", "code token", "code id_token", "token id_token", "code token id_token", "none" ]</span>
    <span class="token literal-property property">subject_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "public", "pairwise" ]</span>
    <span class="token literal-property property">id_token_signing_alg_values_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'RS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "RS256", "ES256" ]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// https://datatracker.ietf.org/doc/html/rfc7517</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">jwks</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">keys</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">kty</span><span class="token operator">:</span> <span class="token string">'RSA'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">'sig'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">n</span><span class="token operator">:</span> crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs1'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">+</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">e</span><span class="token operator">:</span> crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs1'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'der'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></p>
<p>And we should be able to access</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://auth.localhost.direct/jwks</code></pre></div>
<p>And see soemthing like</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"kid"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
            <span class="token property">"kty"</span><span class="token operator">:</span> <span class="token string">"RSA"</span><span class="token punctuation">,</span>
            <span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"RS256"</span><span class="token punctuation">,</span>
            <span class="token property">"use"</span><span class="token operator">:</span> <span class="token string">"sig"</span><span class="token punctuation">,</span>
            <span class="token property">"n"</span><span class="token operator">:</span> <span class="token string">"t-WswdPi6x8mdO9kstaUB7SMRFRiIy2cRGrZt5soZJHPytfQtQ-uQksl5ksXj-Rqop2XdTpOkk0ktk2OpfHEbwOjAW-IRykC8wB9KGNaVNxB1Ox7IerBqi4S3AvdoYdDF2CanpTHlM_T3omBFccrWqonmZYpzEn2XlK6CoLICq9yyu2bLlgFGr863RXej6A4_MbT7MuJaFiyooEMfRaSgu0ajYMANl8Xb4zmJrgGGsF_sTf-GLKDH-CDWyO-yBn7vtwUzMEURl_NHpncHfzyIXjwxfCHmqileHfc_bBPa8bh2f0q7vtqJJi7_iFpAgMBAAE"</span><span class="token punctuation">,</span>
            <span class="token property">"e"</span><span class="token operator">:</span> <span class="token string">"AQAB"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<h1>Auth Service</h1>
<p>Now it is time to wireup everything into auth service</p>
<p>From last example the only thing is changed is that we are signing token with RSA</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

<span class="token comment">// here are our keys that we will use to sign keys, also we will expose public key to the world</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>privateKey<span class="token punctuation">,</span> publicKey<span class="token punctuation">}</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">modulusLength</span><span class="token operator">:</span> <span class="token number">2048</span><span class="token punctuation">,</span>
  <span class="token literal-property property">publicKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">privateKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// read private.pem into privateKey variable</span>
<span class="token comment">// const privateKey = crypto.createPrivateKey(readFileSync('private.pem'))</span>
<span class="token comment">// const publicKey = crypto.createPrivateKey(readFileSync('public.pem'))</span>

<span class="token comment">// As described in "2. Client Registration" and "2.3 Client Authentication" we should have at least `client_id` and `client_secret`, also `redirect_uris`, other possible settings will be `enabled`, `allowed_scopes`, etc</span>
<span class="token keyword">const</span> clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_secret</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uris</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token comment">// for demo purposes, single code is hardcoded so we may skip authorization and call token directly</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'mac'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">60</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/.well-known/openid-configuration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">oidc</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/jwks'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">jwks</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/authorization'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">token</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not Found\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span>

<span class="token comment">// Responsible for interaction with user, display authorization form, consent, etc</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unsupported response_type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response_type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Invalid request&lt;/h1>&lt;p>Unsupported &lt;code>response_type&lt;/code>&lt;/p>\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.1. Authorization Code Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> code <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// as described - code should have short lifetime (~10min) and if possible be one time use, also we are saving everything we can about request to validate it in future when exchanging</span>
      codes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        client_id<span class="token punctuation">,</span>
        response_type<span class="token punctuation">,</span>
        redirect_uri<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.2. Implicit Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>

    <span class="token comment">// it is the same as in code flow</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>

      <span class="token comment">// the difference here is that we are not storing/dealing with code anymore and goind to redirect to url passinng access token in url fragment</span>
      <span class="token comment">// token generation copy pasted from token endpoint, later will be extracted, do not bother</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> now <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'token_type'</span><span class="token punctuation">,</span> <span class="token string">'Bearer'</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'expires_in'</span><span class="token punctuation">,</span> expires<span class="token punctuation">)</span>

      url<span class="token punctuation">.</span>hash <span class="token operator">=</span> fragment

      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token comment">// const grant_type = body.get('grant_type')</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token comment">// const code = body.get('code')</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> codes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// validate everything, do not forget that code is short lived and should be one time used</span>

      <span class="token comment">// for simplicity we are using HS256, later it will be RSA and then JWKS, for not to keep things simple</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> code<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> now <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3. OpenID Provider Metadata</span>
<span class="token comment">// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">oidc</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OIDC discovery'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">issuer</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">authorization_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/authorization'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">token_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/token'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">jwks_uri</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/jwks'</span><span class="token punctuation">,</span> <span class="token comment">// TODO: we need to implement this in next step</span>
    <span class="token literal-property property">response_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "code", "token", "id_token", "code token", "code id_token", "token id_token", "code token id_token", "none" ]</span>
    <span class="token literal-property property">subject_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "public", "pairwise" ]</span>
    <span class="token literal-property property">id_token_signing_alg_values_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'RS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "RS256", "ES256" ]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// https://datatracker.ietf.org/doc/html/rfc7517</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">jwks</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JWKS'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">keys</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// {</span>
      <span class="token comment">//   kid: '1',</span>
      <span class="token comment">//   kty: 'RSA',</span>
      <span class="token comment">//   alg: 'RS256',</span>
      <span class="token comment">//   use: 'sig',</span>
      <span class="token comment">//   n: crypto.createPublicKey(publicKey).export({ type: 'pkcs1', format: 'der' }).subarray(28, 28 + 256).toString('base64url'),</span>
      <span class="token comment">//   e: crypto.createPublicKey(publicKey).export({ type: 'pkcs1', format: 'der' }).subarray(-3).toString('base64url')</span>
      <span class="token comment">// },</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kty</span><span class="token operator">:</span> <span class="token string">'RSA'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">'sig'</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'jwk'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></p>
<p>If everything fine we should be able to open:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://auth.localhost.direct/authorization?response_type=code&amp;client_id=client1&amp;redirect_uri=https%3A%2F%2Fspa.localhost.direct%3A4200%2Fcallback</code></pre></div>
<p>Enter any username and password and submit the form</p>
<p>We should be redirector to something like</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://spa.localhost.direct:4200/callback?code=eacf7f83-6bc9-47d1-9639-74d6f87f8a8c</code></pre></div>
<p>The next step will be to exchange <code class="language-text">code</code> to <code class="language-text">access_token</code> like so:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST https://auth.localhost.direct/token <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"grant_type=authorization_code"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"code=eacf7f83-6bc9-47d1-9639-74d6f87f8a8c"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"redirect_uri=https://spa.localhost.direct:4200/callback"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"client_id=1"</span></code></pre></div>
<p>And response should be</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"access_token"</span><span class="token operator">:</span><span class="token string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJSU0EyNTYifQ.eyJzdWIiOiJoZWxsbyIsIm5iZiI6MTY5MTMxNTIxODMwMSwiaWF0IjoxNjkxMzE1MjE4MzMxLCJleHAiOjE2OTEzMTUyMjE5MzEsImlzcyI6Imh0dHBzOi8vYXV0aC5sb2NhbGhvc3QuZGlyZWN0IiwiYXVkIjoiMSJ9.imetzopnd046Yx8nVKfpVTJxPEQbd7F85pZUC2ZgzlvohHrS1cR0utqrWL7LKqG7jLJhzO3yiIEwBHoQI9Z2FUWByXHTbmQHn7TA89LYEEcCLQa4bX1o50Vu8bM8mT4VMK9Gk_SDjv2fLqEmoiUs8SsTn24TN2K-Q1NtieuJUPhCS2gT3wgLkZjSBvgd3AHQ0GZkPnpKKOwn2NY7v1PJrp6oJlquYWXCbTms2CL0LaxbolSmxbDNgKcd6BekqpJHw8IiKAO_I5f3jz0lKJFn6Z5pPkAidqdmM8Q6ZocRDNajcnuAU3WQYUjnzkZviXxK-7uF3ChKx6Qp77Ceawc0Nw"</span><span class="token punctuation">,</span><span class="token property">"token_type"</span><span class="token operator">:</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span><span class="token property">"expires_in"</span><span class="token operator">:</span><span class="token number">3600</span><span class="token punctuation">}</span></code></pre></div>
<p>And our access token contains</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"hello"</span><span class="token punctuation">,</span>
  <span class="token property">"nbf"</span><span class="token operator">:</span> <span class="token number">1691315218301</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1691315218331</span><span class="token punctuation">,</span>
  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1691315221931</span><span class="token punctuation">,</span>
  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://auth.localhost.direct"</span><span class="token punctuation">,</span>
  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"1"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>For simplicity we may bypass authorization and just call:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">curl -s -X POST https://auth.localhost.direct/token \
  --data-urlencode "grant_type=authorization_code" \
  --data-urlencode "code=123" \
  --data-urlencode "redirect_uri=https://spa.localhost.direct:4200/callback" \
  --data-urlencode "client_id=1"</code></pre></div>
<p>And to check implicit flow we may open</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://auth.localhost.direct/authorization?response_type=token&amp;client_id=client1&amp;redirect_uri=https%3A%2F%2Fspa.localhost.direct%3A4200%2Fcallback</code></pre></div>
<p>Which will redirect us to</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://spa.localhost.direct:4200/callback#access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSU0EyNTYifQ.eyJzdWIiOiJoZWxsbyIsIm5iZiI6MTY5MTMxNTM1MDA1MCwiaWF0IjoxNjkxMzE1MzUwMDgwLCJleHAiOjE2OTEzMTUzNTM2ODAsImlzcyI6Imh0dHBzOi8vYXV0aC5sb2NhbGhvc3QuZGlyZWN0IiwiYXVkIjoiY2xpZW50MSJ9.oLLmr4D2NfAeP0UDWNLMPTgPoCsSj7o7fPxlPBKPeuYEe6Tj2bWrvzYwHkNXceItXhHoCW3PLZ6e8Bz4FXmFLCr415in1Ze02hyexkR4Qvw5b9kxMfCkH-CVMGm4YTNskq8HBp3t0Y9SeHUTBlcH8FNVvNof6LxpLiO-9cqpfhiyUUx45PvxSUrnkH5Azz_8mh_MdRVGntKki88NKOE3nbdCJjNAsd_-TDqrtA-kP2p5rPCf0kIA4qqfi-vtzccxIPk-ZT_KAZH1z6eTljxDzY_3QF4zZCPAct5OiLBTqVI_BcRw5bTi7iZwwGoClEOkPdxC9tR2F8AZIYRrNxZL5g&amp;token_type=Bearer&amp;expires_in=3600</code></pre></div>
<p>So our auth service is "implemented", let's see how it may be used</p>
<h1>Comments Service</h1>
<p>Let's pretend we have comments service, which is responsible for basic CRUD around comment entity, comments are belonging to users, so we need auth</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>

Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Logging<span class="token punctuation">.</span>IdentityModelEventSource<span class="token punctuation">.</span>ShowPII <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// for extended logging</span>

<span class="token comment">/*
mkdir comments
cd comments
dotnet new web --no-https --exclude-launch-settings
dotnet add package Microsoft.Identity.Web
*/</span>
<span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=></span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>Authority <span class="token operator">=</span> <span class="token string">"https://auth.localhost.direct"</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>Audience <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span>

        <span class="token comment">// for extended logging</span>
        options<span class="token punctuation">.</span>Events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtBearerEvents</span>
        <span class="token punctuation">{</span>
            OnMessageReceived <span class="token operator">=</span> context <span class="token operator">=></span>
            <span class="token punctuation">{</span>
                <span class="token class-name">ILogger</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token string">"JwtBearer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token string">"Message received: {0}"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            OnAuthenticationFailed <span class="token operator">=</span> context <span class="token operator">=></span>
            <span class="token punctuation">{</span>
                <span class="token class-name">ILogger</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token string">"JwtBearer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token string">"Authentication failed: {0}"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            OnTokenValidated <span class="token operator">=</span> context <span class="token operator">=></span>
            <span class="token punctuation">{</span>
                <span class="token class-name">ILogger</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token string">"JwtBearer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token string">"Token validated: {0}"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>SecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> user<span class="token punctuation">)</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>c <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyValuePair<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Now we can call it with our access token and magic should happen</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">token</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST https://auth.localhost.direct/token <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"grant_type=authorization_code"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"code=123"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"redirect_uri=https://spa.localhost.direct:4200/callback"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"client_id=1"</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">".access_token"</span><span class="token variable">)</span></span>
<span class="token function">curl</span> http://localhost:5000/ <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Bearer <span class="token variable">$token</span>"</span></code></pre></div>
<p>It did not worked out, after adding some logging/debuging it become obvious that I forget to add <code class="language-text">kid</code> to <code class="language-text">access_token</code>, indeed, how should our service verify it if it does not know which key was used to sign it</p>
<p>Also note that <code class="language-text">kid</code> should be added to header, not payload</p>
<p>It was almost working but I receive an verification error suggesting to read</p>
<p><a href="https://github.com/AzureAD/azure-activedirectory-identitymodel-extensions-for-dotnet/wiki/SecurityTokenInvalidSignatureException:-IDX10511">https://github.com/AzureAD/azure-activedirectory-identitymodel-extensions-for-dotnet/wiki/SecurityTokenInvalidSignatureException:-IDX10511</a></p>
<p>After a while it seems that my attempts of extracting module and exponent were incorrect but thankfully node has built in functionality for this</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'jwk'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>will give us</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"kty"</span><span class="token operator">:</span> <span class="token string">"RSA"</span><span class="token punctuation">,</span>
  <span class="token property">"n"</span><span class="token operator">:</span> <span class="token string">"4XlwmS06sKznL7jQ3-Q70Q_zNRc_gcWC27hCe741vqEd9q3u7yXXyV_UJS7Jl_zC-MlYgE9kelRaaEMCAXpF47TZxG4-kDORGBG-sBOeqUZ5Aqa-BG7B4XSEoQEaadE9e1Sh7zvI2rHrp8g3RsqIeOpVyMEoi7M3YAS_1BQTOy42RKDmYt_oSZSJxFsk7-eKTj1d4Hno6Ot7ddbJ6AtD0ySrYvC-pNh-hRogZy9TKBtjCCY87MWtWYXASkf2u2aUKGWDul9PTmYf93qCg7jKZRDwztU3YwVImr-2kAV2KWuBH9hs9-_drBFaXgA5j2jDlYfSSzAQgMqoR3nS5oE6cw"</span><span class="token punctuation">,</span>
  <span class="token property">"e"</span><span class="token operator">:</span> <span class="token string">"AQAB"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>which seems to be correct because dotnet now complained about expiration time</p>
<p>and this one was easy because in node we have milliseconds for <code class="language-text">Date.now()</code> need to convert it to seconds</p>
<p>and finally it did worked out</p>
<p>from logs of auth service I see that first oidc discovery wasa called, then jwks</p>
<p>from dotnet side in response I see</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"</span><span class="token punctuation">,</span>
    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"mac"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"nbf"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"1691318184"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"iat"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"1691318214"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"exp"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"1691321814"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"iss"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"https://auth.localhost.direct"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"aud"</span><span class="token punctuation">,</span> <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"1"</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre></div>
<p>and as you can guess subsecond calls dotnet does not call jwks anymore and uses cached keys</p>
<p>With that in place we have minimal OIDC/OAuth like auth service that works the same ways as Google/Microsoft</p>
<p>The next big topis are:</p>
<ul>
<li>refresh tokens in general - especialy for 3rd party, so they won't know user credentials but can talk to our services on behalf user</li>
<li>refresh tokens for SPA - implicit flow does not allow refresh token to be passed, in oidc there is dedicated hybrid flow</li>
<li>service to service api key replacement - instead of sharing api keys between services they should talk to each other with access tokens in passwordless manner</li>
<li>ability for our services to do something on behalf of user - only for our services, when we need to change something on behalf user in another service</li>
<li>scopes - aka roles/privileges</li>
<li>platforms - something similar in other platforms, for not dotnet</li>
</ul>
<h1>Scopes</h1>
<p>OAuth 2.0 spec does not specify much details about refresh tokens except the note that they are not supposed to be used in implicit flow</p>
<p>OIDC on the other hand has dedicated scope <code class="language-text">offline_access</code> which asks auth service to return refresh token as well</p>
<p>That's why we need to figure out how to work with scopes before everything else</p>
<p>Scopes are just space separated case sensitive list of ascii strings where order does not matter</p>
<p>OAuth itself does not define the scopes, but OIDC does</p>
<p>Here are some links:</p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6749#section-3.3">3.3. Access Token Scope</a></li>
<li><a href="https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims">5.4. Requesting Claims using Scope Values</a></li>
<li><a href="https://auth0.com/docs/get-started/apis/scopes/openid-connect-scopes">OpenID Connect Scopes</a></li>
</ul>
<p>Here are some of them:</p>
<ul>
<li><code class="language-text">openid</code> - required, client notifies auth service that it wants oidc, so id token should have <code class="language-text">sub</code>, <code class="language-text">iss</code>, <code class="language-text">aud</code>, <code class="language-text">exp</code>, <code class="language-text">iat</code>, and <code class="language-text">at_hash</code>. The last one used to verify id token</li>
<li><code class="language-text">profile</code> - optional, <code class="language-text">name</code>, <code class="language-text">family_name</code>, <code class="language-text">given_name</code>, <code class="language-text">middle_name</code>, <code class="language-text">nickname</code>, <code class="language-text">preferred_username</code>, <code class="language-text">profile</code>, <code class="language-text">picture</code>, <code class="language-text">website</code>, <code class="language-text">gender</code>, <code class="language-text">birthdate</code>, <code class="language-text">zoneinfo</code>, <code class="language-text">locale</code>, and <code class="language-text">updated_at</code>.</li>
<li><code class="language-text">email</code> - optional, <code class="language-text">email</code> and <code class="language-text">email_verified</code></li>
<li><code class="language-text">address</code> - optional, <code class="language-text">address</code></li>
<li><code class="language-text">phone</code> - optional, <code class="language-text">phone_number</code> and <code class="language-text">phone_number_verified</code></li>
</ul>
<p>Note: all this is passed with <code class="language-text">id_token</code>, not <code class="language-text">access_token</code> here is our Google example revisited</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com&amp;redirect_uri=http%3A%2F%2Flocalhost%3A5000%2Fcallback&amp;scope=openid%20%20profile%20email%20address%20phone</code></pre></div>
<p>Note: we asced for <code class="language-text">openid</code>, <code class="language-text">profile</code>, <code class="language-text">email</code>, <code class="language-text">address</code> and <code class="language-text">phone</code> scopes</p>
<p>Responds with:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">http://localhost:5000/callback?code=4%2F0Adeu5BW_sYQH2snUfhgc9r-xVbEkYyp0Br0_dffXV2io87Z61sNnOrCAsrd4f48qDQpaeQ&amp;scope=email+profile+openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email&amp;authuser=0&amp;prompt=consent#</code></pre></div>
<p>As described in spec, because scopes are little bit different - authorization endpoint returns us new list of scopes</p>
<p>Now let's exchange it</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST <span class="token string">"https://oauth2.googleapis.com/token"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"code=4%2F0Adeu5BW_sYQH2snUfhgc9r-xVbEkYyp0Br0_dffXV2io87Z61sNnOrCAsrd4f48qDQpaeQ"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"client_secret=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"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"grant_type=authorization_code"</span> <span class="token punctuation">\</span>
  --data-urlencode <span class="token string">"redirect_uri=http%3A%2F%2Flocalhost%3A5000%2Fcallback"</span></code></pre></div>
<p>But Google will complain that: You can't sign in to this app because it doesn't comply with Google's OAuth 2.0 policy for keeping apps secure.</p>
<p>So I have reduced number of scopes, added them to app, published app and finally it worked out:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com&amp;redirect_uri=https%3A%2F%2Fmac-blog.org.ua%2Fcallback&amp;scope=openid%20profile%20email&amp;state=state&amp;nonce=nonce</code></pre></div>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://mac-blog.org.ua/callback?state=state&amp;code=4%2F0Adeu5BWxpzHn1HEMpqw7nlR7CZxL0PcCEcKvaOU-gz6EzjMtjAqwEgQlWFY6XQSv4RjsEg&amp;scope=email+profile+openid+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile&amp;authuser=0&amp;prompt=none#</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST <span class="token string">"https://oauth2.googleapis.com/token"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"code=4%2F0Adeu5BWxpzHn1HEMpqw7nlR7CZxL0PcCEcKvaOU-gz6EzjMtjAqwEgQlWFY6XQSv4RjsEg"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"client_secret=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"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"grant_type=authorization_code"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"redirect_uri=https%3A%2F%2Fmac-blog.org.ua%2Fcallback"</span></code></pre></div>
<p>response is:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"access_token"</span><span class="token operator">:</span> <span class="token string">"ya29.a0AfB_byBEO4zuBfFs1iaqYCAz_re82KlNDo_l3__v5IrpfKFmgcacEQ6kjlxcf1GXSZOJOwLJ2hMPTNuLYQawWqBDgBL4TichdrWsScwNLsQW3xtl_gwjnzVKPzkiIUnjTCvBoOXkv6ON75fFwM55p2aNKHsUJQaCgYKAUwSARASFQHsvYlsnFZWKb58_Cndxrk5LC0kdw0165"</span><span class="token punctuation">,</span>
  <span class="token property">"expires_in"</span><span class="token operator">:</span> <span class="token number">3580</span><span class="token punctuation">,</span>
  <span class="token property">"scope"</span><span class="token operator">:</span> <span class="token string">"https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email openid"</span><span class="token punctuation">,</span>
  <span class="token property">"token_type"</span><span class="token operator">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token property">"id_token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJSUzI1NiIsImtpZCI6IjkxMWUzOWUyNzkyOGFlOWYxZTlkMWUyMTY0NmRlOTJkMTkzNTFiNDQiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJhenAiOiI5ODQ0NzgyNzI1Mi1sMDlzOGhvZnAwZWs2dHNoaG5jNWw5M2U3MWxpNW12di5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsImF1ZCI6Ijk4NDQ3ODI3MjUyLWwwOXM4aG9mcDBlazZ0c2hobmM1bDkzZTcxbGk1bXZ2LmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tIiwic3ViIjoiMTE0MjU5MDY0MTkxNzkwNjk2ODEzIiwiZW1haWwiOiJtYXJjaGVua28uYWxleGFuZHJAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImF0X2hhc2giOiJWaHVJcVFzb2xxNnJVb2FJT0l1ZG5RIiwibm9uY2UiOiJub25jZSIsIm5hbWUiOiJBbGV4YW5kciBNYXJjaGVua28iLCJwaWN0dXJlIjoiaHR0cHM6Ly9saDMuZ29vZ2xldXNlcmNvbnRlbnQuY29tL2EvQUFjSFR0ZFk0V0dvaHpOUzV2SWhvZ3hBeWlUbWtEb3NhS2MtNDBWaFRsNUVGOGpuX2p3PXM5Ni1jIiwiZ2l2ZW5fbmFtZSI6IkFsZXhhbmRyIiwiZmFtaWx5X25hbWUiOiJNYXJjaGVua28iLCJsb2NhbGUiOiJlbiIsImlhdCI6MTY5MTMyOTY5NywiZXhwIjoxNjkxMzMzMjk3fQ.CFpHDFzO5fmslVkniLAnZfKR17hFXrRQUEjmVz7H8TmT9hWI0nVZZtIzhwmZhdX86L3ROOvJmR5TY2ocvHjbOOTVHShp9okaXbv-n9blusiY1X6LuNifUezck-uAvu3tWITokaYuqSVdsmKEyijhzozth9ZuBQtR9jhyg2MeL_byqt9_mFb1n6Jjx_H5nbqCK5e_fSVb2WDEESqeBdyEu5-KJ-a57DaDjeloaegGWKF0X1sdkea_-Yy9IaAbCYqB4pQLMANgvy6DftdpDAfMvVrI5rf30F0DChhxR8s7z2Vzh68yaWfICgzg-c2C-WqCd7-mQhk5OVxMKx_qeNXmoQ"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>access token is something special and is not JWT, which is fine and prevents missconfsution</p>
<p>id token</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://accounts.google.com"</span><span class="token punctuation">,</span>
  <span class="token property">"azp"</span><span class="token operator">:</span> <span class="token string">"98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com"</span><span class="token punctuation">,</span>
  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com"</span><span class="token punctuation">,</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"114259064191790696813"</span><span class="token punctuation">,</span>
  <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"marchenko.alexandr@gmail.com"</span><span class="token punctuation">,</span>
  <span class="token property">"email_verified"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"at_hash"</span><span class="token operator">:</span> <span class="token string">"VhuIqQsolq6rUoaIOIudnQ"</span><span class="token punctuation">,</span>
  <span class="token property">"nonce"</span><span class="token operator">:</span> <span class="token string">"nonce"</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Alexandr Marchenko"</span><span class="token punctuation">,</span>
  <span class="token property">"picture"</span><span class="token operator">:</span> <span class="token string">"https://lh3.googleusercontent.com/a/AAcHTtdY4WGohzNS5vIhogxAyiTmkDosaKc-40VhTl5EF8jn_jw=s96-c"</span><span class="token punctuation">,</span>
  <span class="token property">"given_name"</span><span class="token operator">:</span> <span class="token string">"Alexandr"</span><span class="token punctuation">,</span>
  <span class="token property">"family_name"</span><span class="token operator">:</span> <span class="token string">"Marchenko"</span><span class="token punctuation">,</span>
  <span class="token property">"locale"</span><span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1691329697</span><span class="token punctuation">,</span>
  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1691333297</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Pretty good explanation is here: <a href="https://www.youtube.com/watch?v=vVM1Tpu9QB4">ID Tokens VS Access Tokens: What's the Difference?</a></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0bab2f9f519fa26b8e7e178ae5c05cad/670dc/id-token-vs-access-token.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 215.234375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAArABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEBQL/xAAXAQADAQAAAAAAAAAAAAAAAAAAAgMB/9oADAMBAAIQAxAAAAHS4zFVXdEkmSqhTFgswczMZWVZIav/xAAeEAACAgICAwAAAAAAAAAAAAABAgADBBIREyEiMf/aAAgBAQABBQJRtK/aVHxba4t7rJisWrG3NO8x/itqayVlTQBWnAhmxB7XgYz/xAAYEQEBAQEBAAAAAAAAAAAAAAAAAREDEv/aAAgBAwEBPwFEbE6R61//xAAbEQACAQUAAAAAAAAAAAAAAAAAAQIDEBESMf/aAAgBAgEBPwEl22GOkzQ//8QAIBAAAQQBBAMAAAAAAAAAAAAAAAECETEhEjJBUhAigf/aAAgBAQAGPwJZV1jpVcKLdjoTkpPgqqnI6NO5bHxp3D57C+rr6jpa7Lp2jrTJMeMFlln/xAAeEAEAAgICAwEAAAAAAAAAAAABABEhMUFREGGRgf/aAAgBAQABPyFGwZlXL9TDMVttTMwJIB65lmi+LhMhvrmdf8T3P0K7JbQu+taI9nbd2c7YMptpd1qVrzMfJcaiFwaMQwi8Fcf/2gAMAwEAAgADAAAAEJ88DUD/AP/EABcRAQEBAQAAAAAAAAAAAAAAAAERACH/2gAIAQMBAT8QLYYQmle5Plwop3JVd//EABoRAQADAQEBAAAAAAAAAAAAAAEAESFhMUH/2gAIAQIBAT8Q+PeeTSi0NEW2otxggqf/xAAfEAEAAwEAAgIDAAAAAAAAAAABABEhMUFhUXGRodH/2gAIAQEAAT8QqNBBWiBldxq5DdGI90V2A5o3WHrusA3Wuq0PLusqocfoNfcRtcWxf2lBd8tu5zeT7/la9CCJMyDRcbMbj1F33Y1XJZZqoWaUajsrkW033ErCqX7lMNbxjviW49ObPb/B/IM35fB9z//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="ID Token and Access Token: What&#39;s the Difference?"
        title=""
        src="/static/0bab2f9f519fa26b8e7e178ae5c05cad/72e01/id-token-vs-access-token.jpg"
        srcset="/static/0bab2f9f519fa26b8e7e178ae5c05cad/e4a55/id-token-vs-access-token.jpg 256w,
/static/0bab2f9f519fa26b8e7e178ae5c05cad/36dd4/id-token-vs-access-token.jpg 512w,
/static/0bab2f9f519fa26b8e7e178ae5c05cad/72e01/id-token-vs-access-token.jpg 1024w,
/static/0bab2f9f519fa26b8e7e178ae5c05cad/ac99c/id-token-vs-access-token.jpg 1536w,
/static/0bab2f9f519fa26b8e7e178ae5c05cad/670dc/id-token-vs-access-token.jpg 1650w"
        sizes="(max-width: 1024px) 100vw, 1024px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>Image taken from <a href="https://auth0.com/blog/id-token-access-token-what-is-the-difference/">here</a></p>
<p>Also note that even so we did not asked for it in our initial request we had <code class="language-text">response_type=code</code> not <code class="language-text">response_type=code%20id_token</code> Google still returns id token to us</p>
<p>id token from Google has life time for 1hr</p>
<p>In header it has <code class="language-text">kid</code> so we can verify it the same way as we did for access tokens</p>
<p>It has <code class="language-text">at_hash</code> that can be used to verify received <code class="language-text">access_token</code> something like this</p>
<p>Here is an bash example</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>access_token<span class="token punctuation">,</span> id_token<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">"access_token"</span><span class="token operator">:</span> <span class="token string">"ya29.a0AfB_byBEO4zuBfFs1iaqYCAz_re82KlNDo_l3__v5IrpfKFmgcacEQ6kjlxcf1GXSZOJOwLJ2hMPTNuLYQawWqBDgBL4TichdrWsScwNLsQW3xtl_gwjnzVKPzkiIUnjTCvBoOXkv6ON75fFwM55p2aNKHsUJQaCgYKAUwSARASFQHsvYlsnFZWKb58_Cndxrk5LC0kdw0165"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"expires_in"</span><span class="token operator">:</span> <span class="token number">3580</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email openid"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"token_type"</span><span class="token operator">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"id_token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJSUzI1NiIsImtpZCI6IjkxMWUzOWUyNzkyOGFlOWYxZTlkMWUyMTY0NmRlOTJkMTkzNTFiNDQiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJhenAiOiI5ODQ0NzgyNzI1Mi1sMDlzOGhvZnAwZWs2dHNoaG5jNWw5M2U3MWxpNW12di5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsImF1ZCI6Ijk4NDQ3ODI3MjUyLWwwOXM4aG9mcDBlazZ0c2hobmM1bDkzZTcxbGk1bXZ2LmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tIiwic3ViIjoiMTE0MjU5MDY0MTkxNzkwNjk2ODEzIiwiZW1haWwiOiJtYXJjaGVua28uYWxleGFuZHJAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImF0X2hhc2giOiJWaHVJcVFzb2xxNnJVb2FJT0l1ZG5RIiwibm9uY2UiOiJub25jZSIsIm5hbWUiOiJBbGV4YW5kciBNYXJjaGVua28iLCJwaWN0dXJlIjoiaHR0cHM6Ly9saDMuZ29vZ2xldXNlcmNvbnRlbnQuY29tL2EvQUFjSFR0ZFk0V0dvaHpOUzV2SWhvZ3hBeWlUbWtEb3NhS2MtNDBWaFRsNUVGOGpuX2p3PXM5Ni1jIiwiZ2l2ZW5fbmFtZSI6IkFsZXhhbmRyIiwiZmFtaWx5X25hbWUiOiJNYXJjaGVua28iLCJsb2NhbGUiOiJlbiIsImlhdCI6MTY5MTMyOTY5NywiZXhwIjoxNjkxMzMzMjk3fQ.CFpHDFzO5fmslVkniLAnZfKR17hFXrRQUEjmVz7H8TmT9hWI0nVZZtIzhwmZhdX86L3ROOvJmR5TY2ocvHjbOOTVHShp9okaXbv-n9blusiY1X6LuNifUezck-uAvu3tWITokaYuqSVdsmKEyijhzozth9ZuBQtR9jhyg2MeL_byqt9_mFb1n6Jjx_H5nbqCK5e_fSVb2WDEESqeBdyEu5-KJ-a57DaDjeloaegGWKF0X1sdkea_-Yy9IaAbCYqB4pQLMANgvy6DftdpDAfMvVrI5rf30F0DChhxR8s7z2Vzh68yaWfICgzg-c2C-WqCd7-mQhk5OVxMKx_qeNXmoQ"</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>at_hash<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>id_token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'base64url'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>at_hash<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token literal-property property">equal</span><span class="token operator">:</span> at_hash <span class="token operator">===</span> hash<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/*
{
  at_hash: 'VhuIqQsolq6rUoaIOIudnQ',
  hash: 'VhuIqQsolq6rUoaIOIudnQ',
  equal: true
}
*/</span></code></pre></div></p>
<p>Just from curiosity, if we will try <code class="language-text">response_type=code id_token</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://accounts.google.com/o/oauth2/v2/auth?response_type=code%20id_token&amp;client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com&amp;redirect_uri=https%3A%2F%2Fmac-blog.org.ua%2Fcallback&amp;scope=openid%20profile%20email&amp;state=state&amp;nonce=nonce</code></pre></div>
<p>Response will be</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://mac-blog.org.ua/callback#state=state&amp;code=4/0Adeu5BX4aWtmO8bYiaMIUwmMM9Fz1zICN54h10SNzory-IrQYFxU0h81sh-r3vSEQcL5jw&amp;scope=email%20profile%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/userinfo.profile&amp;id_token=eyJhbGciOiJSUzI1NiIsImtpZCI6IjkxMWUzOWUyNzkyOGFlOWYxZTlkMWUyMTY0NmRlOTJkMTkzNTFiNDQiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJhenAiOiI5ODQ0NzgyNzI1Mi1sMDlzOGhvZnAwZWs2dHNoaG5jNWw5M2U3MWxpNW12di5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsImF1ZCI6Ijk4NDQ3ODI3MjUyLWwwOXM4aG9mcDBlazZ0c2hobmM1bDkzZTcxbGk1bXZ2LmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tIiwic3ViIjoiMTE0MjU5MDY0MTkxNzkwNjk2ODEzIiwiZW1haWwiOiJtYXJjaGVua28uYWxleGFuZHJAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImNfaGFzaCI6ImJRdkJnSFB5OGVYOWYwVkxiQ04zMmciLCJub25jZSI6Im5vbmNlIiwibmJmIjoxNjkxMzMxNzM3LCJuYW1lIjoiQWxleGFuZHIgTWFyY2hlbmtvIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FBY0hUdGRZNFdHb2h6TlM1dklob2d4QXlpVG1rRG9zYUtjLTQwVmhUbDVFRjhqbl9qdz1zOTYtYyIsImdpdmVuX25hbWUiOiJBbGV4YW5kciIsImZhbWlseV9uYW1lIjoiTWFyY2hlbmtvIiwibG9jYWxlIjoiZW4iLCJpYXQiOjE2OTEzMzIwMzcsImV4cCI6MTY5MTMzNTYzNywianRpIjoiOGZjOTYxMDczOTRhMDg0ZDU2M2ZhZWU4MzdmOTFjZWNkMzIyYzRlZiJ9.J9dJpPYLoOMDdQtjIVuGUJ-jHBRpaNDCbtKpSnb32zVIeOBMW49l6OzXKPXbRMfRwA8esfErePvbHc0J981JJJZNJWREhvj5d7rZIVestaTWzl4KqaIiu9Qj9HBAlQSU_SVLPEKXkFbMHFEQder7nBbZvKx1C9A8xyKflzpYiffJnrmsYM07UjrCTXZXPVZjfMFr1i1NiSadZgv2gbaM5cHFHsiinIo4jL2umoWMyBdPTYxRw9RIIJasAAj3IwKSOrGgWE_CsTvd_PEbYqNYNL5sYs2NHWqgMfOY8DJJF9rcIYHn1whH0EEqIsYay2KWUA5nfIpol-zyOtQPkAhOqQ&amp;authuser=0&amp;prompt=none</code></pre></div>
<p>Note how <code class="language-text">id_token</code> is passed in query string as well</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST <span class="token string">"https://oauth2.googleapis.com/token"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"code=4/0Adeu5BX4aWtmO8bYiaMIUwmMM9Fz1zICN54h10SNzory-IrQYFxU0h81sh-r3vSEQcL5jw"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"client_secret=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"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"grant_type=authorization_code"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">"redirect_uri=https%3A%2F%2Fmac-blog.org.ua%2Fcallback"</span></code></pre></div>
<p>And exchange endpoint returns the same, so this id token in query string may be used to immediatelly get some basic user info as well as validating access token after exchange</p>
<p>So back to scopes, as you can guess, scopes are used as well to restrict some access, the interesting fact here is that by default in dotnet, for example, the claims them selves are used for authorization, but not scopes</p>
<p>There is pretty good article for dotnet</p>
<p><a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/scenario-protected-web-api-verification-scope-app-roles?tabs=aspnetcore">https://learn.microsoft.com/en-us/azure/active-directory/develop/scenario-protected-web-api-verification-scope-app-roles?tabs=aspnetcore</a></p>
<p>With important note - protection ensures that the API is called only by:</p>
<ul>
<li>Applications on behalf of users who have the right scopes and roles.</li>
<li>Daemon apps that have the right application roles.</li>
</ul>
<p>Another good article</p>
<p><a href="https://weblog.west-wind.com/posts/2021/Mar/09/Role-based-JWT-Tokens-in-ASPNET-Core">https://weblog.west-wind.com/posts/2021/Mar/09/Role-based-JWT-Tokens-in-ASPNET-Core</a></p>
<p>Notes</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token comment">// Add roles as multiple claims</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> role <span class="token keyword">in</span> user<span class="token punctuation">.</span>Roles<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	claims<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> role<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// these also work - and reduce token size</span>
	<span class="token comment">// claims.Add(new Claim("roles", role.Name));</span>
	<span class="token comment">// claims.Add(new Claim("role", role.Name));</span>
<span class="token punctuation">}</span></code></pre></div>
<p>all it does - adds "role" string array to JWT token, and can by used by attribute like <code class="language-text">[Authorize(Roles = "Administrator")]</code></p>
<p>And finaly from Duende (former Identity Server) <a href="https://docs.duendesoftware.com/identityserver/v5/apis/aspnetcore/authorization/#scope-claim-format">docs</a> I see following:</p>
<blockquote>
<p>Historically, Duende IdentityServer emitted the scope claims as an array in the JWT. This works very well with the .NET deserialization logic, which turns every array item into a separate claim of type scope.</p>
<p>The newer JWT Profile for OAuth spec mandates that the scope claim is a single space delimited string.</p>
</blockquote>
<p>And indeed <a href="https://datatracker.ietf.org/doc/html/rfc9068#section-2.2.3">2.2.3. Authorization Claims</a> says:</p>
<blockquote>
<p>If an authorization request includes a scope parameter, the corresponding issued JWT access token SHOULD include a "scope" claim</p>
</blockquote>
<p>So all we need to add to our auth service is the addition of scope parameter to generated access token</p>
<p>also for further experiments we need password grant, so we can generate access tokens by curl and make api calls</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

<span class="token comment">// here are our keys that we will use to sign keys, also we will expose public key to the world</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>privateKey<span class="token punctuation">,</span> publicKey<span class="token punctuation">}</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">modulusLength</span><span class="token operator">:</span> <span class="token number">2048</span><span class="token punctuation">,</span>
  <span class="token literal-property property">publicKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">privateKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// read private.pem into privateKey variable</span>
<span class="token comment">// const privateKey = crypto.createPrivateKey(readFileSync('private.pem'))</span>
<span class="token comment">// const publicKey = crypto.createPrivateKey(readFileSync('public.pem'))</span>

<span class="token comment">// As described in "2. Client Registration" and "2.3 Client Authentication" we should have at least `client_id` and `client_secret`, also `redirect_uris`, other possible settings will be `enabled`, `allowed_scopes`, etc</span>
<span class="token keyword">const</span> clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_secret</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uris</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token comment">// for demo purposes, single code is hardcoded so we may skip authorization and call token directly</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'mac'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">60</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/.well-known/openid-configuration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">oidc</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/jwks'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">jwks</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/authorization'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">token</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not Found\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span>

<span class="token comment">// Responsible for interaction with user, display authorization form, consent, etc</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// // wont work here, because response_type is passed as post param</span>
  <span class="token comment">// else if (response_type === 'password') {</span>
  <span class="token comment">//   return await authorization_password_grant(req, res)</span>
  <span class="token comment">// }</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_password_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token comment">// as a workaround to not bother</span>
    <span class="token comment">// console.log(`Unsupported response_type: ${response_type}`)</span>
    <span class="token comment">// return res.setHeader('content-type', 'text/html').writeHead(400).end('&lt;h1>Invalid request&lt;/h1>&lt;p>Unsupported &lt;code>response_type&lt;/code>&lt;/p>\n')</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.1. Authorization Code Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> code <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// as described - code should have short lifetime (~10min) and if possible be one time use, also we are saving everything we can about request to validate it in future when exchanging</span>
      codes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        client_id<span class="token punctuation">,</span>
        response_type<span class="token punctuation">,</span>
        redirect_uri<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token literal-property property">scope</span><span class="token operator">:</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.2. Implicit Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>

    <span class="token comment">// it is the same as in code flow</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>

      <span class="token comment">// the difference here is that we are not storing/dealing with code anymore and goind to redirect to url passinng access token in url fragment</span>
      <span class="token comment">// token generation copy pasted from token endpoint, later will be extracted, do not bother</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> now <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
        <span class="token literal-property property">scope</span><span class="token operator">:</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'token_type'</span><span class="token punctuation">,</span> <span class="token string">'Bearer'</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'expires_in'</span><span class="token punctuation">,</span> expires<span class="token punctuation">)</span>

      url<span class="token punctuation">.</span>hash <span class="token operator">=</span> fragment

      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.3. Resource Owner Password Credentials Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_password_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// TODO: expected client authentication here, as described in "2.3 Client Authentication" either basic auth header or form fields</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
    <span class="token comment">// const client_secret = body.get('client_secret')</span>
    <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    <span class="token comment">// const password = body.get('password')</span>
    <span class="token keyword">const</span> scope <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
    <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">sub</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
      <span class="token literal-property property">nbf</span><span class="token operator">:</span> now <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
      <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
      <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> expires<span class="token punctuation">,</span>
      <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      scope
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token comment">// const grant_type = body.get('grant_type')</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token comment">// const code = body.get('code')</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> codes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// validate everything, do not forget that code is short lived and should be one time used</span>

      <span class="token comment">// for simplicity we are using HS256, later it will be RSA and then JWKS, for not to keep things simple</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> code<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> now <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
        <span class="token literal-property property">scope</span><span class="token operator">:</span> code<span class="token punctuation">.</span>scope
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3. OpenID Provider Metadata</span>
<span class="token comment">// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">oidc</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OIDC discovery'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">issuer</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">authorization_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/authorization'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">token_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/token'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">jwks_uri</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/jwks'</span><span class="token punctuation">,</span> <span class="token comment">// TODO: we need to implement this in next step</span>
    <span class="token literal-property property">response_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "code", "token", "id_token", "code token", "code id_token", "token id_token", "code token id_token", "none" ]</span>
    <span class="token literal-property property">subject_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "public", "pairwise" ]</span>
    <span class="token literal-property property">id_token_signing_alg_values_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'RS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "RS256", "ES256" ]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// https://datatracker.ietf.org/doc/html/rfc7517</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">jwks</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JWKS'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">keys</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// {</span>
      <span class="token comment">//   kid: '1',</span>
      <span class="token comment">//   kty: 'RSA',</span>
      <span class="token comment">//   alg: 'RS256',</span>
      <span class="token comment">//   use: 'sig',</span>
      <span class="token comment">//   n: crypto.createPublicKey(publicKey).export({ type: 'pkcs1', format: 'der' }).subarray(28, 28 + 256).toString('base64url'),</span>
      <span class="token comment">//   e: crypto.createPublicKey(publicKey).export({ type: 'pkcs1', format: 'der' }).subarray(-3).toString('base64url')</span>
      <span class="token comment">// },</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kty</span><span class="token operator">:</span> <span class="token string">'RSA'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">'sig'</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'jwk'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></p>
<p>Let's pretend that for our comments service we will have following scopes (aka something similar to Azure):</p>
<ul>
<li><code class="language-text">Comment.Read</code> - read own comments</li>
<li><code class="language-text">Comment.Write</code> - write own comments</li>
<li><code class="language-text">Comment.ReadWrite</code> - read and write own comments, as well as delete</li>
<li><code class="language-text">Comment.Read.All</code> - read all comments</li>
<li><code class="language-text">Comment.Write.All</code> - write all comments</li>
<li><code class="language-text">Comment.ReadWrite.All</code> - read and write own comments, as well as delete</li>
</ul>
<p>But it seems to be way to many, let's reduce them to</p>
<ul>
<li><code class="language-text">comments.read</code> - read only</li>
<li><code class="language-text">comments.write</code> - basic CRUD for own comments</li>
<li><code class="language-text">comments.admin</code> - elevated privileges</li>
</ul>
<p>And here is modified dotnet service</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>

Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Logging<span class="token punctuation">.</span>IdentityModelEventSource<span class="token punctuation">.</span>ShowPII <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// for extended logging</span>

<span class="token comment">/*
mkdir comments
cd comments
dotnet new web --no-https --exclude-launch-settings
dotnet add package Microsoft.Identity.Web
*/</span>
<span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=></span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"comments.read"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">"scope"</span><span class="token punctuation">,</span> <span class="token string">"comments.read"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"comments.write"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">"scope"</span><span class="token punctuation">,</span> <span class="token string">"comments.write"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"comments.admin"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">"scope"</span><span class="token punctuation">,</span> <span class="token string">"comments.admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=></span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>Authority <span class="token operator">=</span> <span class="token string">"https://auth.localhost.direct"</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>Audience <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span>

        <span class="token comment">// for extended logging</span>
        options<span class="token punctuation">.</span>Events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtBearerEvents</span>
        <span class="token punctuation">{</span>
            OnMessageReceived <span class="token operator">=</span> context <span class="token operator">=></span>
            <span class="token punctuation">{</span>
                <span class="token class-name">ILogger</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token string">"JwtBearer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token string">"Message received: {0}"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            OnAuthenticationFailed <span class="token operator">=</span> context <span class="token operator">=></span>
            <span class="token punctuation">{</span>
                <span class="token class-name">ILogger</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token string">"JwtBearer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token string">"Authentication failed: {0}"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            OnTokenValidated <span class="token operator">=</span> context <span class="token operator">=></span>
            <span class="token punctuation">{</span>
                <span class="token class-name">ILogger</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token string">"JwtBearer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token string">"Token validated: {0}"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>SecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> user<span class="token punctuation">)</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>c <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyValuePair<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/comments"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"returns all comments"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RequireAuthorization</span><span class="token punctuation">(</span><span class="token string">"comments.read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">MapPost</span><span class="token punctuation">(</span><span class="token string">"/comments"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"create comment"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RequireAuthorization</span><span class="token punctuation">(</span><span class="token string">"comments.write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">MapDelete</span><span class="token punctuation">(</span><span class="token string">"/comments"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"delete comment"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RequireAuthorization</span><span class="token punctuation">(</span><span class="token string">"comments.admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>And our experiment is</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">token</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST <span class="token string">"https://auth.localhost.direct/authorization"</span> <span class="token parameter variable">-d</span> <span class="token string">"response_type=password"</span> <span class="token parameter variable">-d</span> <span class="token string">"client_id=1"</span> <span class="token parameter variable">-d</span> <span class="token string">"client_secret=2"</span> <span class="token parameter variable">-d</span> <span class="token string">"username=mac"</span> <span class="token parameter variable">-d</span> <span class="token string">"password=123"</span> <span class="token parameter variable">-d</span> <span class="token string">"scope=comments.write"</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">".access_token"</span><span class="token variable">)</span></span>

<span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> GET http://localhost:5000/comments <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Bearer <span class="token variable">$token</span>"</span></code></pre></div>
<p>Notes:</p>
<ul>
<li>now our access token has <code class="language-text">scope</code> claim</li>
<li>our comments service has few new endpoints, each requires authentication and can be called only if  access token has required scope</li>
<li>it requires little bit more checks for cases when there is more than one scope</li>
<li>auth service knows the audience and as a result can filter scopes if needed</li>
<li>even so it seems little bit harder than roles still it is a way to go because of the specs</li>
</ul>
<p>In Duende they are doing something like:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> <span class="token namespace">IdentityModel<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>AccessTokenValidation</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;summary></span>
    <span class="token comment">/// Logic for normalizing scope claims to separate claim types</span>
    <span class="token comment">/// &lt;/summary></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ScopeConverter</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/// &lt;summary></span>
        <span class="token comment">/// Logic for normalizing scope claims to separate claim types</span>
        <span class="token comment">/// &lt;/summary></span>
        <span class="token comment">/// &lt;param name="principal">&lt;/param></span>
        <span class="token comment">/// &lt;returns>&lt;/returns></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ClaimsPrincipal</span> <span class="token function">NormalizeScopeClaims</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">ClaimsPrincipal</span> principal<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> identities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>ClaimsIdentity<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> id <span class="token keyword">in</span> principal<span class="token punctuation">.</span>Identities<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">var</span></span> identity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsIdentity</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span>AuthenticationType<span class="token punctuation">,</span> id<span class="token punctuation">.</span>NameClaimType<span class="token punctuation">,</span> id<span class="token punctuation">.</span>RoleClaimType<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> claim <span class="token keyword">in</span> id<span class="token punctuation">.</span>Claims<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>claim<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"scope"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>claim<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token class-name"><span class="token keyword">var</span></span> scopes <span class="token operator">=</span> claim<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> StringSplitOptions<span class="token punctuation">.</span>RemoveEmptyEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> scope <span class="token keyword">in</span> scopes<span class="token punctuation">)</span>
                            <span class="token punctuation">{</span>
                                identity<span class="token punctuation">.</span><span class="token function">AddClaim</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"scope"</span><span class="token punctuation">,</span> scope<span class="token punctuation">,</span> claim<span class="token punctuation">.</span>ValueType<span class="token punctuation">,</span> claim<span class="token punctuation">.</span>Issuer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span>
                        <span class="token punctuation">{</span>
                            identity<span class="token punctuation">.</span><span class="token function">AddClaim</span><span class="token punctuation">(</span>claim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{</span>
                        identity<span class="token punctuation">.</span><span class="token function">AddClaim</span><span class="token punctuation">(</span>claim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                identities<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsPrincipal</span><span class="token punctuation">(</span>identities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>That will allow use scopes as usual authorization roles, aka <code class="language-text">[Authorize(Roles = "comments.write")]</code></p>
<p>There is no need to create a demo for <code class="language-text">roles</code> claim which definitely will work out of the box in dotnet, also to me it seems that we should stick with scopes, because there are <code class="language-text">roles</code> claim in dotnet, azure adds <code class="language-text">groups</code> claims from active directory, some other identity provider may use something own, and <code class="language-text">scopes</code> are here from spec and absolutely all providers implement them</p>
<h1>Refresh Tokens</h1>
<p>Now, when scopes are covered we may play with refresh tokens</p>
<p>To recap - OAuth 2.0 does not describe when to return and when not to return refresh token (except the note about implicit flow)</p>
<p>OIDC on the other hand has dedicated <code class="language-text">offline_access</code> scope for this - <a href="https://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess">link</a></p>
<p>So as soon as you add this scope in response you will receive desired <code class="language-text">refresh_token</code></p>
<p>Let's see how it works in Google</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=98447827252-l09s8hofp0ek6tshhnc5l93e71li5mvv.apps.googleusercontent.com&amp;redirect_uri=http%3A%2F%2Flocalhost%3A5000%2Fcallback&amp;scope=email%20profile%20offline_access</code></pre></div>
<p>And it does not work, because Google does not have such scope, we can verify it in discovery document:</p>
<p><a href="https://accounts.google.com/.well-known/openid-configuration">https://accounts.google.com/.well-known/openid-configuration</a></p>
<p>It has only 3 supported scopes: openid, email and profile</p>
<p>Also from Google docs there is a dedicated option <a href="https://developers.google.com/identity/protocols/oauth2/web-server#request-parameter-access_type">access_type=offline</a></p>
<p>So let's give a try to something else, for example Microsoft one seems to have it:</p>
<p><a href="https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration">https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration</a></p>
<p>Does contain <code class="language-text">offline_access</code> in scopes</p>
<p>So having sample azure app registration we should be able to ask for refresh token:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://login.microsoftonline.com/695e64b5-2d13-4ea8-bb11-a6fda2d60c41/oauth2/v2.0/authorize?response_type=code&amp;client_id=1543f1b8-1840-4574-aa44-2e383cdd2652&amp;redirect_uri=http%3A%2F%2Flocalhost&amp;scope=openid%20email%20profile%20offline_access</code></pre></div>
<p>Notes:</p>
<ul>
<li>request is completely the same as we tried with Google</li>
<li>Microsoft complained that <code class="language-text">openid</code> scope is required, and indeed it is required by oidc spec so I have added it</li>
</ul>
<p>Redirected to</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">http://localhost/?code=0.AR8AtWReaRMtqE67Eab9otYMQbjxQxVAGHRFqkQuODzdJlKFAJw.AgABAAIAAAAtyolDObpQQ5VtlI4uGjEPAgDs_wUA9P9_axhpe6eLGXQU4bdMlaQBZdy7S0ZKStzY6JDORF4QDnx5rjfkNu7rE2hmkyTQQ8zQ_gVsvB4V7p3mAgjuymJAj2YOgvZHXIxnoOK_h3PYN9kpdZEjc27EZKC74HtFfjCiG1zBa_vbe9rz6KQiemuKOeuTQrKMAwMsnl7D4maQvtMi_mdYaHlSQrfliZaCbG_zankxv5suj5FG8ZrS6b5XofqwxnUVXfWyQEX2_spEOpt2grlRvcr4oyj3Y0pybhDn3TiqQjDEIxwaEJb7ixk0CGTWLl0JdCHNsTwi1x7oLWj7qukki4HAMNPolKvbicmgu0zswaynuuYg16jINF9uElSMdAzTShmT-k1rfDWWWrFnpB_TCFH3TGb5c3WRM0Iek1ZKtjaNBRn097fJjYk272lfOwTzn8SmbWrL1YAzvkSub6PBDaCoZC59bT2NQmTJuYiFS4lxzzX4Q4Ie6NS2uOjVezjdHKyXueGSXeAP4JvN8XYFLl4vkmKrAqvdzSmoSecDauaVgSw27XjQVnWK2a2lkQNSvthuwbkud9EeNpsEXVb5U1qIn3NZMXgyIzYk9YLpmDSVc5OrAsU-AFh2kpu4UBnENsKaK24_9e9nEC83yWJM1WOWRxIUVIzNYZLJan9s_5ao8jr_0REbaop78YJyiFHBwHkRps3SeTaIfeVdm9LuoNl6aG-uwIzL7HuVGf9E_SSEDQ3XkyUccCT1g-eBShD08Tai&amp;session_state=d977724e-9b34-4cbc-9fea-a1ed601be702#</code></pre></div>
<p>Lets try to exchange it:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token string">"https://login.microsoftonline.com/695e64b5-2d13-4ea8-bb11-a6fda2d60c41/oauth2/v2.0/token"</span> <span class="token parameter variable">-d</span> <span class="token string">"code=0.AR8AtWReaRMtqE67Eab9otYMQbjxQxVAGHRFqkQuODzdJlKFAJw.AgABAAIAAAAtyolDObpQQ5VtlI4uGjEPAgDs_wUA9P9_axhpe6eLGXQU4bdMlaQBZdy7S0ZKStzY6JDORF4QDnx5rjfkNu7rE2hmkyTQQ8zQ_gVsvB4V7p3mAgjuymJAj2YOgvZHXIxnoOK_h3PYN9kpdZEjc27EZKC74HtFfjCiG1zBa_vbe9rz6KQiemuKOeuTQrKMAwMsnl7D4maQvtMi_mdYaHlSQrfliZaCbG_zankxv5suj5FG8ZrS6b5XofqwxnUVXfWyQEX2_spEOpt2grlRvcr4oyj3Y0pybhDn3TiqQjDEIxwaEJb7ixk0CGTWLl0JdCHNsTwi1x7oLWj7qukki4HAMNPolKvbicmgu0zswaynuuYg16jINF9uElSMdAzTShmT-k1rfDWWWrFnpB_TCFH3TGb5c3WRM0Iek1ZKtjaNBRn097fJjYk272lfOwTzn8SmbWrL1YAzvkSub6PBDaCoZC59bT2NQmTJuYiFS4lxzzX4Q4Ie6NS2uOjVezjdHKyXueGSXeAP4JvN8XYFLl4vkmKrAqvdzSmoSecDauaVgSw27XjQVnWK2a2lkQNSvthuwbkud9EeNpsEXVb5U1qIn3NZMXgyIzYk9YLpmDSVc5OrAsU-AFh2kpu4UBnENsKaK24_9e9nEC83yWJM1WOWRxIUVIzNYZLJan9s_5ao8jr_0REbaop78YJyiFHBwHkRps3SeTaIfeVdm9LuoNl6aG-uwIzL7HuVGf9E_SSEDQ3XkyUccCT1g-eBShD08Tai&amp;client_id=1543f1b8-1840-4574-aa44-2e383cdd2652&amp;client_secret=2nM8Q~tUEQZypbeJFPMumdh1TVYMORZdebn-ibdA&amp;grant_type=authorization_code&amp;redirect_uri=http://localhost"</span></code></pre></div>
<p>and the response (everything worked like a charm, everything is done by spec, just changed identifiers and secrets)</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"token_type"</span><span class="token operator">:</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token property">"scope"</span><span class="token operator">:</span><span class="token string">"email openid profile"</span><span class="token punctuation">,</span>
  <span class="token property">"expires_in"</span><span class="token operator">:</span><span class="token number">5160</span><span class="token punctuation">,</span>
  <span class="token property">"ext_expires_in"</span><span class="token operator">:</span><span class="token number">5160</span><span class="token punctuation">,</span>
  <span class="token property">"access_token"</span><span class="token operator">:</span><span class="token string">"eyJ0eXAiOiJKV1QiLCJub....."</span><span class="token punctuation">,</span>
  <span class="token property">"refresh_token"</span><span class="token operator">:</span><span class="token string">"0.AR8AtWReaRMtqE67Eab...."</span><span class="token punctuation">,</span>
  <span class="token property">"id_token"</span><span class="token operator">:</span><span class="token string">"eyJ0eXAiOiJKV1QiLCJhbGciOi...."</span>
<span class="token punctuation">}</span></code></pre></div>
<p>In response both <code class="language-text">access_token</code> and <code class="language-text">id_token</code> are JWT, <code class="language-text">refresh_token</code> is something else</p>
<p><code class="language-text">access_token</code> and <code class="language-text">id_token</code> have expiration of 1hr</p>
<p><code class="language-text">refresh_token</code> has unknown expiration, at least we can only guess or believe the <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/refresh-tokens#token-lifetime">docs</a></p>
<blockquote>
<p>The default lifetime for the refresh tokens is 24 hours for single page apps and 90 days for all other scenarios</p>
</blockquote>
<p>Note: in GitHub for example refresh tokens are infinite if I remeber correct and in Slack only 24hr, so it is something that requires additional research, aka in case of possibility to revoke refresh token it should be fine for it to be valid forewer probably but having limitation will require user from time to time to relogin and as a result confirm grant</p>
<p>Accorting to oauth spec I should be able to ask for fresh tokens like so:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token string">"https://login.microsoftonline.com/695e64b5-2d13-4ea8-bb11-a6fda2d60c41/oauth2/v2.0/token"</span> <span class="token parameter variable">-d</span> <span class="token string">"grant_type=refresh_token&amp;client_id=1543f1b8-1840-4574-aa44-2e383cdd2652&amp;client_secret=2nM8Q~tUEQZypbeJFPMumdh1TVYMORZdebn-ibdA&amp;refresh_token=0.AR8AtWReaRMtqE...."</span></code></pre></div>
<p>gives</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"token_type"</span><span class="token operator">:</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token property">"scope"</span><span class="token operator">:</span><span class="token string">"email openid profile"</span><span class="token punctuation">,</span>
  <span class="token property">"expires_in"</span><span class="token operator">:</span><span class="token number">4356</span><span class="token punctuation">,</span>
  <span class="token property">"ext_expires_in"</span><span class="token operator">:</span><span class="token number">4356</span><span class="token punctuation">,</span>
  <span class="token property">"access_token"</span><span class="token operator">:</span><span class="token string">"eyJ0eXAiOiJKV1QiLCJ...."</span><span class="token punctuation">,</span>
  <span class="token property">"refresh_token"</span><span class="token operator">:</span><span class="token string">"0.AR8AtWReaRMtqE67Eab9otYMQ..."</span><span class="token punctuation">,</span>
  <span class="token property">"id_token"</span><span class="token operator">:</span><span class="token string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJS..."</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Notes:</p>
<ul>
<li>as described in oauth refresh token may be one time used but in case of Microsoft I can use it more than once</li>
<li>response is the same as when we exchanging code</li>
<li>in all responses i have cut long string just for readability nothing really secret there, plus all apps, secrets, client_id are deleted before publishing</li>
</ul>
<h2>Refresh tokens and SPA</h2>
<p>If  we have SPA we should use implicit flow, but implicit flow according to spec should not return refresh token</p>
<p>Then the question is - if token is only for 1hr - what should we do to not ask user rologin each hour?</p>
<p>So lets see what will Microsoft do for implicit flow</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://login.microsoftonline.com/695e64b5-2d13-4ea8-bb11-a6fda2d60c41/oauth2/v2.0/authorize?response_type=token&amp;client_id=1543f1b8-1840-4574-aa44-2e383cdd2652&amp;redirect_uri=http%3A%2F%2Flocalhost&amp;scope=openid%20email%20profile%20offline_access</code></pre></div>
<p>Note: you will receive unsupported response type until you enable implicit flow in app settings</p>
<p>and redirect will be</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">http://localhost/#access_token=eyJ0eXAiOiJKV1QiLCJub2...&amp;token_type=Bearer&amp;expires_in=5242&amp;scope=email+openid+profile&amp;session_state=d977724e-9b34-4cbc-9fea-a1ed601be702</code></pre></div>
<p>as you can see there is no refresh token as expected and given access token has 1h lifetime</p>
<p>from <a href="https://learn.microsoft.com/en-us/azure/active-directory-b2c/implicit-flow-single-page-application#refresh-tokens">docs</a> there is not clear note</p>
<blockquote>
<p>ID tokens and access tokens both expire after a short period of time. Your app must be prepared to refresh these tokens periodically. Implicit flows don't allow you to obtain a refresh token due to security reasons. To refresh either type of token, use the implicit flow in a hidden HTML iframe element. In the authorization request include the <code class="language-text">prompt=none</code> parameter. To receive a new <code class="language-text">id_token</code> value, be sure to use <code class="language-text">response_type=id_token</code> and <code class="language-text">scope=openid</code>, and a <code class="language-text">nonce</code> parameter.</p>
</blockquote>
<p>There is PKCE approach but alsoe there is good <a href="https://auth0.com/blog/securing-single-page-applications-with-refresh-token-rotation/">article</a> from oauth0 explaining why it is not ideal</p>
<p>So I have decided to play with OAuth0 little bit more</p>
<p>The fun fact - seying my dashboard and my registrations and experiments made 7 years ago, wondering what have I do back then :)</p>
<p>Created web app with:</p>
<ul>
<li>domain: <code class="language-text">rua.eu.auth0.com</code></li>
<li>client id: <code class="language-text">WnRtOqI8xKF4dJCAZQpHWxDc6SrDbyEK</code></li>
<li>client secret: <code class="language-text">rCVNj95iNJX4yAQr5buLwU9TIICQFymRMleDb1WjzIs8F-blKcOQ4J3S_6MYPNDC</code></li>
<li>discovery: <code class="language-text">https://rua.eu.auth0.com/.well-known/openid-configuration</code></li>
<li>auth: <code class="language-text">https://rua.eu.auth0.com/authorize</code></li>
<li>token: <code class="language-text">https://rua.eu.auth0.com/oauth/token</code></li>
</ul>
<p>Request</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://rua.eu.auth0.com/authorize?response_type=token&amp;client_id=WnRtOqI8xKF4dJCAZQpHWxDc6SrDbyEK&amp;redirect_uri=http%3A%2F%2Flocalhost&amp;scope=openid%20offline_access</code></pre></div>
<p>Redirect</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">http://localhost/#access_token=eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiaXNzIjoiaHR0cHM6Ly9ydWEuZXUuYXV0aDAuY29tLyJ9..a6CWjTn0bU2NbrBk.VrT0HqmaIkl-WOkYBWYAIEsbthJNX8TTSfcd8_a1A3w-XIAmZE5cjuS2LfX8r5VAPdR0p96avvzjn1PCPL-7WxBkXtLRTpU42bgkt1ky_Vwk7UU45xSs3tgX4mQh2q520Q7c8iwaUEfyGM6s71XQGnMUqCeiaYnQV7b-ZhCSZ7mehr2_e9knhDVogGsBYmKUzupIVnKGXAFd4uVu8DmDd2Saf3Lte7hX8-ZPtf6zoLryRvQjr-Qlgb7fl_a4xB9wx8bwepPYYuvQpzjqCGGkiAlfHz2CVe8tr2cP_PyIdyce.su9-B3dajxeU3WABXXy2Dw&amp;scope=openid%20offline_access&amp;expires_in=7200&amp;token_type=Bearer</code></pre></div>
<p>Still no refresh token, carefully reading <a href="https://auth0.com/blog/securing-single-page-applications-with-refresh-token-rotation/">article</a> we should take a note that it works with authorization code flow and PKCE, so lets try first one</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://rua.eu.auth0.com/authorize?response_type=code&amp;client_id=WnRtOqI8xKF4dJCAZQpHWxDc6SrDbyEK&amp;redirect_uri=http%3A%2F%2Flocalhost&amp;scope=openid%20offline_access</code></pre></div>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">http://localhost/?code=JGByuAmdYefsj1QxReB77mxAiVkzKFInffrNAGQlV-ptl</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token string">"https://rua.eu.auth0.com/oauth/token"</span> <span class="token parameter variable">-d</span> <span class="token string">"code=JGByuAmdYefsj1QxReB77mxAiVkzKFInffrNAGQlV-ptl&amp;client_id=WnRtOqI8xKF4dJCAZQpHWxDc6SrDbyEK&amp;client_secret=rCVNj95iNJX4yAQr5buLwU9TIICQFymRMleDb1WjzIs8F-blKcOQ4J3S_6MYPNDC&amp;grant_type=authorization_code&amp;redirect_uri=http://localhost"</span></code></pre></div>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"access_token"</span><span class="token operator">:</span><span class="token string">"eyJhbGciOiJk..."</span><span class="token punctuation">,</span>
  <span class="token property">"refresh_token"</span><span class="token operator">:</span><span class="token string">"v1.MRgSDlQ3ThyIq2vrEws16K4eO1n7qt..."</span><span class="token punctuation">,</span>
  <span class="token property">"id_token"</span><span class="token operator">:</span><span class="token string">"eyJhbGciOiJSUzI1N...."</span><span class="token punctuation">,</span>
  <span class="token property">"scope"</span><span class="token operator">:</span><span class="token string">"openid offline_access"</span><span class="token punctuation">,</span>
  <span class="token property">"expires_in"</span><span class="token operator">:</span><span class="token number">86400</span><span class="token punctuation">,</span>
  <span class="token property">"token_type"</span><span class="token operator">:</span><span class="token string">"Bearer"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>So far it works the same way as Microsoft, now the question whats about frontend side, e.g. my idea was to create small demo, but really fast I have realized that it does not make any sence because to exchange code to access token we need client secret and we should not expose it to front end</p>
<p>So we definitelly need take a closer look at PCKE</p>
<h1>Proof Key for Code Exchange (PKCE)</h1>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-browser-based-apps-07">https://datatracker.ietf.org/doc/html/draft-ietf-oauth-browser-based-apps-07</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7636">https://datatracker.ietf.org/doc/html/rfc7636</a></li>
<li><a href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/authorization-code-flow-with-proof-key-for-code-exchange-pkce">https://auth0.com/docs/get-started/authentication-and-authorization-flow/authorization-code-flow-with-proof-key-for-code-exchange-pkce</a></li>
<li><a href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/call-your-api-using-the-authorization-code-flow-with-pkce">https://auth0.com/docs/get-started/authentication-and-authorization-flow/call-your-api-using-the-authorization-code-flow-with-pkce</a></li>
</ul>
<p>Before proceeding we should make sure that our identity provider supports PKCE by checking its discovery document, here is one from <a href="https://accounts.google.com/.well-known/openid-configuration">google</a>:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">"code_challenge_methods_supported": ["plain", "S256"]</code></pre></div>
<p>In general it is as simple as:</p>
<p><strong>frontend</strong></p>
<p>create <code class="language-text">code_verifier</code> - random string, and <code class="language-text">code_challenge</code> - aka <code class="language-text">base64urlencode(sha256(code_verifier))</code></p>
<blockquote>
<p>there is cool project <a href="https://example-app.com/pkce">PKCE Tools</a> with examples of how it may be done</p>
</blockquote>
<p>when forming code grant login url, pass <code class="language-text">code_challenge</code> as well as all other params</p>
<blockquote>
<p>Note: also there is <code class="language-text">code_challenge_method=S256</code> parameter that should be passed, depending on implementation it may be plain or SHA256</p>
</blockquote>
<p><strong>auth</strong></p>
<p>store retrieved <code class="language-text">code_challange</code>, redirect user passing authorization code</p>
<p><strong>frontend</strong></p>
<p>exchange received <code class="language-text">code</code> to <code class="language-text">access_token</code> the same way as it done in code grant but pass <code class="language-text">code_verifier</code> instead of <code class="language-text">client_secret</code></p>
<p>Something like this:</p>
<p><strong>oauth0rtr-login.html</strong></p>
<p><div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>OAuth0 - Refresh Token Rotation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>OAuth0 - Refresh Token Rotation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>LOGIN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>get<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://rua.eu.auth0.com/authorize<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response_type<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span> <span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>client_id<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>WnRtOqI8xKF4dJCAZQpHWxDc6SrDbyEK<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span> <span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>redirect_uri<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:3000/oauth0rtr-callback.html<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span> <span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scope<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>openid offline_access<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span> <span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code_challange<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span> <span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code_challenge_method<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>S256<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span> <span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Login<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">sha256</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'SHA-256'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">base64urlencode</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">btoa</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">=+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> code_verifier <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'code_verifier'</span><span class="token punctuation">,</span> code_verifier<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will be used later, in callback, to exchange received code to acces token</span>

  <span class="token function">sha256</span><span class="token punctuation">(</span>code_verifier<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>base64urlencode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">code_challange</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input[name="code_challange"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> code_challange<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div></p>
<p><strong>oauth0rtr-callback.html</strong></p>
<p><div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>OAuth0 - Refresh Token Rotation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>OAuth0 - Refresh Token Rotation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>CALLBACK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code_verifier<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code_verifier<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>res<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'code_verifier'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'code_verifier'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// retrieve code_verifier created on login stage</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://rua.eu.auth0.com/oauth/token'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">'authorization_code'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'WnRtOqI8xKF4dJCAZQpHWxDc6SrDbyEK'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">code_verifier</span><span class="token operator">:</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'code_verifier'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// instead of client_secret</span>
        <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000/oauth0rtr-callback.html'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div></p>
<p>And we have our desirec refresh token in our frontend app without the need to have any backend servers</p>
<p>Take a closer look for implementation details, especially description of how refresh tokens are invalidated, they should be one time used, also their lifetime becomes less each time they are refreshed</p>
<p>So lets implement it by adding <code class="language-text">code_challenge_methods_supported</code> to our discovery as well as some dummy implementation</p>
<p><div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span> <span class="token comment">// const http2 = require('http2')</span>

<span class="token comment">// here are our keys that we will use to sign keys, also we will expose public key to the world</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>privateKey<span class="token punctuation">,</span> publicKey<span class="token punctuation">}</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">modulusLength</span><span class="token operator">:</span> <span class="token number">2048</span><span class="token punctuation">,</span>
  <span class="token literal-property property">publicKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span><span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">privateKeyEncoding</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// read private.pem into privateKey variable</span>
<span class="token comment">// const privateKey = crypto.createPrivateKey(readFileSync('private.pem'))</span>
<span class="token comment">// const publicKey = crypto.createPrivateKey(readFileSync('public.pem'))</span>

<span class="token comment">// As described in "2. Client Registration" and "2.3 Client Authentication" we should have at least `client_id` and `client_secret`, also `redirect_uris`, other possible settings will be `enabled`, `allowed_scopes`, etc</span>
<span class="token keyword">const</span> clients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_secret</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uris</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token comment">// for demo purposes, single code is hardcoded so we may skip authorization and call token directly</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'mac'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">'https://spa.localhost.direct/callback'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">60</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> challanges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span>

https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cert</span><span class="token operator">:</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'localhost.direct.crt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/.well-known/openid-configuration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">oidc</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/jwks'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">jwks</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/authorization'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">'/token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">token</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Not Found\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">443</span><span class="token punctuation">)</span>

<span class="token comment">// Responsible for interaction with user, display authorization form, consent, etc</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
  <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response_type <span class="token operator">===</span> <span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// // wont work here, because response_type is passed as post param</span>
  <span class="token comment">// else if (response_type === 'password') {</span>
  <span class="token comment">//   return await authorization_password_grant(req, res)</span>
  <span class="token comment">// }</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">authorization_password_grant</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token comment">// as a workaround to not bother</span>
    <span class="token comment">// console.log(`Unsupported response_type: ${response_type}`)</span>
    <span class="token comment">// return res.setHeader('content-type', 'text/html').writeHead(400).end('&lt;h1>Invalid request&lt;/h1>&lt;p>Unsupported &lt;code>response_type&lt;/code>&lt;/p>\n')</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.1. Authorization Code Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_code_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> code <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// as described - code should have short lifetime (~10min) and if possible be one time use, also we are saving everything we can about request to validate it in future when exchanging</span>
      codes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        client_id<span class="token punctuation">,</span>
        response_type<span class="token punctuation">,</span>
        redirect_uri<span class="token punctuation">,</span>
        code<span class="token punctuation">,</span>
        <span class="token literal-property property">scope</span><span class="token operator">:</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">at</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code_challenge'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        challanges<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          code<span class="token punctuation">,</span>
          <span class="token literal-property property">code_challenge</span><span class="token operator">:</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code_challenge'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">code_challenge_method</span><span class="token operator">:</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code_challenge_method'</span><span class="token punctuation">)</span>
          <span class="token comment">// pass other wanted data here, will be used later, when exchanging code to token</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      url<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.2. Implicit Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_implicit_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
    <span class="token comment">// TODO: validate wellknown incomming parameters here, if something wrong - warn user and do not redirect him anywhere</span>

    <span class="token comment">// it is the same as in code flow</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;fieldset>
        &lt;legend>login&lt;/legend>
        &lt;form method="POST">
          &lt;table>
            &lt;tr>
              &lt;td>
                &lt;label for="username">username&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="text" name="username" id="username" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
                &lt;label for="password">password&lt;/label>
              &lt;/td>
              &lt;td>
                &lt;input type="password" name="password" id="password" required />
              &lt;/td>
            &lt;/tr>
            &lt;tr>
              &lt;td>
              &lt;/td>
              &lt;td>
                &lt;input type="hidden" name="csrf" value="TODO: do not forget about CSRF" />
                &lt;input type="submit" value="submit" />
              &lt;/td>
            &lt;/tr>
          &lt;/table>
        &lt;/form>
      &lt;/fieldset>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
      <span class="token comment">// const password = body.get('password')</span>
      <span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>referer<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams
      <span class="token keyword">const</span> response_type <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'response_type'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>redirect_uri<span class="token punctuation">)</span>

      <span class="token comment">// the difference here is that we are not storing/dealing with code anymore and goind to redirect to url passinng access token in url fragment</span>
      <span class="token comment">// token generation copy pasted from token endpoint, later will be extracted, do not bother</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'HelloWorld_mac_was_here'</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> now <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
        <span class="token literal-property property">scope</span><span class="token operator">:</span> qs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'access_token'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'token_type'</span><span class="token punctuation">,</span> <span class="token string">'Bearer'</span><span class="token punctuation">)</span>
      fragment<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'expires_in'</span><span class="token punctuation">,</span> expires<span class="token punctuation">)</span>

      url<span class="token punctuation">.</span>hash <span class="token operator">=</span> fragment

      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4.3. Resource Owner Password Credentials Grant</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authorization_password_grant</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method Not Allowed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Method Not Allowed\n'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// TODO: expected client authentication here, as described in "2.3 Client Authentication" either basic auth header or form fields</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
    <span class="token comment">// const client_secret = body.get('client_secret')</span>
    <span class="token keyword">const</span> username <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    <span class="token comment">// const password = body.get('password')</span>
    <span class="token keyword">const</span> scope <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
    <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">sub</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
      <span class="token literal-property property">nbf</span><span class="token operator">:</span> now <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
      <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
      <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> expires<span class="token punctuation">,</span>
      <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
      scope
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=></span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token comment">// const grant_type = body.get('grant_type')</span>
      <span class="token keyword">const</span> redirect_uri <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redirect_uri'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> client_id <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">)</span>
      <span class="token comment">// const code = body.get('code')</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> codes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// validate everything, do not forget that code is short lived and should be one time used</span>

      <span class="token keyword">const</span> challange <span class="token operator">=</span> challanges<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code <span class="token operator">===</span> code<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
      <span class="token comment">// PKCE - we should check either client_secret or challange</span>

      <span class="token comment">// for simplicity we are using HS256, later it will be RSA and then JWKS, for not to keep things simple</span>
      <span class="token keyword">const</span> expires <span class="token operator">=</span> <span class="token number">3600</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> payload <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">sub</span><span class="token operator">:</span> code<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        <span class="token literal-property property">nbf</span><span class="token operator">:</span> now <span class="token operator">-</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
        <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> expires<span class="token punctuation">,</span>
        <span class="token literal-property property">iss</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">aud</span><span class="token operator">:</span> client_id<span class="token punctuation">,</span>
        <span class="token literal-property property">scope</span><span class="token operator">:</span> code<span class="token punctuation">.</span>scope
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> signature <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64url'</span><span class="token punctuation">)</span>

      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">access_token</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>header<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>payload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">token_type</span><span class="token operator">:</span> <span class="token string">'Bearer'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> expires
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3. OpenID Provider Metadata</span>
<span class="token comment">// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">oidc</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OIDC discovery'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">issuer</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">authorization_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/authorization'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">token_endpoint</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/token'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">jwks_uri</span><span class="token operator">:</span> <span class="token string">'https://auth.localhost.direct/jwks'</span><span class="token punctuation">,</span> <span class="token comment">// TODO: we need to implement this in next step</span>
    <span class="token literal-property property">response_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "code", "token", "id_token", "code token", "code id_token", "token id_token", "code token id_token", "none" ]</span>
    <span class="token literal-property property">subject_types_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "public", "pairwise" ]</span>
    <span class="token literal-property property">id_token_signing_alg_values_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'RS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [ "RS256", "ES256" ]</span>
    <span class="token literal-property property">token_endpoint_auth_methods_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"client_secret_post"</span><span class="token punctuation">,</span> <span class="token string">"client_secret_basic"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// TODO: depending on this client may decide whether to use basic auth or pass client_id and client_secret as port params</span>
    <span class="token literal-property property">code_challenge_methods_supported</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"plain"</span><span class="token punctuation">,</span> <span class="token string">"S256"</span><span class="token punctuation">]</span> <span class="token comment">// PCKE: supported methods, usually it will be S256 - SHA, if decide to leave plain need demo for it</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// https://datatracker.ietf.org/doc/html/rfc7517</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">jwks</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JWKS'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">keys</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// {</span>
      <span class="token comment">//   kid: '1',</span>
      <span class="token comment">//   kty: 'RSA',</span>
      <span class="token comment">//   alg: 'RS256',</span>
      <span class="token comment">//   use: 'sig',</span>
      <span class="token comment">//   n: crypto.createPublicKey(publicKey).export({ type: 'pkcs1', format: 'der' }).subarray(28, 28 + 256).toString('base64url'),</span>
      <span class="token comment">//   e: crypto.createPublicKey(publicKey).export({ type: 'pkcs1', format: 'der' }).subarray(-3).toString('base64url')</span>
      <span class="token comment">// },</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">kid</span><span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">kty</span><span class="token operator">:</span> <span class="token string">'RSA'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'RS256'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">'sig'</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>crypto<span class="token punctuation">.</span><span class="token function">createPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'jwk'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div></p>
<h1>Service to Service auth</h1>
<p>Think of this as a way to get rid of ApiKeys or other kinds of shared secrets, here is an example:</p>
<ul>
<li>we have sms api - small service that is used to send sms to the clients</li>
<li>it is ment for internal usage only (aka only our other services are making calls to it)</li>
<li>usually you will add some kind of ApiKey/ApiSecret/callitwhatever to protect this service</li>
<li>this secret then is shared accross all clients</li>
<li>this is bad because now, in case of need it will become hard to revoke/rotate it</li>
</ul>
<p>Instead we are going to use client credentials flow, when our service, before making a call to sms api will receive its signed access token from our auth service, then it will make an call to sms service, and because of discovery and jwks sms service will be able to varify it</p>
<p>It is as simple as implementing "4.4.1. Client Credentials Grant"</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials</code></pre></div>
<p>Do not even bother for now, it will work because of all previous demos</p>
<h1>Service to service - onbehalf user</h1>
<p>There is literally no wellknown way to do it</p>
<p>We should either stick with client credentials but then it is not onbehalf user calls and things like ownership validation need to be modifier - e.g. check ownership or client scope</p>
<p>Or use supported apprpoach where user interaction is required - but it sounds little bit strange in cases when all services are internal and trusted</p>
<p>In Microsoft realisation there is so called <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow">Microsoft identity platform and OAuth 2.0 On-Behalf-Of flow</a></p>
<p>It is little bit different from what we want but really close to it</p>
<p>Here are request parameters for token endpoint:</p>
<ul>
<li><code class="language-text">grant_type</code> - Required, must be <code class="language-text">urn:ietf:params:oauth:grant-type:jwt-bearer</code></li>
<li><code class="language-text">client_id</code>, <code class="language-text">client_secret</code> - Required, client credentials</li>
<li><code class="language-text">assertion</code> - Required, access token received from user, its <code class="language-text">aud</code> should be current client</li>
<li><code class="language-text">scope</code> - required</li>
<li><code class="language-text">request_token_use</code> - required, in this flow value must be <code class="language-text">on_behalf_of</code></li>
</ul>
<p>Example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">POST /oauth2/v2.0/token HTTP/1.1
Host: login.microsoftonline.com/&lt;tenant>
Content-Type: application/x-www-form-urlencoded

grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer
client_id=535fb089-9ff3-47b6-9bfb-4f1264799865
client_secret=sampleCredentia1s
assertion=eyJ0eXAiOiJKV....
scope=https://graph.microsoft.com/user.read+offline_access
requested_token_use=on_behalf_of</code></pre></div>
<p>In response there will be:</p>
<ul>
<li><code class="language-text">token_type</code> - usuall <code class="language-text">Bearer</code></li>
<li><code class="language-text">scope</code> - granted scopes</li>
<li><code class="language-text">expires_in</code> - lifetime seconds</li>
<li><code class="language-text">access_token</code> - our jwt</li>
<li><code class="language-text">refresh_token</code> - only provided if <code class="language-text">offline_access</code> scope was requested</li>
</ul>
<p>So it seems that in our case, our token endpoint should be flexible and return access tokens for wellknown clients event without assertions or something like that, of course it will be less secure but if we want full security we should not do such things at all and do it the same way as it is supposed to be for 3rd party clients with refresh token and access code grant</p>
<h1>dotnet openid connect auth service blueprint</h1>
<p>Here is an really dummy and silly starting point for an auth service</p>
<p><div class="gatsby-highlight" data-language="cs"><pre class="language-cs"><code class="language-cs"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>Jwt</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Mime</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Cryptography</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Protocols<span class="token punctuation">.</span>OpenIdConnect</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>

<span class="token comment">/*
dotnet add package Microsoft.IdentityModel.Protocols.OpenIdConnect

Microsoft.IdentityModel.Protocols.OpenIdConnect enums like OpenIdConnectGrantTypes.RefreshToken https://learn.microsoft.com/en-us/dotnet/api/microsoft.identitymodel.protocols.openidconnect?view=msal-web-dotnet-latest
System.IdentityModel.Tokens.Jwt enums like JwtConstants.TokenType
*/</span>

<span class="token class-name"><span class="token keyword">var</span></span> rsa <span class="token operator">=</span> RSA<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rsa<span class="token punctuation">.</span><span class="token function">ImportFromPem</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token string">"../../private.pem"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "openssl genrsa -out private.pem 2048" and optionally "openssl rsa -in private.pem -pubout -out public.pem"</span>

<span class="token class-name"><span class="token keyword">var</span></span> jwk <span class="token operator">=</span> JsonWebKeyConverter<span class="token punctuation">.</span><span class="token function">ConvertFromRSASecurityKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RsaSecurityKey</span><span class="token punctuation">(</span>rsa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jwk<span class="token punctuation">.</span>Kid <span class="token operator">=</span> <span class="token string">"mykey"</span><span class="token punctuation">;</span>
jwk<span class="token punctuation">.</span>Alg <span class="token operator">=</span> SecurityAlgorithms<span class="token punctuation">.</span>RsaSha256<span class="token punctuation">;</span>
jwk<span class="token punctuation">.</span>Use <span class="token operator">=</span> JsonWebKeyUseNames<span class="token punctuation">.</span>Sig<span class="token punctuation">;</span>

<span class="token comment">// var jwks = new JsonWebKeySet();</span>
<span class="token comment">// jwks.Keys.Add(jwk);</span>


<span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/.well-known/openid-configuration"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> req<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span>
<span class="token punctuation">{</span>
    <span class="token comment">// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata</span>
    issuer <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    authorization_endpoint <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">/authorization"</span></span><span class="token punctuation">,</span>
    token_endpoint <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">/token"</span></span><span class="token punctuation">,</span>
    jwks_uri <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">/jwks"</span></span><span class="token punctuation">,</span>
    response_types_supported <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> OpenIdConnectResponseType<span class="token punctuation">.</span>Code<span class="token punctuation">,</span> OpenIdConnectResponseType<span class="token punctuation">.</span>Token <span class="token punctuation">}</span><span class="token punctuation">,</span>
    subject_types_supported <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"public"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    id_token_signing_alg_values_supported <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> SecurityAlgorithms<span class="token punctuation">.</span>RsaSha256 <span class="token punctuation">}</span><span class="token punctuation">,</span>
    code_challenge_methods_supported <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"plain"</span><span class="token punctuation">,</span> <span class="token string">"S256"</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// app.MapGet("/jwks", () => jwks); // TODO: returns way to many data, including nullish values</span>
app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/jwks"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span>
<span class="token punctuation">{</span>
    keys <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">new</span>
        <span class="token punctuation">{</span>
            kid <span class="token operator">=</span> jwk<span class="token punctuation">.</span>Kid<span class="token punctuation">,</span>
            kty <span class="token operator">=</span> jwk<span class="token punctuation">.</span>Kty<span class="token punctuation">,</span>
            alg <span class="token operator">=</span> jwk<span class="token punctuation">.</span>Alg<span class="token punctuation">,</span>
            use <span class="token operator">=</span> jwk<span class="token punctuation">.</span>Use<span class="token punctuation">,</span>
            n <span class="token operator">=</span> jwk<span class="token punctuation">.</span>N<span class="token punctuation">,</span>
            e <span class="token operator">=</span> jwk<span class="token punctuation">.</span>E
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
http://localhost:5000/authorization?response_type=code&amp;client_id=client1&amp;redirect_uri=http://localhost
*/</span>
app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/authorization"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span> response<span class="token punctuation">)</span> <span class="token operator">=></span>
<span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> MediaTypeNames<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Html<span class="token punctuation">;</span>

    <span class="token comment">// just for demo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span>Query<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"response_type"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> responseType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"&lt;h1>response type is required&lt;/h1>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseType <span class="token operator">!=</span> <span class="token string">"code"</span> <span class="token operator">&amp;&amp;</span> responseType <span class="token operator">!=</span> <span class="token string">"token"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"&lt;h1>unknown response type&lt;/h1>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">""</span>"
                               <span class="token operator">&lt;</span>fieldset<span class="token operator">></span>
                               <span class="token operator">&lt;</span>legend<span class="token operator">></span>login<span class="token operator">&lt;</span><span class="token operator">/</span>legend<span class="token operator">></span>
                               <span class="token operator">&lt;</span><span class="token class-name">form</span> method<span class="token operator">=</span><span class="token string">"POST"</span><span class="token operator">></span>
                               <span class="token operator">&lt;</span>table<span class="token operator">></span>
                               <span class="token operator">&lt;</span>tr<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"username"</span><span class="token operator">></span>username<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"text"</span> id<span class="token operator">=</span><span class="token string">"username"</span> name<span class="token operator">=</span><span class="token string">"username"</span> required <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span>
                               <span class="token operator">&lt;</span>tr<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">></span>password<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"password"</span> name<span class="token operator">=</span><span class="token string">"password"</span> id<span class="token operator">=</span><span class="token string">"password"</span> required <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span>
                               <span class="token operator">&lt;</span>tr<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"hidden"</span> name<span class="token operator">=</span><span class="token string">"csrf"</span> <span class="token keyword">value</span><span class="token operator">=</span><span class="token string">"TODO: do not forget about CSRF"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"submit"</span> <span class="token keyword">value</span><span class="token operator">=</span><span class="token string">"submit"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span>
                               <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">></span>
                               <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span>
                               <span class="token operator">&lt;</span><span class="token operator">/</span>fieldset<span class="token operator">></span>
                               <span class="token string">""</span>"<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapPost</span><span class="token punctuation">(</span><span class="token string">"/authorization"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">"redirect_uri"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">string</span></span> redirectUri<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span> response<span class="token punctuation">)</span> <span class="token operator">=></span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UriBuilder</span><span class="token punctuation">(</span>redirectUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> query <span class="token operator">=</span> HttpUtility<span class="token punctuation">.</span><span class="token function">ParseQueryString</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span>Query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uri<span class="token punctuation">.</span>Query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    response<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
curl -X POST localhost:5000/token
*/</span>
app<span class="token punctuation">.</span><span class="token function">MapPost</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> req<span class="token punctuation">)</span> <span class="token operator">=></span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> oneHour <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> now <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> issuer <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> audience <span class="token operator">=</span> <span class="token string">"comments"</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>JwtRegisteredClaimNames<span class="token punctuation">.</span>Sub<span class="token punctuation">,</span> <span class="token string">"user1"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> notBefore <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> expires <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span>oneHour<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> signingCredentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RsaSecurityKey</span><span class="token punctuation">(</span>rsa<span class="token punctuation">)</span><span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>RsaSha256<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> jwt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>issuer<span class="token punctuation">,</span> audience<span class="token punctuation">,</span> claims<span class="token punctuation">,</span> notBefore<span class="token punctuation">,</span> expires<span class="token punctuation">,</span> signingCredentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> access_token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">,</span> token_type <span class="token operator">=</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span> expires_in <span class="token operator">=</span> oneHour <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div></p>
<p>And sample resource service</p>
<p><div class="gatsby-highlight" data-language="cs"><pre class="language-cs"><code class="language-cs"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

builder<span class="token punctuation">.</span>WebHost<span class="token punctuation">.</span><span class="token function">ConfigureKestrel</span><span class="token punctuation">(</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> serverOptions<span class="token punctuation">)</span> <span class="token operator">=></span> serverOptions<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span>Any<span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">,</span> listenOptions <span class="token operator">=></span> listenOptions<span class="token punctuation">.</span><span class="token function">UseConnectionLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// dotnet add package Microsoft.Identity.Web</span>
builder<span class="token punctuation">.</span>Services
    <span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
    <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"comments.read"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">"scope"</span><span class="token punctuation">,</span> <span class="token string">"comments.read"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"comments.write"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">"scope"</span><span class="token punctuation">,</span> <span class="token string">"comments.write"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"comments.admin"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">"scope"</span><span class="token punctuation">,</span> <span class="token string">"comments.admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
    <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>Authority <span class="token operator">=</span> <span class="token string">"http://localhost:5000"</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>Audience <span class="token operator">=</span> <span class="token string">"comments"</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>RequireHttpsMetadata <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// for demo</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
curl -s localhost:8000 -H "Authorization: Bearer $(curl -s -X POST localhost:5000/token | jq -r '.access_token')" | jq
*/</span>
app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> user<span class="token punctuation">)</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>c <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyValuePair<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/comments"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"returns all comments"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RequireAuthorization</span><span class="token punctuation">(</span><span class="token string">"comments.read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">MapPost</span><span class="token punctuation">(</span><span class="token string">"/comments"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"create comment"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RequireAuthorization</span><span class="token punctuation">(</span><span class="token string">"comments.write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">MapDelete</span><span class="token punctuation">(</span><span class="token string">"/comments"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"delete comment"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RequireAuthorization</span><span class="token punctuation">(</span><span class="token string">"comments.admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div></p>
<p>By intent there is no checks, validations and so on and so on, just to keep it small enough</p>
<p>Also from what I see, packages like OpenIdConfiguration are ment to be used in resource services rather than auth services, so I wonder how it will look like to have auth service without nuget dependencies at all</p>
<p>And it was as easy as</p>
<p><div class="gatsby-highlight" data-language="cs"><pre class="language-cs"><code class="language-cs"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Mime</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Cryptography</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> rsa <span class="token operator">=</span> RSA<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rsa<span class="token punctuation">.</span><span class="token function">ImportFromPem</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span><span class="token string">"../../private.pem"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "openssl genrsa -out private.pem 2048" and optionally "openssl rsa -in private.pem -pubout -out public.pem"</span>

<span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/.well-known/openid-configuration"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> req<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span>
<span class="token punctuation">{</span>
    <span class="token comment">// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata</span>
    issuer <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
    authorization_endpoint <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">/authorization"</span></span><span class="token punctuation">,</span>
    token_endpoint <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">/token"</span></span><span class="token punctuation">,</span>
    jwks_uri <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">/jwks"</span></span><span class="token punctuation">,</span>
    response_types_supported <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">"token"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    subject_types_supported <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"public"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    id_token_signing_alg_values_supported <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"RS256"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    code_challenge_methods_supported <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">"plain"</span><span class="token punctuation">,</span> <span class="token string">"S256"</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/jwks"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span>
<span class="token punctuation">{</span>
    keys <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">new</span>
        <span class="token punctuation">{</span>
            kid <span class="token operator">=</span> <span class="token string">"jwk1"</span><span class="token punctuation">,</span>
            kty <span class="token operator">=</span> <span class="token string">"RSA"</span><span class="token punctuation">,</span>
            alg <span class="token operator">=</span> <span class="token string">"RS256"</span><span class="token punctuation">,</span>
            use <span class="token operator">=</span> <span class="token string">"sig"</span><span class="token punctuation">,</span>
            n <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>rsa<span class="token punctuation">.</span><span class="token function">ExportParameters</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Modulus<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TrimEnd</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'+'</span><span class="token punctuation">,</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>rsa<span class="token punctuation">.</span><span class="token function">ExportParameters</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Exponent<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TrimEnd</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'+'</span><span class="token punctuation">,</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
http://localhost:5000/authorization?response_type=code&amp;client_id=client1&amp;redirect_uri=http://localhost
*/</span>
app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">"/authorization"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">"response_type"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">string</span></span> responseType<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span> response<span class="token punctuation">)</span> <span class="token operator">=></span>
<span class="token punctuation">{</span>
    response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> MediaTypeNames<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Html<span class="token punctuation">;</span>

    <span class="token comment">// just for demo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> responseType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> responseType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"&lt;h1>response type is missing or malformed&lt;/h1>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">""</span>"
                               <span class="token operator">&lt;</span>fieldset<span class="token operator">></span>
                               <span class="token operator">&lt;</span>legend<span class="token operator">></span>login<span class="token operator">&lt;</span><span class="token operator">/</span>legend<span class="token operator">></span>
                               <span class="token operator">&lt;</span><span class="token class-name">form</span> method<span class="token operator">=</span><span class="token string">"POST"</span><span class="token operator">></span>
                               <span class="token operator">&lt;</span>table<span class="token operator">></span>
                               <span class="token operator">&lt;</span>tr<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"username"</span><span class="token operator">></span>username<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"text"</span> id<span class="token operator">=</span><span class="token string">"username"</span> name<span class="token operator">=</span><span class="token string">"username"</span> required <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span>
                               <span class="token operator">&lt;</span>tr<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">></span>password<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"password"</span> name<span class="token operator">=</span><span class="token string">"password"</span> id<span class="token operator">=</span><span class="token string">"password"</span> required <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span>
                               <span class="token operator">&lt;</span>tr<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"hidden"</span> name<span class="token operator">=</span><span class="token string">"csrf"</span> <span class="token keyword">value</span><span class="token operator">=</span><span class="token string">"TODO: do not forget about CSRF"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token class-name">input</span> type<span class="token operator">=</span><span class="token string">"submit"</span> <span class="token keyword">value</span><span class="token operator">=</span><span class="token string">"submit"</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span>
                               <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">></span>
                               <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span>
                               <span class="token operator">&lt;</span><span class="token operator">/</span>fieldset<span class="token operator">></span>
                               <span class="token string">""</span>"<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapPost</span><span class="token punctuation">(</span><span class="token string">"/authorization"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">"redirect_uri"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">string</span></span> redirectUri<span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span> response<span class="token punctuation">)</span> <span class="token operator">=></span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UriBuilder</span><span class="token punctuation">(</span>redirectUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> query <span class="token operator">=</span> HttpUtility<span class="token punctuation">.</span><span class="token function">ParseQueryString</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span>Query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uri<span class="token punctuation">.</span>Query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    response<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
curl -X POST localhost:5000/token
*/</span>
app<span class="token punctuation">.</span><span class="token function">MapPost</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> req<span class="token punctuation">)</span> <span class="token operator">=></span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> expiration <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> header <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        typ <span class="token operator">=</span> <span class="token string">"JWT"</span><span class="token punctuation">,</span>
        alg <span class="token operator">=</span> <span class="token string">"RS256"</span><span class="token punctuation">,</span> 
        kid <span class="token operator">=</span> <span class="token string">"key1"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TrimEnd</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'+'</span><span class="token punctuation">,</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name"><span class="token keyword">var</span></span> payload <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        sub <span class="token operator">=</span> <span class="token string">"user1"</span><span class="token punctuation">,</span>
        nbf <span class="token operator">=</span> DateTimeOffset<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUnixTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        iat <span class="token operator">=</span> DateTimeOffset<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToUnixTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        exp <span class="token operator">=</span> DateTimeOffset<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span>expiration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUnixTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        iss <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Scheme</span><span class="token punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">req<span class="token punctuation">.</span>Host</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
        aud <span class="token operator">=</span> <span class="token string">"comments"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TrimEnd</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'+'</span><span class="token punctuation">,</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> signature <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>rsa<span class="token punctuation">.</span><span class="token function">SignData</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">header</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">payload</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> HashAlgorithmName<span class="token punctuation">.</span>SHA256<span class="token punctuation">,</span> RSASignaturePadding<span class="token punctuation">.</span>Pkcs1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TrimEnd</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'+'</span><span class="token punctuation">,</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> access_token <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">header</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">payload</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">signature</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> token_type <span class="token operator">=</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span> expires_in <span class="token operator">=</span> expiration <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div></p>
<p>Note: not pretending to say I started to understand how it all works together, but having such deep dive samples definitely helps, also with such approach there is nothing to update in future except dotnet itself which, theoretically will make it much safer, but on the other hand will definitelly require understanding of all this crypto things like RSA paddings, etc, <a href="https://github.com/mac2000/cryptography">here</a> i have some notes around this topic</p></div></main><footer><a href="#top">top</a><a href="/">home</a><a href="/search">search</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/oauth-oidc-journey/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-9af786cdcd42b943058e.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-645f86121d32a262d039.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-37f33af8c4ac02cd8a54.js\"],\"component---src-pages-search-js\":[\"/component---src-pages-search-js-47fb6b0774916da2e931.js\"],\"component---src-templates-note-js\":[\"/component---src-templates-note-js-81e5c651144ef401fc6b.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="ea8402185ee018e96c95";</script><script src="/webpack-runtime-0857963aa197356bc6c2.js" async></script><script src="/framework-4b4a12623f06935baae7.js" async></script><script src="/app-9af786cdcd42b943058e.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>