<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.24.5"/><style data-href="/styles.f7b0302c8427f1a04772.css" data-identity="gatsby-global-css">@media (prefers-color-scheme:light){code[class*=language-],pre[class*=language-]{background:#fafafa;color:#383a42;direction:ltr;font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#e5e5e6;color:inherit}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#e5e5e6;color:inherit}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.2em .3em;white-space:normal}.token.cdata,.token.comment,.token.prolog{color:#a0a1a7}.token.doctype,.token.entity,.token.punctuation{color:#383a42}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#b76b01}.token.keyword{color:#a626a4}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e45649}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#50a14f}.token.function,.token.operator,.token.variable{color:#4078f2}.token.url{color:#0184bc}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#383a42}.language-css .token.selector{color:#e45649}.language-css .token.property{color:#383a42}.language-css .token.function,.language-css .token.url>.token.function{color:#0184bc}.language-css .token.url>.token.string.url{color:#50a14f}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#a626a4}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#ca1243}.language-json .token.operator{color:#383a42}.language-json .token.null.keyword{color:#b76b01}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#383a42}.language-markdown .token.url>.token.content{color:#4078f2}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#0184bc}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#a0a1a7;font-style:italic}.language-markdown .token.code-snippet{color:#50a14f}.language-markdown .token.bold .token.content{color:#b76b01}.language-markdown .token.italic .token.content{color:#a626a4}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e45649}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(56,58,66,.2)}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#e5e5e6;border-radius:.3em;color:#696c77;padding:.1em .4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#c6c7c7;color:#383a42}.line-highlight.line-highlight{background:rgba(56,58,66,.05)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#e5e5e6;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2);color:#383a42;padding:.1em .6em}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(56,58,66,.05)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(56,58,66,.2)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#9d9d9f}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e45649}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#50a14f}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#4078f2}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#a626a4}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(25,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(56,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(56,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:hsl(0,0,95%)}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:hsl(0,0,95%)}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:hsl(0,0,95%)}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#fff}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#383a42;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#383a42}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}}@media (prefers-color-scheme:dark){code[class*=language-],pre[class*=language-]{background:#282c34;color:#abb2bf;direction:ltr;font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#3e4451;color:inherit;text-shadow:none}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#3e4451;color:inherit;text-shadow:none}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.2em .3em;white-space:normal}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}.token.cdata,.token.comment,.token.prolog{color:#5c6370}.token.doctype,.token.entity,.token.punctuation{color:#abb2bf}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#d19a66}.token.keyword{color:#c678dd}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e06c75}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#98c379}.token.function,.token.operator,.token.variable{color:#61afef}.token.url{color:#56b6c2}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#abb2bf}.language-css .token.selector{color:#e06c75}.language-css .token.property{color:#abb2bf}.language-css .token.function,.language-css .token.url>.token.function{color:#56b6c2}.language-css .token.url>.token.string.url{color:#98c379}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#c678dd}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#be5046}.language-json .token.operator{color:#abb2bf}.language-json .token.null.keyword{color:#d19a66}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#abb2bf}.language-markdown .token.url>.token.content{color:#61afef}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#56b6c2}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#5c6370;font-style:italic}.language-markdown .token.code-snippet{color:#98c379}.language-markdown .token.bold .token.content{color:#d19a66}.language-markdown .token.italic .token.content{color:#c678dd}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e06c75}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(171,178,191,.15);text-shadow:none}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#3a3f4b;border-radius:.3em;color:#828997;padding:.1em .4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#3e4451;color:#abb2bf}.line-highlight.line-highlight{background:rgba(153,187,255,.04)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#3a3f4b;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2);color:#abb2bf;padding:.1em .6em}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(153,187,255,.04)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(171,178,191,.15)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#636d83}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e06c75}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#98c379}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#61afef}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#c678dd}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(25,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(56,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(56,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:#262931}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:#262931}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:#262931}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#31363f}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#abb2bf;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#abb2bf}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}}:root{--foreground:#24292f;--background:#fff}a{color:#0969da}a.visited,a:visited{color:#57606a}.green{color:#1a7f37}.red{color:#cf222e}@media (prefers-color-scheme:dark){:root{--foreground:#adbac7;--background:#22272e}a{color:#539bf5}a.visited,a:visited{color:#768390}.green{color:#57ab5a}.red{color:#e5534b}}a{text-decoration:none}a:hover{text-decoration:underline}html{font-family:Ubuntu,sans-serif}body{background-color:var(--background);color:var(--foreground);margin:0;padding:0}#top{box-sizing:border-box;display:grid;grid-template-rows:1fr 2em;margin:0;min-height:100vh;padding:1em 2em}.graph polygon{fill:transparent}.graph g ellipse[stroke="#000"],.graph g ellipse[stroke="#000000"],.graph g ellipse[stroke=black],.graph g path[stroke="#000"],.graph g path[stroke="#000000"],.graph g path[stroke=black],.graph g polygon[stroke="#000"],.graph g polygon[stroke="#000000"],.graph g polygon[stroke=black]{stroke:var(--foreground)}.graph g text[fill="#000"],.graph g text[fill="#000000"],.graph g text[fill=black]{fill:var(--foreground)}code,pre{font-family:JetBrains Mono,monospace}pre[class*=language-]{word-wrap:break-word;border-radius:0;box-sizing:border-box;margin:1em -2em;max-width:100vw;padding:1em 2em}footer a{line-height:2em;margin-right:.5em}.delta{line-height:1;margin-left:1em;white-space:nowrap}.columns{display:grid;grid-template-columns:repeat(2,1fr)}@media only screen and (max-width:1024px){.columns{grid-template-columns:repeat(1,1fr)}}.pie{text-align:center}.pie figure{display:inline-block}.pie figcaption{font-size:80%;margin-top:.25em}</style><title data-gatsby-head="true">Wordpress Custom Post Type with Required Unique Custom Field</title><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=6389d5f13c96000946d60b6bb0a8b5a8" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=6389d5f13c96000946d60b6bb0a8b5a8"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=6389d5f13c96000946d60b6bb0a8b5a8"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=6389d5f13c96000946d60b6bb0a8b5a8"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=6389d5f13c96000946d60b6bb0a8b5a8"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=6389d5f13c96000946d60b6bb0a8b5a8"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=6389d5f13c96000946d60b6bb0a8b5a8"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=6389d5f13c96000946d60b6bb0a8b5a8"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=6389d5f13c96000946d60b6bb0a8b5a8"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div id="top"><main><div><h1>Wordpress Custom Post Type with Required Unique Custom Field</h1>
<p>We are going to add custom video post type to wordpress with required and unique video url custom field.</p>
<p>So user will be able to add new video posts only if he enters video url and it is unique (meaning that there is no other posts with same video url) otherwise we will notify user about stufs that are went wrong and save post as draft so user can fix things and publish post.</p>
<p>Short note: There is nothing special in code, and even more it is not good and should not be used in production as is it is just proof of concept.</p>
<p>So all code is placed in <code class="language-text">wp-content/plugins/custom_post_type_with_required_custom_field.php</code></p>
<p>With pretty standard header:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">/*
Plugin Name: Custom Post Type With Required Custom Field
Plugin URI: http://mac-blog.org.ua/
Description: Sample plugin demonstrating how to add required unique custom field to custom post type
Author: Marchenko Alexandr
Version: 1.0
Author URI: http://mac-blog.org.ua/
*/</code></pre></div>
<p>We have some constants that we are using later in code, just for not being messing up with strings</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CPTWRCF_POST_TYPE'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'video'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CPTWRCF_META_KEY'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_video'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CPTWRCF_META_LABEL'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Video URL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CPTWRCF_NONCE_ACTION'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'cptwrcf_nonce_action'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CPTWRCF_NONCE_NAME'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'cptwrcfn_nonce_name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CPTWRCF_NOT_VALID_QUERY_STRING_KEY'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'cptwrcfn_not_valid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CPTWRCF_NOT_UNIQUE_QUERY_STRING_KEY'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'cptwrcfn_not_unique'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CPTWRCF_SQL'</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"SELECT * FROM <span class="token interpolation"><span class="token variable">$wpdb</span><span class="token operator">-></span><span class="token property">postmeta</span></span> WHERE meta_key = %s AND meta_value = %s AND post_id &lt;> %d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>First things first we are going to create custom post type</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'init'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">register_post_type</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_POST_TYPE</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'label'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'Video'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'public'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'supports'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'title'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'editor'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'thumbnail'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'excerpt'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'comments'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'show_in_menu'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'edit.php'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'menu_icon'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'dashicons-video-alt3'</span><span class="token punctuation">,</span>
        <span class="token comment">//'taxonomies' => [''],</span>
        <span class="token string single-quoted-string">'has_archive'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>And add custom meta box for its Video URL custom field</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'add_meta_boxes'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">add_meta_box</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_LABEL</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token class-name type-declaration">WP_Post</span> <span class="token variable">$post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">wp_nonce_field</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_NONCE_ACTION</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_NONCE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$attributes</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'name'</span> <span class="token operator">=></span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'value'</span> <span class="token operator">=></span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-></span><span class="token constant">ID</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'class'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'widefat'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'type'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'text'</span><span class="token punctuation">,</span>
            <span class="token comment">//'type' => 'url',</span>
            <span class="token comment">//'required' => 'required'</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$attributes</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span> <span class="token keyword">use</span><span class="token punctuation">(</span><span class="token variable">$attributes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'%s="%s"'</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token function">esc_attr</span><span class="token punctuation">(</span><span class="token variable">$attributes</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">array_keys</span><span class="token punctuation">(</span><span class="token variable">$attributes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;input '</span> <span class="token operator">.</span> <span class="token variable">$attributes</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' />'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_POST_TYPE</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'side'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Handle post save event and save Video URL custom field as post meta</p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'save_post'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_NONCE_NAME</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_NONCE_NAME</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_NONCE_ACTION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'DOING_AUTOSAVE'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">DOING_AUTOSAVE</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">current_user_can</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'edit_post'</span><span class="token punctuation">,</span> <span class="token variable">$post_id</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token function">update_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span> <span class="token function">sanitize_text_field</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>All that was pretty standard stuff with nothing special</p>
<p>Now we are going to add two additional capabilities: Make Video URL custom field - required and ensure that it is unique across all posts</p>
<h2>Required Custom Field</h2>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 870px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1abdfe769c2b3c26e4dd8e342f31da68/3f3b9/required.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACJUlEQVQoz32STW/aMBjH8/04cNgqCi0Su+zMrZUKGoyp23eYtK9QemHTVALisB3GWyR6HFultpTY8Vvs2HECmRyPlsO6n6Indpz/Y/v/PI5SUiqplNZaJ0mSpGn2X25+/X7wfS3EbbfrzOdz1+0PBsPBYOC6br/fH41G7o7hcOi6rlnq9113cPX1y7DX632+6l52r5dL57hcrtfrrXa7cXbWaDbftFpv2+3TPU5O9menzUaj0+mcn7+/vLhwXrx6PZlOUWC4BwHE9O/5c9L8eZqmqdZaSrnZbJbLpVN493HmXSc8JJQyxmgOIcSO7yBeYzNijGmdxDvSNDXiarky9r4LxYMAIUwCyhgX9g+lYqlMtGfRO57ER0fHs/lUxUoIoXY87hDnUyEExjiKIpmj8toY8cHBy+lkgpC5Nec8zGGM2bcQkVKKc44xllLaapmkVnx4eDg1hqG729v1ev3wYMJqtQIAQAgxxpRSk5RzQkgUx1mWKdMbcrVaOaVSaTweU0oB8K1JJjITGWMYI98HVs8oBYioxHTRdrvlnDuVcmU8/kEIwQYCYYAxhhACAAghAPi+7xOCEQqM53luiDERMgxDp1qtep6ntVZKxntYV629xgQIKQw4D6UQn2Y3H779JJQ6xWJxsVhkWSaEeK6fhRBBEBBKpZRRFOGQA2pMdQqFgud5WZZtNpvnxFJKQojWeu9bfudarWZ3tqX/J3nx6GMhLQihPzAxGLh7lVnTAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Required custom field notice"
        title="Required custom field notice"
        src="/static/1abdfe769c2b3c26e4dd8e342f31da68/3f3b9/required.png"
        srcset="/static/1abdfe769c2b3c26e4dd8e342f31da68/6f3f2/required.png 256w,
/static/1abdfe769c2b3c26e4dd8e342f31da68/01e7c/required.png 512w,
/static/1abdfe769c2b3c26e4dd8e342f31da68/3f3b9/required.png 870w"
        sizes="(max-width: 870px) 100vw, 870px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_insert_post_data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'DOING_AUTOSAVE'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">DOING_AUTOSAVE</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'trash'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span> <span class="token comment">// Make sure to do nothing for posts that are going to be deleted</span>

    <span class="token comment">// If there is not Video URL or it is not valid URL - mark post as draft and notify user</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'post_status'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'draft'</span><span class="token punctuation">;</span>
        <span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'redirect_post_location'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$location</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$location</span> <span class="token operator">=</span> <span class="token function">remove_query_arg</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$location</span> <span class="token operator">=</span> <span class="token function">add_query_arg</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10 is for "Post draft updated" message</span>
            <span class="token keyword">return</span> <span class="token function">add_query_arg</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_NOT_VALID_QUERY_STRING_KEY</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'redirect_post_location'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$location</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">remove_query_arg</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_NOT_VALID_QUERY_STRING_KEY</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'admin_notices'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_NOT_VALID_QUERY_STRING_KEY</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$link</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;b>&lt;a href="#%s">%s&lt;/a>&lt;/b>'</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_LABEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Your post was saved as draft because there is no required %s or it is invalid!'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$link</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;div class="error">&lt;p>%s&lt;/p>&lt;/div>'</span><span class="token punctuation">,</span> <span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>Unique Custom Field</h2>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 870px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/face51c93c13faa648c43f7fe6a02213/3f3b9/unique.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACLklEQVQoz32SQU/bMBTH8/164LChUqASu+zMjUoUDejE9h0m7StQLmyaSFpx2A4rbSPBcd2QOgKxY/s5duw4CZlcU7YD7Hd4TmL/8/z+73laK6WV1sYYUxRFUZb1f7n++es2jo2U837fm06nQeAPBsPBYBAEge/75+fnwZLhcBgEgd3y/SAYnH35PDw9Pf101j/pX81m3martb29vX9w0N3d7e7tvdnfPzw86HQ6O50Hdh6fFux1u71e7+jo3cnxsffi1euL8ZgklhuUYAru/mXxBGVZGmOUUlVVzWYzr/H2wyS8KkTKADjnAMABooTdEABgjNGEcZmp3GLyJWVZWnG7tT4Kv0ktkoQQyhLgXEitc6Ut7qgxxuV0/BVvbGxOpmOdaymlXvKYwb1KKSmlWZapBXrRGyteXX05vrggxFYthEgXcM7dKmWmtRZCUEqVUq5b7jJWvLa2NraGkd/z+d3d3e2tDVEUIYQwxpRSALA/FYIxluV5XdfazoaKoshrNpuj0QgAEIofDOMcuI2cc0pJHCOn5wCIMF3YKbq/vxdCeOut9dHou7XVwjBOKKUYY4QQYwyhOI5jxighCV80AjjHlDKp0jT12u12GIbGGK1V/g/OVWevNQFjwFikqZLy4+T6/dcfDMBbWVm5vLys61pK+dw8SymTJOGca62zLKOpQGBN9RqNRhiGdV1XVfWcWCllS2IsN/ny26Lmra0tl9m1/knSNAULA4B0CSHkD1cRGI/QyFzwAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Unique custom field notice"
        title="Unique custom field notice"
        src="/static/face51c93c13faa648c43f7fe6a02213/3f3b9/unique.png"
        srcset="/static/face51c93c13faa648c43f7fe6a02213/6f3f2/unique.png 256w,
/static/face51c93c13faa648c43f7fe6a02213/01e7c/unique.png 512w,
/static/face51c93c13faa648c43f7fe6a02213/3f3b9/unique.png 870w"
        sizes="(max-width: 870px) 100vw, 870px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_insert_post_data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$raw</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'DOING_AUTOSAVE'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">DOING_AUTOSAVE</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'trash'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span> <span class="token comment">// Make sure to do nothing for posts that are going to be deleted</span>

    <span class="token variable">$post_id</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$raw</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ID'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/** @var wpdb $wpdb */</span>
    <span class="token keyword">global</span> <span class="token variable">$wpdb</span><span class="token punctuation">;</span>
    <span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$wpdb</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_SQL</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span> @<span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$post_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$found</span> <span class="token operator">=</span> <span class="token variable">$wpdb</span><span class="token operator">-></span><span class="token function">get_results</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token constant">ARRAY_A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If we found posts with save Video URL - notify user and save post as a draft</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$found</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'post_status'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'draft'</span><span class="token punctuation">;</span>
        <span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'redirect_post_location'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$location</span> <span class="token operator">=</span> <span class="token function">remove_query_arg</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$location</span> <span class="token operator">=</span> <span class="token function">add_query_arg</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10 is for "Post draft updated" message from `edit-form-advanced.php`</span>
            <span class="token keyword">return</span> <span class="token function">add_query_arg</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_NOT_UNIQUE_QUERY_STRING_KEY</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'redirect_post_location'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">remove_query_arg</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_NOT_UNIQUE_QUERY_STRING_KEY</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Notice last arg: 2 - is for getting raw data which is used to determine post id</span>

<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'admin_notices'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token constant">CPTWRCF_NOT_UNIQUE_QUERY_STRING_KEY</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/** @var wpdb $wpdb */</span>
        <span class="token keyword">global</span> <span class="token variable">$wpdb</span><span class="token punctuation">;</span>

        <span class="token comment">/** @var WP_Post $post */</span>
        <span class="token keyword">global</span> <span class="token variable">$post</span><span class="token punctuation">;</span>

        <span class="token comment">// &lt;editor-fold desc="Optional: Get post links that has same Video URL"></span>
        <span class="token variable">$meta_value</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-></span><span class="token constant">ID</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$wpdb</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token constant">CPTWRCF_SQL</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span> <span class="token variable">$meta_value</span><span class="token punctuation">,</span> <span class="token variable">$post</span><span class="token operator">-></span><span class="token constant">ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$items</span> <span class="token operator">=</span> <span class="token variable">$wpdb</span><span class="token operator">-></span><span class="token function">get_results</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token constant">ARRAY_A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$items</span> <span class="token operator">=</span> <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;a target="_blank" href="%s">%s&lt;/a>'</span><span class="token punctuation">,</span> <span class="token function">get_permalink</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'post_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">get_the_title</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'post_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$items</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$items</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">', '</span><span class="token punctuation">,</span> <span class="token variable">$items</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$used_by</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'by %s'</span><span class="token punctuation">,</span> <span class="token variable">$items</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &lt;/editor-fold></span>

        <span class="token variable">$link</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;b>&lt;a href="#%s">%s&lt;/a>&lt;/b>'</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_KEY</span><span class="token punctuation">,</span> <span class="token constant">CPTWRCF_META_LABEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Your post was saved as draft because %s is already used %s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$link</span><span class="token punctuation">,</span> <span class="token variable">$used_by</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;div class="error">&lt;p>%s&lt;/p>&lt;/div>'</span><span class="token punctuation">,</span> <span class="token variable">$message</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>The first thing you will ask - why the heck <code class="language-text">wp_insert_post_data</code> and <code class="language-text">admin_notices</code> and you will be totally right :)</p>
<p>If you need required <strong>and</strong> unique custom field you should combine them, but if you need only required field just use first part, as I sad it is just proof of concept and not production code (probably it all should be rewriten in some cleaner OOP way but seems to be too heavy for small note)</p>
<p>Full code can be found here: <a href="https://gist.github.com/mac2000/68721ed47567c469fc83">https://gist.github.com/mac2000/68721ed47567c469fc83</a></p></div></main><footer><a href="#top">top</a><a href="/">home</a><a href="/search">search</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/wordpress-custom-post-type-with-required-unique-custom-field";window.___webpackCompilationHash="d66156d9f10a2e2c3817";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-b4bb882d10635d85fa25.js"],"app":["/app-98475b819971087d4b7e.js"],"component---src-pages-404-js":["/component---src-pages-404-js-2652c435d8decd31b8ef.js"],"component---src-pages-index-js":["/component---src-pages-index-js-05a3598fd09bcacab11e.js"],"component---src-pages-search-js":["/component---src-pages-search-js-078619e3aef857102623.js"],"component---src-templates-note-js":["/component---src-templates-note-js-b005c02681f20ea28edd.js"]};/*]]>*/</script><script src="/polyfill-b4bb882d10635d85fa25.js" nomodule=""></script><script src="/app-98475b819971087d4b7e.js" async=""></script><script src="/framework-2ce620c91826a79f925c.js" async=""></script><script src="/webpack-runtime-b5d9ed3760a9b31eebd6.js" async=""></script></body></html>