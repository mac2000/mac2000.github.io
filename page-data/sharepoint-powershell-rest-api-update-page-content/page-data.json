{"componentChunkName":"component---src-templates-note-js","path":"/sharepoint-powershell-rest-api-update-page-content","result":{"data":{"remark":{"fields":{"path":"sharepoint-powershell-rest-api-update-page-content"},"meta":{"title":""},"headings":[{"value":"SharePoint REST API PowerShell Update Page Content"}],"html":"<h1>SharePoint REST API PowerShell Update Page Content</h1>\n<div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; \" > <iframe src=\"https://www.youtube.com/embed/eEV0V-tcEo0\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen=\"\" style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe> </div>\n<p><strong>Goal:</strong> Ability to update SharePoint page content via REST API</p>\n<h2>Prerequisites</h2>\n<p>Set Azure <code class=\"language-text\">$tenant_id</code> (can be retrieved from Azure Active Directory) and <code class=\"language-text\">$sharepoint</code> website subdomain</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$tenant_id</span>=<span class=\"token string\">'xxxxxxxxxxxx'</span>\n<span class=\"token variable\">$sharepoint</span>=<span class=\"token string\">'YOUR_SHAREPOINT_SITE'</span></code></pre></div>\n<h2>App registration</h2>\n<p><a href=\"https://YOUR_SHAREPOINT_SITE.sharepoint.com/_layouts/15/appregnew.aspx\">https://YOUR_SHAREPOINT_SITE.sharepoint.com/_layouts/15/appregnew.aspx</a></p>\n<blockquote>\n<p>set <code class=\"language-text\">$client_id</code> and <code class=\"language-text\">$client_secret</code> somewhere</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$client_id</span>=<span class=\"token string\">'xxxxxxxxxxxx'</span>\n<span class=\"token variable\">$client_secret</span>=<span class=\"token string\">'xxxxxxxxxxxx'</span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>generate both client identifier and secret</li>\n<li>links for web site and callback url does not matter</li>\n</ul>\n<h2>App invitation</h2>\n<p><a href=\"https://YOUR_SHAREPOINT_SITE.sharepoint.com/_layouts/15/appinv.aspx\">https://YOUR_SHAREPOINT_SITE.sharepoint.com/_layouts/15/appinv.aspx</a></p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AppPermissionRequests</span> <span class=\"token attr-name\">AllowAppOnlyPolicy</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AppPermissionRequest</span> <span class=\"token attr-name\">Scope</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://sharepoint/content/sitecollection<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Right</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>FullControl<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>AppPermissionRequests</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>put your client identifier and press lookup button whole form should be filled in automatically</li>\n<li>modify permissions request to desired one</li>\n</ul>\n<h2>PowerShell</h2>\n<h3>Retrieve Access Token</h3>\n<p>Before moving further we need to exchange our application credentials to access token which will be used in all subsequent requests</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$res</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Post <span class=\"token operator\">-</span>Uri <span class=\"token string\">\"https://accounts.accesscontrol.windows.net/<span class=\"token variable\">$tenant_id</span>/tokens/OAuth/2\"</span> <span class=\"token operator\">-</span>ContentType <span class=\"token string\">\"application/x-www-form-urlencoded\"</span> <span class=\"token operator\">-</span>Body @<span class=\"token punctuation\">{</span>\n    grant_type=<span class=\"token string\">\"client_credentials\"</span>\n    client_id=<span class=\"token string\">\"<span class=\"token variable\">$client_id</span>@<span class=\"token variable\">$tenant_id</span>\"</span>\n    client_secret=<span class=\"token variable\">$client_secret</span>\n    resource=<span class=\"token string\">\"00000003-0000-0ff1-ce00-000000000000/<span class=\"token variable\">$sharepoint</span>.sharepoint.com@<span class=\"token variable\">$tenant_id</span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$headers</span> = @<span class=\"token punctuation\">{</span>\n    Authorization = <span class=\"token string\">\"Bearer <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$res</span><span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">)</span></span>\"</span>\n    Accept = <span class=\"token string\">\"application/json;odata=verbose\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Enumerate Lists</h3>\n<p>SharePoint site consists of lists of items, there are lists of files, documents, forms, what ever else and desired website pages</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://<span class=\"token variable\">$sharepoint</span>.sharepoint.com/_api/web/lists\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty d <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty results <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> Id<span class=\"token punctuation\">,</span> Title\n\n<span class=\"token comment\"># 976b19d8-52db-489d-a6e3-2557a1520c79 Сторінки сайту # Site Pages</span>\n<span class=\"token variable\">$guid</span>=<span class=\"token string\">'976b19d8-52db-489d-a6e3-2557a1520c79'</span></code></pre></div>\n<p>Note that depending on your locale titles may differ, thats why we are going to use GUID instead</p>\n<h3>Enumerate List Items</h3>\n<p>Each list consists of items</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token punctuation\">(</span><span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://<span class=\"token variable\">$sharepoint</span>.sharepoint.com/_api/Web/Lists(guid'<span class=\"token variable\">$guid</span>')/Items?select=Id,Title\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertFrom-Json</span> <span class=\"token operator\">-</span>AsHashtable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>d<span class=\"token punctuation\">.</span>results <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> id<span class=\"token punctuation\">,</span> title\n\n<span class=\"token comment\"># 1 Home page</span>\n<span class=\"token comment\"># 2 mac</span>\n<span class=\"token variable\">$id</span>=2</code></pre></div>\n<h3>Get List Item By Id</h3>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$page</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://<span class=\"token variable\">$sharepoint</span>.sharepoint.com/_api/Web/Lists(guid'<span class=\"token variable\">$guid</span>')/items(<span class=\"token variable\">$id</span>)\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertFrom-Json</span> <span class=\"token operator\">-</span>AsHashtable\n<span class=\"token variable\">$page</span> = <span class=\"token variable\">$page</span><span class=\"token punctuation\">.</span>d\n<span class=\"token variable\">$page</span><span class=\"token punctuation\">.</span>Title\n<span class=\"token variable\">$page</span><span class=\"token punctuation\">.</span>CanvasContent1</code></pre></div>\n<p><code class=\"language-text\">CanvasContent1</code> holds page content, take a note that it is usual HTML enriched by SharePoint metadata, to avoid broken pages create template first, save it, and then update content from it</p>\n<h3>Update Page Content</h3>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$h</span> = @<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Authorization\"</span> = <span class=\"token string\">\"Bearer <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$res</span><span class=\"token punctuation\">.</span>access_token<span class=\"token punctuation\">)</span></span>\"</span>\n    <span class=\"token string\">\"Accept\"</span>        = <span class=\"token string\">\"application/json;odata=verbose\"</span>\n    <span class=\"token string\">\"Content-Type\"</span>  = <span class=\"token string\">\"application/json\"</span>\n    <span class=\"token string\">\"If-Match\"</span>      = <span class=\"token string\">\"*\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Patch <span class=\"token string\">\"https://<span class=\"token variable\">$sharepoint</span>.sharepoint.com/_api/Web/Lists(guid'<span class=\"token variable\">$guid</span>')/items(<span class=\"token variable\">$id</span>)\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$h</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span>@<span class=\"token punctuation\">{</span> CanvasContent1 = @<span class=\"token string\">\"\n&lt;div>\n&lt;div data-sp-canvascontrol=\"</span><span class=\"token string\">\" data-sp-canvasdataversion=\"</span>1<span class=\"token punctuation\">.</span>0<span class=\"token string\">\" data-sp-controldata='&amp;#123;\"</span>controlType<span class=\"token string\">\"&amp;#58;4,\"</span>id<span class=\"token string\">\"&amp;#58;\"</span>9db886a5-6767-498a-856a-76852dfb4a42<span class=\"token string\">\",\"</span>position<span class=\"token string\">\"&amp;#58;&amp;#123;\"</span>zoneIndex<span class=\"token string\">\"&amp;#58;2,\"</span>sectionIndex<span class=\"token string\">\"&amp;#58;1,\"</span>controlIndex<span class=\"token string\">\"&amp;#58;1,\"</span>layoutIndex<span class=\"token string\">\"&amp;#58;1&amp;#125;,\"</span>emphasis<span class=\"token string\">\"&amp;#58;&amp;#123;&amp;#125;,\"</span>zoneGroupMetadata<span class=\"token string\">\"&amp;#58;&amp;#123;\"</span><span class=\"token function\">type</span><span class=\"token string\">\"&amp;#58;0&amp;#125;,\"</span>addedFromPersistedData<span class=\"token string\">\"&amp;#58;true&amp;#125;'>\n&lt;p>mac was here&lt;/p>\n&lt;/div>\n&lt;/div>\n\"</span>@<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Json</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Here we can start building our page by replacing <code class=\"language-text\">&lt;p>mac was here&lt;/p></code> with almost anything we want</p>\n<h3>Publish Page</h3>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Post <span class=\"token string\">\"https://<span class=\"token variable\">$sharepoint</span>.sharepoint.com/_api/web/GetFileByServerRelativeUrl('/SitePages/mac.aspx')/Publish()\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span></code></pre></div>\n<p>Note that after modifying content you also need to publish page, also did not bother of finding a way to do it via page identifier and just used relative url found somethere in internet</p>\n<h3>Demo</h3>\n<p>Here is an use case, suppose we want page describing Kubernetes cluster, and want it to be always up to date</p>\n<p>So we need to prepare some cronjob which will grab data about cluster, form HTML from it and update page in SharePoint - profit</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$nodes</span> = kubectl get no <span class=\"token operator\">-</span>o json <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertFrom-Json</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty items <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> @<span class=\"token punctuation\">{</span>n=<span class=\"token string\">'name'</span><span class=\"token punctuation\">;</span>e=<span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> @<span class=\"token punctuation\">{</span>n=<span class=\"token string\">'group'</span><span class=\"token punctuation\">;</span>e=<span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>labels<span class=\"token punctuation\">.</span><span class=\"token string\">'node.deckhouse.io/group'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> @<span class=\"token punctuation\">{</span>n=<span class=\"token string\">'cpu'</span><span class=\"token punctuation\">;</span>e=<span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">.</span>allocatable<span class=\"token punctuation\">.</span>cpu <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> @<span class=\"token punctuation\">{</span>n=<span class=\"token string\">'ram'</span><span class=\"token punctuation\">;</span>e=<span class=\"token punctuation\">{</span> <span class=\"token namespace\">[Math]</span>::Ceiling<span class=\"token punctuation\">(</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">.</span>allocatable<span class=\"token punctuation\">.</span>memory <span class=\"token operator\">/</span> 1Gb<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$nodes</span> <span class=\"token comment\"># array of nodes (name, role, cpu, ram)</span>\n\n<span class=\"token variable\">$table</span> = <span class=\"token variable\">$nodes</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Html</span> <span class=\"token operator\">-</span>Fragment <span class=\"token comment\"># create html table from a given array</span>\n\n<span class=\"token variable\">$table</span> = <span class=\"token variable\">$table</span><span class=\"token punctuation\">.</span>Replace<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&lt;table width=\"100%\"'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># make our table fill whole page</span>\n\n<span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Patch <span class=\"token string\">\"https://<span class=\"token variable\">$sharepoint</span>.sharepoint.com/_api/Web/Lists(guid'<span class=\"token variable\">$guid</span>')/items(<span class=\"token variable\">$id</span>)\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$h</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span>@<span class=\"token punctuation\">{</span> CanvasContent1 = @<span class=\"token string\">\"\n&lt;div>\n&lt;div data-sp-canvascontrol=\"</span><span class=\"token string\">\" data-sp-canvasdataversion=\"</span>1<span class=\"token punctuation\">.</span>0<span class=\"token string\">\" data-sp-controldata='&amp;#123;\"</span>controlType<span class=\"token string\">\"&amp;#58;4,\"</span>id<span class=\"token string\">\"&amp;#58;\"</span>9db886a5-6767-498a-856a-76852dfb4a42<span class=\"token string\">\",\"</span>position<span class=\"token string\">\"&amp;#58;&amp;#123;\"</span>zoneIndex<span class=\"token string\">\"&amp;#58;2,\"</span>sectionIndex<span class=\"token string\">\"&amp;#58;1,\"</span>controlIndex<span class=\"token string\">\"&amp;#58;1,\"</span>layoutIndex<span class=\"token string\">\"&amp;#58;1&amp;#125;,\"</span>emphasis<span class=\"token string\">\"&amp;#58;&amp;#123;&amp;#125;,\"</span>zoneGroupMetadata<span class=\"token string\">\"&amp;#58;&amp;#123;\"</span><span class=\"token function\">type</span><span class=\"token string\">\"&amp;#58;0&amp;#125;,\"</span>addedFromPersistedData<span class=\"token string\">\"&amp;#58;true&amp;#125;'>\n&lt;h1>Kubernetes Cluster Nodes&lt;/h1>\n<span class=\"token variable\">$table</span>\n&lt;/div>\n&lt;/div>\n\"</span>@<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Json</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Post <span class=\"token string\">\"https://<span class=\"token variable\">$sharepoint</span>.sharepoint.com/_api/web/GetFileByServerRelativeUrl('/SitePages/mac.aspx')/Publish()\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span></code></pre></div>"}},"pageContext":{"id":"24b924bc-d088-523f-9946-956f213848bd"}},"staticQueryHashes":[]}