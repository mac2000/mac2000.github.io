{"componentChunkName":"component---src-templates-note-js","path":"/maxmind-bigquery","result":{"data":{"remark":{"fields":{"path":"maxmind-bigquery"},"meta":{"title":""},"headings":[{"value":"MaxMind BigQuery GeoIP"}],"html":"<h1>MaxMind BigQuery GeoIP</h1>\n<p>Idea here is to have maxmind ip lookup table in bigquery for further logs analysis</p>\n<p>So, first of all we need clean everything up</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bq <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> <span class=\"token parameter variable\">-t</span> rualogs:data.maxmind\n<span class=\"token function\">rm</span> *.txt *.csv *.zip</code></pre></div>\n<p>Download and unzip fresh data</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> http://geolite.maxmind.com/download/geoip/database/GeoLite2-Country-CSV.zip\n<span class=\"token function\">wget</span> http://geolite.maxmind.com/download/geoip/database/GeoLite2-ASN-CSV.zip\n\n<span class=\"token function\">unzip</span> <span class=\"token parameter variable\">-jo</span> GeoLite2-Country-CSV.zip\n<span class=\"token function\">unzip</span> <span class=\"token parameter variable\">-jo</span> GeoLite2-ASN-CSV.zip</code></pre></div>\n<p>Load data into BigQuery</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bq load <span class=\"token parameter variable\">--skip_leading_rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> rualogs:data.tmp_country_ip GeoLite2-Country-Blocks-IPv4.csv <span class=\"token string\">\"network:string,geoname_id:integer,registered_country_geoname_id:integer,represented_country_geoname_id:integer,is_anonymous_proxy:integer,is_satellite_provider:integer\"</span>\n\nbq load <span class=\"token parameter variable\">--skip_leading_rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> rualogs:data.tmp_country_labels GeoLite2-Country-Locations-en.csv <span class=\"token string\">\"geoname_id:integer,locale_code:string,continent_code:string,continent_name:string,country_iso_code:string,country_name:string\"</span>\n\nbq load <span class=\"token parameter variable\">--skip_leading_rows</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> rualogs:data.tmp_asn GeoLite2-ASN-Blocks-IPv4.csv <span class=\"token string\">\"network:string,autonomous_system_number:integer,autonomous_system_organization:string\"</span></code></pre></div>\n<p>Now is most important stuff - we are going to process uploaded data and save result as new table</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bq query <span class=\"token parameter variable\">--use_legacy_sql</span><span class=\"token operator\">=</span>false <span class=\"token parameter variable\">--allow_large_results</span> <span class=\"token parameter variable\">--destination_table</span><span class=\"token operator\">=</span>rualogs:data.maxmind <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> maxmind.sql<span class=\"token variable\">)</span></span>\"</span></code></pre></div>\n<p>After this step is done we may cleanup temp tables</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bq <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> <span class=\"token parameter variable\">-t</span> rualogs:data.tmp_country_ip\nbq <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> <span class=\"token parameter variable\">-t</span> rualogs:data.tmp_country_labels\nbq <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> <span class=\"token parameter variable\">-t</span> rualogs:data.tmp_asn</code></pre></div>\n<p>From now on anywhere needed we may join our maxmind table like so</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> l<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">.</span>country_name<span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">.</span>autonomous_system_organization\n<span class=\"token keyword\">FROM</span> <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span>log <span class=\"token keyword\">AS</span> l\n<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span>maxmind <span class=\"token keyword\">AS</span> m <span class=\"token keyword\">ON</span> CAST<span class=\"token punctuation\">(</span>NET<span class=\"token punctuation\">.</span>IPV4_TO_INT64<span class=\"token punctuation\">(</span>NET<span class=\"token punctuation\">.</span>IP_FROM_STRING<span class=\"token punctuation\">(</span>l<span class=\"token punctuation\">.</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token operator\">*</span><span class=\"token number\">256</span><span class=\"token operator\">*</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> INT64<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> class_a <span class=\"token operator\">AND</span> NET<span class=\"token punctuation\">.</span>IPV4_TO_INT64<span class=\"token punctuation\">(</span>NET<span class=\"token punctuation\">.</span>IP_FROM_STRING<span class=\"token punctuation\">(</span>l<span class=\"token punctuation\">.</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">BETWEEN</span> start_num <span class=\"token operator\">AND</span> end_num\n<span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span>_PARTITIONTIME <span class=\"token operator\">=</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CURRENT_DATE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">OR</span> _PARTITIONTIME <span class=\"token operator\">IS</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">LIMIT</span> <span class=\"token number\">100</span></code></pre></div>\n<p><strong>maxmind.sql</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">WITH</span> raw <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n\n<span class=\"token keyword\">SELECT</span>\nREGEXP_REPLACE<span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">,</span> r<span class=\"token string\">'/\\d+$'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> net<span class=\"token punctuation\">,</span>\nCAST<span class=\"token punctuation\">(</span>REGEXP_REPLACE<span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">,</span> r<span class=\"token string\">'^\\d+\\.\\d+\\.\\d+\\.\\d+/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> int64<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> mask<span class=\"token punctuation\">,</span>\nCAST<span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> POW<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span> <span class=\"token operator\">-</span> CAST<span class=\"token punctuation\">(</span>REGEXP_REPLACE<span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">,</span> r<span class=\"token string\">'^\\d+\\.\\d+\\.\\d+\\.\\d+/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> int64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span> <span class=\"token keyword\">THEN</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ELSE</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> POW<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span> <span class=\"token operator\">-</span> CAST<span class=\"token punctuation\">(</span>REGEXP_REPLACE<span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">,</span> r<span class=\"token string\">'^\\d+\\.\\d+\\.\\d+\\.\\d+/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> int64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> INT64<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> hosts<span class=\"token punctuation\">,</span>\n<span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>rualogs.data.tmp_country_ip<span class=\"token punctuation\">`</span></span>\n\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> num <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n\n<span class=\"token keyword\">select</span>\nNET<span class=\"token punctuation\">.</span>IPV4_TO_INT64<span class=\"token punctuation\">(</span>NET<span class=\"token punctuation\">.</span>IP_FROM_STRING<span class=\"token punctuation\">(</span>net<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">as</span> start_num<span class=\"token punctuation\">,</span>\nNET<span class=\"token punctuation\">.</span>IPV4_TO_INT64<span class=\"token punctuation\">(</span>NET<span class=\"token punctuation\">.</span>IP_FROM_STRING<span class=\"token punctuation\">(</span>net<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> hosts <span class=\"token keyword\">as</span> end_num<span class=\"token punctuation\">,</span>\n<span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> raw\n\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ip <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n\n<span class=\"token keyword\">select</span>\ncast<span class=\"token punctuation\">(</span>start_num<span class=\"token operator\">/</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token operator\">*</span><span class=\"token number\">256</span><span class=\"token operator\">*</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> int64<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> class_a<span class=\"token punctuation\">,</span>\nNET<span class=\"token punctuation\">.</span>IP_TO_STRING<span class=\"token punctuation\">(</span>NET<span class=\"token punctuation\">.</span>IPV4_FROM_INT64<span class=\"token punctuation\">(</span>start_num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> start_ip<span class=\"token punctuation\">,</span>\nNET<span class=\"token punctuation\">.</span>IP_TO_STRING<span class=\"token punctuation\">(</span>NET<span class=\"token punctuation\">.</span>IPV4_FROM_INT64<span class=\"token punctuation\">(</span>end_num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> end_ip<span class=\"token punctuation\">,</span>\n<span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> num\n\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> maxmind <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n\n<span class=\"token keyword\">select</span>\nip<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>\nl<span class=\"token punctuation\">.</span>locale_code<span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">.</span>continent_code<span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">.</span>continent_name<span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">.</span>country_iso_code<span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">.</span>country_name<span class=\"token punctuation\">,</span>\na<span class=\"token punctuation\">.</span>autonomous_system_number<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>autonomous_system_organization\n<span class=\"token keyword\">from</span> ip\n<span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> rualogs<span class=\"token punctuation\">.</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span>tmp_country_labels l <span class=\"token keyword\">on</span> ip<span class=\"token punctuation\">.</span>geoname_id <span class=\"token operator\">=</span> l<span class=\"token punctuation\">.</span>geoname_id\n<span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> rualogs<span class=\"token punctuation\">.</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span>tmp_asn a <span class=\"token keyword\">on</span> ip<span class=\"token punctuation\">.</span>network <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span>network\n\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> maxmind</code></pre></div>"}},"pageContext":{"id":"9fc9a78d-7d17-5e3d-86eb-db366cf39520"}},"staticQueryHashes":[]}