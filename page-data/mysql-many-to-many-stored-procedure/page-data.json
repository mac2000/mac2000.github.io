{"componentChunkName":"component---src-templates-note-js","path":"/mysql-many-to-many-stored-procedure","result":{"data":{"remark":{"fields":{"path":"mysql-many-to-many-stored-procedure"},"meta":{"title":""},"headings":[{"value":"MySQL many-to-many stored procedure"}],"html":"<h1>MySQL many-to-many stored procedure</h1>\n<p>Suppose we have following data:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+-------------+----------------+\n| keyword     | domain         |\n+-------------+----------------+\n| foo         | example.com    |\n| bar         | example.com    |\n| hello world | helloworld.org |\n+-------------+----------------+</code></pre></div>\n<p>In my case, after normalization, i have following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">keywords(id, keyword)\ndomains(id, domain)\nkeywords_domains(id, keyword_id, domain_id)</code></pre></div>\n<p><code class=\"language-text\">id</code> in last table is optional and needed for later use.</p>\n<p>Here is SQL to create all this:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- Drop previously created tables, views and procedures</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">VIEW</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> keywords_domains_view<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> search_results<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> keywords_domains<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> keywords<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> domains<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- Create tables and views</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> keywords <span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tkeyword  <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">UNIQUE</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_general_ci<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> domains <span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tdomain  <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">UNIQUE</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_general_ci<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> keywords_domains <span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tkeyword_id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\tdomain_id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">INDEX</span><span class=\"token punctuation\">(</span>keyword_id<span class=\"token punctuation\">,</span> domain_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">(</span>keyword_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">REFERENCES</span> keywords<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">UPDATE</span> <span class=\"token keyword\">CASCADE</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">CASCADE</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">(</span>domain_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">REFERENCES</span> domains<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">UPDATE</span> <span class=\"token keyword\">CASCADE</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">CASCADE</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_general_ci<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">VIEW</span> keywords_domains_view <span class=\"token keyword\">AS</span>\n\t<span class=\"token keyword\">SELECT</span> keyword<span class=\"token punctuation\">,</span> domain <span class=\"token keyword\">FROM</span> keywords_domains\n\t<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> keywords <span class=\"token keyword\">ON</span> keywords_domains<span class=\"token punctuation\">.</span>keyword_id <span class=\"token operator\">=</span> keywords<span class=\"token punctuation\">.</span>id\n\t<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> domains <span class=\"token keyword\">ON</span> keywords_domains<span class=\"token punctuation\">.</span>domain_id <span class=\"token operator\">=</span> domains<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now to if we need to insert some date we will do it something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> domains <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'example.com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SET</span> <span class=\"token variable\">@id_1</span> <span class=\"token operator\">=</span> LAST_INSERT_ID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> domains <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'helloworld.org'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SET</span> <span class=\"token variable\">@id_2</span> <span class=\"token operator\">=</span> LAST_INSERT_ID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> keywords <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> keywords_domains <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> LAST_INSERT_ID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@id_1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> keywords <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> keywords_domains <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> LAST_INSERT_ID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@id_1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> keywords <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'hello world'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> keywords_domains <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> LAST_INSERT_ID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@id_2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And all seems ok, except cases when we catch duplicate error.</p>\n<p>To make things simpler we can create stored procedure that will check existing of rows and insert them as needed.</p>\n<p>Here is stored procedure:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DELIMITER</span> $$\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">PROCEDURE</span> AddKeywordDomain<span class=\"token punctuation\">(</span>keyword_in <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> domain_in <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">BEGIN</span>\n\t<span class=\"token keyword\">DECLARE</span> keyword_in_id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">DECLARE</span> domain_in_id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">DECLARE</span> keyword_domain_id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">SELECT</span> id <span class=\"token keyword\">INTO</span> domain_in_id <span class=\"token keyword\">FROM</span> domains <span class=\"token keyword\">WHERE</span> domain <span class=\"token operator\">=</span> domain_in <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">IF</span> domain_in_id <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">THEN</span>\n\t\t<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> domains <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> domain_in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">SET</span> domain_in_id <span class=\"token operator\">=</span> LAST_INSERT_ID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">END</span> <span class=\"token keyword\">IF</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">SELECT</span> id <span class=\"token keyword\">INTO</span> keyword_in_id <span class=\"token keyword\">FROM</span> keywords <span class=\"token keyword\">WHERE</span> keyword <span class=\"token operator\">=</span> keyword_in <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">IF</span> keyword_in_id <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">THEN</span>\n\t\t<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> keywords <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> keyword_in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">SET</span> keyword_in_id <span class=\"token operator\">=</span> LAST_INSERT_ID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">END</span> <span class=\"token keyword\">IF</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">SELECT</span> id <span class=\"token keyword\">INTO</span> keyword_domain_id <span class=\"token keyword\">FROM</span> keywords_domains <span class=\"token keyword\">WHERE</span> keyword_id <span class=\"token operator\">=</span> keyword_in_id <span class=\"token operator\">AND</span> domain_id <span class=\"token operator\">=</span> domain_in_id <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">IF</span> keyword_domain_id <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">THEN</span>\n\t\t<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> keywords_domains <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> keyword_in_id<span class=\"token punctuation\">,</span> domain_in_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">SET</span> keyword_domain_id <span class=\"token operator\">=</span> LAST_INSERT_ID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">END</span> <span class=\"token keyword\">IF</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">SELECT</span> keyword_domain_id<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span>$$\n<span class=\"token keyword\">DELIMITER</span> <span class=\"token punctuation\">;</span></code></pre></div>\n<p>And now we can insert new record like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CALL</span> AddKeywordDomain<span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'example.com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CALL</span> AddKeywordDomain<span class=\"token punctuation\">(</span><span class=\"token string\">'bar'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'example.com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CALL</span> AddKeywordDomain<span class=\"token punctuation\">(</span><span class=\"token string\">'hello world'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'helloworld.org'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>"}},"pageContext":{"id":"0b6b6e80-a114-56c4-888f-ea5b26d41a27"}},"staticQueryHashes":[]}