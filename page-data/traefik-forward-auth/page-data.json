{"componentChunkName":"component---src-templates-note-js","path":"/traefik-forward-auth/","result":{"data":{"remark":{"fields":{"path":"traefik-forward-auth"},"meta":{"title":""},"headings":[{"value":"Traefik forwardAuth explained"}],"html":"<h1>Traefik forwardAuth explained</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fe6d8c7f9d7d3526119279d81e911977/cbe7f/authforward.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.5625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAs0lEQVR42l2Oi46EIAxF5///UyNWQHT6Rtm6mWQft6S5gZ5bXmrkqu5qbrBCLjmlBLAhnfg+WqvEbwCY5zm6qjKTKpnFvLzMwokIYRRRrXX/Vt3LXktalghQFSIMrPce3rsE8sBj3GMMEW6tTdMU8aWUnDcRQ5LeLxY7DkX055Cdp7Ym3XtQAf/R/egxiFYrR0fUdd3zFuHx4S7izH5d9w/8IX4pnmNtXBPpBrCmhVn+zXwBMB4heb0KUqsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"flow\"\n        title=\"\"\n        src=\"/static/fe6d8c7f9d7d3526119279d81e911977/2bef9/authforward.png\"\n        srcset=\"/static/fe6d8c7f9d7d3526119279d81e911977/6f3f2/authforward.png 256w,\n/static/fe6d8c7f9d7d3526119279d81e911977/01e7c/authforward.png 512w,\n/static/fe6d8c7f9d7d3526119279d81e911977/2bef9/authforward.png 1024w,\n/static/fe6d8c7f9d7d3526119279d81e911977/71c1d/authforward.png 1536w,\n/static/fe6d8c7f9d7d3526119279d81e911977/a878e/authforward.png 2048w,\n/static/fe6d8c7f9d7d3526119279d81e911977/cbe7f/authforward.png 2420w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>From a picture above it should be pretty clear how it works.</p>\n<p>In general, points are:</p>\n<ol>\n<li>before proceeding to our service, request is send to auth service</li>\n<li>depending on auth service response Traefik will either continue or block request</li>\n</ol>\n<p>Before going deeper let's build and sandbox to see it in action</p>\n<p>For demo purposes we are going to run everything in docker, so no need to install anything</p>\n<p>First, let's start some service (aka the app we are going to protect)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>echo ealen/echo-server</code></pre></div>\n<blockquote>\n<p>Note: this one is an simple echo server, that will log and respond with details about incomming request, listening on port 80, we are not exposing it by intent</p>\n</blockquote>\n<p>Second, for an auth service, actually, let's run the same image:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>auth ealen/echo-server</code></pre></div>\n<blockquote>\n<p>Note: the only difference here is the container name, we are going to use it in next step</p>\n</blockquote>\n<p>Now it is turn for Traefik, first prepare configuration files:</p>\n<p><strong>static.yml</strong></p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">log</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span> DEBUG\n<span class=\"token key atrule\">accessLog</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">format</span><span class=\"token punctuation\">:</span> common\n<span class=\"token key atrule\">providers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">filename</span><span class=\"token punctuation\">:</span> /etc/traefik/dynamic.yml\n<span class=\"token key atrule\">entryPoints</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">asDefault</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">experimental</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">google-oidc-auth-middleware</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">moduleName</span><span class=\"token punctuation\">:</span> github.com/andrewkroh/google<span class=\"token punctuation\">-</span>oidc<span class=\"token punctuation\">-</span>auth<span class=\"token punctuation\">-</span>middleware\n      <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v0.1.0</code></pre></div></p>\n<p><strong>dynamic.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">forwardAuth</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//auth<span class=\"token punctuation\">:</span><span class=\"token number\">80</span>\n  <span class=\"token key atrule\">routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> Path(`/`)\n      <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> echo\n      <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> auth\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">loadBalancer</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">servers</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//echo<span class=\"token punctuation\">:</span>80/</code></pre></div>\n<p>And finally run traefik:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>traefik <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>echo <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>auth <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/static.yml:/etc/traefik/static.yml\"</span> <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/dynamic.yml:/etc/traefik/dynamic.yml\"</span> traefik:v3 <span class=\"token parameter variable\">--configfile</span><span class=\"token operator\">=</span>/etc/traefik/static.yml</code></pre></div>\n<blockquote>\n<p>Note: here we are linking <code class=\"language-text\">echo</code> and <code class=\"language-text\">auth</code> containers, so Traefik can reach them</p>\n</blockquote>\n<p>Now, give it a try, and try call <code class=\"language-text\">localhost:8080</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> localhost:8080</code></pre></div>\n<p>Note how both <code class=\"language-text\">auth</code> and <code class=\"language-text\">echo</code> containers receive the request</p>\n<ol>\n<li>Once received an request, Traefik did send request to our <code class=\"language-text\">auth</code> container</li>\n<li>It did respond with 200 OK and details about request</li>\n<li>Once received an 200 OK response from <code class=\"language-text\">auth</code> service, Traefik continued and proxied request to <code class=\"language-text\">echo</code></li>\n<li><code class=\"language-text\">echo</code> did respond with 200 OK and that response was proxied back to us</li>\n</ol>\n<p>If you make few more calls, you should confirm, that Traefik does repeat that for all requests. This one may be important, if you are working with services under high load.</p>\n<p>Also, if you have closer look you should notice that details about original request are passed as <code class=\"language-text\">x-forwarded-</code> headers, most of all, we probably interested in:</p>\n<ul>\n<li><code class=\"language-text\">x-forwarded-host</code> - which will contain hostname, and optionally port</li>\n<li><code class=\"language-text\">x-forwarded-uri</code> - will container path with query string</li>\n</ul>\n<p>Cookies and authorization headers are passed as is, so you can access them as usual</p>\n<h2>Dummy auth service for Traefikd forward auth</h2>\n<p>So why not have fun, and build some dummy auth service</p>\n<p>Here is an example of echo like service to start from</p>\n<p><div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createServer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span>\n\n<span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-method'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">host</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">uri</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'OK\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'open http://localhost:3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div></p>\n<p>Start it like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>auth <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/echo.js:/app/echo.js\"</span> <span class=\"token parameter variable\">-w</span> /app node:23-alpine <span class=\"token function\">node</span> echo.js</code></pre></div>\n<p>Note, because we are listening for port 3000, we should modify our <code class=\"language-text\">dynamic.yml</code> like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">forwardAuth</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//auth<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>\n        <span class=\"token comment\"># ðŸ‘† we have changed port here, everything else is the same</span>\n  <span class=\"token key atrule\">routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> Path(`/`)\n      <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> echo\n      <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> auth\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">loadBalancer</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">servers</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//echo<span class=\"token punctuation\">:</span>80/</code></pre></div>\n<p>restart Traefik</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>traefik <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>echo <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>auth <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/static.yml:/etc/traefik/static.yml\"</span> <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/dynamic.yml:/etc/traefik/dynamic.yml\"</span> traefik:v3 <span class=\"token parameter variable\">--configfile</span><span class=\"token operator\">=</span>/etc/traefik/static.yml</code></pre></div>\n<p>make curl call:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">'http://localhost:8080/?foo=bar'</span></code></pre></div>\n<p>note how you are receing response from echo server, while in auth service we are logging following:</p>\n<div class=\"gatsby-highlight\" data-language=\"log\"><pre class=\"language-log\"><code class=\"language-log\"><span class=\"token operator\">{</span> method<span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> host<span class=\"token operator\">:</span> <span class=\"token string\">'localhost:8080'</span><span class=\"token punctuation\">,</span> uri<span class=\"token operator\">:</span> <span class=\"token string\">'/?foo=bar'</span> <span class=\"token operator\">}</span></code></pre></div>\n<p>Here is our dummy part, let's check <code class=\"language-text\">user</code> query string parameter, if it is present - we are treating request as valid, and responding with 200 OK, if not, respond with 401</p>\n<p><div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createServer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span>\n\n<span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://localhost'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-method'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">host</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">uri</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">user</span><span class=\"token operator\">:</span> user<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Who are you?\\n'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'OK\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'open http://localhost:3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div></p>\n<p>Now attemt to run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">'http://localhost:8080/?foo=bar'</span></code></pre></div>\n<p>will fail with 401 Unauthorized error and response <code class=\"language-text\">Who are you?</code></p>\n<p>and request like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">'http://localhost:8080/?user=alice'</span></code></pre></div>\n<p>will succeed.</p>\n<p>Technically, that all, and yes, it is so simple.</p>\n<p>Buf ofcourse noone will use such implementation, at the very end we need cookies to handle the state, here is another minimalistic example:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createServer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span>\n\n<span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-proto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// let's pretend such url is called on OAuth flow completion callback, from here we want to set an cookie and redirect user to home page</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>pathname <span class=\"token operator\">===</span> <span class=\"token string\">'/demo-as-if-it-was-callback-from-oauth'</span> <span class=\"token operator\">&amp;&amp;</span> url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Set-Cookie'</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">user=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">; HttpOnly;</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-proto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie<span class=\"token operator\">?.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">user=(\\w+)</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">user</span><span class=\"token operator\">:</span> user<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Who are you?\\n'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'OK\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'open http://localhost:3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div></p>\n<p>keep an eye on how we are handing very special endpoint</p>\n<p>let's check if everything still works</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token string\">'http://localhost:8080/?user=alice'</span></code></pre></div>\n<p>as expected gives us \"Who are you?\" response</p>\n<p>Now, let's pretend we have logged in:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'http://localhost:8080/demo-as-if-it-was-callback-from-oauth?user=alice'</span></code></pre></div>\n<p>we will receive 404 - which is indeed expected, we need to modify our router a little bit</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">forwardAuth</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//auth<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>\n  <span class=\"token key atrule\">routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> Path(`/`) <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> Path(`/demo<span class=\"token punctuation\">-</span>as<span class=\"token punctuation\">-</span>if<span class=\"token punctuation\">-</span>it<span class=\"token punctuation\">-</span>was<span class=\"token punctuation\">-</span>callback<span class=\"token punctuation\">-</span>from<span class=\"token punctuation\">-</span>oauth`)\n      <span class=\"token comment\"># ðŸ‘† we have added one more path to this route, later we will see other options</span>\n      <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> echo\n      <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> auth\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">loadBalancer</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">servers</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//echo<span class=\"token punctuation\">:</span>80/</code></pre></div>\n<p>now our request gives us desired response:</p>\n<div class=\"gatsby-highlight\" data-language=\"log\"><pre class=\"language-log\"><code class=\"language-log\">HTTP<span class=\"token operator\">/</span><span class=\"token number\">1.1</span> <span class=\"token number\">302</span> Found\n<span class=\"token property\">Date:</span> Fri<span class=\"token punctuation\">,</span> <span class=\"token date number\">14 Mar 2025</span> <span class=\"token time number\">08:03:44</span> GMT\n<span class=\"token property\">Location:</span> <span class=\"token url\">http://localhost:8080/</span>\n<span class=\"token property\">Set-Cookie:</span> user<span class=\"token operator\">=</span>alice<span class=\"token operator\">;</span> HttpOnly<span class=\"token operator\">;</span>\n<span class=\"token property\">Content-Length:</span> <span class=\"token number\">0</span></code></pre></div>\n<p>and as you may guess next request from browser will be:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token string\">'http://localhost:8080/?foo=bar'</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'Cookie: user=alice'</span></code></pre></div>\n<p>which will work</p>\n<p>at this point you should be able to do the same in browser by opening this urls</p>\n<p>Note: in real Traefik setups your routes will be catching hostanemes, aka:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> Host(`echo.mac<span class=\"token punctuation\">-</span>blog.org.ua`)</code></pre></div>\n<p>Because of that, they will catch all requests and there will be no need for dedicated rule to catch this callback url</p>\n<h2>Traefik OpenId Connect forwardAuth</h2>\n<p>Of course, no one will rely on such dummy auth service.</p>\n<p>To bypass all examples in the middle let's just directly into oidc</p>\n<p>It is required to have some understanding of how it works, previously there were some notes like this:</p>\n<ul>\n<li><a href=\"https://mac-blog.org.ua/kubernetes-oauth2-proxy/\">OAuth2 Proxy in Kubernetes</a></li>\n<li><a href=\"https://mac-blog.org.ua/oauth-oidc-journey/\">OAuth 2.0 and OpenID Connect journey</a></li>\n<li><a href=\"https://mac-blog.org.ua/go-oidc-verifier-azure-github/\">Golang OIDC verifier for Azure and Github Actions</a></li>\n</ul>\n<p>But never the less here is what we are going to build:</p>\n<p>Before jumping into complicated suff let's play with Github, it has minimalistic OAuth implementation</p>\n<h2>Traefik forwardAuth Github</h2>\n<p>Navigate to <a href=\"https://github.com/settings/developers\">github.com/settings/developers</a> and create new app with following params:</p>\n<ul>\n<li>Application name: Traefik</li>\n<li>Homepage URL: <a href=\"http://localhost:8080\">http://localhost:8080</a></li>\n<li>Authorization callback URL: <a href=\"http://localhost:8080/can-be-anything-we-want\">http://localhost:8080/can-be-anything-we-want</a></li>\n</ul>\n<p>Note: because literally all requests are catched and send to our service, we may use anything we want as callback url, for demo purposes I have choosen <code class=\"language-text\">/can-be-anything-we-want</code> to highlight that</p>\n<p>Once created, press \"Generate a new client secret\" button</p>\n<p>And keep note on both <code class=\"language-text\">client_id</code> and <code class=\"language-text\">client_secret</code></p>\n<p>in my case values are:</p>\n<ul>\n<li>client_id: Ov23liWuoZki5P2ubkFy</li>\n<li>client_secret: b23abc4e88d9e3973d5ac199dc4844c3b9f675ce</li>\n</ul>\n<p>How it will work:</p>\n<p>on auth side, we are going to check <code class=\"language-text\">github</code> cookie</p>\n<p>if request has it and it is \"valid\" then respond with 200 ok\notherwise we need to block request</p>\n<p>to keep everything secure, we are going to use session cookies</p>\n<p>note: there are two use cases - web requests and api requests we should behave differently for them</p>\n<p>here is naive pseudo code for auth middleware:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/can-be-anything-we-want'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> <span class=\"token function\">extractCodeFromQueryString</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">exchangeCodeToToken</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'set-cookie'</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">github=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> tokenFromCookie <span class=\"token operator\">=</span> <span class=\"token function\">extractGithubCookieFrom</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> valid <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">callUserInfoEndpointWith</span><span class=\"token punctuation\">(</span>tokenFromCookie<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>valid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isApiRequest</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token function\">buildGithubLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>it is kind of similar to previous example with cookies</p>\n<p>here is what i have ended up with</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createServer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span>\n\n<span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-proto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'processing'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// this one is where user redirected after github login</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>pathname <span class=\"token operator\">===</span> <span class=\"token string\">'/can-be-anything-we-want'</span> <span class=\"token operator\">&amp;&amp;</span> url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> client_id <span class=\"token operator\">=</span> <span class=\"token string\">'Ov23liWuoZki5P2ubkFy'</span>\n    <span class=\"token keyword\">const</span> client_secret <span class=\"token operator\">=</span> <span class=\"token string\">'b23abc4e88d9e3973d5ac199dc4844c3b9f675ce'</span>\n    <span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">callback, exchanging code </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> for token</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> access_token <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://github.com/login/oauth/access_token'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">Accept</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> client_id<span class=\"token punctuation\">,</span> client_secret<span class=\"token punctuation\">,</span> code <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span> <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">got token </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>access_token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">, set it as github cookie and redirect user to home page</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Set-Cookie'</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">github=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>access_token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">; HttpOnly;</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-proto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> github <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie<span class=\"token operator\">?.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">github=(\\w+)</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>github<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'not authenticated, redirect user to github login'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'authenticated, lets check email'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">var</span> <span class=\"token punctuation\">{</span> email <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://api.github.com/user'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">token </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>github<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span> <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// if (email !== 'hello@gmail.com') {</span>\n  <span class=\"token comment\">//   console.log(`unexpected email ${email}, redirect user to github login`)</span>\n  <span class=\"token comment\">//   return res.writeHead(302, { Location: getLoginUrl() }).end()</span>\n  <span class=\"token comment\">// }</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">email: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>email<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'OK\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'open http://localhost:3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://github.com/login/oauth/authorize'</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'client_id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Ov23liWuoZki5P2ubkFy'</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'redirect_uri'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://localhost:8080/can-be-anything-we-want'</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'scope'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'state'</span><span class=\"token punctuation\">,</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'allow_signup'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'false'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>and for it to work, we need to once again modify our route</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># ..</span>\n  <span class=\"token key atrule\">routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span>\n        Path(`/`) <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> Path(`/can<span class=\"token punctuation\">-</span>be<span class=\"token punctuation\">-</span>anything<span class=\"token punctuation\">-</span>we<span class=\"token punctuation\">-</span>want`) <span class=\"token comment\"># ðŸ‘ˆ path</span>\n        <span class=\"token comment\"># ...</span></code></pre></div>\n<p>with this setup - it will work in browser:</p>\n<ul>\n<li>when you open <code class=\"language-text\">http://localhost:8080</code></li>\n<li>you will be redirected to <code class=\"language-text\">https://github.com/login/oauth/authorize?client_id=Ov23liWuoZki5P2ubkFy&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fcan-be-anything-we-want&amp;scope=user&amp;state=9f8d6d03-b629-45d5-9bdc-72734a1aaa88&amp;allow_signup=false</code></li>\n<li>once logged in, we will be redirected back to <code class=\"language-text\">http://localhost:8080/can-be-anything-we-want?code=4aa78194e6eb9314ca9a&amp;state=5e8302fd-22a6-44cf-bd27-e08f26bb4f89</code></li>\n<li>after exchanging <code class=\"language-text\">code</code> to token, and setting it as an <code class=\"language-text\">github</code> cookie we will redirect user back to home page, so browser will be landed to <code class=\"language-text\">http://localhost:8080</code></li>\n<li>once <code class=\"language-text\">http://localhost:8080</code> is requested once again, our middleware does recognize the cookie and checks its email, returns 200 OK so Traefik proceeds and proxies our request to echo service</li>\n</ul>\n<p>Note, that on each subsequent request our auth service is still called and still performs checks which both good and bad, depending on what we are protecting</p>\n<p>Just from curiosity, lets add some caching and encryption on top</p>\n<p>Here is the idea:</p>\n<ul>\n<li>once authenticated, we will store authentication details in memory, tracking last time we did check them</li>\n<li>for cookie, instead of saving github token we will save our own encrypted session token</li>\n<li>for subsequent requests we will check our in memory storage instead of calling github api each time</li>\n</ul>\n<p>Here is example implementation</p>\n<p><div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createServer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createHash<span class=\"token punctuation\">,</span> createCipheriv<span class=\"token punctuation\">,</span> createDecipheriv<span class=\"token punctuation\">,</span> randomBytes<span class=\"token punctuation\">,</span> randomUUID <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'crypto'</span>\n\n<span class=\"token keyword\">const</span> secret <span class=\"token operator\">=</span> <span class=\"token string\">'SecretPhraseToEncryptDecryptCookie'</span>\n<span class=\"token keyword\">const</span> memory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> client_id <span class=\"token operator\">=</span> <span class=\"token string\">'Ov23liWuoZki5P2ubkFy'</span>\n<span class=\"token keyword\">const</span> client_secret <span class=\"token operator\">=</span> <span class=\"token string\">'b23abc4e88d9e3973d5ac199dc4844c3b9f675ce'</span>\n<span class=\"token keyword\">const</span> redirect_uri <span class=\"token operator\">=</span> <span class=\"token string\">'http://localhost:8080/can-be-anything-we-want'</span>\n\n<span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-proto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'processing'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// this one is where user redirected after github login</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>pathname <span class=\"token operator\">===</span> <span class=\"token string\">'/can-be-anything-we-want'</span> <span class=\"token operator\">&amp;&amp;</span> url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">callback, exchanging code </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> for token</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> access_token <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://github.com/login/oauth/access_token'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">Accept</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> client_id<span class=\"token punctuation\">,</span> client_secret<span class=\"token punctuation\">,</span> code <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span> <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">got an access token, retrieving user details</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> info <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserDetails</span><span class=\"token punctuation\">(</span>access_token<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'something wrong, can not retrieve user info, responding with 401'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Who are you?\\n'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    memory<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> <span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'session'</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">redirecting user back to home page with session cookie</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Set-Cookie'</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">session=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>session<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">; HttpOnly;</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-proto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie<span class=\"token operator\">?.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">session=([^(;|$)]+)</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>session<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'not authenticated, redirect user to github login'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'incomming session'</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'invalid session, can not decrypt, redirect user to github login'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> info <span class=\"token operator\">=</span> memory<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'invalid session, no user info found, redirect user to github login'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> timePassedSinceLastCheck <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> info<span class=\"token punctuation\">.</span>at\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timePassedSinceLastCheck <span class=\"token operator\">></span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token was checked more than 1 hour ago, we should recheck it once again'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> info <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserDetails</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'failed to recheck token, redirect user to github login'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span>\n    memory<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'responding with 200 OK to Traefik, passing additonal headers'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> res\n    <span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'X-User-Id'</span><span class=\"token operator\">:</span> info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'X-User-Login'</span><span class=\"token operator\">:</span> info<span class=\"token punctuation\">.</span>login<span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'X-User-Name'</span><span class=\"token operator\">:</span> info<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'X-User-Avatar'</span><span class=\"token operator\">:</span> info<span class=\"token punctuation\">.</span>avatar_url<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'OK\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'open http://localhost:3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://github.com/login/oauth/authorize'</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'client_id'</span><span class=\"token punctuation\">,</span> client_id<span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'redirect_uri'</span><span class=\"token punctuation\">,</span> redirect_uri<span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'scope'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'state'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'allow_signup'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'false'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getUserDetails</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">token</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// { \"id\": 88868, \"login\": \"mac2000\", \"name\": \"Alexandr Marchenko\", \"email\": \"marchenko.alexandr@gmail.com\", \"avatar_url\": \"https://avatars.githubusercontent.com/u/88868?v=4\" }</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> login<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> avatar_url <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://api.github.com/user'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span> <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">error while retrieving user info </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>error<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> login<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> avatar_url<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">at</span><span class=\"token operator\">:</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">text<span class=\"token punctuation\">,</span> secret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> text <span class=\"token operator\">===</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    text <span class=\"token operator\">=</span> text<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha256'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>secret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> iv <span class=\"token operator\">=</span> <span class=\"token function\">randomBytes</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> cipher <span class=\"token operator\">=</span> <span class=\"token function\">createCipheriv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes-256-ctr'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> iv<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> bytes <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>cipher<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cipher<span class=\"token punctuation\">.</span><span class=\"token function\">final</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> iv<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">':'</span> <span class=\"token operator\">+</span> bytes<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">input<span class=\"token punctuation\">,</span> secret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha256'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>secret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>iv<span class=\"token punctuation\">,</span> encrypted<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> decipher <span class=\"token operator\">=</span> <span class=\"token function\">createDecipheriv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes-256-ctr'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>iv<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> bytes <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>decipher<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>encrypted<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> decipher<span class=\"token punctuation\">.</span><span class=\"token function\">final</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> bytes<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">error while decrypting given input </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>error<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<p>Notes:</p>\n<ul>\n<li>we are storin in memory map where key is user id, and value are user details</li>\n<li>for cookie we are storing encrypted user id</li>\n<li>every hour, just in case, we are revalidating token</li>\n</ul>\n<p>Also, for demo purposes, we are passing headers like <code class=\"language-text\">X-User-Login</code> to our echo service</p>\n<p>for this to work, add following changes to <code class=\"language-text\">dynamic.yml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">forwardAuth</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//auth<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>\n        <span class=\"token key atrule\">authResponseHeaders</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>User<span class=\"token punctuation\">-</span>Id\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>User<span class=\"token punctuation\">-</span>Login\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>User<span class=\"token punctuation\">-</span>Name\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>User<span class=\"token punctuation\">-</span>Avatar\n<span class=\"token comment\"># ...</span></code></pre></div>\n<p>so we have almost ready to use example for github, add few more checks here and there and you are reday to go</p>\n<p>but initially the goal was to cover oidc forward auth so</p>\n<h2>Traefik Google auth</h2>\n<p>Now, when we have played with simplified Github example, it should be much easier to do something similar with Google</p>\n<p>By intent I will start with nodejs example, so it can be run as single script without the need to compile anything, and later on, if everything will be working fine, will add Golang example as well</p>\n<p>For Google we gonna need Google Cloud Project, configured OAuth contest screen and create an client - I expect this one should not be a problem, otherwise everthing below will be an dark magic</p>\n<p>here is what i have ended up with</p>\n<p><div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createServer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'http'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createHash<span class=\"token punctuation\">,</span> createCipheriv<span class=\"token punctuation\">,</span> createDecipheriv<span class=\"token punctuation\">,</span> randomBytes<span class=\"token punctuation\">,</span> randomUUID <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'crypto'</span>\n\n<span class=\"token keyword\">const</span> secret <span class=\"token operator\">=</span> <span class=\"token string\">'SecretPhraseToEncryptDecryptCookie'</span>\n<span class=\"token keyword\">const</span> memory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> client_id <span class=\"token operator\">=</span> <span class=\"token string\">'869226817339-0hlu97qq43ia4l24eugbl3q570v373m7.apps.googleusercontent.com'</span>\n<span class=\"token keyword\">const</span> client_secret <span class=\"token operator\">=</span> <span class=\"token string\">'GOCSPX-xxxxxx-kJsu'</span>\n<span class=\"token keyword\">const</span> redirect_uri <span class=\"token operator\">=</span> <span class=\"token string\">'http://localhost:8080/callback'</span>\n\n<span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-proto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-uri'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'processing'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// this one is where user redirected after google login</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>pathname <span class=\"token operator\">===</span> <span class=\"token string\">'/callback'</span> <span class=\"token operator\">&amp;&amp;</span> url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">callback, exchanging code </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> for token</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> access_token <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://oauth2.googleapis.com/token'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">Accept</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">grant_type</span><span class=\"token operator\">:</span> <span class=\"token string\">'authorization_code'</span><span class=\"token punctuation\">,</span>\n        code<span class=\"token punctuation\">,</span>\n        client_id<span class=\"token punctuation\">,</span>\n        client_secret<span class=\"token punctuation\">,</span>\n        redirect_uri<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span> <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">got an access token, retrieving user details</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> info <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserDetails</span><span class=\"token punctuation\">(</span>access_token<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'something wrong, can not retrieve user info, responding with 401'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Who are you?\\n'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    memory<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'memory keys'</span><span class=\"token punctuation\">,</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>memory<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> <span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'session'</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">redirecting user back to home page with session cookie</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Set-Cookie'</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">session=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>session<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">; HttpOnly;</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-proto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-forwarded-host'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie<span class=\"token operator\">?.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">session=([^(;|$)]+)</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>session<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'not authenticated, redirect user to google login'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'incomming session'</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'decrypted id'</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'invalid session, can not decrypt, redirect user to google login'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'memory keys'</span><span class=\"token punctuation\">,</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>memory<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> info <span class=\"token operator\">=</span> memory<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'invalid session, no user info found, redirect user to google login'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> timePassedSinceLastCheck <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> info<span class=\"token punctuation\">.</span>at\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timePassedSinceLastCheck <span class=\"token operator\">></span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token was checked more than 1 hour ago, we should recheck it once again'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> info <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserDetails</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'failed to recheck token, redirect user to google login'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Location</span><span class=\"token operator\">:</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span>\n    memory<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'responding with 200 OK to Traefik, passing additonal headers'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> res\n    <span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/plain'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'X-User-Id'</span><span class=\"token operator\">:</span> info<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'X-User-Name'</span><span class=\"token operator\">:</span> info<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'X-User-Picture'</span><span class=\"token operator\">:</span> info<span class=\"token punctuation\">.</span>picture<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'OK\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'open http://localhost:3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getLoginUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://accounts.google.com/o/oauth2/v2/auth'</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'response_type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'code'</span><span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'client_id'</span><span class=\"token punctuation\">,</span> client_id<span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'redirect_uri'</span><span class=\"token punctuation\">,</span> redirect_uri<span class=\"token punctuation\">)</span>\n  url<span class=\"token punctuation\">.</span>searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'scope'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'profile'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getUserDetails</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">token</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// { \"sub\": \"114259064191790696813\", \"name\": \"Alexandr Marchenko\", \"given_name\": \"Alexandr\", \"family_name\": \"Marchenko\", \"picture\": \"https://lh3.googleusercontent.com/a/ACg8ocLCg6rfbaPrEuotvuKegwXSu-TAXlT20AfJNJuoj5cZx604sxca\\u003ds96-c\" }</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> sub<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> picture <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://openidconnect.googleapis.com/v1/userinfo'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span> <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">error while retrieving user info </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>error<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>sub<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> sub<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> picture<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">at</span><span class=\"token operator\">:</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">text<span class=\"token punctuation\">,</span> secret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha256'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>secret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> iv <span class=\"token operator\">=</span> <span class=\"token function\">randomBytes</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> cipher <span class=\"token operator\">=</span> <span class=\"token function\">createCipheriv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes-256-ctr'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> iv<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> bytes <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>cipher<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cipher<span class=\"token punctuation\">.</span><span class=\"token function\">final</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> iv<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">':'</span> <span class=\"token operator\">+</span> bytes<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">input<span class=\"token punctuation\">,</span> secret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha256'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>secret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>iv<span class=\"token punctuation\">,</span> encrypted<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> decipher <span class=\"token operator\">=</span> <span class=\"token function\">createDecipheriv</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aes-256-ctr'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>iv<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> bytes <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>decipher<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>encrypted<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> decipher<span class=\"token punctuation\">.</span><span class=\"token function\">final</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> bytes<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">error while decrypting given input </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>error<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<p>note: in real life we want to utilize refresh tokens and do some fancy stuff, but in my case it is expected to have short lived session cookies - aka it will last only whily you are using the app, and once you close the browser - you are done, next time - new login</p>\n<p>So the final setup is:</p>\n<p><strong>static.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">log</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span> DEBUG\n<span class=\"token key atrule\">accessLog</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">format</span><span class=\"token punctuation\">:</span> common\n<span class=\"token key atrule\">providers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">filename</span><span class=\"token punctuation\">:</span> /etc/traefik/dynamic.yml\n<span class=\"token key atrule\">entryPoints</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">asDefault</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p><strong>dynamic.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">forwardAuth</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//auth<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>\n        <span class=\"token key atrule\">authResponseHeaders</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>User<span class=\"token punctuation\">-</span>Id\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>User<span class=\"token punctuation\">-</span>Name\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>User<span class=\"token punctuation\">-</span>Picture\n  <span class=\"token key atrule\">routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> Path(`/`) <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> Path(`/callback`)\n      <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> echo\n      <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> auth\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">loadBalancer</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">servers</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//echo<span class=\"token punctuation\">:</span>80/</code></pre></div>\n<p><strong>echo</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>echo ealen/echo-server</code></pre></div>\n<p><strong>auth</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>auth <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/google.js:/app/google.js\"</span> <span class=\"token parameter variable\">-w</span> /app node:23-alpine <span class=\"token function\">node</span> google.js</code></pre></div>\n<p><strong>traefik</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>traefik <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>echo <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>auth <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/static.yml:/etc/traefik/static.yml\"</span> <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/dynamic.yml:/etc/traefik/dynamic.yml\"</span> traefik:v3 <span class=\"token parameter variable\">--configfile</span><span class=\"token operator\">=</span>/etc/traefik/static.yml</code></pre></div>\n<h2>OAuth2-proxy Traefik forwardAuth</h2>\n<p>Having all that in place, should allow us to not reinwent the wheel and configure something existant, for example <a href=\"https://oauth2-proxy.github.io/oauth2-proxy/\">oauth2-proxy</a></p>\n<p>Technically it does exactly the same we were writting before</p>\n<p>Here is small refresher - <a href=\"https://mac-blog.org.ua/kubernetes-oauth2-proxy/\">OAuth2 Proxy in Kubernetes</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>auth <span class=\"token parameter variable\">-p</span> <span class=\"token number\">4180</span>:4180 quay.io/oauth2-proxy/oauth2-proxy <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--provider</span><span class=\"token operator\">=</span>google <span class=\"token punctuation\">\\</span>\n  --client-id<span class=\"token operator\">=</span><span class=\"token number\">869226817339</span>-c14i5aj3mq1rkht381u9c15lujm5810b.apps.googleusercontent.com <span class=\"token punctuation\">\\</span>\n  --client-secret<span class=\"token operator\">=</span>GOCSPX-xxxxxx <span class=\"token punctuation\">\\</span>\n  --cookie-secret<span class=\"token operator\">=</span>wsFX9kYoi00jYjA5m_tv6hzZvwk8OvHmtW9pCiQkpXA<span class=\"token operator\">=</span> <span class=\"token punctuation\">\\</span>\n  --email-domain<span class=\"token operator\">=</span>* <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--upstream</span><span class=\"token operator\">=</span>file:///dev/null <span class=\"token punctuation\">\\</span>\n  --redirect-url<span class=\"token operator\">=</span>http://localhost:4180/oauth2/callback <span class=\"token punctuation\">\\</span>\n  --http-address<span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0:4180 <span class=\"token punctuation\">\\</span>\n  --cookie-secure<span class=\"token operator\">=</span>false</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>to create cookie seecret use snippets from <a href=\"https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview#generating-a-cookie-secret\">docs</a> - under the hood 32 random bytes</li>\n<li>while in localhost - we disabling secure flag for cookies</li>\n<li>you should be able to open <code class=\"language-text\">http://localhost:4180</code> and login via Google</li>\n<li>after login, you will be landed on 404 page not found - which is fine for now</li>\n</ul>\n<p>There is an documentation and examples of how to integrate Traefik with OAuth2 <a href=\"https://oauth2-proxy.github.io/oauth2-proxy/configuration/integration#configuring-for-use-with-the-traefik-v2-forwardauth-middleware\">here</a></p>\n<p>After reading docs many times I have ended up with following setup:</p>\n<p><strong>echo</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>echo ealen/echo-server</code></pre></div>\n<p><strong>auth</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>auth quay.io/oauth2-proxy/oauth2-proxy <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--provider</span><span class=\"token operator\">=</span>google <span class=\"token punctuation\">\\</span>\n  --client-id<span class=\"token operator\">=</span><span class=\"token number\">869226817339</span>-c14i5aj3mq1rkht381u9c15lujm5810b.apps.googleusercontent.com <span class=\"token punctuation\">\\</span>\n  --client-secret<span class=\"token operator\">=</span>GOCSPX-xxxxxx <span class=\"token punctuation\">\\</span>\n  --cookie-secret<span class=\"token operator\">=</span>wsFX9kYoi00jYjA5m_tv6hzZvwk8OvHmtW9pCiQkpXA<span class=\"token operator\">=</span> <span class=\"token punctuation\">\\</span>\n  --email-domain<span class=\"token operator\">=</span>* <span class=\"token punctuation\">\\</span>\n  --http-address<span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0:4180 <span class=\"token punctuation\">\\</span>\n  --cookie-secure<span class=\"token operator\">=</span>false <span class=\"token punctuation\">\\</span>\n  --cookie-name<span class=\"token operator\">=</span>auth <span class=\"token punctuation\">\\</span>\n  --set-xauthrequest<span class=\"token operator\">=</span>true</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li><code class=\"language-text\">--cookie-secure=false</code> - for now, while playing without https</li>\n<li><code class=\"language-text\">--cookie-name=auth</code> - just to control and see it</li>\n<li><code class=\"language-text\">--skip-jwt-bearer-tokens=true</code> - for api requests, should allow authorization bearer headers</li>\n<li><code class=\"language-text\">--set-xauthrequest=true</code> - will pass <code class=\"language-text\">X-Auth-Request-User</code> and <code class=\"language-text\">X-Auth-Request-Email</code> headers to response</li>\n<li><code class=\"language-text\">--skip-provider-button=true</code> - nice to have but does not work as expected</li>\n</ul>\n<p><strong>static.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">log</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span> DEBUG\n<span class=\"token key atrule\">accessLog</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">format</span><span class=\"token punctuation\">:</span> common\n<span class=\"token key atrule\">providers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">filename</span><span class=\"token punctuation\">:</span> /etc/traefik/dynamic.yml\n<span class=\"token key atrule\">entryPoints</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">asDefault</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p><strong>dynamic.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">forwardAuth</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//auth<span class=\"token punctuation\">:</span>4180/oauth2/auth\n        <span class=\"token key atrule\">authResponseHeaders</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>Auth<span class=\"token punctuation\">-</span>Request<span class=\"token punctuation\">-</span>User\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>Auth<span class=\"token punctuation\">-</span>Request<span class=\"token punctuation\">-</span>Email\n          <span class=\"token punctuation\">-</span> X<span class=\"token punctuation\">-</span>Forwarded<span class=\"token punctuation\">-</span>User\n    <span class=\"token key atrule\">errors</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">errors</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">status</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token string\">'401-403'</span>\n        <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> auth\n        <span class=\"token key atrule\">query</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'/oauth2/sign_in?rd={url}'</span>\n  <span class=\"token key atrule\">routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> PathPrefix(`/`)\n      <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> echo\n      <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> errors\n        <span class=\"token punctuation\">-</span> auth\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> PathPrefix(`/oauth2/`)\n      <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> auth\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">loadBalancer</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">servers</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//echo<span class=\"token punctuation\">:</span>80/\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">loadBalancer</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">servers</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//auth<span class=\"token punctuation\">:</span>4180/</code></pre></div>\n<p><strong>traefik</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>traefik <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>echo <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>auth <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/static.yml:/etc/traefik/static.yml\"</span> <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/dynamic.yml:/etc/traefik/dynamic.yml\"</span> traefik:v3 <span class=\"token parameter variable\">--configfile</span><span class=\"token operator\">=</span>/etc/traefik/static.yml</code></pre></div>\n<p>With this setup you will get kind of similar behaviour to what we have written</p>\n<p>But there is even more</p>\n<p>Only after all this, have discovered Traefik plugins</p>\n<p>So the plugins in Traefik are kind of JavaScript for browsers, Go code is being injected and interpretated</p>\n<p>There is already one created <a href=\"https://plugins.traefik.io/plugins/65d5360746079255c9ffd1e2/google-oidc-auth\">Google OIDC Auth</a></p>\n<p>And indeed setup is as easy as:</p>\n<p><strong>echo</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>echo ealen/echo-server</code></pre></div>\n<p><strong>auth</strong></p>\n<p>not needed</p>\n<p><strong>static.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">log</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span> DEBUG\n<span class=\"token key atrule\">accessLog</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">format</span><span class=\"token punctuation\">:</span> common\n<span class=\"token key atrule\">providers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">filename</span><span class=\"token punctuation\">:</span> /etc/traefik/dynamic.yml\n<span class=\"token key atrule\">entryPoints</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">address</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">asDefault</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">experimental</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">google-oidc-auth-middleware</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">moduleName</span><span class=\"token punctuation\">:</span> github.com/andrewkroh/google<span class=\"token punctuation\">-</span>oidc<span class=\"token punctuation\">-</span>auth<span class=\"token punctuation\">-</span>middleware\n      <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v0.1.0</code></pre></div>\n<p><strong>dynamic.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">plugin</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">google-oidc-auth-middleware</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">authorized</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">emails</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> marchenko.alexandr@gmail.com\n          <span class=\"token key atrule\">cookie</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">secret</span><span class=\"token punctuation\">:</span> wsFX9kYoi00jYjA5m_tv6hzZvwk8OvHmtW9pCiQkpXA=\n            <span class=\"token key atrule\">insecure</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n          <span class=\"token key atrule\">oidc</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">clientID</span><span class=\"token punctuation\">:</span> 869226817339<span class=\"token punctuation\">-</span>c14i5aj3mq1rkht381u9c15lujm5810b.apps.googleusercontent.com\n            <span class=\"token key atrule\">clientSecret</span><span class=\"token punctuation\">:</span> GOCSPX<span class=\"token punctuation\">-</span>xxxxxx\n  <span class=\"token key atrule\">routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">rule</span><span class=\"token punctuation\">:</span> PathPrefix(`/`)\n      <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> echo\n      <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> auth\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">echo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">loadBalancer</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">servers</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//echo<span class=\"token punctuation\">:</span>80/</code></pre></div>\n<p><strong>traefik</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>traefik <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>echo <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/static.yml:/etc/traefik/static.yml\"</span> <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/dynamic.yml:/etc/traefik/dynamic.yml\"</span> traefik:v3 <span class=\"token parameter variable\">--configfile</span><span class=\"token operator\">=</span>/etc/traefik/static.yml</code></pre></div>\n<p>And here is one more:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">experimental</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">traefikoidc</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">moduleName</span><span class=\"token punctuation\">:</span> github.com/lukaszraczylo/traefikoidc\n      <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v0.5.34</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">middlewares</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">plugin</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">traefikoidc</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">sessionEncryptionKey</span><span class=\"token punctuation\">:</span> e7a4fdbd<span class=\"token punctuation\">-</span>baa7<span class=\"token punctuation\">-</span>4bf3<span class=\"token punctuation\">-</span>8ae6<span class=\"token punctuation\">-</span>f4734f0471fd\n          <span class=\"token key atrule\">providerURL</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//accounts.google.com\n          <span class=\"token key atrule\">clientID</span><span class=\"token punctuation\">:</span> 869226817339<span class=\"token punctuation\">-</span>c14i5aj3mq1rkht381u9c15lujm5810b.apps.googleusercontent.com\n          <span class=\"token key atrule\">clientSecret</span><span class=\"token punctuation\">:</span> GOCSPX<span class=\"token punctuation\">-</span>xxxxxx\n          <span class=\"token key atrule\">callbackURL</span><span class=\"token punctuation\">:</span> /oauth2/callback\n          <span class=\"token key atrule\">forceHTTPS</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></code></pre></div>"}},"pageContext":{"id":"1815ad8a-86b3-5c35-9633-6c80dab57988"}},"staticQueryHashes":[],"slicesMap":{}}