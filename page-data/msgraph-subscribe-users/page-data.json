{"componentChunkName":"component---src-templates-note-js","path":"/msgraph-subscribe-users/","result":{"data":{"remark":{"fields":{"path":"msgraph-subscribe-users"},"meta":{"title":""},"headings":[{"value":"Subscribe to Azure Active Directory changes"}],"html":"<h1>Subscribe to Azure Active Directory changes</h1>\n<p>Use case: in our case GitHub has Teams plan, not enterprise one, which means we need manage users on our own, especially when someone leaves, so far we are requiring users to have corporate public email and checkinf if this account is enabled or not, and if not kick it off from github, but how can we react to Active Directory changes instead of having scheduled job</p>\n<p>There is an concept of subscriptions in msgraph</p>\n<p><a href=\"https://learn.microsoft.com/en-us/graph/api/subscription-post-subscriptions?view=graph-rest-1.0&#x26;tabs=http\">https://learn.microsoft.com/en-us/graph/api/subscription-post-subscriptions?view=graph-rest-1.0&#x26;tabs=http</a></p>\n<p>Prerequisites: we need an access token</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">token</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>az account get-access-token <span class=\"token parameter variable\">--query</span><span class=\"token operator\">=</span>accessToken <span class=\"token parameter variable\">--output</span><span class=\"token operator\">=</span>tsv --resource-type ms-graph<span class=\"token variable\">)</span></span></code></pre></div>\n<p>Creating an subscription</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">\"https://graph.microsoft.com/v1.0/subscriptions\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$token</span>\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'{\n    \"changeType\": \"created,updated,deleted\",\n    \"notificationUrl\": \"https://40c8-178-150-44-191.ngrok-free.app\",\n    \"resource\": \"/users\",\n    \"expirationDateTime\":\"2023-08-20T17:37:51.0000000Z\",\n    \"clientState\": \"optional, mac was here\"\n}'</span> <span class=\"token operator\">|</span> jq</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"@odata.context\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/$metadata#subscriptions/$entity\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6b8d8da9-a1d7-4f1b-a333-6563521acc00\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"applicationId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"04b07795-8ddb-461a-bbee-02f9e1bf7b46\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"changeType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"created,updated,deleted\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"clientState\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"notificationUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://40c8-178-150-44-191.ngrok-free.app\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"notificationQueryOptions\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"lifecycleNotificationUrl\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"expirationDateTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2023-08-20T17:37:51Z\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"creatorId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"57434352-42b0-4090-9d36-9561ae89c607\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"includeResourceData\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"latestSupportedTlsVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"v1_2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"encryptionCertificate\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"encryptionCertificateId\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"notificationUrlAppId\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li><code class=\"language-text\">clientState</code> is an optional string, the good thing is that it will be passed everywhere, so can be used to identify subscription</li>\n<li><code class=\"language-text\">expirationDateTime</code> is not only required but has limitations, so do not expect it to be valid for years</li>\n<li>to create subscription your listerener should be able to answer to initial request (see below)</li>\n<li>notifications are arriving in ~1min, not immediatelly</li>\n</ul>\n<p>List subscirptions:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/subscriptions\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$token</span>\"</span> <span class=\"token operator\">|</span> jq <span class=\"token string\">\".value\"</span></code></pre></div>\n<p>Delete subscription:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> DELETE <span class=\"token string\">\"https://graph.microsoft.com/v1.0/subscriptions/6b8d8da9-a1d7-4f1b-a333-6563521acc00\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$token</span>\"</span></code></pre></div>\n<p>Here is an simples possible listener:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">urlencoded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">extended</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>validationToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// required for subscription creation</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>validationToken<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">dir</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">depth</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">colors</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>From what I have checked notifications are received with some delay, not immediatelly, also the payload is always the same with only change type changing between created, updated and deleted</p>\n<p>Also you should note that deleting user from portal - will trigger update notification, and if you go to deleted users in portal and permanently delete it from there - only then you will receive deleted notification</p>\n<p>Here is an example of payload</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"changeType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"updated\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"clientState\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"optional, mac was here\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Users/e6421e53...\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"resourceData\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"@odata.type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#Microsoft.Graph.User\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"@odata.id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Users/e6421e53...\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"e6421e53...\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"organizationId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"695e64b5...\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"subscriptionExpirationDateTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2023-08-20T10:37:51-07:00\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"subscriptionId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7b573f64-f3d7-4daf-9dd3-f35aa06d186e\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"tenantId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"695e64b5...\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Whenever we receive an notification we may want to receive user details, we can do it like so</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users/e6421e53...\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$token</span>\"</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"@odata.context\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/$metadata#users/$entity\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"businessPhones\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mactemp\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"givenName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mac\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"jobTitle\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"mail\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"mobilePhone\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"officeLocation\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"preferredLanguage\"</span><span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"surname\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"temp\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"userPrincipalName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mactemp@mac-blog.org.ua\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"e6421e53...\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And to see what other fields we have you may want to look at <a href=\"https://graph.microsoft.com/v1.0/$metadata#users/$entity\">@odata.context</a></p>\n<p>Here is and example:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users/57434352?\\<span class=\"token variable\">$select</span>=displayName,mail,lastPasswordChangeDateTime,accountEnabled,signInActivity,usageLocation\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$token</span>\"</span> <span class=\"token operator\">|</span> jq</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"@odata.context\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/$metadata#users(displayName,mail,lastPasswordChangeDateTime,accountEnabled,signInActivity,usageLocation)/$entity\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Alexandr Marchenko\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"mail\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AlexandrM@mac-blog.org.ua\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"lastPasswordChangeDateTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2023-05-25T13:05:25Z\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"accountEnabled\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"usageLocation\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"UA\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"57434352\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"signInActivity\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"lastSignInDateTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2023-08-19T16:09:19Z\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"lastNonInteractiveSignInDateTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2023-08-20T02:33:04Z\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can guess this data may be used for many other things, also do not forget that you can store additional data for user, that also may be used</p>"}},"pageContext":{"id":"8ff50277-664f-530d-ac71-e80fb37cba4f"}},"staticQueryHashes":[],"slicesMap":{}}