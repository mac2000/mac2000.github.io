{"componentChunkName":"component---src-templates-note-js","path":"/microk8s-upgrade-downgrade/","result":{"data":{"remark":{"fields":{"path":"microk8s-upgrade-downgrade"},"meta":{"title":""},"headings":[{"value":"MicroK8S upgrade/downgrade"}],"html":"<h1>MicroK8S upgrade/downgrade</h1>\n<p>While we had and issue with network, also decided to upgrade the cluster, here what was done</p>\n<h2>Обновление ноды mks3</h2>\n<p>On <strong>mks1</strong> run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">microk8s kubectl drain mks3 --ignore-daemonsets --delete-local-data</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>this command marks node as unavailable and move everything from it to other nodes</li>\n<li>took ~ 5min</li>\n<li>after completion, there should be no pods on mks3, check it by running <code class=\"language-text\">microk8s kubectl get po -A -o wide</code></li>\n</ul>\n<p>On <strong>mks3</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> snap refresh microk8s <span class=\"token parameter variable\">--channel</span><span class=\"token operator\">=</span><span class=\"token number\">1.19</span>/stable</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li><strong>it is note recommended to jump upgrade skipping versions</strong></li>\n<li>while upgrading, services will be restarted</li>\n<li>after completion <code class=\"language-text\">microk8s.kubectl get no</code> should show new version</li>\n</ul>\n<p>On <strong>mks1</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">microk8s kubectl uncordon mks3</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>command \"unfreezes\" note</li>\n<li>after it, deployments will start to move back to mks3</li>\n</ul>\n<p>Next, do the same on mks2 and mks1</p>\n<p>On mks1 got an issue Can't connect to HTTPS URL because the SSL module is not available. Found few articles in internet, especially <a href=\"https://github.com/ubuntu/microk8s/pull/672/files\">this</a>. So did update, skipping all versions.</p>\n<p>After that did update mks2 and mks3 to actual at the time 1.21 version.</p>\n<p>Original <a href=\"https://microk8s.io/docs/upgrading\">docs</a>.</p>\n<h2>Downgrade</h2>\n<p>Because in prod we had 1.18 and locally 1.21 cronjobs become broken, so were forced to rollback</p>\n<p>On <strong>mks1</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">microk8s kubectl drain mks3 --ignore-daemonsets --delete-local-data</code></pre></div>\n<p>On <strong>mks3</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> snap refresh microk8s <span class=\"token parameter variable\">--channel</span><span class=\"token operator\">=</span><span class=\"token number\">1.18</span>/stable</code></pre></div>\n<p>On <strong>mks1</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">microk8s kubectl uncordon mks3</code></pre></div>\n<p>At the end <code class=\"language-text\">microk8s kubectl get nodes</code> should upgrade and show nodes with desired verion</p>\n<p>Did that in such order: mks3, mks2, mks1</p>\n<p>Also, restart of all deployments were need</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl <span class=\"token parameter variable\">-n</span> dev rollout restart deployment\nkubectl <span class=\"token parameter variable\">-n</span> dev get po <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> Running</code></pre></div>"}},"pageContext":{"id":"730d230e-a394-5bc0-bb2f-f526a1eeb2d1"}},"staticQueryHashes":[],"slicesMap":{}}