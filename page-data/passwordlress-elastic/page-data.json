{"componentChunkName":"component---src-templates-note-js","path":"/passwordlress-elastic/","result":{"data":{"remark":{"fields":{"path":"passwordlress-elastic"},"meta":{"title":""},"headings":[{"value":"Passwordless ElasticSearch"},{"value":"How it works?"}],"html":"<h1>Passwordless ElasticSearch</h1>\n<p>Заметки вокруг <a href=\"http://cloud.elastic.co\">cloud.elastic.co</a></p>\n<h1>How it works?</h1>\n<p>За для удобства, рассматриваем эластик как rest api сервис, как если бы это было, не знаю, наше sms-api</p>\n<p>Так вот, это самое api, по умолчанию закрыто за basic auth</p>\n<p>Если бы это был dotnet то это было бы что то типа (псевдокод):</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">builder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AddBasic</span><span class=\"token punctuation\">(</span>options <span class=\"token operator\">=></span> <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>И как следствие запросы к нему мы пуляем вот так:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-u</span> elastic:Secr3tW0rd <span class=\"token parameter variable\">-X</span> POST https://elastic.com/vacancies/_search</code></pre></div>\n<p>По мимо этого у эластика есть еще ряд других опций, а именно:</p>\n<ul>\n<li>api-key - авторизация через ключик, который формируется, ротируется и отзывается эластиком</li>\n<li>saml - это как soap только про авторизацию</li>\n<li>jwt - это то что мы будем рассматривать в этой заметке</li>\n<li>oidc - это полноценная махина вокруг openid connect которая прикручена к kibana'е за для авторизации</li>\n<li>и другие</li>\n</ul>\n<p>В портале эластика, если провалиться к конретно взятому инстансу и кликнуть редактировать и провалиться в его свойства, можно добраться до конфигурационного yaml (стоит думать про это, как про appsettings.json)</p>\n<p>Выглядит вот так:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74eb4ae5528df5d7ccecb27ac96801e2/6871f/image-20240926-103040.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.421875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABMUlEQVR42n2Ra2+CMBiF+cPbEoHSCxiXRfYnTYhzxgu3IRERxLPTzu3jmpz0bZs+7zmtF4QSoVCIkznnCIJS2kCbGOah93SJbV6jaHs0TYNxHKkbhmH8q6/XAdM0wZv5ApE0DqiUhogkhDIEJYjj5AFMkW222B1K1HWNsvpCWVZOVcVGRelqC/X8QNARL/JyJCOEoSDEYLFYOCVslBK43e2QFxe07YD/hmfjmnj+cEh3IiA0ZM19rSHZJF0u8bnZuHgFofv9meArbreJsW3ciWcT1/cfh79AoyW08mFUgFgHXIfQ0sfba4z1eo37/cZoPbLshOOxY/weXTc6nU4DzucRnv0AC7SRk8TGVpB8y5kfUD6enl9csyzL6GAk6IKPj5ZOe+T5BatVg8Ohc09hHX4DaqV4miCwASoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20240926-103040.png\"\n        title=\"\"\n        src=\"/static/74eb4ae5528df5d7ccecb27ac96801e2/2bef9/image-20240926-103040.png\"\n        srcset=\"/static/74eb4ae5528df5d7ccecb27ac96801e2/6f3f2/image-20240926-103040.png 256w,\n/static/74eb4ae5528df5d7ccecb27ac96801e2/01e7c/image-20240926-103040.png 512w,\n/static/74eb4ae5528df5d7ccecb27ac96801e2/2bef9/image-20240926-103040.png 1024w,\n/static/74eb4ae5528df5d7ccecb27ac96801e2/71c1d/image-20240926-103040.png 1536w,\n/static/74eb4ae5528df5d7ccecb27ac96801e2/a878e/image-20240926-103040.png 2048w,\n/static/74eb4ae5528df5d7ccecb27ac96801e2/6871f/image-20240926-103040.png 2688w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>На практике, это означает, что если бы это был dotnet то мы бы сделали что то типа:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">builder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">AddBasic</span><span class=\"token punctuation\">(</span><span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// это штатная авторизация elastic:Secr3tW0rd</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">AddJwt</span><span class=\"token punctuation\">(</span><span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>   <span class=\"token comment\">// мы будем крутить эту штуку</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">AddOpenIdConnect</span><span class=\"token punctuation\">(</span><span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// это для кибаны</span></code></pre></div>\n<p>Все это дело, подключено и настроено в репо терраформа, пример для dev эластика можно посмотреть <a href=\"https://github.com/rabotaua/terraform/blob/main/elastic/dev.tf#L110-L147\">тут</a></p>\n<p>За для интеграции с Azure, прямо там, мы создаем и настраиваем Azure App Registration, конфигурируем доступы и вот это все и следом, пробрасываем все эти client_id и прочую разность в эластик</p>\n<blockquote>\n<p>Примечание: внесение изменений в эту штуку требует рестарта эластика, в проде норм, в тестовых окружениях, где у нас всего по одной штучке может быть downtime, но учитывая кол-во раз которые и одно и второе рубеталось на прошедшей неделе и там и там норм</p>\n</blockquote>\n<h2>How it works: JWT?</h2>\n<p>Итого, со стороны нашего rest api настроена JWT авторизация, а это значит, что, при наличии валидного JWT токена, мы должны мочь сходить в эластик и он должен нас пропустить</p>\n<p>Далее пример как это проверить (предпологается что установлен <a href=\"https://learn.microsoft.com/en-us/cli/azure/install-azure-cli\">az cli</a> и выполнен <code class=\"language-text\">az login</code>)</p>\n<p>Первым делом, проверяем что мы можем получить токен:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">az account get-access-token <span class=\"token parameter variable\">--resource</span><span class=\"token operator\">=</span>api://elastic-dev <span class=\"token parameter variable\">--query</span> accessToken <span class=\"token parameter variable\">-o</span> tsv</code></pre></div>\n<blockquote>\n<p>Примечание: под капотом дергаются oidc и проче, за для сохранения целосности мозга, мы пока в эти дебри не залазим и пользуем az cli</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a314a4e9d9d3e7204ca8c86f3e1072cc/a5120/image-20240926-103952.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSUlEQVR42mWR61LCMBCFef9X03H8oQ5CJSgW8FILpba57nE3G4Y6wJzZJrP59pxkRvUPaH8AfRxZXPctaNdqbToQEbz36E4dLNfR2bxOlFTpv2a4fQFuK+DegO7WrFfQjVE9bcHEfBC9BZoTMDjwBhCi1slPhs/i4oCwOCKYE9w6wlYEZwh2leDrlBsTN6IdgE0DWu5Bb9+QZGj7a6BdASObtKzxmTUH3EbX7l0bQwj47XtEjkRXogwS5cjO8GFOLGBrCsjot98qMMYIZ10+IIAUC+T8nwLHSiFZawVn4OoClMZ45PVOFRoewmkTX2mSOk4ijwuOuSwuq4tLiS9gNpAfJXa85gG+5q2k+0hFNAEOj8Wd3OU5eqXfri5AqMPYIoMTPzSFibz2qcO5AoYHhrBbGSDu8pCzQ44sDySPFT6LvlS+rCki3+cffAC7vu0DZNQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20240926-103952.png\"\n        title=\"\"\n        src=\"/static/a314a4e9d9d3e7204ca8c86f3e1072cc/2bef9/image-20240926-103952.png\"\n        srcset=\"/static/a314a4e9d9d3e7204ca8c86f3e1072cc/6f3f2/image-20240926-103952.png 256w,\n/static/a314a4e9d9d3e7204ca8c86f3e1072cc/01e7c/image-20240926-103952.png 512w,\n/static/a314a4e9d9d3e7204ca8c86f3e1072cc/2bef9/image-20240926-103952.png 1024w,\n/static/a314a4e9d9d3e7204ca8c86f3e1072cc/71c1d/image-20240926-103952.png 1536w,\n/static/a314a4e9d9d3e7204ca8c86f3e1072cc/a878e/image-20240926-103952.png 2048w,\n/static/a314a4e9d9d3e7204ca8c86f3e1072cc/a5120/image-20240926-103952.png 2380w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>В токене важными будут:</p>\n<ul>\n<li><code class=\"language-text\">aud</code> - для кого выписывали</li>\n<li><code class=\"language-text\">iss</code> - кто выписывал</li>\n<li><code class=\"language-text\">sub</code> - пользователь</li>\n</ul>\n<p>Со стороны эластика у нас прописаны соотв настройки, опять же, для простоты, на примере дотнета это было бы вот так:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">builder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthentication</span><span class=\"token punctuation\">(</span>JwtBearerDefaults<span class=\"token punctuation\">.</span>AuthenticationScheme<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddJwtBearer</span><span class=\"token punctuation\">(</span>options <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        options<span class=\"token punctuation\">.</span>Authority <span class=\"token operator\">=</span> <span class=\"token string\">\"https://sts.windows.net/695e64b5-2d13-4ea8-bb11-a6fda2d60c41\"</span><span class=\"token punctuation\">;</span>\n        options<span class=\"token punctuation\">.</span>Audience <span class=\"token operator\">=</span> <span class=\"token string\">\"api://elastic-dev\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>по сути эта настройка перепроверяет первых два поля и за счет issuer'а и jwks проверяет подпись</p>\n<p>Имея такой токен, должно быть возможным выполнить следующее:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">token</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>az account get-access-token <span class=\"token parameter variable\">--resource</span><span class=\"token operator\">=</span>api://elastic-dev <span class=\"token parameter variable\">--query</span> accessToken <span class=\"token parameter variable\">-o</span> tsv<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"token: <span class=\"token variable\">$token</span>\"</span>\n<span class=\"token function\">curl</span> <span class=\"token string\">\"https://dev-b68b60.es.europe-west3.gcp.cloud.es.io\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$token</span>\"</span></code></pre></div>\n<p>И оно должно будет нас пропустить и вернуть нам ответ</p>\n<h2>How to: dotnet?</h2>\n<p>Со стороны дотнета у нас уже есть <a href=\"https://github.com/rabotaua/terraform/blob/main/docs/cloud_elastic.md#dotnet\">заготовка</a> которую делали под будущие эластики для сервисов</p>\n<p>Если совсем кратко, выглядеть оно будет вот так:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Azure<span class=\"token punctuation\">.</span>Core</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Azure<span class=\"token punctuation\">.</span>Identity</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Elastic<span class=\"token punctuation\">.</span>Clients<span class=\"token punctuation\">.</span>Elasticsearch</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Elastic<span class=\"token punctuation\">.</span>Transport</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// dotnet add package Elastic.Clients.Elasticsearch</span>\n<span class=\"token comment\">// dotnet add package Azure.Identity</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> WebApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddSingleton</span><span class=\"token punctuation\">(</span>_ <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DefaultAzureCredential</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddSingleton</span><span class=\"token punctuation\">(</span>provider <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ElasticsearchClient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dev:ZXVyb3BlLXdlc3QzLmdjcC5jbG91ZC5lcy5pbzo0NDMkY2IwM2Q1ZDkzMGU5NDFmMWI0MzFjY2I2NjU0MjkwMWMkNjhhOGMxNDFjNmExNDk2NWEyMTI2YWUxOTM1MzkwMGU=\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">OAuthAuthorizationHeader</span><span class=\"token punctuation\">(</span>provider<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetRequiredService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>DefaultAzureCredential<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/demo\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ElasticsearchClient</span> elasticsearchClient<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CancellationToken</span> cancellationToken<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// await elasticsearchClient.SearchAsync(...)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token string\">\"TODO\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuthAuthorizationHeader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DefaultAzureCredential</span> defaultAzureCredential<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> AuthorizationHeader\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">TryGetAuthorizationParameters</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">out</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> accessToken <span class=\"token operator\">=</span> defaultAzureCredential<span class=\"token punctuation\">.</span><span class=\"token function\">GetToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">TokenRequestContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"api://elastic-dev/.default\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">value</span> <span class=\"token operator\">=</span> accessToken<span class=\"token punctuation\">.</span>Token<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsNullOrWhiteSpace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> AuthScheme <span class=\"token operator\">=></span> <span class=\"token string\">\"Bearer\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Аргумент cloudId в конструкторе принимает киллометровую строку из портала эластка</p>\n<h2>How to: terraform?</h2>\n<p>Перед тем как это деплоить понадобиться ряд дополнительных приседаний, в частности нам нужна свервисная учетка, от имени которой мы будем подключаться (читай то же самое как мы делаем для azure storage и sql)</p>\n<p>Соотв, если таковой еще нет, в репо терраформа, в соотв папке заводим файлик, аля:</p>\n<p><strong>project.mactemp.tf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">resource &quot;azurerm_resource_group&quot; &quot;mactemp&quot; {\n  name     = &quot;mactemp-rg-${var.suffix}&quot;\n  location = var.location\n  tags = {\n    &quot;owner&quot;      = &quot;alexandrm@rabota.ua&quot;\n    &quot;repository&quot; = &quot;https://github.com/rabotaua/terraform&quot;\n  }\n}\n\nresource &quot;azurerm_user_assigned_identity&quot; &quot;mactemp&quot; {\n  name                = &quot;mactemp-${var.user_assigned_identity_prefix}&quot;\n  location            = azurerm_resource_group.mactemp.location\n  resource_group_name = azurerm_resource_group.mactemp.name\n  tags = {\n    &quot;owner&quot;      = &quot;alexandrm@rabota.ua&quot;\n    &quot;repository&quot; = &quot;https://github.com/rabotaua/terraform&quot;\n  }\n}\n\nresource &quot;azurerm_federated_identity_credential&quot; &quot;mactemp&quot; {\n  name                = &quot;mactemp&quot;\n  resource_group_name = azurerm_resource_group.mactemp.name\n  issuer              = azurerm_kubernetes_cluster.kube.oidc_issuer_url\n  parent_id           = azurerm_user_assigned_identity.mactemp.id\n  audience            = [&quot;api://AzureADTokenExchange&quot;]\n  subject             = &quot;system:serviceaccount:${var.namespace}:mactemp&quot;\n}\n\ndata &quot;azuread_service_principal&quot; &quot;elastic-dev&quot; {\n  display_name = &quot;elastic-dev&quot;\n}\n\nresource &quot;azuread_app_role_assignment&quot; &quot;elastic-dev-mactemp&quot; {\n  app_role_id         = &quot;00000000-0000-0000-0000-000000000000&quot;\n  resource_object_id  = data.azuread_service_principal.elastic-dev.object_id\n  principal_object_id = azurerm_user_assigned_identity.mactemp.principal_id # &quot;639e25b3-2c13-4d8d-94cf-0eff86dd5e46&quot; # Object (principal) ID: az ad sp list --display-name mactemp-app-mid-eun-dev --query &quot;[].{id:id}&quot; -o tsv\n}\n\nresource &quot;elasticstack_elasticsearch_security_role&quot; &quot;mactemp&quot; {\n  name = &quot;mactemp&quot;\n  indices {\n    names      = [&quot;mactemp&quot;]\n    privileges = [&quot;all&quot;]\n  }\n  indices {\n    names      = [&quot;vacancysearch&quot;]\n    privileges = [&quot;read&quot;]\n  }\n}\n\nresource &quot;elasticstack_elasticsearch_security_role_mapping&quot; &quot;mactemp&quot; {\n  name  = &quot;mactemp&quot;\n  roles = [&quot;mactemp&quot;]\n  rules = jsonencode({\n    all = [\n      { field = { &quot;realm.name&quot; = &quot;jwt2&quot; } },\n      { field = { &quot;username&quot; = azurerm_user_assigned_identity.mactemp.principal_id } } // &quot;639e25b3-2c13-4d8d-94cf-0eff86dd5e46&quot; } }\n    ]\n  })\n}\n\nresource &quot;kubernetes_service_account&quot; &quot;mactemp&quot; {\n  metadata {\n    name      = &quot;mactemp&quot;\n    namespace = var.namespace\n    labels = {\n      app                           = &quot;mactemp&quot;\n      &quot;azure.workload.identity/use&quot; = &quot;true&quot;\n    }\n    annotations = {\n      &quot;owner&quot;                             = &quot;alexandrm@rabota.ua&quot;\n      &quot;repository&quot;                        = &quot;https://github.com/rabotaua/terraform&quot;\n      &quot;azure.workload.identity/client-id&quot; = azurerm_user_assigned_identity.mactemp.client_id\n      &quot;azure.workload.identity/tenant-id&quot; = azurerm_user_assigned_identity.mactemp.tenant_id\n    }\n  }\n}</code></pre></div>\n<p>Если присмотреться то в файле этом ничего особого нет и тем кто уже создавал такие штуки никаких вопросов не вызовет</p>\n<p>Кроме двух новых ресурсов:</p>\n<ul>\n<li><code class=\"language-text\">elasticstack_elasticsearch_security_role</code> - имя роли и список индексов к которым эта роль имеет доступ</li>\n<li><code class=\"language-text\">elasticstack_elasticsearch_security_role_mapping</code> - маппим нашу учетку на эту роль</li>\n</ul>\n<p>в обоих ресурсах настройки говорят сами за себя и особых вопросов вызывать не должны</p>\n<p>пожалуй кроме вопроса - нафига?!</p>\n<p>ответ простой - нам все равно нужно повозиться с этими сервисными учетками что бы все заработало, т.к. мы не можем сделать одну общую на все все сервисы - бо тогда получается они все будут иметь доступ всюду, условно в ту же ats sql, что явно не ок</p>\n<p>а раз нам все равно нужно делать это и учитывая то что в эластике свалка индексов ничейных было бы не плохо сразу разграничить все это дело, дабы навести трохи порядка, обезоапаситься от случайных удалений или доступов куда не надо, чему не надо</p>\n<p>в остальном - так надо было сделать вообще с самого начала, и вероятно так бы и сделали, эсли бы с этого начала существовало как класс</p>"}},"pageContext":{"id":"16fb8260-938b-5883-8ecf-b50babaf5ab9"}},"staticQueryHashes":[],"slicesMap":{}}