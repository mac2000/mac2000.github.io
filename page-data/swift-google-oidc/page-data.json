{"componentChunkName":"component---src-templates-note-js","path":"/swift-google-oidc/","result":{"data":{"remark":{"fields":{"path":"swift-google-oidc"},"meta":{"title":""},"headings":[{"value":"SwiftUI Google OpenID Connect"}],"html":"<h1>SwiftUI Google OpenID Connect</h1>\n<p>I want to build small iOS app that will talk to Google API, so I need \"Signin with Google\" feature and oh my gosh it was so frustrating from beginning to end...</p>\n<p>Majority of links everywhere talking about Firebase which is not something I want to bring, little bit less info is about official documented library here <a href=\"https://developers.google.com/identity/sign-in/ios/start-integrating\">\nGoogle Sign-In for iOS and macOS</a></p>\n<p>But it is not clear to me how it works, why changed user did not trigger view rerender, why profile is optional and so on and so on</p>\n<p>Wish to save a note of how we can have google authentication without any third party libraries at all</p>\n<p><video width=\"405\" height=\"813\" controls><source src=\"GoogleSignin.mp4\" type=\"video/mp4\"></video></p>\n<h2>How does it work</h2>\n<p>Before touching any Swift we need to understand few building blocks</p>\n<p>After registering an app in Google we have our client id and so called ios url scheme - this one is so funy</p>\n<p>Technically whenever we want to login user our job is to create an authorization link and open browser pointing to that link</p>\n<p>User will authorize, and callback will be called - this callback will be not something like <code class=\"language-text\">http://localhost/?foo=bar</code> but <code class=\"language-text\">our_custom_ios_scheme_url:/callback?foo=bar</code></p>\n<p>Our app job is to register itself in system as a handler for such urls, so it will catch it, exchange tockens and draw successfull screen</p>\n<h2>Authorize endpoint</h2>\n<p>Authentication url formation is done like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">## prerequisites</span>\n<span class=\"token comment\"># random string, aka our secret we will use to verify later, look for \"code_challange\" note</span>\n<span class=\"token assign-left variable\">secret</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>openssl rand <span class=\"token parameter variable\">-base64</span> <span class=\"token number\">32</span> <span class=\"token operator\">|</span> <span class=\"token function\">tr</span> <span class=\"token parameter variable\">-dc</span> <span class=\"token string\">'a-zA-Z0-9'</span> <span class=\"token operator\">|</span> <span class=\"token function\">head</span> <span class=\"token parameter variable\">-c</span> <span class=\"token number\">43</span><span class=\"token variable\">)</span></span>\n<span class=\"token comment\"># base64url(sha256(code_verifier))</span>\n<span class=\"token assign-left variable\">hash</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$secret</span>\"</span> <span class=\"token operator\">|</span> openssl sha256 <span class=\"token parameter variable\">-binary</span> <span class=\"token operator\">|</span> openssl base64 <span class=\"token operator\">|</span> <span class=\"token function\">tr</span> <span class=\"token string\">'+/'</span> <span class=\"token string\">'-_'</span> <span class=\"token operator\">|</span> <span class=\"token function\">tr</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'='</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token assign-left variable\">response_type</span><span class=\"token operator\">=</span><span class=\"token string\">'code'</span>\n<span class=\"token assign-left variable\">client_id</span><span class=\"token operator\">=</span><span class=\"token string\">'98400000000-700000000000000000000000000000va4.apps.googleusercontent.com'</span>\n<span class=\"token comment\"># note: redirect_uri is not usual url, it's a custom url scheme provided by Google, and its scheme MUST be exactly like that, part after `:/` can be anything, url will be handled by our app</span>\n<span class=\"token assign-left variable\">redirect_uri</span><span class=\"token operator\">=</span><span class=\"token string\">'com.googleusercontent.apps.98400000000-700000000000000000000000000000va4:/callback'</span>\n<span class=\"token assign-left variable\">scope</span><span class=\"token operator\">=</span><span class=\"token string\">'openid profile email'</span>\n<span class=\"token comment\"># note: can be used to pass data between stages</span>\n<span class=\"token assign-left variable\">state</span><span class=\"token operator\">=</span><span class=\"token string\">'HELLO'</span>\n<span class=\"token comment\"># note: this one is like csrf token but inversed, on client side we are creating secret and hashing it with SHA256 to check later when callback will be called</span>\n<span class=\"token assign-left variable\">code_challenge</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$hash</span>\"</span>\n<span class=\"token assign-left variable\">code_challenge_method</span><span class=\"token operator\">=</span><span class=\"token string\">'S256'</span>\n\n<span class=\"token comment\"># open browser with autorization url, after logging in, user will be redirected to our app with code, state and the secret</span>\n<span class=\"token function\">open</span> <span class=\"token string\">\"https://accounts.google.com/o/oauth2/v2/auth?response_type=<span class=\"token variable\">$response_type</span>&amp;client_id=<span class=\"token variable\">$client_id</span>&amp;redirect_uri=<span class=\"token variable\">$redirect_uri</span>&amp;scope=<span class=\"token variable\">$scope</span>&amp;state=<span class=\"token variable\">$state</span>&amp;code_challenge=<span class=\"token variable\">$code_challenge</span>&amp;code_challenge_method=<span class=\"token variable\">$code_challenge_method</span>\"</span></code></pre></div>\n<p>This link can be opened in browser but after login you will receive an message that Safari can not handle given link (that's because of this custom scheme)</p>\n<p>Inside iOS everything will be fine</p>\n<h2>PCKE</h2>\n<p>But before there is one more catch with PCKE, here is pretty cool <a href=\"https://www.oauth.com/playground/authorization-code-with-pkce.html\">playground</a> to generate code challange, make sure your results are comparable</p>\n<p>Here is working example for nodejs:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// https://www.oauth.com/playground/authorization-code-with-pkce.html</span>\n<span class=\"token keyword\">const</span> code_verifier <span class=\"token operator\">=</span> <span class=\"token string\">'M9amGcIBsnKiJTiBEfN3YPf8aegQ8qQL2w97fh0PtzYrfKoa'</span>\n<span class=\"token comment\">// base64url(sha256(code_verifier))</span>\n<span class=\"token keyword\">const</span> expected_code_challenge <span class=\"token operator\">=</span> <span class=\"token string\">'25_Rx2lQGJHR1UCD1Rvx_eYnyBF-Zm2g3s3oI6fzL60'</span>\n\n<span class=\"token keyword\">const</span> code_challenge <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha256'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>code_verifier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'base64url'</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>code_challenge <span class=\"token operator\">==</span> expected_code_challenge<span class=\"token punctuation\">)</span></code></pre></div>\n<p>and here is how you can have base64url encoded sha256 in Swift:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">UIKit</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">CryptoKit</span>\n\n<span class=\"token comment\">// https://www.oauth.com/playground/authorization-code-with-pkce.html</span>\n\n<span class=\"token comment\">// Define the expected code challenge</span>\n<span class=\"token keyword\">let</span> expected <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"25_Rx2lQGJHR1UCD1Rvx_eYnyBF-Zm2g3s3oI6fzL60\"</span></span>\n\n<span class=\"token comment\">// Define the code verifier</span>\n<span class=\"token keyword\">let</span> codeVerifier <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"M9amGcIBsnKiJTiBEfN3YPf8aegQ8qQL2w97fh0PtzYrfKoa\"</span></span>\n\n<span class=\"token keyword\">let</span> codeChallenge <span class=\"token operator\">=</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">(</span>SHA256<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">(</span>codeVerifier<span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">base64EncodedString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">replacingOccurrences</span><span class=\"token punctuation\">(</span>of<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"+\"</span></span><span class=\"token punctuation\">,</span> with<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"-\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">replacingOccurrences</span><span class=\"token punctuation\">(</span>of<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"/\"</span></span><span class=\"token punctuation\">,</span> with<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"_\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">trimmingCharacters</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"=\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>codeChallenge <span class=\"token operator\">==</span> expected<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>iOS URL scheme</h2>\n<p>With this in place inside our empty app we may add an button that will open browser, aka:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">SwiftUI</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">CryptoKit</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> url<span class=\"token punctuation\">:</span> <span class=\"token constant\">URL</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> codeVerifier <span class=\"token operator\">=</span> <span class=\"token function\">UUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>uuidString\n        <span class=\"token keyword\">let</span> codeChallenge <span class=\"token operator\">=</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">(</span>SHA256<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">(</span>codeVerifier<span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">base64EncodedString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">replacingOccurrences</span><span class=\"token punctuation\">(</span>of<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"+\"</span></span><span class=\"token punctuation\">,</span> with<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"-\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">replacingOccurrences</span><span class=\"token punctuation\">(</span>of<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"/\"</span></span><span class=\"token punctuation\">,</span> with<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"_\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">trimmingCharacters</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"=\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">var</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"https://accounts.google.com/o/oauth2/v2/auth\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n        url<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>queryItems<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"response_type\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"code\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"client_id\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"98400000000-700000000000000000000000000000va4.apps.googleusercontent.com\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"redirect_uri\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"com.googleusercontent.apps.98400000000-700000000000000000000000000000va4:/callback\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"scope\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"openid profile email https://www.googleapis.com/auth/drive.readonly\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"state\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> codeVerifier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"code_challenge\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> codeChallenge<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"code_challenge_method\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"S256\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> url\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">VStack</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span>systemName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"globe\"</span></span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">imageScale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>large<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">foregroundStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>tint<span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Hello, world!\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Link</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Login\"</span></span><span class=\"token punctuation\">,</span> destination<span class=\"token punctuation\">:</span> url<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">padding</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">GoogleDemoApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<p>It wont work out of the box - reason is the same - this custom schemas</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 942px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d58a20dc8adb9ee9fe3b00701a15025b/f1901/demo1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 187.10937500000003%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAlCAYAAABCr8kFAAAACXBIWXMAABYlAAAWJQFJUiTwAAAGRUlEQVR42qVWbUyTVxSuIKK4hPhnUQeRZUaNP5iJCkiWoMQ/M4w/CgVhfNSIgE6n2VxmMo2ZowJtodDvlo8WsH6ALv7x55ZFN6fFrwQXFbWTQj8oQkGgwPu+Z+fcvq1FMZrsTZ6e23vvee4555577pVIQt8iEf/nC+mfkkhiSG7ZskWWkZ5+JT09rTMtLc2+c+fOCOj/1q1bmczIyGDIzMy0b9u2rQvbv5Iu4zp1KkaSl5cXi+3FmRmZV47lfgn79mVxX+RnQ1lRKeyv2A9SqRSys7MhKysLcnJyIDc3F3bt2sX6cTGO/qenp19GjljGJRIuX7du3cnU1NTrKSmf/rZq1arbycnJvUlJSb0rV64k6aA24s7q1avv4TjhbkpKyh+bNm36a+3ateioJIFZKH4fLVu27BOUh9D8vgJpgWv37t0utMK1d+9eJgmFhYWD+fn5Q3v27BkqKCgYwrn/oM5h1E0ijvnBlEg+l+bnef3DXnja/0QIjI3ByMgIbN++HTZs2ADr169nbb/fD/S5XC7B6XRC8dfFHtRNjeYKE5acPF0Dj50e7vc/e3nHg8d8772HfE1NDX/8+HEGuVzO9/X18f39/bzD4eDdbjcnP1sLqFscTRhDcUTnv5EWFoFGbxbqlGogKFRqsFgsYLVaGdrb20Gn04FWq2Voa2sTioqKifCQuBcshjGbN2+OQ/mtrLwcznV1CiajASxmE4PRaASDwcgkwWQyMRgMBujq6hLKUQd1j1RUVMRFCDElFsfExPxAg52dnbxSqQS1Wg0NDQ1MEhobG6GpqQlUKhX2NzJps9kWJGR5iDulkMlk6GILX1tbiwoNjIRICUqlChQKJdBiREZzWlpaFrZwzZo1S1H+WFZWRrESKD5kVXNzM7NKo9GwNi1AksapjywkHQqXGLaQhfQHLayn1TAuvBHjQ8GnOC2EUFwNFJ4w4eGIheLuxCckJKjJ5db2Tk6l1kGzVg9NGh1CH0Gz1hBpqxo10G7t4MkIjP+JaAuZy7GxcT/LZOWgN1v50/IGOFvfAL/UNoC8ThVCrTIk61VsrOasAiytNp6MiI+Pr5tHiFiSkLBUReafs1/k9UYLGC02MLZ2gamlA0yWdjC3WMHcagtJhKWtA85f7OFJBwkVeJ7jIy7Tn7DLrkEv9+jxM3j+fACePnUi/mV48sQJjx49g/5+J2sTXC4PszAuLu41YdQu/0SDTqeLv3HjFvT23ocHDx7CzZsOePFiCDxuPwwMeMDtHobBQR/4fSPgH37Jl5ayTTmBubw0Qrhx48YlKI+VlpbC+PiUEAwKMDXFQTDIw/Q0DzMzAszOCjA3BzAzCzCHbXcAwDsyJZSXlRLhUfR0yZtH71hJSQncvn1HcDjukgSS4XY0HIjrf9+Hm7fuCqRDeTgvscOEZCGmhnD6jBzOyOtwZ+vwdNRDff1rKBShPiVKPOsC6dBJmbfLYULaMVtHh6DBpNZj8upZIoeKAu28zmARpRkM2EfFQUzsIwtaSINYooTwcYtGs0aL0LFkJ0lHMOrovZvQarWxs2zQ6xn0EdBR1DMYERqt5sMIO9BlItDqDKDRGSJ1kFzX6w1onZ5Bi0fTZuv4MEJWlZGMEC4IRKZDaLT6EDAE7yUUC6xAm2HGqmwWq3M0wv20wDsrdnQe0j1BmxKqedrI/REN8oA2hTYwnIfz0qaiIkRYXV0NV69eFdBKWh3sdjtcunQJuru7obunG3ou97D2hYsXwH7eDteuXRMOHjz4toUYdPpz1Ggy0pUrDPuH8bjNgG/YB0PuoRAGB/EsD4DX68GxIIzhvU1zadeJUOSYT2jA244mjQZGYTo4DS/HRsE/4gcfXu4erw98Pi/4X45CEA90IBAiJCPI5YUID2m0OprEj08EYOLVBLyanARubgY8AcT4LAj8DPT7guAZfQUTOMfHAa9u1hFhdTThIrFSfIXvlckgukor0w/HY8VB96iPQK5yPB8axDlTwSDgW2cSdXPEihV5Yy7BqvsZonHHjh2ByqpK7kDlAa5cVs6hAlcglTJQG68JrhLHqqqqOJw7hjoq0iWON1+fieKjpwjxHV2r78H34txUUfetFzD5vxy/j1esWJGcmJiYQsDV5yHcT3NoLumEY/e+9/KH4K3vP8gcUtKXksSnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"demo1\"\n        title=\"\"\n        src=\"/static/d58a20dc8adb9ee9fe3b00701a15025b/f1901/demo1.png\"\n        srcset=\"/static/d58a20dc8adb9ee9fe3b00701a15025b/6f3f2/demo1.png 256w,\n/static/d58a20dc8adb9ee9fe3b00701a15025b/01e7c/demo1.png 512w,\n/static/d58a20dc8adb9ee9fe3b00701a15025b/f1901/demo1.png 942w\"\n        sizes=\"(max-width: 942px) 100vw, 942px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>To fix that add it to your app info like so:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ad178c1616600940aea58a439fcc6ecb/3f99a/demo2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.765625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACDklEQVR42o1Sy27iMBRlPb9B/6BfwI5FF5QN32L1x9h1JKRBpa2gvCompCGQByGJnYSQB3Fy59pVKcxUo1o6cXxtH5977q09399fzWaPdwtVIePxmCwWc7JQFDLXHeLQgOgbnaiqSnRdJ7ZjE9M2iYJnBXR9QzxKCQ0osbbW3XQ6var97D+3FW0Nm826Mk0TXJ9CUQHsywo4fHtU4rNcLtu1Xw8Pt8PRCzw9PhWKonDDtHmW5chV8bLk+J9x27Z5EDCepBmP05wf4pjvEb7v8yiK+PF4LAShpmm3tX6/31a1Fczm80p7ewPT3sLO9SHLc/l0WZZgGAZYlgWMMcA35F6aphAEARwOB0DCT4W9Xq9tWSas1+tqtVqB42whikJIkuREiP5h3JGXxVqQif3dbidJ8zy/JDQMU1yqUDJ4nvduSoUeoho8LGOUUsD0ZRwVyTimLFX/o1AU429CMYQioWK/30uir1FeFuV/hHEcSxUiPZGqIPhQL9alyKL8JuHH5TTNwMBCFUUhUWI75dhXUZyCqlugGTuIkrOUB4NB23VdwNaQfRiG4QWhUBGGkfSzeldzKpZ4QJw68jOF3W73Zjgcxtjl9GU0Yq+/l8zzKfM9j2EFGRaDeZ7LsN9Oa7RBzugtQ1tYcjhQFBJPJpOb2vX19Y9Go1H/RLPe6nTqrVZLotlsSnQw1jmLfwXB9QdBXzpEpfj7ZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"demo2\"\n        title=\"\"\n        src=\"/static/ad178c1616600940aea58a439fcc6ecb/2bef9/demo2.png\"\n        srcset=\"/static/ad178c1616600940aea58a439fcc6ecb/6f3f2/demo2.png 256w,\n/static/ad178c1616600940aea58a439fcc6ecb/01e7c/demo2.png 512w,\n/static/ad178c1616600940aea58a439fcc6ecb/2bef9/demo2.png 1024w,\n/static/ad178c1616600940aea58a439fcc6ecb/71c1d/demo2.png 1536w,\n/static/ad178c1616600940aea58a439fcc6ecb/a878e/demo2.png 2048w,\n/static/ad178c1616600940aea58a439fcc6ecb/3f99a/demo2.png 2840w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now, at least error message is gone, but still nothing works, we need to add url handler to our app like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">GoogleDemoApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">// added url handler</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">onOpenURL</span><span class=\"token punctuation\">(</span>perform<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> url <span class=\"token keyword\">in</span>\n                    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"OPEN:\"</span></span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And finally we get our callback working, url will be something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">com.googleusercontent.apps.98400000000-700000000000000000000000000000va4:/callback?state=C05ABF67&amp;code=xxxxx&amp;scope=email%20profile&amp;authuser=0&amp;prompt=consent</code></pre></div>\n<p>So it is our job now to extract <code class=\"language-text\">code</code> from it as well as <code class=\"language-text\">state</code> (note: technically it is a bad idea and we do not need to pass code verifier via state which makes it silly, but I left it as is so it is repeatable)</p>\n<h2>Token endpoint</h2>\n<p>Now, when we have code we gonna send an post request like this one:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">code</span><span class=\"token operator\">=</span><span class=\"token string\">'...'</span> <span class=\"token comment\"># code we have extracted from callback url</span>\n<span class=\"token assign-left variable\">code_verifier</span><span class=\"token operator\">=</span><span class=\"token string\">'...'</span> <span class=\"token comment\"># code verifier we have created when we generate auth link</span>\n<span class=\"token assign-left variable\">client_id</span><span class=\"token operator\">=</span><span class=\"token string\">'98400000000-700000000000000000000000000000va4.apps.googleusercontent.com'</span>\n<span class=\"token assign-left variable\">redirect_uri</span><span class=\"token operator\">=</span><span class=\"token string\">'com.googleusercontent.apps.98400000000-700000000000000000000000000000va4:/callback'</span>\n<span class=\"token assign-left variable\">grant_type</span><span class=\"token operator\">=</span><span class=\"token string\">'authorization_code'</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST https://oauth2.googleapis.com/token <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'Content-Type: application/x-www-form-urlencoded'</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"code=<span class=\"token variable\">$code</span>&amp;code_verifier=<span class=\"token variable\">$code_verifier</span>&amp;client_id=<span class=\"token variable\">$client_id</span>&amp;redirect_uri=<span class=\"token variable\">$redirect_uri</span>&amp;grant_type=<span class=\"token variable\">$grant_type</span>\"</span></code></pre></div>\n<p>and in response we will receive <code class=\"language-text\">access_token</code> that we may use to talk to Google API</p>\n<p>also there is an <code class=\"language-text\">refresh_token</code> that we should store somewhere in local storage (user default) to persist authentication beween app restarts</p>\n<h2>Refresh endpoint</h2>\n<p>Refresh endpoin is even easier and can be called like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">grant_type</span><span class=\"token operator\">=</span><span class=\"token string\">'refresh_token'</span>\n<span class=\"token assign-left variable\">refresh_token</span><span class=\"token operator\">=</span><span class=\"token string\">'...'</span> <span class=\"token comment\"># refresh token we have saved</span>\n<span class=\"token assign-left variable\">code_verifier</span><span class=\"token operator\">=</span><span class=\"token string\">'...'</span> <span class=\"token comment\"># code verifier we have created when we generate auth link</span>\n<span class=\"token assign-left variable\">client_id</span><span class=\"token operator\">=</span><span class=\"token string\">'98400000000-700000000000000000000000000000va4.apps.googleusercontent.com'</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST https://oauth2.googleapis.com/token <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'Content-Type: application/x-www-form-urlencoded'</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"grant_type=<span class=\"token variable\">$grant_type</span>&amp;refresh_token=<span class=\"token variable\">$refresh_token</span>&amp;code_verifier=<span class=\"token variable\">$code_verifier</span>\"</span></code></pre></div>\n<p>Refresh endpoint will give you new access token, refresh token itself stays untouched</p>\n<h2>Google Sheets API</h2>\n<p>As an example I am using Sheets API which is pretty simple and straight forward</p>\n<p>aka here is how we can retrieve some cell values:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">access_token</span><span class=\"token operator\">=</span><span class=\"token string\">'...'</span> <span class=\"token comment\"># our access token we have retrieved initially or after refresh</span>\n<span class=\"token assign-left variable\">spreadsheet_id</span><span class=\"token operator\">=</span><span class=\"token string\">'...'</span> <span class=\"token comment\"># id of your spreadheet (take it from url)</span>\n<span class=\"token assign-left variable\">sheet_name</span><span class=\"token operator\">=</span><span class=\"token string\">'Sheet1'</span>\n<span class=\"token assign-left variable\">range</span><span class=\"token operator\">=</span><span class=\"token string\">'A2'</span>\n<span class=\"token function\">curl</span> <span class=\"token string\">\"https://sheets.googleapis.com/v4/spreadsheets/<span class=\"token variable\">$spreadsheet_id</span>/values/<span class=\"token variable\">$sheet_name</span>!<span class=\"token variable\">$range</span>\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span></code></pre></div>\n<h2>Recap</h2>\n<p>Here is a full code of what I have ended up with</p>\n<p><div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">SwiftUI</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">CryptoKit</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">SafariServices</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">AnonymousView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@State</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> isVisible <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">VStack</span><span class=\"token punctuation\">(</span>spacing<span class=\"token punctuation\">:</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span>systemName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"lock\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">imageScale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>large<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">foregroundStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>tint<span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Anonymous\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">// Link(\"Login\", destination: url) // will open real safari</span>\n            <span class=\"token class-name\">Button</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Login\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> isVisible<span class=\"token punctuation\">.</span><span class=\"token function\">toggle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">popover</span><span class=\"token punctuation\">(</span>isPresented<span class=\"token punctuation\">:</span> $isVisible<span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">SafariWebView</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> url<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> url<span class=\"token punctuation\">:</span> <span class=\"token constant\">URL</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> codeVerifier <span class=\"token operator\">=</span> <span class=\"token function\">UUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>uuidString\n        <span class=\"token keyword\">let</span> codeChallenge <span class=\"token operator\">=</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">(</span>SHA256<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Data</span><span class=\"token punctuation\">(</span>codeVerifier<span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">base64EncodedString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">replacingOccurrences</span><span class=\"token punctuation\">(</span>of<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"+\"</span></span><span class=\"token punctuation\">,</span> with<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"-\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">replacingOccurrences</span><span class=\"token punctuation\">(</span>of<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"/\"</span></span><span class=\"token punctuation\">,</span> with<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"_\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">trimmingCharacters</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">in</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"=\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">var</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"https://accounts.google.com/o/oauth2/v2/auth\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n        url<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>queryItems<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"response_type\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"code\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"client_id\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"98400000000-700000000000000000000000000000va4.apps.googleusercontent.com\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"redirect_uri\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"com.googleusercontent.apps.98400000000-700000000000000000000000000000va4:/callback\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"scope\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"openid profile email https://www.googleapis.com/auth/drive.readonly\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"state\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> codeVerifier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"code_challenge\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> codeChallenge<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"code_challenge_method\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"S256\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> url\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">AuthenticatedView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@AppStorage</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"access_token\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> accessToken<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@AppStorage</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"refresh_token\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> refreshToken<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@State</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> message <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"Authenticated\"</span></span>\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">VStack</span><span class=\"token punctuation\">(</span>spacing<span class=\"token punctuation\">:</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span>systemName<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"lock.open\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">imageScale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>large<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">foregroundStyle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>tint<span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Button</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Demo\"</span></span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">:</span> demo<span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Button</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Refresh\"</span></span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">:</span> renew<span class=\"token punctuation\">)</span>\n            <span class=\"token class-name\">Button</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Logout\"</span></span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">:</span> logout<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">logout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        accessToken <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n        refreshToken <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">demo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> url <span class=\"token operator\">=</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"https://www.googleapis.com/drive/v3/files\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n        url<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>queryItems<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"q\"</span></span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">:</span><span class=\"token string-literal\"><span class=\"token string\">\"mimeType='application/vnd.google-apps.spreadsheet'\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">var</span> request <span class=\"token operator\">=</span> <span class=\"token class-name\">URLRequest</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> url<span class=\"token punctuation\">)</span>\n        request<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Bearer </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">accessToken<span class=\"token operator\">!</span></span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> forHTTPHeaderField<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Authorization\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token class-name\">URLSession</span><span class=\"token punctuation\">.</span>shared<span class=\"token punctuation\">.</span><span class=\"token function\">dataTask</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> error <span class=\"token operator\">=</span> error <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Error: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">error</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> data <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"No data received\"</span></span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token class-name\">JSONSerialization</span><span class=\"token punctuation\">.</span><span class=\"token function\">jsonObject</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> files <span class=\"token operator\">=</span> json<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"files\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">Any</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Got </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">files<span class=\"token punctuation\">.</span>count</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\"> files\"</span></span><span class=\"token punctuation\">)</span>\n                        message <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"Got </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">files<span class=\"token punctuation\">.</span>count</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\"> files\"</span></span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>localizedDescription<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">renew</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> parameters <span class=\"token operator\">=</span> <span class=\"token class-name\">URLComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        parameters<span class=\"token punctuation\">.</span>queryItems <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"grant_type\"</span></span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"refresh_token\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"refresh_token\"</span></span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> refreshToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"client_id\"</span></span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"98400000000-700000000000000000000000000000va4.apps.googleusercontent.com\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">var</span> request <span class=\"token operator\">=</span> <span class=\"token class-name\">URLRequest</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"https://oauth2.googleapis.com/token\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n        request<span class=\"token punctuation\">.</span>httpMethod <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"POST\"</span></span>\n        request<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"application/x-www-form-urlencoded\"</span></span><span class=\"token punctuation\">,</span> forHTTPHeaderField<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Content-Type\"</span></span><span class=\"token punctuation\">)</span>\n        request<span class=\"token punctuation\">.</span>httpBody <span class=\"token operator\">=</span> parameters<span class=\"token punctuation\">.</span>query<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>using<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span>\n\n        <span class=\"token class-name\">URLSession</span><span class=\"token punctuation\">.</span>shared<span class=\"token punctuation\">.</span><span class=\"token function\">dataTask</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> data<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> error <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> error <span class=\"token operator\">=</span> error <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Error: </span><span class=\"token interpolation-punctuation punctuation\">\\(</span><span class=\"token interpolation\">error</span><span class=\"token interpolation-punctuation punctuation\">)</span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> data <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"No data received\"</span></span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token class-name\">JSONSerialization</span><span class=\"token punctuation\">.</span><span class=\"token function\">jsonObject</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> accessToken <span class=\"token operator\">=</span> json<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"access_token\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>accessToken <span class=\"token operator\">=</span> accessToken\n                        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"refreshed\"</span></span><span class=\"token punctuation\">)</span>\n                        message <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"Refreshed\"</span></span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"token missing in json\"</span></span><span class=\"token punctuation\">)</span>\n                        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>accessToken <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n                        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>refreshToken <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>localizedDescription<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@AppStorage</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"access_token\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> accessToken<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@AppStorage</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"refresh_token\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> refreshToken<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">View</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> accessToken <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token operator\">&amp;&amp;</span> refreshToken <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">AuthenticatedView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">AnonymousView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute atrule\">@main</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">GoogleOpenIdConnectApp</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">App</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute atrule\">@AppStorage</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"access_token\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> accessToken<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n    <span class=\"token attribute atrule\">@AppStorage</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"refresh_token\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">var</span> refreshToken<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token operator\">?</span>\n\n    <span class=\"token keyword\">var</span> body<span class=\"token punctuation\">:</span> <span class=\"token keyword\">some</span> <span class=\"token class-name\">Scene</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">WindowGroup</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">ContentView</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">onOpenURL</span><span class=\"token punctuation\">(</span>perform<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> url <span class=\"token keyword\">in</span>\n                    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token class-name\">URLComponents</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> url<span class=\"token punctuation\">,</span> resolvingAgainstBaseURL<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">}</span>\n                    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> codeVerifier <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>queryItems<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">where</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">==</span> <span class=\"token string-literal\"><span class=\"token string\">\"state\"</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>value <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">}</span>\n                    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> code <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span>queryItems<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">where</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">==</span> <span class=\"token string-literal\"><span class=\"token string\">\"code\"</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>value <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">}</span>\n                    <span class=\"token comment\">// guard let scope = url.queryItems?.first(where: { $0.name == \"scope\" })?.value else { return }</span>\n\n                    <span class=\"token keyword\">var</span> requestBodyComponents <span class=\"token operator\">=</span> <span class=\"token class-name\">URLComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    requestBodyComponents<span class=\"token punctuation\">.</span>queryItems <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                        <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"code\"</span></span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"code_verifier\"</span></span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> codeVerifier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"client_id\"</span></span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"98400000000-700000000000000000000000000000va4.apps.googleusercontent.com\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"redirect_uri\"</span></span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"com.googleusercontent.apps.98400000000-700000000000000000000000000000va4:/callback\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token class-name\">URLQueryItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"grant_type\"</span></span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"authorization_code\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">]</span>\n\n                    <span class=\"token keyword\">var</span> request <span class=\"token operator\">=</span> <span class=\"token class-name\">URLRequest</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"https://oauth2.googleapis.com/token\"</span></span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">)</span>\n                    request<span class=\"token punctuation\">.</span>httpMethod <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"POST\"</span></span>\n                    request<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"application/x-www-form-urlencoded\"</span></span><span class=\"token punctuation\">,</span> forHTTPHeaderField<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Content-Type\"</span></span><span class=\"token punctuation\">)</span>\n                    request<span class=\"token punctuation\">.</span>httpBody <span class=\"token operator\">=</span> requestBodyComponents<span class=\"token punctuation\">.</span>query<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>using<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span>\n\n                    <span class=\"token class-name\">Task</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> <span class=\"token class-name\">URLSession</span><span class=\"token punctuation\">.</span>shared<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">)</span>\n                        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> json <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token class-name\">JSONSerialization</span><span class=\"token punctuation\">.</span><span class=\"token function\">jsonObject</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n                                <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> accessToken <span class=\"token operator\">=</span> json<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"access_token\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> refreshToken <span class=\"token operator\">=</span> json<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">\"refresh_token\"</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n                                    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>accessToken <span class=\"token operator\">=</span> accessToken\n                                    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>refreshToken <span class=\"token operator\">=</span> refreshToken\n                                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                                    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"tokens missing in json\"</span></span><span class=\"token punctuation\">)</span>\n                                    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>accessToken <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n                                    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>refreshToken <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n                                <span class=\"token punctuation\">}</span>\n                            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                                <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"invlid json\"</span></span><span class=\"token punctuation\">)</span>\n                                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>accessToken <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n                                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>refreshToken <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n                            <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>localizedDescription<span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">SafariWebView</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIViewControllerRepresentable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> url<span class=\"token punctuation\">:</span> <span class=\"token constant\">URL</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">makeUIViewController</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">SFSafariViewController</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">SFSafariViewController</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> url<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">updateUIViewController</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> uiViewController<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SFSafariViewController</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Context</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<p>The only thing changed is that we are using popover window with <code class=\"language-text\">SFSafariViewController</code> so our signin flow is more straight forward</p>"}},"pageContext":{"id":"17e23699-af7f-5f33-989e-ea1df666b49e"}},"staticQueryHashes":[],"slicesMap":{}}