{"componentChunkName":"component---src-templates-note-js","path":"/dba1/","result":{"data":{"remark":{"fields":{"path":"dba1"},"meta":{"title":""},"headings":[{"value":"Тема 01 «Установка и управление сервером»"},{"value":"Тема 02 «Использование psql»"},{"value":"Тема 03 «Конфигурирование»"},{"value":"Тема 04 «Общее устройство PostgreSQL»"},{"value":"Транзакции"},{"value":"Тема 05 «Изоляция и многоверсионность»"},{"value":"Тема 06 «Буферный кэш и журнал»"},{"value":"Тема 07 «Базы данных и схемы»"},{"value":"Тема 08 «Системный каталог»"},{"value":"Тема 09 «Табличные пространства»"},{"value":"Тема 10 «Низкий уровень»"},{"value":"Тема 11 «Мониторинг»"},{"value":"Тема 12 «Сопровождение»"},{"value":"Тема 13 «Роли и атрибуты»"},{"value":"Тема 14 «Привилегии»"},{"value":"Тема 15 «Политики защиты строк»"},{"value":"Тема 16 «Подключение и аутентификация»"},{"value":"Тема 17 «Резервное копирование»"},{"value":"Тема 18 «Репликация»"}],"html":"<h1><a href=\"https://www.youtube.com/watch?v=38Mz_ZLxSUU&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=2\">Тема 01 «Установка и управление сервером»</a></h1>\n<p>TLDR: Тут какая то жесть, ребята ставят все из исходников, в обычной ситуации это просто:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> postgresql postgresql-contrib <span class=\"token function\">sudo</span>\npg_ctlcluster <span class=\"token number\">12</span> main start\n<span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-u</span> postgres psql <span class=\"token parameter variable\">-c</span> <span class=\"token string\">'select 1'</span></code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>проверял в <code class=\"language-text\">docker run -it --rm ubuntu bash</code></li>\n<li>в <code class=\"language-text\">postgresql-contrib</code> всякие доп модули которые можно будет включать (аля uuid, crypto, etc)</li>\n</ul>\n<h2>Установка из исходников</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># dependencies</span>\n<span class=\"token function\">apt</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> build-essential libreadline-dev zlib1g-dev flex bison libxml2-dev libxslt-dev libssl-dev libxml2-utils xsltproc <span class=\"token function\">git</span> <span class=\"token function\">sudo</span>\n<span class=\"token comment\"># sources</span>\n<span class=\"token function\">git</span> clone git://git.postgresql.org/git/postgresql.git\n<span class=\"token builtin class-name\">cd</span> postgresql\n<span class=\"token comment\"># optional to cleanup previous run: make distclean</span>\n./configure\n<span class=\"token function\">make</span>\n<span class=\"token function\">make</span> <span class=\"token function\">install</span>\n<span class=\"token comment\"># postgres user</span>\nadduser postgres\n<span class=\"token comment\"># data folder</span>\n<span class=\"token function\">mkdir</span> /usr/local/pgsql/data\n<span class=\"token function\">chown</span> postgres /usr/local/pgsql/data\n<span class=\"token comment\"># switch to postgres user</span>\n<span class=\"token function\">su</span> - postgres\n<span class=\"token comment\"># initialize</span>\n/usr/local/pgsql/bin/initdb <span class=\"token parameter variable\">-D</span> /usr/local/pgsql/data\n<span class=\"token comment\"># start</span>\n/usr/local/pgsql/bin/pg_ctl <span class=\"token parameter variable\">-D</span> /usr/local/pgsql/data <span class=\"token parameter variable\">-l</span> logfile start\n<span class=\"token comment\"># create database</span>\n/usr/local/pgsql/bin/createdb <span class=\"token builtin class-name\">test</span>\n<span class=\"token comment\"># test</span>\n/usr/local/pgsql/bin/psql <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-c</span> <span class=\"token string\">'select 1'</span>\n<span class=\"token comment\"># stop (fast|smart|immediate)</span>\n/usr/local/pgsql/bin/pg_ctl <span class=\"token parameter variable\">-D</span> /usr/local/pgsql/data stop <span class=\"token parameter variable\">-m</span> fast</code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>опять же запускал из под докера</li>\n<li><a href=\"https://wiki.postgresql.org/wiki/Compile_and_Install_from_source_code\">зависимости</a></li>\n<li><a href=\"https://www.postgresql.org/docs/current/install-short.html\">документация</a></li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=1W6l8WupZiM&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=3\">Тема 02 «Использование psql»</a></h1>\n<h2>Подключение</h2>\n<ul>\n<li><code class=\"language-text\">psql -d база -U роль -h узел -p порт</code> - снаружи</li>\n<li><code class=\"language-text\">=> \\c[onnect] база роль узел порт</code> - изнутри</li>\n<li><code class=\"language-text\">=> \\conninfo</code> - информация о текущем подключении</li>\n</ul>\n<h2>Получение справки</h2>\n<ul>\n<li>\n<p><code class=\"language-text\">psql --help</code> опции запуска</p>\n</li>\n<li>\n<p>в самом psql</p>\n<ul>\n<li><code class=\"language-text\">=> \\?</code> - список доступных команд</li>\n<li><code class=\"language-text\">=> \\? variables</code> - список переменных psq</li>\n<li><code class=\"language-text\">=> \\h[elp]</code> - список команд SQL</li>\n<li><code class=\"language-text\">=> \\h команда</code> - синтаксис команды SQL, напр.: <code class=\"language-text\">\\h CREATE TABLE</code></li>\n<li><code class=\"language-text\">=> \\q</code> - выход из psql</li>\n</ul>\n</li>\n</ul>\n<h2>Файлы</h2>\n<ul>\n<li><code class=\"language-text\">psqlrc</code> - общий системный файл</li>\n<li><code class=\"language-text\">~/.psqlrc</code> - пользовательский файл</li>\n<li><code class=\"language-text\">~/.psql_history</code> - история команд</li>\n</ul>\n<h2>Формат вывода запросов</h2>\n<ul>\n<li><code class=\"language-text\">\\t</code> - вывод названия колонок и кол-ва строк</li>\n<li><code class=\"language-text\">\\a</code> - align</li>\n<li><code class=\"language-text\">\\x</code> - аля Format-List из PowerShell когда каждая строка будет выведена в виде отдельной pivot таблички</li>\n<li><code class=\"language-text\">\\timing</code> - вывод времени</li>\n<li><code class=\"language-text\">\\pset fieldsep ' '</code> - разделитель, например если выполнить <code class=\"language-text\">\\t</code>, <code class=\"language-text\">\\a</code>, <code class=\"language-text\">\\pset fieldsep ','</code> мы по сути получим csv</li>\n</ul>\n<h2>Вызов системных команд из psql</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">=> \\! pwd\n=> \\! uptime\n=> \\setenv TEST Hello\n=> \\! echo $TEST</code></pre></div>\n<h2>Перенаправление вывода</h2>\n<p>последняя команда выключит перенаправление</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">=> \\o test.txt\n=> select * from users;\n=> \\! cat test.txt\n=> \\o</code></pre></div>\n<h2>Запуск скрипта из файла</h2>\n<ul>\n<li><code class=\"language-text\">psql &lt; filename</code></li>\n<li><code class=\"language-text\">psql -f filename</code></li>\n<li><code class=\"language-text\">=> \\i filename</code></li>\n</ul>\n<h2>Переменные</h2>\n<ul>\n<li>\n<p>Базовые операции</p>\n<ul>\n<li><code class=\"language-text\">=> \\set TEST Hello</code></li>\n<li><code class=\"language-text\">=> \\echo :TEST</code></li>\n<li><code class=\"language-text\">=> \\unset TEST</code></li>\n<li><code class=\"language-text\">=> \\set</code> - выведет список всех переменных (аналог <code class=\"language-text\">env</code>)</li>\n</ul>\n</li>\n<li>\n<p>Использование в запросах</p>\n<ul>\n<li><code class=\"language-text\">select now() as curr_time \\gset</code> - примечание: запрос должен возвращать только одну запись</li>\n<li><code class=\"language-text\">=> \\echo :curr_time</code> - можем переиспользовать</li>\n</ul>\n</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=BY4UGcFn9GU&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=4\">Тема 03 «Конфигурирование»</a></h1>\n<h2>postgresql.conf</h2>\n<h3>Основной файл конфигурации</h3>\n<ul>\n<li>читается один раз при старте сервера</li>\n<li>если праметр указан несколько раз, применяется последнее значение</li>\n</ul>\n<h3>Расположение</h3>\n<ul>\n<li><code class=\"language-text\">SHOW config_file;</code></li>\n<li>при сборке по умолчанию - в каталоге с данными <code class=\"language-text\">PGDATA</code></li>\n</ul>\n<h3>Дайствия при изменении</h3>\n<p>Файл надо перечитать одним из способов:</p>\n<ul>\n<li><code class=\"language-text\">pg_ctl reload</code></li>\n<li><code class=\"language-text\">kill -HUP</code> - это нужно отрпавлять главному процессу</li>\n<li><code class=\"language-text\">select pg_reload_conf();</code></li>\n</ul>\n<p>Примечание: изменения некоторых из параметро требует перезапуск сервера</p>\n<h2>postgres.auto.conf</h2>\n<p>Файл конфигурации, <strong>управляемый SQL</strong></p>\n<ul>\n<li><code class=\"language-text\">ALTER SYSTEM SET параметр TO значение;</code> - добавляет или изменяет строку</li>\n<li><code class=\"language-text\">ALTER SYSTEM RESET параметр;</code> - удаляет строку</li>\n<li><code class=\"language-text\">ALTER SYSTEM RESET ALL;</code> - удаляет все строки</li>\n<li>Считывается <strong>после</strong> <code class=\"language-text\">postgresql.conf</code></li>\n<li>Распологается в каталоге с данными <code class=\"language-text\">PGDATA</code></li>\n<li>Даействия при изменении аналогичто postgresq.conf</li>\n</ul>\n<p>Текущие настройки</p>\n<ul>\n<li><code class=\"language-text\">pg_settings</code> - системная вьюха со всеми настройками</li>\n<li><code class=\"language-text\">pg_file_settings</code> - то что было вычитанно с файлов конфигураций</li>\n</ul>\n<p>Пример запроса к pg_file_settings:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> sourceline<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> setting<span class=\"token punctuation\">,</span> applied <span class=\"token keyword\">from</span> pg_file_settings <span class=\"token keyword\">where</span> sourcefile <span class=\"token operator\">like</span> <span class=\"token string\">'%postgresql.conf'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>Примечание: столбец applied говорит не о текущем статусе настройки, а о том может ли быть параметр изменен без перезагрузки сервера, посмтреть текущее (актуальное) значение можно вот так:</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span> setting<span class=\"token punctuation\">,</span> unit<span class=\"token punctuation\">,</span> boot_val<span class=\"token punctuation\">,</span> reset_val<span class=\"token punctuation\">,</span> source<span class=\"token punctuation\">,</span> sourcefile<span class=\"token punctuation\">,</span> sourceline<span class=\"token punctuation\">,</span> pending_restart<span class=\"token punctuation\">,</span> context <span class=\"token keyword\">from</span> pg_settings <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'work_mem'</span>\\gx</code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>\n<p><code class=\"language-text\">setting, unit</code> - применимо для настроек имеющих unit например объем памяти или время, для строк, unit остается пустым</p>\n</li>\n<li>\n<p><code class=\"language-text\">boot_val</code> - значение по умолчанию</p>\n</li>\n<li>\n<p><code class=\"language-text\">reset_val</code> - значение которое мы можем поменять, будет применино при вызове <code class=\"language-text\">ALTER SYSTEM RESET</code></p>\n</li>\n<li>\n<p><code class=\"language-text\">source, sourcefile, sourceline</code> - будут заполнены если конфигурация была вычитанна с файла, если <code class=\"language-text\">source - default</code> - то это значение по умолчанию</p>\n</li>\n<li>\n<p><code class=\"language-text\">pending_restart</code> - требуется ли перезапуск сервера для применения настройки</p>\n</li>\n<li>\n<p><code class=\"language-text\">context</code></p>\n<ul>\n<li><code class=\"language-text\">internal</code> - зменить нельзя, задано при установке</li>\n<li><code class=\"language-text\">postmaster</code> - требуется перезапус сервера</li>\n<li><code class=\"language-text\">sighup</code> - требуется перечитать файлы конфиграции</li>\n<li><code class=\"language-text\">superuser</code> - суперпользователь может изменить для своего сеанса</li>\n<li><code class=\"language-text\">user</code> - любой пользователь может на ходу менять значения этого параметра</li>\n</ul>\n</li>\n</ul>\n<p>Представление <code class=\"language-text\">pg_file_settings</code> прям на лету перечитывает файл:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\\! echo work_mem=12MB >> /usr/local/pgsql/data/postgresql.conf\n\\! echo work_mem=8MB >> /usr/local/pgsql/data/postgresql.conf\nselect sourceline, name, setting, applied from pg_file_settings where name = 'work_mem';\nselect pg_reload_conf();\nselect name, setting, unit, boot_val, reset_val, source, sourcefile, sourceline, pending_restart, context from pg_settings where name = 'work_mem'\\gx</code></pre></div>\n<p>В примере мы дописываем две опции, запрос, выведет обе, но у первой applied будет false.</p>\n<p>После применения, <code class=\"language-text\">boot_val</code> останеться 4мб, а вот <code class=\"language-text\">reset_val</code> уже станет 8мб, а так же обновиться source.</p>\n<p>Пример через <code class=\"language-text\">ALTER SYSTEM</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ALTER SYSTEM SET work_mem TO '16MB';\n\\! cat /usr/local/pgsql/data/postgresql.auto.conf\nSHOW work_mem;\nselect pg_reload_conf();\nSHOW work_mem;\nselect name, setting, unit, boot_val, reset_val, source, sourcefile, sourceline, pending_restart, context from pg_settings where name = 'work_mem'\\gx</code></pre></div>\n<p>Откат, у далением строки из файла:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ALTER SYSTEM RESET work_mem;\nselect pg_reload_conf();\nSHOW work_mem;</code></pre></div>\n<p>По скольку <code class=\"language-text\">work_mem</code> это пользовательская переменная можно устанавливать еще вот так:</p>\n<ul>\n<li><code class=\"language-text\">SET work_mem TO '24MB';</code></li>\n<li><code class=\"language-text\">SELECT set_config('work_mem', '32MB', false);</code> - примечание - последний параметр переключает настройку на весь сеанс или только для следующего запроса</li>\n</ul>\n<p>Посмотреть значение параметра:</p>\n<ul>\n<li><code class=\"language-text\">SHOW work_mem;</code></li>\n<li><code class=\"language-text\">SELECT current_setting('work_mem');</code></li>\n<li><code class=\"language-text\">SELECT name, setting, unit FROM pg_settings WHERE name = 'work_mem';</code></li>\n</ul>\n<h2>Пользовательские параметры</h2>\n<p>Этот же механизм может быть использован для пользовательских параметров используемых в приложении, например:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> current_setting<span class=\"token punctuation\">(</span><span class=\"token string\">'myapp.currency_code'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">IS</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">THEN</span>\n  set_config<span class=\"token punctuation\">(</span><span class=\"token string\">'myapp.currency_code'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'RUB'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">ELSE</span>\n  current_setting<span class=\"token punctuation\">(</span><span class=\"token string\">'myapp.currency_code'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>в название переменной обязательно должна быть точка, что бы postgres мог отличить их от системных</li>\n<li>такие переменные можно сложить прямо в <code class=\"language-text\">postgres.conf</code></li>\n<li><code class=\"language-text\">set_config</code> - не сохраняет на файл, настройка только в текущем сеансе</li>\n</ul>\n<h2>Практика</h2>\n<p>Получить список параметров (и их значений), для изменения которых требуется перезапуск сервера</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span> setting <span class=\"token keyword\">from</span> pg_settings <span class=\"token keyword\">where</span> context <span class=\"token operator\">=</span> <span class=\"token string\">'postmaster'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>В файле postgresql.conf устанвить значения для параметра listen_address в * и применить</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ALTER SYSTEM SET listen_addresses TO '*';\nselect pg_reload_conf();\nSHOW listen_addresses;\n\\q\n/usr/local/pgsql/bin/pg_ctl -D /usr/local/pgsql/data restart</code></pre></div>\n<h1><a href=\"https://www.youtube.com/watch?v=JUcwkizO--Y&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=5\">Тема 04 «Общее устройство PostgreSQL»</a></h1>\n<h1>Транзакции</h1>\n<ul>\n<li><strong>атомарность</strong> - все или ничего</li>\n<li><strong>согласованность</strong> - ограничения целостности и пользовательские ограничения</li>\n<li><strong>изоляция</strong> - влияние параллельных процессов</li>\n<li><strong>долговечность</strong> - сохранность данных дажепосле сбоя</li>\n</ul>\n<h2>Выполнение запроса</h2>\n<ul>\n<li><strong>разбор</strong> - синтаксический (нет ли очепяток) и семантический (существуют ли запрашиваемые таблички) анализ (последний использует системный каталог)</li>\n<li><strong>трансформация</strong> - правила, используются для трансформации полученного AST</li>\n<li><strong>планирование</strong> - статистика, используется для построения эфективного плана выполнения</li>\n<li><strong>выполнение</strong> - данные</li>\n</ul>\n<h2>Процессы и память</h2>\n<ul>\n<li>postmaster (сейчас называется просто postgres) - основной процесс, основной задачей которого является запуск и контроль всех остальных процессов, так же именно он обрабатывает входящие подключения от клиентов, при поступлении нового запроса, он порождает новый backend и передает подключение ново созданному backend'у.</li>\n<li>backend</li>\n<li>фоновые процессы</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=OW1MPSkCOro&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=6\">Тема 05 «Изоляция и многоверсионность»</a></h1>\n<h2>Многоверсионность</h2>\n<p>Наличие нескольких версий одной и той же строки</p>\n<ul>\n<li>версии различаются временем действия</li>\n<li>время = номер транзакции (номера выдаются по возврастанию)</li>\n</ul>\n<h2>Снимок данных</h2>\n<ul>\n<li>номер транзакции - определяет момент времени</li>\n<li>список активных странзакций - что бы не смотреть на еще не зафиксированные изменения</li>\n</ul>\n<h2>Блокировки</h2>\n<h3>Блокировки строк</h3>\n<ul>\n<li>чтение никогда не блокирует строк</li>\n<li>изменение строки блокирует ее для изменений, но не для чтений</li>\n</ul>\n<h3>Блокировки таблиц</h3>\n<ul>\n<li>запрещают изменение или удаление таблицы, пока с ней идет работа</li>\n<li>запрещают чтение таблицы при перестроении или перемещении и т.п.</li>\n</ul>\n<h3>Время жизни блокировок</h3>\n<ul>\n<li>устанавливаются по мере необходимости или вручную</li>\n<li>снимаются автоматически при завершении транзакции</li>\n</ul>\n<h2>Статус транзакций (xact)</h2>\n<p>Статус транзакций</p>\n<ul>\n<li>служебная информация, два бита</li>\n<li>специальные файлы на диске</li>\n<li>буферы в общей памяти</li>\n</ul>\n<p>Фиксация</p>\n<ul>\n<li>устанавливается бит “транзакция зафиксирована”</li>\n</ul>\n<p>Откат</p>\n<ul>\n<li>устанавливается бит “транзакция прервана”</li>\n<li>выполняется так же быстро, как и фиксация (не нужен откат данных)</li>\n</ul>\n<h2>Очистка</h2>\n<p>Старые версии строк храняться вместе с актуальными</p>\n<ul>\n<li>со временем размер таблиц и индексов увеличивается</li>\n<li>Процесс очистки (vacuum)</li>\n<li>удалет версии строк, которые уже не нужны (то есть не видны ни в одном снимке данных)</li>\n<li>работает параллельно с остальными процессами</li>\n<li>удаленные версии отставляют в файла данных “дыры”, которые затем используются для новых версий строк</li>\n</ul>\n<p>Полная очистка</p>\n<ul>\n<li>полностью перестраивает файлы данных, делая их компактными блокирует таблицу на время работы</li>\n</ul>\n<p>Примечание: важно что бы auto vacuum постоянно подчищал файлы, иначе, если файл сильно вырос и нужно его пожать, необходима полная очистка со всеми вытекающими</p>\n<h2>Автоочистка</h2>\n<ul>\n<li><strong>Autovacuum launcher</strong> - фоновый процесс реагирует на активность изменения данных</li>\n<li><strong>Autovacuum worker</strong> - запускается по необходимости, выполняет очистку</li>\n</ul>\n<h2>Уровни изоляции</h2>\n<ul>\n<li><strong>Read uncommitted</strong> - не поддерживается postgre sql - позволяет читать не зафиксированные данные</li>\n<li><strong>Read commited</strong> - используется по умолчанию - снимок строиться на момент начала оператора, одинаковые запросы могут каждый раз получать разные данные</li>\n<li><strong>Repeatable read</strong> - снимок строиться на момент начала первого оператора транзакции, транзакция может завершиться ошибкой сериализации</li>\n<li><strong>Serializable</strong> - полная изоляция, но дополнительные накладные расходы, транзакция может завершиться ошибкой сериализации</li>\n</ul>\n<h2>Демо</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> t<span class=\"token punctuation\">(</span>s <span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> T <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'Первая версия'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Начянет транзакцию в выведем ее номер:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> txid_current<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Транзакция видит первую (и пока единственную) версию строки:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> xmin<span class=\"token punctuation\">,</span> xmax <span class=\"token keyword\">FROM</span> t<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li><code class=\"language-text\">xmin</code>, <code class=\"language-text\">xmax</code> - служебные поля, есть везде, не выводяться звездочкой</li>\n<li><code class=\"language-text\">xmin</code> - номер транзакции которая создала версию этой строки</li>\n<li><code class=\"language-text\">xmax</code> - номер транзакции которая удалила версию</li>\n<li>в примере, xmin меньше чем мой номер, т.к. вставка произошла ранее, в предыдущей транзакции.</li>\n</ul>\n<p>Запускаем второе подключение:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> txid_current<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> xmin<span class=\"token punctuation\">,</span> xmax <span class=\"token keyword\">FROM</span> t<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> t <span class=\"token keyword\">SET</span> s <span class=\"token operator\">=</span> <span class=\"token string\">'Вторая версия'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> xmin<span class=\"token punctuation\">,</span> xmax <span class=\"token keyword\">FROM</span> t<span class=\"token punctuation\">;</span></code></pre></div>\n<p>При этом в первом сеансе, версия все еще старая, но зато появился <code class=\"language-text\">xmax</code>. Дальше если сделаем commit то первый сеанс увидит новую версию. Если и первый сеанс сделает commit, то первая версия останеться “мусорной” и не будет доступна никому.</p>\n<p>Так же при коммите, в обоих сеансах max обнулилось.</p>\n<p>При одновременной попытке обновить строку, ожидаемо, вторая - зависает.</p>\n<h2>Итоги</h2>\n<ul>\n<li>В файлах данных могут храниться несколько версий каждой строки</li>\n<li>Транзакции работают со снимком данных - согласованным срезом на определенный момент времени</li>\n<li>Писатели не блоикруют читателей, читатели не блокируют никого</li>\n<li>Время создания снимка виляет на уровень изоляции</li>\n<li>Версии строк накапливаются, поэтому нужна периодическая очистка</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=a5ymkoWD7fA&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=7\">Тема 06 «Буферный кэш и журнал»</a></h1>\n<h2>Буферный кэш</h2>\n<p>речь об оперативной памяти</p>\n<ul>\n<li>массив буферов - страница данных (8кб), доп. информация</li>\n<li>блокировки в памяти - для совместного доступа</li>\n</ul>\n<h2>Вытеснение</h2>\n<p>Вытеснение редко используемых страниц - “гразный” буфер записывается на диск, на освободившееся место читается другая страница</p>\n<h2>Журнал предзаписи (WAL)</h2>\n<p><strong>Проблема:</strong> при сбое теряются данные из оперативной памяти, не записанные на диск</p>\n<h3>Журнал</h3>\n<ul>\n<li>поток информации о выполняемых действиях, позволяющей повторно выполнить потерянные при сбое операции</li>\n<li>запись попадает на диск раньше, чем измененные данные</li>\n</ul>\n<h3>Журнал защищает</h3>\n<ul>\n<li>страницы таблиц, индексов и других объектов</li>\n<li>статус транзакций (xact)</li>\n</ul>\n<h3>Журнал не защищает</h3>\n<ul>\n<li>временные и нежурналируемые таблицы</li>\n</ul>\n<h2>Производительность</h2>\n<p><strong>Синхронный режим</strong> - запись при фиксации обслуживаеющий процесс</p>\n<p><strong>Асинхронный режим</strong> - фоновая запись, walwriter</p>\n<h2>Контрольная точка</h2>\n<p><strong>Периодический сброс всех грязных буферов на диск</strong> - гарантирует попадание на диск всех изменений до контрольной точки, ограничивает размер журнала, необходимого для восстановлений</p>\n<p><strong>Востановление при сбое</strong> - начинается с последней контрольной точки, последовательно проигрываются записи, если изменений нет на диске</p>\n<h2>Основные процессы</h2>\n<ul>\n<li><strong>walwriter</strong> - запись журнала</li>\n<li><strong>checkpointer</strong> - контрольная точка (сброс всех грязных буферов)</li>\n<li><strong>bgwriter</strong> - фоновая запись (сброс части грязных буферов)</li>\n<li>обслуживающие процессы - сброс вытесняемого грязного буфера</li>\n</ul>\n<h2>Демо</h2>\n<p>Журнал WAL - непрерывный поток записей, каждая имеет номер LSN (Log Sequence Number). 64 разрядное число, смещение записи в байтах относительно начала журнала.</p>\n<p>Текущая позиция</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> pg_current_wal_lsn<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 0/16BF818</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> t<span class=\"token punctuation\">(</span>n <span class=\"token keyword\">integer</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> t <span class=\"token keyword\">SELECT</span> gen<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">FROM</span> generate_series<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> gen<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> pg_current_wal_lsn<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 0/16E5E90</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token string\">'0/16E5E90'</span>::pg_lsn <span class=\"token operator\">-</span> <span class=\"token string\">'0/16BF818'</span>::pg_lsn<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 157304 - 157kb журнала ушло в логе на все про все</span></code></pre></div>\n<p>Физически журнал храниться в файлах по 16mb в отдельном каталоге (PGDATA/pg_wal). Так же можно посмотреть прямо из базы:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_ls_waldir<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> name<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Вернет список файлов с логами, размером и датой изменения, база будет их подчищать в фоне по мере надобности</p>\n<h2>Уровни журнала</h2>\n<ul>\n<li><strong>minimal</strong> - гарантия востановления после сбоя</li>\n<li><strong>replica</strong> (по умолчанию) - резервное копирование, репликация: передача и проигрывание журнала на другом сервере</li>\n<li><strong>logical</strong> - логическая репликация: информация о добавлении, изменении и удалении табличных строк</li>\n</ul>\n<h2>Итоги</h2>\n<ul>\n<li>\n<p>Буферный кэш существенно ускоряет работу, уменьшая число дисковых операций</p>\n</li>\n<li>\n<p>Надежность обеспечивается журналированием</p>\n</li>\n<li>\n<p>Размер журнала ограничен благодаря контрольным точкам</p>\n</li>\n<li>\n<p>Журнал удобен и ипользуется во многих случая</p>\n<ul>\n<li>для востановления после сбоя</li>\n<li>при резервном копировании</li>\n<li>для репликации между серверами</li>\n</ul>\n</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=fXALI61g3dQ&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=8\">Тема 07 «Базы данных и схемы»</a></h1>\n<h2>Кластер баз данных</h2>\n<p>Инициализация кластера создает три базы данных.</p>\n<p>Новая база всегда клонируется из существующей.</p>\n<ul>\n<li><code class=\"language-text\">postgres</code> - подключение по умолчанию, служебная.</li>\n<li><code class=\"language-text\">template0</code> - не меняется</li>\n<li><code class=\"language-text\">template1</code> - общие изменения (копируется от сюда)</li>\n</ul>\n<p>Примечание: например мы всегда используем <code class=\"language-text\">uuid</code>, есть смысл включить его в <code class=\"language-text\">template1</code> что бы он был доступен во всех последующих базах.</p>\n<h2>Схемы</h2>\n<p>Пространство имен для объектов внутри базы данных - каждый объект принадлежит какой-либо схеме</p>\n<p>Задачи:</p>\n<ul>\n<li>разделение объектов на логические группы</li>\n<li>предотвращение конфликта имен между приложениями</li>\n</ul>\n<p>Схема и пользователь - разные сущности</p>\n<h2>Базы и схемы кластера</h2>\n<ul>\n<li><code class=\"language-text\">pg_catalog</code> - системный каталог (есть в каждой базе данных)</li>\n<li><code class=\"language-text\">public</code> - общая схема по умолчанию (ака <code class=\"language-text\">dbo</code>)</li>\n</ul>\n<h2>Путь поиска</h2>\n<h3>Обределение схемы объекта</h3>\n<ul>\n<li>квалифицированно имя (схема.имя) явно определеяет схему</li>\n<li>имя без квалификатора проверяется в схемах, указанных в пути поиска</li>\n</ul>\n<h3>Путь поиска</h3>\n<ul>\n<li>задаеться параметром <code class=\"language-text\">search_path</code> (перечисление схем через запятую)</li>\n<li>исключаются несуществующие схемы и схемы, к которым нет доступа</li>\n<li>подставляются неявно подразумеваемые схемы</li>\n<li>реальное значение показывает функцися <code class=\"language-text\">current_schemas</code></li>\n<li>первая явно указанная в пути схема используется для создания объектов</li>\n</ul>\n<h2>Специальные схемы</h2>\n<h3>Схема public</h3>\n<ul>\n<li>по умолчанию входит в путь поиска</li>\n<li>если ничего не менять, все объекты будут в этой схеме</li>\n</ul>\n<h3>Схема, совпадающая по имени с пользователем</h3>\n<ul>\n<li>по умолчанию входит в путь поиска, но не существует</li>\n<li>если создать, объекты пользователя будут в этой схеме</li>\n</ul>\n<h3>Схема pg_catalog</h3>\n<ul>\n<li>схема для объектов системного каталога</li>\n<li>если pg_catalog нет в пути, она неявно подразумевается первой</li>\n</ul>\n<h3>Временные таблицы</h3>\n<ul>\n<li>существуют на время сеанса или транзакции</li>\n<li>не журналируются (невозможно восстановление после сбоя)</li>\n<li>не попадают в общий буферный кэш</li>\n</ul>\n<h3>Схема pg_temp_N</h3>\n<ul>\n<li>автоматически создается для временных таблиц</li>\n<li><code class=\"language-text\">pg_temp</code> - ссылка на конкретную временную схему данного сеанса</li>\n<li>если <code class=\"language-text\">pg_temp</code> нет в пути, она неявно подразумевается самой первой</li>\n<li>по окончании сеанса все объекты временной схемы удаляются, а сама схема остается и повторно используется для других сеансов</li>\n</ul>\n<h2>Демо</h2>\n<p>Список базы данных</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">psql -l\n=> \\l\n=> select datname, datistemplate, datallowconn, datconnlimit from pg_database;</code></pre></div>\n<p>Примечание:</p>\n<ul>\n<li><code class=\"language-text\">datistemplate</code> - является ли база данных шаблоном</li>\n<li><code class=\"language-text\">datallowconn</code> - разрешены ли соединения с базой данных</li>\n<li><code class=\"language-text\">datconnlimit</code> - максимально количество соединений (-1 - без ограничений)</li>\n</ul>\n<h3>Создание базы из шаблона</h3>\n<p>Подключимся к шаблонной базе template1</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\\c template1</code></pre></div>\n<p>Проверим что функция digest не включена</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> digest<span class=\"token punctuation\">(</span><span class=\"token string\">'hello'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'md5'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Включим расширение</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">create extension pgcrypto;</code></pre></div>\n<p>После чего предыдущий запрос заработает, теперь необходимо отключиться от базы, что бы можно было создать на ее основе новую</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\\c postgres</code></pre></div>\n<p>И создадим базу</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">database</span> acme<span class=\"token punctuation\">;</span></code></pre></div>\n<p>После чего можно переключиться на нее и проверить что md5 работает</p>\n<h3>Дополнительные примеры</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> acme <span class=\"token keyword\">TO</span> foo<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- переименование базы</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> acme CONNECTION <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- выставляем лимит подключений</span>\n<span class=\"token keyword\">SELECT</span> pg_database_size<span class=\"token punctuation\">(</span><span class=\"token string\">'acme'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- размер базы данных</span>\n<span class=\"token keyword\">SELECT</span> pg_size_pretty<span class=\"token punctuation\">(</span>pg_database_size<span class=\"token punctuation\">(</span><span class=\"token string\">'test'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- размер базы данных</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> \\dn <span class=\"token comment\">-- выведет списох схем</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">SCHEMA</span> demo<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SHOW</span> search_path<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- выводит путь поиска</span>\n<span class=\"token keyword\">SELECT</span> current_schemas<span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- выводит актуальный путь поиска</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> \\dt <span class=\"token comment\">-- выведет список табличек</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> test <span class=\"token keyword\">SET</span> <span class=\"token keyword\">SCHEMA</span> demo<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- переместить табличку в другую схему</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> search_path <span class=\"token operator\">=</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- поменять путь поиска (на текущий сеанс)</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> test <span class=\"token keyword\">SET</span> search_path <span class=\"token operator\">=</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- поменять путь поиска для базы (персистентно)</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TEMP</span> <span class=\"token keyword\">TABLE</span> t<span class=\"token punctuation\">(</span>s <span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- создание времянки, после чего \\dt - выведет ее, схема будет pg_temp_4, POI - pg_temp_4 добавилась в начало пути поиска и как следствие может перекрыть существующую табличку, что бы достучаться до оригинальной, нужно явно указзывать схему</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">VIEW</span> v <span class=\"token keyword\">AS</span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_temp<span class=\"token punctuation\">.</span>t<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- создание временной вьюхи (по сути та же временная табличка)</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">SCHEMA</span> app<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- удаление пустой схемы</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">SCHEMA</span> app <span class=\"token keyword\">CASCADE</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- удаление схемы и всех ее объектьов</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">DATABASE</span> acme<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- удаление базы</span></code></pre></div>\n<h2>Итоги</h2>\n<ul>\n<li>\n<p>Логически</p>\n<ul>\n<li>кластер содержит базы данных</li>\n<li>базы данных - схемы</li>\n<li>схемы - конкретные объекты (таблицы, индексы и т.п.)</li>\n</ul>\n</li>\n<li>\n<p>Базы данных создаются клонированием существующих</p>\n</li>\n<li>\n<p>Схема указывается явно или определяется по пукти поиска</p>\n</li>\n<li>\n<p>Некоторые схемы имеют специальное назначение</p>\n</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=szkSbtMSQQ4&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=9\">Тема 08 «Системный каталог»</a></h1>\n<h2>Системный каталог</h2>\n<p>Набор таблиц и представлений, описывающий все объекты кластера баз данных</p>\n<p>Схемы</p>\n<ul>\n<li>основная схема - pg_catalog</li>\n<li>альтернативное представление - information_schema (стандарт SQL)</li>\n</ul>\n<p>SQL-доступ</p>\n<ul>\n<li>просмотр: SELECT</li>\n<li>изменение: CREATE, ALTER, DROP</li>\n</ul>\n<p>Доступ в psql возможен специальными командам для удобного просмотра</p>\n<h2>Специальные типы данных</h2>\n<h3>OID - тип для идентификатора объекта</h3>\n<ul>\n<li>первичные и внешние ключи в табличцах системного каталога</li>\n<li>скрытый столбец, в запросах надо указывать явно</li>\n</ul>\n<h3>Reg-типы</h3>\n<ul>\n<li>псевдонимы OID для некоторых таблиц системного каталога (regclass для pg_class и т.п.)</li>\n<li>приведение текстового имени объекта к типу OID и обратно</li>\n</ul>\n<h2>Демо</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_database <span class=\"token keyword\">WHERE</span> datname <span class=\"token operator\">=</span> <span class=\"token string\">'test'</span> \\gx <span class=\"token comment\">-- инфо о базе</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_namespace <span class=\"token keyword\">WHERE</span> nspname <span class=\"token operator\">=</span> <span class=\"token string\">'public'</span> \\gx <span class=\"token comment\">-- инфо о схеме</span>\n<span class=\"token keyword\">SELECT</span> relname<span class=\"token punctuation\">,</span> relkind<span class=\"token punctuation\">,</span> relnamespace<span class=\"token punctuation\">,</span> relfilenode<span class=\"token punctuation\">,</span> relowner<span class=\"token punctuation\">,</span> reltablespace <span class=\"token keyword\">FROM</span> pg_class <span class=\"token keyword\">WHERE</span> relname <span class=\"token operator\">=</span> <span class=\"token string\">'users'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- инфо об relation, в постгрес, все все в этой табличке, а именно: таблицы, представления (вклюючая материализированные), индексы, последовательности</span>\n<span class=\"token keyword\">SELECT</span> schemaname<span class=\"token punctuation\">,</span> tablename<span class=\"token punctuation\">,</span> tableowner<span class=\"token punctuation\">,</span> <span class=\"token keyword\">tablespace</span> <span class=\"token keyword\">FROM</span> pg_tables <span class=\"token keyword\">WHERE</span> schemaname <span class=\"token operator\">=</span> <span class=\"token string\">'public'</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>по сути <code class=\"language-text\">pg_tables, pg_views</code> это представление поверх <code class=\"language-text\">pg_class</code> джойнящее данные</li>\n<li>сокращения <code class=\"language-text\">\\dt, \\dv, \\di</code> - это сокращения обращающиеся в те же представления</li>\n<li>у сокращений можно подставить плюсик что бы получить доп инфо - <code class=\"language-text\">\\dt+</code></li>\n<li>можно вывести инфо о конкретном объекте <code class=\"language-text\">\\dt+ users</code></li>\n<li><code class=\"language-text\">\\df pg*size</code> - выведет список доступных ф-ий, добавили pgsize что бы хоть что то вывело, т.к. в базе нет пользовательских ф-ий</li>\n<li><code class=\"language-text\">\\sf pg_catalog.pg_database_size(oid)</code> - вывод исходников</li>\n<li><code class=\"language-text\">\\set ECHO_HIDDEN on</code> - трюк, после него вызов всяких \\dt будет выводить запрос которым он был получен</li>\n</ul>\n<p>Получение ифы о колонках</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>attname<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>atttypid <span class=\"token keyword\">FROM</span> pg_attribute a <span class=\"token keyword\">WHERE</span> a<span class=\"token punctuation\">.</span>attrelid <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">SELECT</span> oid <span class=\"token keyword\">FROM</span> pg_class <span class=\"token keyword\">WHERE</span> relname <span class=\"token operator\">=</span> <span class=\"token string\">'users'</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>attnum <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> attname<span class=\"token punctuation\">,</span> atttypid::regtype <span class=\"token keyword\">FROM</span> pg_attribute <span class=\"token keyword\">WHERE</span> attrelid <span class=\"token operator\">=</span> <span class=\"token string\">'users'</span>::regclass <span class=\"token operator\">AND</span> attnum <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>если убрать attnum получим xmin, xmax и т.п.</li>\n<li>за вместо того что бы ходить за oid можно сделать <code class=\"language-text\">'users'::regclass</code></li>\n<li>то же самое касается и типов <code class=\"language-text\">a.attypid::regtype</code></li>\n</ul>\n<h2>Итоги</h2>\n<ul>\n<li>Системный каталог - метаинформация о кластере в самом кластере</li>\n<li>SQL-доступ и дополнительные команды psql</li>\n<li>Часть таблиц системого каталога храниться в базах данных, часть - общая для всего кластера</li>\n<li>Системный каталог использует специальные типы данных</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=XKhoGe9oSNU&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=10\">Тема 09 «Табличные пространства»</a></h1>\n<ul>\n<li>Табличные пространства позволяют размещать таблички на разных дисках</li>\n<li>Существуют <code class=\"language-text\">pg_global, pg_default</code></li>\n<li>В одной базе, объекты могут храниться в разных пространствах</li>\n<li><code class=\"language-text\">pg_global</code> - хранит объекты общие для всех баз данных (читай системные вьюхи)</li>\n<li><code class=\"language-text\">pg_global</code> - <code class=\"language-text\">$PGDATA/global/</code></li>\n<li><code class=\"language-text\">pg_default</code> - <code class=\"language-text\">$PGDATA/base/dboid/</code>, где <code class=\"language-text\">dboid</code> - идентификатор базы</li>\n<li>свое пространство - <code class=\"language-text\">/путь-к-каталогу/ver/dboid/</code> - будет ссылка в <code class=\"language-text\">$PGDATA/pg_tblspc/tsoid</code></li>\n<li><code class=\"language-text\">select * from pg_tablespace;</code> - вывести список пространств</li>\n</ul>\n<h2>Создания своего пространства</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\\! mkdir /home/postgres/test -- be sure that it is owned by postgres\nCREATE TABLESPACE test LOCATION '/home/postgres/test';\n\\db -- выведет созданное пространство\nCREATE DATABASE bar TABLESPACE test; -- создаст базу с пространством по умолчанию\nCREATE TABLE t2(n numeric) TABLESPACE pg_default; -- все еще можно указывать для таблички\nALTER TABLE t1 SET TABLESPACE pg_default; -- важно - это физическое перемещение файлов с блокировкой таблички\nALTER TABLE ALL IN TABLESPACE pg_default SET TABLESPACE test; -- переместит все таблички из pg_default в test\nSELECT pg_size_pretty(pg_tablespace_size('test')); -- размер пространства\nDROP TABLESPACE ts; -- удалить пустое пространство, нет возможности сделать CASCADE, т.к. в пространтсве могут быть объекты из разных баз</code></pre></div>\n<h2>Удаление пространства</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> oid <span class=\"token keyword\">from</span> pg_tablespace <span class=\"token keyword\">WHERE</span> spcname <span class=\"token operator\">=</span> <span class=\"token string\">'test'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- получили id пространства</span>\n<span class=\"token keyword\">select</span> datname <span class=\"token keyword\">from</span> pg_database <span class=\"token keyword\">where</span> oid <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> pg_tablespace_databases<span class=\"token punctuation\">(</span><span class=\"token number\">234</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- список баз использующих это пространство</span>\n<span class=\"token keyword\">select</span> relnamespace::regnamespace<span class=\"token punctuation\">,</span> relname<span class=\"token punctuation\">,</span> relkind <span class=\"token keyword\">from</span> pg_class <span class=\"token keyword\">where</span> reltablespace <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- список объектов живующих в пространстве</span>\n<span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> pg_class <span class=\"token keyword\">where</span> reltablespace <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- для случаев когда пространство по умолчанию</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> acme <span class=\"token keyword\">SET</span> <span class=\"token keyword\">TABLESPACE</span> pg_default<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- переедет все объекты в новое пространство</span></code></pre></div>\n<h2>Вопросы</h2>\n<ul>\n<li>Если поломается диск на котором есть какое либо пространство - свалиться весь постгрес</li>\n<li>Табличное пространство может быть сетевой файловой системой, но это считается плохой идеей</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=P0lunPuJnkk&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=11\">Тема 10 «Низкий уровень»</a></h1>\n<h2>Слои объекта</h2>\n<ul>\n<li><strong>main</strong> - NNN, NNN.1, NNN.2</li>\n<li><strong>fsm</strong> - NNN_fsm, NNN_fsm.1</li>\n<li><strong>vm</strong> - NNN_vm</li>\n</ul>\n<p>Каждый файл занимает не более 1гб (для совместимости с файловыми системами которые не умеют файлы больше)</p>\n<h2>Страницы файцлов</h2>\n<p>Каждый файл разбит на так называемые странички, по умолчанию 8кб, каждая имеет заголовок и данные</p>\n<p>Буфферный кэш не знает с какими страничками он работает (для него это просто странички не важно идет ли речь о табличках, индексах и т.п.)</p>\n<h2>Слои</h2>\n<h3>Основной слой (main)</h3>\n<ul>\n<li>собственно данные (версии строк)</li>\n<li>существует для всех объектов</li>\n</ul>\n<h3>Инициализации (init)</h3>\n<ul>\n<li>заготовка пустого основного слоя</li>\n<li>используется при сбое, только для нежуранлируемых таблиц</li>\n</ul>\n<h3>Карта с вободного пространтсва (fsm)</h3>\n<ul>\n<li>отмечает свободное пространство в страницах после очистки</li>\n<li>используется при вставке новый хверсий строк</li>\n<li>существует для всех объектов</li>\n</ul>\n<h3>Карта видимости (vm)</h3>\n<ul>\n<li>отмечает страницы, на которых все версии строк видны во всех снимках</li>\n<li>используется для оптимизации работы процесса очистки и ускорения индексного доступа</li>\n<li>существует только для таблиц</li>\n</ul>\n<p>Поля xmin, xmax храняться в таблице, а не в индексе, соотв даже если запрос только на индекс, все равно нужно сходить в табличку, что бы понять показывать это или нет, вот тут visibility map позволяет это обойти, что позволяет выполнять index only scan</p>\n<h3>TOAST</h3>\n<ul>\n<li>\n<p>Версия строки должна помещаться на одну страницу (8kb)</p>\n<ul>\n<li>можно сжать часть атрибутов</li>\n<li>или вынести в отдельную TOAST-таблицу</li>\n<li>или сжать и вынести одновременно</li>\n</ul>\n</li>\n<li>\n<p>TOAST-таблица</p>\n<ul>\n<li>схемы pg_toast, pg_toast_temp_N</li>\n<li>табличца поддержана собственным индексом</li>\n<li>“длинные” атрибуты разделены на части размером меньше страницы</li>\n<li>читается только при обращении к “длинному” атрибуту</li>\n<li>собственная версионность</li>\n<li>работает прозрачно для приложения</li>\n</ul>\n</li>\n</ul>\n<p>TOAST - the oversized attribute storage technique</p>\n<p>Примечание - если поменяли версию строки в малой табличке, но новая и старая версии просто ссылаются на одну и ту же версию аттрибута(ов) в TOAST табличке</p>\n<h2>Расположение файлов</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> data_lowlevel<span class=\"token punctuation\">;</span>\n\\c data_lowlevel\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> t<span class=\"token punctuation\">(</span>id <span class=\"token keyword\">serial</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span> n <span class=\"token keyword\">numeric</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> T<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">SELECT</span> g<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">FROM</span> generate_series<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> g<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> pg_relation_filepath<span class=\"token punctuation\">(</span><span class=\"token string\">'t'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- путь где храняться файлы таблички, base/16431/16433, первая цифра - oid базы, второе - идентификатор таблички</span>\n<span class=\"token keyword\">SELECT</span> OID <span class=\"token keyword\">FROM</span> pg_database <span class=\"token keyword\">WHERE</span> datname <span class=\"token operator\">=</span> <span class=\"token string\">'data_lowlevel'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- oid базы</span>\n<span class=\"token keyword\">SELECT</span> relfilenode <span class=\"token keyword\">FROM</span> pg_class <span class=\"token keyword\">WHERE</span> relname <span class=\"token operator\">=</span> <span class=\"token string\">'t'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- идентификатор для таблички</span>\n\\<span class=\"token operator\">!</span> ls <span class=\"token operator\">-</span>lah <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token keyword\">local</span><span class=\"token operator\">/</span>pgsql<span class=\"token operator\">/</span><span class=\"token keyword\">data</span><span class=\"token operator\">/</span>base<span class=\"token operator\">/</span><span class=\"token number\">16431</span><span class=\"token operator\">/</span><span class=\"token number\">16433</span><span class=\"token operator\">*</span> <span class=\"token comment\">-- выведет список файлов</span>\nVACUUM t<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- ручной запуск авто очистки для таблички</span>\n<span class=\"token keyword\">SELECT</span> pg_relation_filepath<span class=\"token punctuation\">(</span><span class=\"token string\">'t_pkey'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- путь к индексу, base/16431/16439</span>\n\\<span class=\"token operator\">!</span> ls <span class=\"token operator\">-</span>lah <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token keyword\">local</span><span class=\"token operator\">/</span>pgsql<span class=\"token operator\">/</span><span class=\"token keyword\">data</span><span class=\"token operator\">/</span>base<span class=\"token operator\">/</span><span class=\"token number\">16431</span><span class=\"token operator\">/</span><span class=\"token number\">16439</span><span class=\"token operator\">*</span> <span class=\"token comment\">-- fsm у индекса может быть, а vm - нет</span>\n<span class=\"token keyword\">SELECT</span> pg_relation_filepath<span class=\"token punctuation\">(</span><span class=\"token string\">'t_id_seq'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- последовательность base/16431/16432</span>\n\\<span class=\"token operator\">!</span> ls <span class=\"token operator\">-</span>lah <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token keyword\">local</span><span class=\"token operator\">/</span>pgsql<span class=\"token operator\">/</span><span class=\"token keyword\">data</span><span class=\"token operator\">/</span>base<span class=\"token operator\">/</span><span class=\"token number\">16431</span><span class=\"token operator\">/</span><span class=\"token number\">16432</span><span class=\"token operator\">*</span>\n<span class=\"token keyword\">SELECT</span> pg_relation_size<span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'main'</span><span class=\"token punctuation\">)</span> main<span class=\"token punctuation\">,</span> pg_relation_size<span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'fsm'</span><span class=\"token punctuation\">)</span> fsm<span class=\"token punctuation\">,</span> pg_relation_size<span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'vm'</span><span class=\"token punctuation\">)</span> vm<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- размер</span>\n<span class=\"token keyword\">select</span> pg_table_size<span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- сумма всех слоев таблички</span>\n<span class=\"token keyword\">select</span> pg_indexes_size<span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- размер индексов на табличке</span>\n<span class=\"token keyword\">select</span> pg_total_relation_size<span class=\"token punctuation\">(</span><span class=\"token string\">'users'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- размер таблички + индексов</span></code></pre></div>\n<h3>oid2name</h3>\n<ul>\n<li><code class=\"language-text\">oid2name</code> - выведет базы и их oid</li>\n<li><code class=\"language-text\">oid2name -d data_lowlevel</code> - выведет таблички в базе и их filenode</li>\n<li><code class=\"language-text\">oid2name -d data_lowlevel -s</code> - вывеедт пространства в базе и их oid</li>\n<li><code class=\"language-text\">oid2name -d data_lowlevel -t t</code> - выведет filenode таблички</li>\n<li><code class=\"language-text\">oid2name -d data_lowlevel -f 16514</code> - выведет табличку по filenode</li>\n</ul>\n<h2>Пример TOAST</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> toastdemo<span class=\"token punctuation\">;</span>\n\\c toastdemo\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> demo <span class=\"token punctuation\">(</span>s <span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> pg_total_relation_size<span class=\"token punctuation\">(</span><span class=\"token string\">'demo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 8192</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> demo <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'hello'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> pg_total_relation_size<span class=\"token punctuation\">(</span><span class=\"token string\">'demo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 16384</span>\n<span class=\"token keyword\">SELECT</span> length<span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span><span class=\"token number\">123456789</span>::<span class=\"token keyword\">numeric</span> <span class=\"token operator\">^</span> <span class=\"token number\">12345</span>::<span class=\"token keyword\">numeric</span><span class=\"token punctuation\">)</span>::<span class=\"token keyword\">text</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- демо, вот такую длинную строку мы будем вставлять, она не влезет в страницу, так что будет использована TOAST табличка</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> demo<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">SELECT</span> <span class=\"token number\">123456789</span>::<span class=\"token keyword\">numeric</span> <span class=\"token operator\">^</span> <span class=\"token number\">12345</span>::<span class=\"token keyword\">numeric</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> pg_total_relation_size<span class=\"token punctuation\">(</span><span class=\"token string\">'demo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 131072 -- хм, у меня не сработало,</span>\n<span class=\"token keyword\">select</span> relname<span class=\"token punctuation\">,</span> relfilenode <span class=\"token keyword\">from</span> pg_class <span class=\"token keyword\">where</span> oid <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> reltoastrelid <span class=\"token keyword\">from</span> pg_class <span class=\"token keyword\">where</span> relname <span class=\"token operator\">=</span> <span class=\"token string\">'demo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- TOAST таблички, 16445</span>\n<span class=\"token keyword\">SELECT</span> OID <span class=\"token keyword\">FROM</span> pg_database <span class=\"token keyword\">WHERE</span> datname <span class=\"token operator\">=</span> <span class=\"token string\">'toastdemo'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 16441</span>\n\\<span class=\"token operator\">!</span> ls <span class=\"token operator\">-</span>lah <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token keyword\">local</span><span class=\"token operator\">/</span>pgsql<span class=\"token operator\">/</span><span class=\"token keyword\">data</span><span class=\"token operator\">/</span>base<span class=\"token operator\">/</span><span class=\"token number\">16441</span><span class=\"token operator\">/</span><span class=\"token number\">16445</span><span class=\"token operator\">*</span> <span class=\"token comment\">-- main файл на 152кб, вот тут живет TOAST</span>\n<span class=\"token keyword\">SELECT</span> relfilenode <span class=\"token keyword\">FROM</span> pg_class <span class=\"token keyword\">WHERE</span> relname <span class=\"token operator\">=</span> <span class=\"token string\">'demo'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 16442</span>\n\\<span class=\"token operator\">!</span> ls <span class=\"token operator\">-</span>lah <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token keyword\">local</span><span class=\"token operator\">/</span>pgsql<span class=\"token operator\">/</span><span class=\"token keyword\">data</span><span class=\"token operator\">/</span>base<span class=\"token operator\">/</span><span class=\"token number\">16441</span><span class=\"token operator\">/</span><span class=\"token number\">16442</span><span class=\"token operator\">*</span> <span class=\"token comment\">-- main файл таблички 8кб, остался маленьким, т.к. большие строки уехали в TOAST</span>\n\\d<span class=\"token operator\">+</span> demo <span class=\"token comment\">-- выведет инфо о табличке, в частности стратегии хранения (storage)</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> demo <span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">COLUMN</span> s <span class=\"token keyword\">SET</span> STORAGE <span class=\"token keyword\">extended</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- изменить стратегию хранения (будет применяться только для новых данных, старые остаются как есть)</span></code></pre></div>\n<h3>Стратегии хранения</h3>\n<ul>\n<li><strong>plain</strong> - TOAST не применяется (тип имеет фиксированную длину)</li>\n<li><strong>main</strong> - приоритет сжатия</li>\n<li><strong>extended</strong> - применяется как сжатие, как и отдельное хранение</li>\n<li><strong>external</strong> - только отдельное хранение без сжатия (например если собираемся хранить jpeg - они уже пожаты, нет смысл за зря гонять CPU)</li>\n</ul>\n<h2>Итоги</h2>\n<ul>\n<li>объект представлен несколькими слоями</li>\n<li>слой состоит из одного или нескольких файлов-сегментов</li>\n<li>каждый файл разбит на страницы</li>\n<li>для “длинных” версий строк используется TOAST</li>\n</ul>\n<p>Примечание: вроде как TOAST подключается после превышения 2кб</p>\n<h1><a href=\"https://www.youtube.com/watch?v=YSZ-3PuIiKk&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=12\">Тема 11 «Мониторинг»</a></h1>\n<h2>Средства ОС</h2>\n<h3>Процессы</h3>\n<ul>\n<li>ps (grep postgres)</li>\n<li>парааметр update_process_title для обновление статус процессов</li>\n</ul>\n<h3>Использование ресурсов</h3>\n<ul>\n<li>iostat, vmstat, sar, top…</li>\n</ul>\n<h3>Дисковое пространство</h3>\n<ul>\n<li>df, du, quota…</li>\n</ul>\n<h2>Статистика внутри базы</h2>\n<ul>\n<li>\n<p>текущие активности системы</p>\n<ul>\n<li>статистика - текущая активность и ожидания обслуживающих и фоновых процессов</li>\n<li>параметр track_activities - включен по умолчанию</li>\n</ul>\n</li>\n<li>\n<p>процесс сбора статистики</p>\n</li>\n<li>\n<p>дополнительные расширения</p>\n</li>\n</ul>\n<h3>Настройки процесса stats collector</h3>\n<ul>\n<li>статистика - обращения к таблицам и индексам (доступы, затронутые строки) - <code class=\"language-text\">track_counts</code> - включен по умолчанию и нужен для автоочистки</li>\n<li>обращения к страницам - <code class=\"language-text\">track_io_timing</code> - выключен по умолчанию</li>\n<li>вызовы пользовательских функций - <code class=\"language-text\">track_functions</code> - выключен по умолчанию</li>\n</ul>\n<p>Раз в пол секунды, агрегированная статистика сбрасывается на диск и обновляется в памяти, после чего используется остальными процессами. Примечательно что благодаря этому после перезапуска сервера у нас все равно есть статистика.</p>\n<p>Для сброса статистики есть специальные системные ф-ии.</p>\n<h2>Дополнительная статистика</h2>\n<h3>Расширения в поставке</h3>\n<ul>\n<li><code class=\"language-text\">pg_stat_statements</code> - статистика по запросам (например топ тяжелых запросов)</li>\n<li><code class=\"language-text\">pgstattuple</code> - статистика по версиям строк (насколько распухли таблички и не пора ли их чистить)</li>\n<li><code class=\"language-text\">pg_buffercache</code> - состояние буферного кэша (используем ли мы целиком кэш, какие объекты храним)</li>\n</ul>\n<h3>Другие расширения</h3>\n<ul>\n<li><code class=\"language-text\">pg_stat_plans</code> - статистика по планам запросов</li>\n<li><code class=\"language-text\">pg_stat_kcache</code> - статистика по процессору и вводу-выводу</li>\n<li><code class=\"language-text\">pg_qualstats</code> - статистика по предикатам</li>\n</ul>\n<h2>Журнал сообщений</h2>\n<ul>\n<li>настройка журнальных записей</li>\n<li>ротация файлов журнала</li>\n<li>анализ журнала</li>\n</ul>\n<h3>Приемник сообщений (log_destination = список) - может быть несколько</h3>\n<ul>\n<li>stderr - поток ошибок</li>\n<li>csvlog - формат CSV (только с коллектором)</li>\n<li>syslog - демон syslog</li>\n<li>eventlog - журнал событий Windows</li>\n</ul>\n<h3>Коллектор сообщений (logging_collector = on)</h3>\n<ul>\n<li>позволяет собирать дополнительную информацию</li>\n<li>никогда не теряет сообщения (в отличие от syslog)</li>\n<li>записывает stderr и csvlog в log_directory/log_filename</li>\n</ul>\n<p>Примечание: если не будет успевать записывать - может притормаживать остальные процессы</p>\n<h2>Настройки журнала</h2>\n<ul>\n<li>log_min_messages - сообщения определенного уровня</li>\n<li>log_min_duration_statement - время выполнения длинных комманд (логирует долгие запросы)</li>\n<li>log_duration - время выполнения команд</li>\n<li>application_name - имя приложения</li>\n<li>log_checkpoints - контрольные точки</li>\n<li>log_(dis)connections - подключения и отключения</li>\n<li>log_lock_waits - длинные ожидания (отслеживать блокировки)</li>\n<li>log_statement - текст выполняемых команд</li>\n<li>log_temp_files - использование временных файлов</li>\n</ul>\n<p>TODO: можно ли менять эти настройки налету без перезагрузки</p>\n<h2>Ротация файлов журнала</h2>\n<h3>С помощью коллектора сообщений</h3>\n<ul>\n<li>log_filename - маска имени файла</li>\n<li>log_rotation_age - время ротации, мин</li>\n<li>log_rotation_size - размер файла для ротации, кб - лучше не использовать, если ротация по времени</li>\n<li>log_truncate_on_rotation = on - очищает файл при ротации (иначе будет делать append)</li>\n</ul>\n<h3>Комбинируя маску файла и время ротации, получаем разные схемы:</h3>\n<ul>\n<li><code class=\"language-text\">'postgresql-%H.log', '1h'</code> - 24 файла в сутки</li>\n<li><code class=\"language-text\">'postgresql-%a.log', '1d'</code> - 7 файлов в неделю</li>\n</ul>\n<h3>Внешние средства</h3>\n<p>например 23 файлв в сутки с apache rotatelogs:</p>\n<p>pg<em>ctl start | rotatelogs имя</em>файла 3600 -n 24</p>\n<h2>Анализ журнала</h2>\n<ul>\n<li>Сресдтва операционной системы - <code class=\"language-text\">grep, awk,…</code></li>\n<li>Специальные средства анализа - <code class=\"language-text\">pgBadger</code> - требует определенных настроек журнала</li>\n</ul>\n<h2>Внешний мониторинг</h2>\n<h3>Универсальные системы мониторинга</h3>\n<ul>\n<li>zabbix, munin, cacti, …</li>\n<li>в облаке - okmeter, newrelic, datadog, …</li>\n</ul>\n<h3>Системы мониторинга postgresql</h3>\n<ul>\n<li>PGObserver</li>\n<li>PostgreSQL Workload Analyzer (PoWA)</li>\n<li>Open PostgreSQL Monitoring (OPM)</li>\n</ul>\n<h2>Демо</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> track_io_timing <span class=\"token operator\">=</span> <span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> track_functions<span class=\"token operator\">=</span><span class=\"token string\">'all'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> pg_reload_conf<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>В отдельном терминале эмулируем нагрузку</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">pgbench <span class=\"token operator\">-</span>i admin_monitoring\n<span class=\"token keyword\">SELECT</span> pg_stat_reset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- сброс статистики по таблицам</span>\n<span class=\"token keyword\">SELECT</span> pg_stat_reset_shared<span class=\"token punctuation\">(</span><span class=\"token string\">'bgwriter'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- сброс статистики</span>\npgbench <span class=\"token operator\">-</span>T <span class=\"token number\">10</span> admin_monitoring\nVACUUM pgbench_accounts<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- подчисщаем табличку</span></code></pre></div>\n<p>Статистика</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_stat_all_tables <span class=\"token keyword\">WHERE</span> relid<span class=\"token operator\">=</span><span class=\"token string\">'users'</span>::regclass \\gx <span class=\"token comment\">-- статистика по табличке, сколько строк вставленно, удалено, обновлено, когда срабатывала автоочистка, sec_scan - полное чтение, idx_scan - скаинрование индекса, можно смотреть как табличкой пользуются</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_statio_all_tables <span class=\"token keyword\">WHERE</span> relid<span class=\"token operator\">=</span><span class=\"token string\">'users'</span>::regclass \\gx <span class=\"token comment\">-- сколько было операций io, heap_blks_read - чтений с диска, heap_blks_hit - попадание в кэш</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_stat_all_indexes <span class=\"token keyword\">WHERE</span> relid<span class=\"token operator\">=</span><span class=\"token string\">'users'</span>::regclass \\gx\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_statio_all_indexes <span class=\"token keyword\">WHERE</span> relid<span class=\"token operator\">=</span><span class=\"token string\">'users'</span>::regclass \\gx <span class=\"token comment\">-- то же самое только про индексы</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_stat_database <span class=\"token keyword\">WHERE</span> datname<span class=\"token operator\">=</span><span class=\"token string\">'test'</span> \\gx <span class=\"token comment\">-- статистика по базе целиком, например раз в секунду собирать xact_commit + xact_rollback это будет TPS</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_stat_bgwriter \\gx <span class=\"token comment\">-- статистика по сбросу кэша, может триггернуться командой CHECKPOINT,</span></code></pre></div>\n<p>Примечания по bgwriter:</p>\n<ul>\n<li>buffers_clean - количество страниц, записанных фоновой записью</li>\n<li>buffers_checkpoint - количество страниц, записанных контрольной точкой</li>\n<li>buffers_backend - количество страниц, записанных серверными процессами</li>\n<li>checkpoints_timed - сколько раз срабатывал процесс контрольной точки в соотв с расписнием</li>\n<li>checkpoint_req - вынужденный чекпоинт (напр большая активность, wal переполнен)</li>\n</ul>\n<h3>Текущие активности</h3>\n<p>Пример с расследованием блокировок</p>\n<p>Предположим первый процесс</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> t <span class=\"token keyword\">SET</span> n <span class=\"token operator\">=</span> n <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>В это же время второй:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">UPDATE</span> t <span class=\"token keyword\">SET</span> n <span class=\"token operator\">=</span> n <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- заблокируется, ожидает первый процесс</span></code></pre></div>\n<p>Разбор</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> pid<span class=\"token punctuation\">,</span> query<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> wait_event<span class=\"token punctuation\">,</span> wait_event_type<span class=\"token punctuation\">,</span> pg_blocking_pids<span class=\"token punctuation\">(</span>pid<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> pg_stat_activity <span class=\"token keyword\">WHERE</span> backend_type <span class=\"token operator\">=</span> <span class=\"token string\">'client backend'</span> \\gx\n<span class=\"token keyword\">select</span> pid <span class=\"token keyword\">as</span> blocked_pid <span class=\"token keyword\">from</span> pg_stat_activity <span class=\"token keyword\">where</span> backend_type <span class=\"token operator\">=</span> <span class=\"token string\">'client backend'</span> <span class=\"token operator\">and</span> cardinality<span class=\"token punctuation\">(</span>pg_blocking_pids<span class=\"token punctuation\">(</span>pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- по сути список pid'ов которые заблокированны</span>\n<span class=\"token comment\">-- если бы не было ф-ии pg_blocking_pids</span>\n<span class=\"token keyword\">select</span> locktype<span class=\"token punctuation\">,</span> transactionid<span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">,</span> <span class=\"token keyword\">mode</span><span class=\"token punctuation\">,</span> granted <span class=\"token keyword\">from</span> pg_locks<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- по полю granted понятно кто залочил, а кто ждет</span>\n<span class=\"token keyword\">SELECT</span> pg_terminate_backend<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>pid<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> unnest<span class=\"token punctuation\">(</span>pg_blocking_pids<span class=\"token punctuation\">(</span>:blocked_pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> b<span class=\"token punctuation\">(</span>pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- аля KILL 23;</span></code></pre></div>\n<ul>\n<li>У первого процесса state будет idle in transaction - то есть он как бы ничего не делает и в транзакции</li>\n<li>У второго state будет active, wait_event_type - Lock - то есть мы заблокированны, pg_blocking_pids - pid первого процесса</li>\n<li><code class=\"language-text\">cardinality</code> - кол-во элементов в массиве</li>\n<li><code class=\"language-text\">pg_blocking_pids</code> - это массив, остображается как {234}, процесс может быть заблокирован несколькими процессами</li>\n<li>после прибивания первого процесса, state второго станет просто idle (без транзакции)</li>\n</ul>\n<p>Примечание: начиная с 9.6 появился параметр <code class=\"language-text\">idle_in_transaction_session_timeout</code> - принудительно завершает сеансы в которых транзакция простаивает больше указанного времени</p>\n<p>Если докапываться, вот так будет выглядет блокировка, первая транзакция залочила вторую, в представлении вторая транзакция будет иметь тот же trasnactionid, и false в granted, но опять таки что бы со всем этим не возиться есть pg_blocking_pids</p>\n<p>Начиная с верси 10 можно смотреть не только пользовательские но и системные процесс</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> pid<span class=\"token punctuation\">,</span> backend_type<span class=\"token punctuation\">,</span> backend_start<span class=\"token punctuation\">,</span> state <span class=\"token keyword\">FROM</span> pg_stat_activity<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Трюк - показать все порожденные процессы (по сути то же что и в пред примере)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ps</span> <span class=\"token parameter variable\">-o</span> pid,command <span class=\"token parameter variable\">--ppid</span> <span class=\"token punctuation\">\\</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">head</span> <span class=\"token parameter variable\">-n1</span> $PGDATA/postmaster.pid<span class=\"token punctuation\">\\</span><span class=\"token variable\">`</span></span><span class=\"token function\">grep</span> FATAL /hosm</code></pre></div>\n<p>Пару примеров с логами</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> log_min_duration_statement<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- начнет писать вообще все запросы</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> log_line_prefix<span class=\"token operator\">=</span><span class=\"token string\">'(pid=%p) '</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- меняет формат строки, в этом примере добавилии pid</span>\n<span class=\"token keyword\">SELECT</span> pg_reload_conf<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> test <span class=\"token keyword\">SET</span> log_min_duration_statement<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- можно на конретную базу, а так же на конкретного пользователя</span></code></pre></div>\n<h1><a href=\"https://www.youtube.com/watch?v=j6IinAiKIlk&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=13\">Тема 12 «Сопровождение»</a></h1>\n<h2>Процедура очистки</h2>\n<p>Запуск</p>\n<ul>\n<li><code class=\"language-text\">VACUUM таблица</code> - очистка таблицы</li>\n<li><code class=\"language-text\">VACUUM</code> - очистка все базы</li>\n<li><code class=\"language-text\">vacuumdb</code> - консольная утилита</li>\n</ul>\n<p>Примечания</p>\n<ul>\n<li>выполняется параллельно с другими транзакциями</li>\n<li>часты запуск нагружает подсистему ввода-вывода</li>\n<li>редкий запуск приводит к росту размера файлов</li>\n<li>не блокирует табличку</li>\n</ul>\n<h2>Фоновый процесс autovacuum</h2>\n<ul>\n<li>частота обработки таблицы динамически меняется в зависимости от частоты изменений</li>\n<li>настраивается конфигурационными параметрами</li>\n<li>процесс autovacuum launcher, запускает процессы autovacuum worker которые приходят чистить конретные таблички</li>\n</ul>\n<h2>Очистка</h2>\n<ul>\n<li><code class=\"language-text\">VACUUM FULL табличка</code> - очистка таблицы</li>\n<li><code class=\"language-text\">VACUUM FULL</code> - очистка все базы</li>\n<li><code class=\"language-text\">vacuumdb --full</code> - консольный аналог</li>\n</ul>\n<p>Примечания</p>\n<ul>\n<li>полностью перестраивает содержимое таблиц и индексов, уменьшая размер файлов и минимизируя место</li>\n<li>требует эксклюзивной блокировки на таблицу</li>\n<li>похожим образом работает <code class=\"language-text\">TRUNCATE</code></li>\n<li>требует много места что бы пересоздать файлы</li>\n<li>очень желательно не доводить до этого состояния</li>\n<li><strong>pg_repack</strong> - сторонее расширение позволяющее провернуть все это без блокировки</li>\n</ul>\n<h2>Обновление статистики</h2>\n<p>Фоновый процесс autovacuum - автоматически обновляет статистику при значительных изменениях, использует случайная выборка данных (размер настраивается), используется планировщиком запросов</p>\n<h3>Обновление статистики (анализ) вручную</h3>\n<ul>\n<li><code class=\"language-text\">ANALYZE [таблика]</code></li>\n<li><code class=\"language-text\">vacuumdb --analyze-only</code></li>\n</ul>\n<h3>Очистка и обновление</h3>\n<ul>\n<li><code class=\"language-text\">VACUUM ANALYZE [таблица]</code></li>\n<li><code class=\"language-text\">vacuumdb --analyze</code></li>\n</ul>\n<h2>Обновление карт</h2>\n<p><strong>Карта видимости</strong> - битовая карта страниц с видмыми всем версиями строк (отмечает “давно не менявшиеся” страницы), признак видимости сбрасывается при любом изменении, а устанавливается автоматически в процессе очистки, используется для отпимизации доступ</p>\n<p><strong>Карта свободного пространства</strong> - структура, отмечающая свободное место в страницах, обновляется в том числе при очистке, используется для поиска страниц при вставке новых строк</p>\n<h2>Переполнение и заморозка</h2>\n<p>Номер транзакции 32-битный, пространство номеров закольцовано, старые версии строк “замораживаются” автоочисткой</p>\n<p>Заморозка - берутся версии строк, у которых номер версии достаточно старый и фактически номер заменяется на условное значение минус бесконечности, а так же проставляется спец бит, помечающий строку как замороженную</p>\n<p>Когда счетчик заходит на второй круг, он уже не будет спотыкаться об старые транзакции т.к. их xmin будет минус бесконечность и не будет конфликтовать с вторым кругом счетчика</p>\n<p>Счетчик 32 битный потому что в каждой версии строки есть заголовок (в том числе xmin, xmax), если счетчик 64 бита, то это еще 64 бита на каждую строку, получиться что накладные расходы на служебную информацию будут превышать сами данные</p>\n<h2>Индексы</h2>\n<h3>Лишние индексы</h3>\n<ul>\n<li>не используемые (мониторинг <code class=\"language-text\">pg_stat_all_indexes.idx_scan</code> - если стабильный 0 на продолжительном времени - скорее всего не нужен) дублирующеся или пересекающиеся (запросы к <code class=\"language-text\">pg_index</code> - тут можно попытаться найти индексы которые очееень похожи)</li>\n<li>проблемы - накладные расходы на изменения, место на диске</li>\n<li>решение - удаление лишних индексов (аккуратное)</li>\n</ul>\n<h3>Разрастание индексов</h3>\n<ul>\n<li>мониторинг <code class=\"language-text\">pg_relation_size()</code></li>\n<li>проблемы - место на диске, уменьшение эффективности</li>\n<li>решение - перестроение индексов</li>\n</ul>\n<h2>Перестроение индексов</h2>\n<h3>REINDEX</h3>\n<ul>\n<li><code class=\"language-text\">REINDEX INDEX индекс</code> - перестроить индекс</li>\n<li><code class=\"language-text\">REINDEX TABLE таблица</code> - перестроить все индексы таблицы</li>\n<li><code class=\"language-text\">REINDEX DATABASE база</code> - перстроить все индексы базы</li>\n<li><code class=\"language-text\">REINDEX SYSTEM</code> - пререстроить все индексы</li>\n</ul>\n<p>Примечания</p>\n<ul>\n<li>перестраивает индекс, минимизируя занимаемое место</li>\n<li>устанавливает экслюзивную блокировку</li>\n</ul>\n<h3>VACUUM FULL</h3>\n<ul>\n<li>всесте с таблицей перестраивает и индексы</li>\n<li>также устанавливает экслюзивную блокировку</li>\n</ul>\n<h3>Пересоздание без экслюзивной блокировки</h3>\n<p>CREATE INDEX новый ON … CONCURRENTLY; DROP INDEX старый;</p>\n<ul>\n<li>допускается создание нескольких индексов по одним и тем же полям</li>\n<li>не все типы индексов поддерживают неблокирующее создание</li>\n<li>неблокирующее создание не транзакционно</li>\n<li>неблокирующее создание может завершитьсмя неудачно</li>\n</ul>\n<h3>Индекс с ограничением целостности</h3>\n<p>Эжакий drop create в один заход</p>\n<p>CREATE UNIQUE INDEX новый ON ... CONCURRENTLY;\nALTER TABLE ...\nDROP CONSTRAINT старое,\nADD CONSTRAINT новое [UNIQUE|PRIMARY KEY] USING INDEX новый;</p>\n<h2>Демо</h2>\n<p>Оценить степень разростания объектов, что бы принять решение о полной очистке можно разными способами:</p>\n<ul>\n<li>запросы к системному каталогу</li>\n<li>используя расширение pgstattuple</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> EXTENSION pgstattuple<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- создаем и заполняем табличку</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> bloat<span class=\"token punctuation\">(</span>id <span class=\"token keyword\">serial</span><span class=\"token punctuation\">,</span> s <span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nINSER <span class=\"token keyword\">INTO</span> bloat<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">SELECT</span> g<span class=\"token punctuation\">.</span>id::<span class=\"token keyword\">text</span> <span class=\"token keyword\">FROM</span> generate_series<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">100000</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> g<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> <span class=\"token keyword\">ON</span> bloat<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pgstattuple<span class=\"token punctuation\">(</span><span class=\"token string\">'bloat'</span><span class=\"token punctuation\">)</span> \\gx <span class=\"token comment\">-- больше всего нас интересует tuple_percent - процент заполнения таблицы реальными данными (не будет 100% т.к. есть мета данные, плюс иногда записи между страницами)</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pgstatindex<span class=\"token punctuation\">(</span><span class=\"token string\">'bloat_s_idx'</span><span class=\"token punctuation\">)</span> \\gx <span class=\"token comment\">-- avg_leaf_density - это та же инфа про индекс, leaf_fragmentation - фрагментация</span>\n\n<span class=\"token keyword\">UPDATE</span> bloat <span class=\"token keyword\">SET</span> s <span class=\"token operator\">=</span> s <span class=\"token operator\">||</span> <span class=\"token string\">'!'</span> <span class=\"token keyword\">WHERE</span> id <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pgstattuple<span class=\"token punctuation\">(</span><span class=\"token string\">'bloat'</span><span class=\"token punctuation\">)</span> \\gx <span class=\"token comment\">-- tuple_percent станет 50% (мы ж по сути обновлии половину таблички, соотв для половины строк есть 2 версии, а как следвстие только половина места занята реальными данными)</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pgstattuple_approx<span class=\"token punctuation\">(</span><span class=\"token string\">'bloat'</span><span class=\"token punctuation\">)</span> \\gx <span class=\"token comment\">-- примерная инфа, из случайно выборки, может быть оправданее чем вызов полноценной</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pgstatindex<span class=\"token punctuation\">(</span><span class=\"token string\">'bloat_s_idx'</span><span class=\"token punctuation\">)</span> \\gx <span class=\"token comment\">-- с индексом та же история - avg_leaf_density стал около 50%, а leaf_fragmentation так же 50%</span></code></pre></div>\n<h2>Итоги</h2>\n<ul>\n<li>\n<p>Процесс очистки решает много задачи помимо очистки</p>\n<ul>\n<li>сбор статистики для планировщика</li>\n<li>обновление карти видимости и свободного пространства</li>\n<li>заморозка старых версий строк</li>\n</ul>\n</li>\n<li>\n<p>Автоочистка должна работать, но требует настройки</p>\n</li>\n<li>\n<p>Индексы требуют мониторинга и (иногда) пересоздания</p>\n</li>\n<li>\n<p>Другие задачи сопровождения рассматриваются отдельно</p>\n</li>\n</ul>\n<p>Примечание: постргес не занимается дефрагментацией файлов (имеется в виду на низком уровне файловой системы)</p>\n<h1><a href=\"https://www.youtube.com/watch?v=WPvaaXNI_t4&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=14\">Тема 13 «Роли и атрибуты»</a></h1>\n<h2>Роль</h2>\n<ul>\n<li>пользователь субд</li>\n<li>может включать в себя другие роли - быть “групповой ролью”</li>\n<li>никак не связана с пользователем ОС (хотя некоторые программы берут имя пользователя ОС как имя роли по умолчанию)</li>\n<li>определяется уровне кластера (то есть не на уровне базы, а на уровне сервера)</li>\n<li>псевдороль public - неявно включает в себя все остальные роли (когда надо выдать права всем пользователям)</li>\n</ul>\n<h2>Атрибуты</h2>\n<p>Атрибуты определяют свойства роли</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> ROLE роль <span class=\"token punctuation\">[</span><span class=\"token keyword\">WITH</span><span class=\"token punctuation\">]</span> атрибут <span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> атрибут<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">LOGIN</code> - возможность подключения</li>\n<li><code class=\"language-text\">SUPERUSER</code> - суперпользователь</li>\n<li><code class=\"language-text\">CREATEDB</code> - возможность создания базы данных</li>\n<li><code class=\"language-text\">CREATEROLE</code> - возможность создавать роли</li>\n<li><code class=\"language-text\">REPLICATION</code> - использование протокола репликации</li>\n<li>и другие</li>\n</ul>\n<p>Если не указывать роли, применяются их противовесы, NOLOGIN, NOSUPERUSER, NOCREATEDB, …</p>\n<h2>Участие в групповой роли</h2>\n<p>Включение роли в группу - <code class=\"language-text\">роль1: GRANT группа TO роль2;</code></p>\n<p>Исключение роли из группы - <code class=\"language-text\">роль1: REVOKE группы FROM роль2;</code></p>\n<p>Право управления участем в групповой роли имеют:</p>\n<ul>\n<li>любая роль в самой себе</li>\n<li>роль с атрибутом <code class=\"language-text\">SUPERUSER</code> - в любой роли</li>\n<li>роль с атрибутом <code class=\"language-text\">CREATEROLE</code> - в любой, кроме суперпользовательской</li>\n</ul>\n<h2>Передача права управления</h2>\n<p>Включение в группу с передачей права управления</p>\n<p>роль1: GRANT группа TO роль2 WITH ADMIN OPTION;\n-- теперь роль2 управляет группой, включая передачу права управления и может выполнить\nроль2: GRANT группа TO роль3 WITH ADMIN OPTION;</p>\n<p>-- отзыв права передачи управления\nроль1: REVOKE ADMIN OPTION FOR группа FROM роль2;</p>\n<h2>Владельцы</h2>\n<p>Владелец объекта</p>\n<ul>\n<li>роль, создавшая объект (а также роли, включенные в нее)</li>\n<li>может быть изменен командой <code class=\"language-text\">ALTER … OWNER TO роль</code></li>\n</ul>\n<h2>Демо</h2>\n<p>Примечание, в постгре для обратной совместимости остались users и groups, но по сути это role</p>\n<p>CREATE ROLE alice LOGIN CREATEROLE; -- создаем пользователя alice который может покдлючаться и создавать другие роли\n\\c - alice -- переподключаемся под пользователем\n\\du -- вывести роли\nSELECT usename FROM pg_user; -- вьюха\nALTER ROLE bob NOLOGIN; -- забираем права\nALTER ROLE alice NOCREATEROLE; -- забираем права сами у себя\n\\c - postgres -- переключаенмся в суперпользователя\nGRANT postgres TO alice; -- добавляем пользователя alice в группу супер пользователя\n\\du -- в третьем столбце покажет что alice является членом группы postgres\nALTER ROLE alice SET log_min_duration_statement=0; -- трюк - следим за алисой\nALTER ROLE alice RESET log_min_duration_statement; -- сбрасываем назад\nALTER ROLE alice IN DATABASE test SET log_min_duration_statement=0; -- то же самое только для конретной базы</p>\n<p>-- alice самаа по себе не стала супер пользователем на что это похоже\n\\c - alice -- переключаемся под пользователя alice\nSET ROLE postgres; -- аля sudo su - postgres - перключаемся в пользователя\nSELECT session_user, current_user; -- session_user - выведет пользователя которым подключились и не меняется, current_user - текущий пользовател, изменяектся после set role\nRESET ROLE; -- сбросить роль\nDROP ROLE alice; -- грохнет роль, но не должно быть объектов которыми он владеет в любой из баз на сервере\nREASSIGN OWNED BY alice TO bob; -- переназначаем владельца, может пригодиться при необходимости грохнуть роль\nDROP OWNED BY bob; -- удаляет объекты которым владеет роль</p>\n<h1><a href=\"https://www.youtube.com/watch?v=Kqr6peCmLB8&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=15\">Тема 14 «Привилегии»</a></h1>\n<h2>Виды привилегий</h2>\n<ul>\n<li>\n<p><strong>таблицы</strong></p>\n<ul>\n<li><code class=\"language-text\">select</code> - чтение данных (можно задавать на уровне столбцов)</li>\n<li><code class=\"language-text\">insert</code> - вставка строк (можно задавать на уровне столбцов)</li>\n<li><code class=\"language-text\">update</code> - изменение строк (можно задавать на уровне столбцов)</li>\n<li><code class=\"language-text\">references</code> - внешний ключ (можно задавать на уровне столбцов)</li>\n<li><code class=\"language-text\">delete</code> - удаление строк</li>\n<li><code class=\"language-text\">truncate</code> - очистка таблицы</li>\n<li><code class=\"language-text\">trigger</code> - создание триггеров</li>\n</ul>\n</li>\n<li>\n<p><strong>представления</strong></p>\n<ul>\n<li>select (можно задавать на уровне столбцов?)</li>\n<li>trigger</li>\n</ul>\n</li>\n<li>\n<p><strong>последовательности</strong></p>\n<ul>\n<li><code class=\"language-text\">select</code> - currval</li>\n<li><code class=\"language-text\">update</code> - nextval, setval</li>\n<li><code class=\"language-text\">usage</code> - currval, nextval - текущее значение и следующее</li>\n</ul>\n</li>\n<li>\n<p><strong>табличные пространства</strong></p>\n<ul>\n<li><code class=\"language-text\">create</code></li>\n</ul>\n</li>\n<li>\n<p><strong>база данных</strong></p>\n<ul>\n<li><code class=\"language-text\">create</code></li>\n<li><code class=\"language-text\">connect</code></li>\n<li><code class=\"language-text\">temporary</code> - право на создание временных табличек</li>\n</ul>\n</li>\n<li>\n<p><strong>схемы</strong></p>\n<ul>\n<li><code class=\"language-text\">create</code></li>\n<li><code class=\"language-text\">usage</code> - право пользоватся объектами в схеме</li>\n</ul>\n</li>\n<li>\n<p><strong>функции</strong></p>\n<ul>\n<li><code class=\"language-text\">execute</code> - выполнение с правами <code class=\"language-text\">security invoker</code> - вызвавшего (по умолчанию), <code class=\"language-text\">security definer</code> - создавшего</li>\n</ul>\n</li>\n</ul>\n<h2>Категории ролей</h2>\n<ul>\n<li><strong>суперпользователи</strong> - полный доступ ко всем объектам - проверки не выполняються</li>\n<li><strong>владельцы</strong> - доступ в рамках выданных привилегий (изначально получает полный набор), а также действия, не регламентируемые привилегиями, например: удаление, выдача и отзыв привилегий и т.п.</li>\n<li><strong>остальные роли</strong> - доступ исключительно в рамках выданных привилегий</li>\n</ul>\n<h2>Управление привилегиями</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-- выдача привилегии (одна и та же привилегия может быть независимо выдана разными ролями)\nроль1: GRANT привилегии ON объект TO роль2;\n-- отзыв привилегии\nроль1: REVOKE привилегии ON объект TO роль2;\n\n-- выдача привилегии с правом передачи\nроль1: GRANT привилегии ON объект TO роль2 WITH GRANT OPTION;\n-- отзыв (cascade необходим если привелегии успели быть переданы еще кому либо)\nроль1: REVOKE привилегии ON объект TO роль2 CASCADE;\nроль1: REVOKE GRANT OPTION FOR привилегии ON объект TO роль2 CASCADE;</code></pre></div>\n<h2>Групповые привилегии</h2>\n<p>Роль получает привилегии своих групповых ролей</p>\n<p>Поведение зависит от атрибута роли</p>\n<p>INHERIT (по умолчанию) - автоматически наследует привилегии группы</p>\n<p>NOINHERIT - требуется явное переключение с помощью SET ROLE</p>\n<h3>Преднастроенные роли</h3>\n<ul>\n<li>pg_signal_backend - сигналы обсуживающими процессам (напр позволяет делать pg_reload_conf)</li>\n<li>pg_read_all_settings - чтение конфигурационных параметров</li>\n<li>pg_read_all_stats - доступ к статистике</li>\n<li>pg_stat_scan_tables - статистика, вызывающая блокировки</li>\n</ul>\n<h2>Привилегии public</h2>\n<p>По умолчанию роль public получает ряд привилегий, удобно, но не безопасно</p>\n<ul>\n<li>\n<p>для базы данных</p>\n<ul>\n<li>connect - подключение</li>\n<li>temporary - создание временных таблиц</li>\n</ul>\n</li>\n<li>\n<p>для схемы public</p>\n<ul>\n<li>create - создание объектов</li>\n<li>usage - доступ к объектам</li>\n</ul>\n</li>\n<li>\n<p>для схем pg_catalog и information_schema</p>\n<ul>\n<li>usage - доступ к объектам</li>\n</ul>\n</li>\n<li>\n<p>для функций</p>\n<ul>\n<li>execute - выполнение</li>\n</ul>\n</li>\n</ul>\n<h2>Привилегии по умолчанию</h2>\n<p>Можно задать дефолтные привелегии которые будут применяться по умолчанию</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">PRIVILEGES</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">IN</span> <span class=\"token keyword\">SCHEMA</span> схема<span class=\"token punctuation\">]</span> <span class=\"token keyword\">GRANT</span> привилегии <span class=\"token keyword\">ON</span> класс_объектов <span class=\"token keyword\">TO</span> роль<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- отзыв</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">PRIVILEGES</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">IN</span> <span class=\"token keyword\">SCHEMA</span> схема<span class=\"token punctuation\">]</span> <span class=\"token keyword\">REVOKE</span> привилегии <span class=\"token keyword\">ON</span> класс_объектов <span class=\"token keyword\">TO</span> роль<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- пример REVOKE EXECUTE ON FUNCTIONS FROM public</span></code></pre></div>\n<h2>Демо</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\\c - postgres\n\nCREATE ROLE alice LOGIN;\nCREATE SCHEMA alice;\nGRANT CREATE, USAGE ON SCHEMA alice to alice;\n\n\\c - alice\n\nCREATE TABLE t1(n integer);\nCREATE TABLE t2(n integer, m integer);\n\n\\c - postgres\n\nCREATE ROLE bob LOGIN;\n\n\\c - bob\n\nselect * from alice.t1; -- выдаст ошибку\n\n-- посмотреть какие привелегии у кого есть\n-- роль=привилегии/кем_выданы\n-- U - usage, C - create\n\\db+ alice\n\n\\c - alice\n\nGRANT CREATE, USAGE ON SCHEMA alice to bob; -- выдаст ошибку, т.к. alice не владелец схемы и ей не выдали привилегии на передачу прав\n\n\\c - postgres\n\nALTER SCHEMA alice OWNER TO alice;\n\n\\c - alice\n\nGRANT CREATE, USAGE ON SCHEMA alice to bob;\n\n-- посмотреть привилегии на табличку (по умолчанию пусто)\n\\dp alice.t1\n-- сразу после этого появиться две записи, оригинальная для алисы и новая для боба\nGRANT SELECT ON t1 TO bob;\n-- a - insert\n-- r - select\n-- w - update\n-- d - delete\n-- D - truncate\n-- x - reference\n-- t - trigger\n\n-- разрешаем вставку в обе колонки\nGRANT INSERT(n,m) ON t2 TO bob;\n-- разрешаем чтение только на одну колонку (select * from t2 будет завершаться с ошибкой)\nGRANT SELECT(m) ON t2 TO bob;\n\nGRANT ALL ON t1 TO bob; -- что бы не перечислять, можно выдать все привелегии</code></pre></div>\n<p>Удалять табличку может только владелец или супер пользователь, отдельной привилегии нет</p>\n<p>Привилегия update без select работать не будет, т.к. в начале нужно вычитать, что бы затем обновить</p>\n<p>Знак звездочки рямдо с привилегиями говорит о том что пользователь может их передавать дальше</p>\n<p>Отнимать можно только те привилегии которые были выданы текущим пользователем (то есть я не могу отнять роли, выданные другим пользователем)</p>\n<h1><a href=\"https://www.youtube.com/watch?v=vJfGRQZ58_s&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=16\">Тема 15 «Политики защиты строк»</a></h1>\n<ul>\n<li>политика ограничивает видимость строк в таблца - видимост определяется предикатами, которые вычисляются для каждой строки с правами вызывающего, клиенту доступны только те строки, для которых предикаты истинны</li>\n<li>предиткат для существующих строк - используется операторами sleect, update, delete, при наррушении политикеи не возникает ошибка (если только не сброшен параметр row_security)</li>\n<li>предикат для новых строк - используется операторами insert, update, если не зада, используется первый предикат, при нарушении политики возникает ошибка</li>\n</ul>\n<p>TODO</p>\n<h1><a href=\"https://www.youtube.com/watch?v=-R2iNKuMdmk&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=17\">Тема 16 «Подключение и аутентификация»</a></h1>\n<h2>Задачи при подключении</h2>\n<ul>\n<li><strong>Идентификация</strong> - определение имени пользователя базы, имя может отличаться от указанного (при внешней аутентификации)</li>\n<li><strong>Аутентификация</strong> - действительно ли пользователь тот, за кого себя выдает? обычно требуется подтверждение (например, пароль)</li>\n<li><strong>Авторизация</strong> - имеет ли право данный пользователь подключаться к серверу? частично пересекается с функционалом привилегий</li>\n</ul>\n<h2>Основные настройки</h2>\n<p>pg_hba.conf - конфигурационный файл, при изменение нужно перечитать</p>\n<p>Его настройки можно перевычитать точно так же как и обычные (pg_reload_conf, etc)</p>\n<h3>Поля</h3>\n<ul>\n<li>\n<p>тип подключения</p>\n<ul>\n<li>\n<p>local - локально подключение через unix socket</p>\n</li>\n<li>\n<p>host - подключение по tcp/ip (обычно требуется изменение параметра listen_addresses)</p>\n<ul>\n<li>hostssl - шифрованное ssl-подключение по tcp/ip (сервер должен быть собран с поддежкой ssl, также требуется установить параметр ssl)</li>\n<li>hostnossl - нешифрованное подключение по tcp/ip</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>имя базы данных</p>\n<ul>\n<li>all - подключение к любой базе</li>\n<li>sameuser - базы, совпадающие по имени с ролью</li>\n<li>samerole - базы, совпадающие по имени с ролью или гшрппой, в которую она входит</li>\n<li>replication - специальное разрешения для протокола репликации</li>\n<li>база - конретная база</li>\n<li>имя[, имя…] - несколько баз</li>\n</ul>\n</li>\n<li>\n<p>имя пользователя</p>\n<ul>\n<li>all - любая роль</li>\n<li>роль - роль с указанным именем</li>\n<li>+роль - роль, входящая в указанную роль</li>\n<li>имя[, имя…] - несколько имен из вышеперечисленного</li>\n</ul>\n</li>\n<li>\n<p>адрес узла</p>\n<ul>\n<li>all - любой ip адрес</li>\n<li>ip-адрес/длина_маски - укананный диапазо ip адресов</li>\n<li>samehost - ip адрес сервера</li>\n<li>samenet - любой ip из любой подсети, к которой подключен сервер</li>\n<li>доменное_имя - ip адрес, соотв указанному имени (например domain.com ), допускается указание части имени, начиная с точки (.com), под капотом резолвиться адрес dns</li>\n</ul>\n</li>\n<li>\n<p>метод аутентификации</p>\n<ul>\n<li>\n<p>простые</p>\n<ul>\n<li>trust - допустить без аутентификации</li>\n<li>reject - отказать без аутентификации</li>\n</ul>\n</li>\n<li>\n<p>пароль</p>\n<ul>\n<li>md5 - пароль храниться в субд и шифруется md5</li>\n<li>scram-sha-256 - пароль храниться в субд, используется протокол scram</li>\n<li>ldap [параметры] - пароль храниться на сервере LDAP</li>\n<li>radius [параметры] - пароль храниться на сервере RADIUS</li>\n<li>pam [параметры] - пароль хранится в подключаемом модуле PAM</li>\n</ul>\n</li>\n<li>\n<p>внешнаяя</p>\n<ul>\n<li>peer [map=…] - запрос имени пользоватекля у ядра ОС (для локальных подключений)</li>\n<li>cert [map=…] - аутентификация с использованием клиентского ssl сертификата</li>\n<li>gss [map=… и другие параметры] - аутентификация Kerberos по протоколу GSS API</li>\n<li>sspi [map=… и другие параметры] - аутентификация Kerberos/NTLM для Windows</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>необязательные дополнительные параметры в виду имя=значения</p>\n</li>\n</ul>\n<p>Записи просматриваются сверху вниз, выбирается первая подходящая запись, причем если с ней не получилось, дальше проверки все равно не идут</p>\n<h2>Установить пароль пользователя</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token punctuation\">[</span><span class=\"token keyword\">CREATE</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">ALTER</span><span class=\"token punctuation\">]</span> ROLE <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nPASSWORD <span class=\"token string\">'пароль'</span>\n<span class=\"token punctuation\">[</span> VALID UNTIL дата_время <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Пароли храняться в системно каталоге <code class=\"language-text\">pg_authid</code></p>\n<p>метод шифрования определяеться параметром password_encryption, должны совпадать с конфигом</p>\n<h2>Ввод пароля</h2>\n<ul>\n<li>\n<p>установить переменную <code class=\"language-text\">$PGPASSWORD</code> - неудобно при подключении к разным базам и не безопасно в целом</p>\n</li>\n<li>\n<p>файл с паролями <code class=\"language-text\">~/.pgpass</code> на узле клиента</p>\n<ul>\n<li>строки в формате <code class=\"language-text\">host:port:database:username:password</code></li>\n<li>в качестве значения можно использовать звездочку (любое значение)</li>\n<li>строки просматриваются сверху вниз, выбирается первая подходящая</li>\n<li>файл должен иметь права доступа <code class=\"language-text\">600 (rw- --- ---)</code></li>\n</ul>\n</li>\n</ul>\n<h2>Соответствие имен</h2>\n<p>pg_ident.conf</p>\n<ul>\n<li>название соответствия - указывается в параметре map в pg_hba.conf</li>\n<li>внешнее имя - считается регулярным выражением, если начинается с косой черты</li>\n<li>внутренее имя пользователя БД</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">SHOW hba_file;\n\\! egrep '^[^#]' /usr/local/pgsql/data/pg_hba.conf\nselect line_number, type, database, user_name, address, auth_method from pg_hba_file_rules;\n\\! echo 'local all all trast' >> /usr/local/pgsql/data/pg_hba.conf\nselect line_number, error from pg_hba_file_rules where error is not null;</code></pre></div>\n<h1><a href=\"https://www.youtube.com/watch?v=-V4zzgOVSjg&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=18\">Тема 17 «Резервное копирование»</a></h1>\n<p>Виды:</p>\n<ul>\n<li>логическое - аля просто sql файлики с create table и insert into table</li>\n<li>физическое</li>\n</ul>\n<h2>Логическая копия</h2>\n<p>Команды SQL для восстановления с нуля</p>\n<ul>\n<li>можно сделать копию отдельного объекта или базы</li>\n<li>можно восстановиться на кластере другой основной версии</li>\n<li>можно восстановиться на другой архитектуре</li>\n<li>невысокая скорость</li>\n<li>нет возможности востановиться на точку во времени</li>\n</ul>\n<h3>COPY - копия таблицы</h3>\n<ul>\n<li>Резервное копирование - вывод таблицы или результатов запроса в файла, на консоль или в программу</li>\n<li>Восстановление - добавление строк из файла или с консоли к существующей таблице</li>\n<li>Серверный вариант - команда SQL COPY - файл будет на сервере</li>\n<li>Клиентский вариант - команда psql \\COPY - файл будет на клиенте</li>\n</ul>\n<h3>pg_dump - копия базы</h3>\n<ul>\n<li>\n<p>резервное копирование</p>\n<ul>\n<li>выдает на консоль или в файли либо sql-скрипт либо архив в специальном формате с оглавлением</li>\n<li>поддерживает параллельное выполнение</li>\n<li>позволяет ограничить набор выгружаемых объектов (таблицы, схемы, только DML или только DDL и т.п.)</li>\n</ul>\n</li>\n<li>\n<p>востановление</p>\n<ul>\n<li>SQL-скрипт - psql</li>\n<li>формат с оглавлением - pg_restore</li>\n<li>поддерживает паралелльное выполнение</li>\n<li>новая база должна быть создана из шаблона template0</li>\n<li>заранее должны быть созданы роли и табличные пространства</li>\n<li>после восстановления имеет смысл выполнить сбор статистики</li>\n</ul>\n</li>\n</ul>\n<h3>pg_dumpall - копия кластера</h3>\n<ul>\n<li>\n<p>резервирование</p>\n<ul>\n<li>сохраняет весь кластер, включая роли и табличные пространства</li>\n<li>выдает на консоль или в файл SQL-скирпт</li>\n<li>паралельное выполнение не поддерживается, но можно выгрузить только глобальные объекты и воспользоваться pg_dump</li>\n</ul>\n</li>\n<li>\n<p>востановление</p>\n<ul>\n<li>с помощью psql</li>\n</ul>\n</li>\n</ul>\n<h2>Физическая копия</h2>\n<p>Используется механизм восстановления после сбоя - копия данных и журналы предзаписи (по сути это просто копия файловой системы)</p>\n<ul>\n<li>скорость востановления выше (грубо говоря упирается в скорость дисков)</li>\n<li>можно восстановить кластер на определенный момент времени</li>\n<li>нельзя восстановить отдельную базу данных, только весь кластер</li>\n<li>восстановление только на той же основной версии и архитектуре</li>\n</ul>\n<p><strong>Холодное резервирование</strong></p>\n<p><strong>Горячее резервирование</strong></p>\n<p><strong>файловая система копируется при…</strong></p>\n<p>выключенном сервере</p>\n<p>неаккуратно выключенном серврее</p>\n<p>работающем сервере (нужно специальные средства)</p>\n<p><strong>журналы предварительной записи…</strong></p>\n<p>не нужны</p>\n<p>нужны с последней контрольной точки (находятся в файловой системе)</p>\n<p>нужны за время копирования файловой системы (сервер не должен удалить WAL раньше времени)</p>\n<h3>Автономная копия</h3>\n<ul>\n<li>\n<p>Автономная копия содержит и файлы данных и WAL</p>\n</li>\n<li>\n<p>Резервное копирование - утилита - pg_basebackup</p>\n<ul>\n<li>подключается к серверу по протоколу репликации</li>\n<li>выполняет контрольную точку</li>\n<li>переключается на следующий сегмент WAL</li>\n<li>копирует файловую систему в указанный каталог</li>\n<li>переключается на следующий сегмент WAL</li>\n<li>сохраняет все сегменты WAL, сгенерированные за время копирования</li>\n</ul>\n</li>\n<li>\n<p>Восстановление</p>\n<ul>\n<li>разворачиваем созданную автономную копию</li>\n<li>запускаем сервер</li>\n</ul>\n</li>\n</ul>\n<h3>Протокол репликации</h3>\n<ul>\n<li>\n<p>протокол - получение потока журнальных записей, команды управления резервным копированием и репликацией</p>\n</li>\n<li>\n<p>обсулживается процессом wal_sender - создается для каждого клиента</p>\n</li>\n<li>\n<p>параметр wal_level = replica</p>\n</li>\n<li>\n<p>слот репликации - мы как бы говорим “использовать” слот такой то, тем самым постгрес, перед удалением не нужных wal свериться с слотами репликации</p>\n<ul>\n<li>серверный объект для получения журнальных записей</li>\n<li>помнит, какая запись была считана последней</li>\n<li>сегмент wal не удаляется, пока он полностью не прочитан через слот</li>\n</ul>\n</li>\n</ul>\n<h3>Архив журналов</h3>\n<ul>\n<li>\n<p><strong>Файловый архив</strong></p>\n<ul>\n<li>\n<p>сегменты wal копируются в архив по мере заполнения</p>\n</li>\n<li>\n<p>механизм работает под управлением сервера</p>\n</li>\n<li>\n<p>неизбежны задержки попадания данных в архив (пока до конца не заполнился текущий лог, он не попадет в архи)</p>\n</li>\n<li>\n<p>процесс archiver</p>\n<ul>\n<li>archive_mode = on</li>\n<li>archive_command - команда shell для копирования только что освободившегося wal файла куда мы укажем</li>\n<li>archive_timeout - максимально время для переключения на новый сегмент wal</li>\n<li>алгоритм - при заполнении сегмента wal вызывается archive_command, если команда завершается со статусом 0, сегмент удлаляется, иначе - сегмент остается до тех пор, пока попытка не будет успешной</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>Потоковый архив</strong></p>\n<ul>\n<li>\n<p>в архив постоянно записывается поток журнальных записей</p>\n</li>\n<li>\n<p>требуются внешние средства</p>\n</li>\n<li>\n<p>задержки минимальны</p>\n</li>\n<li>\n<p>утилита pg_receivewal</p>\n<ul>\n<li>подключается по протоколу репликации (можно использовать слот) и направляет поток записей wal в файлы-сегменты</li>\n<li>стартовая позиция - начало сегмента, следующего за последним заполненным сегментом, найденным в каталоге, или начало текущего сегмента сервере, если каталог пустой</li>\n<li>в отличие от файлового архива, записи пишутся постоянно при переходе на новый сервер надо перенастраивать параметры</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2>Резервная копия + архив</h2>\n<ul>\n<li>\n<p>настроенное непрерывное арихвирование журналов</p>\n</li>\n<li>\n<p>резервное копирование - pg_basebackup</p>\n<ul>\n<li>подключаемся к серверу по протоколу репликации</li>\n<li>выполняем контрольую точку</li>\n<li>переключается на следующий сегнмент WAL</li>\n<li>копирует файловую систему в указанные каталог (сегменты wal в копии не нужны)</li>\n<li>переключается на следующий сегмент wal</li>\n</ul>\n</li>\n<li>\n<p>восстановление</p>\n<ul>\n<li>разворачиваем резервную копию</li>\n<li>создаем управляющий файла $PGDATA/recovery.conf (чтение wal из архива, указание целевой точки восстановыление)</li>\n<li>запускаем сервер</li>\n</ul>\n</li>\n</ul>\n<h2>Демо</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span> setting <span class=\"token keyword\">from</span> pg_settings <span class=\"token keyword\">where</span> name <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'wal_level'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'max_wal_senders'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- wal_level - replica по умолчанию</span>\n<span class=\"token comment\">-- max_wal_senders != 0 - а как следствие можно подключаться</span>\n<span class=\"token keyword\">select</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">database</span><span class=\"token punctuation\">,</span> user_name<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">,</span> auth_method <span class=\"token keyword\">from</span> pg_hba_file_rules<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token keyword\">database</span> <span class=\"token operator\">=</span><span class=\"token string\">'{replication}'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- по умолчанию включены и разрешены для лоокальных подключения=</span></code></pre></div>\n<h1><a href=\"https://www.youtube.com/watch?v=03wNXENAbIk&#x26;list=PLaFqU3KCWw6JhHBp07QSu9uE8zahhKnTn&#x26;index=19\">Тема 18 «Репликация»</a></h1>\n<h2>Виды</h2>\n<ul>\n<li>\n<p><strong>физическая</strong></p>\n<ul>\n<li>мастер-реплка - поток данных только в одну сторону</li>\n<li>трансляция потока журнальных записей или файлов журнала</li>\n<li>требуется двоичная совместимость серверов</li>\n<li>возможно репликация только всего кластера</li>\n</ul>\n</li>\n<li>\n<p><strong>логическая</strong></p>\n<ul>\n<li>поставщик-подписчик - поток данных возможен в обе стороны</li>\n<li>информация о строках (уровеень журнала logical)</li>\n<li>требуется совместимость на уровне протокола</li>\n<li>возможна выборочная репликация отдельных таблиц</li>\n</ul>\n</li>\n</ul>\n<h2>Задачи</h2>\n<ul>\n<li>\n<p><strong>репликация</strong> - процесс синхронизации нескольких копий кластера баз данных на разных серверах</p>\n<ul>\n<li><strong>отказоустойчивость</strong> - при выходе из строя одного из серверов система должна сохранить доступность (возможна деградация производительности)</li>\n<li><strong>масштабируемость</strong> - распределение нагрузки между серверами</li>\n</ul>\n</li>\n</ul>\n<p>Вопросы автоматизации переключения и перенаправления запросов решаются внешними средствами</p>\n<h2>Физическая репликация</h2>\n<p>Резервная копия:</p>\n<ul>\n<li>базовая резервная копия - pg_basebackup</li>\n<li>журналы упреждающей записи - непрерывное архивирование</li>\n</ul>\n<p>Непрерывное восстановление</p>\n<ul>\n<li>разворачиваем резервную копию</li>\n<li>создаем управляющий файл recovery.conf (standby_mode = on) и запускаем сервер</li>\n<li>сервер восстанавливает согласованность и продолжает применять поступающие журналы</li>\n<li>доставка - поток по протоколу репликации или архив wal</li>\n<li>подключаения (только для чтения) разрешаются сразу после восстановления согласованности</li>\n</ul>\n<h3>Использование реплики</h3>\n<ul>\n<li>\n<p>Допускается</p>\n<ul>\n<li>запросы на чтение данных (select, copy to, курсоры)</li>\n<li>установка парметров сервера (set, reset)</li>\n<li>управление транзакциями (begin, commit, rollback…)</li>\n<li>создание реззервной копии (pg_basebackup)</li>\n</ul>\n</li>\n<li>\n<p>Не допускаются</p>\n<ul>\n<li>любые изменения (insert, update, delete, truncate, nextval…)</li>\n<li>блокировки, пдепологающие изменения (select for update…)</li>\n<li>команды DDL (create, drop…) в том числе создание временных таблиц</li>\n<li>команды сопровождения (vacuum, analyze, reindex…)</li>\n<li>управление доступом (grant, revoke…)</li>\n<li>не срабатывают триггеры и пользовательские (advisory) блокировки</li>\n</ul>\n</li>\n</ul>\n<h3>Переключение на реплику</h3>\n<ul>\n<li><strong>плановое переключение</strong> - останов основного сервера для технических работ без прерывания обслуживание , ручной режим</li>\n<li><strong>аварийное переключение</strong> - переход на реплику из-за сбоя основного сервера, ручной режим, но в принципе можно автоматизировать с помощью дополнительного ПО</li>\n</ul>\n<h3>Восстановление мастера</h3>\n<ul>\n<li><strong>простое подключение бывшего мастера</strong> - не работает - проблема потери записей wal, не попавших на реплику из-за задержки</li>\n<li><strong>востановление “с нуля” из резервной копии</strong> - на месте бывшего мастера разворачивается абсолютно новая реплика, процесс занимает много времени (отчасти можно ускорить rsync)</li>\n<li><strong>утилита pg_rewind</strong> - “откатывает” потерянные записи wal, заменяя соответствующие страницы на диске страницами с нового мастера, есть ряд ограничений, ограничивающий применение</li>\n</ul>\n<h2>Логическая репликация</h2>\n<ul>\n<li>\n<p>Поставщик</p>\n<ul>\n<li>выдает изменения данных построчно в порядке их фиксации (реплицируются команды insert, update, delete)</li>\n<li>возможна начальная синхронизация</li>\n<li>всегда используется слот логической репликации</li>\n<li>параметр wal_level = logical</li>\n</ul>\n</li>\n<li>\n<p>Подписчик</p>\n<ul>\n<li>получает и применяет изменения</li>\n<li>без разбора, трансформаций и планирование - сразу выполнение</li>\n<li>возможны конфликты с локальными данными</li>\n</ul>\n</li>\n</ul>\n<h2>Конфликты</h2>\n<ul>\n<li>\n<p>режимы идентификации для изменения и удаления</p>\n<ul>\n<li>столбцы первичного ключа (по умолчанию)</li>\n<li>столбцы указанного уникального индекса с ограничением not null</li>\n<li>все столбцы</li>\n<li>без идентификации (по умолчанию для системного каталога)</li>\n</ul>\n</li>\n<li>\n<p>конфликты - нарушение ограничений целостности</p>\n<ul>\n<li>репликация приостанавливается до устранения конфликта вручную либо исправления данных, либо пропуск конфликтующей транзакции</li>\n</ul>\n</li>\n</ul>\n<p>На основном сервере</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_stat_replication \\gx</code></pre></div>\n<ul>\n<li>state - streaming</li>\n<li>sync_state - async</li>\n<li>sent_lsn - то что послали</li>\n<li>werite_lsn - подтверждение от реплики</li>\n<li>flush_lsn - реплика записала на диск</li>\n<li>replay_lsn - реплика проиграла</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token identifier\"><span class=\"token punctuation\">`</span>\\dRs<span class=\"token punctuation\">`</span></span> <span class=\"token comment\">-- выведет список подписчиков</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_stat_subscription \\gx</code></pre></div>\n<p>Если репликация больше не нужна, надо аккуаратно удалить подписку - иначе публикующем сервере останеться открытым репликационный слот</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DROP</span> SUBSCRIPTION demo<span class=\"token punctuation\">;</span></code></pre></div>"}},"pageContext":{"id":"4e812c8e-1152-5bdb-914b-2d11151b4d51"}},"staticQueryHashes":[],"slicesMap":{}}