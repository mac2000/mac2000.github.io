{"componentChunkName":"component---src-templates-note-js","path":"/powershell-iis-mass-site-bindings-change-ip/","result":{"data":{"remark":{"fields":{"path":"powershell-iis-mass-site-bindings-change-ip"},"meta":{"title":""},"headings":[{"value":"PowerShell IIS mass site bindings change ip"}],"html":"<h1>PowerShell IIS mass site bindings change ip</h1>\n<p>If u do not do so before run:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Set-ExecutionPolicy</span> remotesigned</code></pre></div>\n<p>Not right click on PowerShell and choose Import all modules.</p>\n<p>Or in powershell try this:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Import-Module</span> WebAdministration\n<span class=\"token function\">Get-Command</span> WebAdministration\\<span class=\"token operator\">*</span></code></pre></div>\n<p>Here is some samples that was on my way to dzen</p>\n<p>Setting up bindings examples:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Set-WebConfigurationProperty</span> <span class=\"token string\">\"/system.applicationHost/sites/site[@name='local.rabota.ua']/bindings/binding[@protocol='http']\"</span> <span class=\"token operator\">-</span>name bindingInformation <span class=\"token operator\">-</span>value <span class=\"token string\">'127.0.0.1:80:local.rabota.ua'</span>\n<span class=\"token function\">Set-WebConfigurationProperty</span> <span class=\"token string\">\"/system.applicationHost/sites/site[@name='local.rabota.ua']/bindings/binding[@protocol='http']\"</span> <span class=\"token operator\">-</span>name bindingInformation <span class=\"token operator\">-</span>value <span class=\"token string\">'[::1]:80:local.rabota.ua'</span></code></pre></div>\n<p>List domain &#x3C;-> site</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$sites</span> = @<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token function\">Get-Website</span> <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$site_name</span> = <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span> <span class=\"token function\">Get-WebBinding</span> <span class=\"token operator\">-</span>name <span class=\"token variable\">$site_name</span> <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$sites</span><span class=\"token punctuation\">.</span>Add<span class=\"token punctuation\">(</span><span class=\"token namespace\">[regex]</span>::replace<span class=\"token punctuation\">(</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>bindingInformation<span class=\"token punctuation\">,</span> <span class=\"token string\">'.*?:80:'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$site_name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n<span class=\"token variable\">$sites</span></code></pre></div>\n<p>And here it is:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Get-WebConfigurationProperty</span> <span class=\"token operator\">-</span><span class=\"token keyword\">filter</span> <span class=\"token string\">\"/system.applicationHost/sites/site/bindings/binding[@protocol='http']\"</span> <span class=\"token operator\">-</span>name bindingInformation <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$site_binding</span> = <span class=\"token namespace\">[regex]</span>::replace<span class=\"token punctuation\">(</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>itemXPath<span class=\"token punctuation\">,</span> <span class=\"token string\">\".*?@bindingInformation='.*?:80:(.*?)'.*\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"`<span class=\"token variable\">$1</span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">Set-WebConfigurationProperty</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>itemXPath <span class=\"token operator\">-</span>name bindingInformation <span class=\"token operator\">-</span>value <span class=\"token string\">\"[::1]:80:<span class=\"token variable\">$site_binding</span>\"</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>We are getting all bindings, then from xpath we getting domain name, and change binding to new ip.</p>\n<p>Now u can make sheduled task on dhcp ip change to change all sites ip</p>\n<p>And here is sample how i change ip</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">net stop w3svc\nnetsh http show iplisten\nnetsh http delete iplisten ::1\nnetsh http add iplisten ipaddress=<span class=\"token string\">\"192.168.56.1:80\"</span>\nnetsh http show iplisten\n<span class=\"token function\">Get-WebBinding</span>\n<span class=\"token function\">Get-WebConfigurationProperty</span> <span class=\"token operator\">-</span><span class=\"token keyword\">filter</span> <span class=\"token string\">\"/system.applicationHost/sites/site/bindings/binding[@protocol='http']\"</span> <span class=\"token operator\">-</span>name bindingInformation <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$site_binding</span> = <span class=\"token namespace\">[regex]</span>::replace<span class=\"token punctuation\">(</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>itemXPath<span class=\"token punctuation\">,</span> <span class=\"token string\">\".*?@bindingInformation='.*?:80:(.*?)'.*\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"`<span class=\"token variable\">$1</span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token function\">Set-WebConfigurationProperty</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>itemXPath <span class=\"token operator\">-</span>name bindingInformation <span class=\"token operator\">-</span>value <span class=\"token string\">\"192.168.56.1:80:<span class=\"token variable\">$site_binding</span>\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token function\">Get-WebBinding</span>\nnet <span class=\"token function\">start</span> w3svc</code></pre></div>\n<p>Do not forget to change your hosts file, but better setup DNS</p>\n<p>When run power shell do not forget to run:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">import-module</span> webadministration</code></pre></div>\n<p>After some research noticed that there is no need to change webbinding, so script going to be more easier:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$connection_name</span> = <span class=\"token string\">\"lan\"</span>\n<span class=\"token function\">Import-Module</span> WebAdministration\n<span class=\"token function\">Get-Website</span> <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">Stop-Website</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>name <span class=\"token punctuation\">}</span>\nnet stop w3svc\n<span class=\"token variable\">$connection_index</span> = <span class=\"token punctuation\">(</span><span class=\"token function\">gwmi</span> <span class=\"token operator\">-</span>query <span class=\"token string\">\"SELECT Index FROM Win32_NetworkAdapter WHERE NetConnectionID='<span class=\"token variable\">$connection_name</span>'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Index\n<span class=\"token variable\">$new_ip</span> = <span class=\"token punctuation\">(</span><span class=\"token function\">gwmi</span> <span class=\"token operator\">-</span>query <span class=\"token string\">\"SELECT IPAddress FROM Win32_NetworkAdapterConfiguration WHERE Index=<span class=\"token variable\">$connection_index</span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>IPAddress <span class=\"token punctuation\">|</span> <span class=\"token function\">select-string</span> <span class=\"token operator\">-</span>Pattern <span class=\"token string\">'[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+'</span>\nnetsh http show iplisten\n<span class=\"token variable\">$current_iplisten_ips</span> = netsh http show iplisten <span class=\"token punctuation\">|</span> <span class=\"token function\">select-string</span> <span class=\"token operator\">-</span>Pattern <span class=\"token string\">'[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+'</span> <span class=\"token operator\">-</span>AllMatches <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>Matches <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>Value <span class=\"token punctuation\">}</span>\n<span class=\"token variable\">$current_iplisten_ips</span> <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> netsh http delete iplisten <span class=\"token variable\">$_</span> <span class=\"token punctuation\">}</span>\nnetsh http add iplisten ipaddress=<span class=\"token variable\">$new_ip</span>\nnetsh http show iplisten\nnet <span class=\"token function\">start</span> w3svc\n<span class=\"token function\">Get-Website</span> <span class=\"token punctuation\">|</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">Start-Website</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>name <span class=\"token punctuation\">}</span></code></pre></div>\n<p>All we do is change iplisten, and in IIS leave all binding listen <code class=\"language-text\">*</code>.</p>"}},"pageContext":{"id":"1f8ecfe8-8417-5ca2-b348-c2131b4384f1"}},"staticQueryHashes":[],"slicesMap":{}}