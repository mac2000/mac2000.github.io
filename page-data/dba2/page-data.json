{"componentChunkName":"component---src-templates-note-js","path":"/dba2/","result":{"data":{"remark":{"fields":{"path":"dba2"},"meta":{"title":""},"headings":[{"value":"DBA2-10 Тема 1 «Изоляция»"},{"value":"DBA2-10 Тема 2 «Страницы и версии строк»"},{"value":"DBA2-10 Тема 3 «Снимки данных»"},{"value":"DBA2-10 Тема 4 «HOT-обновления»"},{"value":"DBA2-10 Тема 5 «Очистка»"},{"value":"DBA2-10 Тема 6 «Автоочистка»"},{"value":"DBA2-10 Тема 7 «Заморозка»"},{"value":"DBA2-10 Тема 8 «Буферный кэш»"},{"value":"DBA2-10 Тема 9 «Журнал предзаписи»"},{"value":"DBA2-10 Тема 10 «Контрольная точка»"},{"value":"DBA2-10 Тема 11 «Настройка журнала»"}],"html":"<h1><a href=\"https://www.youtube.com/watch?v=xLfXYCpALNY\">DBA2-10 Тема 1 «Изоляция»</a></h1>\n<p><strong>Транзакция</strong> - множество операций, которые переводят базу данных из одного корректного состояни в другое корретное (соглассованость) при условии, что транзакция выполнена полностью (атомарность) и без помех со стороны других транзакций (изоляция)</p>\n<p><strong>Атомарность</strong> - транзакция либо выполняется полностью, либо не оставляет никаких следов</p>\n<p><strong>Согласованность</strong> определяет ограничениями целостности и семантикой приложения</p>\n<p>Неполная изоляция приводит к нарушению корректности (аномалиям) при конкурентном выполнении</p>\n<p>Возможные аномалии (согласно стандарту, но на деле их больше):</p>\n<ul>\n<li>“грязное” чтение - запрос видит незафиксированные изменения других транзакций</li>\n<li>неповторяющееся чтение - повторное чтение строки вернет другое значение, если оно было изменено (и зафиксировано) другой транзакцией (тут про ячейки)</li>\n<li>фантомное чтение - повторный запрос по одниоу и тому же условию вернет иную выборку, если другая транзакция добавила (и зафиксировала) новые строки, удовлетворяюще этому условию (тут про строки)</li>\n<li>остутсвие всяких аномалий - результат выполнения транзакций совпадает с результатом последовательного выполнения транзакций</li>\n</ul>\n<h2>Уровни изоляции (согласно стандарта)</h2>\n<p>| <strong>Грязное чтение</strong>  | <strong>неповторяющееся чтение</strong> | <strong>фантомное чтение</strong> | <strong>другие аномалии</strong> |\n| ------------------- | -------------------------- | -------------------- | ------------------- | --- |\n| <strong>Read Uncommited</strong> | да                         | да                   | да                  | да  |\n| <strong>Read Committed</strong>  | -                          | да                   | да                  | да  |\n| <strong>Repeatable Read</strong> | -                          | -                    | да                  | да  |\n| <strong>Serializable</strong>    | -                          | -                    | -                   | -   |</p>\n<p>на всех уровнях не допускается потеря зафиксированных изменений</p>\n<h2>Уровни изоляции postgres</h2>\n<p>| <strong>Грязное чтение</strong>                | <strong>неповторяющееся чтение</strong> | <strong>фантомное чтение</strong> | <strong>другие аномалии</strong> |\n| --------------------------------- | -------------------------- | -------------------- | ------------------- | --- |\n| <strong>Read Committed (по умолчанию)</strong> | -                          | да                   | да                  | да  |\n| <strong>Repeatable Read</strong>               | -                          | -                    | -                   | да  |\n| <strong>Serializable</strong>                  | -                          | -                    | -                   | -   |</p>\n<h2>Демо</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> transaction_isolation<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- текущий уровень изоляции</span>\n<span class=\"token keyword\">SHOW</span> default_transaction_isolation<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- значение по умолчанию</span></code></pre></div>\n<p>В read committed данные вычитываются согласованно на начало запуска оператора</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> pg_sleep<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> demo<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- пока ждем 2 сек, табличка поменялась, но мы не увидим этих изменений</span></code></pre></div>\n<p>Обновляющие транзакции, в случае конфликтов, вынужденны перевычитать данные (перечитываются только измененные строки)</p>\n<h1><a href=\"https://www.youtube.com/watch?v=eP_lEFJFLzo\">DBA2-10 Тема 2 «Страницы и версии строк»</a></h1>\n<ul>\n<li>Страницы (8кб)\n<ul>\n<li>табличная страница\n<ul>\n<li>заголовок страницы (24 байта)</li>\n<li>указатели на версии строк (массив)</li>\n<li>строка\n<ul>\n<li>заголовок весрии строки</li>\n<li>версия строки</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>страница индекса\n<ul>\n<li>заголовок страницы (24 байта)</li>\n<li>указатели на версии строк (массив)</li>\n<li>специальная область (специфичные данные для разных видов индексов)</li>\n<li>строка\n<ul>\n<li>индексируемое значение</li>\n<li>указатель на версию строки в странице таблички (обратная ссылка)</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>Благодаря тому что индексы ссылаются только на указатели сами данные внутри страничек можно реорганизовать никак не трогая индекс</p>\n<p>Указатели на версии строк хранят:</p>\n<ul>\n<li>статус версии строки</li>\n<li>указатель на версию строки и ее длина</li>\n</ul>\n<p>Версии строк в табличной странице</p>\n<p>За это критикуют postgres, т.к. вне зависимости от размера строки будет всегда плюс 24 байта</p>\n<ul>\n<li>xmin committerd, xmin aborted - биты позволяющие ответить на статус завершения транзакции xmin</li>\n<li>ctid - указатель на следующую версию этой же строки (аля linked list), если следующей версии нет - указатель смотрит сам на себя</li>\n</ul>\n<p>Для индексов все в принципе так же, за исключением того что за вместо данных мы храним сам ключ (значения колонок), а ссылка ведет на саму строку</p>\n<p>В индексе нет xmin, xmax, по этому смотря в индекс нельзя сказать должна ли быть видна эта строка, из-за чего необходимо идти в табличку за xmin, xmax после чего уже становиться понятно</p>\n<p>Страницы читаются в оперативную память “как есть”, данные неперносимы между разными платформами, между полями данных возможны пропуски из-за выравнивания</p>\n<h2>Вставка</h2>\n<p>xmax aborted выставился в ture, что говорит о том что еще нет транзакции удалившей эту версию и поле xmax можно игнорить</p>\n<p>XACT - журнал транзакций, здесь мы видим что транзакция под номером 100 все еще жужжит</p>\n<p>После комита, в строке ничего не происходит (бит как был так и не проставлялся) последующие запросы будут ходить и сверяться с журналом XACT и уже последующая транзакция выполнив эту проверку проставит этот бит</p>\n<p>Это может быть читающая транзакция</p>\n<p>Интересный пример, после COPY перегона большого объема данных, потом если выполнить <code class=\"language-text\">select count(*)</code> будет большая дисковая активность, так как этот sleect начнет проставлять битики</p>\n<p>Выставлять сразу не выходит т.к. нужно помнить кучу мест где мы меняли и сам коммит станет дорогим т.к. мы будетм всюду бегать и повторно менять</p>\n<p>Commit дешевый, но плата за это - следующая транзакиция читающая эту строку будет чуть дольше так как будет сверять и обновлять байты</p>\n<p>проставляем 101 в xmax, транзакция по все еще бежит (так же ведет себя select for update)</p>\n<p>следующая транзакция видит xmax и то что 101 еще не завершилась - как следствие строка заблокированна и надо ждать</p>\n<p>так же как и с commit, при вызове rollback обновляется xact, но биты в строке не меняются, бит в строке будет обновлен когда будет обращение от последующей строки</p>\n<p>при обновлении мы проставляем 102 в xmax старой версии</p>\n<p>содаем новую версию в которой 102 будет в xmin, ссылка старой строки обновляется и смотрит на новую версию</p>\n<p>в индексе так же появляется вторая строка ссылающаяся на вторую версию</p>\n<p>Каждый выполняемый запрос - это транзакция, как следствие будет иметь свой номер, при выполнении транзакции внтури другой транзакции база трекает их и следит за тем что бы применилось все сразу</p>\n<h2>Вложенные транзакции</h2>\n<ul>\n<li>собственный номер и статус в XACT - конечный статус зависит от статуса основной тразакции</li>\n<li>информация о вложенности сохраняется на диске\n<ul>\n<li>каталог <code class=\"language-text\">$PGDATA/pg_subtrans/</code></li>\n<li>данные кэшируются в буферах общей памяти (аналогично XACT)</li>\n</ul>\n</li>\n<li>примеры использования\n<ul>\n<li>точка SAVEPOINT</li>\n<li>обработка исключений в PL/pgSQL (EXCEPTION)</li>\n<li>режим <code class=\"language-text\">psql ON_ERROR_ROLLBACK = on/interactive</code></li>\n</ul>\n</li>\n</ul>\n<h2>Пример</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> t<span class=\"token punctuation\">(</span>id <span class=\"token keyword\">serial</span><span class=\"token punctuation\">,</span> s <span class=\"token keyword\">text</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> t_s <span class=\"token keyword\">ON</span> t<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- что бы изучить структуру страницы и версий строк, есть расширение pageinspect</span>\n<span class=\"token keyword\">CREATE</span> EXTENSION pageinspect<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- вьюха что бы смотреть</span>\n<span class=\"token comment\">-- get_raw_page - читает сырые байтики без понимание что это</span>\n<span class=\"token comment\">-- heap_page_items - парсит именно табличную страничку</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">VIEW</span> t_v <span class=\"token keyword\">AS</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token string\">'(0,'</span><span class=\"token operator\">||</span>lp<span class=\"token operator\">||</span><span class=\"token string\">')'</span> <span class=\"token keyword\">AS</span> ctid<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">CASE</span> lp_flags\n         <span class=\"token keyword\">WHEN</span> <span class=\"token number\">0</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'unused'</span>\n         <span class=\"token keyword\">WHEN</span> <span class=\"token number\">1</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'normal'</span>\n         <span class=\"token keyword\">WHEN</span> <span class=\"token number\">2</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'redirect to '</span><span class=\"token operator\">||</span>lp_off\n         <span class=\"token keyword\">WHEN</span> <span class=\"token number\">3</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'dead'</span>\n       <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> state<span class=\"token punctuation\">,</span>\n       t_xmin <span class=\"token keyword\">as</span> xmin<span class=\"token punctuation\">,</span>\n       t_xmax <span class=\"token keyword\">as</span> xmax<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> <span class=\"token punctuation\">(</span>t_infomask <span class=\"token operator\">&amp;</span> <span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span>  <span class=\"token keyword\">THEN</span> <span class=\"token string\">'t'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> xmin_c<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> <span class=\"token punctuation\">(</span>t_infomask <span class=\"token operator\">&amp;</span> <span class=\"token number\">512</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span>  <span class=\"token keyword\">THEN</span> <span class=\"token string\">'t'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> xmin_a<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> <span class=\"token punctuation\">(</span>t_infomask <span class=\"token operator\">&amp;</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'t'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> xmax_c<span class=\"token punctuation\">,</span>\n       <span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> <span class=\"token punctuation\">(</span>t_infomask <span class=\"token operator\">&amp;</span> <span class=\"token number\">2048</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'t'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> xmax_a<span class=\"token punctuation\">,</span>\n       t_ctid\n<span class=\"token keyword\">FROM</span> heap_page_items<span class=\"token punctuation\">(</span>get_raw_page<span class=\"token punctuation\">(</span><span class=\"token string\">'t'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> lp<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- похожее представление для индекса</span>\n<span class=\"token comment\">-- у индекса первая страничка 0 - занята служебными данными, потому тут мы читаем 1-ю</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">VIEW</span> t_s_v <span class=\"token keyword\">AS</span>\n<span class=\"token keyword\">SELECT</span> itemoffset<span class=\"token punctuation\">,</span>\n       ctid\n<span class=\"token keyword\">FROM</span> bt_page_items<span class=\"token punctuation\">(</span><span class=\"token string\">'t_s'</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>В сессии</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> t<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'FOO'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> txid_current<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 493</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> t_v<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- похожее но менее информативное</span>\n<span class=\"token keyword\">SELECT</span> xmin<span class=\"token punctuation\">,</span> xmax<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> t<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> t_v<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- ничего не поменялось</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> t<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> t_v<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- а вот теперь будут байтики</span></code></pre></div>\n<h2>Стурктура странички</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> lower<span class=\"token punctuation\">,</span> upper<span class=\"token punctuation\">,</span> special<span class=\"token punctuation\">,</span> pagesize <span class=\"token keyword\">FROM</span> page_header<span class=\"token punctuation\">(</span>get_raw_page<span class=\"token punctuation\">(</span><span class=\"token string\">'t'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>0 - начало заголвка странички и указатели на версии строк</li>\n<li>lower - начало свободного места</li>\n<li>upper - начало данных (версий строк)</li>\n<li>special - начало спец. данных (только для индексов)</li>\n<li>pagesize - конец страницы</li>\n<li>от 0 до lower - занимает заголовок странички (24 байта) и массив указателей - можно ответить на вопрос сколько указателей</li>\n<li>от lower до upper - это свободное место</li>\n<li>от upper до special - это занятое место</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=C-Wjk6NqVCU\">DBA2-10 Тема 3 «Снимки данных»</a></h1>\n<p>Снимок - дает согласованную картину данных на момент времени (видны только зафиксированные на этот момент данные)</p>\n<p>Создается</p>\n<ul>\n<li>read commited - в начале каждого оператора</li>\n<li>repeatable read, serializable - в начале первого оператора транзакции</li>\n</ul>\n<h2>Видимость версий строк</h2>\n<ul>\n<li>видимость версии строки ограничена xmin и xmax</li>\n<li>версия попадает в снимок, когда\n<ul>\n<li>изменения транзакции xmin видны для снимка</li>\n<li>изменения транзакции xmax не видны для снимка</li>\n</ul>\n</li>\n<li>изменения транзакции видны, когда\n<ul>\n<li>либо это та же самая тразакция, что создала снимок</li>\n<li>либо она звершилась фиксацией до момента создания снимка</li>\n</ul>\n</li>\n<li>отдельные правила для видимости собственных изменений\n<ul>\n<li>учитывается порядковый номер операции в транзакции (cmin/cmax)</li>\n</ul>\n</li>\n</ul>\n<h2>Снимок данных</h2>\n<ul>\n<li>номер самой ранней активной транзакции</li>\n<li>номер следующей транзакции (еще не существующей)</li>\n<li>список активных транзакций</li>\n<li>горизонт - точка до которой проходит autovacuum</li>\n<li>пока транзакция висит - автовакуум не может продвигаться вперед</li>\n<li><code class=\"language-text\">old_snapshot_threshold</code> - время, на которое транзакции разрешено транзакции держать снимок, вакууму разрешено удалять строки, если транзакции понадобяться строки она завершиться с ошибкой и откатиться</li>\n<li><code class=\"language-text\">idle_in_transaction_session_timeout</code> - прибивать транзакции которые ничего не делают но держат вакуум</li>\n</ul>\n<h2>Виртуальные транзакции</h2>\n<p>Только читающая транзакция никак не влияет на видимость</p>\n<ul>\n<li>обслуживающий процесс выделает виртуальный номер</li>\n<li>виртуальный номер не учитывается в снимках</li>\n<li>виртуальный номер никогда не попадает в страницы</li>\n<li>“настроящий” номер выделяется при первом изменении данных</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> txid_current<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">--</span>\n<span class=\"token keyword\">select</span> txid_current_if_assigned<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- более честный\\оптимальный способ узнать свой номер</span>\n<span class=\"token keyword\">select</span> txid_current_snapshot<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- xmin:xmax:xip_list</span>\n<span class=\"token keyword\">select</span> backend_xmin <span class=\"token keyword\">from</span> pg_stat_activity <span class=\"token keyword\">where</span> pid <span class=\"token operator\">=</span> pg_backend_pid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- горизонт</span></code></pre></div>\n<h1><a href=\"https://www.youtube.com/watch?v=rfWAZ52KN4s\">DBA2-10 Тема 4 «HOT-обновления»</a></h1>\n<h2>Проблемы обновления</h2>\n<ul>\n<li>при любом обновлении строки надо изменять индекс - страдает производительность вставок и изменений</li>\n<li>в индексе накапливаются ссылки на неактуальные версии - размер индекса растет, требуется очистка</li>\n<li>все сложности умножаются на количество индексов, построенных по таблице</li>\n</ul>\n<h2>HOT-обновление</h2>\n<ul>\n<li>HOT - heap only tuple</li>\n<li>heap - подразумевается табличка</li>\n<li>tuple - кортеж, строка</li>\n<li>heap only tuple - эта версия строки находиться только в таблице и на нее нет ссылок из индекса</li>\n<li>heap hot upd - признак что было обновлено HOT</li>\n<li>заскочив в табличку пойдет по heap hot upd - пока не встретит false</li>\n</ul>\n<h2>HOT-обновления</h2>\n<ul>\n<li>Обновляемый столбей не долджен входить ни в один индекс - иначе на версию строки будет ссылка из индекса и ее нельзя пометить как heap only</li>\n<li>Цепочка обновлений - только в пределах одной страницы\n<ul>\n<li>не требуется обращение к другим страница, обход цепочки не ухудшает производительность</li>\n<li>если в табличной странице не хватает места для новой версии, цепочка обрывается (как если бы оптимизация не работала)</li>\n<li>место в странице можно зарезервировать. уменьшив параметр хранения таблицы fillfactor (100% → 10%)</li>\n</ul>\n</li>\n</ul>\n<h2>Внутристраничная очистка</h2>\n<ul>\n<li>выполняется при любом обращении к старнице\n<ul>\n<li>если ранее выполненное обновление не нашло места для новой версии строки на этой же странице</li>\n<li>если страница заполнена больше, чем на fillfactor</li>\n</ul>\n</li>\n<li>действует в пределах одной табличной страницы\n<ul>\n<li>не освобождает указатели, на которые могут ссылаться индексы</li>\n<li>не обновляет карту свободного пространтсва</li>\n<li>не обновляет карту видимости</li>\n</ul>\n</li>\n</ul>\n<p>Происходит зачистка, но индекс не трогается, т.к. это другая страничка</p>\n<p>Примечания:</p>\n<ul>\n<li>фактическую очистку проведет вакуум</li>\n<li>индекс, впервые сходив и увидев что колонка dead пометит и у себя как мерткую</li>\n<li>unused - это как бы по умолчанию, можно использовать</li>\n<li>теоретически очистка внутри странички может прям укладываться в страничку и как следствие и вакууму делать ничего не надо будет</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=aHzIqZJDiOY\">DBA2-10 Тема 5 «Очистка»</a></h1>\n<h2>Обычная очистка</h2>\n<ul>\n<li>выполняется командой VACUUM - не конфликтует с обычной активностью в системе</li>\n<li>обрабатывает таблицу и все ее индексы\n<ul>\n<li>очищает ненужные версии строк в табличных страницах (пропуская страницы, уже отмеченные в карте видимости)</li>\n<li>очищает индексные записи, ссылающиеся на очищенные версии страниц</li>\n<li>освобождает указатели</li>\n<li>обновляет карту свободного пространтсва - спец структура, в которой для таблицы храняться “дырки” куда можно вставить новые строки</li>\n<li>обновляет карту видимости - для каждой странички выставляется бит, являются ли все версии на этой страничке видимыми для всех пользователей (аля можно не чистить)</li>\n</ul>\n</li>\n</ul>\n<p><code class=\"language-text\">maintenance_work_mem</code> - сюда складываются указатели которые нужно зачищать</p>\n<h2>Мониторинг</h2>\n<ul>\n<li><code class=\"language-text\">VACUUM VERBOSE</code> - будет выводить инфу о том что он сейчас делает</li>\n<li>представление <code class=\"language-text\">pg_stat_progress_vacuum</code>\n<ul>\n<li>полный размер таблицы</li>\n<li>число прочитанных страниц и число очищенных страниц</li>\n<li>количество уже завершенных циклов очистки индексов</li>\n<li>число идентификаторов версий строк, помещающихся в память и текущее число идентификаторов в памяти</li>\n<li>текущая фаза очистки</li>\n</ul>\n</li>\n</ul>\n<h2>Регулирование нагрузки</h2>\n<ul>\n<li>процесс чередует работу и ожидание - примерно vacuum_cost_limit условных единиц работы, затем засыпает на vacuum_cost_delay мс</li>\n<li>настройки\n<ul>\n<li>vacuum_cost_limit = 200</li>\n<li>vacuum_cost_delay = 0ms</li>\n<li>стоимость обработки\n<ul>\n<li>vacuum_cost_page_hit = 1 - страницы в кэше</li>\n<li>vacuum_cost_page_miss = 10 - страницы на диске (нет в памяти, нужно вычитать с диска)</li>\n<li>vacuum_cost_page_dirty = 20 - грязной страницы (означает что нужно будет записать на диск)</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2>Анализ</h2>\n<ul>\n<li>выполняется при VACUUM ANALYZE или ANALYZE - не конфликтует с обычной активностью в системе</li>\n<li>собирает статистику для планировщика</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=JDqG8kHwrTY\">DBA2-10 Тема 6 «Автоочистка»</a></h1>\n<h2>Autovacuum launcher</h2>\n<p>для каждой баззы данных (в которой есть активность) запускать рабочий процесс раз в autovacuum_naptime, количесво рабочих процессов &#x3C; autovacuum_max_workers</p>\n<p>Настройки</p>\n<ul>\n<li>autovacuum = on</li>\n<li>track_counts = on # required, иначе автовакуум не будет знать куда ходить</li>\n<li>autovacuum_naptime = 60s</li>\n<li>autovacuum_max_workers=3</li>\n</ul>\n<h2>Autovacuum worker</h2>\n<p>выполнять по очереди очистку всех таблиц (включая TOAST), в которых число ненужных версий строк превышает <code class=\"language-text\">autovacuum_vacuum_threshold + autovacuum_vacuum_scale_factory * число строк в таблице</code></p>\n<p>а так же выполнять анализ всех таблиц, в которых число изменившихся версий стррок превышает <code class=\"language-text\">autovacuum_analyze_threshold + authovacuum_analyze_scale_factor * число строк в табличке</code></p>\n<p>в одной БД может параллельно работать несколько процессов</p>\n<p>Настройки автоочистки</p>\n<ul>\n<li>autovacuum_vacuum_threshold = 50</li>\n<li>autovacuum_vacuum_scale_factor = 0.2 # рекомендуется уменьшать, скажем 5, 3, 2 процента, т.к. 20% на некоторых сетапах это может уже быть очееень много, можно устанавливать отдельно на каждую табличку, см примеры ниже</li>\n</ul>\n<p>Параметры хранения таблиц</p>\n<ul>\n<li>autovacuum_enabled</li>\n<li>toast.autovacuum_enabled</li>\n<li>autovacuum_vacuum_threshold</li>\n<li>toast.autovacuum_vacuum_threshold</li>\n<li>autovacuum_vacuum_scale_factor</li>\n<li>toast.autovacuum_vacuum_scale_factor</li>\n</ul>\n<h2>Мониторинг</h2>\n<ul>\n<li>log_autovacuum_min_duration</li>\n<li>pg_stat_progress_vacuum</li>\n</ul>\n<h2>Подход к настройке</h2>\n<ul>\n<li>баланс между разрастанием и накладными расходами - итеративный процесс</li>\n<li>основные параметры\n<ul>\n<li>autovacuum_vacuum_scale_factor - частота обработки (понизить на порядок)</li>\n<li>autovacuum_max_workers - параллелизм (по умолчанию 3, стоит увеличить, но надо не забыть увеличить лимиты, иначе нет смысла)</li>\n<li>autovacuum_vacuum_cost_limit - скорость работы (увеличить пропорционально кол-ву рабочих)</li>\n<li>индивидуальная настройка важных таблиц параметрами хранения</li>\n</ul>\n</li>\n<li>мониторинг\n<ul>\n<li>разрастание таблиц</li>\n<li>очередь таблиц, ожидающих очистки</li>\n<li>нагрузка на диски</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> mvcc_autovacuum<span class=\"token punctuation\">;</span>\n\\c mvcc_autovacuum\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> tvac<span class=\"token punctuation\">(</span>id <span class=\"token keyword\">serial</span><span class=\"token punctuation\">,</span> n <span class=\"token keyword\">numeric</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tvac<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">SELECT</span> <span class=\"token number\">1</span> <span class=\"token keyword\">FROM</span> generate_series<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- Выставим настройки автоочистки.</span>\n<span class=\"token comment\">-- Небольшое время ожидания, чтобы сразу видеть результат:</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> autovacuum_naptime <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- Один процент строк:</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> autovacuum_vacuum_scale_factor <span class=\"token operator\">=</span> <span class=\"token number\">0.01</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- Нулевой порог:</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> autovacuum_vacuum_threshold <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- Выставим настройки автоанализа.</span>\n<span class=\"token comment\">-- Два процента строк:</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> autovacuum_analyze_scale_factor <span class=\"token operator\">=</span> <span class=\"token number\">0.02</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- Нулевой порог:</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> autovacuum_analyze_threshold <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- Перечитаем настройки:</span>\n<span class=\"token keyword\">SELECT</span> pg_reload_conf<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">-- Создадим представление, показывающее, нуждается ли наша таблица в очистке.</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">VIEW</span> vacuum_v <span class=\"token keyword\">AS</span>\n<span class=\"token keyword\">WITH</span> params <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">SELECT</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> setting::<span class=\"token keyword\">integer</span>\n          <span class=\"token keyword\">FROM</span>   pg_settings\n          <span class=\"token keyword\">WHERE</span>  name <span class=\"token operator\">=</span> <span class=\"token string\">'autovacuum_vacuum_threshold'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> vacuum_threshold<span class=\"token punctuation\">,</span>\n         <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> setting::<span class=\"token keyword\">float</span>\n          <span class=\"token keyword\">FROM</span>   pg_settings\n          <span class=\"token keyword\">WHERE</span>  name <span class=\"token operator\">=</span> <span class=\"token string\">'autovacuum_vacuum_scale_factor'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> vacuum_scale_factor\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">SELECT</span> st<span class=\"token punctuation\">.</span>relname<span class=\"token punctuation\">,</span>\n       st<span class=\"token punctuation\">.</span>n_dead_tup dead_tup<span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>vacuum_threshold <span class=\"token operator\">+</span> p<span class=\"token punctuation\">.</span>vacuum_scale_factor<span class=\"token operator\">*</span>c<span class=\"token punctuation\">.</span>reltuples<span class=\"token punctuation\">)</span>::<span class=\"token keyword\">integer</span> max_dead_tup<span class=\"token punctuation\">,</span>\n       st<span class=\"token punctuation\">.</span>n_dead_tup <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>vacuum_threshold <span class=\"token operator\">+</span> p<span class=\"token punctuation\">.</span>vacuum_scale_factor<span class=\"token operator\">*</span>c<span class=\"token punctuation\">.</span>reltuples<span class=\"token punctuation\">)</span>::<span class=\"token keyword\">integer</span> need_vacuum<span class=\"token punctuation\">,</span>\n       st<span class=\"token punctuation\">.</span>last_autovacuum\n<span class=\"token keyword\">FROM</span>   pg_stat_all_tables st<span class=\"token punctuation\">,</span>\n       pg_class c<span class=\"token punctuation\">,</span>\n       params p\n<span class=\"token keyword\">WHERE</span>  c<span class=\"token punctuation\">.</span>oid <span class=\"token operator\">=</span> st<span class=\"token punctuation\">.</span>relid\n<span class=\"token operator\">AND</span>    c<span class=\"token punctuation\">.</span>relname <span class=\"token operator\">=</span> <span class=\"token string\">'tvac'</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> vacuum_v<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- relname | dead_tup | max_dead_tup | need_vacuum | last_autovacuum</span>\n<span class=\"token comment\">-----------+----------+--------------+-------------+-----------------</span>\n<span class=\"token comment\">-- tvac    |        0 |           10 | f           |</span>\n\n<span class=\"token comment\">-- Таблица не требует очистки (0 ненужных версий) и ни разу не очищалась.</span>\n\n<span class=\"token comment\">-- Можно создать аналогичное представление и для анализа:</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">VIEW</span> analyze_v <span class=\"token keyword\">AS</span>\n<span class=\"token keyword\">WITH</span> params <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">SELECT</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> setting::<span class=\"token keyword\">integer</span>\n          <span class=\"token keyword\">FROM</span>   pg_settings\n          <span class=\"token keyword\">WHERE</span>  name <span class=\"token operator\">=</span> <span class=\"token string\">'autovacuum_analyze_threshold'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> analyze_threshold<span class=\"token punctuation\">,</span>\n         <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> setting::<span class=\"token keyword\">float</span>\n          <span class=\"token keyword\">FROM</span>   pg_settings\n          <span class=\"token keyword\">WHERE</span>  name <span class=\"token operator\">=</span> <span class=\"token string\">'autovacuum_analyze_scale_factor'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> analyze_scale_factor\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">SELECT</span> st<span class=\"token punctuation\">.</span>relname<span class=\"token punctuation\">,</span>\n       st<span class=\"token punctuation\">.</span>n_mod_since_analyze mod_tup<span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>analyze_threshold <span class=\"token operator\">+</span> p<span class=\"token punctuation\">.</span>analyze_scale_factor<span class=\"token operator\">*</span>c<span class=\"token punctuation\">.</span>reltuples<span class=\"token punctuation\">)</span>::<span class=\"token keyword\">integer</span> max_mod_tup<span class=\"token punctuation\">,</span>\n       st<span class=\"token punctuation\">.</span>n_mod_since_analyze <span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>analyze_threshold <span class=\"token operator\">+</span> p<span class=\"token punctuation\">.</span>analyze_scale_factor<span class=\"token operator\">*</span>c<span class=\"token punctuation\">.</span>reltuples<span class=\"token punctuation\">)</span>::<span class=\"token keyword\">integer</span> need_analyze<span class=\"token punctuation\">,</span>\n       st<span class=\"token punctuation\">.</span>last_autoanalyze\n<span class=\"token keyword\">FROM</span>   pg_stat_all_tables st<span class=\"token punctuation\">,</span>\n       pg_class c<span class=\"token punctuation\">,</span>\n       params p\n<span class=\"token keyword\">WHERE</span>  c<span class=\"token punctuation\">.</span>oid <span class=\"token operator\">=</span> st<span class=\"token punctuation\">.</span>relid\n<span class=\"token operator\">AND</span>    c<span class=\"token punctuation\">.</span>relname <span class=\"token operator\">=</span> <span class=\"token string\">'tvac'</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">-- Таблица не требует анализа; автоанализ уже был выполнен.</span>\n\n<span class=\"token comment\">-- Отключим автоочистку на уровне таблицы и изменим 11 строк (больше 1 %):</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> tvac <span class=\"token keyword\">SET</span> <span class=\"token punctuation\">(</span>autovacuum_enabled <span class=\"token operator\">=</span> <span class=\"token keyword\">off</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> tvac <span class=\"token keyword\">SET</span> n <span class=\"token operator\">=</span> n <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">WHERE</span> id <span class=\"token operator\">&lt;=</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> vacuum_v<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- relname | dead_tup | max_dead_tup | need_vacuum | last_autovacuum</span>\n<span class=\"token comment\">-----------+----------+--------------+-------------+-----------------</span>\n<span class=\"token comment\">-- tvac    |       11 |           10 | t           |</span>\n\n<span class=\"token comment\">-- Как видно, таблице требуется автоочистка.</span>\n<span class=\"token comment\">-- Включим автоочистку для таблицы и подождем несколько секунд...</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> tvac <span class=\"token keyword\">SET</span> <span class=\"token punctuation\">(</span>autovacuum_enabled <span class=\"token operator\">=</span> <span class=\"token keyword\">on</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> vacuum_v<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- relname | dead_tup | max_dead_tup | need_vacuum |        last_autovacuum</span>\n<span class=\"token comment\">-----------+----------+--------------+-------------+-------------------------------</span>\n<span class=\"token comment\">-- tvac    |        0 |           10 | f           | 2019-08-12 17:15:32.258085+03</span></code></pre></div>\n<h1><a href=\"https://www.youtube.com/watch?v=jjV_f6KJ9JI\">DBA2-10 Тема 7 «Заморозка»</a></h1>\n<p>Это история про второй круг счетчика транзакций</p>\n<h2>Настройка</h2>\n<ul>\n<li>vacuum_freeze_min_age - минимальный возраст, с которого начинается заморозка</li>\n<li>vacuum_freeze_table_age - при достижении такого возраста замораживаются версии строк на всех страницах, используется карта заморозки</li>\n<li>autovacuum_freeze_max_age - при достижении такого возраста заморозка запускается принудительно, определяет размер XACT</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=u64ZfwKoR-w\">DBA2-10 Тема 8 «Буферный кэш»</a></h1>\n<p>Диск - большой но медленный</p>\n<p>ОЗУ - быстрая но мало</p>\n<p>Отводим в памяти кусок, в котором кэшируем данные которые читаем с диска</p>\n<p>Буферный кэш - это общая для всех процессов область памяти, в которой находиться массив буфферов.</p>\n<p>Каждый буфекр это место под страничку данных (8кб) плюс заголовок</p>\n<p><code class=\"language-text\">shared_buffers</code> - определяет кол-во этих буферов, требует перезапуска, захватывается сразу</p>\n<p>В заголовке буфера информация о том от куда пришла страница (файл, номер страницы внутри файла и т.п.) там же счетчик обращений к буферу (что бы понимать какие буфферы активно используются, а какие нет). Так же есть флаг помечающий буфер как грязный (поменялись данные, требуется сохранение на диск)</p>\n<p>При запуске сервера, все буферы пустые, и храняться в виде списка, есть указатели на свободные буферы и “следующую жертву” которая будет вытесняться</p>\n<p>Так же в памяти храниться хэш таблица для быстрого перехода к нужному буферу</p>\n<p>Несколько процессов могут “закрепить” один и тот же буффер (pincount), эдакая мягкая блокировка, не разрешает страничку выкинуть из буфера, но при этом позволяет ее менять</p>\n<h2>Настройка размера кэша</h2>\n<ul>\n<li>настройка shared_buffers = 128MB - очень мало</li>\n<li>буферный кэш должен содержать “активные” данные\n<ul>\n<li>при меньшем размере постоянно вытеняются полезные страницы</li>\n<li>при большем размере бессмысленно расхуд накладные расходы</li>\n<li>начальное приближение - 0.25 ОЗУ (рекомендация с потолка, с чего начать)</li>\n</ul>\n</li>\n<li>нужно учитывать двойное кэширование\n<ul>\n<li>если страницы нет в кэше СУБД, она может оказаться в кэше ОС</li>\n<li>алгоритм вытеснения ОС не учитывает специфики базы данных</li>\n</ul>\n</li>\n</ul>\n<h2>Временные таблицы</h2>\n<ul>\n<li>данные временных таблиц - видны только одному секансу - нет смысла использовать общий кэш, существуют в перделах сеанса - не жалко потерять при сбое</li>\n<li>используется локальный буферный кэш\n<ul>\n<li>не требуются блокировки</li>\n<li>память выделяется по необходимости в пределах temp_buffers</li>\n<li>обычный алгорит вытеснения</li>\n</ul>\n</li>\n</ul>\n<p>постгрес 11 умеет запоминать что было в буферном кэше и после перезапуска “прогревать” его</p>\n<h1><a href=\"https://www.youtube.com/watch?v=q-aQ3GxjAbc\">DBA2-10 Тема 9 «Журнал предзаписи»</a></h1>\n<h2>Логическое устройство</h2>\n<ul>\n<li>последовательность записей</li>\n<li>номер записи - 64 битный LSN (log sequence number)</li>\n<li>специальный тип pg_lsn</li>\n</ul>\n<h2>Физическое йстройство</h2>\n<ul>\n<li>В памяти - кольцевой буферный кэш wal_buffers = -1 - означает 1/32 от shared_buffers</li>\n<li>На диске - файлы (сегменты) по 16мб, $PGDATA/pg<em>wal/000100010001 - ветка</em>времени:start_lsn:end_lsn?</li>\n</ul>\n<h2>Упреждающая запись</h2>\n<ul>\n<li>Когда мы хотим что либо поменять в буферном кэше - мы помещаем ее в wal, получаем адрес этой записи pg_current_wal_insert_lsn(), полученный lsn выставляем в странице</li>\n<li>При фиксации транзакции ставим бит в XACT, после чего создаем новую запись в WAL и снова получаем lsn, который прописываем в xact</li>\n<li>При вытеснении страницы из кэша, если у странички есть lsn который еще не на диске, вначале сбрасываем на диск wal</li>\n</ul>\n<p>pg_current_wal_lsn() -- то что меньше, уже на диске\npg_current_wal_insert_lsn() - голова</p>\n<h2>Упрощенный алгоритм востановления</h2>\n<p>при старте сервера после сбоя (состояние кластера в pg_control отличается от shutdown)</p>\n<ul>\n<li>для каждой журнальной записи\n<ul>\n<li>определить страницу, к которой относиться эта запись</li>\n<li>применить запись, если ее lsn больше, чем lsn страницы</li>\n</ul>\n</li>\n<li>перезаписаать нежурналируемые табличцы init-файлами</li>\n</ul>\n<h1><a href=\"https://www.youtube.com/watch?v=dO2RQ-35J2A\">DBA2-10 Тема 10 «Контрольная точка»</a></h1>\n<p>checkpoint_completion_target = 0.5</p>\n<p>checkpoint_timeout = 5min – обычно делают пореже, 30-60 мин</p>\n<p>max_wal_size = 1Gb</p>\n<h1><a href=\"https://www.youtube.com/watch?v=45nlw9uz0oU\">DBA2-10 Тема 11 «Настройка журнала»</a></h1>\n<h2>Уровни журнала</h2>\n<ul>\n<li><strong>minimal</strong> - воставновление после сбоя</li>\n<li><strong>replica</strong> - по умолчанию, восстановление из резервной копии, репликация плюс операции массовой обработки данных, блокировки</li>\n<li><strong>logical</strong> - логическая репликация плюс информация для логического декодирования</li>\n</ul>\n<p>Чем выше уровень, тем больше размер журнала</p>"}},"pageContext":{"id":"715e5a99-0ca7-5d39-a727-2f9b13a9acad"}},"staticQueryHashes":[],"slicesMap":{}}