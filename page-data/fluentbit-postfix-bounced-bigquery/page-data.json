{"componentChunkName":"component---src-templates-note-js","path":"/fluentbit-postfix-bounced-bigquery/","result":{"data":{"remark":{"fields":{"path":"fluentbit-postfix-bounced-bigquery"},"meta":{"title":""},"headings":[{"value":"fluentbit postfix stream bounced emails to bigquery"}],"html":"<h1>fluentbit postfix stream bounced emails to bigquery</h1>\n<p>Installing fluent bit described in <a href=\"https://docs.fluentbit.io/manual/installation/linux/ubuntu\">docs</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> <span class=\"token parameter variable\">-qO</span> - https://packages.fluentbit.io/fluentbit.key <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> apt-key <span class=\"token function\">add</span> -\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'deb https://packages.fluentbit.io/ubuntu/focal focal main'</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/apt/sources.list.d/fluentbit.list\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> td-agent-bit\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> td-agent-bit start\n<span class=\"token function\">sudo</span> systemctl status td-agent-bit</code></pre></div>\n<p>As described in docs we can run fluentbit without any configs by passing all configurations as command line arguments like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/opt/td-agent-bit/bin/td-agent-bit <span class=\"token parameter variable\">-i</span> systemd <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">-p</span> <span class=\"token assign-left variable\">systemd_filter</span><span class=\"token operator\">=</span>_SYSTEMD_UNIT<span class=\"token operator\">=</span>postfix@-.service <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">-p</span> <span class=\"token assign-left variable\">tag</span><span class=\"token operator\">=</span><span class=\"token string\">'host.*'</span> <span class=\"token parameter variable\">-o</span> stdout</code></pre></div>\n<blockquote>\n<p>Also we can grab some journals from <code class=\"language-text\">/var/log/journal/xxxxxxxx/*.journal</code> and pass <code class=\"language-text\">Path</code> parameter to fluentbit</p>\n</blockquote>\n<p><strong>parsers.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[PARSER]\n    name postfix_smtp_bounced\n    format regex\n    regex (?&lt;id>[^:]+): to=&lt;(?&lt;to>[^>]+)>, relay=(?&lt;relay>(none|[^\\[]+))(\\[(?&lt;ip>[^\\]]+)\\]:(?&lt;port>\\d+))?, delay=(?&lt;delay>[^,]+), delays=(?&lt;receive>[^\\/]+)\\/(?&lt;queue>[^\\/]+)\\/(?&lt;conn>[^\\/]+)\\/(?&lt;send>[^,]+), dsn=(?&lt;dsn>[^,]+), status=(?&lt;status>[^ ]+) \\((?&lt;msg>[^\\)]+)\\)</code></pre></div>\n<p>There are many more interesting stuff in postfix logs, here are few other <a href=\"/074061403a090aa592294a6797a454d5/parsers.conf\">parsers</a></p>\n<p>And here is a sample configuration which was used to parse dumped journal</p>\n<p><strong>td-agent-bit.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[SERVICE]\n    Flush        1\n    daemon       Off\n    Log_Level    warn\n    Parsers_File bqp.conf\n\n[INPUT]\n    name             systemd\n    Systemd_Filter   _SYSTEMD_UNIT=postfix@-.service\n    Systemd_Filter   _COMM=smtp\n    Systemd_Filter_Type And\n    Read_From_Tail   Off\n    Path             /data/\n    Strip_Underscores On\n    alias smtp\n    tag smtp\n    Mem_Buf_Limit 128MB\n\n[FILTER]\n    Name record_modifier\n    Match smtp\n    Whitelist_key MESSAGE\n\n[FILTER]\n    name grep\n    match smtp\n    regex MESSAGE status=bounced\n\n[FILTER]\n    name parser\n    match smtp\n    key_name MESSAGE\n    parser postfix_smtp_bounced\n\n[FILTER]\n    name grep\n    match smtp\n    # regex MESSAGE .+\n    exclude MESSAGE .+\n\n[FILTER]\n    Name record_modifier\n    Match smtp\n    # Whitelist_key id\n    Whitelist_key to\n\n[OUTPUT]\n    name   stdout\n    format json_lines\n    match smtp\n\n[OUTPUT]\n    name   bigquery\n    match  smtp\n    google_service_credentials /data/creds.json\n    project_id demo\n    dataset_id dev\n    table_id   postfix\n    skip_invalid_rows On\n    ignore_unknown_values On\n    Retry_Limit 5</code></pre></div>\n<p>With this setup we have our bounced emails in bigquery table</p>\n<p>Notes:</p>\n<ul>\n<li>While testing bigquery output can be commented out</li>\n<li>To test whether all messages were parsed replace <code class=\"language-text\">exclude MESSAGE .+</code> with <code class=\"language-text\">regex MESSAGE .+</code> in filter</li>\n<li>We can have multiple <code class=\"language-text\">input -> filter -> output</code> chains (e.g. if we want to have successfull emails side by side with bounced)</li>\n</ul>\n<p><strong>Additional headers</strong></p>\n<p>Same way as HTTP requests, emails have their <a href=\"https://www.iana.org/assignments/message-headers/message-headers.xhtml\">headers</a> which also can be logged</p>\n<p>For this to work, somewhere in main.cf add</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">header_checks = regexp:/etc/postfix/header_checks</code></pre></div>\n<p>with contents like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/^subject:/      WARN\n/^X-FOO:/        INFO</code></pre></div>\n<p>after that in logs there will be records like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Jan 23 16:29:08 demo postfix/smtpd[448165]: 4JflJ44pRZzVg5M: client=unknown[173.110.42.141]\nJan 23 16:29:08 demo postfix/cleanup[448186]: 4JflJ44pRZzVg5M: info: header X-Foo: hello from unknown[173.110.42.141]; from=&lt;noreply@mac-blog.org.ua> to=&lt;marchenko.alexandr@gmail.com> proto=ESMTP helo=&lt;bsg>\nJan 23 16:29:08 demo postfix/cleanup[448186]: 4JflJ44pRZzVg5M: info: header Subject: hello from unknown[173.110.42.141]; from=&lt;noreply@mac-blog.org.ua> to=&lt;marchenko.alexandr@gmail.com> proto=ESMTP helo=&lt;bsg>\nJan 23 16:29:08 demo postfix/cleanup[448186]: 4JflJ44pRZzVg5M: message-id=&lt;>\nJan 23 16:29:08 demo postfix/qmgr[448161]: 4JflJ44pRZzVg5M: from=&lt;noreply@mac-blog.org.ua>, size=438, nrcpt=1 (queue active)\nJan 23 16:29:08 demo postfix/smtpd[448165]: disconnect from unknown[173.110.42.141] ehlo=1 mail=1 rcpt=1 data=1 quit=1 commands=5\nJan 23 16:29:09 demo postfix/smtp[448187]: 4JflJ44pRZzVg5M: to=&lt;marchenko.alexandr@gmail.com>, relay=gmail-smtp-in.l.google.com[108.177.14.26]:25, delay=0.96, delays=0.13/0.01/0.48/0.35, dsn=2.0.0, status=sent (250 2.0.0 OK  1642688949 g25si2880938lfh.217 - gsmtp)\nJan 23 16:29:09 demo postfix/qmgr[448161]: 4JflJ44pRZzVg5M: removed</code></pre></div>"}},"pageContext":{"id":"3e244caf-a9f7-5cb2-bdaa-d81d30d65ef6"}},"staticQueryHashes":[],"slicesMap":{}}