{"componentChunkName":"component---src-templates-note-js","path":"/migrate-redis-node/","result":{"data":{"remark":{"fields":{"path":"migrate-redis-node"},"meta":{"title":""},"headings":[{"value":"Migrate Redis Node"},{"value":"redis.conf"},{"value":"Redis service"},{"value":"sentinel.conf"},{"value":"Sentinel service"},{"value":"Slave"},{"value":"Sentinel"},{"value":"Save configs"},{"value":"Failover"},{"value":"Forget old nodes"},{"value":"Restore?"}],"html":"<h1>Migrate Redis Node</h1>\n<p>Note of migrating redis from srv17 to srv16</p>\n<h1>redis.conf</h1>\n<p>Note: everything needed - do not forget correct ip address into bind</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bind 192.168.0.16\nport 6379\nnotify-keyspace-events \"AKE\"\nmaxmemory 9765625kb\nmaxmemory-policy allkeys-lru\nslave-read-only yes\nrepl-diskless-sync yes</code></pre></div>\n<h1>Redis service</h1>\n<p>Install service</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-server.exe --service-install C:<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>Redis-x64-3.2.100<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>redis.conf\n\n<span class=\"token punctuation\">[</span><span class=\"token number\">4132</span><span class=\"token punctuation\">]</span> <span class=\"token number\">17</span> May <span class=\"token number\">10</span>:59:21.136 <span class=\"token comment\"># Granting read/write access to 'NT AUTHORITY\\NetworkService' on: \"C:\\Redis-x64-3.2.100\" \"C:\\Redis-x64-3.2.100\\\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token number\">4132</span><span class=\"token punctuation\">]</span> <span class=\"token number\">17</span> May <span class=\"token number\">10</span>:59:21.137 <span class=\"token comment\"># Redis successfully installed as a service.</span></code></pre></div>\n<p>Start service</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-server.exe --service-start\n\n<span class=\"token punctuation\">[</span><span class=\"token number\">1508</span><span class=\"token punctuation\">]</span> <span class=\"token number\">17</span> May <span class=\"token number\">11</span>:04:19.567 <span class=\"token comment\"># Redis service successfully started.</span></code></pre></div>\n<p>Check if redis is alive</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token function\">ping</span>\n\nPONG</code></pre></div>\n<h1>sentinel.conf</h1>\n<p>Note: same way as with redis - do not forget to change bind</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bind 192.168.0.16\nport 26379</code></pre></div>\n<h1>Sentinel service</h1>\n<p>Install service</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-server.exe --service-install --service-name redissentinel C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.100<span class=\"token punctuation\">\\</span>sentinel.conf <span class=\"token parameter variable\">--sentinel</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token number\">5144</span><span class=\"token punctuation\">]</span> <span class=\"token number\">17</span> May <span class=\"token number\">11</span>:22:07.334 <span class=\"token comment\"># Granting read/write access to 'NT AUTHORITY\\NetworkService' on: \"C:\\Redis-x64-3.2.100\" \"C:\\Redis-x64-3.2.100\\\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token number\">5144</span><span class=\"token punctuation\">]</span> <span class=\"token number\">17</span> May <span class=\"token number\">11</span>:22:07.335 <span class=\"token comment\"># Redis successfully installed as a service.</span></code></pre></div>\n<p>Start service</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> sc start redissentinel\n\nSERVICE_NAME:  redissentinel\n        TYPE:  <span class=\"token number\">10</span>  WIN32_OWN_PROCESS\n        STATE:  <span class=\"token number\">4</span>  RUNNING</code></pre></div>\n<p>Check if whitnes is alive</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> <span class=\"token function\">ping</span>\n\nPONG</code></pre></div>\n<p>Note: i was not able to start/delete servicevia <code class=\"language-text\">redis-server</code> by its name, to delete use <code class=\"language-text\">sc delete redissentinel</code></p>\n<h1>Slave</h1>\n<p>Added to <code class=\"language-text\">redis.conf</code> line <code class=\"language-text\">slaveof 192.168.0.17 6379</code> (srv17 was master at moment) and restarted service, now srv16 is slave of srv17</p>\n<p>Role srv17</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 info replication <span class=\"token operator\">|</span> findstr role\n\nrole:slave</code></pre></div>\n<p>Who is master right now:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 info replication <span class=\"token operator\">|</span> findstr master_host\n\nmaster_host:192.168.0.17</code></pre></div>\n<h1>Sentinel</h1>\n<p>Start monitoring mycluster, saying who is master now, his port and number of nodes in quorum</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel monitor mycluster <span class=\"token number\">192.168</span>.0.17 <span class=\"token number\">6379</span> <span class=\"token number\">2</span>\n\nOK</code></pre></div>\n<p>Check if sentinel sees master</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel get-master-addr-by-name mycluster\n\n<span class=\"token number\">1</span>. <span class=\"token string\">\"192.168.0.17\"</span>\n<span class=\"token number\">2</span>. <span class=\"token string\">\"6379\"</span></code></pre></div>\n<p>Adding configuration changes</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel <span class=\"token builtin class-name\">set</span> mycluster down-after-milliseconds <span class=\"token number\">5000</span>\n\nOK</code></pre></div>\n<p>Check if we have quorum</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel ckquorum mycluster\n\nOK <span class=\"token number\">4</span> usable Sentinels. Quorum and failover authorization can be reached</code></pre></div>\n<h1>Save configs</h1>\n<p>Now, when everyhing is configured, we need flush settings to the disk</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 config rewrite\n\nOK\n\nC:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel flushconfig\n\nOK</code></pre></div>\n<p>Note: if everything is ok, in both configs you will see bunch of new lines right after \"Generated by CONFIG REWRITE\" comment</p>\n<h1>Failover</h1>\n<p>Because removed node is master right now - we should make manual failover, but before check if we have quorum</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Step 1: Check who is master</span>\nredis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel get-master-addr-by-name mycluster\n\n<span class=\"token comment\"># Step 2: check is quorum ok</span>\nredis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel ckquorum mycluster\n\n<span class=\"token comment\"># Step 3: manual failover</span>\nredis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel failover mycluster\n\n<span class=\"token comment\"># Step 4: Check who is master</span>\nredis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel get-master-addr-by-name mycluster\n\n<span class=\"token comment\"># Turn off SRV16</span>\nsc stop redis\nsc stop redissentinel\nsc delete redis\nsc delete redissentinel</code></pre></div>\n<p>Note: i was running them one by one, because it was quite scarry operation</p>\n<p>Then shutdown redis and wait for a while</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv12 info replication\n\n<span class=\"token comment\"># Replication</span>\nrole:master\nconnected_slaves:2\nslave0:ip<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.0.16,port<span class=\"token operator\">=</span><span class=\"token number\">6379</span>,state<span class=\"token operator\">=</span>online,offset<span class=\"token operator\">=</span><span class=\"token number\">3206080046244</span>,lag<span class=\"token operator\">=</span><span class=\"token number\">0</span>\nslave1:ip<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.0.15,port<span class=\"token operator\">=</span><span class=\"token number\">6379</span>,state<span class=\"token operator\">=</span>online,offset<span class=\"token operator\">=</span><span class=\"token number\">3206079599208</span>,lag<span class=\"token operator\">=</span><span class=\"token number\">1</span></code></pre></div>\n<p>Then shutdown sentinel</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel ckquorum mycluster\n\nOK <span class=\"token number\">3</span> usable Sentinels. Quorum and failover authorization can be reached</code></pre></div>\n<h1>Forget old nodes</h1>\n<p>Sentinel will remember about old srv17 and wait for it to come back. To delete it forever you need to run following commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">C:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel reset mycluster\n\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span>\n\nC:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv16 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel flushconfig\n\nOK\n\nC:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv12 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel reset mycluster\n\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span>\n\nC:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> srv12 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel flushconfig\n\nOK\n\nC:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> drum <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel reset mycluster\n\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span>\n\nC:<span class=\"token punctuation\">\\</span>Redis-x64-3.2.10<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> redis-cli <span class=\"token parameter variable\">-h</span> drum <span class=\"token parameter variable\">-p</span> <span class=\"token number\">26379</span> sentinel flushconfig\n\nOK</code></pre></div>\n<h1>Restore?</h1>\n<p>Theoretically, if we need to rollback everyhing - we gonna need to cleanup configs, start services, connect back to the cluster and everything should work</p>"}},"pageContext":{"id":"4980866d-184f-5245-b231-25cec72d0d8a"}},"staticQueryHashes":[],"slicesMap":{}}