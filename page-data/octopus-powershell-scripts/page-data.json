{"componentChunkName":"component---src-templates-note-js","path":"/octopus-powershell-scripts/","result":{"data":{"remark":{"fields":{"path":"octopus-powershell-scripts"},"meta":{"title":""},"headings":[{"value":"Octopus Deploy Powershell Scripts"},{"value":"Update variables in all releases"},{"value":"Redeploy all IIS sites to dev1"}],"html":"<h1>Octopus Deploy Powershell Scripts</h1>\n<h1>Update variables in all releases</h1>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$headers = @{\n    &#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY\n}\n\n# Update variables in all releases\n$releases = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/releases?take=1000&quot; -Headers $headers | Select-Object -ExpandProperty Items\nforeach ($release in $releases) {\n    $message = &quot;[$(1 +[Array]::IndexOf($releases, $release)) of $($releases.Count)] $($release.Id) - $($release.Version)&quot;\n    try {\n        Invoke-RestMethod -Method Post -Uri &quot;https://robota.octopus.app/api/releases/$($release.Id)/snapshot-variables&quot; -Headers $headers | Out-Null\n        Write-Host $message -ForegroundColor Green\n    }\n    catch {\n        Write-Host $message -ForegroundColor Red\n    }\n}</code></pre></div>\n<h1>Redeploy all IIS sites to dev1</h1>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$headers = @{\n    &#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY\n}\n\n\n$target = &quot;dev1&quot;\n\n\n$environments = Invoke-RestMethod &quot;https://robota.octopus.app/api/environments&quot; -Headers $headers | Select-Object -ExpandProperty Items\n$environment = $environments | Where-Object Name -EQ $target\nWrite-Host &quot;Environment for $target has id $($environment.Id)&quot;\n\n\n$projects = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/projects?skip=0&amp;take=1000&quot; -Headers $headers | Select-Object -ExpandProperty Items\n$projects = $projects | Where-Object IsDisabled -EQ $false\nWrite-Host &quot;Got $($projects.Count) projects&quot;\n\n# Optional: filter frontend projects\n$projects = $projects | Where-Object Name -NotLike &quot;alliance-*&quot;\n\n\n# Optional: filter only IIS projects\n$iisProjects = @()\nforeach ($project in $projects) {\n    $process = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -Headers $headers\n    $hasIisStep = $false\n    foreach ($step in $process.Steps) {\n        if (($step.Properties.&#39;Octopus.Action.TargetRoles&#39; -eq &#39;iis&#39;) -or ($step.Properties.&#39;Octopus.Action.TargetRoles&#39; -eq &#39;admin&#39;)) {\n            foreach ($action in $step.Actions) {\n                if ($action.IsDisabled -eq $false) {\n                    $hasIisStep = $true\n                    break\n                }\n            }\n        }\n    }\n    if ($hasIisStep -eq $true) {\n        $iisProjects += $project\n    }\n}\nWrite-Host &quot;Filtered $($iisProjects.Count) IIS projects&quot;\n$projects = $iisProjects\n\n\n$releases = @()\nforeach($project in $projects) {\n    $progression = Invoke-RestMethod &quot;https://robota.octopus.app/api/progression/$($project.Id)&quot; -Headers $headers\n    foreach($release in $progression.Releases) {\n        if ($release.Deployments.$($environment.Id)) {\n            $releases += $release\n            break\n        }\n    }\n}\nWrite-Host &quot;Got $($releases.Count) releases&quot;\n\n\nWrite-Host &quot;Going to update release variables for $($releases.Count) releases&quot;\nforeach($release in $releases) {\n    $projectName = $projects | Where-Object Id -EQ $release.Release.ProjectId | Select-Object -First 1 -ExpandProperty Name\n    try {\n        Invoke-RestMethod -Method Post -Uri &quot;https://robota.octopus.app/api/releases/$($release.Release.Id)/snapshot-variables&quot; -Headers $headers | Out-Null\n        Write-Host &quot;$($projectName): $($release.Release.Version)&quot; -ForegroundColor Green\n    }\n    catch {\n        Write-Host &quot;$($projectName): $($release.Release.Version)&quot; -ForegroundColor Red\n    }\n}\n\n$counter = 0\n$errors = @()\nWrite-Host &quot;Going to redeploy $($releases.Count) releases&quot;\nforeach($release in $releases) {\n    $projectName = $projects | Where-Object Id -EQ $release.Release.ProjectId | Select-Object -First 1 -ExpandProperty Name\n    try {\n        $deployment = Invoke-RestMethod -Method Post &quot;https://robota.octopus.app/api/deployments&quot; -Headers $headers -ContentType &#39;application/json&#39; -Body (@{ ReleaseId = $release.Release.Id; EnvironmentId = $environment.Id } | ConvertTo-Json)\n\n        Write-Host &quot;$($projectName): $($release.Release.Version)&quot; -ForegroundColor Cyan\n        $task = Invoke-RestMethod &quot;https://robota.octopus.app/api/tasks/$($deployment.TaskId)&quot; -Headers $headers\n        while($task.IsCompleted -ne $true) {\n            $task = Invoke-RestMethod &quot;https://robota.octopus.app/api/tasks/$($deployment.TaskId)&quot; -Headers $headers\n            if ($task.State -eq &quot;Success&quot;) {\n                Write-Host &quot;$($task.State) $($task.Duration)&quot; -ForegroundColor Green\n                break\n            } else {\n                Write-Host &quot;$($task.State) $($task.Duration)&quot;\n            }\n\n            Start-Sleep -Seconds 30\n        }\n        if ($task.FinishedSuccessfully -ne $true) {\n            Write-Host &quot;$($projectName): $($release.Release.Version) - unsuccessfull deployment&quot; -ForegroundColor Red\n            $errors += New-Object PSObject -Property @{\n                project = $projectName\n                version = $release.Release.Version\n            }\n        }\n\n    }\n    catch {\n        Write-Host &quot;$($projectName): $($release.Release.Version) - unable to create deployment&quot; -ForegroundColor Red\n        $errors += New-Object PSObject -Property @{\n            project = $projectName\n            version = $release.Release.Version\n        }\n    }\n\n    &lt;#\n    $counter += 1\n    if ($counter -ge 3) {\n        break\n    }\n    #&gt;\n\n}\n\nif ($errors.Count) {\n    Write-Host &quot;Take a look at failed projects&quot;\n    $errors | Out-Host\n} else {\n    Write-Host &quot;Everything is OK, go take your üç∫&quot; -ForegroundColor Yellow\n}</code></pre></div>\n<h2>PowerShell Octopus Check All Kubernetes Deployment Have Revision History Limit</h2>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$headers = @{\n    &#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY\n}\n\n$projects = Invoke-RestMethod &quot;https://robota.octopus.app/api/projects?skip=0&amp;take=1000&quot; -Headers $headers | Select-Object -ExpandProperty Items\nforeach($project in $projects) {\n    $process = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -Headers $headers\n    foreach($step in $process.Steps) {\n        foreach($action in $step.Actions) {\n            if ($action.ActionType -ne &#39;Octopus.KubernetesDeployContainers&#39;) {\n                continue\n            }\n            $limit = $action.Properties.&#39;Octopus.Action.KubernetesContainers.RevisionHistoryLimit&#39;\n            if ($limit -ne &#39;#{RevisionHistoryLimit}&#39;) {\n                Write-Host &quot;project: $($project.Name), step: $($step.Name), url: https://robota.octopus.app/app#/Spaces-1/projects/$($project.Slug)/deployments/process&quot;\n            }\n        }\n    }\n}</code></pre></div>\n<h2>PowerShell Octopus set deployment setting in all projects</h2>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$headers = @{\n    &#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY\n}\n\n$projects = Invoke-RestMethod &quot;https://robota.octopus.app/api/projects?skip=0&amp;take=1000&quot; -Headers $headers | Select-Object -ExpandProperty Items\n$projects = $projects | Sort-Object -Property Name\n# $project = $projects |? Name -EQ &#39;adjwt&#39;\nforeach($project in $projects) {\n    $process = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -Headers $headers\n    $shouldUpdate = $false\n    foreach($step in $process.Steps) {\n        foreach($action in $step.Actions) {\n            if ($action.ActionType -ne &#39;Octopus.KubernetesDeployContainers&#39;) {\n                continue\n            }\n            if ($action.Properties.&#39;Octopus.Action.KubernetesContainers.RevisionHistoryLimit&#39; -ne &#39;#{RevisionHistoryLimit}&#39;) {\n                if (-not $action.Properties.&#39;Octopus.Action.KubernetesContainers.RevisionHistoryLimit&#39;) {\n                    $action.Properties | Add-Member -NotePropertyName &#39;Octopus.Action.KubernetesContainers.RevisionHistoryLimit&#39; -NotePropertyValue &#39;#{RevisionHistoryLimit}&#39;\n                } else {\n                    $action.Properties.&#39;Octopus.Action.KubernetesContainers.RevisionHistoryLimit&#39; = &#39;#{RevisionHistoryLimit}&#39;\n                }\n                $shouldUpdate = $true\n            }\n        }\n    }\n    $status = &#39;unknown&#39;\n    if ($shouldUpdate) {\n        try {\n            Invoke-RestMethod -Method Put &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -Headers $headers -Body ($process | ConvertTo-Json -Depth 100) | Out-Null\n            Write-Host &quot;$($project.Name) - updated&quot; -ForegroundColor Green\n            $status = &#39;updated&#39;\n        } catch {\n            Write-Host &quot;$($project.Name) - failed&quot; -ForegroundColor Red\n            $status = &#39;failed&#39;\n        }\n    } else {\n        Write-Host &quot;$($project.Name) - skipped&quot; -ForegroundColor Cyan\n        $status = &#39;skipped&#39;\n    }\n    Write-Progress -Activity $project.Name -Status $status -PercentComplete ( [Array]::IndexOf($projects, $project) / $projects.Count * 100 )\n}</code></pre></div>\n<h2>PowerShell Octopus Create and Deploy Release (sync dev environments with production)</h2>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">&lt;#\nProblem: after releasing new version engineers are often forget to sync dev environments\nFact: deployment to production happens only after deployment to staging, so there is no need to sync them, only devX environments should be synced\nIdea: after releasing to production, take its selected versions, create release for dev channel with same version, deploy\nInputs: project name to sync\nOutputs: released deployments to all dev environments\nImprovements for v2: ability to sync all projects\nLinks: https://github.com/OctopusDeploy/OctopusDeploy-Api/blob/master/REST/PowerShell/Deployments/CreateReleaseAndDeployment.ps1\n#&gt;\n\n$name = &#39;adjwt&#39;\n\n$headers = @{\n    &#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY\n}\n\n$projects = Invoke-RestMethod &quot;https://robota.octopus.app/api/projects?skip=0&amp;take=1000&quot; -Headers $headers | Select-Object -ExpandProperty Items | Select-Object Id, Name\n$project = $projects |? Name -EQ $name\n\n$environments = Invoke-RestMethod &quot;https://robota.octopus.app/api/environments&quot; -Headers $headers | Select-Object -ExpandProperty Items | Select-Object Id, Name\n$productionEnvironmentId = $environments | Where-Object Name -EQ &quot;Production&quot; | Select-Object -ExpandProperty Id\n\n$idOfLastSuccessfullDeploymentToProduction = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/tasks?take=1&amp;environment=$($productionEnvironmentId)&amp;state=Success&amp;name=Deploy&amp;project=$($project.Id)&quot; -Headers $headers | Select-Object -ExpandProperty Items | Select-Object -ExpandProperty Arguments -First 1 | Select-Object -ExpandProperty DeploymentId\n$idOfRelease = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/deployments/$idOfLastSuccessfullDeploymentToProduction&quot; -Headers $headers | Select-Object -ExpandProperty ReleaseId\n$lastRelease = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/releases/$idOfRelease&quot; -Headers $headers | Select-Object Version, SelectedPackages\n\n$channels = Invoke-RestMethod &quot;https://robota.octopus.app/api/projects/$($project.Id)/channels&quot; -Headers $headers | Select-Object -ExpandProperty Items | Where-Object Id -NE $releaseOfLastSuccessfullDeploymentToProduction.ChannelId | Select-Object Id, Name\nforeach($channel in $channels) {\n    $release = Invoke-RestMethod -Method Post -Uri &quot;https://robota.octopus.app/api/releases&quot; -Headers $headers -Body (@{\n        ChannelId        = $channel.Id\n        ProjectId        = $project.Id\n        Version          = $lastRelease.Version + &quot;-sync&quot;\n        SelectedPackages = $lastRelease.SelectedPackages\n    } | ConvertTo-Json)\n\n    foreach($environment in $environments | Where-Object Name -NotIn @(&#39;Production&#39;, &#39;Staging&#39;)) {\n        $deployment = Invoke-RestMethod -Method Post -Uri &quot;https://robota.octopus.app/api/deployments &quot; -Headers $headers -Body (@{\n            ReleaseId     = $release.Id\n            EnvironmentId = $environment.Id\n        } | ConvertTo-Json)\n\n        # optional\n        Write-Host &quot;$($project.Name)@$($environment.Name): created&quot; -ForegroundColor Cyan\n        do {\n            $task = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/tasks/$($deployment.TaskId)&quot; -Headers $headers\n            if ($task.State -eq &quot;Success&quot;) {\n                Write-Host &quot;$($task.State) $($task.Duration)&quot; -ForegroundColor Green\n                break\n            } else {\n                Write-Host &quot;$($task.State) $($task.Duration)&quot;\n            }\n            Start-Sleep -Seconds 30\n        } while($task.IsCompleted -ne $true)\n        if ($task.FinishedSuccessfully -ne $true) {\n            Write-Host &quot;$($project.Name)@$($environment.Name): failed&quot; -ForegroundColor Red\n        } else {\n            Write-Host &quot;$($project.Name)@$($environment.Name): deployed&quot; -ForegroundColor Green\n        }\n    }\n}</code></pre></div>\n<h2>Mass fix for HPA tab issue</h2>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$headers = @{&#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY}\n\n$projects = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/projects?skip=0&amp;take=1000&quot; -Headers $headers | Select-Object -ExpandProperty Items\n$projects = $projects | Where-Object IsDisabled -EQ $false\nWrite-Host &quot;Got $($projects.Count) projects&quot;\n\nforeach($project in $projects) {\n    # $project = $projects | Where-Object Name -EQ &#39;ApplyApi&#39;\n    Write-Host &quot;Project: $($project.Name)&quot;\n    $process = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -Headers $headers\n    $shouldUpdate = $false\n    foreach($step in $process.Steps) {\n        # $process.Steps | Select-Object name\n        # $step = $process.Steps[2]\n        Write-Host &quot;Step: $($step.Name)&quot;\n        if ($step.Properties.&#39;Octopus.Action.TargetRoles&#39; -ne &#39;kube-azure&#39;) {\n            Write-Host &quot;skipping &#39;$($step.Properties.&#39;Octopus.Action.TargetRoles&#39;)&#39; non kubernetes step...&quot; -ForegroundColor Yellow\n            continue\n        }\n        foreach($action in $step.Actions) {\n            # $step.Actions | Select-Object name\n            # $action = $step.Actions[0]\n            Write-Host &quot;Action: $($action.Name)&quot;\n            if ($action.IsDisabled) {\n                Write-Host &quot;skipping disabled action...&quot; -ForegroundColor Yellow\n                continue\n            }\n            if ($action.ActionType -ne &#39;Octopus.KubernetesDeployContainers&#39;) {\n                Write-Host &quot;skipping &#39;$($action.ActionType)&#39; non kubernetes action...&quot; -ForegroundColor Yellow\n                continue\n            }\n            if (-not $action.Properties.&#39;Octopus.Action.KubernetesContainers.CustomResourceYaml&#39;) {\n                Write-Host &quot;skipping action without custom resource yaml...&quot; -ForegroundColor Yellow\n                continue\n            }\n            if ($action.Properties.&#39;Octopus.Action.KubernetesContainers.CustomResourceYaml&#39; -notmatch &#39;HorizontalPodAutoscaler&#39;) {\n                Write-Host &quot;skipping action without hpa in custom resource yaml...&quot; -ForegroundColor Yellow\n                continue\n            }\n            if ($action.Properties.&#39;Octopus.Action.KubernetesContainers.CustomResourceYaml&#39; -notmatch &quot;`t&quot;) {\n                Write-Host &quot;skipping action tabs not found...&quot; -ForegroundColor Yellow\n                continue\n            }\n\n            $action.Properties.&#39;Octopus.Action.KubernetesContainers.CustomResourceYaml&#39; = ($action.Properties.&#39;Octopus.Action.KubernetesContainers.CustomResourceYaml&#39; -replace &quot;`t&quot;, &#39;  &#39;)\n            $shouldUpdate = $true\n            Write-Host &quot;should be updated...&quot; -ForegroundColor Yellow\n\n        }\n    }\n    if ($shouldUpdate) {\n        try {\n            Invoke-RestMethod -Method Put &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -Headers $headers -Body ($process | ConvertTo-Json -Depth 100) | Out-Null\n            Write-Host $project.Name -ForegroundColor Green\n        } catch {\n            Write-Host $project.Name -ForegroundColor Red\n        }\n    } else {\n        Write-Host $project.Name -ForegroundColor Cyan\n    }\n}</code></pre></div>\n<h2>Project variables CRUD</h2>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$headers = @{&#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY}\n\n# Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/environments&quot; -Headers $headers | Select-Object -ExpandProperty Items | Select-Object Id, Name\n# Environments-3  Production\n# Environments-2  Staging\n# Environments-1  dev\n\n$projects = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/projects?skip=0&amp;take=1000&quot; -Headers $headers | Select-Object -ExpandProperty Items\n\n$project = $projects | Where-Object Name -EQ &#39;adjwt&#39;\n\n# Add global variable\n$variables = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.Variables)&quot; -Headers $headers\n\n$variables.Variables += [PSCustomObject]@{\n    Name = &#39;Demo&#39;\n    Value = &#39;Hello from PowerShell&#39;\n    IsEditable = $true\n    IsSensitive = $false\n    Type = &#39;String&#39;\n}\n\nInvoke-RestMethod -Method Put -Uri &quot;https://robota.octopus.app$($project.Links.Variables)&quot; -Headers $headers -Body ($variables | ConvertTo-Json -Depth 100)\n\n# Add environment variable\n$variables = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.Variables)&quot; -Headers $headers\n\n$variables.Variables += [PSCustomObject]@{\n    Name = &#39;Demo&#39;\n    Value = &#39;default&#39;\n    IsEditable = $true\n    IsSensitive = $false\n    Type = &#39;String&#39;\n}\n\n$variables.Variables += [PSCustomObject]@{\n    Name = &#39;Demo&#39;\n    Value = &#39;test2&#39;\n    IsEditable = $true\n    IsSensitive = $false\n    Type = &#39;String&#39;\n    Scope = @{\n        Environment = @(&#39;Environments-2&#39;)\n    }\n}\n\n$variables.Variables += [PSCustomObject]@{\n    Name = &#39;Demo&#39;\n    Value = &#39;prod&#39;\n    IsEditable = $true\n    IsSensitive = $false\n    Type = &#39;String&#39;\n    Scope = @{\n        Environment = @(&#39;Environments-3&#39;)\n    }\n}\n\nInvoke-RestMethod -Method Put -Uri &quot;https://robota.octopus.app$($project.Links.Variables)&quot; -Headers $headers -Body ($variables | ConvertTo-Json -Depth 100)\n\n# Delete variable by its name\n\n$variables = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.Variables)&quot; -Headers $headers\n\n$variables.Variables = $variables.Variables | Where-Object Name -NE &#39;Demo&#39;\n\nInvoke-RestMethod -Method Put -Uri &quot;https://robota.octopus.app$($project.Links.Variables)&quot; -Headers $headers -Body ($variables | ConvertTo-Json -Depth 100)</code></pre></div>\n<h2>Mass add TZ environment variable to all octopus projects, powershell</h2>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$headers = @{&#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY }\n\n$projects = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/projects/all&quot; -Headers $headers\n$projects = $projects | Where-Object IsDisabled -EQ $false\nWrite-Host &quot;Got $($projects.Count) projects&quot;\n\nforeach ($project in $projects) {\n  &lt;#\n  $project = $projects | Where-Object Name -EQ &#39;banner-api&#39;\n  #&gt;\n  Write-Host &quot;Project: $($project.Name)&quot;\n  $process = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -Headers $headers\n  $shouldUpdate = $false\n  foreach ($step in $process.Steps) {\n    &lt;#\n    $process.Steps | Select-Object name\n    $step = $process.Steps[1]\n    #&gt;\n    Write-Host &quot;Step: $($step.Name)&quot;\n    if ($step.Properties.&#39;Octopus.Action.TargetRoles&#39; -ne &#39;kube-azure&#39;) {\n      Write-Host &quot;skipping &#39;$($step.Properties.&#39;Octopus.Action.TargetRoles&#39;)&#39; non kubernetes step...&quot; -ForegroundColor Yellow\n      continue\n    }\n    foreach ($action in $step.Actions) {\n      &lt;#\n      $step.Actions | Select-Object name\n      $action = $step.Actions[0]\n      #&gt;\n      Write-Host &quot;Action: $($action.Name)&quot;\n      if ($action.IsDisabled) {\n        Write-Host &quot;skipping disabled action...&quot; -ForegroundColor Yellow\n        continue\n      }\n      if ($action.ActionType -ne &#39;Octopus.KubernetesDeployContainers&#39;) {\n        Write-Host &quot;skipping &#39;$($action.ActionType)&#39; non kubernetes action...&quot; -ForegroundColor Yellow\n        continue\n      }\n\n      $containers = $action.Properties.&#39;Octopus.Action.KubernetesContainers.Containers&#39; | ConvertFrom-Json\n      foreach ($container in $containers) {\n        &lt;#\n        $containers | Select-Object name\n        $container = $containers[0]\n        #&gt;\n        if (-not ($container.EnvironmentVariables | Where-Object key -EQ &#39;TZ&#39; | Where-Object value -In @(&#39;Europe/Kiev&#39;, &#39;UTC&#39;))) {\n          Write-Host &quot;Container: $($container.Name) - has no TZ env variable - should be updated...&quot; -ForegroundColor Yellow\n          $container.EnvironmentVariables += [PSCustomObject]@{\n            key   = &#39;TZ&#39;\n            value = &#39;Europe/Kiev&#39; # TODO: chose &#39;Europe/Kiev&#39; or &#39;UTC&#39;\n          }\n          $shouldUpdate = $true\n        }\n      }\n\n      # WTF powershell?! Powershell always messes up with single item arrays! Keep that in mind\n      $action.Properties.&#39;Octopus.Action.KubernetesContainers.Containers&#39; = ConvertTo-Json -Depth 100 -InputObject @($containers)\n    }\n  }\n  if ($shouldUpdate) {\n    try {\n      # # Uncomment me when you ready\n      # Invoke-RestMethod -Method Put &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -ContentType &quot;application/json&quot; -Headers $headers -Body ($process | ConvertTo-Json -Depth 100) | Out-Null\n      Write-Host $project.Name -ForegroundColor Green\n    }\n    catch {\n      Write-Host $project.Name -ForegroundColor Red\n    }\n  }\n  else {\n    Write-Host $project.Name -ForegroundColor Cyan\n  }\n}</code></pre></div>\n<h2>Mass owners sync from Octopus to Kubernetes</h2>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$octopusHeaders = @{ &quot;X-Octopus-ApiKey&quot; = $env:OCTOPUS_TOKEN; &quot;Content-Type&quot; = &quot;application/json&quot; }\n\n$items = kubectl get &quot;deployment,statefulset,cronjob&quot; -o json | ConvertFrom-Json | Select-Object -ExpandProperty items\n&lt;#\n    $item = $items | Where-Object { $_.metadata.name -eq &#39;candidates-auto-screening-answer-stats-cronjob&#39; }\n#&gt;\n\nforeach ($item in $items) {\n    $projectId = $item.metadata.labels.&#39;Octopus.Project.Id&#39;\n    if ([string]::IsNullOrEmpty($projectId)) {\n        #Write-Host &quot;$($project.Name) | Octopus.Project.Id label not found for deployment&quot; -ForegroundColor Red\n        continue\n    }\n\n    if (-not $item.metadata.annotations.owner) {\n        #Write-Host &quot;$($project.Name) | Owner annotation not found for deployment&quot; -ForegroundColor Red\n        continue\n    }\n\n    $variables = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/Spaces-1/projects/$($projectId)/variables&quot; -Headers $octopusHeaders\n    $octo_owner = $variables.Variables | Where-Object Name -eq &quot;Owner&quot; | Select-Object -ExpandProperty Value -First 1\n    if (-not $octo_owner) {\n        #Write-Host &quot;$($project.Name) | Owner repository variable not found for project&quot; -ForegroundColor Red\n        continue\n    }\n\n    $octo_owner_normalized = $octo_owner.Trim().ToLower()\n    if ($item.metadata.annotations.owner.Trim().ToLower() -eq $octo_owner_normalized) {\n        #Write-Host &quot;$($item.metadata.name) | Owner is up to date&quot; -ForegroundColor Green\n        continue\n    }\n\n    if ($item.kind -eq &quot;CronJob&quot;) {\n        $patch = ConvertTo-Json -Compress -Depth 100 -InputObject @{\n            metadata = @{\n                annotations = @{\n                    owner = $octo_owner_normalized\n                }\n            }\n            spec     = @{\n                jobTemplate = @{\n                    metadata = @{\n                        annotations = @{\n                            owner = $octo_owner_normalized\n                        }\n                    }\n                    spec     = @{\n                        template = @{\n                            metadata = @{\n                                annotations = @{\n                                    owner = $octo_owner_normalized\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n    else {\n        $patch = ConvertTo-Json -Compress -Depth 100 -InputObject @{\n            metadata = @{\n                annotations = @{\n                    owner = $octo_owner_normalized\n                }\n            }\n            spec     = @{\n                template = @{\n                    metadata = @{\n                        annotations = @{\n                            owner = $octo_owner_normalized\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    Write-Host &quot;kubectl patch $($item.kind.ToLower()) $($item.metadata.name) -p &#39;$patch&#39;&quot;\n\n    if ($item.kind -ne &quot;cronjob&quot;) {\n        Write-Host &quot;kubectl rollout status $($item.kind.ToLower()) $($item.metadata.name) --timeout=60s&quot;\n    }\n}</code></pre></div>\n<h2>Octopus Powershell List Variable Usage by Projects</h2>\n<p>find all projects that use some variable</p>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$headers = @{&#39;X-Octopus-ApiKey&#39; = $env:OCTOPUS_CLI_API_KEY }\n\n$projects = Invoke-RestMethod -Uri &quot;https://robota.octopus.app/api/projects/all&quot; -Headers $headers\n$projects = $projects | Where-Object IsDisabled -EQ $false\n\n$variables = @()\nforeach ($project in $projects) {\n  &lt;#\n  $project = $projects | Where-Object Name -EQ &#39;RbacApi&#39;\n  #&gt;\n  $process = Invoke-RestMethod -Uri &quot;https://robota.octopus.app$($project.Links.DeploymentProcess)&quot; -Headers $headers\n  foreach ($step in $process.Steps) {\n    &lt;#\n    $process.Steps | Select-Object name\n    $step = $process.Steps[1]\n    #&gt;\n    foreach ($action in $step.Actions) {\n      &lt;#\n      $step.Actions | Select-Object name\n      $action = $step.Actions[0]\n      #&gt;\n      if ($action.IsDisabled) { continue }\n\n      $json = $action | ConvertTo-Json -Depth 100 # trick: instead of iteratin over all possible step kinds, serialize it as json and search for #{SomeVariable}\n      foreach ($variable in [regex]::Matches($json, &#39;#\\{[^\\}]+\\}&#39;)) {\n        $variables += [PSCustomObject]@{\n          project  = $project.Name\n          step     = $step.Name\n          variable = $variable.Value\n        }\n      }\n    }\n  }\n}\n\n$variables = $variables | Select-Object project, step, variable -Unique\n\n$variables</code></pre></div>"}},"pageContext":{"id":"b2209ef4-9f24-5f11-a44a-ab3c17047ab0"}},"staticQueryHashes":[],"slicesMap":{}}