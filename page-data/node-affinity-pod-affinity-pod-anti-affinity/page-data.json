{"componentChunkName":"component---src-templates-note-js","path":"/node-affinity-pod-affinity-pod-anti-affinity/","result":{"data":{"remark":{"fields":{"path":"node-affinity-pod-affinity-pod-anti-affinity"},"meta":{"title":""},"headings":[{"value":"Kubernetes: Node affinity, pod affinity, pod anti affinity"},{"value":"Node affinity - говорим что бы приложенька запускалась на app нодах"},{"value":"Pod affinity - держим редис по ближе к приложению"},{"value":"Pod anti affinity - размазываем приложение по кластеру"},{"value":"Дополнительная информация"}],"html":"<h1>Kubernetes: Node affinity, pod affinity, pod anti affinity</h1>\n<p>Концепт affinity и anti affinity проще всего описать на примере магнитов которые могут <strong>притягиваться</strong> друг к другу (<strong>affinity</strong>) или <strong>отталкиваться</strong> (<strong>anti affinity</strong>)</p>\n<p><strong>Affinity</strong> - имеем деплоймент dictionaries и dictionaries-redis, было бы круто, что бы они бежали на одном и том же сервере, соответсвенно они должны как бы “притягиваться” друг к другу</p>\n<p><strong>Anti affinity</strong> - имеем кластер эластика из трех нод, было бы круто что бы каждый бежал на отдельном сервере - соответственно они должны как бы “отталкиваться” друг от друга</p>\n<h1>Node affinity - говорим что бы приложенька запускалась на app нодах</h1>\n<p>В этом примере мы просим что бы наше приложение запускалось на нодах с лейбочкой <code class=\"language-text\">poolDestination=app</code></p>\n<blockquote>\n<p>Примечание: сейчас у нас в кластере есть infra и app ноды, первые не предпологают хостить приложения, именно по этому мы тут используем именно <code class=\"language-text\">required</code>, а не <code class=\"language-text\">preferred</code>. В будущем этот же концепт будет использоваться для других видов серверов (условно preemtible, сервера с gpu и т.п.)</p>\n</blockquote>\n<h1>Pod affinity - держим редис по ближе к приложению</h1>\n<p><img src=\"attachments/2442952738/2443116561.png\" alt=\"\"></p>\n<p>В этом примере, для деплоймента dictionaries-redis мы выставляем pod affinity в <code class=\"language-text\">app=dictionary</code>, соответственно приложение будет стараться запуститься на том же сервере где уже бежит dictionary</p>\n<blockquote>\n<p>Примечание: мы намерянно используем <code class=\"language-text\">preferred</code> т.к. <code class=\"language-text\">required</code> вылезет боком, ведь если сам dictionaries запущен больше чем в одном экземпляре и на разных серверах то этот affinity просто разорвет редиску надвое</p>\n</blockquote>\n<h1>Pod anti affinity - размазываем приложение по кластеру</h1>\n<p><img src=\"attachments/2442952738/2443477020.png\" alt=\"\"></p>\n<p>В этом примере мы просим сервис dictionary по возможности запускаться на тех серверах где он еще не бежит (размазываем по кластеру)</p>\n<blockquote>\n<p>Примечание: тут так же как и с affinity мы используем именно <code class=\"language-text\">preferred</code>, а не <code class=\"language-text\">required</code>, ведь иначе куберу пришлось бы добавлять по целому серверу на каждый экземпляр приложения</p>\n</blockquote>\n<p>ВАЖНО: required в pod affinity и anti affinity может наделать делов и стоит его избегать</p>\n<h1>Дополнительная информация</h1>\n<p>Дальше серия дополнительных примеров и уже не обязательна для ознакомления</p>\n<h2>topologyKey</h2>\n<p><strong>topologyKey</strong> используется для дележки доступных серверов, во всех наших сценариях мы используем <code class=\"language-text\">kubernetes.io/hostname</code> что равносильно дележке до конретного сервера.</p>\n<p>Идея этой штуки для чуть более больших кластеров, предположим у нас глобальное приложение и есть сервера в штатах и европе и у каждой ноды есть соответствующая лейбочка, тогда мы бы могли использовать ее за вместо hostname и работать уже с группами серверов</p>\n<p>Другие примеры - наличие серверов с разными операционными системами или архитектурами (тот же arm)</p>\n<h2>Example deployments</h2>\n<p>Далее парочка примеров которые можно задеплоить что бы глазами увидеть как оно работает на деле</p>\n<p><strong>magnet-node-app.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>app\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nodeAffinity</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># allow deployment only to this nodes: kubectl get nodes -l poolDestination=app</span>\n      <span class=\"token key atrule\">requiredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">nodeSelectorTerms</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> poolDestination\n                <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token punctuation\">-</span> app</code></pre></div>\n<p>deploy</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> magnet-node-app.yml</code></pre></div>\n<p>check</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get po magnet-node-app <span class=\"token parameter variable\">-o</span> wide</code></pre></div>\n<p>result: приложение всегда будет приезжать но app ноду</p>\n<p>cleanup</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl delete <span class=\"token parameter variable\">-f</span> magnet-node-app.yml</code></pre></div>\n<p><strong>magnet-pods.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>pods\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>pods\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>pods<span class=\"token punctuation\">-</span>redis\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>pods<span class=\"token punctuation\">-</span>redis\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> redis\n  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">podAffinity</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># try to deploy to this node: kubectl get po magnet-pods -o wide</span>\n      <span class=\"token key atrule\">preferredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">weight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n          <span class=\"token key atrule\">podAffinityTerm</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app\n                  <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                  <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token punctuation\">-</span> magnet<span class=\"token punctuation\">-</span>pods\n            <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> kubernetes.io/hostname</code></pre></div>\n<p>deploy</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> magnet-pods.yml</code></pre></div>\n<p>check</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get po magnet-pods <span class=\"token parameter variable\">-o</span> wide\nkubectl get po magnet-pods <span class=\"token parameter variable\">-o</span> wide</code></pre></div>\n<p>result: redis pod будет стрататься запуститься на той же ноде что и приложение</p>\n<p>cleanup</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl delete <span class=\"token parameter variable\">-f</span> magnet-pods.yml</code></pre></div>\n<p><strong>spread-pods.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> spread<span class=\"token punctuation\">-</span>pods\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> spread<span class=\"token punctuation\">-</span>pods\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> spread<span class=\"token punctuation\">-</span>pods\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> spread<span class=\"token punctuation\">-</span>pods\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> spread<span class=\"token punctuation\">-</span>pods\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n      <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">podAntiAffinity</span><span class=\"token punctuation\">:</span>\n          <span class=\"token comment\"># try to deploy to any other nodes than this: kubectl get po -l app=spread-pods -o wide</span>\n          <span class=\"token key atrule\">preferredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">weight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n              <span class=\"token key atrule\">podAffinityTerm</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app\n                      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                        <span class=\"token punctuation\">-</span> spread<span class=\"token punctuation\">-</span>pods\n                <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> kubernetes.io/hostname</code></pre></div>\n<p>deploy</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> spread-pods.yml</code></pre></div>\n<p>check</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get po <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>spread-pods <span class=\"token parameter variable\">-o</span> wide</code></pre></div>\n<p>result: кубер будет стараться запустить каждый экземпляр приложения на отдельном сервере</p>\n<p>cleanup</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl delete <span class=\"token parameter variable\">-f</span> spread-pods.yml</code></pre></div>\n<p><strong>magnet-combi.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>combi<span class=\"token punctuation\">-</span>redis\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>combi<span class=\"token punctuation\">-</span>redis\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> redis\n  <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">podAffinity</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># try to deploy to one of nodes from here: kubectl get po -l app=magnet-combi -o wide</span>\n      <span class=\"token key atrule\">preferredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">weight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n          <span class=\"token key atrule\">podAffinityTerm</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app\n                  <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                  <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token punctuation\">-</span> magnet<span class=\"token punctuation\">-</span>combi\n            <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> kubernetes.io/hostname\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>combi\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>combi\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>combi\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>combi\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> magnet<span class=\"token punctuation\">-</span>combi\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n      <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">podAntiAffinity</span><span class=\"token punctuation\">:</span>\n          <span class=\"token comment\"># try to deploy to any other nodes than this: kubectl get po -l app=magnet-combi -o wide</span>\n          <span class=\"token key atrule\">preferredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">weight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n              <span class=\"token key atrule\">podAffinityTerm</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app\n                      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                        <span class=\"token punctuation\">-</span> magnet<span class=\"token punctuation\">-</span>combi\n                <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> kubernetes.io/hostname</code></pre></div>\n<p>deploy</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> magnet-combi.yml</code></pre></div>\n<p>check</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl get po <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>magnet-combi <span class=\"token parameter variable\">-o</span> wide\nkubectl get po magnet-combi-redis <span class=\"token parameter variable\">-o</span> wide</code></pre></div>\n<p>result: nginx должен будет постараться задеплоиться на 3 разных сервера, redis должен будет постараться запуститься на одном из них</p>\n<p>cleanup</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl delete <span class=\"token parameter variable\">-f</span> magnet-combi.yml</code></pre></div>"}},"pageContext":{"id":"215a3e7e-c661-5358-88bd-3e2f5257a92b"}},"staticQueryHashes":[],"slicesMap":{}}