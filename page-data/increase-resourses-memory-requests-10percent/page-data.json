{"componentChunkName":"component---src-templates-note-js","path":"/increase-resourses-memory-requests-10percent/","result":{"data":{"remark":{"fields":{"path":"increase-resourses-memory-requests-10percent"},"meta":{"title":""},"headings":[{"value":"Kubernetes increse memory requests by 10% for all deployments"}],"html":"<h1>Kubernetes increse memory requests by 10% for all deployments</h1>\n<p>in case of urgency and need to perform fast change of resources change accross all deployments following script may be used</p>\n<p><div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$deployments</span> = kubectl get deployments <span class=\"token operator\">-</span>o json <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertFrom-Json</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty items\n\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$deployment</span> in <span class=\"token variable\">$deployments</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># $deployment = $deployments |? { $_.metadata.name -eq 'users-api' }</span>\n    <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$container</span> in <span class=\"token variable\">$deployment</span><span class=\"token punctuation\">.</span>spec<span class=\"token punctuation\">.</span>template<span class=\"token punctuation\">.</span>spec<span class=\"token punctuation\">.</span>containers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># $container = $deployment.spec.template.spec.containers[0]</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>requests<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span>$<span class=\"token punctuation\">(</span><span class=\"token variable\">$deployment</span><span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span> has no memory requests - skipping\"</span> <span class=\"token operator\">-</span>ForegroundColor Cyan\n            <span class=\"token keyword\">continue</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>limits<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span>$<span class=\"token punctuation\">(</span><span class=\"token variable\">$deployment</span><span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span> has no memory limits - skipping\"</span> <span class=\"token operator\">-</span>ForegroundColor Cyan\n            <span class=\"token keyword\">continue</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>requests<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">.</span>Contains<span class=\"token punctuation\">(</span><span class=\"token string\">'Gi'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-or</span> <span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>limits<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">.</span>Contains<span class=\"token punctuation\">(</span><span class=\"token string\">'Gi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span>$<span class=\"token punctuation\">(</span><span class=\"token variable\">$deployment</span><span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span> has big memory requests of <span class=\"token function\">$<span class=\"token punctuation\">(</span>$<span class=\"token punctuation\">(</span><span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>requests<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span> - skipping\"</span> <span class=\"token operator\">-</span>ForegroundColor Cyan\n            <span class=\"token keyword\">continue</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token variable\">$requestsCurrent</span> = <span class=\"token namespace\">[int]</span><span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>requests<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">.</span>Replace<span class=\"token punctuation\">(</span><span class=\"token string\">'Gi'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Replace<span class=\"token punctuation\">(</span><span class=\"token string\">'Mi'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n        <span class=\"token variable\">$requestsDesired</span> = <span class=\"token namespace\">[math]</span>::Ceiling<span class=\"token punctuation\">(</span> <span class=\"token variable\">$requestsCurrent</span> <span class=\"token operator\">*</span> 1<span class=\"token punctuation\">.</span>1 <span class=\"token operator\">/</span> 10 <span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> 10\n\n        <span class=\"token variable\">$limitsCurrent</span> = <span class=\"token namespace\">[int]</span><span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span>limits<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">.</span>Replace<span class=\"token punctuation\">(</span><span class=\"token string\">'Mi'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n        <span class=\"token variable\">$limitsDesired</span> = <span class=\"token namespace\">[math]</span>::Ceiling<span class=\"token punctuation\">(</span> <span class=\"token variable\">$limitsCurrent</span> <span class=\"token operator\">*</span> 1<span class=\"token punctuation\">.</span>1 <span class=\"token operator\">/</span> 10 <span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> 10\n\n        <span class=\"token comment\"># Write-Host \"$($deployment.metadata.name) requests $requestsCurrent > $requestsDesired limits $limitsCurrent > $limitsDesired\"</span>\n\n        <span class=\"token variable\">$patch</span> = @<span class=\"token punctuation\">{</span>\n            spec = @<span class=\"token punctuation\">{</span>\n                template = @<span class=\"token punctuation\">{</span>\n                    spec = @<span class=\"token punctuation\">{</span>\n                        containers = @<span class=\"token punctuation\">(</span>\n                            @<span class=\"token punctuation\">{</span>\n                                name = <span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>name\n                                resources = @<span class=\"token punctuation\">{</span>\n                                    requests = @<span class=\"token punctuation\">{</span>\n                                        memory = <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$requestsDesired</span><span class=\"token punctuation\">)</span></span>Mi\"</span>\n                                    <span class=\"token punctuation\">}</span>\n                                    limits = @<span class=\"token punctuation\">{</span>\n                                        memory = <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$limitsDesired</span><span class=\"token punctuation\">)</span></span>Mi\"</span>\n                                        cpu = <span class=\"token variable\">$null</span>\n                                    <span class=\"token punctuation\">}</span>\n                                <span class=\"token punctuation\">}</span>\n                            <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Json</span> <span class=\"token operator\">-</span>Compress <span class=\"token operator\">-</span>Depth 100\n        <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"kubectl patch deployment <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$deployment</span><span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span> -p '<span class=\"token variable\">$patch</span>'\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>"}},"pageContext":{"id":"d11c8711-90dc-585e-b18d-5bb6c33f433f"}},"staticQueryHashes":[],"slicesMap":{}}