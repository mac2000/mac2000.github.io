{"componentChunkName":"component---src-templates-note-js","path":"/uploadify-v-modx","result":{"data":{"remark":{"fields":{"path":"uploadify-v-modx"},"meta":{"title":""},"headings":[{"value":"Uploadify в ModX"}],"html":"<h1>Uploadify в ModX</h1>\n<p>В <a href=\"http://modxcms.com/\">ModX</a> есть полноценный файловый менеджер, который обладает единственным минусом – неудобной загрузкой файлов.</p>\n<p>Это становиться настоящей проблемой если создаваемый сайт предполагает необходимость загружать сразу много файлов.</p>\n<p>Эту проблему и буду лечить прикрутив <a href=\"http://www.uploadify.com/\">Uploadify</a>, для тех кто не знает, это плагин для <a href=\"http://jquery.com/\">jQuery</a>, позволяющий загружать сразу много файлов, используется в <a href=\"http://wordpress.org/\">Wordpress</a> по умолчанию.</p>\n<p>Для начала необходимо <a href=\"http://www.uploadify.com/download/\">скачать</a> сам <strong>Uploadify</strong>.</p>\n<p>Далее создадим папку <code class=\"language-text\">/assets/modules/uploadify</code> куда и сложим скачанный плагин.</p>\n<p>Теперь необходимо найти где в ModX спрятан файловый менеджер и заменить его форму загрузки файлов нашим плагином.</p>\n<p>Все что касается файлового менеджера ModX, лежит в файле <code class=\"language-text\">/manager/actions/files.dynamic.php</code>.</p>\n<p>В нем в районе <strong>520</strong>-й строки объявляется форма загрузки файлов, которую мы в первую очередь прячем, добавляя стиль <code class=\"language-text\">display:none</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>form</span> <span class=\"token attr-name\">enctype</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>multipart/form-data<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">action</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>index.php?a=31<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>post<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">display</span><span class=\"token punctuation\">:</span>none</span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Далее перед этой формой вставляем следующий код:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$modx</span><span class=\"token operator\">-></span><span class=\"token property\">config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'base_url'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span>assets/modules/uploadify/jquery.uploadify-v2.1.0/uploadify.css<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/css<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$modx</span><span class=\"token operator\">-></span><span class=\"token property\">config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'base_url'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span>assets/modules/uploadify/jquery.uploadify-v2.1.0/swfobject.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$modx</span><span class=\"token operator\">-></span><span class=\"token property\">config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'base_url'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span>assets/js/jquery-1.3.2.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$modx</span><span class=\"token operator\">-></span><span class=\"token property\">config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'base_url'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span>assets/modules/uploadify/jquery.uploadify-v2.1.0/jquery.uploadify.v2.1.0.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n<span class=\"token keyword\">var</span> fileCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">$</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ready</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#uploadify\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uploadify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">'uploader'</span>       <span class=\"token operator\">:</span> <span class=\"token string\">'<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$modx</span><span class=\"token operator\">-></span><span class=\"token property\">config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'base_url'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span>assets/modules/uploadify/jquery.uploadify-v2.1.0/uploadify.swf'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">'script'</span>         <span class=\"token operator\">:</span> <span class=\"token string\">'<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$modx</span><span class=\"token operator\">-></span><span class=\"token property\">config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'base_url'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span>assets/modules/uploadify/uploadify.php'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">'cancelImg'</span>      <span class=\"token operator\">:</span> <span class=\"token string\">'<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$modx</span><span class=\"token operator\">-></span><span class=\"token property\">config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'base_url'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span>assets/modules/uploadify/jquery.uploadify-v2.1.0/cancel.png'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">'folder'</span>         <span class=\"token operator\">:</span> <span class=\"token string\">'<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token variable\">$modx</span><span class=\"token operator\">-></span><span class=\"token property\">config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'base_url'</span><span class=\"token punctuation\">]</span><span class=\"token delimiter important\">?></span></span><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$startpath</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$len</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$startpath</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token string single-quoted-string\">''</span> <span class=\"token operator\">?</span> <span class=\"token string single-quoted-string\">'/'</span> <span class=\"token punctuation\">:</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$startpath</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$len</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$startpath</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token delimiter important\">?></span></span>'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">'queueID'</span>        <span class=\"token operator\">:</span> <span class=\"token string\">'fileQueue'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">'auto'</span>           <span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">'multi'</span>          <span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">'onSelectOnce'</span>   <span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> fileCount <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>fileCount<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">'onAllComplete'</span>  <span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>filesUploaded <span class=\"token operator\">==</span> fileCount<span class=\"token punctuation\">)</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token string\">'location=location'</span><span class=\"token punctuation\">,</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>fileQueue<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>uploadify<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>uploadify<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>Собственно это стандартное включение плагина Uplodify на страницу, не напутайте с путями к файлам Uploadify.</p>\n<p>Есть один момент, который стоит оговорить отдельно, дело в том что файловый менеджер ModX аж никак не Ajax’ый, поэтому мы вешаем простенький код на событие <code class=\"language-text\">onAllComplete</code>, которое просто перезагружает страницу, чтобы показать пользователю загруженные файлы.</p>\n<p>Осталось реализовать обработку пересылаемых файлов, для этого был создан файл <code class=\"language-text\">/assetss/modules/uploadify/uploadify.php</code> с следующим кодом:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$tempFile</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'Filedata'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$targetPath</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'DOCUMENT_ROOT'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'folder'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$targetFile</span> <span class=\"token operator\">=</span>  <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'//'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$targetPath</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'Filedata'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token variable\">$i</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$targetFile</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$targetFile</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'//'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$targetPath</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$i</span><span class=\"token operator\">++</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'-'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'Filedata'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$tempFile</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$targetFile</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"1\"</span><span class=\"token punctuation\">;</span>\n        @<span class=\"token function\">chmod</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$targetFile</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0777</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"Error moving file \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$tempFile</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">' to '</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$targetFile</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Собственно говоря, все. Теперь вместо стандартной формы загрузки файлов, используется Uploadify, который позволяет за раз загружать сколько угодно файлов.</p>"}},"pageContext":{"id":"8534541b-4a09-5d30-8146-c0c8b8475c81"}},"staticQueryHashes":[]}