{"componentChunkName":"component---src-templates-note-js","path":"/aad-open-extensions/","result":{"data":{"remark":{"fields":{"path":"aad-open-extensions"},"meta":{"title":""},"headings":[{"value":"Adding custom data to Azure Active Directory users"}],"html":"<h1>Adding custom data to Azure Active Directory users</h1>\n<p>Let's pretend we want to build some really custom app, like custom <a href=\"https://mac-blog.org.ua/kubernetes-wireguard/\">wireguar</a>, we already can <a href=\"https://mac-blog.org.ua/msgraph-subscribe-users/\">watch for changes in active directory</a> so the only missing part left is storage - where can we store key pairs - why not store them directly in active directory user</p>\n<p>Exactly for such cases there is an <a href=\"https://learn.microsoft.com/en-us/graph/api/resources/opentypeextension?view=graph-rest-1.0\">open extensions</a> available</p>\n<p>We gonna need access token</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">access_token</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>az account get-access-token --resource-type ms-graph <span class=\"token parameter variable\">--query</span><span class=\"token operator\">=</span>accessToken <span class=\"token parameter variable\">-o</span> tsv<span class=\"token variable\">)</span></span></code></pre></div>\n<p>Create</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users/57434352-42b0-4090-9d36-9561ae89c607/extensions\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'{\n    \"@odata.type\": \"#microsoft.graph.openTypeExtension\",\n    \"extensionName\": \"ua.robota.mactemp\",\n    \"github\": \"mac2000\",\n    \"id\": \"ua.robota.mactemp\"\n}'</span></code></pre></div>\n<p>Update</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-X</span> PATCH <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users/57434352-42b0-4090-9d36-9561ae89c607/extensions/ua.robota.mactemp\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'{\n    \"github\": \"mac2001\",\n}'</span></code></pre></div>\n<p>Retrieve</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users/57434352-42b0-4090-9d36-9561ae89c607/extensions/ua.robota.mactemp\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token operator\">|</span> jq</code></pre></div>\n<p>Set for different user</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users/6c291093-7739-4f89-ad4d-c25072030e3d/extensions\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'{\n    \"@odata.type\": \"#microsoft.graph.openTypeExtension\",\n    \"extensionName\": \"ua.robota.mactemp\",\n    \"github\": \"bk\",\n    \"id\": \"ua.robota.mactemp\"\n}'</span></code></pre></div>\n<p>Delete</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-X</span> DELETE <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users/6c291093-7739-4f89-ad4d-c25072030e3d/extensions/ua.robota.mactemp\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span></code></pre></div>\n<p>To help find users here are few examples</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">tenant_id</span><span class=\"token operator\">=</span><span class=\"token string\">'695e64b5...'</span>\n<span class=\"token assign-left variable\">access_token</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>az account get-access-token --resource-type ms-graph <span class=\"token parameter variable\">--query</span><span class=\"token operator\">=</span>accessToken <span class=\"token parameter variable\">-o</span> tsv<span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># List all users</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users\"</span> <span class=\"token operator\">|</span> jq <span class=\"token string\">\".value\"</span>\n\n<span class=\"token comment\"># List only enabled users</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token string\">\"https://graph.microsoft.com/v1.0/users?\\<span class=\"token variable\">$top</span>=999&amp;\\<span class=\"token variable\">$filter</span>=accountEnabled%20eq%20true\"</span> <span class=\"token operator\">|</span> jq <span class=\"token string\">\".value[] | {id: .id, mail: .mail}\"</span> <span class=\"token operator\">|</span> pbcopy\n\n<span class=\"token comment\"># List users from group</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token string\">\"https://graph.microsoft.com/v1.0/groups/82281f89.../members?\\<span class=\"token variable\">$top</span>=999\"</span> <span class=\"token operator\">|</span> jq <span class=\"token string\">\".value[] | {id: .id, mail: (.mail | ascii_downcase)}\"</span>\n\n\n<span class=\"token comment\"># List groups, filtered by name, select id and mail only</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token string\">\"https://graph.microsoft.com/v1.0/groups?\\<span class=\"token variable\">$filter</span>=displayName%20eq%20'Hello%20World'&amp;\\<span class=\"token variable\">$select</span>=id,mail\"</span> <span class=\"token operator\">|</span> jq <span class=\"token string\">\".value[0]\"</span>\n\n<span class=\"token comment\"># Find group id by name</span>\n<span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token string\">\"https://graph.microsoft.com/v1.0/groups?\\<span class=\"token variable\">$filter</span>=displayName%20eq%20'Hello%20World'&amp;\\<span class=\"token variable\">$select</span>=id\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">\".value[0].id\"</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># List users from group</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token string\">\"https://graph.microsoft.com/v1.0/groups/<span class=\"token variable\">$gid</span>/members?\\<span class=\"token variable\">$top</span>=999&amp;\\<span class=\"token variable\">$select</span>=id,mail\"</span> <span class=\"token operator\">|</span> jq <span class=\"token string\">\".value[] | {id: .id, mail: (.mail | ascii_downcase)}\"</span></code></pre></div>\n<p>This approach may be used to wireup different services, aka thinking about having slack username, github username in active directory as well as other things that may be usefull</p>"}},"pageContext":{"id":"8bf39fc4-b346-52cc-9306-6b9f8fabf4e9"}},"staticQueryHashes":[],"slicesMap":{}}