{"componentChunkName":"component---src-templates-note-js","path":"/powershell-github-branch-protection-rules/","result":{"data":{"remark":{"fields":{"path":"powershell-github-branch-protection-rules"},"meta":{"title":""},"headings":[{"value":"Powershell github branch protection rules"}],"html":"<h1>Powershell github branch protection rules</h1>\n<p><strong>Goal:</strong> we want to make sure that all repositories has reasonable settings configured (at very minimum we want to protect main branch from deletion)</p>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$ErrorActionPreference = &quot;Stop&quot;\n\n$token = &#39;***********&#39; # GitHub App Password\n\n$query = @&quot;\nquery GetPrivateRepositoryProtectionRules(`$after: String) {\n  organization(login:&quot;rabotaua&quot;) {\n    repositories(first:100, privacy: PRIVATE, after: `$after) {\n      pageInfo {\n        endCursor\n        hasNextPage\n      }\n      nodes {\n        name\n        id\n        defaultBranchRef {\n          name\n        }\n        branchProtectionRules(first:10) {\n          nodes {\n            id\n            pattern\n            allowsDeletions\n            allowsForcePushes\n            requiredApprovingReviewCount\n            requiresApprovingReviews\n            requiresCodeOwnerReviews\n            requiresStatusChecks\n          }\n        }\n      }\n    }\n  }\n}\n&quot;@\n\n$createRule = @&quot;\nmutation CreateRule(`$repositoryId: ID!, `$pattern: String!) {\n  createBranchProtectionRule(input:{\n    repositoryId: `$repositoryId\n    pattern: `$pattern\n    allowsDeletions: false\n    allowsForcePushes: false\n    requiredApprovingReviewCount: 1\n    requiresApprovingReviews: true\n    requiresCodeOwnerReviews: true\n    requiresStatusChecks: true\n  }) {\n    branchProtectionRule {\n      id\n      pattern\n      allowsDeletions\n      allowsForcePushes\n      requiredApprovingReviewCount\n      requiresApprovingReviews\n      requiresCodeOwnerReviews\n      requiresStatusChecks\n    }\n  }\n}\n&quot;@\n\n$updateRule = @&quot;\nmutation UpdateRule(`$ruleId: ID!, `$pattern: String!) {\n  updateBranchProtectionRule(input:{\n    branchProtectionRuleId: `$ruleId\n    pattern: `$pattern\n    allowsDeletions: false\n    allowsForcePushes: false\n    requiredApprovingReviewCount: 1\n    requiresApprovingReviews: true\n    requiresCodeOwnerReviews: true\n    requiresStatusChecks: true\n  }) {\n    branchProtectionRule {\n      id\n      pattern\n      allowsDeletions\n      allowsForcePushes\n      requiredApprovingReviewCount\n      requiresApprovingReviews\n      requiresCodeOwnerReviews\n      requiresStatusChecks\n    }\n  }\n}\n&quot;@\n\n$variables = @{\n    after = $null\n}\n\n$repositories = @()\ndo {\n    $res = Invoke-RestMethod -Method Post https://api.github.com/graphql -Headers @{Authorization = &quot;Bearer $token&quot;} -ContentType &#39;application/json&#39; -Body (@{ query = $query; variables = $variables } | ConvertTo-Json)\n    $repositories += $res.data.organization.repositories.nodes\n    $variables.after = $res.data.organization.repositories.pageInfo.endCursor\n} while ($res.data.organization.repositories.pageInfo.hasNextPage)\n\n\n\n$repositoriesToSkip = @(\n    &#39;alliance&#39;,\n    &#39;test-owners&#39;\n)\n\nforeach($repository in $repositories) {\n    $name = $repository.name\n    if ($repositoriesToSkip.Contains($name)) {\n        Write-Host $name -ForegroundColor Cyan\n        continue\n    }\n\n    $defaultBranchName = $repository.defaultBranchRef.name\n\n    $rule = $null\n    foreach($node in $repository.branchProtectionRules.nodes) {\n        if ($node.pattern -eq $defaultBranchName) {\n            $rule = $node\n            break\n        }\n    }\n\n    if ($rule) {\n        $shouldUpdate = $false\n\n        if ($rule.allowsDeletions) {\n            $shouldUpdate = $true\n        }\n\n        if ($rule.allowsForcePushes) {\n            $shouldUpdate = $true\n        }\n\n        if ($rule.requiredApprovingReviewCount -lt 1) {\n            $shouldUpdate = $true\n        }\n\n        if (-not ($rule.requiresApprovingReviews)) {\n            $shouldUpdate = $true\n        }\n\n        if (-not ($rule.requiresCodeOwnerReviews)) {\n            $shouldUpdate = $true\n        }\n\n        if (-not ($rule.requiresStatusChecks)) {\n            $shouldUpdate = $true\n        }\n\n        if (-not ($shouldUpdate)) {\n            Write-Host $name -ForegroundColor Cyan\n            continue\n        }\n\n        $variables = @{\n            ruleId = $rule.id\n            pattern = $defaultBranchName\n        }\n        $res = Invoke-RestMethod -Method Post https://api.github.com/graphql -Headers @{Authorization = &quot;Bearer $token&quot;} -ContentType &#39;application/json&#39; -Body (@{ query = $updateRule; variables = $variables } | ConvertTo-Json)\n        if ($res.errors) {\n            $res.errors | select -ExpandProperty message\n            Write-Host $name -ForegroundColor Red\n        } else {\n            Write-Host $name -ForegroundColor Yellow\n        }\n    } else {\n        $variables = @{\n            repositoryId = $repository.id\n            pattern = $defaultBranchName\n        }\n        $res = Invoke-RestMethod -Method Post https://api.github.com/graphql -Headers @{Authorization = &quot;Bearer $token&quot;} -ContentType &#39;application/json&#39; -Body (@{ query = $createRule; variables = $variables } | ConvertTo-Json)\n        if ($res.errors) {\n            $res.errors | select -ExpandProperty message\n            Write-Host $name -ForegroundColor Red\n        } else {\n            Write-Host $name -ForegroundColor Green\n        }\n    }\n\n    Start-Sleep -Seconds 1\n}</code></pre></div>"}},"pageContext":{"id":"b8a06b44-575b-57f2-9f99-5539db66c858"}},"staticQueryHashes":[],"slicesMap":{}}