{"componentChunkName":"component---src-templates-note-js","path":"/drupal-batch-operations/","result":{"data":{"remark":{"fields":{"path":"drupal-batch-operations"},"meta":{"title":""},"headings":[{"value":"Drupal batch operations"}],"html":"<h1>Drupal batch operations</h1>\n<p>Example of script for internal use</p>\n<p><strong>macbatch.info</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token key attr-name\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">macbatch</span>\"</span>\n<span class=\"token key attr-name\">core</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">6.x</span>\"</span>\n<span class=\"token key attr-name\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">6.x-1.0</span>\"</span></code></pre></div>\n<p><strong>macbatch.module</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">macbatch_menu</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string single-quoted-string\">'macbatch'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string single-quoted-string\">'title'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'Batch'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'page callback'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'macbatch_page_callback'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'access arguments'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'administer access control'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'type'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'MENU_CALLBACK'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">_macbatch_finished</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$success</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$results</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$operations</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$success</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$message</span> <span class=\"token operator\">=</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$results</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">' processed.'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$message</span> <span class=\"token operator\">.=</span> <span class=\"token function\">theme</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'item_list'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$results</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$error_operation</span> <span class=\"token operator\">=</span> <span class=\"token function\">reset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$operations</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$message</span> <span class=\"token operator\">=</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'An error occurred while processing %error_operation with arguments: @arguments'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'%error_operation'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$error_operation</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'@arguments'</span> <span class=\"token operator\">=></span> <span class=\"token function\">print_r</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$error_operation</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">drupal_set_message</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$message</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">_macbatch_run</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">array</span> <span class=\"token variable\">$operations</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">batch_set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string single-quoted-string\">'operations'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$operations</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'finished'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'_macbatch_finished'</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">batch_process</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'node'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">macbatch_page_callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'_'</span> <span class=\"token operator\">.</span> <span class=\"token function\">arg</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token function\">call_user_func</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'_'</span> <span class=\"token operator\">.</span> <span class=\"token function\">arg</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'not found'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/////////////////////////////////////////////////////</span>\n\n<span class=\"token comment\">// will be accessible on url: http://example.com/macbatch/geo</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">_geo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// fill $operations arrray</span>\n    <span class=\"token variable\">$operations</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$q</span> <span class=\"token operator\">=</span> <span class=\"token function\">db_query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"SELECT nid FROM {node} WHERE type = 'salon'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$r</span> <span class=\"token operator\">=</span> <span class=\"token function\">db_fetch_object</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$q</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$operations</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'_geo_process'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$r</span><span class=\"token operator\">-></span><span class=\"token property\">nid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// and run batch on them</span>\n    <span class=\"token function\">_macbatch_run</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$operations</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// operation</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">_geo_process</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$nid</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token variable\">$context</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$node</span> <span class=\"token operator\">=</span> <span class=\"token function\">node_load</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$nid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//sleep(1);</span>\n    <span class=\"token variable\">$context</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'results'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">check_plain</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$node</span><span class=\"token operator\">-></span><span class=\"token property\">title</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>To create some batch job - u must define <code class=\"language-text\">YOUR_JOB_NAME</code> and <code class=\"language-text\">YOUR_JOB_NAME_process</code> functions.</p>\n<p>First must fill operations array, which will contains second function name, and array with params.</p>\n<p>Second will actualy do job.</p>"}},"pageContext":{"id":"b5b1b119-4d73-5622-99a1-91ac53d1b96e"}},"staticQueryHashes":[],"slicesMap":{}}