{"componentChunkName":"component---src-templates-note-js","path":"/elasticsearch-fix-number-of-replicas/","result":{"data":{"remark":{"fields":{"path":"elasticsearch-fix-number-of-replicas"},"meta":{"title":""},"headings":[{"value":"ElasticSearch fix number of replicas"}],"html":"<h1>ElasticSearch fix number of replicas</h1>\n<p><strong>problem:</strong> some service was configured in a such way that its index number of replicas was bigger than number of servers, because of that cluster become \"yellow\"</p>\n<p>to prevent such things and autome its healing following script may be used:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$max</span> = 2\n<span class=\"token variable\">$hostname</span> = <span class=\"token variable\">$env</span>:ES_HOSTNAME\n<span class=\"token variable\">$headers</span> = @<span class=\"token punctuation\">{</span>Authorization = <span class=\"token string\">\"Basic \"</span> <span class=\"token operator\">+</span> <span class=\"token namespace\">[Convert]</span>::ToBase64String<span class=\"token punctuation\">(</span><span class=\"token namespace\">[Text.Encoding]</span>::ASCII<span class=\"token punctuation\">.</span>GetBytes<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$env</span>:ES_USERNAME<span class=\"token punctuation\">)</span></span>:<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$env</span>:ES_PASSWORD<span class=\"token punctuation\">)</span></span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n<span class=\"token variable\">$indices</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://<span class=\"token variable\">$hostname</span>/_cat/indices?v&amp;health=yellow&amp;h=index,rep\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ForEach-Object</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span> <span class=\"token operator\">-replace</span> <span class=\"token string\">' +'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"`t\"</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertFrom-Csv</span> <span class=\"token operator\">-</span>Delimiter <span class=\"token string\">\"`t\"</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> rep <span class=\"token operator\">-GT</span> <span class=\"token variable\">$max</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty index\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$index</span> in <span class=\"token variable\">$indices</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Put <span class=\"token string\">\"https://<span class=\"token variable\">$hostname</span>/<span class=\"token variable\">$index</span>/_settings\"</span> <span class=\"token operator\">-</span>ContentType <span class=\"token string\">'application/json'</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span>@<span class=\"token punctuation\">{</span>number_of_replicas = <span class=\"token variable\">$max</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Json</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Post <span class=\"token string\">\"https://slack.com/api/chat.postMessage\"</span> <span class=\"token operator\">-</span>ContentType <span class=\"token string\">'application/json'</span> <span class=\"token operator\">-</span>Headers @<span class=\"token punctuation\">{</span> Authorization = <span class=\"token string\">\"Bearer <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$env</span>:SLACK_TOKEN<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span>@<span class=\"token punctuation\">{</span>channel = <span class=\"token string\">'#demo'</span><span class=\"token punctuation\">;</span> text = <span class=\"token string\">\"fixed number_of_replicas for <span class=\"token variable\">$index</span> index in <span class=\"token variable\">$hostname</span> elastic\"</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Json</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>"}},"pageContext":{"id":"765ccd1a-e283-5e4c-bcef-c0764c8283d6"}},"staticQueryHashes":[],"slicesMap":{}}