{"componentChunkName":"component---src-templates-note-js","path":"/git-sync-remote/","result":{"data":{"remark":{"fields":{"path":"git-sync-remote"},"meta":{"title":""},"headings":[{"value":"Distributed Git or keeping your remote in sync"}],"html":"<h1>Distributed Git or keeping your remote in sync</h1>\n<p>In my current setup I have laptop I'm working on, and small local server to play with.</p>\n<p>Let's pretend we want to have some web site with bunch of files hosted on server.</p>\n<p>We may:</p>\n<ul>\n<li>manually ssh into server and edit files there</li>\n<li>keep files locally and rsync them to remote</li>\n<li>use git ðŸ¤”</li>\n</ul>\n<p>Goal:</p>\n<ul>\n<li>as usual store repo in github</li>\n<li>have local clone to edit files and on server the same clone to host site</li>\n<li>once if push changes - they should automatically arrive to server</li>\n<li>ideally server may want to run some scripts once changes arrived</li>\n</ul>\n<p>Before proceeding there are two topics worth mentioning:</p>\n<ul>\n<li>bare repo - aka <code class=\"language-text\">git init --bare</code> - is an option when we want to have an central repo stored somewhere not in github and in our case not as usefull because we want rather forcibly push changes to remote</li>\n<li>setup without 3rd parties like github is possible</li>\n</ul>\n<p>Here is how can we do it without github</p>\n<p>On remote run following:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> ~/github.com/mac2000/demo\n<span class=\"token builtin class-name\">cd</span> ~/github.com/mac2000/demo\n<span class=\"token function\">git</span> init\n<span class=\"token builtin class-name\">echo</span> hello <span class=\"token operator\">></span> README.md\n<span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token builtin class-name\">.</span>\n<span class=\"token function\">git</span> commit <span class=\"token parameter variable\">-m</span> init\n\n<span class=\"token comment\"># allow remote push</span>\n<span class=\"token function\">git</span> config receive.denyCurrentBranch updateInstead</code></pre></div>\n<p>Locally run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone ssh://mini/~/github.com/mac2000/demo\n<span class=\"token builtin class-name\">cd</span> demo\n<span class=\"token builtin class-name\">echo</span> foo <span class=\"token operator\">></span> foo.txt\n<span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token builtin class-name\">.</span>\n<span class=\"token function\">git</span> commit <span class=\"token parameter variable\">-m</span> foo\n<span class=\"token function\">git</span> push</code></pre></div>\n<p>After push, you should see your changes on remote - profit ðŸŽ‰</p>\n<p><strong>Hooks</strong></p>\n<p><strong>pre-receive</strong></p>\n<p>There is one more thing we should take care of - if there are some changes on remote - our push will be rejected, and we won't know why, so on remote create following pre-receive hook</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">touch</span> .git/hooks/pre-receive\n<span class=\"token function\">chmod</span> +x .git/hooks/pre-receive\n<span class=\"token function\">vim</span> .git/hooks/pre-receive\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n<span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-e</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">git</span> --work-tree<span class=\"token operator\">=</span><span class=\"token punctuation\">..</span> status <span class=\"token parameter variable\">--short</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span> <span class=\"token parameter variable\">-ne</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"[pre-receive]: rejecting push beacause of local changes\"</span>\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n</code></pre></div>\n<p>now, whenever you push changes from your local machine, at least it will be clear what went wrong</p>\n<p>notes:</p>\n<ul>\n<li>from pre-receive hook we <strong>can not</strong> do things like <code class=\"language-text\">git clean</code>, <code class=\"language-text\">git reset</code>, ...</li>\n<li>pre-receive hook is ran in .git directory, that's why we passing <code class=\"language-text\">--work-tree=..</code></li>\n</ul>\n<p><strong>post-receive</strong></p>\n<p>Here is second one, for exapmle lets pretend we have node.js project</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">touch</span> .git/hooks/post-receive\n<span class=\"token function\">chmod</span> +x .git/hooks/post-receive\n<span class=\"token function\">vim</span> .git/hooks/post-receive\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n<span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-e</span>\n\n<span class=\"token builtin class-name\">eval</span> <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>/opt/homebrew/bin/brew shellenv<span class=\"token variable\">)</span></span>\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"[post-receive] npm install\"</span>\n<span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">--quiet</span> <span class=\"token parameter variable\">--prefix</span> <span class=\"token punctuation\">..</span>\n</code></pre></div>\n<p>notes:</p>\n<ul>\n<li>hooks will not have your profile, as a result empty <code class=\"language-text\">PATH</code>, so either use full path to executables, or like in this example eval brew env</li>\n<li>do not forget about working directory</li>\n<li>stdout and stderr of this script will be printed on local machine while pushing changes ðŸ’ª</li>\n</ul>\n<p>With this in place it is already possible to do whatever tricks we want</p>\n<p><strong>github</strong></p>\n<p>and for github setup is quite simple</p>\n<p>let's pretend we have created github.com/mac2000/demo, so on both machines run</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/mac2000/demo</code></pre></div>\n<p>to allow remote push, on remote machine, run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> config receive.denyCurrentBranch updateInstead</code></pre></div>\n<p>then prepare pre-receive and post-receive hooks as described above</p>\n<p>on local machine our goal now is to push to two remotes instead of one (github)</p>\n<p>to see configured remotes run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> remote show origin</code></pre></div>\n<p>to add one more remote to origin run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> remote set-url <span class=\"token parameter variable\">--add</span> <span class=\"token parameter variable\">--push</span> origin https://github.com/mac2000/demo\n<span class=\"token function\">git</span> remote set-url <span class=\"token parameter variable\">--add</span> <span class=\"token parameter variable\">--push</span> origin ssh://mini/~/github.com/mac2000/demo</code></pre></div>\n<p>note: we need to run this command twice, because initially this setting is unset and as soon as we ran first one, we will loose github, after running this commands <code class=\"language-text\">git remote show origin</code> should display both push urls</p>\n<p>and finally try to change, commit, push something - everything is wired up and you should see log similar to this one:</p>\n<div class=\"gatsby-highlight\" data-language=\"log\"><pre class=\"language-log\"><code class=\"language-log\"><span class=\"token property\">Enumerating objects:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">.</span>\n<span class=\"token property\">Counting objects:</span> <span class=\"token number\">100</span><span class=\"token operator\">%</span> <span class=\"token operator\">(</span><span class=\"token number\">6</span><span class=\"token operator\">/</span><span class=\"token number\">6</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">.</span>\nDelta compression using up to <span class=\"token number\">8</span> threads\n<span class=\"token property\">Compressing objects:</span> <span class=\"token number\">100</span><span class=\"token operator\">%</span> <span class=\"token operator\">(</span><span class=\"token number\">4</span><span class=\"token operator\">/</span><span class=\"token number\">4</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">.</span>\n<span class=\"token property\">Writing objects:</span> <span class=\"token number\">100</span><span class=\"token operator\">%</span> <span class=\"token operator\">(</span><span class=\"token number\">5</span><span class=\"token operator\">/</span><span class=\"token number\">5</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7.66</span> KiB <span class=\"token operator\">|</span> <span class=\"token number\">7.66</span> MiB<span class=\"token operator\">/</span>s<span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">.</span>\nTotal <span class=\"token number\">5</span> <span class=\"token operator\">(</span>delta <span class=\"token number\">0</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> reused <span class=\"token number\">0</span> <span class=\"token operator\">(</span>delta <span class=\"token number\">0</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> pack<span class=\"token operator\">-</span>reused <span class=\"token number\">0</span> <span class=\"token operator\">(</span>from <span class=\"token number\">0</span><span class=\"token operator\">)</span>\n<span class=\"token property\">remote:</span> <span class=\"token punctuation\">[</span>post<span class=\"token operator\">-</span>receive<span class=\"token punctuation\">]</span> npm install <span class=\"token operator\">#</span> ðŸ‘ˆ post<span class=\"token operator\">-</span>receive script in action\n<span class=\"token property\">remote:</span>\n<span class=\"token property\">remote:</span> added <span class=\"token number\">66</span> packages<span class=\"token punctuation\">,</span> and audited <span class=\"token number\">67</span> packages in <span class=\"token number\">438ms</span>\n<span class=\"token property\">remote:</span>\n<span class=\"token property\">remote:</span> <span class=\"token number\">14</span> packages are looking for funding\n<span class=\"token property\">remote:</span>   run `npm fund` for details\n<span class=\"token property\">remote:</span>\n<span class=\"token property\">remote:</span> found <span class=\"token number\">0</span> vulnerabilities\nTo ssh<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>mini<span class=\"token operator\">/</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span>github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>mac2000<span class=\"token operator\">/</span>demo <span class=\"token operator\">#</span> ðŸ‘ˆ pushed to our remote\n   <span class=\"token number\">6c32237</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>79b1693  main <span class=\"token operator\">-</span><span class=\"token operator\">></span> main\n<span class=\"token property\">Enumerating objects:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">.</span>\n<span class=\"token property\">Counting objects:</span> <span class=\"token number\">100</span><span class=\"token operator\">%</span> <span class=\"token operator\">(</span><span class=\"token number\">6</span><span class=\"token operator\">/</span><span class=\"token number\">6</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">.</span>\nDelta compression using up to <span class=\"token number\">8</span> threads\n<span class=\"token property\">Compressing objects:</span> <span class=\"token number\">100</span><span class=\"token operator\">%</span> <span class=\"token operator\">(</span><span class=\"token number\">4</span><span class=\"token operator\">/</span><span class=\"token number\">4</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">.</span>\n<span class=\"token property\">Writing objects:</span> <span class=\"token number\">100</span><span class=\"token operator\">%</span> <span class=\"token operator\">(</span><span class=\"token number\">5</span><span class=\"token operator\">/</span><span class=\"token number\">5</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7.66</span> KiB <span class=\"token operator\">|</span> <span class=\"token number\">7.66</span> MiB<span class=\"token operator\">/</span>s<span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">.</span>\nTotal <span class=\"token number\">5</span> <span class=\"token operator\">(</span>delta <span class=\"token number\">0</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> reused <span class=\"token number\">0</span> <span class=\"token operator\">(</span>delta <span class=\"token number\">0</span><span class=\"token operator\">)</span><span class=\"token punctuation\">,</span> pack<span class=\"token operator\">-</span>reused <span class=\"token number\">0</span> <span class=\"token operator\">(</span>from <span class=\"token number\">0</span><span class=\"token operator\">)</span>\nTo <span class=\"token url\">https://github.com/mac2000/demo</span>  <span class=\"token operator\">#</span> ðŸ‘ˆ pushed to github\n   <span class=\"token number\">6c32237</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>79b1693  main <span class=\"token operator\">-</span><span class=\"token operator\">></span> main</code></pre></div>\n<p><strong>troubleshooting</strong></p>\n<p>note if push to one origin fails, it won't stop git and it will try to push to others</p>\n<p>in such case there is possibility to catch following issue:</p>\n<ul>\n<li>on remote you have some changes</li>\n<li>as result push is prevented</li>\n<li>but push to github succeed</li>\n</ul>\n<p>so keep an eye on git push logs</p>\n<p><strong>alternatives</strong></p>\n<p>in my case, initially, i wanted to have something independed of github/bitbucket/gitlab/... which is kind of solved</p>\n<p>there are other ways to configure something similar is you are stick to github</p>\n<p>you may want to configure webhook on github side, it will call an endpoint on your server, which will git pull changes</p>\n<p>alternativelly you may provide ssh key to github and create some kind of github action that will ssh into your server and do the work</p>\n<p>both cases require server to be exposed somehow to external network and obviously you tied up with github</p>"}},"pageContext":{"id":"54f8097d-f87b-5974-8c6b-0ad31c9c6a60"}},"staticQueryHashes":[],"slicesMap":{}}