{"componentChunkName":"component---src-templates-note-js","path":"/mysql-payment-table-analysis/","result":{"data":{"remark":{"fields":{"path":"mysql-payment-table-analysis"},"meta":{"title":""},"headings":[{"value":"MySQL payment table analysis"}],"html":"<h1>MySQL payment table analysis</h1>\n<p><a href=\"http://downloads.mysql.com/docs/sakila-db.zip\">http://downloads.mysql.com/docs/sakila-db.zip</a> - training database with payment table.</p>\n<p>Run following to install it:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql <span class=\"token parameter variable\">-u</span> root <span class=\"token parameter variable\">-p</span> <span class=\"token operator\">&lt;</span> sakila-schema.sql\nmysql <span class=\"token parameter variable\">-u</span> root <span class=\"token parameter variable\">-p</span> <span class=\"token operator\">&lt;</span> sakila-data.sql</code></pre></div>\n<p>Here is how our payment table fields:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> COLUMN_NAME <span class=\"token keyword\">FROM</span> information_schema<span class=\"token punctuation\">.</span><span class=\"token keyword\">columns</span> <span class=\"token keyword\">WHERE</span> TABLE_NAME <span class=\"token operator\">=</span> <span class=\"token string\">'payment'</span> <span class=\"token operator\">AND</span> TABLE_SCHEMA <span class=\"token operator\">=</span> <span class=\"token string\">'sakila'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+--------------+\n| COLUMN_NAME  |\n+--------------+\n| payment_id   |\n| customer_id  |\n| staff_id     |\n| rental_id    |\n| amount       |\n| payment_date |\n| last_update  |\n+--------------+</code></pre></div>\n<p>We are interested in staff_id, amount and payment_date and want to get some analysis data on them.</p>\n<h2>ROLLUP</h2>\n<p>Usually we doing something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> staff_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> total <span class=\"token keyword\">FROM</span> sakila<span class=\"token punctuation\">.</span>payment <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> staff_id<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+----------+----------+\n| staff_id | total    |\n+----------+----------+\n|        1 | 33489.47 |\n|        2 | 33927.04 |\n+----------+----------+</code></pre></div>\n<p>And here is what <code class=\"language-text\">ROLLUP</code> can do:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> staff_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> total <span class=\"token keyword\">FROM</span> sakila<span class=\"token punctuation\">.</span>payment <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> staff_id <span class=\"token keyword\">WITH ROLLUP</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+----------+----------+\n| staff_id | total    |\n+----------+----------+\n|        1 | 33489.47 |\n|        2 | 33927.04 |\n|     NULL | 67416.51 |\n+----------+----------+</code></pre></div>\n<p>So rollup gathers information and counting total, it can be used to build cubes.</p>\n<p>Here is more complicated example:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n\t<span class=\"token keyword\">YEAR</span><span class=\"token punctuation\">(</span>payment_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> payment_year<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">(</span>payment_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> payment_month<span class=\"token punctuation\">,</span>\n\t<span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> total\n<span class=\"token keyword\">FROM</span> sakila<span class=\"token punctuation\">.</span>payment\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span>\n\t<span class=\"token keyword\">YEAR</span><span class=\"token punctuation\">(</span>payment_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">(</span>payment_date<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">WITH ROLLUP</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+--------------+---------------+----------+\n| payment_year | payment_month | total    |\n+--------------+---------------+----------+\n|         2005 |             5 |  4824.43 |\n|         2005 |             6 |  9631.88 |\n|         2005 |             7 | 28373.89 |\n|         2005 |             8 | 24072.13 |\n|         2005 |          NULL | 66902.33 |\n|         2006 |             2 |   514.18 |\n|         2006 |          NULL |   514.18 |\n|         NULL |          NULL | 67416.51 |\n+--------------+---------------+----------+</code></pre></div>\n<p>Notice how rollup counts sums for 2005, 2006 and total.</p>\n<h2>Date ranges</h2>\n<p>Lets try this:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n\t<span class=\"token keyword\">DATE</span><span class=\"token punctuation\">(</span>payment_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> payment_date<span class=\"token punctuation\">,</span>\n\t<span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> total\n<span class=\"token keyword\">FROM</span> sakila<span class=\"token punctuation\">.</span>payment\n<span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">(</span>payment_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'2005-08-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'2005-08-31'</span>\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">(</span>payment_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+--------------+---------+\n| payment_date | total   |\n+--------------+---------+\n| 2005-08-01   | 2817.29 |\n| 2005-08-02   | 2726.57 |\n| 2005-08-16   |  111.77 |\n| 2005-08-17   | 2457.07 |\n| 2005-08-18   | 2710.79 |\n| 2005-08-19   | 2615.72 |\n| 2005-08-20   | 2723.76 |\n| 2005-08-21   | 2809.41 |\n| 2005-08-22   | 2576.74 |\n| 2005-08-23   | 2523.01 |\n+--------------+---------+</code></pre></div>\n<p>You can see that we have no payments in the first half of the month.</p>\n<p>But lets assume that we need this data with zeros, to build some charts in our reports.</p>\n<p>After some searching seems that only possible way to do this in MySQL is to create separate calendar table and join in with results table.</p>\n<p>So, here is SQL to create table and stored procedure:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DROP</span> <span class=\"token keyword\">PROCEDURE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> FillCalendar<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> calendar<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> calendar<span class=\"token punctuation\">(</span>\n\tcalendar_date <span class=\"token keyword\">DATE</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">DELIMITER</span> $$\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">PROCEDURE</span> FillCalendar<span class=\"token punctuation\">(</span>start_date <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">,</span> end_date <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">BEGIN</span>\n\t<span class=\"token keyword\">DECLARE</span> crt_date <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">SET</span> crt_date <span class=\"token operator\">=</span> start_date<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">WHILE</span> crt_date <span class=\"token operator\">&lt;=</span> end_date <span class=\"token keyword\">DO</span>\n\t\t<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">IGNORE</span> <span class=\"token keyword\">INTO</span> calendar <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>crt_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">SET</span> crt_date <span class=\"token operator\">=</span> ADDDATE<span class=\"token punctuation\">(</span>crt_date<span class=\"token punctuation\">,</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token number\">1</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">END</span> <span class=\"token keyword\">WHILE</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span>$$\n<span class=\"token keyword\">DELIMITER</span> <span class=\"token punctuation\">;</span></code></pre></div>\n<p>And now we can call our procedure to fill desired dates range like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CALL</span> FillCalendar<span class=\"token punctuation\">(</span><span class=\"token string\">'2005-08-01'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'2005-08-31'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now lets try to make query joining our calendar and payment tables:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n\tcalendar<span class=\"token punctuation\">.</span>calendar_date <span class=\"token keyword\">AS</span> payment_date<span class=\"token punctuation\">,</span>\n\tIFNULL<span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>payment<span class=\"token punctuation\">.</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> total\n<span class=\"token keyword\">FROM</span> calendar\n<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> payment <span class=\"token keyword\">ON</span> calendar<span class=\"token punctuation\">.</span>calendar_date <span class=\"token operator\">=</span> <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">(</span>payment<span class=\"token punctuation\">.</span>payment_date<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">WHERE</span> calendar<span class=\"token punctuation\">.</span>calendar_date <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'2005-08-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'2005-08-31'</span>\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> calendar<span class=\"token punctuation\">.</span>calendar_date<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+--------------+---------+\n| payment_date | total   |\n+--------------+---------+\n| 2005-08-01   | 2817.29 |\n| 2005-08-02   | 2726.57 |\n| 2005-08-03   |    0.00 |\n| 2005-08-04   |    0.00 |\n| 2005-08-05   |    0.00 |\n| 2005-08-06   |    0.00 |\n| 2005-08-07   |    0.00 |\n| 2005-08-08   |    0.00 |\n| 2005-08-09   |    0.00 |\n| 2005-08-10   |    0.00 |\n| 2005-08-11   |    0.00 |\n| 2005-08-12   |    0.00 |\n| 2005-08-13   |    0.00 |\n| 2005-08-14   |    0.00 |\n| 2005-08-15   |    0.00 |\n| 2005-08-16   |  111.77 |\n| 2005-08-17   | 2457.07 |\n| 2005-08-18   | 2710.79 |\n| 2005-08-19   | 2615.72 |\n| 2005-08-20   | 2723.76 |\n| 2005-08-21   | 2809.41 |\n| 2005-08-22   | 2576.74 |\n| 2005-08-23   | 2523.01 |\n| 2005-08-24   |    0.00 |\n| 2005-08-25   |    0.00 |\n| 2005-08-26   |    0.00 |\n| 2005-08-27   |    0.00 |\n| 2005-08-28   |    0.00 |\n| 2005-08-29   |    0.00 |\n| 2005-08-30   |    0.00 |\n| 2005-08-31   |    0.00 |\n+--------------+---------+</code></pre></div>\n<p>Mission is almost accomplished, now we can split report into years, monthes, staffs and make rollups on them.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n\t<span class=\"token keyword\">YEAR</span><span class=\"token punctuation\">(</span>calendar<span class=\"token punctuation\">.</span>calendar_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> payment_year<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">(</span>calendar<span class=\"token punctuation\">.</span>calendar_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> payment_month<span class=\"token punctuation\">,</span>\n\tIFNULL<span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>payment<span class=\"token punctuation\">.</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> total\n<span class=\"token keyword\">FROM</span> calendar\n<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> payment <span class=\"token keyword\">ON</span> calendar<span class=\"token punctuation\">.</span>calendar_date <span class=\"token operator\">=</span> <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">(</span>payment<span class=\"token punctuation\">.</span>payment_date<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">WHERE</span> calendar<span class=\"token punctuation\">.</span>calendar_date <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'2005-07-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'2006-03-01'</span>\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">YEAR</span><span class=\"token punctuation\">(</span>calendar<span class=\"token punctuation\">.</span>calendar_date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">(</span>calendar<span class=\"token punctuation\">.</span>calendar_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">WITH ROLLUP</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+--------------+---------------+----------+\n| payment_year | payment_month | total    |\n+--------------+---------------+----------+\n|         2005 |             7 | 28373.89 |\n|         2005 |             8 | 24072.13 |\n|         2005 |             9 |     0.00 |\n|         2005 |            10 |     0.00 |\n|         2005 |            11 |     0.00 |\n|         2005 |            12 |     0.00 |\n|         2005 |          NULL | 52446.02 |\n|         2006 |             1 |     0.00 |\n|         2006 |             2 |   514.18 |\n|         2006 |             3 |     0.00 |\n|         2006 |          NULL |   514.18 |\n|         NULL |          NULL | 52960.20 |\n+--------------+---------------+----------+</code></pre></div>\n<p>Yes it is cube :)</p>"}},"pageContext":{"id":"000ef3fe-3372-517e-82f6-004efab85522"}},"staticQueryHashes":[],"slicesMap":{}}