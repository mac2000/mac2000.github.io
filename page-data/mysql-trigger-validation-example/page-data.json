{"componentChunkName":"component---src-templates-note-js","path":"/mysql-trigger-validation-example/","result":{"data":{"remark":{"fields":{"path":"mysql-trigger-validation-example"},"meta":{"title":""},"headings":[{"value":"MySQL Trigger Validation Example"}],"html":"<h1>MySQL Trigger Validation Example</h1>\n<p>In sql there is <code class=\"language-text\">CHECK</code> constraint that is ignored by MySQL, so here is workaround with triggers:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- SCHEMA</span>\n<span class=\"token comment\">-- ***********************************************************************</span>\n\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> customer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> customer <span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n\tage <span class=\"token keyword\">INT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\tname <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n\temail <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> email <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">-- CONSTRAINT chk_age CHECK (age > 18) -- MySQL ignores constraints</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8_unicode_ci<span class=\"token punctuation\">;</span>\n\n\n\n<span class=\"token comment\">-- STORED PROCEDURES</span>\n<span class=\"token comment\">-- ***********************************************************************</span>\n\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">PROCEDURE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> validate_customer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DELIMITER</span> $$\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">PROCEDURE</span> validate_customer<span class=\"token punctuation\">(</span>\n\t<span class=\"token operator\">IN</span> age <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token operator\">IN</span> email <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">DETERMINISTIC</span>\n<span class=\"token keyword\">NO</span> <span class=\"token keyword\">SQL</span>\n<span class=\"token keyword\">BEGIN</span>\n\t<span class=\"token keyword\">IF</span> age <span class=\"token operator\">&lt;</span> <span class=\"token number\">18</span> <span class=\"token keyword\">THEN</span>\n\t\tSIGNAL SQLSTATE <span class=\"token string\">'45000'</span> <span class=\"token keyword\">SET</span> MESSAGE_TEXT <span class=\"token operator\">=</span> <span class=\"token string\">'Age must be gte 18'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">END</span> <span class=\"token keyword\">IF</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> email <span class=\"token operator\">REGEXP</span> <span class=\"token string\">'$[A-Z0-9._%-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}$'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">THEN</span>\n\t\tSIGNAL SQLSTATE <span class=\"token string\">'45000'</span> <span class=\"token keyword\">SET</span> MESSAGE_TEXT <span class=\"token operator\">=</span> <span class=\"token string\">'Wrong email'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">END</span> <span class=\"token keyword\">IF</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span>$$\n<span class=\"token keyword\">DELIMITER</span> <span class=\"token punctuation\">;</span>\n\n\n\n<span class=\"token comment\">-- TRIGGERS</span>\n<span class=\"token comment\">-- ***********************************************************************</span>\n\n<span class=\"token keyword\">DELIMITER</span> $$\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TRIGGER</span> validate_customer_insert\nBEFORE <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">ON</span> customer <span class=\"token keyword\">FOR EACH ROW</span>\n<span class=\"token keyword\">BEGIN</span>\n\t<span class=\"token keyword\">CALL</span> validate_customer<span class=\"token punctuation\">(</span>NEW<span class=\"token punctuation\">.</span>age<span class=\"token punctuation\">,</span> NEW<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span>$$\n<span class=\"token keyword\">DELIMITER</span> <span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">DELIMITER</span> $$\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TRIGGER</span> validate_customer_update\nBEFORE <span class=\"token keyword\">UPDATE</span> <span class=\"token keyword\">ON</span> customer <span class=\"token keyword\">FOR EACH ROW</span>\n<span class=\"token keyword\">BEGIN</span>\n\t<span class=\"token keyword\">CALL</span> validate_customer<span class=\"token punctuation\">(</span>NEW<span class=\"token punctuation\">.</span>age<span class=\"token punctuation\">,</span> NEW<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span>$$\n<span class=\"token keyword\">DELIMITER</span> <span class=\"token punctuation\">;</span>\n\n\n\n<span class=\"token comment\">-- RUN THEM ALL :)</span>\n<span class=\"token comment\">-- ***********************************************************************</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> customer <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Alex\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"alex@example.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- Error Code: 1644: Age must be gte 18</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> customer <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Alex\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"alex\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- Error Code: 1644: Wrong email</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> customer<span class=\"token punctuation\">;</span> <span class=\"token comment\">-- Will be empty</span></code></pre></div>\n<p>We declare <code class=\"language-text\">validate_customer</code> stored procedure that will be used in both (insert, update) triggers to check input data.</p>"}},"pageContext":{"id":"04bf2846-d675-5726-b5b1-3af19dcc8100"}},"staticQueryHashes":[],"slicesMap":{}}