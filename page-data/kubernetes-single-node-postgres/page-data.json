{"componentChunkName":"component---src-templates-note-js","path":"/kubernetes-single-node-postgres/","result":{"data":{"remark":{"fields":{"path":"kubernetes-single-node-postgres"},"meta":{"title":""},"headings":[{"value":"kubernetes single node postgres"}],"html":"<h1>kubernetes single node postgres</h1>\n<h2>Step 1: Disk</h2>\n<p><strong>Note:</strong> this step is only for cloud, for local can be skipped, idea here to be able to control disk name and type, otherwise kubernetes will create disk with uuid name which is hard to manage in future</p>\n<p>Go to <a href=\"https://console.cloud.google.com/compute/disks?project=majestic-cairn-171208\">disks management</a> and create one</p>\n<ul>\n<li>Name: pg1</li>\n<li>Description: disk for \"pg1\" pod in kubernetes</li>\n<li>Type: SSD persistent disk</li>\n<li>Zone: europe-west1-b</li>\n<li>Size (GB): 10</li>\n</ul>\n<h2>Step 2: Password</h2>\n<p><strong>create password secret</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl create secret generic pg1 --from-literal<span class=\"token operator\">=</span>password<span class=\"token operator\">=</span><span class=\"token string\">'xxxxxxx'</span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li><strong>pg1</strong> is the name of secret at will be used later, keep eye on it and do not forget to rename it</li>\n<li>on the other hand it can be optional and you can reuse already created secret</li>\n</ul>\n<h2>Step 3: Persistent Volume</h2>\n<p>For local kubernetes use:</p>\n<p><strong>local.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolume\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pg1<span class=\"token punctuation\">-</span>pv\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> manual\n  <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 10G\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ReadWriteOnce\n  <span class=\"token key atrule\">hostPath</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># TODO: do not forget to change me</span>\n    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/Users/mac/Desktop/pgkube/data\"</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pg1<span class=\"token punctuation\">-</span>pvc\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> manual\n  <span class=\"token key atrule\">volumeName</span><span class=\"token punctuation\">:</span> pg1<span class=\"token punctuation\">-</span>pv\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ReadWriteOnce\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 10G</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> local.yml\nkubectl get pv,pvc</code></pre></div>\n<p>For cloud kubernetes:</p>\n<p><strong>cloud.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolume\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pg1<span class=\"token punctuation\">-</span>pv\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 10G\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ReadWriteOnce\n  <span class=\"token key atrule\">gcePersistentDisk</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># https://console.cloud.google.com/compute/disksDetail/zones/europe-west1-b/disks/es1?project=majestic-cairn-171208</span>\n    <span class=\"token comment\"># TODO: change \"pg1\" to your disk name</span>\n    <span class=\"token key atrule\">pdName</span><span class=\"token punctuation\">:</span> pg1\n    <span class=\"token key atrule\">fsType</span><span class=\"token punctuation\">:</span> ext4\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pg1<span class=\"token punctuation\">-</span>pvc\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">volumeName</span><span class=\"token punctuation\">:</span> pg1<span class=\"token punctuation\">-</span>pv\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ReadWriteOnce\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 10G</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> cloud.yml\nkubectl get pv,pvc</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>use same <strong>metadata.name</strong> for both local and cloud persistent volumes in order to prevent confusion</li>\n<li><strong>gcePersistentDisk.pdName</strong> is a disk name you have created in step 1</li>\n<li><strong>capacity.storage</strong> can not be bigger than a disk space</li>\n<li><a href=\"https://www.youtube.com/watch?v=VB7vI9OT-WQ\">kubernetes persistent volume 5 minutes video</a></li>\n<li>in either case look for <code class=\"language-text\">bound</code> status in <code class=\"language-text\">kubectl get pv,pvc</code></li>\n</ul>\n<h2>Step 4: Postgres</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pg1\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> pg1\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pg1\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> postgres<span class=\"token punctuation\">:</span>12<span class=\"token punctuation\">-</span>alpine\n      <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5432</span>\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> POSTGRES_USER\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> pg1\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> POSTGRES_PASSWORD\n          <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">secretKeyRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pg1\n              <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> password\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> PGDATA\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> /postgres/data\n      <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> data\n          <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /postgres\n      <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 128M\n        <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 512M\n      <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> pg_isready\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>U\n            <span class=\"token punctuation\">-</span> $POSTGRES_USER\n        <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">15</span>\n        <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n      <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> pg_isready\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>U\n            <span class=\"token punctuation\">-</span> $POSTGRES_USER\n        <span class=\"token key atrule\">initialDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">45</span>\n        <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> data\n      <span class=\"token key atrule\">persistentVolumeClaim</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">claimName</span><span class=\"token punctuation\">:</span> pg1<span class=\"token punctuation\">-</span>pvc\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pg1\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5432</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> pg1</code></pre></div>\n<p>Connect to running postgres</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> pg1 psql -- <span class=\"token parameter variable\">-U</span> pg1</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>service is a headless so postgres will be accessible by hostname for other pods in same namespace but wont be accessible outside</li>\n<li>do not forget to tune limits and change username</li>\n<li>example with configuration file can be found <a href=\"https://bitbucket.org/rabotaua/sentry/src/master/postgres.yml\">here</a></li>\n</ul>"}},"pageContext":{"id":"5fff8561-4db6-5411-be6b-cd690f455f23"}},"staticQueryHashes":[],"slicesMap":{}}