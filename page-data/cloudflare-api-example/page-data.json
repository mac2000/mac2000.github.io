{"componentChunkName":"component---src-templates-note-js","path":"/cloudflare-api-example/","result":{"data":{"remark":{"fields":{"path":"cloudflare-api-example"},"meta":{"title":""},"headings":[{"value":"Cloudflare API example"},{"value":"Step 2: send to slack"}],"html":"<h1>Cloudflare API example</h1>\n<p>Example below sends to Slack notifications about rate limit events</p>\n<h2>Step 1: retrive event logs from cloud flare for last $minutes</h2>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">try {\n    if ([Net.ServicePointManager]::SecurityProtocol -notcontains &#39;Tls12&#39;) {\n        [Net.ServicePointManager]::SecurityProtocol += [Net.SecurityProtocolType]::Tls12\n    }\n}\ncatch {\n    throw &quot;Can not enable Tls12&quot;\n}\n\n$headers = @{\n    &#39;Content-Type&#39; = &#39;application/json&#39;\n    &#39;X-Auth-Key&#39; = &#39;*******&#39;\n    &#39;X-Auth-Email&#39; = &#39;svc@rabota.ua&#39;\n}\n\nInvoke-RestMethod -Method Get -Uri &#39;https://api.cloudflare.com/client/v4/zones/63c7bbdac4f7f5f3cd76a100039b3416/dns_records?type=CNAME&#39; -Headers $headers -UseBasicParsing | select -ExpandProperty result\n\n\n$since = (Get-Date((Get-Date).AddMinutes(-60).ToUniversalTime()) -format u).Replace(&#39; &#39;, &#39;T&#39;)\n$result = Invoke-RestMethod -Method Get -Uri &quot;https://api.cloudflare.com/client/v4/zones/63c7bbdac4f7f5f3cd76a100039b3416/security/events?since=$since&amp;kind=firewall&amp;source=rateLimit&quot; -Headers $headers -UseBasicParsing | select -ExpandProperty result</code></pre></div>\n<h1>Step 2: send to slack</h1>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$attachments = @()\nforeach($item in $result) {\n    $color = &#39;danger&#39;\n    if ($item.action -eq &#39;simulate&#39;) {\n        $color = &#39;good&#39;\n    }\n\n    $fields = @()\n\n    foreach($title in @(&#39;kind&#39;, &#39;source&#39;, &#39;action&#39;, &#39;ip&#39;, &#39;ip_class&#39;, &#39;country&#39;, &#39;colo&#39;, &#39;host&#39;, &#39;uri&#39;, &#39;ua&#39;)) {\n        $value = $item | select -ExpandProperty $title\n        $short = $true\n        if ($title -in @(&#39;host&#39;, &#39;uri&#39;, &#39;ua&#39;)) {\n            $short = $false\n        }\n        if ($value) {\n            $fields += @{\n                title = $title\n                value = $value\n                short = $short\n            }\n        }\n    }\n\n    $attachments += @{\n        color = $color\n        fields = $fields\n    }\n}\n\n$payload = @{\n    channel = &#39;#cloudflare&#39;\n    username = &#39;Cloudfalre&#39;\n    icon_url = &#39;https://www.cloudflare.com/apple-touch-icon-120x120.png&#39;\n    attachments = $attachments\n}\n\nInvoke-RestMethod -Uri &#39;https://hooks.slack.com/services/T035G4UK7/B4W2UT87P/xxxxxxxx&#39; -Method Post -Body ([System.Text.Encoding]::UTf8.GetBytes(($payload | ConvertTo-Json -Depth 100 -Compress)))</code></pre></div>\n<p>Other examples:</p>\n<p><strong>add cname record</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">\"https://api.cloudflare.com/client/v4/zones/63c7bbdac4f7f5f3cd76a100039b3416/dns_records\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"X-Auth-Key: <span class=\"token variable\">$cfkey</span>\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"X-Auth-Email: svc@rabota.ua\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">--data</span> <span class=\"token string\">'{\"type\":\"CNAME\",\"name\":\"'</span>\"<span class=\"token variable\">$bucket</span><span class=\"token string\">\"'\"</span>,<span class=\"token string\">\"content\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"'\"</span><span class=\"token variable\">$bucket</span><span class=\"token string\">\"'.s3-website.eu-central-1.amazonaws.com\"</span>,<span class=\"token string\">\"ttl\"</span>:1,<span class=\"token string\">\"proxied\"</span>:true<span class=\"token punctuation\">}</span>'</code></pre></div>\n<p><strong>retrieve and delete cname</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">id</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token string\">\"https://api.cloudflare.com/client/v4/zones/63c7bbdac4f7f5f3cd76a100039b3416/dns_records?type=CNAME&amp;name=<span class=\"token variable\">$bucket</span>\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"X-Auth-Key: <span class=\"token variable\">$cfkey</span>\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"X-Auth-Email: yura@rabota.ua\"</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">\\</span>\n    python3 <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"import sys, json; print(json.load(sys.stdin)['result'][0]['id'])\"</span><span class=\"token variable\">`</span></span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> DELETE <span class=\"token string\">\"https://api.cloudflare.com/client/v4/zones/63c7bbdac4f7f5f3cd76a100039b3416/dns_records/<span class=\"token variable\">$id</span>\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"X-Auth-Key: <span class=\"token variable\">$cfkey</span>\"</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"X-Auth-Email: yura@rabota.ua\"</span></code></pre></div>"}},"pageContext":{"id":"fd793b0c-847e-5bdb-92b7-a12246a72ede"}},"staticQueryHashes":[],"slicesMap":{}}