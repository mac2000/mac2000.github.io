{"componentChunkName":"component---src-templates-note-js","path":"/googlesheets-storage-crud/","result":{"data":{"remark":{"fields":{"path":"googlesheets-storage-crud"},"meta":{"title":""},"headings":[{"value":"Using Google Sheets as main storage for service"}],"html":"<h1>Using Google Sheets as main storage for service</h1>\n<p>From time to time there is need to create some nano services, that will have really small amount of data and/or active users.</p>\n<p>For such services one of best ever solutions will be simple things like sqlite or even plain json file.</p>\n<p>But what if we need to give a way to modify data for internal users, should we build an admin pages for that?</p>\n<p>Here is where Google Sheets may become helpful.</p>\n<p>Lets pretend we have an two sheets like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dfa7af41a4c6d2453c06f18737788e53/df438/sheet.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.296875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACTElEQVR42rWTzWrbQBDHfW+vzXPkUWLyGIVAwFAiUoLBb1F6Kr3U9GroKSBwaCk1pgmpSUtsy5Il62P1tZZkra3p7NiSRepCLx34e2Z3Z3+enV01GmifhsNn/aF5pPbUF6qKQt/r9SrJucFgQKJ1Va3mpe/3+0fX19fPG6UtxrM3S+8RDN8ImOvxKAp5HEck/OGu63DD0LllzbnnutxxbM6Yxx3b5r7PAsyHyWTytgIahtUFNCfkgoUpuH6M4uBHKQTxCuMljS0nAC9MYOGGENBaJiXkXt20PlZATTcJGMap8BBm2gxcFiMwgTjJIeQrkhxL73gR/VmcCIiWOQFNy64BtTEBTT8XM2eJG3xYZamcAiFyKDYb2OwERUFezhUYr4UgoGXVKrz/qXdNtoKHqSPmLIexZkHg+5BlGRiGAWEYQpqmpCRJnoqA2MM98NfU7C5YAjdfvomJ7sDt/QPc3X4HH6Gj0Ygkq5HFSK3X60piV6Gu63sglktH9jxXxHhjeIPgeh5VxhgjL4FFedyd34mAtl3rIdIJKFtWbpRWxtQrrEYCSl8Kx9se1oHYp+72AoSoH6euGuAg8GCFcrGefEj/BNQ07cPuyDkmFZhEwoJJZfzU7+Kcnpxp/nnkVY6vDt9pvn2rB63sb80oGRl74Hg6fZfla/x8FsvZ3M4+3y2yrz/cbGb52dyyMhaEWRjzgwqieCk2BTxOpu8rYKvVOm53OqeXV1cnivK6eXauNF+eKc3zltJ8pShNOfc3XVxcnrTbndOWohw3/of9Bps0xo6CY3ixAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Google Sheet\"\n        title=\"\"\n        src=\"/static/dfa7af41a4c6d2453c06f18737788e53/2bef9/sheet.png\"\n        srcset=\"/static/dfa7af41a4c6d2453c06f18737788e53/6f3f2/sheet.png 256w,\n/static/dfa7af41a4c6d2453c06f18737788e53/01e7c/sheet.png 512w,\n/static/dfa7af41a4c6d2453c06f18737788e53/2bef9/sheet.png 1024w,\n/static/dfa7af41a4c6d2453c06f18737788e53/71c1d/sheet.png 1536w,\n/static/dfa7af41a4c6d2453c06f18737788e53/df438/sheet.png 1556w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><a href=\"https://docs.google.com/spreadsheets/d/19sdWNuvlixPtEW3w5KRCosVm0iltpdbTm-o9FET1q-s\">Sample sheet</a></p>\n<p>Benefits are:</p>\n<ul>\n<li>users are already familiar with Google Sheets</li>\n<li>we may add some data protection rules</li>\n<li>we may protect sheets and ranges from editing</li>\n<li>there is an rest api</li>\n</ul>\n<p>To keep things simple I am going to use service account credentials and nodejs samples taken from <a href=\"https://github.com/googleworkspace/node-samples/tree/main/sheets/snippets\">here</a></p>\n<blockquote>\n<p>Note: there is nothing fancy, just want to have something ready to be copy pasted</p>\n</blockquote>\n<p><div class=\"gatsby-highlight\" data-language=\"mjs\"><pre class=\"language-mjs\"><code class=\"language-mjs\">import express from &#39;express&#39;\nimport { GoogleAuth } from &#39;google-auth-library&#39;\nimport { google } from &#39;googleapis&#39;\nimport { readFileSync } from &#39;fs&#39;\n\n// Sample sheet: https://docs.google.com/spreadsheets/d/19sdWNuvlixPtEW3w5KRCosVm0iltpdbTm-o9FET1q-s\nconst spreadsheetId = &#39;19sdWNuvlixPtEW3w5KRCosVm0iltpdbTm-o9FET1q-s&#39;\n// Sample table for products list\nconst range = &#39;products!A:C&#39;\n// Unformatted will return raw value like numeric 600, formatted will return formatted string values like &quot;$600&quot; instead\nconst valueRenderOption = &#39;UNFORMATTED_VALUE&#39;\n\n// Instance of GoogleSheets API client\nconst { client_email, private_key } = JSON.parse(readFileSync(&#39;/Users/mac/Library/Mobile Documents/com~apple~CloudDocs/Certs/alexandrm.json&#39;, &#39;utf-8&#39;))\nconst auth = new GoogleAuth({ scopes: [&#39;https://www.googleapis.com/auth/spreadsheets&#39;], credentials: { client_email, private_key } })\nconst service = google.sheets({ version: &#39;v4&#39;, auth })\n\n// Usual express stuff\nconst app = express()\napp.use(express.json())\n\n/**\n * Retrieve products list\n *\n * Request:\n * curl http://localhost:3000/products\n *\n * Response:\n * [\n *   [&quot;sku&quot;,&quot;name&quot;,&quot;price&quot;],\n *   [&quot;iphone15&quot;,&quot;iPhone 15&quot;,600],\n *   [&quot;iphone15pro&quot;,&quot;iPhone 15 Pro&quot;,900],\n *   [&quot;macbook-pro-14&quot;,&quot;MacBook Pro 14&quot;,2700]\n * ]\n */\napp.get(&#39;/products&#39;, async (_, res) =&gt; {\n  const result = await service.spreadsheets.values.get({ spreadsheetId, range, valueRenderOption })\n  return res.json(result.data.values)\n})\n\n/**\n * Retrieve product by sku\n *\n * Remember - we are not talking here about bazillion records and/or performance\n * this approach should be enough and can be always cached.\n * Also think of this - if there is really quadrillion of products - how it will be handled by GoogleSheet?\n *\n * Request:\n * curl http://localhost:3000/products/iphone15\n *\n * Response:\n * [&quot;iphone15&quot;,&quot;iPhone 15&quot;,600]\n */\napp.get(&#39;/products/:sku&#39;, async (req, res) =&gt; {\n  const result = await service.spreadsheets.values.get({\n    spreadsheetId,\n    range,\n    valueRenderOption: &#39;UNFORMATTED_VALUE&#39;,\n  })\n  return res.json(result.data.values.find((row) =&gt; row[0] === req.params.sku))\n})\n\n/**\n * Create product\n *\n * Request:\n * curl -X POST http://localhost:3000/products -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;sku&quot;:&quot;watch4&quot;,&quot;name&quot;:&quot;Watch 4&quot;,&quot;price&quot;:400}&#39;\n *\n * Response:\n * {&quot;spreadsheetId&quot;:&quot;19sdWNuvlixPtEW3w5KRCosVm0iltpdbTm-o9FET1q-s&quot;,&quot;tableRange&quot;:&quot;products!A1:C4&quot;,&quot;updates&quot;:{&quot;spreadsheetId&quot;:&quot;19sdWNuvlixPtEW3w5KRCosVm0iltpdbTm-o9FET1q-s&quot;,&quot;updatedRange&quot;:&quot;products!A5:C5&quot;,&quot;updatedRows&quot;:1,&quot;updatedColumns&quot;:3,&quot;updatedCells&quot;:3}}\n */\napp.post(&#39;/products&#39;, async (req, res) =&gt; {\n  // Note: pretend we did all validation here\n  const { sku, name, price } = req.body\n  const result = await service.spreadsheets.values.append({\n    spreadsheetId,\n    range,\n    valueInputOption: &#39;USER_ENTERED&#39;,\n    requestBody: { values: [[sku, name, price]] },\n  })\n  // Technically we should return 201 here, but for curiosity lets see whats returned by GoogleSheets API\n  return res.json(result.data)\n})\n\n/**\n * Update product\n *\n * Request:\n * curl -X PUT http://localhost:3000/products/iphone15 -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;sku&quot;:&quot;iphone15&quot;,&quot;name&quot;:&quot;iPhone 15&quot;,&quot;price&quot;:700}&#39;\n *\n * Response:\n * {&quot;spreadsheetId&quot;:&quot;19sdWNuvlixPtEW3w5KRCosVm0iltpdbTm-o9FET1q-s&quot;,&quot;updatedRange&quot;:&quot;products!A2:C2&quot;,&quot;updatedRows&quot;:1,&quot;updatedColumns&quot;:3,&quot;updatedCells&quot;:3}\n */\napp.put(&#39;/products/:sku&#39;, async (req, res) =&gt; {\n  // Note: pretend we did all validation here\n  const { sku, name, price } = req.body\n\n  // Lets receive products first, to find index of product we want to update\n  // once again - keep in mind we are not talking about performance here\n  const products = await service.spreadsheets.values.get({\n    spreadsheetId,\n    range,\n    valueRenderOption: &#39;UNFORMATTED_VALUE&#39;,\n  })\n  const index = products.data.values.findIndex((row) =&gt; row[0] === req.params.sku)\n\n  const result = await service.spreadsheets.values.update({\n    spreadsheetId,\n    range: &#39;products!A&#39; + (index + 1) + &#39;:C&#39; + (index + 1),\n    valueInputOption: &#39;USER_ENTERED&#39;,\n    requestBody: { values: [[sku, name, price]] },\n  })\n  return res.json(result.data)\n})\n\n/**\n * Delete product\n *\n * Request:\n * curl -X DELETE http://localhost:3000/products/iphone15\n *\n * Response:\n * {&quot;spreadsheetId&quot;:&quot;19sdWNuvlixPtEW3w5KRCosVm0iltpdbTm-o9FET1q-s&quot;,&quot;replies&quot;:[{}]}\n */\napp.delete(&#39;/products/:sku&#39;, async (req, res) =&gt; {\n  const products = await service.spreadsheets.values.get({\n    spreadsheetId,\n    range,\n    valueRenderOption: &#39;UNFORMATTED_VALUE&#39;,\n  })\n  const index = products.data.values.findIndex((row) =&gt; row[0] === req.params.sku)\n\n  const result = await service.spreadsheets.batchUpdate({\n    spreadsheetId,\n    requestBody: {\n      requests: [\n        {\n          deleteDimension: {\n            range: {\n              sheetId: 0,\n              dimension: &#39;ROWS&#39;,\n              startIndex: index,\n              endIndex: index + 1,\n            },\n          },\n        },\n      ],\n    },\n  })\n  return res.json(result.data)\n})\n\napp.listen(3000)</code></pre></div></p>\n<p>Notes to keep in mind:</p>\n<ul>\n<li>it is just an demo and is not about performance</li>\n<li>for those complaining - think of how Google will handle sheet with quadrillion of records</li>\n<li>by intent things keeped simple and copy pasted</li>\n</ul>\n<p>Links:</p>\n<ul>\n<li><a href=\"https://github.com/googleworkspace/node-samples/tree/main/sheets/snippets\">Google Sheets Node.js Snippets</a></li>\n<li><a href=\"https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets.values/update\">Method: spreadsheets.values.update</a></li>\n</ul>\n<p>Just in case here is crafted PHP sample</p>\n<p><div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">require_once</span> <span class=\"token string single-quoted-string\">'vendor/autoload.php'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$client</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name class-name-fully-qualified\">Google<span class=\"token punctuation\">\\</span>Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// $client->setAuthConfig('/Users/mac/Library/Mobile Documents/com~apple~CloudDocs/Certs/alexandrm.json');</span>\n<span class=\"token function\">putenv</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'GOOGLE_APPLICATION_CREDENTIALS=/Users/mac/Library/Mobile Documents/com~apple~CloudDocs/Certs/alexandrm.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$client</span><span class=\"token operator\">-></span><span class=\"token function\">useApplicationDefaultCredentials</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$client</span><span class=\"token operator\">-></span><span class=\"token function\">addScope</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'https://www.googleapis.com/auth/spreadsheets'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$service</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name class-name-fully-qualified\">Google<span class=\"token punctuation\">\\</span>Service<span class=\"token punctuation\">\\</span>Sheets</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$client</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$service</span><span class=\"token operator\">-></span><span class=\"token property\">spreadsheets_values</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'19sdWNuvlixPtEW3w5KRCosVm0iltpdbTm-o9FET1q-s'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'products!A:C'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'valueRenderOption'</span><span class=\"token operator\">=></span><span class=\"token string single-quoted-string\">'UNFORMATTED_VALUE'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">echo</span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token operator\">-></span><span class=\"token function\">getValues</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre></div></p>"}},"pageContext":{"id":"599767ac-eddd-5ff9-9454-24ddec4fa222"}},"staticQueryHashes":[],"slicesMap":{}}