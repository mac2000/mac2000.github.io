{"componentChunkName":"component---src-templates-note-js","path":"/azure-kubernetes-powershell-scripts/","result":{"data":{"remark":{"fields":{"path":"azure-kubernetes-powershell-scripts"},"meta":{"title":""},"headings":[{"value":"Azure Kubernetes Powershell Scripts"}],"html":"<h1>Azure Kubernetes Powershell Scripts</h1>\n<h2>Mass resources change</h2>\n<p>Необходимо добавить 10% по памяти всем всем всем деплойментам</p>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$deployments = kubectl get deployments -o json | ConvertFrom-Json | Select-Object -ExpandProperty items\n\nforeach($deployment in $deployments) {\n    # $deployment = $deployments |? { $_.metadata.name -eq &#39;users-api&#39; }\n    foreach($container in $deployment.spec.template.spec.containers) {\n        # $container = $deployment.spec.template.spec.containers[0]\n        if (-not $container.resources.requests.memory) {\n            Write-Host &quot;$($($deployment.metadata.name)) has no memory requests - skipping&quot; -ForegroundColor Cyan\n            continue\n        }\n        if (-not $container.resources.limits.memory) {\n            Write-Host &quot;$($($deployment.metadata.name)) has no memory limits - skipping&quot; -ForegroundColor Cyan\n            continue\n        }\n        if ($container.resources.requests.memory.Contains(&#39;Gi&#39;) -or $container.resources.limits.memory.Contains(&#39;Gi&#39;)) {\n            Write-Host &quot;$($($deployment.metadata.name)) has big memory requests of $($($container.resources.requests.memory)) - skipping&quot; -ForegroundColor Cyan\n            continue\n        }\n\n        $requestsCurrent = [int]$container.resources.requests.memory.Replace(&#39;Gi&#39;, &#39;000&#39;).Replace(&#39;Mi&#39;, &#39;&#39;)\n        $requestsDesired = [math]::Ceiling( $requestsCurrent * 1.1 / 10 ) * 10\n\n        $limitsCurrent = [int]$container.resources.limits.memory.Replace(&#39;Mi&#39;, &#39;&#39;)\n        $limitsDesired = [math]::Ceiling( $limitsCurrent * 1.1 / 10 ) * 10\n\n        # Write-Host &quot;$($deployment.metadata.name) requests $requestsCurrent &gt; $requestsDesired limits $limitsCurrent &gt; $limitsDesired&quot;\n\n        $patch = @{\n            spec = @{\n                template = @{\n                    spec = @{\n                        containers = @(\n                            @{\n                                name = $container.name\n                                resources = @{\n                                    requests = @{\n                                        memory = &quot;$($requestsDesired)Mi&quot;\n                                    }\n                                    limits = @{\n                                        memory = &quot;$($limitsDesired)Mi&quot;\n                                        cpu = $null\n                                    }\n                                }\n                            }\n                        )\n                    }\n                }\n            }\n        } | ConvertTo-Json -Compress -Depth 100\n        Write-Host &quot;kubectl patch deployment $($deployment.metadata.name) -p &#39;$patch&#39;&quot;\n    }\n}</code></pre></div>\n<p>Примечание: это скрипт который на деле ничего не меняет и просто генерит команды для каждого деплоймента, далее руками для самых больших и важных по ощущениям выполняем, глядим что бы применилось и что приложешька заработала, как набрались уверенности уже массово все применяем</p>\n<h2>Kubernetes Mass Node Affinity Change</h2>\n<p>This script was used to mass change of node affinity from \"app\" to \"svc\" while separating foreground and background workloads</p>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">kubectx test\nkubens test2\n\n$deployments = kubectl get deployments -o json | ConvertFrom-Json | Select-Object -ExpandProperty items\n\nforeach($deployment in $deployments) {\n    if ($deployment.metadata.name -in $(&#39;alliance-jobmob&#39;, &#39;chat-api-job-redis&#39;, &#39;employer-events-api&#39;, &#39;mailhog&#39;)) { continue }\n    if ($deployment.metadata.name.ToLower() -notmatch &#39;mail|consumer|event|job&#39;) { continue }\n    $affinity = $deployment.spec.template.spec.affinity\n    if (-not $affinity) { continue }\n    if ($affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[0] -eq &#39;svc&#39;) { continue }\n    $affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[0] = &#39;svc&#39;\n    $patch = ConvertTo-Json -Compress -Depth 100 -InputObject @{\n        spec = @{\n            template = @{\n                spec = @{\n                    affinity = $affinity\n                }\n            }\n        }\n    }\n\n\n    Write-Host &quot;kubectl patch deployment $($deployment.metadata.name) -p &#39;$patch&#39;&quot;\n    Write-Host &quot;kubectl rollout status deployment/$($deployment.metadata.name) --timeout=1m&quot;\n    Write-Host &quot;&quot;\n}\n\n$cronjobs = kubectl get cronjobs -o json | ConvertFrom-Json | Select-Object -ExpandProperty items\nforeach($cronjob in $cronjobs) {\n    $affinity = $cronjob.spec.jobTemplate.spec.template.spec.affinity\n    if (-not $affinity) { continue }\n    if ($affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[0] -eq &#39;svc&#39;) { continue }\n    $affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[0] = &#39;svc&#39;\n    $patch = ConvertTo-Json -Compress -Depth 100 -InputObject @{\n        spec = @{\n            jobTemplate = @{\n                spec = @{\n                    template = @{\n                        spec = @{\n                            affinity = $affinity\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    Write-Host &quot;kubectl patch cronjob $($cronjob.metadata.name) -p &#39;$patch&#39;&quot;\n}</code></pre></div>"}},"pageContext":{"id":"06fa334e-ce73-55aa-b8c2-13d8c79e6789"}},"staticQueryHashes":[],"slicesMap":{}}