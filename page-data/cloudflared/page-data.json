{"componentChunkName":"component---src-templates-note-js","path":"/cloudflared/","result":{"data":{"remark":{"fields":{"path":"cloudflared"},"meta":{"title":""},"headings":[{"value":"CloudflarD to Nginx on Mac Mini Homelab"}],"html":"<h1>CloudflarD to Nginx on Mac Mini Homelab</h1>\n<p>Backing up my previous home lab setup</p>\n<p>I had an public ip address from my ISP. On my router DHCP static ip address were configured for mac mini, as well as 443 port forwarding to it.</p>\n<p>So, any traffic from outside to my ip port 443 were forwarded to macmini</p>\n<p>On mac mini side, nginx were installed via brew (no docker stuff here)</p>\n<p>From a cloudflare, i had an wildcard subdomain pointing to my ip address, and ssl configured to strict mode (no http anywhere, only https)</p>\n<p>Here are config snippets from nginx</p>\n<p><strong>nginx.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">worker_processes 1;\n\nevents {\n  multi_accept on;\n  worker_connections 1024;\n}\n\nhttp {\n  charset utf-8;\n  client_max_body_size 10M;\n  default_type application/octet-stream;\n  gzip on;\n  gzip_vary on;\n  include mime.types;\n  keepalive_timeout 65;\n  sendfile on;\n  server_tokens off;\n  tcp_nodelay on;\n  tcp_nopush on;\n\n  # for ip in $(curl -s https://www.cloudflare.com/ips-v4/)\n  # do\n  #   echo &quot;set_real_ip_from $ip;&quot;\n  # done\n  set_real_ip_from 173.245.48.0/20;\n  set_real_ip_from 103.21.244.0/22;\n  set_real_ip_from 103.22.200.0/22;\n  set_real_ip_from 103.31.4.0/22;\n  set_real_ip_from 141.101.64.0/18;\n  set_real_ip_from 108.162.192.0/18;\n  set_real_ip_from 190.93.240.0/20;\n  set_real_ip_from 188.114.96.0/20;\n  set_real_ip_from 197.234.240.0/22;\n  set_real_ip_from 198.41.128.0/17;\n  set_real_ip_from 162.158.0.0/15;\n  set_real_ip_from 104.16.0.0/13;\n  set_real_ip_from 104.24.0.0/14;\n  set_real_ip_from 172.64.0.0/13;\n  set_real_ip_from 131.0.72.0/22;\n  real_ip_header X-Forwarded-For;\n  real_ip_recursive on;\n\n  include servers/*;\n}</code></pre></div>\n<p>technically nothing fancy here, usual config may be used, the only thing changed is this block with ip addresses, so nginx logs will contain real ip instead of cloudflare</p>\n<p>note: we will allow traffic only from cloudflare, the settings above is technically optional and needed only if you wish to see real ip addresses in logs</p>\n<p>also, you may notice this <code class=\"language-text\">include servers/*;</code> that's where all service definitions leave, here are few examples of how it looks like</p>\n<p><strong>3000.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n  server_name 3000.mac-blog.org.ua;\n\n  include cloudflare.conf;\n  include common.conf;\n\n  location / {\n    proxy_pass http://192.168.105.109:3000;\n    include proxy_headers.conf;\n  }\n}</code></pre></div>\n<p><strong>calendar.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n  server_name calendar.mac-blog.org.ua;\n\n  include cloudflare.conf;\n  include common.conf;\n\n  location / {\n    root html;\n    fastcgi_pass 127.0.0.1:9000;\n    fastcgi_index index.php;\n    fastcgi_param SCRIPT_FILENAME /Users/mini/Desktop/calendar/public$fastcgi_script_name;\n    include fastcgi_params;\n    fastcgi_read_timeout 5s;\n  }\n}</code></pre></div>\n<p>as, you may see, everywhere we are including two more files, here they are</p>\n<p><strong>cloudflare.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">listen 8080 ssl;\n# https\nssl_certificate /opt/homebrew/etc/nginx/cloudflare.pem;\nssl_certificate_key /opt/homebrew/etc/nginx/cloudflare.key;\n# mtls\nssl_verify_client on;\nssl_client_certificate /opt/homebrew/etc/nginx/authenticated_origin_pull_ca.pem;</code></pre></div>\n<p>here are are adding cloudflare trusted https certs for strict tls to work, as well as mtls so only traffic from cloudflare will pass thru.</p>\n<p><strong>common.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">location = /favicon.ico {\n  log_not_found off;\n}\n\nlocation = /robots.txt {\n  log_not_found off;\n}</code></pre></div>\n<p>nothing interesting here, just few tuning options, may be good to add some cache control directives for static content, etc.</p>\n<p>thanks to brew, nginx is installed as launchd service out of the box so will be running after system restart.</p>\n<p>This approach allows to expose not only local services but also service on local network. Also we may play with nginx configuration options to have some basic auth. And the beauty of setup there is no http, as result no need to have redirect to https rules, and the best one only traffic from cloudflare is allowed.</p>\n<p>But at moment i have loose my public ip address and because of that need to find alternative approach, very first attempt was around cloudflared which may completely replace nginx on its own, but because i have few small php services and php-fpm which can not be handled by cloudfalred seems like i still need nginx</p>\n<p>The key difference: with cloudflared i do not need port forwarding on my router anymore, as well as ssl stuff in nginx - from tunnel everything will be in plain http which is fine for internal net.</p>\n<p>so after following up cloudflare wizzard from here <a href=\"https://one.dash.cloudflare.com/a46509e2e3b4f05df1e7bbb3d89af270/networks/connectors\">https://one.dash.cloudflare.com/a46509e2e3b4f05df1e7bbb3d89af270/networks/connectors</a></p>\n<p>i was able to install cloudflared as easy as</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">brew <span class=\"token function\">install</span> cloudflared\n<span class=\"token function\">sudo</span> cloudflared <span class=\"token function\">service</span> <span class=\"token function\">install</span> eyJhIj<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>bSJ9</code></pre></div>\n<p><a href=\"https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/macos/\">https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/do-more-with-tunnels/local-management/as-a-service/macos/</a></p>\n<p>and after starting it, cleanup nginx from all previous cloudflare additions, aka, now configs are as simple as:</p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n  listen 80;\n  server_name prometheus.mac-blog.org.ua;\n\n  # include cloudflare.conf;\n  # include common.conf;\n\n  location / {\n    proxy_pass http://localhost:9090;\n    include proxy_headers.conf;\n    auth_basic &quot;auth&quot;;\n    auth_basic_user_file /opt/homebrew/etc/nginx/prometheus.htpasswd;\n  }\n}</code></pre></div>\n<p>the only thing did not like - brew services list shows one service, but cloudflared installs system daemon at /Library/LaunchDaemons/com.cloudflare.cloudflared.plist</p>\n<p>so instead, i have uninstalled everything and following docs from here <a href=\"https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/downloads/\">https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/downloads/</a> downloaded binary and used it instead</p>\n<p>at cloudflare portal i have added so called application</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/11e0ed5b1716eb728e391b6580ffa09a/d3deb/screen1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVR42n2S63KCMBCFM0MSQoAKchEUlJYWqoy2Hd//2U6zAdFW2x/fZLPZnN3MCRuGAefzGXmew/M8+L5/B+UXiwWiKILW+mENQWeMhLIsg1IKUso7hBAIggBlWaIoilmU8r9rqTEjIerOOX9YdBGkmjiOkCSJneZRrZ2QumZZjuUyQRg+GWFhiuUPKOc4fMKxeym4wTFMwnZ1wdpK4bPzcGw9HJ5d7BuJ953Ewa4CexNTjqDzYapp6gh1nWK31mgKjqbk2JUSrKs4vt4cfLQCp4njC8fp9bq/PRvzHH2/Rt+V4wDUrBE2Zn3fYbvdwg/82cEwDP91UmsTa/MjtDLQHX11uapqRHFs36+Uh3y1Qppm9hLlbnFd1zip4ZmL83qJJ1hsxOgrkOVpmmKz2cxfYzSAz5Cz44R/8w2zadIOTnMc2AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screen1\"\n        title=\"\"\n        src=\"/static/11e0ed5b1716eb728e391b6580ffa09a/2bef9/screen1.png\"\n        srcset=\"/static/11e0ed5b1716eb728e391b6580ffa09a/6f3f2/screen1.png 256w,\n/static/11e0ed5b1716eb728e391b6580ffa09a/01e7c/screen1.png 512w,\n/static/11e0ed5b1716eb728e391b6580ffa09a/2bef9/screen1.png 1024w,\n/static/11e0ed5b1716eb728e391b6580ffa09a/71c1d/screen1.png 1536w,\n/static/11e0ed5b1716eb728e391b6580ffa09a/d3deb/screen1.png 1758w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>not how cloudflare warns us that it wont create any dns record because of wildcard, so we need to create one manually like so</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/391ab63145b2f31ef58af7aa73ea3061/09ede/screen2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.09375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAu0lEQVR42j1QORKDMBCj4fIdH2BiTIZJqjwg//+Z4jVHsYUlraR1I4SA1hrrukIpBXozxjAMA6y1SClhWWLhND6LxDPOcM5jHEd47yGlrHouJLhZ0NASmXDO6xDpnEOMESGEG6flLR/ml94W4zDNGM8CjIvDkMRd16Ft20oaYyDPpoT3fY+cM/Z9r0HTNNVmv7fFd3N4pdLah6pvKI1OvZrU5BJC7egr6jkFo9aE0RBP2ENxGMmglbxP/wOoHF7LtWeodQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screen2\"\n        title=\"\"\n        src=\"/static/391ab63145b2f31ef58af7aa73ea3061/2bef9/screen2.png\"\n        srcset=\"/static/391ab63145b2f31ef58af7aa73ea3061/6f3f2/screen2.png 256w,\n/static/391ab63145b2f31ef58af7aa73ea3061/01e7c/screen2.png 512w,\n/static/391ab63145b2f31ef58af7aa73ea3061/2bef9/screen2.png 1024w,\n/static/391ab63145b2f31ef58af7aa73ea3061/71c1d/screen2.png 1536w,\n/static/391ab63145b2f31ef58af7aa73ea3061/09ede/screen2.png 1710w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>for a target use: <code class=\"language-text\">[tunnel_id].cfargotunnel.com</code></p>\n<p>you can retrieve your tunnel id from here <a href=\"https://one.dash.cloudflare.com/a46509e2e3b4f05df1e7bbb3d89af270/networks/connectors\">https://one.dash.cloudflare.com/a46509e2e3b4f05df1e7bbb3d89af270/networks/connectors</a></p>"}},"pageContext":{"id":"187b039e-eca3-5d03-b89c-2467c40b5121"}},"staticQueryHashes":[],"slicesMap":{}}