{"componentChunkName":"component---src-templates-note-js","path":"/bash-backup-restore-script","result":{"data":{"remark":{"fields":{"path":"bash-backup-restore-script"},"meta":{"title":""},"headings":[{"value":"Bash backup-restore script"}],"html":"<h1>Bash backup-restore script</h1>\n<h2>Backup\\Restore Commands</h2>\n<p><strong>Backup files</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/bin/tar <span class=\"token parameter variable\">-cpzf</span> /path-to-backups/www-<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +%Y-%m-%d<span class=\"token variable\">`</span></span>.tar.gz /home/example/www/</code></pre></div>\n<p><strong>Restore files</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/bin/tar <span class=\"token parameter variable\">-xpzf</span> /path-to-backups/www-2012-04-25.tar.gz <span class=\"token parameter variable\">-C</span> /</code></pre></div>\n<p><strong>Backup mysql</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/usr/bin/mysqldump <span class=\"token parameter variable\">--databases</span> <span class=\"token parameter variable\">-u</span> MYSQL_LOGIN <span class=\"token parameter variable\">--password</span><span class=\"token operator\">=</span>MYSQL_PASSWORD MYSQL_DATABASE <span class=\"token operator\">></span> /path-to-backups/db-<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +%Y-%m-%d<span class=\"token variable\">`</span></span>.sql</code></pre></div>\n<p><strong>Restore mysql</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/usr/bin/mysql <span class=\"token parameter variable\">-u</span> MYSQL_LOGIN <span class=\"token parameter variable\">--password</span><span class=\"token operator\">=</span>MYSQL_PASSWORD MYSQL_DATABASE <span class=\"token operator\">&lt;</span> /path-to-backups/db-2012-04-25.sql</code></pre></div>\n<p><a href=\"http://help.ubuntu.com/community/BackupYourSystem/TAR\">http://help.ubuntu.com/community/BackupYourSystem/TAR</a></p>\n<h2>Backup Script</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">touch</span> ~/make-backup.sh\n<span class=\"token function\">chmod</span> a+x ~/make-backup.sh\n<span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /home/example/make-backup.sh /etc/cron.daily/make-backup.sh\n<span class=\"token function\">cat</span> ~/make-backup.sh\n<span class=\"token comment\">#!/bin/sh</span>\n\n<span class=\"token comment\"># Backup www directory</span>\n/bin/tar <span class=\"token parameter variable\">-cpzf</span> /home/example/backups/www-<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +%Y-%m-%d<span class=\"token variable\">`</span></span>.tar.gz /home/example/www/\n\n<span class=\"token comment\"># Backup database</span>\n/usr/bin/mysqldump <span class=\"token parameter variable\">--databases</span> <span class=\"token parameter variable\">-u</span> example <span class=\"token parameter variable\">--password</span><span class=\"token operator\">=</span>example example <span class=\"token operator\">></span> /home/example/backups/db-<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +%Y-%m-%d<span class=\"token variable\">`</span></span>.sql\n\n<span class=\"token comment\"># Delete old backups</span>\n/usr/bin/find /home/example/backups/ <span class=\"token parameter variable\">-mtime</span> +30 <span class=\"token parameter variable\">-delete</span></code></pre></div>\n<h2>Restore Script</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">touch</span> ~/restore-backup.sh\n<span class=\"token function\">chmod</span> a+x ~/restore-backup.sh\n<span class=\"token function\">cat</span> ~/restore-backup.sh\n<span class=\"token comment\">#!/bin/sh</span>\n\n<span class=\"token comment\"># Get last backup file names into variables</span>\n<span class=\"token assign-left variable\">LAST_WWW_BACKUP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> /home/example/backups/www-*.tar.gz <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> <span class=\"token parameter variable\">-n</span> <span class=\"token number\">1</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">LAST_SQL_BACKUP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> /home/example/backups/db-*.sql <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> <span class=\"token parameter variable\">-n</span> <span class=\"token number\">1</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># Restore files</span>\n/bin/tar <span class=\"token parameter variable\">-xpzf</span> <span class=\"token variable\">$LAST_WWW_BACKUP</span> <span class=\"token parameter variable\">-C</span> /\n\n<span class=\"token comment\"># Restore database</span>\n/usr/bin/mysql <span class=\"token parameter variable\">-u</span> example <span class=\"token parameter variable\">--password</span><span class=\"token operator\">=</span>example example <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$LAST_SQL_BACKUP</span>\n\n<span class=\"token comment\"># Clear drupal caches</span>\ndrush <span class=\"token parameter variable\">-r</span> /home/example/www/ cc all</code></pre></div>\n<h2>Interactive Restore Script</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 670px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9341b46294c1e6d4c5cc31e94dc2d7dc/d67fd/132.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACFklEQVQ4y5WRTU8TURSGZ+VGMHHLh8RfOMUEw8q1UEgqJrpxGkmotAhiWmd655xpO0MbvpqISLQrCQQJlCr8hMfMlKatYaGLJ/e87zn3zbm51r75xr60ODloc9W65utuh9Zeh9bn3/w8vKZ9cMXp9hnfd8+5OPrF5ZcLzppndI463LRuuDxsc7xzwmnzlMvzNlZlIqDyOCCYUuSRUJ4U3HEfM+Gj42VkzEPHPXTMxZ8w+JNxzyTEdYxMCjIlHAc/sNZWCrx31ik4BdbfrlPMFSkXPNyCR3m1hL4rIqslJFfEXfNw8y5uYYC8i9kw5DI5mtrE8iIXI4aylDFqkIqgNUXDAE0/R2em0dkZ9OkTdNlBGxFavZ2JqSpRI8JZfoOvPpZfMwR+gKqi0kVEkPjc+IDm82i+gMSUSogGiC+3M5LUYS0k62RRCbBMzaC+9gdEkvDkrFbRWq1PEKC3/R7xXBiGZLNOssRQYHdL6V/q1YP0/DsCgyC4I/A/uSOwPBT497P/RXcDs/i+j+VVPMRIInrEQ4N6kN6n9bQxhmq1iuM43cBoJ6QRNahv1WnUG0S1MLnU2Op6Pbq9COMZKlrp96M6e7t75FZyydZW+tU8i0uLLLxc6LKUZv7FfF8PsrTAXGaO9Iv0kJd5nWH22SybHzex7Hs29oMUqZEU9oiNPZIiNRprO/GGGB1gwLPv20w/nGb70zZ/ADswDzKQ7WP0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"screenshot\"\n        src=\"/static/9341b46294c1e6d4c5cc31e94dc2d7dc/d67fd/132.png\"\n        srcset=\"/static/9341b46294c1e6d4c5cc31e94dc2d7dc/6f3f2/132.png 256w,\n/static/9341b46294c1e6d4c5cc31e94dc2d7dc/01e7c/132.png 512w,\n/static/9341b46294c1e6d4c5cc31e94dc2d7dc/d67fd/132.png 670w\"\n        sizes=\"(max-width: 670px) 100vw, 670px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">touch</span> ~/date-backup-restore.sh\n<span class=\"token function\">chmod</span> a+x ~/date-backup-restore.sh\n<span class=\"token function\">cat</span> ~/date-backup-restore.sh\n\n<span class=\"token comment\">#!/bin/sh</span>\n\n<span class=\"token comment\"># Disaplay choose dialog with available backups</span>\n<span class=\"token assign-left variable\">CHOSEN_DATE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>whiptail <span class=\"token parameter variable\">--title</span> <span class=\"token string\">\"RESTORE BACKUP\"</span> <span class=\"token parameter variable\">--menu</span> <span class=\"token string\">\"Chose Backup Date\"</span> <span class=\"token number\">20</span> <span class=\"token number\">78</span> <span class=\"token number\">10</span> `for <span class=\"token for-or-select variable\">x</span> <span class=\"token keyword\">in</span> /home/example/backups/*.tar.gz<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$x</span> backup\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/.*www-\\(.*\\).tar.gz/\\1/'</span><span class=\"token punctuation\">;</span> done` <span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span><span class=\"token file-descriptor important\">&amp;2</span> <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;3</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token assign-left variable\">exitstatus</span><span class=\"token operator\">=</span><span class=\"token variable\">$?</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$exitstatus</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n        <span class=\"token comment\"># Get files and database backup file names</span>\n        <span class=\"token assign-left variable\">WWW_BACKUP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> /home/example/backups/www-<span class=\"token string\">\"<span class=\"token variable\">$CHOSEN_DATE</span>\"</span>.tar.gz <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> <span class=\"token parameter variable\">-n</span> <span class=\"token number\">1</span><span class=\"token variable\">)</span></span>\n        <span class=\"token assign-left variable\">SQL_BACKUP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> /home/example/backups/unon-$CHOSEN_DATE.sql <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> <span class=\"token parameter variable\">-n</span> <span class=\"token number\">1</span><span class=\"token variable\">)</span></span>\n\n        <span class=\"token comment\"># Restore files</span>\n        /bin/tar <span class=\"token parameter variable\">-xpzf</span> <span class=\"token variable\">$WWW_BACKUP</span> <span class=\"token parameter variable\">-C</span> /\n\n        <span class=\"token comment\"># Restore database</span>\n        /usr/bin/mysql <span class=\"token parameter variable\">-u</span> example <span class=\"token parameter variable\">--password</span><span class=\"token operator\">=</span>example example <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$SQL_BACKUP</span>\n\n        <span class=\"token comment\"># Clear drupal caches</span>\n        drush <span class=\"token parameter variable\">-r</span> /home/example/www/ cc all\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p>TODO: refactor scripts to use path variables</p>\n<p>TODO: move to github</p>"}},"pageContext":{"id":"2e41d151-8486-5bed-ac22-891aa16b11a3"}},"staticQueryHashes":[]}