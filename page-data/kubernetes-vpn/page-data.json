{"componentChunkName":"component---src-templates-note-js","path":"/kubernetes-vpn","result":{"data":{"remark":{"fields":{"path":"kubernetes-vpn"},"meta":{"title":""},"headings":[{"value":"Run VPN inside Kubernetes"}],"html":"<h1>Run VPN inside Kubernetes</h1>\n<p>Imagine if VPN is ran right inside Kubernetes, with right configurations, theoretically you should be able to pretend like you are living inside it, which means all internal services will be resolvable and accessible</p>\n<p>Here is an sample manifest of how we may self host VPN righ inside kubernetes:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> vpn\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> vpn\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> vpn\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> vpn\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">kubernetes.io/os</span><span class=\"token punctuation\">:</span> linux\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> lib<span class=\"token punctuation\">-</span>modules\n        <span class=\"token key atrule\">hostPath</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /lib/modules\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Directory\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> vpn\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> hwdsl2/ipsec<span class=\"token punctuation\">-</span>vpn<span class=\"token punctuation\">-</span>server\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_IPSEC_PSK\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> xxxxxxxxxxxxx\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_ADDL_USERS\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> user1 user2\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_ADDL_PASSWORDS\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> pass1 pass2\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_USER\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> user0\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_PASSWORD\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> pass0\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_DNS_SRV1\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> 10.0.0.10\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_L2TP_NET\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> 10.1.0.0/8\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_L2TP_LOCAL\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> 10.1.0.1\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> VPN_L2TP_POOL\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> 10.1.1.1<span class=\"token punctuation\">-</span>10.1.1.254\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">500</span>\n          <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> UDP\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4500</span>\n          <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> UDP\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 500m\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 500Mi\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 100m\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 64Mi\n        <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">privileged</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> lib<span class=\"token punctuation\">-</span>modules\n          <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /lib/modules\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> vpn\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> LoadBalancer\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> vpn\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> port\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">500</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> UDP\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nat\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4500</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> UDP</code></pre></div></p>\n<p>Key things here are:</p>\n<ul>\n<li>make sure to tune <code class=\"language-text\">VPN_L2TP_NET</code> so it will cover Kubernetes Pod CIDR</li>\n<li>make sure to set correct <code class=\"language-text\">VPN_DNS_SRV1</code> pointing to a CoreDNS</li>\n<li>optionally tune CoreDNS to resolve ingress to internal address</li>\n</ul>\n<p>And here you go, from my experiments after connecting to such VPN I was able to:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># resolve service, as myapp.mynamespace.svc.cluster.local pointing to private 10.0.0.0 addres</span>\n<span class=\"token function\">nslookup</span> myapp\n\n<span class=\"token comment\"># talk to this service</span>\n<span class=\"token function\">curl</span> http://myapp/\n\n<span class=\"token comment\"># resolve ingress (after optional changes to CoreDNS) pointing to ingress private IP address</span>\n<span class=\"token function\">host</span> myapp.mac-blog.org.ua\n\n<span class=\"token comment\"># talk to this service via private network</span>\n<span class=\"token function\">curl</span> http://myapp.mac-blog.org.ua/\n\n<span class=\"token comment\"># talk to any other service in kubernetes</span>\n<span class=\"token function\">nc</span> <span class=\"token parameter variable\">-vz</span> myapp-redis <span class=\"token number\">6379</span></code></pre></div>\n<p>Note: macOS has a tricky DNS, I'm still not sure if I understand it to be fair, but the last commands that did helped out to resolve services were:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># networksetup -listnetworkserviceorder</span>\n<span class=\"token comment\"># networksetup -listallnetworkservices</span>\n\n<span class=\"token comment\"># # did not work</span>\n<span class=\"token comment\"># networksetup -getsearchdomains vpn</span>\n<span class=\"token comment\"># networksetup -setsearchdomains vpn mynamespace.svc.cluster.local</span>\n\n<span class=\"token comment\"># # worked out</span>\nnetworksetup <span class=\"token parameter variable\">-getsearchdomains</span> Wi-Fi\nnetworksetup <span class=\"token parameter variable\">-setsearchdomains</span> Wi-Fi mynamespace.svc.cluster.local\n\n<span class=\"token comment\"># check</span>\ndns-sd <span class=\"token parameter variable\">-q</span> myapp</code></pre></div>\n<p>So suddenly it is like living inside Kubernetes, there is no need for endless <code class=\"language-text\">kubectl port-forward</code> everything just works out of the box</p>\n<p>Alternative and popular Wireguard somehow did not work inside Azure, and there is OpenVPN alternative but both require additional clients to be installed, and this approach works out of the box with native software</p>"}},"pageContext":{"id":"87305dde-2a8a-53ad-af61-4deba5f76112"}},"staticQueryHashes":[]}