{"componentChunkName":"component---src-templates-note-js","path":"/drupal-programmaticaly-sync-cck-fileds-between-nodes/","result":{"data":{"remark":{"fields":{"path":"drupal-programmaticaly-sync-cck-fileds-between-nodes"},"meta":{"title":""},"headings":[{"value":"Drupal programmaticaly sync CCK fileds between nodes"}],"html":"<h1>Drupal programmaticaly sync CCK fileds between nodes</h1>\n<p>My case.</p>\n<p>When user registers via specific path - he gets seller role (auto assign role module), <code class=\"language-text\">about_company</code> node creates (rules module).</p>\n<p>Seller can edit own <code class=\"language-text\">about_company</code> node, but not create or delete.</p>\n<p>It works like content profile module, but i do not use him - because i have many other roles, that have other profiles.</p>\n<p>About company node has price min, avg, max fields that must be updated when user create, update or delete product nodes that have price field.</p>\n<p><strong>sync_company_prices.info</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token key attr-name\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">Sync company prices</span>\n<span class=\"token key attr-name\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">Sync company prices, when author make something with products</span>\n<span class=\"token key attr-name\">package</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">Custom</span>\n<span class=\"token key attr-name\">core</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">6.x</span></code></pre></div>\n<p><strong>sync_company_prices.module</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// registering our custom action (will be shown when configuring rules)</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">sync_company_prices_rules_action_info</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string single-quoted-string\">'sync_company_prices_action'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string single-quoted-string\">'label'</span> <span class=\"token operator\">=></span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Sync company prices'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'arguments'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// action will recieve product node and its author</span>\n        <span class=\"token string single-quoted-string\">'node'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'type'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'node'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'label'</span> <span class=\"token operator\">=></span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Content'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'author'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'type'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'label'</span> <span class=\"token operator\">=></span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'User, which is set as author'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'module'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'Node'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// custom action</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">sync_company_prices_action</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$node</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$author</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// step 1. retrieve node id of company node</span>\n    <span class=\"token variable\">$nid</span> <span class=\"token operator\">=</span> <span class=\"token function\">db_result</span><span class=\"token punctuation\">(</span><span class=\"token function\">db_query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"SELECT nid FROM {node} WHERE type = 'company' AND uid = %d LIMIT 1\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$author</span><span class=\"token operator\">-></span><span class=\"token property\">uid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// if there is such node - we will update its prices</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$nid</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// fetch price min, avg, max from company products</span>\n        <span class=\"token comment\">// selecting prices from published products by user id</span>\n        <span class=\"token variable\">$prices</span> <span class=\"token operator\">=</span> <span class=\"token function\">db_fetch_object</span><span class=\"token punctuation\">(</span><span class=\"token function\">db_query</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"\n        SELECT\n            MAX({content_type_product}.field_price_value) AS price_max,\n            AVG({content_type_product}.field_price_value) AS price_avg,\n            MIN({content_type_product}.field_price_value) AS price_min\n        FROM {node}\n        LEFT JOIN {content_type_product} ON\n            {node}.nid = {content_type_product}.nid AND\n            {node}.vid = {content_type_product}.vid\n        WHERE\n            {node}.type = 'product' AND\n            {node}.status = 1 AND\n            {node}.uid = %d\n        \"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$author</span><span class=\"token operator\">-></span><span class=\"token property\">uid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// load node, change its prices and save it</span>\n        <span class=\"token variable\">$company_node</span> <span class=\"token operator\">=</span> <span class=\"token function\">node_load</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$nid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$company_node</span><span class=\"token operator\">-></span><span class=\"token property\">field_price_min</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'value'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$prices</span><span class=\"token operator\">-></span><span class=\"token property\">price_min</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$company_node</span><span class=\"token operator\">-></span><span class=\"token property\">field_price_avg</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'value'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$prices</span><span class=\"token operator\">-></span><span class=\"token property\">price_avg</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$company_node</span><span class=\"token operator\">-></span><span class=\"token property\">field_price_max</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'value'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$prices</span><span class=\"token operator\">-></span><span class=\"token property\">price_max</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">node_save</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$company_node</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'node'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$node</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// altering company node form - hiding prices fields</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">sync_company_prices_form_alter</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token variable\">$form</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$form_state</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$form_id</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$form_id</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'company_node_form'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// hide price fields, they will be calculated by rules</span>\n        <span class=\"token variable\">$form</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'field_price_min'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'#type'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'value'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$form</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'field_price_avg'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'#type'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'value'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$form</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'field_price_max'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'#type'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'value'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>Now u can create rules, like: When user creates new published product call our custom action.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 769px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/53e125b3e980e7286690a168ee548c6e/227ba/112.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.703125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA0ElEQVR42p2P0WqDMAAA/f9/Gm1BnVroqKyTtjHEVA04axOpOrB4Y37CDu714Dxjaipj0FrT9z1/LMvCf/FMXdO1d17zzM84Mg4D03NgGkZ61yOlxDnHNE2M08g8v3h0HSIX1MYgxBWlKk6fF+rK4KWHGn+j8Lcl4a4kDkp2bzcivyIOJEEYEIYhSRITJQmF1jRNg1mvbuz3Ee9RwXZTcko1XpY9OXw8uFztai4tX5nlVjnatuWYHhFCUBQFSqk1Zq1dbe8tSkny/Jvz2VFoyy/xbihjxqH9gwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/53e125b3e980e7286690a168ee548c6e/227ba/112.png\"\n        srcset=\"/static/53e125b3e980e7286690a168ee548c6e/6f3f2/112.png 256w,\n/static/53e125b3e980e7286690a168ee548c6e/01e7c/112.png 512w,\n/static/53e125b3e980e7286690a168ee548c6e/227ba/112.png 769w\"\n        sizes=\"(max-width: 769px) 100vw, 769px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 335px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/04cf0e178591a621556d35d48e3e78ae/c0051/24.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 96.484375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACeElEQVR42q2U607bQBCF/f4vQUV/tLSiAbW0FVJVUak0BVqam0OuJE7iJE7w3bG9a/urcLgkIFQQHeloZ2fts2d3ZlYp//nFxsYLDn8U+bS3x96H9+x/+Urx509ebm6yUyhQram8ef2KQqHA7s4O7wq7fDs4oHh4yMfP++wWttneLlAqlVGklIRRRBD42LaNbVm4rkewWOC5LqZp5usX5gWWbeE4DrPZjMlkguu42I6DZZmYpkUYhij9Xo92p8OlZVnGc01R1RqtViufpGm2JL3ivfSvN1nGr3DHVoUoS6J05efsxr/BSuz6+yRJ8vGeQikkrb5JT51S+d6nearTqxucV8c0TnU65TFaY8a5Os39s5MBpuHTbDfQtP59ha7j0O9r2JaPZ4c5Ai8icCM8J8zHHH6M74a4dkgcJ5iWie979xVOxjpVVWURRqu3cveW7sQeTp4iZcLA8Gm3BcViTLUqaLUljbqgVImpnwnOzyXtlsjXjo4ElYrEmEVUqqd5Ga0eW8nSFMeVGPOU0ShhOEqYGmmO8TRF1yXjsWQ4lAwGt/A8yWQyIorjdYUzJ8RxQ3wrIA4FIhJEQYRrBoReSJY+rTYVKxDMpj7d0phhx2TQvKCnGrRLEzrlKXEor460jocaQYnDBa7r3NbUM5tF+X1yzNbWW+amu+S77JZ02TVpmq2pexTh5eMgk4T/ZYoQksFwgK7HefbmF5LRSNLvSzRNYBjLrGqaZLGQj1GYoOsmzaZAVSXdrsxrr1QW1GqCZkui1gS1qshL5Z+EQSSJRUKWJGRZeoNlkrI1POZ5U3QzYKhZNI5HdGsGWn1Gtzzh7ETHni+enJS/hLi0xZNO+/wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/04cf0e178591a621556d35d48e3e78ae/c0051/24.png\"\n        srcset=\"/static/04cf0e178591a621556d35d48e3e78ae/6f3f2/24.png 256w,\n/static/04cf0e178591a621556d35d48e3e78ae/c0051/24.png 335w\"\n        sizes=\"(max-width: 335px) 100vw, 335px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>"}},"pageContext":{"id":"2910c8e8-5990-5148-8bae-184105316760"}},"staticQueryHashes":[],"slicesMap":{}}