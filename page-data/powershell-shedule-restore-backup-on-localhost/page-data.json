{"componentChunkName":"component---src-templates-note-js","path":"/powershell-shedule-restore-backup-on-localhost/","result":{"data":{"remark":{"fields":{"path":"powershell-shedule-restore-backup-on-localhost"},"meta":{"title":""},"headings":[{"value":"PowerShell shedule restore backup on localhost"}],"html":"<h1>PowerShell shedule restore backup on localhost</h1>\n<p>So I want get fresh images etc from server:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Set-Variable</span> <span class=\"token operator\">-</span>name SBS_ARCH_PATH <span class=\"token operator\">-</span>value <span class=\"token string\">\"\\\\ProductServer\\wwwroot\"</span> <span class=\"token operator\">-</span>option constant\n<span class=\"token function\">Set-Variable</span> <span class=\"token operator\">-</span>name SMTP_SERVER <span class=\"token operator\">-</span>value <span class=\"token string\">\"192.168.0.1\"</span> <span class=\"token operator\">-</span>option constant\n<span class=\"token function\">Set-Variable</span> <span class=\"token operator\">-</span>name EMAIL_FROM <span class=\"token operator\">-</span>value <span class=\"token string\">\"alexandrm@rabota.ua\"</span> <span class=\"token operator\">-</span>option constant\n<span class=\"token function\">Set-Variable</span> <span class=\"token operator\">-</span>name EMAIL_TO <span class=\"token operator\">-</span>value <span class=\"token string\">\"alexandrm@rabota.ua\"</span> <span class=\"token operator\">-</span>option constant\n<span class=\"token function\">Set-Variable</span> <span class=\"token operator\">-</span>name SEVEN_ZIP_EXE_PATH <span class=\"token operator\">-</span>value <span class=\"token string\">\"C:\\Program Files\\7-Zip\\7z.exe\"</span> <span class=\"token operator\">-</span>option constant\n\n<span class=\"token comment\"># check is SBS server is accessible</span>\n<span class=\"token keyword\">function</span> isSbsAccessible<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Test-Path</span> <span class=\"token variable\">$SBS_ARCH_PATH</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># retrive last archive file name from SBS</span>\n<span class=\"token keyword\">function</span> getLastArchiveName<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$path</span> = <span class=\"token variable\">$SBS_ARCH_PATH</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"\\*.rar\"</span>\n    <span class=\"token variable\">$path</span> = <span class=\"token function\">ls</span> <span class=\"token variable\">$path</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">sort-object</span> Name <span class=\"token punctuation\">|</span> <span class=\"token function\">select-object</span> <span class=\"token operator\">-</span>last 1 <span class=\"token punctuation\">|</span> <span class=\"token function\">foreach-object</span> <span class=\"token punctuation\">{</span><span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$path</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># get last archive path on SBS</span>\n<span class=\"token keyword\">function</span> getLastArchivePath<span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$SBS_ARCH_PATH</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"\\\"</span> <span class=\"token operator\">+</span> <span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># get target archive path</span>\n<span class=\"token keyword\">function</span> getTargetArchPath<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$path</span> = <span class=\"token variable\">$env</span>:Temp\n    <span class=\"token variable\">$path</span> = <span class=\"token variable\">$path</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"\\rabotauabackup.rar\"</span>\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$path</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># send email</span>\n<span class=\"token keyword\">function</span> sendEmail<span class=\"token punctuation\">(</span><span class=\"token variable\">$body</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$subject</span> = <span class=\"token punctuation\">(</span><span class=\"token string\">\"[\"</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span><span class=\"token function\">Get-Date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ToString<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\"] files update job report\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">$smtp</span> = <span class=\"token function\">new-object</span> Net<span class=\"token punctuation\">.</span>Mail<span class=\"token punctuation\">.</span>SmtpClient<span class=\"token punctuation\">(</span><span class=\"token variable\">$SMTP_SERVER</span><span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">$mail</span> = <span class=\"token function\">new-object</span> Net<span class=\"token punctuation\">.</span>Mail<span class=\"token punctuation\">.</span>MailMessage<span class=\"token punctuation\">(</span><span class=\"token variable\">$EMAIL_FROM</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$EMAIL_TO</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$subject</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$body</span><span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">$mail</span><span class=\"token punctuation\">.</span>IsBodyHtml = <span class=\"token boolean\">$True</span>\n    <span class=\"token variable\">$smtp</span><span class=\"token punctuation\">.</span>Send<span class=\"token punctuation\">(</span><span class=\"token variable\">$mail</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>isSbsAccessible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># if SBS is accessible</span>\n    <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"All ok, SBS is accessebile\"</span> <span class=\"token operator\">-</span>foregroundcolor green\n\n    <span class=\"token comment\"># generate pathes</span>\n    <span class=\"token variable\">$lastArchName</span> = getLastArchiveName\n    <span class=\"token variable\">$lastArchPath</span> = getLastArchivePath <span class=\"token variable\">$lastArchName</span>\n    <span class=\"token variable\">$targetPath</span> = getTargetArchPath\n\n    <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"Copying backup\"</span> <span class=\"token operator\">-</span>foregroundcolor yellow\n    <span class=\"token function\">copy</span> <span class=\"token variable\">$lastArchPath</span> <span class=\"token variable\">$targetPath</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">Test-Path</span> <span class=\"token variable\">$targetPath</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># check is file was copied</span>\n\n        <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"Extracting files\"</span> <span class=\"token operator\">-</span>foregroundcolor yellow\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">Test-Path</span> <span class=\"token string\">\"C:\\Program Files\\7-Zip\\\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># is there 7z?</span>\n            <span class=\"token function\">set-alias</span> sz <span class=\"token string\">\"C:\\Program Files\\7-Zip\\7z.exe\"</span>\n            <span class=\"token comment\">#$extractPath = $env:Temp</span>\n            <span class=\"token comment\">#$extractPath = $extractPath + \"\\rabotauabackup\"</span>\n            <span class=\"token comment\">#sz x -pPASSWORD $targetPath -o$extractPath -r -aou</span>\n            sz x <span class=\"token operator\">-</span>pPASSWORD <span class=\"token variable\">$targetPath</span> <span class=\"token operator\">-</span>oC:\\inetpub\\wwwroot\\rabotauabackup <span class=\"token operator\">-</span>r <span class=\"token operator\">-</span>aou\n\n            robocopy C:\\inetpub\\wwwroot\\rabotauabackup\\Inetpub\\wwwroot\\BlogEngine\\App_Data\\files C:\\Users\\mac\\Rabota<span class=\"token punctuation\">.</span>UA\\trunk\\Version\\Rabota2<span class=\"token punctuation\">.</span>CMS\\BlogEngine<span class=\"token punctuation\">.</span>Web\\App_Data\\files <span class=\"token operator\">/</span>MIR\n\n            <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"SUCCESS\"</span> <span class=\"token operator\">-</span>foregroundcolor green\n\n            <span class=\"token variable\">$body</span> = <span class=\"token string\">\"&lt;h3 style='color:green'>SUCCESS&lt;/h3>\"</span>\n            <span class=\"token variable\">$body</span> <span class=\"token operator\">+=</span> <span class=\"token string\">\"&lt;p>Files updated from &lt;a href='\"</span> <span class=\"token operator\">+</span> <span class=\"token variable\">$lastArchPath</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"'>\"</span> <span class=\"token operator\">+</span> <span class=\"token variable\">$lastArchName</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&lt;/a>&lt;/p>\"</span>\n            sendEmail <span class=\"token variable\">$body</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># if therre is no 7z</span>\n            <span class=\"token variable\">$body</span> = <span class=\"token string\">\"&lt;h3 style='color:red'>FAILURE&lt;/h3>\"</span>\n            <span class=\"token variable\">$body</span> <span class=\"token operator\">+=</span> <span class=\"token string\">\"&lt;p>7Zip was not found&lt;/p>\"</span>\n            sendEmail <span class=\"token variable\">$body</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># file was not copied</span>\n        <span class=\"token variable\">$body</span> = <span class=\"token string\">\"&lt;h3 style='color:red'>FAILURE&lt;/h3>\"</span>\n        <span class=\"token variable\">$body</span> <span class=\"token operator\">+=</span> <span class=\"token string\">\"&lt;p>Backup file was not copied from&lt;a href='\"</span> <span class=\"token operator\">+</span> <span class=\"token variable\">$lastArchPath</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"'>\"</span> <span class=\"token operator\">+</span> <span class=\"token variable\">$lastArchName</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&lt;/a>&lt;/p>\"</span>\n        sendEmail <span class=\"token variable\">$body</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># if SBS is NOT accessible</span>\n    <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"SBS is not accessibile\"</span> <span class=\"token operator\">-</span>foregroundcolor red\n    <span class=\"token variable\">$body</span> = <span class=\"token string\">\"&lt;h3 style='color:red'>FAILURE&lt;/h3>\"</span>\n    <span class=\"token variable\">$body</span> <span class=\"token operator\">+=</span> <span class=\"token string\">\"&lt;p>SBS was not accessible&lt;/p>\"</span>\n    sendEmail <span class=\"token variable\">$body</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then all u need to do is register this script in sheduler</p>"}},"pageContext":{"id":"73459c5e-cdcb-5bdf-95fc-1ca8954c3e23"}},"staticQueryHashes":[],"slicesMap":{}}