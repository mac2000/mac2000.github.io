{"componentChunkName":"component---src-templates-note-js","path":"/http2/","result":{"data":{"remark":{"fields":{"path":"http2"},"meta":{"title":""},"headings":[{"value":"HTTP2"}],"html":"<h1>HTTP2</h1>\n<p>Серия заметок наглядно показывающих в чем весь сыр бор вокруг HTTP2</p>\n<h2>HTTPS</h2>\n<p>Для работы HTTP2 нам нужен будет HTTPS, а как следствие сертификаты</p>\n<p>Благо наткнулся на крайне полезную полезняху - <a href=\"https://get.localhost.direct/\">https://get.localhost.direct/</a> - домен резолвит себя и все поддомены на локалхост и при этом есть валидные сертификаты, что невероятно упростит эксперименты</p>\n<hr>\n<p>Хоть эксперименты мы и будем в основном делать с nginx и go, нужно подчеркнуть что для современного dotnet прикручивание сервитификатов as easy as добавление в appsettings.json вот такого:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Kestrel\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Endpoints\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Http\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http://dotnet.localhost.direct\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Https\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://dotnet.localhost.direct\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Certificate\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"Path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"localhost.direct.crt\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"KeyPath\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"localhost.direct.key\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>примечания:</p>\n<ul>\n<li>вовсе не обязательно добавлять и HTTP и HTTPS, можно только последний</li>\n<li>все еще можно пользовать порты, аля <code class=\"language-text\">\"Url\": \"https://localhost.direct:5001\",</code></li>\n<li>за вместо домена, по старинке можно указать четыре нолика</li>\n<li>http2 в dotnet включен по умолчанию то ли с 3.1 то ли с 5.0 и не требует вообще никаких дополнительных телодвижений</li>\n</ul>\n<p>В случае с express за вместо привычного <code class=\"language-text\">app.listen(3000)</code> делаем вот так:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app.listen(3000) // instead of this do following:</span>\n<span class=\"token keyword\">const</span> httpServer <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> httpsServer <span class=\"token operator\">=</span> https<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">key</span><span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost.direct.key\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"utf8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">cert</span><span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost.direct.crt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"utf8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  app\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nhttpServer<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nhttpsServer<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">443</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<h2>HTTP2 Header Compression</h2>\n<p>Первая плюшка HTTP2 заключается в том что из коробки он сжимает заголовки запросов и ответов, а в некоторых сценариях они могут оказаться даже больше чем само тело ответа или запроса</p>\n<p>Для примера нам не нужно создавать никаких приложений, возьмем обычный nginx и подправим конфиг таким образом что бы для главной он возращал “Hello World” и 100500 байтиков в кастомных заголовках.</p>\n<p><strong>default.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n    listen              80;\n    listen              443 ssl;\n    server_name         localhost.direct;\n    ssl_certificate     localhost.direct.crt;\n    ssl_certificate_key localhost.direct.key;\n\n    location / {\n        add_header Content-Type text/plain;\n        add_header X-Hundred-Bytes-0 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-1 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-2 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-3 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-4 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-5 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-6 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-7 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-8 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-9 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        return 200 &#39;Hello World\\n&#39;;\n        # # instead of serving html files are returning hardcoded &quot;Hello World&quot; with bunch of headers\n        # root   /usr/share/nginx/html;\n        # index  index.html index.htm;\n    }\n}</code></pre></div>\n<p>Запускаем все это дело</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.crt:/etc/nginx/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.key:/etc/nginx/localhost.direct.key <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/http.conf:/etc/nginx/conf.d/default.conf <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/nginx.conf:/etc/nginx/nginx.conf nginx</code></pre></div>\n<p>И открываем в браузере</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0679db15115281e97efbf4c74fc5ca34/7e318/image-20230201-111423.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.59375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACcUlEQVR42q1RXU/TYBQuN3hlSJSAiihMUnA0bGFCSLpEEsPFLvgF3HHBH+DSeAsNARlWG9mYZMONBTYSwf0WJcA+uvVjH3QUZ9ttfXt8uwnG4IUmPs3Tc87znvfpSQ8xNDR064XbPeF5Puad9vlo3+ws7fPN0jMzPtrrnaanvF7a45n6I0dHXbSDJGnn2JjX5fJMOp3OTqLz9oPhkf6H1cGnA0C5nlnu8Ulwj08AOULBwCAJ9/sewZ27vTfZ3Qv9jx3geEJaPff67L5aV1ePg5ifn6fW/KzKcQFg33LW+80gBLc+gH+DhdW1dVh77b9BW1/3v4HIThT2EwdWMBiCd9ymNjc3N0wkk0lK13UVMBBCFvw7Wnfq9boWDofJ3wxN07SwKfwtrXZsGRqGoQUCgbbhZa2m2g26blj1RgNsNhpNMOpNnDdbeaPZpl3b5wZms2nammXiu5qmtw0j3BaVPz5RpcoFyKWKJcgy5AUJ8qIEX894yPAipDM5KIgy8AUBeEHEfWWQiiUonys2rVJFgXxB1JaWlrBhJELlMllVubiEilK15GIZTs7SkM3xcJbOwPHJKWRwbhtI2EiUS9dmolTEdREbnmOtrLEsnpDbilBfTrPVAv4ybjIFSUZZPo8KooRyeQHhqZCtnSsKqqpqK1cuVMQXJZQWBHT57btZ03Q8jFJbZVmSiMftpRjq1cYw7NdV8TP+Wui1hh/73yITXW+Z47hhYnFxsSe6u/tybz+58jEWW96JxphYLM5E7Rjfw4wz4XCCCYYSTGg7wcRjB8xhaJs5TCSYz6kU8+noaBlz5SiVerWwsNBNYHQQ/w8dPwDwk43EICAy2QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/0679db15115281e97efbf4c74fc5ca34/2bef9/image-20230201-111423.png\"\n        srcset=\"/static/0679db15115281e97efbf4c74fc5ca34/6f3f2/image-20230201-111423.png 256w,\n/static/0679db15115281e97efbf4c74fc5ca34/01e7c/image-20230201-111423.png 512w,\n/static/0679db15115281e97efbf4c74fc5ca34/2bef9/image-20230201-111423.png 1024w,\n/static/0679db15115281e97efbf4c74fc5ca34/71c1d/image-20230201-111423.png 1536w,\n/static/0679db15115281e97efbf4c74fc5ca34/7e318/image-20230201-111423.png 1892w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Как видим ответ был по <code class=\"language-text\">HTTP 1.1</code>, а размер <code class=\"language-text\">1.5 kB</code></p>\n<blockquote>\n<p>Думаю очевидно что строка “Hello World” столько не весит</p>\n</blockquote>\n<p>Далее правим конфиг и меняем <code class=\"language-text\">listen 443 ssl;</code> на <code class=\"language-text\">listen 443 ssl http2;</code> снова запускаем контейнер и проверяем в браузере и видим:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/65d630a197cba75dc8c120fe29b5f94a/7e318/image-20230201-111628.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.59375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACbklEQVR42q1RXU/TYBitF3JnSIQ4Awoyk05gbhlDNOkSvZCLXewXcMcFf4BL4y00ZIPpsGYfSra5sczND5b9FokMRkfXdt8rYNeuH49vO8ELvNDEk5w+z3Pep6fNe7CZmZmh5y7X/OOnDo/X6yV8Ph/h9fqIxUUv4fE8Q/QQbveTP3J21kngOE44HA6P0+lecLvd17GhG2O26bt3OtbpSXjonNddcwvgmnsEtgd2uDeFw9j4BNwcsVzhyKgFJiatYL1v0y23x4298+FhyxS2vLxsD2yFBIqKwPb2Wz0cjkI09h6Cr0LgD2zB5mbwCgNIDwZfQyKZglzusx6N7sAbKiwuLS3ZsHw+b+/1RAEQNE3T4d9hviPLshiPx/Ffhj3TUFVVHZnC31IfVNNQkiQxEokMDE/PzgVjodeTdLnfB4P9vgKSrKBeMXuTigIX51JfBkVRDU1XVQ1EBIqibFgiFrNX9g8ErtEFvt7UWY6HkyoHDMvD/mEFyhUWjsq0OVeYKiILXK2BWIdGqw31ZktHBJqpimtraziWSMTsdJkWWt1TaLY6Oo+WDw7LcEwzUDoqw/73EpTpE2D5umnC8rVLM5arGbppyPE1MRQK4RgVS9i/legOg/6q0WyrDMdrxxVGQ7NW5WpaBVWG5bRmq621uwLSeK3ZGdQSfaJ1hTP17IdofODc70eGmYwRiiRcJIZgPC6G3zEOhEvNDBHde19SBilL8uAOV1dXb6V2d19kP+Y3PqTT68lUmkxnMmTKqOks6rNkMpkjw9Es+W4nh7RP5JedOLmXypB7xSL5tVBYR9woFIsvV1ZWRjGEa9h/xE/rQI3ZBqBDrgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/65d630a197cba75dc8c120fe29b5f94a/2bef9/image-20230201-111628.png\"\n        srcset=\"/static/65d630a197cba75dc8c120fe29b5f94a/6f3f2/image-20230201-111628.png 256w,\n/static/65d630a197cba75dc8c120fe29b5f94a/01e7c/image-20230201-111628.png 512w,\n/static/65d630a197cba75dc8c120fe29b5f94a/2bef9/image-20230201-111628.png 1024w,\n/static/65d630a197cba75dc8c120fe29b5f94a/71c1d/image-20230201-111628.png 1536w,\n/static/65d630a197cba75dc8c120fe29b5f94a/7e318/image-20230201-111628.png 1892w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Протокол - искомый <code class=\"language-text\">HTTP2</code>, а Size уже <code class=\"language-text\">1.0 kB</code></p>\n<p>При этом если в обоих вариантах погонять curl:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-o</span> /dev/null <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-1: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-2: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-3: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-4: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-5: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-6: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-7: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-8: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-9: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-0: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  https://localhost.direct/ <span class=\"token parameter variable\">-w</span> <span class=\"token string\">'version: %{http_version}\\nbody: %{size_download}\\nheaders: %{size_header}\\n'</span></code></pre></div>\n<p>Мы будем видеть для HTTP 1.1:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: 1.1\nbody: 12\nheaders: 1498</code></pre></div>\n<p>А для HTTP2:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: 2\nbody: 12\nheaders: 1470</code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>похоже у curl в логировании размер уже расжатых заголовков</li>\n<li>важно - http2 не делает ничего с телом запроса и ответа и в обоих случаях это 12 байт, для этого смотри историю про <a href=\"Compress-me_2544271361.html\">сжатие</a></li>\n<li>подправив логи со стороны nginx вижу вот такое <code class=\"language-text\">request \"GET / HTTP/1.1\", 1010 bytes received, 1510 bytes sent</code> и <code class=\"language-text\">request \"GET / HTTP/2.0\", 506 bytes received, 1048 bytes sent</code> что уже больше похоже на правду</li>\n<li>для сжатия заголовков не нужно никаких дополнительных телодвижений ни со стороны клиента ни со стороны сервера</li>\n</ul>\n<h2>HTTP2 Socket Connections</h2>\n<p>Второй ништяк HTTP2 это более отимальная утилизация соединений</p>\n<p>В следующем примере уже не получиться открутиться nginx и нужно какое то приложение, в качестве примера взят go, только из-за того что с наскоку получилось найти пример как трекать низкоуровневые подключения</p>\n<p>Само приложение возвращает простенький index.html внутри которого мы подключаем еще десять скриптов, каждый из которых просто печает привествие на страничку</p>\n<p>На выходе на страничке будет:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">demo\nhello /echo/say1\nhello /echo/say2\nhello /echo/say3\nhello /echo/say4\nhello /echo/say5\nhello /echo/say6\nhello /echo/say7\nhello /echo/say8\nhello /echo/say9\nhello /echo/say0</code></pre></div>\n<p>Так ну и само приложение (я себе так думаю даже тем кто впервые в жизни видит go будет плюс минус понятно что там происходит)</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"net\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\trouter <span class=\"token operator\">:=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">NewServeMux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s %s\\n\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Proto<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/html\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token string\">`\n          &lt;!DOCTYPE html>\n          &lt;html>\n          &lt;head>\n              &lt;title>demo&lt;/title>\n          &lt;/head>\n          &lt;body>\n              &lt;h1>demo&lt;/h1>\n              &lt;script src=\"/echo/say1\">&lt;/script>\n              &lt;script src=\"/echo/say2\">&lt;/script>\n              &lt;script src=\"/echo/say3\">&lt;/script>\n              &lt;script src=\"/echo/say4\">&lt;/script>\n              &lt;script src=\"/echo/say5\">&lt;/script>\n              &lt;script src=\"/echo/say6\">&lt;/script>\n              &lt;script src=\"/echo/say7\">&lt;/script>\n              &lt;script src=\"/echo/say8\">&lt;/script>\n              &lt;script src=\"/echo/say9\">&lt;/script>\n              &lt;script src=\"/echo/say0\">&lt;/script>\n          &lt;/body>\n          &lt;/html>\n    `</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/echo/\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s %s\\n\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Proto<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/javascript\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"document.write('hello %s&lt;br>')\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\ts <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>http<span class=\"token punctuation\">.</span>Server<span class=\"token punctuation\">{</span>\n\t\tConnState<span class=\"token punctuation\">:</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>c net<span class=\"token punctuation\">.</span>Conn<span class=\"token punctuation\">,</span> cs http<span class=\"token punctuation\">.</span>ConnState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">if</span> cs <span class=\"token operator\">==</span> http<span class=\"token punctuation\">.</span>StateNew <span class=\"token punctuation\">{</span>\n\t\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GOT NEW TCP CONNECTION\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// https://stackoverflow.com/questions/51317122/how-to-get-number-of-idle-and-active-connections-in-go</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tHandler<span class=\"token punctuation\">:</span> router<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>Args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"http\"</span> <span class=\"token punctuation\">{</span>\n\t\tlistener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">Listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\":80\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open http://localhost/\"</span><span class=\"token punctuation\">)</span>\n\t\ts<span class=\"token punctuation\">.</span><span class=\"token function\">Serve</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>Args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"http2\"</span> <span class=\"token punctuation\">{</span>\n\t\tlistener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">Listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\":443\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open https://localhost.direct/\"</span><span class=\"token punctuation\">)</span>\n\t\ts<span class=\"token punctuation\">.</span><span class=\"token function\">ServeTLS</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost.direct.crt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost.direct.key\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Пробуем запустить его в HTTP режиме:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/main.go:/code/main.go <span class=\"token parameter variable\">-w</span> /code golang go run main.go http</code></pre></div>\n<p>Открываем локалхости и наблюдаем за логами сервиса, видим следующее:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION</code></pre></div>\n<p>Примечание: уже на этом этапе видно как сам браузер пытается лимитировать кол-во подключений, в нашем случае до шести и уже через них гонять запросы</p>\n<p>Теперь запускаемся в HTTP2 режиме:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/main.go:/code/main.go <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/localhost.direct.crt:/code/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/localhost.direct.key:/code/localhost.direct.key <span class=\"token parameter variable\">-w</span> /code golang go run main.go http2</code></pre></div>\n<p>Все так же открываем страничку, но на этот раз в логах будет только:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GOT NEW TCP CONNECTION</code></pre></div>\n<p>Тем самым было созданно всего одно соединение и через него передалось все добро, попутно компресируя заголовки из пред примера</p>\n<h2>HTTP2 Server Push</h2>\n<p>Еще одна приколюха и она же первая ложка дегтя</p>\n<p>HTTP2 позволяет “пушнуть” клиенту данные, еще до того как он сообразил что они ему нужны</p>\n<p>В следующем примере наша приложенька выдает index.html, который подключает styles.css в которых подключается катринка для фона. При этом стили и картинка отдаются с задержкой в 2 секунды, а как следствие браузер в начале потратит 2 секунды на получение стилей, только потом сообразит что ему нужна картинка, будет ждать ее и общее время загрузки странички займет около 4 секунд</p>\n<p>Код приложения</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"net\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n\t<span class=\"token string\">\"time\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\trouter <span class=\"token operator\">:=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">NewServeMux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/style.css\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n\t\tb<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"style.css\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/css\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sc2.jpeg\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n\t\tb<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sc2.jpeg\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"image/jpeg\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\tpusher<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> w<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>Pusher<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> ok <span class=\"token punctuation\">{</span>\n\t\t\terr <span class=\"token operator\">:=</span> pusher<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/style.css\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\terr <span class=\"token operator\">=</span> pusher<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sc2.jpeg\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http2 push is not supported\"</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\tb<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"index.html\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/html\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\ts <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>http<span class=\"token punctuation\">.</span>Server<span class=\"token punctuation\">{</span>\n\t\tHandler<span class=\"token punctuation\">:</span> router<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>Args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"http\"</span> <span class=\"token punctuation\">{</span>\n\t\tlistener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">Listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\":80\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open http://localhost/\"</span><span class=\"token punctuation\">)</span>\n\t\ts<span class=\"token punctuation\">.</span><span class=\"token function\">Serve</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>Args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"http2\"</span> <span class=\"token punctuation\">{</span>\n\t\tlistener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">Listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\":443\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open https://localhost.direct/\"</span><span class=\"token punctuation\">)</span>\n\t\ts<span class=\"token punctuation\">.</span><span class=\"token function\">ServeTLS</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost.direct.crt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost.direct.key\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Опять же, никакого ракетостроения, самое интересное будет дальше</p>\n<p>Так ну и пробуем его запустить в режиме http и http2, по аналогии с тем как делали это в предыдущих экспериментах</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/46fa238d14b6af1d2b8f6d1ebf2b51f5/8126d/image-20230201-114626.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.34374999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC8ElEQVR42o2T30tTYRjHjwrSD1Ch6EYjDxi1XWU4lwlBNSnFdDfDi5QgvAkkLwyi9MI1vTIIJE/mzVAvJuGNtYuBf4HXLTcJaTttO9vc2Xbe95zt7Nf79L5vTQqEfOGz59275/m+zzn7PsLup93WbEp+F0/FVpW4spLJZCQ58l0K7e9L3vV1af0PW1tb0ubmpuT1evk+Ho9LuVxOovkr6XR6lX5/u7e3d0HwfvB2Zo+Spl7UoVarEaCrWjGhVDKBJkIqleKRFvOYTCbh6OgIqtUqSz2uKZVKKBAIXBc2NjbEWDyhB78Ga9FotCzLciWppCr0Zo5RKFRoEYfWnUSZQsrlco4L7uzsiPRmMxwOQzgUIqHQPvyIHEI2mwVd16FYLEKhUOD7SqXCOuL8tXiHpmliv99vEWZmZsTRkVHTZrNDj81G+uz9cL//IfT22uFW32240X0Tpqenf1cSAiesfwUnJyfFjvZ2U2hogJazF4n98gg8fvASrrX1wrkzbSAIAgw4Burv6/+CU1NTotjZaZ5vaYM7PcPk6fAcPH/2EZ7cewH27rtccHBw8PSCvMOODpMVUkhTYzNcarVwoaamRh4dDsfpBT0ej7i4uGi+np2FNx4PcbvnYXbuFcy73eBZWAB2Tp1w+ne4trYm0n/QZL5inmK2qheyWAdjDAghHhmaptUhzAWqqmKfz2cRlpeXqQ/jJv8xnyfZHAKVWqYuwGCWyefzx5GdUQFQEgqDMKNHohFMJ8oiLC0ticHgN1NRFJZEWKKaybBHYO7nk2IYBr+AeZKdMUENaaBimotUQm0PuqajwGdqbNbhwcGByYRY+/XbqfO5kZkYE2eCLLJzHeuADASxUgzk4k+ShjTIBRn7/D7W4fsrajaXQkgzqCCiYAadFEy7xnSKeEwkEpjOMYc+NkYawgYysI4wSqiJwmHsML79ZfuqYLVam8fHx7tcLpd1bGzMchITExOc+t7pdHKGnEM8ukZcVtcjVxf9bP4FTp+owT9YZ04AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/46fa238d14b6af1d2b8f6d1ebf2b51f5/2bef9/image-20230201-114626.png\"\n        srcset=\"/static/46fa238d14b6af1d2b8f6d1ebf2b51f5/6f3f2/image-20230201-114626.png 256w,\n/static/46fa238d14b6af1d2b8f6d1ebf2b51f5/01e7c/image-20230201-114626.png 512w,\n/static/46fa238d14b6af1d2b8f6d1ebf2b51f5/2bef9/image-20230201-114626.png 1024w,\n/static/46fa238d14b6af1d2b8f6d1ebf2b51f5/71c1d/image-20230201-114626.png 1536w,\n/static/46fa238d14b6af1d2b8f6d1ebf2b51f5/a878e/image-20230201-114626.png 2048w,\n/static/46fa238d14b6af1d2b8f6d1ebf2b51f5/8126d/image-20230201-114626.png 2316w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>В HTTP1 мы видим ту самую лесенку в network и ожидаемое время ответа в 4 секунды</p>\n<p>А вот для HTTP2</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/78a736a48419ecc270c1c93418870dbc/8126d/image-20230201-114832.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.34374999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC7ElEQVR42o1TS0sbURQeFaQPsELblZY6YKnJqhZjaoWCNNoIEt2IiyKF4qYgdWGhJXGhxHaTQkHq1LoJiqCEUrC6EPwF7ooJJl2UaprHTB6TzCPJmMc9PffapLYI9cDHucOc77tnznyH2/XtXpGl8LuoFFmKR+OLqVRKCB9+EwKBfWFlZYVhbW1N8Pl8LHu9XmFjY0OIRqNCJpMRsH4xkUgs4fPbvb29q5z3g7dNToqGXtChUqkQwCiXCmAYBmAhSJIESIJsNgvJZBJEUWS5XC7T0hrn+PhY3dnZ6eBWV1f5SDSmB/yBytHRUTEcDpdEMVFCEYZcPl9CEgPyzkIRQYrFYoYJbm5u8tiJEQqFIBQMkmDwAH4cfgdZlkHXdSgUCpDP59mZdoXCDKeCdYhfpG1vb5u46elpftgxbFgsVuiyWEiPtRce9tqhu9sK93ruw53OuzA1NXXCJATOiL8FJyYm+NaWFoOrq4Omi9eI9YYDHj96Cbebu+HShWbgOA76bf3Vef1fcHJykufb2ozLTc3woGuIPB2agefPPsKTvhdg7exjgoODg+cXZB22thqUiCAN9Y1wvcnEhBoa6lm22WznF3S7XPzrN28Mp9MJbrebzM7NgmvmFczOzYF7fh6cLhegE84/w+XlZR7/oPH7DxJqqyqRZgramaZpoKoqyxSKoqA3Fchks0TP5dCraW19fd3ELSws8LFYzKAFqqqQjKJBGi1TJVLkkECNXc0KCqfTaUiIcUhKcaJmZIhFwhpulYnzeDy83+83cHXoRhDqP7wAIpEI8x8TwMuoWKlUYr6U5TSIiRQcxBXY/ymTkKTD1yNJ9X760lHrkH4OEgklUyG6elSAjqJq6D8jKOO7Mhi4fbkSELouasHQPtMZejzvb2YVVdI0NaeehEaDZtxbDbtmuXrGPdaqkTsBTiqbl8R4dGtr6xZnNpsbR0dH2x0Oh3lkZMR0GmNjYzWMj4/Xzv/W2e1288DAQDvV+gWmRKie0VBTgAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/78a736a48419ecc270c1c93418870dbc/2bef9/image-20230201-114832.png\"\n        srcset=\"/static/78a736a48419ecc270c1c93418870dbc/6f3f2/image-20230201-114832.png 256w,\n/static/78a736a48419ecc270c1c93418870dbc/01e7c/image-20230201-114832.png 512w,\n/static/78a736a48419ecc270c1c93418870dbc/2bef9/image-20230201-114832.png 1024w,\n/static/78a736a48419ecc270c1c93418870dbc/71c1d/image-20230201-114832.png 1536w,\n/static/78a736a48419ecc270c1c93418870dbc/a878e/image-20230201-114832.png 2048w,\n/static/78a736a48419ecc270c1c93418870dbc/8126d/image-20230201-114832.png 2316w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Картинка другая:</p>\n<ol>\n<li>Время загрузки странички около предпологаемых 2 секунд</li>\n<li>На деле мы не делали запросов за стилями и картинками</li>\n<li>На деле запросы за ними были пушнуты нам, причем в праалель</li>\n</ol>\n<p>Дальше самое веселое:</p>\n<ol>\n<li>Скришоты в сафари не с проста</li>\n<li>Пример на go тоже</li>\n<li>Пытаясь понять как это сделать на dotnet наткнулся на такой вот <a href=\"https://github.com/dotnet/aspnetcore/issues/4249#issuecomment-728363386\">коммент</a>, который ставит крест на этой фиче и поясняет происходящее</li>\n</ol>\n<h2>HTTP2 behind Reverse Proxy</h2>\n<p>Но это только начало, дальше больше, нужно еще понять как оно ведет себя за проксей</p>\n<p>Идея такая - берем приложение из истории про соединения и запускаем его за проксирующим nginx настроенным на http2, по сути то это будет то же самое что быть за cloudflare (который сделан поверх nginx) и\\или за ingress в кубернетесах или еще веслее как у нас когда мы за cloudflare, а затем ingress</p>\n<p>Конфиг получился вот такой:</p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n    listen              80;\n    listen              443 ssl http2;\n    server_name         localhost.direct;\n    ssl_certificate     localhost.direct.crt;\n    ssl_certificate_key localhost.direct.key;\n\n    # location / {\n    #     proxy_pass https://http.localhost.direct;\n    # }\n\n    # With such config, even so from client side we see HTTP2, on proxied service logs we see that requests are HTTP1.1\n    location / {\n        proxy_pass https://http2.localhost.direct:443;\n    }\n}</code></pre></div>\n<p>Запускал вот так:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>http2 --add-host<span class=\"token operator\">=</span>http2.localhost.direct:172.17.0.2 <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.crt:/etc/nginx/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.key:/etc/nginx/localhost.direct.key <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/proxy.conf:/etc/nginx/conf.d/default.conf <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/nginx.conf:/etc/nginx/nginx.conf nginx</code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>какого то фига не работает опция docker run с принудительным выставлением адреса, но при это адрес выдавался всегда один и тот же, потому мы просто его захардкодили</li>\n</ul>\n<p>И тут начинается самое интересное - не важно с каким бубном мы вокруг этой штуки ходим, коммуникация между клиентом и nginx идет по http2 как и ожидается, а вот между nginx и нашим приложением уже обычный http</p>\n<p>По концовке интернеты вывели на вот этот <a href=\"https://serverfault.com/a/875471/255456\">комментарий</a> который еще раз многое ставит на свои места</p>\n<h2>Заключение</h2>\n<ul>\n<li>HTTP2 может ускорить работу сервисов торчащих наружу за счет сжатия и более грамотной утилизации сокетов</li>\n<li>Будучи за проксей по типу того же nginx, оптимизация все еще будет, т.к. хотя бы по наружке будет бегать все сжатым, а в нутри уже не так страшно т.к. там nginx химичит с keepalive и тем самым не плодит подключений, ну а сам трафик бесплатный</li>\n<li>А вот будучи за cloudflare, а затем за ingress уже вопрос интересный 🤔</li>\n</ul>\n<blockquote>\n<p>Любопытная отсылка к попытке вкрутить gRPC, который, в идеале, работает поверх HTTP2 раскрывается в новых крассках, благо у Cloudflare есть галочка по этому делу, но с оговорками по типу “At the moment, connection multiplexing is not supported by our implementation but will soon be available.“</p>\n</blockquote>"}},"pageContext":{"id":"32255675-b405-581a-aede-102280c71ee1"}},"staticQueryHashes":[],"slicesMap":{}}