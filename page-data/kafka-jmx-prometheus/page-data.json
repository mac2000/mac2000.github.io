{"componentChunkName":"component---src-templates-note-js","path":"/kafka-jmx-prometheus/","result":{"data":{"remark":{"fields":{"path":"kafka-jmx-prometheus"},"meta":{"title":""},"headings":[{"value":"Kafka JMX Prometheus Metrics"}],"html":"<h1>Kafka JMX Prometheus Metrics</h1>\n<p>At moment of writing, minial docker example is</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>kafka <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9092</span>:9092 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">CLUSTER_ID</span><span class=\"token operator\">=</span>DDFn9qNCTrin1hUV7Rd6nQ <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_NODE_ID</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_PROCESS_ROLES</span><span class=\"token operator\">=</span>broker,controller <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_LISTENERS</span><span class=\"token operator\">=</span>PLAINTEXT://:9092,CONTROLLER://:9093 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_ADVERTISED_LISTENERS</span><span class=\"token operator\">=</span>PLAINTEXT://localhost:9092 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_CONTROLLER_QUORUM_VOTERS</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>@localhost:9093 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_CONTROLLER_LISTENER_NAMES</span><span class=\"token operator\">=</span>CONTROLLER <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_TRANSACTION_STATE_LOG_MIN_ISR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  confluentinc/cp-kafka:7.9.0</code></pre></div>\n<p>to check if everything ok run following examples:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># create topic</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> kafka kafka-topics --bootstrap-server localhost:9092 <span class=\"token parameter variable\">--create</span> <span class=\"token parameter variable\">--topic</span> topic1\n\n<span class=\"token comment\"># consume</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> kafka kafka-console-consumer --bootstrap-server localhost:9092 <span class=\"token parameter variable\">--topic</span> topic1\n\n<span class=\"token comment\"># produce</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> kafka kafka-console-producer --bootstrap-server localhost:9092 <span class=\"token parameter variable\">--topic</span> topic1</code></pre></div>\n<h2>Metrics</h2>\n<p>minimally to get up and running we need following</p>\n<p><strong>jmx.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'.*'</span></code></pre></div>\n<p>plus following environment variables:</p>\n<ul>\n<li><code class=\"language-text\">KAFKA_JMX_PORT=9101</code></li>\n<li><code class=\"language-text\">KAFKA_JMX_HOSTNAME=localhost</code></li>\n<li><code class=\"language-text\">KAFKA_OPTS=-javaagent:/usr/share/java/cp-base-new/jmx_prometheus_javaagent-0.18.0.jar=9999:/etc/kafka/jmx.yml</code></li>\n</ul>\n<p>last one, will use <code class=\"language-text\">jmx_prometheus_javaagent</code> baked into container, it will listen <code class=\"language-text\">9999</code> port and be configured with <code class=\"language-text\">/etc/kafka/jmx.yml</code> which we need to mount, aka</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>kafka <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9092</span>:9092 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9101</span>:9101 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9999</span>:9999 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">CLUSTER_ID</span><span class=\"token operator\">=</span>DDFn9qNCTrin1hUV7Rd6nQ <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_NODE_ID</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_PROCESS_ROLES</span><span class=\"token operator\">=</span>broker,controller <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_LISTENERS</span><span class=\"token operator\">=</span>PLAINTEXT://:9092,CONTROLLER://:9093 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_ADVERTISED_LISTENERS</span><span class=\"token operator\">=</span>PLAINTEXT://localhost:9092 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_CONTROLLER_QUORUM_VOTERS</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>@localhost:9093 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_CONTROLLER_LISTENER_NAMES</span><span class=\"token operator\">=</span>CONTROLLER <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_TRANSACTION_STATE_LOG_MIN_ISR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_JMX_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">9101</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_JMX_HOSTNAME</span><span class=\"token operator\">=</span>localhost <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_OPTS</span><span class=\"token operator\">=</span>-javaagent:/usr/share/java/cp-base-new/jmx_prometheus_javaagent-0.18.0.jar<span class=\"token operator\">=</span><span class=\"token number\">9999</span>:/etc/kafka/jmx.yml <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/jmx.yml:/etc/kafka/jmx.yml\"</span> <span class=\"token punctuation\">\\</span>\n  confluentinc/cp-kafka:7.9.0</code></pre></div>\n<p>note: we are exposing <code class=\"language-text\">9101</code> JMX port, you may want to use <code class=\"language-text\">jconsole</code> and connect to it, to see what metrics are available, you may need it while configuring prometheus agent</p>\n<p>and you should have your metrics here: <a href=\"http://localhost:9999/metrics\">http://localhost:9999/metrics</a></p>\n<p>detailed docs about metrics can be found here: <a href=\"https://docs.confluent.io/platform/current/kafka/monitoring.html\">https://docs.confluent.io/platform/current/kafka/monitoring.html</a></p>\n<h2>Rules</h2>\n<p>By default, our config does expose all metrics as is, which produces bazillion of metrics, from one some of them are weird, it is not always easy to understand whether metric is gauge or counter and after all we do not need all of them</p>\n<p>Instead of</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'.*'</span></code></pre></div>\n<p>we may create dedicated rules</p>\n<p>let's start from simplest possible one</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#linux-disk-write-bytes</span>\n  <span class=\"token comment\"># mbean: kafka.server:type=KafkaServer,name=linux-disk-write-bytes</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=KafkaServer<span class=\"token punctuation\">,</span> name=linux<span class=\"token punctuation\">-</span>disk<span class=\"token punctuation\">-</span>write<span class=\"token punctuation\">-</span>bytes<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_server_disk_write_bytes_total\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> The total number of bytes written by the broker process<span class=\"token punctuation\">,</span> including writes from all disks\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=Fetch<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>queue<span class=\"token punctuation\">-</span>size\n  <span class=\"token comment\"># - pattern: '.*' # uncomment me to see the rest</span></code></pre></div>\n<p>notes:</p>\n<ul>\n<li>even so we have defined exact metrics we want, exporter still will produce some jvm and process based metrics</li>\n<li>keep an eye on metric names for given example <code class=\"language-text\">kafka_server_disk_write_bytes</code> will be incorrect and it wants <code class=\"language-text\">_total</code> prefix, keep an eye on generated comments</li>\n<li>be careful to choose <code class=\"language-text\">COUNTER</code> vs <code class=\"language-text\">GAUGE</code></li>\n</ul>\n<h2>Regex</h2>\n<p>there is a way to catch multiple metrics by using regular expressions here is an example</p>\n<p>for example if we want to keep trak controller metrics we may do something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#activecontrollercount</span>\n  <span class=\"token comment\"># kafka.controller:type=KafkaController,name=ActiveControllerCount</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.controller&lt;type=KafkaController<span class=\"token punctuation\">,</span> name=ActiveControllerCount<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_controller_active_controller_count\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> The number of active controllers in the cluster. Valid values are 0 or 1. Alert if the aggregated sum across all brokers in the cluster is anything other than 1 because there should be exactly one controller per cluster.\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#activebrokercount</span>\n  <span class=\"token comment\"># kafka.controller:type=KafkaController,name=ActiveBrokerCount</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.controller&lt;type=KafkaController<span class=\"token punctuation\">,</span> name=ActiveBrokerCount<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_controller_active_broker_count\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> The number of active brokers as observed by this controller.\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE</code></pre></div>\n<p>it will produce:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># HELP kafka_controller_active_controller_count The number of active controllers in the cluster. Valid values are 0 or 1. Alert if the aggregated sum across all brokers in the cluster is anything other than 1 because there should be exactly one controller per cluster.</span>\n<span class=\"token comment\"># TYPE kafka_controller_active_controller_count gauge</span>\nkafka_controller_active_controller_count <span class=\"token number\">1.0</span>\n<span class=\"token comment\"># HELP kafka_controller_active_broker_count The number of active brokers as observed by this controller.</span>\n<span class=\"token comment\"># TYPE kafka_controller_active_broker_count gauge</span>\nkafka_controller_active_broker_count <span class=\"token number\">1.0</span></code></pre></div>\n<p>or, instead, we may do:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.controller&lt;type=KafkaController<span class=\"token punctuation\">,</span> name=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_controller_$1_count\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE</code></pre></div>\n<p>which will give us:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># HELP kafka_controller_LastAppliedRecordOffset_count Attribute exposed for management kafka.controller:name=LastAppliedRecordOffset,type=KafkaController,attribute=Value</span>\n<span class=\"token comment\"># TYPE kafka_controller_LastAppliedRecordOffset_count gauge</span>\nkafka_controller_LastAppliedRecordOffset_count <span class=\"token number\">4165.0</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token comment\"># HELP kafka_controller_EventQueueOperationsStartedCount_count Attribute exposed for management kafka.controller:name=EventQueueOperationsStartedCount,type=KafkaController,attribute=Value</span>\n<span class=\"token comment\"># TYPE kafka_controller_EventQueueOperationsStartedCount_count gauge</span>\nkafka_controller_EventQueueOperationsStartedCount_count <span class=\"token number\">9631.0</span></code></pre></div>\n<p>if we do not want all of them we may do:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.controller&lt;type=KafkaController<span class=\"token punctuation\">,</span> name=(ActiveControllerCount<span class=\"token punctuation\">|</span>ActiveBrokerCount)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_controller_$1_count\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE</code></pre></div>\n<p>and output will be:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># HELP kafka_controller_ActiveControllerCount_count Attribute exposed for management kafka.controller:name=ActiveControllerCount,type=KafkaController,attribute=Value</span>\n<span class=\"token comment\"># TYPE kafka_controller_ActiveControllerCount_count gauge</span>\nkafka_controller_ActiveControllerCount_count <span class=\"token number\">1.0</span>\n<span class=\"token comment\"># HELP kafka_controller_ActiveBrokerCount_count Attribute exposed for management kafka.controller:name=ActiveBrokerCount,type=KafkaController,attribute=Value</span>\n<span class=\"token comment\"># TYPE kafka_controller_ActiveBrokerCount_count gauge</span>\nkafka_controller_ActiveBrokerCount_count <span class=\"token number\">1.0</span></code></pre></div>\n<p>to lowercase metrics do this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">lowercaseOutputName</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">lowercaseOutputLabelNames</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.controller&lt;type=KafkaController<span class=\"token punctuation\">,</span> name=(ActiveControllerCount<span class=\"token punctuation\">|</span>ActiveBrokerCount)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_controller_$1_count\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># HELP kafka_controller_activecontrollercount_count Attribute exposed for management kafka.controller:name=ActiveControllerCount,type=KafkaController,attribute=Value</span>\n<span class=\"token comment\"># TYPE kafka_controller_activecontrollercount_count gauge</span>\nkafka_controller_activecontrollercount_count <span class=\"token number\">1.0</span>\n<span class=\"token comment\"># HELP kafka_controller_activebrokercount_count Attribute exposed for management kafka.controller:name=ActiveBrokerCount,type=KafkaController,attribute=Value</span>\n<span class=\"token comment\"># TYPE kafka_controller_activebrokercount_count gauge</span>\nkafka_controller_activebrokercount_count <span class=\"token number\">1.0</span></code></pre></div>\n<p>note: so technically it is an question of if you want dedicated help messages and metrics or if you want do everything at once</p>\n<h2>Labels</h2>\n<p>there is also an way to relabel metrics like so</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">lowercaseOutputName</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">lowercaseOutputLabelNames</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.controller&lt;type=KafkaController<span class=\"token punctuation\">,</span> name=(ActiveControllerCount<span class=\"token punctuation\">|</span>ActiveBrokerCount)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_controller_count\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> $1\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># HELP kafka_controller_count Attribute exposed for management kafka.controller:name=ActiveBrokerCount,type=KafkaController,attribute=Value</span>\n<span class=\"token comment\"># TYPE kafka_controller_count gauge</span>\nkafka_controller_count<span class=\"token punctuation\">{</span><span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"ActiveBrokerCount\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">1.0</span>\nkafka_controller_count<span class=\"token punctuation\">{</span><span class=\"token builtin\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"ActiveControllerCount\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">1.0</span></code></pre></div>\n<p>you may really want labels for topic related metrics</p>\n<p>here is little bit different way of commands to run</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># start kafka</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>kafka <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9999</span>:9999 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">CLUSTER_ID</span><span class=\"token operator\">=</span>DDFn9qNCTrin1hUV7Rd6nQ <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_NODE_ID</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_PROCESS_ROLES</span><span class=\"token operator\">=</span>broker,controller <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_LISTENERS</span><span class=\"token operator\">=</span>PLAINTEXT://:9092,CONTROLLER://:9093 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_ADVERTISED_LISTENERS</span><span class=\"token operator\">=</span>PLAINTEXT://kafka:9092 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_CONTROLLER_QUORUM_VOTERS</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>@localhost:9093 <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_CONTROLLER_LISTENER_NAMES</span><span class=\"token operator\">=</span>CONTROLLER <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_TRANSACTION_STATE_LOG_MIN_ISR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_JMX_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">9101</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_JMX_HOSTNAME</span><span class=\"token operator\">=</span>localhost <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">KAFKA_OPTS</span><span class=\"token operator\">=</span>-javaagent:/usr/share/java/cp-base-new/jmx_prometheus_javaagent-0.18.0.jar<span class=\"token operator\">=</span><span class=\"token number\">9999</span>:/etc/kafka/jmx.yml <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token environment constant\">$PWD</span>/jmx.yml:/etc/kafka/jmx.yml\"</span> <span class=\"token punctuation\">\\</span>\n  confluentinc/cp-kafka:7.9.0\n\n<span class=\"token comment\"># create topic</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>kafka confluentinc/cp-kafka:7.9.0 kafka-topics --bootstrap-server kafka:9092 <span class=\"token parameter variable\">--create</span> <span class=\"token parameter variable\">--topic</span> topic1\n\n<span class=\"token comment\"># start consumer</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>kafka confluentinc/cp-kafka:7.9.0 kafka-console-consumer --bootstrap-server kafka:9092 <span class=\"token parameter variable\">--topic</span> topic1\n\n<span class=\"token comment\"># start producer</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>kafka confluentinc/cp-kafka:7.9.0 kafka-console-producer --bootstrap-server kafka:9092 <span class=\"token parameter variable\">--topic</span> topic1\n\n<span class=\"token comment\"># type something in producer, press enter, repeat few times</span>\n<span class=\"token comment\"># then create few more topics and repeat steps</span></code></pre></div>\n<p>let's try to expose MessagesInPerSec, BytesInPerSec and BytesOutPerSec for topics</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#messagesinpersec</span>\n  <span class=\"token comment\"># kafka.server:type=BrokerTopicMetrics,name=MessagesInPerSec,topic={topicName}</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=BrokerTopicMetrics<span class=\"token punctuation\">,</span> name=MessagesInPerSec<span class=\"token punctuation\">,</span> topic=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_messages_total\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> The incoming message rate per topic.\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> $1\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#bytesinpersec</span>\n  <span class=\"token comment\"># kafka.server:type=BrokerTopicMetrics,name=BytesInPerSec,topic={topicName}</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=BrokerTopicMetrics<span class=\"token punctuation\">,</span> name=BytesInPerSec<span class=\"token punctuation\">,</span> topic=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_incoming_bytes_total\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> The incoming byte rate from clients<span class=\"token punctuation\">,</span> per topic.\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> $1\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#bytesoutpersec</span>\n  <span class=\"token comment\"># kkafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec,topic={topicName}</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.server&lt;type=BrokerTopicMetrics<span class=\"token punctuation\">,</span> name=BytesOutPerSec<span class=\"token punctuation\">,</span> topic=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Count\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_outgoing_bytes_total\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> The outgoing byte rate to clients per topic.\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> $1\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> COUNTER</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># HELP kafka_outgoing_bytes_total The outgoing byte rate to clients per topic.</span>\n<span class=\"token comment\"># TYPE kafka_outgoing_bytes_total counter</span>\nkafka_outgoing_bytes_total<span class=\"token punctuation\">{</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic1\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">300.0</span>\nkafka_outgoing_bytes_total<span class=\"token punctuation\">{</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic2\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">146.0</span>\n<span class=\"token comment\"># HELP kafka_messages_total The incoming message rate per topic.</span>\n<span class=\"token comment\"># TYPE kafka_messages_total counter</span>\nkafka_messages_total<span class=\"token punctuation\">{</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic1\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">5.0</span>\nkafka_messages_total<span class=\"token punctuation\">{</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"__consumer_offsets\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">6.0</span>\nkafka_messages_total<span class=\"token punctuation\">{</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic2\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">2.0</span>\n<span class=\"token comment\"># HELP kafka_incoming_bytes_total The incoming byte rate from clients, per topic.</span>\n<span class=\"token comment\"># TYPE kafka_incoming_bytes_total counter</span>\nkafka_incoming_bytes_total<span class=\"token punctuation\">{</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic1\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">300.0</span>\nkafka_incoming_bytes_total<span class=\"token punctuation\">{</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic2\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">146.0</span>\nkafka_incoming_bytes_total<span class=\"token punctuation\">{</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"__consumer_offsets\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">1410.0</span></code></pre></div>\n<p>Here is one more example with topics + paritions</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#messagesinpersec</span>\n  <span class=\"token comment\"># kafka.log:type=Log,name=Size,topic=topic1,partition=0</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.log&lt;type=Log<span class=\"token punctuation\">,</span> name=Size<span class=\"token punctuation\">,</span> topic=(.+)<span class=\"token punctuation\">,</span> partition=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_log_size_bytes\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> A metric for the total size in bytes of all log segments that belong to a given partition.\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> $1\n      <span class=\"token key atrule\">partition</span><span class=\"token punctuation\">:</span> $2\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#logstartoffset</span>\n  <span class=\"token comment\"># kafka.log:type=Log,name=LogStartOffset,topic=topic1,partition=0</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.log&lt;type=Log<span class=\"token punctuation\">,</span> name=LogStartOffset<span class=\"token punctuation\">,</span> topic=(.+)<span class=\"token punctuation\">,</span> partition=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_log_start_offset\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> The offset of the first message in a partition. Use with LogEndOffset to calculate the current message count for a topic.\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> $1\n      <span class=\"token key atrule\">partition</span><span class=\"token punctuation\">:</span> $2\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE\n  <span class=\"token comment\"># https://docs.confluent.io/platform/current/kafka/monitoring.html#logendoffset</span>\n  <span class=\"token comment\"># kafka.log:type=Log,name=LogEndOffset,topic=topic1,partition=0</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> kafka.log&lt;type=Log<span class=\"token punctuation\">,</span> name=LogEndOffset<span class=\"token punctuation\">,</span> topic=(.+)<span class=\"token punctuation\">,</span> partition=(.+)<span class=\"token punctuation\">></span>&lt;<span class=\"token punctuation\">></span>Value\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kafka_log_end_offset\n    <span class=\"token key atrule\">help</span><span class=\"token punctuation\">:</span> The offset of the last message in a partition. Use with LogStartOffset to calculate the current message count for a topic.\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">topic</span><span class=\"token punctuation\">:</span> $1\n      <span class=\"token key atrule\">partition</span><span class=\"token punctuation\">:</span> $2\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> GAUGE</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># HELP kafka_log_end_offset The offset of the last message in a partition. Use with LogStartOffset to calculate the current message count for a topic.</span>\n<span class=\"token comment\"># TYPE kafka_log_end_offset gauge</span>\nkafka_log_end_offset<span class=\"token punctuation\">{</span>partition<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic1\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">5.0</span>\nkafka_log_end_offset<span class=\"token punctuation\">{</span>partition<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic2\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">2.0</span>\n<span class=\"token comment\"># HELP kafka_log_start_offset The offset of the first message in a partition. Use with LogEndOffset to calculate the current message count for a topic.</span>\n<span class=\"token comment\"># TYPE kafka_log_start_offset gauge</span>\nkafka_log_start_offset<span class=\"token punctuation\">{</span>partition<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic1\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">0.0</span>\nkafka_log_start_offset<span class=\"token punctuation\">{</span>partition<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic2\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">0.0</span>\n<span class=\"token comment\"># HELP kafka_log_size_bytes A metric for the total size in bytes of all log segments that belong to a given partition.</span>\n<span class=\"token comment\"># TYPE kafka_log_size_bytes gauge</span>\nkafka_log_size_bytes<span class=\"token punctuation\">{</span>partition<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic2\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">146.0</span>\nkafka_log_size_bytes<span class=\"token punctuation\">{</span>partition<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>topic<span class=\"token operator\">=</span><span class=\"token string\">\"topic1\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span> <span class=\"token number\">300.0</span></code></pre></div>\n<p>So, if you want, you may filter metrics as much as you want, probably key ones are mentioned in <a href=\"https://docs.confluent.io/platform/current/kafka/monitoring.html\">docs</a></p>\n<blockquote>\n<p>There are many metrics reported at the broker and controller level that can be monitored and used to troubleshoot issues with your cluster. At minimum, you should monitor and set alerts on <code class=\"language-text\">ActiveControllerCount</code>, <code class=\"language-text\">OfflinePartitionsCount</code>, and <code class=\"language-text\">UncleanLeaderElectionsPerSec</code>.</p>\n</blockquote>\n<p>But if you are not sure, probably it should be ok to stick with defaults</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">startDelaySeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'.*'</span></code></pre></div>\n<p>note: <code class=\"language-text\">startDelaySeconds</code> is used to give app some time to initialize everything, in some examples there are even values like <code class=\"language-text\">120</code></p>"}},"pageContext":{"id":"3059db81-06d7-5b6d-bbf7-f712920e255a"}},"staticQueryHashes":[],"slicesMap":{}}