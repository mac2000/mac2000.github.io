{"componentChunkName":"component---src-templates-note-js","path":"/cloudflare-mass-delete-subdomains/","result":{"data":{"remark":{"fields":{"path":"cloudflare-mass-delete-subdomains"},"meta":{"title":""},"headings":[{"value":"Cloudflare mass delete subdomains"}],"html":"<h1>Cloudflare mass delete subdomains</h1>\n<p>In our case we need to delete quadrillion of subdomain which may be automated via api like so</p>\n<p><div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$headers</span> = @<span class=\"token punctuation\">{</span><span class=\"token string\">'Authorization'</span> = <span class=\"token string\">\"Bearer <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$env</span>:CLOUDFLARE_TOKEN<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token punctuation\">}</span> <span class=\"token comment\"># \"DNS read/write\" token</span>\n<span class=\"token variable\">$zones</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://api.cloudflare.com/client/v4/zones\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty result <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> id<span class=\"token punctuation\">,</span> name\n<span class=\"token variable\">$zone</span> = <span class=\"token variable\">$zones</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> name <span class=\"token operator\">-eq</span> <span class=\"token string\">'rabota.ua'</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty id\n<span class=\"token variable\">$dns</span> = @<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token variable\">$page</span> = 1\n<span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$response</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Get <span class=\"token operator\">-</span>Uri <span class=\"token string\">\"https://api.cloudflare.com/client/v4/zones/<span class=\"token variable\">$zone</span>/dns_records?type=A,CNAME&amp;per_page=100&amp;page=<span class=\"token variable\">$page</span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n    <span class=\"token variable\">$dns</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>result\n    <span class=\"token variable\">$page</span> <span class=\"token operator\">+=</span> 1\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$page</span> <span class=\"token operator\">-le</span> <span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>result_info<span class=\"token punctuation\">.</span>total_pages<span class=\"token punctuation\">)</span>\n<span class=\"token function\">Write-Host</span> <span class=\"token string\">\"Retrieved <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$dns</span><span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">)</span></span> DNS records\"</span>\n<span class=\"token variable\">$items</span> = <span class=\"token variable\">$dns</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> name <span class=\"token operator\">-Like</span> <span class=\"token string\">'*.dev3.rabota.ua'</span>\n<span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$items</span><span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">)</span></span> are to be removed\"</span>\n<span class=\"token comment\"># $items | Select-Object name, type, content</span>\n<span class=\"token comment\"># $item = $dns | Where-Object name -EQ 'dictionaries.dev.rabota.ua'</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span> in <span class=\"token variable\">$items</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Delete <span class=\"token operator\">-</span>Uri <span class=\"token string\">\"https://api.cloudflare.com/client/v4/zones/<span class=\"token variable\">$zone</span>/dns_records/<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Out-Null</span>\n        <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span> - success\"</span> <span class=\"token operator\">-</span>ForegroundColor Green\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span> - failed\"</span> <span class=\"token operator\">-</span>ForegroundColor Red\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">Start-Sleep</span> <span class=\"token operator\">-</span>Seconds 1\n<span class=\"token punctuation\">}</span></code></pre></div></p>"}},"pageContext":{"id":"fd6a0bdc-c324-574b-8b91-c705332de149"}},"staticQueryHashes":[],"slicesMap":{}}