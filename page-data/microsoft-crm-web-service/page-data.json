{"componentChunkName":"component---src-templates-note-js","path":"/microsoft-crm-web-service/","result":{"data":{"remark":{"fields":{"path":"microsoft-crm-web-service"},"meta":{"title":""},"headings":[{"value":"Microsoft CRM web service"}],"html":"<h1>Microsoft CRM web service</h1>\n<p>Интеграция с MS CRM по средствам встроенного сервиса дает возможность получать\\изменять данные в системе.</p>\n<p><strong>Полезные ссылки:</strong></p>\n<p><a href=\"http://example.com:5555/mscrmservices/2006/crmservice.asmx\">http://example.com:5555/mscrmservices/2006/crmservice.asmx</a> - сам сервис</p>\n<p><a href=\"http://example.com:5555/mscrmservices/2006/metadataservice.asmx\">http://example.com:5555/mscrmservices/2006/metadataservice.asmx</a> - мета данные</p>\n<p><a href=\"http://example.com:5555/sdk/list.aspx\">http://example.com:5555/sdk/list.aspx</a> - список сущностей</p>\n<p>Для подключения к студии надо использовать вот такие ссылки:</p>\n<p><a href=\"http://example.com:5555/mscrmservices/2006/crmservice.asmx?WSDL&#x26;uniquename=COMPANYNAME\">http://example.com:5555/mscrmservices/2006/crmservice.asmx?WSDL&#x26;uniquename=COMPANYNAME</a></p>\n<p><a href=\"http://example.com:5555/mscrmservices/2006/metadataservice.asmx?WSDL&#x26;uniquename=COMPANYNAME\">http://example.com:5555/mscrmservices/2006/metadataservice.asmx?WSDL&#x26;uniquename=COMPANYNAME</a></p>\n<p>По ним будут доступны xml файлы описывающие сервис, со всеми кастомными полями и т.п. и именно они будут нужны для подключения к студии.</p>\n<p><strong>Добавление сервиса к проекту.</strong></p>\n<p>Для WinForms - правый клик по проекту <strong>Add Web Reference</strong>, в URL вбиваем путь к сохраненному xml файлу, в Web reference name вбиваем имя создаваемой ссылки.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 817px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dca587f763ce7e3b105d21891ca6bc38/98314/111.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.53125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACX0lEQVR42l2TiW7bMBBE9f9/1rSF4zZGIln3bYm6o8PnK5aW3bQEBksQ5GBnZmmYYYwZBLhFQTJ8kvQ9TtNgFQW5UnRdR13VFEVB3/fM88w0TU/ImaCua+q6wbBDGycI8D2PwLZJgpDY9wnDiCiOCYKAMAgJw5CyVDRNQ1VVK8FfyLnAcD2TbLcj2u3IzQ9qz6ewbWrXY+p7xmliHEeGYSArU9q20ftHZ6KgbVsNTZgnCebLN/bbLdZ2i/m6IfNcVBDQVjX9MGhCkdoODXme47kegX/vPIkTmpVMOjWCuOSXGaKqiqKsyIuWrh8Z5yPH45Hz6cTlcuF2uyFLKcXe2mPbNkVRolSlvROIFcY4L4RhjL3f4/sJntuh1Cfn853g67pcL7oTCUjwkPqPZOnCMk02r6/s3t7Y7WIcJyHPB06nE8uysCxrt+ezfig2CNov/gm0ZLnoui4vL9+xLAfXSbCskMBPybJMp50kKUmS3KUpRR7FFGmKKkvtX70m/CSUy57ncchLskwkNfR9qzEMnYY8mJaFKorwvv8gft3Sl4p5WXRgokTSN06r5J8/N1jWB64T8fGR4jgdVX1jmm7M802Hcr1eaeua7nCg00Pf4/s+m82G9/d33Zgm9H2P37/fsG2HKMrw/Zo4UoSh1I4872mbu+na/AdWmZL8Y9gNMV7myrL2pEmB7/ekacGyjIAkfdWQ7iSUx49opa5hyHDLkMveOB2XdShusM7as/63RPZXwvZLGIfDgbIsMcqmpxtnmmFa68gwTozzdP928/zE5zjeE+26J2R0irLEdsSuiD/eEB7xm+iHuwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/dca587f763ce7e3b105d21891ca6bc38/98314/111.png\"\n        srcset=\"/static/dca587f763ce7e3b105d21891ca6bc38/6f3f2/111.png 256w,\n/static/dca587f763ce7e3b105d21891ca6bc38/01e7c/111.png 512w,\n/static/dca587f763ce7e3b105d21891ca6bc38/98314/111.png 817w\"\n        sizes=\"(max-width: 817px) 100vw, 817px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Для asp.net - правый клик по проекту <strong>Add Service Reference</strong>, далее клик по кнопке <strong>Advanced...</strong> и еще раз клик по кнопке <strong>Add Web Reference..</strong>. и дальше то же самое как и для обычных апликух.</p>\n<p><a href=\"http://msdn.microsoft.com/en-us/library/cc151015.aspx\">http://msdn.microsoft.com/en-us/library/cc151015.aspx</a></p>\n<p><a href=\"http://msdn.microsoft.com/en-us/library/cc151014.aspx\">http://msdn.microsoft.com/en-us/library/cc151014.aspx</a></p>\n<p>Теперь после того как сервисы прикручены можно с ними работать.</p>\n<p><strong>Пример получения информации и компании из CRM</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">MetadataService</span> ms <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MetadataService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">CrmService</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">CrmService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ns<span class=\"token punctuation\">.</span>Credentials <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NetworkCredential</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LOGIN\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PASSWORD\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"COMPANYNAME\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ns<span class=\"token punctuation\">.</span>Credentials <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NetworkCredential</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LOGIN\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PASSWORD\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"COMPANYNAME\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">EntityMetadata</span> em <span class=\"token operator\">=</span> ms<span class=\"token punctuation\">.</span><span class=\"token function\">RetrieveEntityMetadata</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"organization\"</span><span class=\"token punctuation\">,</span> EntityFlags<span class=\"token punctuation\">.</span>All<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> attrs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AttributeMetadata</span> am <span class=\"token keyword\">in</span> em<span class=\"token punctuation\">.</span>Attributes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    attrs<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>am<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">//MessageBox.Show(string.Join(\"\\r\\n\", attrs.ToArray()));</span>\n\n<span class=\"token class-name\">ColumnSet</span> colSet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ColumnSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncolSet<span class=\"token punctuation\">.</span>Attributes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"accountid\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"new_notebookid\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"createdon\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">QueryExpression</span> query <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">QueryExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nquery<span class=\"token punctuation\">.</span>EntityName <span class=\"token operator\">=</span> EntityName<span class=\"token punctuation\">.</span>account<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nquery<span class=\"token punctuation\">.</span>ColumnSet <span class=\"token operator\">=</span> colSet<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//////</span>\n<span class=\"token class-name\">ConditionExpression</span> condition <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ConditionExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncondition<span class=\"token punctuation\">.</span>AttributeName <span class=\"token operator\">=</span> <span class=\"token string\">\"createdon\"</span><span class=\"token punctuation\">;</span>\ncondition<span class=\"token punctuation\">.</span>Operator <span class=\"token operator\">=</span> ConditionOperator<span class=\"token punctuation\">.</span>LastXDays<span class=\"token punctuation\">;</span>\ncondition<span class=\"token punctuation\">.</span>Values <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token punctuation\">{</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Build the filter based on the condition.</span>\n<span class=\"token class-name\">FilterExpression</span> filter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">FilterExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfilter<span class=\"token punctuation\">.</span>FilterOperator <span class=\"token operator\">=</span> LogicalOperator<span class=\"token punctuation\">.</span>And<span class=\"token punctuation\">;</span>\nfilter<span class=\"token punctuation\">.</span>Conditions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ConditionExpression<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token punctuation\">{</span> condition <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Set the Criteria field.</span>\nquery<span class=\"token punctuation\">.</span>Criteria <span class=\"token operator\">=</span> filter<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//////////////////////////</span>\n\n<span class=\"token class-name\">RetrieveMultipleRequest</span> req <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">RetrieveMultipleRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nreq<span class=\"token punctuation\">.</span>Query <span class=\"token operator\">=</span> query<span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">RetrieveMultipleResponse</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>RetrieveMultipleResponse<span class=\"token punctuation\">)</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">Execute</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">string</span></span> res <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>TMP<span class=\"token punctuation\">></span></span> items <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>TMP<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessEntity</span> item <span class=\"token keyword\">in</span> response<span class=\"token punctuation\">.</span>BusinessEntityCollection<span class=\"token punctuation\">.</span>BusinessEntities<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">account</span> a <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span>item<span class=\"token punctuation\">;</span>\n\n    items<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">TMP</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>accountid<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>new_notebookid<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\ndataGridView1<span class=\"token punctuation\">.</span>DataSource <span class=\"token operator\">=</span> items<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Собственно вот как это может выглядеть:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 539px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6e5609b456222331f6ece68a56d400b8/10f9a/22.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.953125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB/UlEQVR42n2SW1PaQBSA85P72Kf+GKqgow99sK3CDFYN2hJAYgQCuXALkBDJFS9U4Gs3HWd635lvZmfP7rdnz1lJuTVp6AO0vo82ilHMBbJ+R7m1oKT5nKjzjNNOyCf9B7KRcGkt+Wwv+aK7XLVG1C6qXJ+UkFq9PsEioGOOqLf72NMAe7LANC0mzpgwCPDnHr1uF38+J45CbtQmH94fUSqeUCoWOT7+SL2pkq6+IqmtLsskIldNePUu4vVRzJviI8pND8dxWG+2hGFIp6OTJCliKIpCLpdjf3+fvb093u7scFouk8YxUteweXh4xPV8rP4QvWdwt4jo9/vMfT8TpGnCcDDEdT3W6zWNRoPd3V0ODw8zhPT8/Dy7ULppG6xWK8bjMZbRwzB6RGGAbVk4E4fNZkOaJNiWja7rRFH8i/Dg4IBCocDZ2RlpmiJdt02enp4YDkeYhoHe7eJ5c0zTYDqdsdluiKII27azugZBSL1e/7ewpnbYbrc4zgTDMLKDokn39/c8Pz9nT16mKZZlMZlMSeLk/0Kl2WY2naHd3lKr1bKCC7FpmsxmM1zXZTAYoDZVxmMHz/OoVCqZ5M8aJkhluUqhkCdfKGQBQT6fzxBZvCAEL/OXuECsi46XRZdFhtVmm6vLCheyjPwbIhOB/JfYz3tEdpqmEX//Nt8A9JCwas22238AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/6e5609b456222331f6ece68a56d400b8/10f9a/22.png\"\n        srcset=\"/static/6e5609b456222331f6ece68a56d400b8/6f3f2/22.png 256w,\n/static/6e5609b456222331f6ece68a56d400b8/01e7c/22.png 512w,\n/static/6e5609b456222331f6ece68a56d400b8/10f9a/22.png 539w\"\n        sizes=\"(max-width: 539px) 100vw, 539px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Чтобы не заморачиваться с ColumnSet - можно юзать вот такую штуку:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">query<span class=\"token punctuation\">.</span>ColumnSet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AllColumns</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Взято отсюда: <a href=\"http://community.dynamics.com/roletailored/customerservice/b/cscrmblog/archive/2009/01/07/building-rich-client-dashboards-for-microsoft-dynamics-crm-with-windows-presentation-foundation.aspx\">http://community.dynamics.com/roletailored/customerservice/b/cscrmblog/archive/2009/01/07/building-rich-client-dashboards-for-microsoft-dynamics-crm-with-windows-presentation-foundation.aspx</a></p>\n<p>Пример выуживания данных сразу из двух сущностей:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">String</span> fetch <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;fetch mapping='logical'>\"</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">\"&lt;entity name='account'>\"</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">\"&lt;attribute name='new_notebookid'/>\"</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">\"&lt;attribute name='name'/>\"</span> <span class=\"token operator\">+</span>\n\n<span class=\"token string\">\"&lt;link-entity name='systemuser' link-type='inner' from='systemuserid' to='ownerid'>\"</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">\"&lt;attribute name='lastname'/>\"</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">\"&lt;/link-entity>\"</span> <span class=\"token operator\">+</span>\n\n<span class=\"token string\">\"&lt;filter type='and'>\"</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">\"&lt;condition attribute = 'name' operator='like' value='%Саша%'/>\"</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">\"&lt;/filter>\"</span> <span class=\"token operator\">+</span>\n\n<span class=\"token string\">\"&lt;/entity>\"</span> <span class=\"token operator\">+</span>\n<span class=\"token string\">\"&lt;/fetch>\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">String</span> result <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">Fetch</span><span class=\"token punctuation\">(</span>fetch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Взято из этих мест:</p>\n<p><a href=\"http://msdn.microsoft.com/en-us/library/ms914457.aspx\">http://msdn.microsoft.com/en-us/library/ms914457.aspx</a></p>\n<p><a href=\"http://social.microsoft.com/Forums/en/crmdevelopment/thread/5ef585a5-58bc-46cd-a134-a46869d0684c\">http://social.microsoft.com/Forums/en/crmdevelopment/thread/5ef585a5-58bc-46cd-a134-a46869d0684c</a></p>\n<p><a href=\"http://www.stunnware.com/crm2/topic.aspx?id=FindingData6\">http://www.stunnware.com/crm2/topic.aspx?id=FindingData6</a></p>\n<p><a href=\"http://mymscrm3.blogspot.com/2008/01/fetchxml-query-examples.html\">http://mymscrm3.blogspot.com/2008/01/fetchxml-query-examples.html</a></p>\n<p><strong>Вытягивание связанных записей</strong></p>\n<p>Задачи за последние N дней плюс кастомное поле из account</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> fetchXml <span class=\"token operator\">=</span> <span class=\"token string\">@\"\n&lt;fetch mapping=\"\"logical\"\" count=\"\"5\"\">\n    &lt;entity name=\"\"activitypointer\"\">\n    &lt;attribute name=\"\"subject\"\" />\n    &lt;filter>\n        &lt;condition attribute=\"\"createdon\"\" operator=\"\"last-x-days\"\" value=\"\"3\"\" />\n        &lt;condition attribute=\"\"statuscode\"\" operator=\"\"eq\"\" value=\"\"1\"\" />\n    &lt;/filter>\n    &lt;link-entity name=\"\"account\"\" from=\"\"accountid\"\" to=\"\"regardingobjectid\"\">\n        &lt;attribute name=\"\"name\"\" />\n        &lt;attribute name=\"\"new_notebookid\"\" />\n    &lt;/link-entity>\n    &lt;/entity>\n&lt;/fetch>\n\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>выглядит вот так:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 363px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/531d43eeaf0c1336cf04199775c4c609/4e786/23.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.484375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACBElEQVR42kWQy27aABBF87fdRs2mUv+gm/5FGnapEkVN0oIIaiRCwDZgA8YOfuB3jIMx5hlOZaO2I93FXM0c3ZmT9lMdUenxJPWZzt5w4gQrfMUMXrGjmChdMFvm/xRny9JLljnRPMV0fTTLRjFMzOiVE3kwwg8j7ImG1m8TGCNWic9q5pLFHupohCgICJ2j+t0uxssLYkdAFESETgdR7PIsClxeX3HS6yvsNhvOmzM+nDucXs75fL/j7GbD10aOIsuoqobr+ZiWTRCEGIaJrr/g+wGGYeB5AaZhULm4KIAy61XOt6eYTzdLTr+nfLzKOPux50t1gT4el7A8z3l/fy/lOA6+77PdbjkcDhQ1m824KID2dMpuf8CzTTxTJ3YN9vkbcOCwybAsC8u2y1RZtiyBQRDQ7Uq4nsd+vy+hcRwfgcXgZrsvlxRliCT10fQJi3zFYpExVscMBwNGI5VeTy5P9n0PWZZxXLdMWUCjKPoPXG922JaFqqpomo6u63ieT5IkDAdD1LFWeuW//IAojBBFEVlRWK/X7HY7wjA8Ah3HpfhCYTjTKUWfLY+nbdZrbNtmOnVKTSYT0nTBfD5nPFZJkjf+VpqmR2CtVqPX69NoNLi9vaVarSGKEpIk0e60qf6q8vP+nnr9gbu7Ox5/P9JqtXh4qPPcekYQhHK22WxSqVT4AwbdhpAJeTufAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/531d43eeaf0c1336cf04199775c4c609/4e786/23.png\"\n        srcset=\"/static/531d43eeaf0c1336cf04199775c4c609/6f3f2/23.png 256w,\n/static/531d43eeaf0c1336cf04199775c4c609/4e786/23.png 363w\"\n        sizes=\"(max-width: 363px) 100vw, 363px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>fetch link-entity aggregate</strong></p>\n<p>Вытягиваем количество действий для конкретного аккаунта:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> fetchXml <span class=\"token operator\">=</span> <span class=\"token string\">@\"\n&lt;fetch mapping=\"\"logical\"\" count=\"\"50\"\" aggregate=\"\"true\"\">\n    &lt;entity name=\"\"activitypointer\"\">\n    &lt;attribute name=\"\"activityid\"\" aggregate=\"\"count\"\" alias=\"\"activitypointer_count\"\" />\n    &lt;link-entity name=\"\"account\"\" from=\"\"accountid\"\" to=\"\"regardingobjectid\"\">\n        &lt;attribute name=\"\"new_notebookid\"\" />\n    &lt;filter>\n        &lt;condition attribute=\"\"new_notebookid\"\" operator=\"\"eq\"\" value=\"\"99\"\" />\n    &lt;/filter>\n    &lt;/link-entity>\n    &lt;/entity>\n&lt;/fetch>\n\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 392px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ba7d28d4f419f40e51d7db7ed1750b3e/0acb4/31.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.3125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABBklEQVR42jXHUUvCUACG4f1Zy0joB0V5X9bFCBJtkigz3aZnZ2tqBmWaVLp1dJtNu3hDoQ8ePl6t5Th0nyR10cf7CBlnGwZhjJgtCcIUf57if6WM1IbRcsvzaks/yngMM/rRhiDM8Bc/ePMU512hVUzB4GWCHwyxrA6208ay2gjRoye6TKZj/MGIar2F0dh54N7sYFqCRtuhWjepNS2Gr1NuKjW0hi35XcfYbxm5y5jcheKwtCJ/FXN0nXByC2YwQy0+UUrxHUUkccw6TUjiFaul2vduNeMOTS8b2J0WJaNL/sylUJQc75xLCkWXg1PBZbmJLwXS85CeREqJ67r7/9cTAl3X+QPLZRPDID7WxQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/ba7d28d4f419f40e51d7db7ed1750b3e/0acb4/31.png\"\n        srcset=\"/static/ba7d28d4f419f40e51d7db7ed1750b3e/6f3f2/31.png 256w,\n/static/ba7d28d4f419f40e51d7db7ed1750b3e/0acb4/31.png 392w\"\n        sizes=\"(max-width: 392px) 100vw, 392px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>fetchxml into datagridview</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> fetchXml <span class=\"token operator\">=</span> <span class=\"token string\">@\"\n&lt;fetch mapping=\"\"logical\"\" count=\"\"50\"\" aggregate=\"\"true\"\">\n    &lt;entity name=\"\"activitypointer\"\">\n    &lt;attribute name=\"\"activityid\"\" aggregate=\"\"count\"\" alias=\"\"activitypointer_count\"\" />\n    &lt;link-entity name=\"\"account\"\" from=\"\"accountid\"\" to=\"\"regardingobjectid\"\">\n        &lt;attribute name=\"\"new_notebookid\"\" />\n    &lt;filter>\n        &lt;condition attribute=\"\"new_notebookid\"\" operator=\"\"eq\"\" value=\"\"99\"\" />\n    &lt;/filter>\n    &lt;/link-entity>\n    &lt;/entity>\n&lt;/fetch>\n\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">String</span> result <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">Fetch</span><span class=\"token punctuation\">(</span>fetchXml<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">StringReader</span> lxmlStringReader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StringReader</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">DataSet</span> ds <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DataSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nds<span class=\"token punctuation\">.</span><span class=\"token function\">ReadXml</span><span class=\"token punctuation\">(</span>lxmlStringReader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ndataGridView1<span class=\"token punctuation\">.</span>DataSource <span class=\"token operator\">=</span> ds<span class=\"token punctuation\">.</span>Tables<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Avoid CRM 5000 limit</h2>\n<p>By default CRM Web Services is limited to return only first 5000 records. Here is how you can retrieve all records:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">MetadataService</span> ms <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MetadataService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">CrmService</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">CrmService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ns<span class=\"token punctuation\">.</span>Credentials <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NetworkCredential</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"USERNAME\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PASSWORD\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DOMAIN\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nms<span class=\"token punctuation\">.</span>Credentials <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NetworkCredential</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"USERNAME\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PASSWORD\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DOMAIN\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">int</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> finished <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">DataSet</span> dsAll <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DataSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>finished <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">String</span> fetch <span class=\"token operator\">=</span> <span class=\"token string\">@\"&lt;fetch mapping='logical' page='\"</span> <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> <span class=\"token string\">@\"' count='5000'> &lt;!-- add page and count attributes to avoid 5000 limit -->\n    &lt;!-- http://example.com:5555/sdk/list.aspx - list of available entities can be found here-->\n    &lt;entity name='account'>\n        &lt;!-- &lt;all-attributes /> - to retrieve all attributes -->\n        &lt;attribute name='new_notebookid'/>\n        &lt;attribute name='name'/>\n        &lt;link-entity name='systemuser' link-type='inner' from='systemuserid' to='ownerid'>\n            &lt;attribute name='fullname'/>\n            &lt;attribute name='firstname'/>\n            &lt;attribute name='lastname'/>\n        &lt;/link-entity>\n        &lt;!-- filtering example\n        &lt;filter type='and'>\n            &lt;condition attribute = 'name' operator='like' value='%Саша%'/>\n        &lt;/filter>\n        -->\n    &lt;/entity>\n    &lt;/fetch>\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">String</span> result <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">Fetch</span><span class=\"token punctuation\">(</span>fetch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">DataSet</span> ds <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DataSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">StringReader</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StringReader</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ds<span class=\"token punctuation\">.</span><span class=\"token function\">ReadXml</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dsAll<span class=\"token punctuation\">.</span><span class=\"token function\">Merge</span><span class=\"token punctuation\">(</span>ds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// if there is &lt;resultset morerecods=\"1\"> in response</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ds<span class=\"token punctuation\">.</span>Tables<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Rows<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"morerecords\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">)</span> finished <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">else</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\ngrid<span class=\"token punctuation\">.</span>DataSource <span class=\"token operator\">=</span> dsAll<span class=\"token punctuation\">.</span>Tables<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\ngrid<span class=\"token punctuation\">.</span><span class=\"token function\">DataBind</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>"}},"pageContext":{"id":"dbcb9296-f355-5e84-b956-40d175331869"}},"staticQueryHashes":[],"slicesMap":{}}