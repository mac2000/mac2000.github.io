{"componentChunkName":"component---src-templates-note-js","path":"/google-federated-github-actions/","result":{"data":{"remark":{"fields":{"path":"google-federated-github-actions"},"meta":{"title":""},"headings":[{"value":"Access Google API from within Github Actions using federated credentials"}],"html":"<h1>Access Google API from within Github Actions using federated credentials</h1>\n<p>Goal: in my case i need to talk to search console api from within github actions, and i wish to not store secrets nor deal with service account json credentials</p>\n<h2>How it works</h2>\n<ul>\n<li>Github Actions issues an OIDC token (not secret)</li>\n<li>Google Cloud trusts Github as identity provider</li>\n<li>Google exchanges OIDC from github for short lived access token</li>\n<li>We can call search console api with exchanged token</li>\n</ul>\n<h2>Prerequisites</h2>\n<p><strong>Enable API</strong></p>\n<p><strong>IAM Service Account Credentials API</strong></p>\n<p><code class=\"language-text\">iamcredentials.googleapis.com</code></p>\n<blockquote>\n<p>Service Account Credentials API allows developers to create short-lived, limited-privilege credentials for their service accounts on GCP.</p>\n</blockquote>\n<p>This one will be used to create access tokens that we will use in our github action to access search console api</p>\n<p><strong>Security Token Service API</strong></p>\n<p><code class=\"language-text\">sts.googleapis.com</code></p>\n<blockquote>\n<p>The Security Token Service exchanges Google or third-party credentials for a short-lived access token to Google Cloud resources.</p>\n</blockquote>\n<p>This one is used to exchange github oidc token to so called federated token, which we will exchange one more time using iam service account credentials</p>\n<p><strong>Google Search Console API</strong></p>\n<p><code class=\"language-text\">searchconsole.googleapis.com</code></p>\n<blockquote>\n<p>The Search Console API provides access to both Search Console data (verified users only) and to public information on an URL basis (anyone)</p>\n</blockquote>\n<p>this one is the target api we wish to use, here we may want to enable any other api</p>\n<h2>Service Account</h2>\n<p>We still need to create an service account - the key difference is that we do not need its credentials json anymore - we will exchange github oidc token for this account access token instead.</p>\n<p>Do not forget to give desired roles for service account so once exchanged, access token will have required privileges running requests on behalf service account</p>\n<blockquote>\n<p>Note: search console api does not have roles and works little bit different, from within search console we need to add service account email to our site and give it required privileges because there is nothing about that in google cloud console.</p>\n<p>You can add users here: <code class=\"language-text\">https://search.google.com/search-console/users</code></p>\n<p>So in my case i have added email of created service account with restricted privileges which should be enough to read data</p>\n</blockquote>\n<h2>Workload Identity Pool</h2>\n<p>From <strong>IAM &#x26; Admin</strong> menu navigate to <strong>Workload Identity Federation</strong> or from search bar search for \"Workload Identity Pool\"</p>\n<p>Here are notes from its getting started page</p>\n<p>Workload Identity allows your workloads to access Google Cloud without Service Account keys. There are 4 steps to setting up a workload identity:</p>\n<ol>\n<li><strong>Create a workload identity pool</strong>: The pool organizes and manages external identities. IAM lets you grant access to identities in the pool.</li>\n<li><strong>Connect an identity provider</strong>: Add either AWS or OpenID Connect (OIDC) providers to your pool.</li>\n<li><strong>Configure provider mapping</strong>: Set attributes and claims from providers to show up in IAM.</li>\n<li><strong>Grant access</strong>: Use a service account to allow pool identities to access resources in Google Cloud.</li>\n</ol>\n<p>Once proceeded to pool creation give it some name, like \"github\"</p>\n<p>As provider choose \"OpenID Connect (OIDC)\"</p>\n<p>and for provider detail fill following:</p>\n<ul>\n<li>Provider name: <code class=\"language-text\">github</code></li>\n<li>Issuer (URL): <code class=\"language-text\">https://token.actions.githubusercontent.com</code></li>\n<li>Audiences: <code class=\"language-text\">Default audience</code></li>\n</ul>\n<p>On next step, wizard will ask you to configure mappings, so it know what to expect from github oidc token and how to map its claims.</p>\n<p>At least <strong>sub</strong>ject claim is required - so we need to pass it.</p>\n<p>Also, from my experiments it seems like we really need to have <code class=\"language-text\">repository</code> and probably <code class=\"language-text\">ref</code> maps, so just in case, following docs i configured all of them like so</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/df57422353a323395cb5c1d9acc2785f/ce0a7/mapping.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.265625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABz0lEQVR42pVU2ZLbIBD0//9jktq1ZaELgcQhoaMzPfbmabVVoYoCMabpnp7xbZ4D/BQwxwzvPfphQN/3aJoWIUbknBFC0H1KCbPs87Igyj7GpGtKWeOLnN94YS0bxikKiMH9/sA4juBDx3Hgf8dtWVds+wZjajyfNaqqgnNOmUV5lVMZvufX97qWC0ChuW2byJ1U5iCSjTEC/pTvBm3b6uSej5rW4qMJ6NzyPSClEVBzKaBJc5KUYc6LsIkSm99nEaWsmqLzPL8HTHKRubKSt8ejghEmTftiynT4acI0zTqtjxhl0oBLQEpmcJKLz9roStf2tyEE5CNtP+KzmdH5IrHz2hQaQMlkyBy2XQcn5UOJBJuFGX/jvBiVZhx7UVMuGfYuisuH1uBdJPf9IGXjFJCDbBmzLuDRJdQ2SyrKNcNfjby4nEgxwNoRX67v+/6PeSXlNEhsChlpKXp+yZAO8jKBmD/tCDGKzIq4uSyruv2q11O6pGiHXLucXsFhsPj950NX5owPcFB+XddoOok/HYxIZoouJVNSKUXZsYdXYcIHCEj2rEPnvJ5zHNJVOf/AkAXMIC99Sh+3bad/EJTOwVaz1qK3XkwJMKMU/A+m/AULZT+T9UpTfQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mappings\"\n        title=\"\"\n        src=\"/static/df57422353a323395cb5c1d9acc2785f/2bef9/mapping.png\"\n        srcset=\"/static/df57422353a323395cb5c1d9acc2785f/6f3f2/mapping.png 256w,\n/static/df57422353a323395cb5c1d9acc2785f/01e7c/mapping.png 512w,\n/static/df57422353a323395cb5c1d9acc2785f/2bef9/mapping.png 1024w,\n/static/df57422353a323395cb5c1d9acc2785f/71c1d/mapping.png 1536w,\n/static/df57422353a323395cb5c1d9acc2785f/ce0a7/mapping.png 1590w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Also, you need to configure conditions - e.g. restrict access, i did it like so</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8bec7e60ac767986ff2e87a5f1936248/dca52/conditions.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.95312500000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB2UlEQVR42p1Uba7bIBD0OXuynqbHaH9VSaVnx8bY2HzagJnukjy9vtZRpSCNIGFZZnYHN8uqsawW2jiaV0g5VYxSwnuPEAKccxWBfjtnsW0bzR7GWNi652EtzbTfcGBMBT5EDMMAIUYopTDPM47jqEg5EQ7EXLBT7HEUPBuNJwalFAxCoOt6zJSMmaaUaoBSC/q+x01M+Pk2o5UOW8ygQ/Xc32j2fafbMyZixIgx1o1AsgzJYFnMmON4lJLxTuKUIR9gWVy3tu0gp4nkqlob/p/nZVkwrwZCBYxLoIQbp36S0Np6m7Ge5OraHO8/GDAzjtG0LxcP7TPK8xKi2ei2TAVXLqNfMjqV4PYDr46Gi87SNKkQmqSb4xODj4Ljjv8lXLWuTeFasVSWzI15meEvecCFhOv1Qk1pcblcMI5jNbUxpoK9aqmO9/kOXp91upkWS8bO1dTsN0F+HEeJ2+1WL+iGCdfB4k1omEdi8wCX6l9jE5NMJmavSXpuK1lE67Uy07RWZCNNz7N8qmehRubzhOw53sxph3YRs4lY7VaZ2Aej9zXXtsYSeH2akIMTvdEfbUA7c7IIv98PxJjqE+Q1+5ET/MnytCklEyub8eWrwLfvFoi2fghe7fJvoIKSfh18zc0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"conditions\"\n        title=\"\"\n        src=\"/static/8bec7e60ac767986ff2e87a5f1936248/2bef9/conditions.png\"\n        srcset=\"/static/8bec7e60ac767986ff2e87a5f1936248/6f3f2/conditions.png 256w,\n/static/8bec7e60ac767986ff2e87a5f1936248/01e7c/conditions.png 512w,\n/static/8bec7e60ac767986ff2e87a5f1936248/2bef9/conditions.png 1024w,\n/static/8bec7e60ac767986ff2e87a5f1936248/71c1d/conditions.png 1536w,\n/static/8bec7e60ac767986ff2e87a5f1936248/dca52/conditions.png 1550w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>What is important, in my case i did:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">assertion.repository_owner=='marchenko1985'</code></pre></div>\n<p>which is kind of widest range, you may want, for example, to restrict it to concrete repository like so</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">assertion.repository=='marchenko1985/some_repo'</code></pre></div>\n<p>You may want to configure even more strict rules here - aka allow only concrete repositories or actions from main branches and so on.</p>\n<p><a href=\"https://docs.cloud.google.com/iam/docs/workload-identity-federation-with-deployment-pipelines#github-actions_2\">Configure Workload Identity Federation with deployment pipelines</a> has more details on how to configure everything.</p>\n<p>Technically via this wizard we have created identity pool as well as identity provider attached to it.</p>\n<p>Also, when we choose Default audience, wizard did give us url like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/providers/github</code></pre></div>\n<p>where</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://iam.googleapis.com/projects/&lt;PROJECT_ID>/locations/global/workloadIdentityPools/&lt;POOL_NAME>/providers/&lt;PROVIDER_NAME></code></pre></div>\n<p>keep this, we will need it later in github actions</p>\n<h2>Allow impersonation</h2>\n<p>This step is required and without it nothing will work</p>\n<p>We need to give very specific role for our service account</p>\n<p>So navigate to it, and under \"Principals with access\"</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/17e08c3e4139c7c94d817da8e584374e/ddc6c/grant.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABxUlEQVR42q2T2W6dMBCGef+X6lVVVeqmtM1NDuthOewYsA025u/YJDSqEqWVOtan8djiZ2YYvLbt0PcDOOcYpwnDwBwzxYwxYgQbGeqmQdt1aFmHbuzBV4FhZlBGw9hlDjy5KAgFjOOIsiyJCnVdY993hzHkceyd1eRz8jeioH1BviTMce2tSpHYjGVZIIRA1/fkJZTS7ky5+8llIQYB/dmgCjekDwrFRaOINeRX415kl6e1duVarOBEZVs/u1i682meIaQAn6gNnzjaO43h3mD4adDfbxB3JDg/E2zbFklyRZZlyPIceVEgzXKUVY00TZHnheNGLcnSDJJx7CuJaPzm0Txbku2d7wcIfB9xHBORI4pCFweBTy9M3D6KIjxcLqioz9bO3j4J2gxzysYK+iE9EKeOMLoiCBNESYpLEDtvz67XjD5aAyklXrKzh3ZUmlGjIkpGDJT58BjbPTvOxbrZvPCaeUKuZ7A/4y37s9RTsJu3U+x/mKe0gtQ7lbahmTbcyNvYziDnAuu6/pvgtmh0Hw2i9yuSDwr5OxrUhmZrOWbTNv/pr/kbnODyDeDfd4gfO9QXKn/coXeNbdscr/XrpQx/AR857vPxvIbiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grant\"\n        title=\"\"\n        src=\"/static/17e08c3e4139c7c94d817da8e584374e/2bef9/grant.png\"\n        srcset=\"/static/17e08c3e4139c7c94d817da8e584374e/6f3f2/grant.png 256w,\n/static/17e08c3e4139c7c94d817da8e584374e/01e7c/grant.png 512w,\n/static/17e08c3e4139c7c94d817da8e584374e/2bef9/grant.png 1024w,\n/static/17e08c3e4139c7c94d817da8e584374e/ddc6c/grant.png 1534w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>grant access to</p>\n<p><code class=\"language-text\">principalSet://iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/attribute.repository_owner/marchenko1985</code> principal, and for role choose <code class=\"language-text\">Workload Identity User</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dc57a3af8688119107c66b6a9d96b37a/7e21b/access.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.203125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABOUlEQVR42q1SW26DMBDk/jfoby/Sr14jDSFEJRAwNsZPPNk1SZWqUpqotTQabLyzsyMXXXdC3/cQQoC/27ZD0xwRY0RK6SHcrkJrDWttFgghZCzLgmcW13rvc12x2XyQqxZKTRjECDVNGMcREzGfMWdQ4+teKZVZEhtj8nTbbZlFCxZQuWgtUBdmpzwOd/0C7dnNLfic7xpj15H3dU2ZNdAklOhnjOvY3M05woWv+9/iKLZliaqqUNcHVJ9k/TCg63lkRU7lypPMMTDY1V1BzsJYg5my0DbAhgRPDkc5oR0UiUuchMqXnXPZ6V3Bstyh3O1Q7ff0bDrMFL5zFtoEHIVDO3qCo/weFBzkDEGYZipa0tNP5oegiwnSrPDx+yNNN3hY8PVdQugI4xekhD+v4uVNohEhi/6H4BngWKxFaIXVlgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"access\"\n        title=\"\"\n        src=\"/static/dc57a3af8688119107c66b6a9d96b37a/2bef9/access.png\"\n        srcset=\"/static/dc57a3af8688119107c66b6a9d96b37a/6f3f2/access.png 256w,\n/static/dc57a3af8688119107c66b6a9d96b37a/01e7c/access.png 512w,\n/static/dc57a3af8688119107c66b6a9d96b37a/2bef9/access.png 1024w,\n/static/dc57a3af8688119107c66b6a9d96b37a/71c1d/access.png 1536w,\n/static/dc57a3af8688119107c66b6a9d96b37a/7e21b/access.png 1626w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>Note: if you choose repo, principal will be different, do read manuals mentioned above</p>\n</blockquote>\n<h2>Github Actions</h2>\n<p>Now we need to allow our service account to be called on behalf of github oidc token but while we did not saw this tokens we can not do it so proceding to github actions side let's have some simple action just to verify if everything working</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> google\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># contents: read # at moment we do not need to read repo contents</span>\n  <span class=\"token key atrule\">id-token</span><span class=\"token punctuation\">:</span> write <span class=\"token comment\"># but we want to play with OIDC tokens</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">google</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># - uses: actions/checkout@v6 # at moment we do not need to checkout repo contents</span>\n\n      <span class=\"token comment\"># OpenID Connect</span>\n      <span class=\"token comment\"># OpenID Connect allows your workflows to exchange short-lived tokens directly from your cloud provider.</span>\n      <span class=\"token comment\"># https://docs.github.com/en/actions/concepts/security/openid-connect</span>\n\n      <span class=\"token comment\"># Methods for requesting the OIDC token</span>\n      <span class=\"token comment\"># https://docs.github.com/en/actions/reference/security/oidc#methods-for-requesting-the-oidc-token</span>\n      <span class=\"token comment\"># states that there will be two environment variables available</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ACTIONS_ID_TOKEN_REQUEST_URL\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          echo \"ACTIONS_ID_TOKEN_REQUEST_URL: $ACTIONS_ID_TOKEN_REQUEST_URL\"</span>\n        <span class=\"token comment\"># ACTIONS_ID_TOKEN_REQUEST_URL: https://run-actions-2-azure-eastus.actions.githubusercontent.com/152//idtoken/6a5e4506-885f-4c7b-a4cf-70f6e241634b/d78f7636-37d2-56e6-a557-10cab26cfb09?api-version=2.0</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ACTIONS_ID_TOKEN_REQUEST_TOKEN\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          echo \"ACTIONS_ID_TOKEN_REQUEST_TOKEN: $ACTIONS_ID_TOKEN_REQUEST_TOKEN\"</span>\n        <span class=\"token comment\"># ACTIONS_ID_TOKEN_REQUEST_TOKEN: xxx</span>\n\n      <span class=\"token comment\"># which may be used to retrieve the OIDC token like so</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> retrieve OIDC token\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          curl -H \"Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \"$ACTIONS_ID_TOKEN_REQUEST_URL\"</span>\n        <span class=\"token comment\"># {\"value\":\"***\"}</span></code></pre></div>\n<p>This one did not give us to much because of github actions logs are trying to hide sensitive data from us</p>\n<p>For us to get it we will use hack with hex</p>\n<p>Here is how it works</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"Hello World\"</span> <span class=\"token operator\">|</span> xxd <span class=\"token parameter variable\">-p</span></code></pre></div>\n<p>will produce <code class=\"language-text\">48656c6c6f20576f726c64</code></p>\n<p>and to decode it back</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"48656c6c6f20576f726c64\"</span> <span class=\"token operator\">|</span> xxd <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-p</span></code></pre></div>\n<p>So here is alternative yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> google\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># contents: read # at moment we do not need to read repo contents</span>\n  <span class=\"token key atrule\">id-token</span><span class=\"token punctuation\">:</span> write <span class=\"token comment\"># but we want to play with OIDC tokens</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">google</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># - uses: actions/checkout@v6 # at moment we do not need to checkout repo contents</span>\n\n      <span class=\"token comment\"># OpenID Connect</span>\n      <span class=\"token comment\"># OpenID Connect allows your workflows to exchange short-lived tokens directly from your cloud provider.</span>\n      <span class=\"token comment\"># https://docs.github.com/en/actions/concepts/security/openid-connect</span>\n\n      <span class=\"token comment\"># Methods for requesting the OIDC token</span>\n      <span class=\"token comment\"># https://docs.github.com/en/actions/reference/security/oidc#methods-for-requesting-the-oidc-token</span>\n      <span class=\"token comment\"># states that there will be two environment variables available</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ACTIONS_ID_TOKEN_REQUEST_URL\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          echo \"ACTIONS_ID_TOKEN_REQUEST_URL: $ACTIONS_ID_TOKEN_REQUEST_URL\"</span>\n        <span class=\"token comment\"># ACTIONS_ID_TOKEN_REQUEST_URL: https://run-actions-2-azure-eastus.actions.githubusercontent.com/152//idtoken/6a5e4506-885f-4c7b-a4cf-70f6e241634b/d78f7636-37d2-56e6-a557-10cab26cfb09?api-version=2.0</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ACTIONS_ID_TOKEN_REQUEST_TOKEN\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          echo \"ACTIONS_ID_TOKEN_REQUEST_TOKEN: $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" | xxd -p</span>\n\n      <span class=\"token comment\"># which may be used to retrieve the OIDC token like so</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> retrieve OIDC token\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          curl -s -H \"Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \"$ACTIONS_ID_TOKEN_REQUEST_URL&amp;audience=HelloWorld\" | jq -r .value | xxd -p</span>\n\n      <span class=\"token comment\"># and here is how can we retrieve token using getIDToken</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> getIDToken\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/github<span class=\"token punctuation\">-</span>script@v8\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            core.getIDToken('HelloWorld').then(token => {\n              // console.log(token) // will output: xxx\n              // trick with hex output\n              console.log(Buffer.from(token, 'utf8').toString('hex'))\n            })</span></code></pre></div>\n<p>Note how we did encode both values with <code class=\"language-text\">xxd</code> so we can get it from logs</p>\n<p>so inside <code class=\"language-text\">ACTIONS_ID_TOKEN_REQUEST_TOKEN</code> we have following:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"IdentityTypeClaim\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"System:ServiceIdentity\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ac\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"[{\\\"Scope\\\":\\\"refs/heads/main\\\",\\\"Permission\\\":3}]\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"acsl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"10\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HelloWorld\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"billing_owner_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1766242035</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"http://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dddddddd-dddd-dddd-dddd-dddddddddddd\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dddddddd-dddd-dddd-dddd-dddddddddddd\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1766219835</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://token.actions.githubusercontent.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"job_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1dceee7c-eee3-5898-b4a3-e349255ee79b\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nameid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dddddddd-dddd-dddd-dddd-dddddddddddd\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nbf\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1766219535</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"oidc_extra\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{\\\"actor\\\":\\\"marchenko1985\\\",\\\"actor_id\\\":\\\"88868\\\",...}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"oidc_sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"repo:marchenko1985/marchenko1985:ref:refs/heads/main\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"orch_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"owner_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"plan_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"repository_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"352284565\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"run_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"20391870713\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"run_number\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"run_type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"full\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"runner_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1000000363\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"runner_type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hosted\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sha\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"trust_tier\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>which is interesting, there is nothing very special, it is used to identify us, when we are asking for oidc token</p>\n<p>second curl call output is our OIDC token which we will pass to Google to exchange it for google service account access token</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"actor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"marchenko1985\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"actor_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"88868\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://github.com/marchenko1985\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"base_ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"check_run_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"58602234763\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"event_name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"workflow_dispatch\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1766220137</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"head_ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1766219837</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://token.actions.githubusercontent.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"job_workflow_ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"marchenko1985/marchenko1985/.github/workflows/google.yml@refs/heads/main\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"job_workflow_sha\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"9d1c0030434f78ae61041cb49166386c21b1124f\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"jti\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6b4848f3-b246-4968-9638-c4e9e20611e8\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nbf\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1766219537</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"refs/heads/main\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ref_protected\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"false\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ref_type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"branch\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"repository\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"marchenko1985/marchenko1985\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"repository_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"352284565\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"repository_owner\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"marchenko1985\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"repository_owner_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"88868\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"repository_visibility\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"run_attempt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"run_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"20391870713\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"run_number\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"runner_environment\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"github-hosted\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sha\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"9d1c0030434f78ae61041cb49166386c21b1124f\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"repo:marchenko1985/marchenko1985:ref:refs/heads/main\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"workflow\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"google\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"workflow_ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"marchenko1985/marchenko1985/.github/workflows/google.yml@refs/heads/main\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"workflow_sha\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"9d1c0030434f78ae61041cb49166386c21b1124f\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note: in both cases we are dealing with usual JWT, there is nothing secret in tokens them selves, the key is their signature and ability to verify it in github</p>\n<p>github has public endpoint for oidc which we can find in token itself <code class=\"language-text\">iss</code> claim - <code class=\"language-text\">https://token.actions.githubusercontent.com</code></p>\n<p>and because it is an oidc it has <code class=\"language-text\">/.well-known/openid-configuration</code> endpoint so we can access it <code class=\"language-text\">https://token.actions.githubusercontent.com/.well-known/openid-configuration</code> which is quite interesting, it indeed has jwks configured (aka async encryption with public and private keys) but it miss token or verify endpoints but we do not need them, google from its side will read jwks configuration and public key with corresponding jit from token to verify token signature</p>\n<p>Also note how <code class=\"language-text\">aud</code> is set, if you pass it, it will be set like <code class=\"language-text\">HelloWorld</code> in getIDToken example, if not - then it will default to <code class=\"language-text\">https://github.com/marchenko1985</code></p>\n<p>BUT, it is important to set it to one Google is expecting - aka <code class=\"language-text\">//iam.googleapis.com/projects/&lt;PROJECT_NUMBER>/locations/global/workloadIdentityPools/&lt;POOL_NAME>/providers/&lt;PROVIDER_NAME></code> so in my case it is <code class=\"language-text\">//iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/providers/github</code></p>\n<h2>Exchange tokens</h2>\n<p>There are ready to use github actions that will make things easier, but before proceeding to them, let's give it a try and exchange tokens manually</p>\n<p>Technically it will be something like this:</p>\n<p><strong>Step 1: Retrieve Github OIDC token</strong></p>\n<p>This one we already did in previous examples</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">token</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: bearer <span class=\"token variable\">$ACTIONS_ID_TOKEN_REQUEST_TOKEN</span>\"</span> <span class=\"token string\">\"<span class=\"token variable\">$ACTIONS_ID_TOKEN_REQUEST_URL</span>&amp;audience=//iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/providers/github\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> .value<span class=\"token variable\">)</span></span></code></pre></div>\n<p>Note: how we did add <code class=\"language-text\">&amp;audience=//iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/providers/github</code> we need this, so signed token will have corresponding audience, which will tell google that indeed by intent this token were generated to be sent to sts.googleapis.com later on.</p>\n<p>Otherwise default audience will be set to <code class=\"language-text\">https://github.com/marchenko1985</code> and our attempt to call STS will fail with error:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"error\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"invalid_grant\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"error_description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The audience in ID Token [https://github.com/marchenko1985] does not match the expected audience.\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Step 2: Exchange GitHub OIDC â†’ Google federated token (STS)</strong></p>\n<p>This is the RFC 8693 token exchange call.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">sts</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> POST https://sts.googleapis.com/v1/token <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{\n  <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>grant_type<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>urn:ietf:params:oauth:grant-type:token-exchange<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,\n  <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>audience<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>//iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/providers/github<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,\n  <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>scope<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>https://www.googleapis.com/auth/cloud-platform<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,\n  <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>requested_token_type<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>urn:ietf:params:oauth:token-type:access_token<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,\n  <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>subject_token_type<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>urn:ietf:params:oauth:token-type:jwt<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,\n  <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>subject_token<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$token</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>\n}\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> .access_token<span class=\"token variable\">)</span></span></code></pre></div>\n<p>This token:</p>\n<ul>\n<li>Is short-lived (1 hour)</li>\n<li>Represents \"GitHub Actions identity\"</li>\n<li>Is NOT yet your service account</li>\n<li>In Google access tokens are not JWT so we won't be able to see what's inside</li>\n</ul>\n<p>More details can be found <a href=\"https://docs.cloud.google.com/iam/docs/reference/sts/rest/v1/TopLevel/token#request-body\">here</a></p>\n<p>Notes on payload</p>\n<ul>\n<li><code class=\"language-text\">grant_type=urn:ietf:params:oauth:grant-type:token-exchange</code> - note this unusual grant type, this one comes from RFC 8693 which allows to exchange token from one provider to another</li>\n<li><code class=\"language-text\">audience</code> audience should be exactly our configured pool provider - think of this - we are asking github to sign oidc token for us, and telling that this token will be passed to concrete this audience, then we are sending this token to google and he not only verifies that token is signed correctly but also that it was intentionally signed to be passed to concrete this audience - aka few layers of security checks</li>\n<li><code class=\"language-text\">scope=https://www.googleapis.com/auth/cloud-platform</code> - google specific, should be set exactly to this, here are not yet dealing with desired search console api, but rather with STS and we need scope for it</li>\n<li><code class=\"language-text\">requested_token_type=urn:ietf:params:oauth:token-type:access_token</code> as you may guess we are saying that we are requesting access token</li>\n<li><code class=\"language-text\">subject_token_type=urn:ietf:params:oauth:token-type:jwt</code> - here we are saying that instead of user credentials we will pass jwt token</li>\n<li><code class=\"language-text\">subject_token=$token</code> - and here we are passing github token</li>\n</ul>\n<blockquote>\n<p>Under the hood: from given <code class=\"language-text\">$token</code> google will see issuer, from its well known endpoint will find jwks endpoins, and public key for jit and will be able to verify if token is valid or not, and also check mentioned audiences</p>\n</blockquote>\n<p><strong>Step 3: Impersonate the Service Account</strong></p>\n<p>Now we call IAM Credentials API using the federated token.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">access_token</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token string\">\"https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/marchenko1985@marchenko1985.iam.gserviceaccount.com:generateAccessToken\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$sts</span>\"</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Content-Type: application/json\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'{\n  \"scope\": [\"https://www.googleapis.com/auth/webmasters.readonly\"]\n}'</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> .accessToken<span class=\"token variable\">)</span></span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>url is fomder like this: <code class=\"language-text\">https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/&lt;SERVICE_ACCOUNT_EMAIL>:generateAccessToken</code></li>\n</ul>\n<p><strong>Step 4: Calling search console api</strong></p>\n<p>and finally we can call our search console api to see if it is working like so</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$access_token</span>\"</span> https://searchconsole.googleapis.com/webmasters/v3/sites</code></pre></div>\n<p>and if everything is ok we will receive something like</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"siteEntry\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"siteUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://marchenko1985.github.io/\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"permissionLevel\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"siteRestrictedUser\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Once again remember that for concrete search console api you need to add your service account email as a user from withing google webmaster tools, it has no equivalent in google cloud console</p>\n</blockquote>\n<h2>Verifiying if everything was configured correctly</h2>\n<p>Here are few commands that may be useful to check if everything is configured correctly</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">PROJECT_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"marchenko1985\"</span>\n<span class=\"token assign-left variable\">PROJECT_NUMBER</span><span class=\"token operator\">=</span><span class=\"token string\">\"348636136344\"</span>\n<span class=\"token assign-left variable\">POOL_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"github\"</span>\n<span class=\"token assign-left variable\">PROVIDER_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"github\"</span>\n<span class=\"token assign-left variable\">SA_EMAIL</span><span class=\"token operator\">=</span><span class=\"token string\">\"marchenko1985@marchenko1985.iam.gserviceaccount.com\"</span>\n<span class=\"token assign-left variable\">REPO</span><span class=\"token operator\">=</span><span class=\"token string\">\"marchenko1985/marchenko1985\"</span></code></pre></div>\n<p>Confirm workload identity pool exists</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud iam workload-identity-pools describe <span class=\"token string\">\"<span class=\"token variable\">$POOL_ID</span>\"</span> <span class=\"token parameter variable\">--project</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$PROJECT_ID</span>\"</span> <span class=\"token parameter variable\">--location</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span></code></pre></div>\n<p>should output something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">displayName</span><span class=\"token punctuation\">:</span> github\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> projects/348636136344/locations/global/workloadIdentityPools/github\n<span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> ACTIVE</code></pre></div>\n<p>confirm provider exists</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud iam workload-identity-pools providers describe <span class=\"token string\">\"<span class=\"token variable\">$PROVIDER_ID</span>\"</span> <span class=\"token parameter variable\">--project</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$PROJECT_ID</span>\"</span> <span class=\"token parameter variable\">--location</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> --workload-identity-pool<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$POOL_ID</span>\"</span></code></pre></div>\n<p>should output</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">attributeCondition</span><span class=\"token punctuation\">:</span> assertion.repository_owner=='marchenko1985'\n<span class=\"token key atrule\">attributeMapping</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">attribute.ref</span><span class=\"token punctuation\">:</span> assertion.ref\n  <span class=\"token key atrule\">attribute.repository</span><span class=\"token punctuation\">:</span> assertion.repository\n  <span class=\"token key atrule\">attribute.repository_owner</span><span class=\"token punctuation\">:</span> assertion.repository_owner\n  <span class=\"token key atrule\">google.subject</span><span class=\"token punctuation\">:</span> assertion.sub\n<span class=\"token key atrule\">displayName</span><span class=\"token punctuation\">:</span> github\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> projects/348636136344/locations/global/workloadIdentityPools/github/providers/github\n<span class=\"token key atrule\">oidc</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">issuerUri</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//token.actions.githubusercontent.com\n<span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> ACTIVE</code></pre></div>\n<p>here we should check:</p>\n<ol>\n<li><code class=\"language-text\">issuerUri</code> is <code class=\"language-text\">https://token.actions.githubusercontent.com</code></li>\n<li><code class=\"language-text\">attributeMapping</code> contains <code class=\"language-text\">google.subject</code>, <code class=\"language-text\">attribute.repository</code> and <code class=\"language-text\">attribute.ref</code> - seems like that is required minimum, in our case, i wanted wider access so also added <code class=\"language-text\">repository_owner</code></li>\n<li><code class=\"language-text\">attributeCondition</code> is set, and is using attributes that appear in <code class=\"language-text\">attributeMapping</code></li>\n</ol>\n<p><strong>Verify Service Account IAM binding</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gcloud iam service-accounts get-iam-policy <span class=\"token string\">\"<span class=\"token variable\">$SA_EMAIL</span>\"</span> <span class=\"token parameter variable\">--project</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$PROJECT_ID</span>\"</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">bindings</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">members</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> principalSet<span class=\"token punctuation\">:</span>//iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/attribute.repository_owner/marchenko1985\n    <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> roles/iam.workloadIdentityUser\n<span class=\"token key atrule\">etag</span><span class=\"token punctuation\">:</span> BwZGYg5Oj3U=\n<span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></code></pre></div>\n<p>this one checks that we have granted access, make sure to be correct with attributes, like in my case, i wanted wirder access, that's why i have this <code class=\"language-text\">attribute.repository_owner/marchenko1985</code> at the end</p>\n<p>And if everything configured correctly following sample github action should work</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> google\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">id-token</span><span class=\"token punctuation\">:</span> write\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">google</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          # github token\n          token=$(curl -s -H \"Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\" \"$ACTIONS_ID_TOKEN_REQUEST_URL&amp;audience=//iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/providers/github\" | jq -r .value)</span>\n\n          <span class=\"token comment\"># federated token (RFC 8693 token exchange call to Google STS)</span>\n          <span class=\"token key atrule\">sts=$(curl -s -X POST https://sts.googleapis.com/v1/token -H \"Content-Type</span><span class=\"token punctuation\">:</span> application/json\" <span class=\"token punctuation\">-</span>d \"<span class=\"token punctuation\">{</span>\n            <span class=\"token key atrule\">\\\"grant_type\\\"</span><span class=\"token punctuation\">:</span> \\\"urn<span class=\"token punctuation\">:</span>ietf<span class=\"token punctuation\">:</span>params<span class=\"token punctuation\">:</span>oauth<span class=\"token punctuation\">:</span>grant<span class=\"token punctuation\">-</span>type<span class=\"token punctuation\">:</span>token<span class=\"token punctuation\">-</span>exchange\\\"<span class=\"token punctuation\">,</span>\n            <span class=\"token key atrule\">\\\"audience\\\"</span><span class=\"token punctuation\">:</span> \\\"//iam.googleapis.com/projects/348636136344/locations/global/workloadIdentityPools/github/providers/github\\\"<span class=\"token punctuation\">,</span>\n            <span class=\"token key atrule\">\\\"scope\\\"</span><span class=\"token punctuation\">:</span> \\\"https<span class=\"token punctuation\">:</span>//www.googleapis.com/auth/cloud<span class=\"token punctuation\">-</span>platform\\\"<span class=\"token punctuation\">,</span>\n            <span class=\"token key atrule\">\\\"requested_token_type\\\"</span><span class=\"token punctuation\">:</span> \\\"urn<span class=\"token punctuation\">:</span>ietf<span class=\"token punctuation\">:</span>params<span class=\"token punctuation\">:</span>oauth<span class=\"token punctuation\">:</span>token<span class=\"token punctuation\">-</span>type<span class=\"token punctuation\">:</span>access_token\\\"<span class=\"token punctuation\">,</span>\n            <span class=\"token key atrule\">\\\"subject_token_type\\\"</span><span class=\"token punctuation\">:</span> \\\"urn<span class=\"token punctuation\">:</span>ietf<span class=\"token punctuation\">:</span>params<span class=\"token punctuation\">:</span>oauth<span class=\"token punctuation\">:</span>token<span class=\"token punctuation\">-</span>type<span class=\"token punctuation\">:</span>jwt\\\"<span class=\"token punctuation\">,</span>\n            <span class=\"token key atrule\">\\\"subject_token\\\"</span><span class=\"token punctuation\">:</span> \\\"$token\\\"\n          <span class=\"token punctuation\">}</span>\" <span class=\"token punctuation\">|</span> jq <span class=\"token punctuation\">-</span>r .access_token)\n\n          <span class=\"token comment\"># service account access token</span>\n          <span class=\"token key atrule\">access_token=$(curl -s -X POST \"https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/marchenko1985@marchenko1985.iam.gserviceaccount.com:generateAccessToken\" -H \"Authorization</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">Bearer $sts\" -H \"Content-Type</span><span class=\"token punctuation\">:</span> application/json\" <span class=\"token punctuation\">-</span>d '<span class=\"token punctuation\">{</span>\n            <span class=\"token key atrule\">\"scope\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://www.googleapis.com/auth/webmasters.readonly\"</span><span class=\"token punctuation\">]</span>\n          <span class=\"token punctuation\">}</span>' <span class=\"token punctuation\">|</span> jq <span class=\"token punctuation\">-</span>r .accessToken)\n\n          <span class=\"token comment\"># call google search console api</span>\n          <span class=\"token key atrule\">curl -s -H \"Authorization</span><span class=\"token punctuation\">:</span> Bearer $access_token\" https<span class=\"token punctuation\">:</span>//searchconsole.googleapis.com/webmasters/v3/sites</code></pre></div>\n<p>and if everything correct you should see desired</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"siteEntry\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"siteUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://marchenko1985.github.io/\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"permissionLevel\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"siteRestrictedUser\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Github Actions</h2>\n<p>now, when we have low level understanding of what and how it works, it is time to see which github actions available to make it easier</p>\n<p>initially we may try something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> google\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">id-token</span><span class=\"token punctuation\">:</span> write\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">google</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> google<span class=\"token punctuation\">-</span>github<span class=\"token punctuation\">-</span>actions/auth@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">workload_identity_provider</span><span class=\"token punctuation\">:</span> projects/348636136344/locations/global/workloadIdentityPools/github/providers/github\n          <span class=\"token key atrule\">service_account</span><span class=\"token punctuation\">:</span> marchenko1985@marchenko1985.iam.gserviceaccount.com\n\n      <span class=\"token comment\"># here we are installing gcloud cli, so we can easily retrieve access token</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> google<span class=\"token punctuation\">-</span>github<span class=\"token punctuation\">-</span>actions/setup<span class=\"token punctuation\">-</span>gcloud@v3\n\n      <span class=\"token comment\"># for sake of demonstration, check that we are signed in</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gcloud auth list\n        <span class=\"token comment\"># ACTIVE  ACCOUNT</span>\n        <span class=\"token comment\"># *       marchenko1985@marchenko1985.iam.gserviceaccount.com</span>\n\n      <span class=\"token comment\"># example of how access token can be retrieved</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> gcloud auth print<span class=\"token punctuation\">-</span>access<span class=\"token punctuation\">-</span>token\n        <span class=\"token comment\"># ya29.c.....</span>\n\n      <span class=\"token comment\"># example of calling search console api</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Call Search Console API\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          curl -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \"https://searchconsole.googleapis.com/webmasters/v3/sites\"</span></code></pre></div>\n<p>but it will fail with error like</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"error\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"code\"</span><span class=\"token operator\">:</span> <span class=\"token number\">403</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Request had insufficient authentication scopes.\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"errors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Insufficient Permission\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"domain\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"global\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"reason\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"insufficientPermissions\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PERMISSION_DENIED\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"details\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"@type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"type.googleapis.com/google.rpc.ErrorInfo\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"reason\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ACCESS_TOKEN_SCOPE_INSUFFICIENT\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"domain\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"googleapis.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"metadata\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"method\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"google.searchconsole.v1.SitesService.List\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"service\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"searchconsole.googleapis.com\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>which is kind of obvious - we did not requested scopes</p>\n<p>more correct way will be to do it like so</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> google\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">id-token</span><span class=\"token punctuation\">:</span> write\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">google</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> google<span class=\"token punctuation\">-</span>github<span class=\"token punctuation\">-</span>actions/auth@v3\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> auth\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">workload_identity_provider</span><span class=\"token punctuation\">:</span> projects/348636136344/locations/global/workloadIdentityPools/github/providers/github\n          <span class=\"token key atrule\">service_account</span><span class=\"token punctuation\">:</span> marchenko1985@marchenko1985.iam.gserviceaccount.com\n          <span class=\"token key atrule\">token_format</span><span class=\"token punctuation\">:</span> access_token\n          <span class=\"token key atrule\">access_token_scopes</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//www.googleapis.com/auth/webmasters.readonly\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          curl -H \"Authorization: Bearer ${{ steps.auth.outputs.access_token }}\" \"https://searchconsole.googleapis.com/webmasters/v3/sites\"</span></code></pre></div>\n<p>which is technically our final results - with such setup we may exchange github oidc token to our service account access token that we may use in our github actions scripts - profit</p>\n<p>and the beauty of this approach is that we can reuse it accross different repositories and there is no need to store any secrets - and as result - nothing to hide, rotate, revoke - profit</p>"}},"pageContext":{"id":"0ebbb504-2a31-5e7d-b35c-6e43ddfd2164"}},"staticQueryHashes":[],"slicesMap":{}}