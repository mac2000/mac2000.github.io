{"componentChunkName":"component---src-templates-note-js","path":"/external-secrets-operator/","result":{"data":{"remark":{"fields":{"path":"external-secrets-operator"},"meta":{"title":""},"headings":[{"value":"External Secrets Operator"}],"html":"<h1>External Secrets Operator</h1>\n<p>Here is my attemp to have External Secrets Operator minimal possible setup</p>\n<p>We will deploy only wanted pieces</p>\n<p>So far, minimally required are following CRDS:</p>\n<ul>\n<li><a href=\"https://raw.githubusercontent.com/external-secrets/external-secrets/refs/tags/v0.11.0/config/crds/bases/external-secrets.io_secretstores.yaml\">secretstore</a> - holds credentials for keyvault</li>\n<li><a href=\"https://raw.githubusercontent.com/external-secrets/external-secrets/refs/tags/v0.11.0/config/crds/bases/external-secrets.io_externalsecrets.yaml\">externalsecret</a> - will produce kubernetes secrets filled with values from keyvault</li>\n</ul>\n<p>We gonna need to create secret that will hold keyvault credentials</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Secret\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> azure<span class=\"token punctuation\">-</span>secret<span class=\"token punctuation\">-</span>sp\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Opaque\n<span class=\"token key atrule\">stringData</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ClientID</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"00000000-0000-0000-0000-000000000000\"</span>\n  <span class=\"token key atrule\">ClientSecret</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"00000000-0000-0000-0000-000000000000\"</span> <span class=\"token comment\"># instead consider federated credentials</span></code></pre></div></p>\n<p>and SecretStore that will use this secret and connect to KeyVault</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>secrets.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> SecretStore\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> example\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">azurekv</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">tenantId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"00000000-0000-0000-0000-000000000000\"</span>\n      <span class=\"token key atrule\">vaultUrl</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://example.vault.azure.net\"</span>\n      <span class=\"token key atrule\">authSecretRef</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">clientId</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> azure<span class=\"token punctuation\">-</span>secret<span class=\"token punctuation\">-</span>sp\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> ClientID\n        <span class=\"token key atrule\">clientSecret</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> azure<span class=\"token punctuation\">-</span>secret<span class=\"token punctuation\">-</span>sp\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> ClientSecret</code></pre></div></p>\n<p>and finally secrets controller (we do not need everything elase, also note how we are disabling few things via arguments)</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>secrets\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>secrets\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">revisionHistoryLimit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>secrets\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>secrets\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>secrets\n      <span class=\"token key atrule\">automountServiceAccountToken</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> external<span class=\"token punctuation\">-</span>secrets\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> oci.external<span class=\"token punctuation\">-</span>secrets.io/external<span class=\"token punctuation\">-</span>secrets/external<span class=\"token punctuation\">-</span>secrets<span class=\"token punctuation\">:</span>v0.10.5\n          <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n          <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>enable<span class=\"token punctuation\">-</span>push<span class=\"token punctuation\">-</span>secret<span class=\"token punctuation\">-</span>reconciler=false\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>enable<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>store<span class=\"token punctuation\">-</span>reconciler=false\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>enable<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>external<span class=\"token punctuation\">-</span>secret<span class=\"token punctuation\">-</span>reconciler=false\n          <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> metrics\n              <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n              <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n          <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 10m\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 64Mi\n            <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 500m\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 128Mi\n          <span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">allowPrivilegeEscalation</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n            <span class=\"token key atrule\">capabilities</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">drop</span><span class=\"token punctuation\">:</span>\n                <span class=\"token punctuation\">-</span> ALL\n            <span class=\"token key atrule\">readOnlyRootFilesystem</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n            <span class=\"token key atrule\">runAsNonRoot</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n            <span class=\"token key atrule\">runAsUser</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\n            <span class=\"token key atrule\">seccompProfile</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RuntimeDefault</code></pre></div></p>\n<p>here is kustomization</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kustomize.config.k8s.io/v1beta1\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># crd: secretstore - holds credentials for keyvault</span>\n  <span class=\"token punctuation\">-</span> https<span class=\"token punctuation\">:</span>//raw.githubusercontent.com/external<span class=\"token punctuation\">-</span>secrets/external<span class=\"token punctuation\">-</span>secrets/refs/tags/v0.11.0/config/crds/bases/external<span class=\"token punctuation\">-</span>secrets.io_secretstores.yaml\n  <span class=\"token comment\"># crd: externalsecret - will produce kubernetes secrets filled with values from keyvault</span>\n  <span class=\"token punctuation\">-</span> https<span class=\"token punctuation\">:</span>//raw.githubusercontent.com/external<span class=\"token punctuation\">-</span>secrets/external<span class=\"token punctuation\">-</span>secrets/refs/tags/v0.11.0/config/crds/bases/external<span class=\"token punctuation\">-</span>secrets.io_externalsecrets.yaml\n  <span class=\"token comment\"># external secrets controller</span>\n  <span class=\"token punctuation\">-</span> service<span class=\"token punctuation\">-</span>account.yml\n  <span class=\"token punctuation\">-</span> cluster<span class=\"token punctuation\">-</span>role<span class=\"token punctuation\">-</span>binding.yml\n  <span class=\"token punctuation\">-</span> deployment.yml\n  <span class=\"token comment\"># azure key vault</span>\n  <span class=\"token punctuation\">-</span> secret.yml\n  <span class=\"token punctuation\">-</span> secret<span class=\"token punctuation\">-</span>store.yml\n  <span class=\"token comment\"># sync key vault secret into kubernetes secret</span>\n  <span class=\"token punctuation\">-</span> example.external<span class=\"token punctuation\">-</span>secret.yml</code></pre></div></p>\n<p>and its usage example:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kind create cluster\nkubectl <span class=\"token function\">wait</span> <span class=\"token parameter variable\">--for</span><span class=\"token operator\">=</span>condition<span class=\"token operator\">=</span>Ready <span class=\"token function\">node</span> <span class=\"token parameter variable\">--all</span> <span class=\"token parameter variable\">--timeout</span><span class=\"token operator\">=</span>90s\n\nkubectl apply <span class=\"token parameter variable\">-k</span> <span class=\"token builtin class-name\">.</span>\nkubectl rollout status deployment external-secrets <span class=\"token parameter variable\">--timeout</span><span class=\"token operator\">=</span>10m\n\nkubectl logs <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>external-secrets <span class=\"token parameter variable\">--tail</span><span class=\"token operator\">=</span><span class=\"token number\">5</span> <span class=\"token operator\">|</span> jq .msg\n\nkubectl get secrets secret-to-be-created\nkubectl get secrets secret-to-be-created <span class=\"token parameter variable\">-o</span> json <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">'.data[\"secret-key-to-be-managed\"]'</span> <span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">-d</span>\n<span class=\"token comment\"># should output: \"bar\"</span>\n\nkind delete cluster</code></pre></div></p>"}},"pageContext":{"id":"32a5a890-6a82-5004-b3ac-e666050f8cf1"}},"staticQueryHashes":[],"slicesMap":{}}