{"componentChunkName":"component---src-templates-note-js","path":"/esxi-automate-vm-creation","result":{"data":{"remark":{"fields":{"path":"esxi-automate-vm-creation"},"meta":{"title":""},"headings":[{"value":"ESXi Create VM from Shell"},{"value":"ESXi VMX"}],"html":"<h1>ESXi Create VM from Shell</h1>\n<p>At last have found how VM creation can be created from shell scripts</p>\n<p>Starting point - <a href=\"https://github.com/josenk/esxi-vm-create/blob/master/esxi-vm-create\">https://github.com/josenk/esxi-vm-create/blob/master/esxi-vm-create</a></p>\n<p>There is an <code class=\"language-text\">vim-cmd</code> which holds all we need</p>\n<p>Note: everything is done from within ESXi server</p>\n<p>Here are some basics:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># list virtual machines</span>\nvim-cmd vmsvc/getallvms\n\n<span class=\"token comment\"># get virtual machine by vmid</span>\nvim-cmd vmsvc/get.summary <span class=\"token number\">78</span>\n\n<span class=\"token comment\"># get power status (where 78 is vmid)</span>\nvim-cmd vmsvc/power.getstate <span class=\"token number\">78</span>\n\n<span class=\"token comment\"># power management (hard)</span>\nvim-cmd vmsvc/power.on <span class=\"token number\">78</span>\nvim-cmd vmsvc/power.off <span class=\"token number\">78</span>\nvim-cmd vmsvc/power.reset <span class=\"token number\">78</span>\n\n<span class=\"token comment\"># power management (soft, requires vm tools to be installed)</span>\nvim-cmd vmsvc/power.shutdown <span class=\"token number\">78</span>\nvim-cmd vmsvc/power.reboot <span class=\"token number\">78</span>\n\n<span class=\"token comment\"># delete virtual machine and its files</span>\nvim-cmd vmsvc/destroy <span class=\"token number\">78</span></code></pre></div>\n<p>Also there is a <a href=\"https://www.enterprisedaddy.com/2016/09/vim-cmd-with-virtual-machines/\">set of commands</a> around snapshots which also might be useful in some cases</p>\n<h1>ESXi VMX</h1>\n<p>From ESXi perspective virtual machine is an <code class=\"language-text\">vmx</code> file with its configuration and <code class=\"language-text\">vmdx</code> file with disk data</p>\n<p><code class=\"language-text\">vmx</code> is a <code class=\"language-text\">ini</code> like configuration file holding key value pairs, where values are always wrapped in double quotes</p>\n<p>If you create VM and remove from it all devices it will look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token key attr-name\">.encoding</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">UTF-8</span>\"</span>\n<span class=\"token key attr-name\">bios.bootRetry.delay</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">10</span>\"</span>\n<span class=\"token key attr-name\">config.version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">8</span>\"</span>\n<span class=\"token key attr-name\">displayName</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">test1</span>\"</span>\n<span class=\"token key attr-name\">firmware</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">efi</span>\"</span>\n<span class=\"token key attr-name\">floppy0.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">FALSE</span>\"</span>\n<span class=\"token key attr-name\">guestOS</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">other5xlinux-64</span>\"</span>\n<span class=\"token key attr-name\">hpet0.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">memSize</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">1024</span>\"</span>\n<span class=\"token key attr-name\">nvram</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">test1.nvram</span>\"</span>\n<span class=\"token key attr-name\">pciBridge0.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">pciBridge4.functions</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">8</span>\"</span>\n<span class=\"token key attr-name\">pciBridge4.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">pciBridge4.virtualDev</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">pcieRootPort</span>\"</span>\n<span class=\"token key attr-name\">pciBridge5.functions</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">8</span>\"</span>\n<span class=\"token key attr-name\">pciBridge5.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">pciBridge5.virtualDev</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">pcieRootPort</span>\"</span>\n<span class=\"token key attr-name\">pciBridge6.functions</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">8</span>\"</span>\n<span class=\"token key attr-name\">pciBridge6.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">pciBridge6.virtualDev</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">pcieRootPort</span>\"</span>\n<span class=\"token key attr-name\">pciBridge7.functions</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">8</span>\"</span>\n<span class=\"token key attr-name\">pciBridge7.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">pciBridge7.virtualDev</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">pcieRootPort</span>\"</span>\n<span class=\"token key attr-name\">powerType.powerOff</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">default</span>\"</span>\n<span class=\"token key attr-name\">powerType.reset</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">default</span>\"</span>\n<span class=\"token key attr-name\">powerType.suspend</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">soft</span>\"</span>\n<span class=\"token key attr-name\">RemoteDisplay.maxConnections</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">-1</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.affinity</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">all</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.latencySensitivity</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">normal</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.min</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">0</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.shares</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">normal</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.units</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">mhz</span>\"</span>\n<span class=\"token key attr-name\">sched.mem.min</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">0</span>\"</span>\n<span class=\"token key attr-name\">sched.mem.minSize</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">0</span>\"</span>\n<span class=\"token key attr-name\">sched.mem.shares</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">normal</span>\"</span>\n<span class=\"token key attr-name\">svga.autodetect</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">svga.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">tools.syncTime</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">FALSE</span>\"</span>\n<span class=\"token key attr-name\">tools.upgrade.policy</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">manual</span>\"</span>\n<span class=\"token key attr-name\">toolScripts.afterPowerOn</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">toolScripts.afterResume</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">toolScripts.beforePowerOff</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">toolScripts.beforeSuspend</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">uefi.secureBoot.enabled</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">uuid.bios</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">56 4d 7a c3 90 63 48 ef-69 24 5b 13 98 01 81 96</span>\"</span>\n<span class=\"token key attr-name\">uuid.location</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">56 4d 7a c3 90 63 48 ef-69 24 5b 13 98 01 81 96</span>\"</span>\n<span class=\"token key attr-name\">vc.uuid</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">52 0e 56 ab da 71 20 00-99 c0 b5 96 8a 32 4e 7c</span>\"</span>\n<span class=\"token key attr-name\">virtualHW.version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">19</span>\"</span>\n<span class=\"token key attr-name\">vm.createDate</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">1640534518499977</span>\"</span>\n<span class=\"token key attr-name\">vmci0.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span></code></pre></div>\n<p>You can create folder in ESXi, put this file there and register VM</p>\n<p>I did tried to remove all non required options till I was able to register an vm and it seems that almost everything can be removed, I have stopped after some period where it loose any sence</p>\n<p>There are set of generated parameters like <code class=\"language-text\">uuid.bios</code>, <code class=\"language-text\">uuid.location</code>, <code class=\"language-text\">vm.createDate</code> and most of others are just defaults</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token key attr-name\">.encoding</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">UTF-8</span>\"</span>\n<span class=\"token key attr-name\">config.version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">8</span>\"</span>\n<span class=\"token key attr-name\">displayName</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">test1</span>\"</span>\n<span class=\"token key attr-name\">floppy0.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">FALSE</span>\"</span>\n<span class=\"token key attr-name\">guestOS</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">other5xlinux-64</span>\"</span>\n<span class=\"token key attr-name\">memSize</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">1024</span>\"</span>\n<span class=\"token key attr-name\">numvcpus</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">2</span>\"</span>\n<span class=\"token key attr-name\">virtualHW.version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">19</span>\"</span></code></pre></div>\n<p>Then I did tried to add existing vmdk to see what vmx will looklike</p>\n<p>Here is what I got:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token key attr-name\">.encoding</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">UTF-8</span>\"</span>\n<span class=\"token key attr-name\">config.version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">8</span>\"</span>\n<span class=\"token key attr-name\">displayName</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">test1</span>\"</span>\n<span class=\"token key attr-name\">guestOS</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">ubuntu-64</span>\"</span>\n<span class=\"token key attr-name\">memSize</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">1024</span>\"</span>\n<span class=\"token key attr-name\">virtualHW.version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">19</span>\"</span>\n\n<span class=\"token key attr-name\">tools.upgrade.policy</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">manual</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.units</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">mhz</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.affinity</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">all</span>\"</span>\n<span class=\"token key attr-name\">toolScripts.afterPowerOn</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">toolScripts.afterResume</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">toolScripts.beforeSuspend</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">toolScripts.beforePowerOff</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">tools.syncTime</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">FALSE</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.min</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">0</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.shares</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">normal</span>\"</span>\n<span class=\"token key attr-name\">sched.mem.min</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">0</span>\"</span>\n<span class=\"token key attr-name\">sched.mem.minSize</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">0</span>\"</span>\n<span class=\"token key attr-name\">sched.mem.shares</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">normal</span>\"</span>\n<span class=\"token key attr-name\">ide0:0.fileName</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">system.vmdk</span>\"</span>\n<span class=\"token key attr-name\">sched.ide0:0.shares</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">normal</span>\"</span>\n<span class=\"token key attr-name\">sched.ide0:0.throughputCap</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">off</span>\"</span>\n<span class=\"token key attr-name\">ide0:0.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span>\n<span class=\"token key attr-name\">sched.cpu.latencySensitivity</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">normal</span>\"</span>\n<span class=\"token key attr-name\">tools.guest.desktop.autolock</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">FALSE</span>\"</span></code></pre></div>\n<p>So ESXi once again added bunch of things, before powering on, did tried to remove them back and started with:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token key attr-name\">.encoding</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">UTF-8</span>\"</span>\n<span class=\"token key attr-name\">config.version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">8</span>\"</span>\n<span class=\"token key attr-name\">displayName</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">test1</span>\"</span>\n<span class=\"token key attr-name\">guestOS</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">ubuntu-64</span>\"</span>\n<span class=\"token key attr-name\">memSize</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">1024</span>\"</span>\n<span class=\"token key attr-name\">virtualHW.version</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">19</span>\"</span>\n\n<span class=\"token key attr-name\">ide0:0.fileName</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">system.vmdk</span>\"</span>\n<span class=\"token key attr-name\">ide0:0.present</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">TRUE</span>\"</span></code></pre></div>\n<p>And everything worked out!</p>\n<p>Having this and <a href=\"https://mac-blog.org.ua/esxi-cloud-init-ubuntu\">cloud init</a> now it is possible to spin up bazillion of virtual machines in a seconds</p>\n<p>Here is an example of docker host with two networks:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> /vmfs/volumes/storage/test\nvmkfstools <span class=\"token parameter variable\">--clonevirtualdisk</span> /vmfs/volumes/storage/iso/system.vmdk <span class=\"token parameter variable\">--diskformat</span> thin /vmfs/volumes/storage/test/test.vmdk\nvmkfstools <span class=\"token parameter variable\">-X</span> 20G /vmfs/volumes/storage/test/test.vmdk\n\n<span class=\"token function\">tee</span> /vmfs/volumes/storage/test/test.vmx <span class=\"token operator\">></span> /dev/null <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOT\n.encoding = \"UTF-8\"\nconfig.version = \"8\"\nvirtualHW.version = \"19\"\nnvram = \"test.nvram\"\nsvga.present = \"TRUE\"\npciBridge0.present = \"TRUE\"\npciBridge4.present = \"TRUE\"\npciBridge4.virtualDev = \"pcieRootPort\"\npciBridge4.functions = \"8\"\npciBridge5.present = \"TRUE\"\npciBridge5.virtualDev = \"pcieRootPort\"\npciBridge5.functions = \"8\"\npciBridge6.present = \"TRUE\"\npciBridge6.virtualDev = \"pcieRootPort\"\npciBridge6.functions = \"8\"\npciBridge7.present = \"TRUE\"\npciBridge7.virtualDev = \"pcieRootPort\"\npciBridge7.functions = \"8\"\nvmci0.present = \"TRUE\"\nhpet0.present = \"TRUE\"\nfloppy0.present = \"FALSE\"\nRemoteDisplay.maxConnections = \"-1\"\nnumvcpus = \"4\"\nmemSize = \"8192\"\nbios.bootRetry.delay = \"10\"\npowerType.powerOff = \"default\"\npowerType.suspend = \"soft\"\npowerType.reset = \"default\"\ntools.upgrade.policy = \"manual\"\nsched.cpu.units = \"mhz\"\nsched.cpu.affinity = \"all\"\nsched.cpu.latencySensitivity = \"normal\"\nscsi0.virtualDev = \"lsilogic\"\nscsi0.present = \"TRUE\"\nsata0.present = \"TRUE\"\nusb.present = \"TRUE\"\nehci.present = \"TRUE\"\nsvga.autodetect = \"TRUE\"\nethernet0.virtualDev = \"vmxnet3\"\nethernet0.networkName = \"wan\"\nethernet0.addressType = \"generated\"\nethernet0.wakeOnPcktRcv = \"FALSE\"\nethernet0.uptCompatibility = \"TRUE\"\nethernet0.present = \"TRUE\"\nethernet1.virtualDev = \"vmxnet3\"\nethernet1.networkName = \"lan\"\nethernet1.addressType = \"generated\"\nethernet1.wakeOnPcktRcv = \"FALSE\"\nethernet1.uptCompatibility = \"TRUE\"\nethernet1.present = \"TRUE\"\nsata0:0.startConnected = \"FALSE\"\nsata0:0.autodetect = \"TRUE\"\nsata0:0.deviceType = \"atapi-cdrom\"\nsata0:0.fileName = \"auto detect\"\nsata0:0.present = \"TRUE\"\ndisplayName = \"test\"\nguestOS = \"ubuntu-64\"\ntoolScripts.afterPowerOn = \"TRUE\"\ntoolScripts.afterResume = \"TRUE\"\ntoolScripts.beforeSuspend = \"TRUE\"\ntoolScripts.beforePowerOff = \"TRUE\"\ntools.syncTime = \"FALSE\"\nsched.cpu.min = \"0\"\nsched.cpu.shares = \"normal\"\nsched.mem.min = \"0\"\nsched.mem.minSize = \"0\"\nsched.mem.shares = \"normal\"\n\n\nsched.scsi0:0.shares = \"normal\"\nsched.scsi0:0.throughputCap = \"off\"\nscsi0:0.deviceType = \"scsi-hardDisk\"\nscsi0:0.fileName = \"test.vmdk\"\nscsi0:0.present = \"TRUE\"\n\n\nguestinfo.metadata.encoding = \"base64\"\nguestinfo.metadata = \"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">'\nnetwork:\n  version: 2\n  ethernets:\n    ens160:\n      dhcp4: false\n      dhcp6: false\n      addresses:\n        - 178.20.154.77/24\n      gateway4: 178.20.154.254\n        nameservers:\n            addresses: [1.1.1.1, 8.8.8.8]\n    ens196:\n      dhcp4: false\n      dhcp6: false\n      addresses:\n        - 192.168.106.11/24\n'</span> <span class=\"token operator\">|</span> openssl base64 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'BEGIN{ORS=\"\";} {print}'</span><span class=\"token variable\">)</span></span>\"\nguestinfo.userdata.encoding = \"base64\"\nguestinfo.userdata = \"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">'#cloud-init\n# note that \"#cloud-config\" must be very first line for everything to work\n\n# hostname\npreserve_hostname: false\nhostname: test.mac-blog.org.ua\nmanage_etc_hosts: true\n\n# enable ntp\nntp:\n  enabled: true\n\n# timezone\ntimezone: Europe/Kiev\n\n# disable root login via ssh\ndisable_root: true\n\n# optional, additional groups\ngroups:\n  # because we gonna install docker\n  - docker\n\nusers:\n  - name: mac\n    # allows password authnetication when set to false, true by default\n    lock_passwd: False\n    # password hash, created by `mkpasswd --method=SHA-512 --rounds=4096`, read the docs before complaining security against plain\n    # passwd: $6$rounds=4096$4Jh2rwf9h2jM9TbQ$.CTSPJPIoIOUwKVo4A2Er19Deu945m/oD.JXVEGNH9g/piK.motblke/kpyPQ0npNKF.jZjzi61ZSBPGNbJyK/\n    # alternative approach with plain text password\n    plain_text_passwd: mac\n    ssh_authorized_keys:\n      - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAyfdNzj4mbl0PiOA7VQxeO8cR/U9u2SdRFZaZlRatdJZ1sYYa/Q0jMDOsr7oklftX49yGpuW1sBtWLevaKtcKz3kHkInFvlebFeFB9uPmMfo8gd+QLuLc8LeOQgn4wlSPEuizDxuMd1Sz1frZ7r7QUH8HdhnCO/FXtIg+c8DHsAVQSxapfalVCv4z4EiC3le8SxlZjxf/KaVmIdYOpbLf0GBP/gP5ObFYxvtTx7Rp1lM1ZSXYVGFBpXC15WYMHKq+LfQ8D0WpwiOIXw0723k+CSUb3tHS5a8Hz0GUtjMOizclIeiv503DqZAA8RxtWLfLUFdCeUgEyvIu430s4xBqSw== rsa-key-20140409\n    groups:\n      - adm\n      - cdrom\n      - sudo\n      - dip\n      - plugdev\n      - lxd\n      # add user to docker group\n      - docker\n    sudo:\n      # allow sudo\n      - ALL=(ALL) NOPASSWD:ALL\n    shell: /bin/bash\n\n# enforce password change\nchpasswd:\n  list:\n    - mac:mac\n\n# optional, additional apt sources, docker\napt:\n  sources:\n    docker.list:\n      source: deb [arch=amd64] https://download.docker.com/linux/ubuntu $RELEASE stable\n      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88\n\n# apt update &amp;&amp; apt upgrade, reboot if needed\npackage_update: true\npackage_upgrade: true\npackage_reboot_if_required: true\n\n# install packages\npackages:\n  - docker-ce\n  - docker-ce-cli\n  - containerd.io\n'</span> <span class=\"token operator\">|</span> openssl base64 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'BEGIN{ORS=\"\";} {print}'</span><span class=\"token variable\">)</span></span>\"\nEOT</span>\n\nvim-cmd solo/registervm /vmfs/volumes/storage/test/test.vmx\nvim-cmd vmsvc/getallvms\nvim-cmd vmsvc/power.on <span class=\"token number\">44</span>\n<span class=\"token comment\"># vim-cmd vmsvc/power.off 44</span>\n<span class=\"token comment\"># vim-cmd vmsvc/destroy 44</span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li><a href=\"https://mac-blog.org.ua/esxi-cloud-init-ubuntu\">cloud init or how to bootstrap ubuntu vm</a></li>\n<li>be very carefull with yaml whitespace hell, got everything working after bazillion of attempts just to realize that I have wrong spaces in network configuration</li>\n<li>if second interface not needed just remove <code class=\"language-text\">ethernet1.*</code> from vmx</li>\n<li>options to change <code class=\"language-text\">nvram</code>, <code class=\"language-text\">displayName</code>, <code class=\"language-text\">scsi0:0.fileName</code> also <code class=\"language-text\">hostname</code> in <code class=\"language-text\">guestinfo.userdata</code></li>\n<li>do not forget to rename <code class=\"language-text\">networkName</code> of <code class=\"language-text\">ethernetX</code> to corresponding ones</li>\n<li>esxi does not have built int <code class=\"language-text\">base64</code> utility so we are using <code class=\"language-text\">echo -n \"hello\" | openssl base64</code> instead, and because there is no <code class=\"language-text\">tr</code> utility to remove new lines from base64 we use <code class=\"language-text\">awk 'BEGIN{ORS=\"\";} {print}')</code></li>\n</ul>"}},"pageContext":{"id":"8d955439-1d20-5e30-9e18-a2f3f70eaad3"}},"staticQueryHashes":[]}