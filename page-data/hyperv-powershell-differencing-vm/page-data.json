{"componentChunkName":"component---src-templates-note-js","path":"/hyperv-powershell-differencing-vm/","result":{"data":{"remark":{"fields":{"path":"hyperv-powershell-differencing-vm"},"meta":{"title":""},"headings":[{"value":"Hyper-V dealing with differential VMs with Powershell"}],"html":"<h1>Hyper-V dealing with differential VMs with Powershell</h1>\n<p>Here is a way to create any number of virtual machines in seconds.</p>\n<p>First create your virtual machine and setup OS, updates, etc on it - it will be your base image.</p>\n<p>Next, turn it off and delete virtual machine, all we need it is its vhdx.</p>\n<p><strong>Create new VM from base image</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">New-VHD</span> <span class=\"token operator\">-</span>Path <span class=\"token string\">'D:\\Hyper-V\\Virtual Hard Disks\\Server1.vhdx'</span> <span class=\"token operator\">-</span>ParentPath <span class=\"token string\">'D:\\Hyper-V\\Virtual Hard Disks\\Server2016.vhdx'</span>\n<span class=\"token function\">New-VM</span> <span class=\"token operator\">-</span>Name Server1 <span class=\"token operator\">-</span>Generation 2 <span class=\"token operator\">-</span>VHDPath <span class=\"token string\">\"D:\\Hyper-V\\Virtual Hard Disks\\Server1.vhdx\"</span> <span class=\"token operator\">-</span>SwitchName <span class=\"token punctuation\">(</span><span class=\"token function\">Get-VMSwitch</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>First 1 <span class=\"token operator\">-</span>ExpandProperty Name<span class=\"token punctuation\">)</span>\n<span class=\"token function\">Set-VMMemory</span> <span class=\"token operator\">-</span>VMName Server1 <span class=\"token operator\">-</span>DynamicMemoryEnabled <span class=\"token boolean\">$True</span> <span class=\"token operator\">-</span>StartupBytes 4GB <span class=\"token operator\">-</span>MinimumBytes 4GB <span class=\"token operator\">-</span>MaximumBytes 8GB\n<span class=\"token function\">Set-VMProcessor</span> <span class=\"token operator\">-</span>VMName Server1 <span class=\"token operator\">-</span>Count 2\n<span class=\"token function\">Start-VM</span> <span class=\"token operator\">-</span>Name Server1</code></pre></div>\n<p><strong>Delete VM</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Stop-VM</span> <span class=\"token operator\">-</span>Name Server1\n<span class=\"token function\">Get-VMHardDiskDrive</span> <span class=\"token operator\">-</span>VMName Server1 <span class=\"token punctuation\">|</span> <span class=\"token function\">Remove-Item</span>\n<span class=\"token function\">Get-VMHardDiskDrive</span> <span class=\"token operator\">-</span>VMName Server1 <span class=\"token punctuation\">|</span> <span class=\"token function\">Remove-VMHardDiskDrive</span>\n<span class=\"token function\">Remove-VM</span> <span class=\"token operator\">-</span>Name Server1 <span class=\"token operator\">-</span>Force</code></pre></div>\n<p><strong>Notes</strong></p>\n<ul>\n<li>Works perfectly with Windows Server 2016, no need in syspreping image.</li>\n<li>For Ubuntu - use first generation virtual machines and turn off safe boot in firmware settings.</li>\n</ul>"}},"pageContext":{"id":"b4d34a25-b816-543c-93ee-07ac846494b9"}},"staticQueryHashes":[],"slicesMap":{}}