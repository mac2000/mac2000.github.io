{"componentChunkName":"component---src-templates-note-js","path":"/elasticsearch-reindex-increase-number-of-shards/","result":{"data":{"remark":{"fields":{"path":"elasticsearch-reindex-increase-number-of-shards"},"meta":{"title":""},"headings":[{"value":"ElasticSearch reindex increase number of shards"}],"html":"<h1>ElasticSearch reindex increase number of shards</h1>\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html\">Reindex API</a> - mechanism of receation of the index with applying of new settings</p>\n<p>We have <code class=\"language-text\">candidate-application</code> index which has only 1 shard, we need 6</p>\n<p>firs of all to create new index we need settings of existing one</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># GET candidate-application/_mapping\n{\n  \"candidate-application\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"employerId\" : {\n          \"type\" : \"keyword\"\n        },\n        \"id\" : {\n          \"type\" : \"keyword\"\n        },\n        ...\n      }\n    }\n  }\n}</code></pre></div>\n<p>next, create new index with same settings but apply desired configuration for number of shards and replicas</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PUT /candidate-application-2\n{\n  \"settings\": {\n    \"number_of_shards\": 6,\n    \"number_of_replicas\": 0\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"employerId\" : {\n        \"type\" : \"keyword\"\n      },\n      \"id\" : {\n        \"type\" : \"keyword\"\n      },\n      ...\n    }\n  }\n}</code></pre></div>\n<p>Note: while reindexing, we are setting number of replicas to 0, theoreticall it will be little bit faster</p>\n<p>Next, start reindex:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">OST _reindex?slices=5&amp;wait_for_completion=false\n{\n  \"source\": {\n    \"index\": \"candidate-application\",\n    \"size\": 10000\n  },\n  \"dest\": {\n    \"index\": \"candidate-application-2\",\n    \"version_type\": \"external\"\n  }\n}</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li><code class=\"language-text\">version_type external</code> ask elastic to move everything as is</li>\n<li><code class=\"language-text\">wait_for_completion</code> ask elastic to run operation async</li>\n<li><code class=\"language-text\">slices</code> number of threads (docs, says that it should match number of shards, in our case we have only one shard, but increasing this value speeds up reindex)</li>\n<li><code class=\"language-text\">size</code> by defaul 1К, number of docs copied at once</li>\n</ul>\n<p>as response we will receive something like</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  \"task\" : \"Jwk8EOKOSLKxzqHSa2VWuQ:5105786962\"\n}</code></pre></div>\n<p>to check current status:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GET _tasks?detailed=true&amp;actions=*reindex\n{\n  \"nodes\" : {\n    \"Jwk8EOKOSLKxzqHSa2VWuQ\" : {\n      \"name\" : \"es01\",\n      \"transport_address\" : \"62.149.5.105:9300\",\n      \"host\" : \"62.149.5.105\",\n      \"ip\" : \"62.149.5.105:9300\",\n      \"roles\" : [\n        \"ingest\",\n        \"master\",\n        \"data\",\n        \"ml\"\n      ],\n      \"attributes\" : {\n        \"ml.machine_memory\" : \"16818429952\",\n        \"xpack.installed\" : \"true\",\n        \"ml.max_open_jobs\" : \"20\"\n      },\n      \"tasks\" : {\n        \"Jwk8EOKOSLKxzqHSa2VWuQ:5106832820\" : {\n          \"node\" : \"Jwk8EOKOSLKxzqHSa2VWuQ\",\n          \"id\" : 5106832820,\n          \"type\" : \"transport\",\n          \"action\" : \"indices:data/write/reindex\",\n          \"status\" : {\n            \"total\" : 1013102,\n            \"updated\" : 0,\n            \"created\" : 60000,\n            \"deleted\" : 0,\n            \"batches\" : 60,\n            \"version_conflicts\" : 0,\n            \"noops\" : 0,\n            \"retries\" : {\n              \"bulk\" : 0,\n              \"search\" : 0\n            },\n            \"throttled_millis\" : 0,\n            \"requests_per_second\" : -1.0,\n            \"throttled_until_millis\" : 0\n          },\n          \"description\" : \"reindex from [candidate-application] to [candidate-application-mac-1][_doc]\",\n          \"start_time_in_millis\" : 1600430372126,\n          \"running_time_in_nanos\" : 12301230038,\n          \"cancellable\" : true,\n          \"headers\" : { }\n        }\n      }\n    }\n  }\n}</code></pre></div>\n<p>Where <code class=\"language-text\">total</code> - overall number of docs, <code class=\"language-text\">created</code> - number of copied docs, <code class=\"language-text\">running_time_in_nanos</code> - time from begining</p>\n<p>after completion</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GET /_cat/indices/candidate-application*?v&amp;h=index,docs.count&amp;s=index\n\nGET candidate-application/_count\n\nGET candidate-application-mac-1/_count</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>first request may show fron info, untile last request is run</li>\n<li>last request, runned first time may take some time (under the hood refresh is happening)</li>\n</ul>\n<p>Switch aliases</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">POST /_aliases\n{\n  \"actions\": [\n    {\n      \"remove\": {\n        \"index\": \"candidate-application\",\n        \"alias\": \"candidate-application-alias\"\n      }\n    },\n    {\n      \"add\": {\n        \"index\": \"candidate-application-mac-1\",\n        \"alias\": \"candidate-application-alias\"\n      }\n    }\n  ]\n}</code></pre></div>\n<p>To see current status of aliases</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GET _cat/aliases/candidate-application*?v&amp;h=alias,index</code></pre></div>\n<p>Timing</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">time</span> <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token parameter variable\">-u</span> <span class=\"token string\">'elastic:AVMrMHQ56augSsSGLAs3xahYB'</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'Content-Type: application/json'</span> <span class=\"token string\">'https://es01.rabota.ua:9200/_reindex?slices=5'</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">'{\n  \"source\": {\n    \"index\": \"candidate-application\",\n    \"size\": 10000\n  },\n  \"dest\": {\n    \"index\": \"candidate-application-mac-1\",\n    \"version_type\": \"external\"\n  }\n}'</span></code></pre></div>\n<blockquote>\n<p>index with one million of docs were reindexed in 14 seconds</p>\n<p>test on big index with 16M docs, 60gb, takes approx 30min which is fine, because copying of such amount of data on its own is not fast</p>\n</blockquote>\n<p>here is small script to see whats going on</p>\n<p>Пока ждал накалякал скрипт что бы смотреть что происходит</p>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">$username = &#39;elastic&#39;\n$password = &#39;*******&#39;\n\n$base64 = [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes(&quot;$($username):$($password)&quot;))\n$headers = @{ Authorization = &quot;Basic $base64&quot; }\n\n$res = Invoke-RestMethod &quot;https://es01.rabota.ua:9200/_tasks?detailed=true&amp;actions=*reindex&quot; -Headers $headers | Select-Object -ExpandProperty nodes\n$key = $res | Get-Member -MemberType NoteProperty | Select-Object -ExpandProperty Name -First 1\n$taskKeys = $res.$key.tasks | Get-Member -MemberType NoteProperty | Select-Object -ExpandProperty Name\n\nforeach($taskKey in $taskKeys) {\n    $task = $res.$key.tasks.$taskKey\n\n    if ($task.status.total -eq 0) {\n        Write-Host &quot;$taskKey - empty&quot;\n        continue\n    }\n\n    $percent = [int]($task.status.created / $task.status.total * 100)\n    $timer = [TimeSpan]::FromMilliseconds($task.running_time_in_nanos/1000000).ToString()\n\n    Write-Host &quot;$taskKey - $($percent)% in $timer&quot;\n}</code></pre></div>\n<p>Output will be something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Jwk8EOKOSLKxzqHSa2VWuQ:5150731438 - empty\nJwk8EOKOSLKxzqHSa2VWuQ:5150731439 - 64% in 00:20:45.4927814\nJwk8EOKOSLKxzqHSa2VWuQ:5150731441 - 66% in 00:20:45.4925209\nJwk8EOKOSLKxzqHSa2VWuQ:5150731443 - 68% in 00:20:45.4923133\nJwk8EOKOSLKxzqHSa2VWuQ:5150731446 - 67% in 00:20:45.4921202\nJwk8EOKOSLKxzqHSa2VWuQ:5150731449 - 66% in 00:20:45.4919510</code></pre></div>\n<p>Note: first empty record is ok, this one acts as a parent for child threads</p>\n<p>Here are results for big index:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  \"size\": 0,\n  \"aggs\": {\n    \"status\": {\n      \"terms\": {\n        \"field\": \"statusId\",\n        \"size\": 10\n      }\n    }\n  }\n}</code></pre></div>\n<p>On old index with single shard - 550ms, on new index - 20ms</p>"}},"pageContext":{"id":"bd1003bc-7d62-582d-b081-c039e928f6e2"}},"staticQueryHashes":[],"slicesMap":{}}