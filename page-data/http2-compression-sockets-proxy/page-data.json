{"componentChunkName":"component---src-templates-note-js","path":"/http2-compression-sockets-proxy/","result":{"data":{"remark":{"fields":{"path":"http2-compression-sockets-proxy"},"meta":{"title":""},"headings":[{"value":"HTTP2 headers compression, sockets usage, reverse proxy"}],"html":"<h1>HTTP2 headers compression, sockets usage, reverse proxy</h1>\n<p>Trying to figure out basic things around HTTP2 with set of examples that will show how it works and what benefits it has</p>\n<h2>HTTP2 header compression</h2>\n<p>With help of <a href=\"/http-compression\">http compression</a> we may dramatically reduce traffic and costs</p>\n<p>But there is even more improvement that might be done</p>\n<p>HTTP2 alongside all other benefits will compress request and response headers and will do it always</p>\n<p>To demonstrate this we will have following example: simple nginx server (there is no need to create an sample app), that serves \"Hello World\" web page plus one tousand of bytes in headers</p>\n<p>We are going to run such nginx for good old http and moder http2 and compare results in our browser</p>\n<p>As well in nginx logs (unfortunately I did not found a way to get header only bytes in nginx logs as well as request body size to perform checks from curl, but still I do believe that request headers are compressed same way as well)</p>\n<h3>HTTP1.1</h3>\n<p><div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n    listen              80;\n    listen              443 ssl;\n    server_name         localhost.direct;\n    ssl_certificate     localhost.direct.crt;\n    ssl_certificate_key localhost.direct.key;\n\n    location / {\n        # root   /usr/share/nginx/html;\n        # index  index.html index.htm;\n\n        add_header Content-Type text/plain;\n        add_header X-Hundred-Bytes-0 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-1 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-2 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-3 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-4 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-5 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-6 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-7 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-8 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-9 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        return 200 &#39;Hello World\\n&#39;;\n    }\n}</code></pre></div></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.crt:/etc/nginx/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.key:/etc/nginx/localhost.direct.key <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/http.conf:/etc/nginx/conf.d/default.conf <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/nginx.conf:/etc/nginx/nginx.conf nginx</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cda80aae76f163ece480c215769cfee0/7e318/http.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.59375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACeElEQVR42q1RTU8TURQdN+4IiRBrJCpU05pSaaCCJNNEFrLogl/AjgV/gKVxw4YJAcpXJtYOKMUOTWlJpOl/QSn9mM6b6QfTMhSm7cy8d80MFhe40MSbnHfuPe++s3iH8ng899+Nj75+89YfmAoG6eDMDB0MztDT00E6EJiiJwMB2uef/CNcwz7a6XLRnpGRgM/nn7C8qJ6ePrdnaLDxwuOEVz4/GR2bgNGxcXC/9MLgkAseDzyFB32OO+jrd8CTZ05wPncTx6MBa++qt9cxRM3NzXlXQ5sqy4Zhe5sl4XAEItwubGxswepqCNbW1u/A0tfXNyG6H4Nk8ohwkV1g2Y/a7Oysm0qlUt5WS1MBADDGBP697DedTkfjOK5r2LINTdMkGGP4W5Abtg3b7bbGsuyN4WWzqZoYg9ZqkY6ugwVd16HdsXoD9C4MA7r3bV0Hw7A1YpgYNE27MYxynFc4PVXlWgPK1RpBkgwCkqCEZDjJFiFfRHCWL0BJkqFYEkEQEciVKkjlKlTPFQukWlOgKIra4uKim4pGo95CvqAqjUuoKXViLX/P5iBXFOA0l4eTH1nIFQSQyhWQKlVAcsXuLTMkla2ZVGqKpWmhUMhNffrCD59kC40SkqCmKCaSZFwQRCxKMi6WEBZEhJEsY6Vex42LC4zkMq5fqLhUlvGZiPBls2leXV/DuVK/WlnZclHxuBVKW+0mRgixju7wi38HeqvZyRqATXybsv2HCwsLD2MHB+8Th4fLX3l+aT/GMzE+zljMxxMMH48ze3tJJhxOMpHPSYbnj5ijnR3mOJFkjjMZJp1OL33LpJfTmcyH+fn5foqiqHvUf6yfVO+NLkpLjLsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"http\"\n        title=\"\"\n        src=\"/static/cda80aae76f163ece480c215769cfee0/2bef9/http.png\"\n        srcset=\"/static/cda80aae76f163ece480c215769cfee0/6f3f2/http.png 256w,\n/static/cda80aae76f163ece480c215769cfee0/01e7c/http.png 512w,\n/static/cda80aae76f163ece480c215769cfee0/2bef9/http.png 1024w,\n/static/cda80aae76f163ece480c215769cfee0/71c1d/http.png 1536w,\n/static/cda80aae76f163ece480c215769cfee0/7e318/http.png 1892w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>protocol</th>\n<th>size</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>http1.1</td>\n<td>1.5kb</td>\n</tr>\n</tbody>\n</table>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">request \"GET / HTTP/1.1\", 754 bytes received, 1510 bytes sent</code></pre></div>\n<p>and the curl attempt:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-o</span> /dev/null <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-1: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-2: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-3: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-4: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-5: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-6: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-7: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-8: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-9: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-H</span> <span class=\"token string\">'X-Bytes-0: 12345678901234567890123456789012345678901234567890123456789012345678901234567890'</span> <span class=\"token punctuation\">\\</span>\n  https://localhost.direct/ <span class=\"token parameter variable\">-w</span> <span class=\"token string\">'version: %{http_version}\\nbody: %{size_download}\\nheaders: %{size_header}\\n'</span></code></pre></div>\n<p>will output:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: 1.1\nbody: 12\nheaders: 1498</code></pre></div>\n<p>and from nginx side it will be:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">request \"GET / HTTP/1.1\", 1010 bytes received, 1510 bytes sent</code></pre></div>\n<h3>HTTP2</h3>\n<blockquote>\n<p>For HTTP2 to work SSL (HTTPS) is <strong>required</strong>, thankfully there is an <a href=\"https://get.localhost.direct\">localhost.direct</a> project which will be really helpfull here, I have just realized that I have been using it in HTTP example but want to leave everything as is, because this one does prove that TLS does not change anything here</p>\n</blockquote>\n<p><div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n    listen              80;\n    listen              443 ssl http2;\n    server_name         localhost.direct;\n    ssl_certificate     localhost.direct.crt;\n    ssl_certificate_key localhost.direct.key;\n\n    location / {\n        # root   /usr/share/nginx/html;\n        # index  index.html index.htm;\n        add_header Content-Type text/plain;\n        add_header X-Hundred-Bytes-0 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-1 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-2 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-3 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-4 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-5 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-6 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-7 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-8 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        add_header X-Hundred-Bytes-9 12345678090123456780901234567809012345678090123456780901234567809012345678090123456780901234567809012345678090;\n        return 200 &#39;Hello World\\n&#39;;\n    }\n}</code></pre></div></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.crt:/etc/nginx/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.key:/etc/nginx/localhost.direct.key <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/http2.conf:/etc/nginx/conf.d/default.conf <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/nginx.conf:/etc/nginx/nginx.conf nginx</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ad174bbe382fec75b8e7446bf09a99f4/7e318/http2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.59375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACc0lEQVR42q1RS08TURgdN+4IiRBrJD6opjWl0kAFSaaJLGTRBb+AHQv+AEvjhg0TApRXRmsraLFDA4VIav8LSkufM9MHQxke08507j1m2jTG4EITv+Tc833nfvcs7mFcLtft1yNDL16+8vrG/X7WPznJ+v2T7MSEn/X5xtkxn4/1eMf+CMeAh7U7HKxrcNDn8XhHLS+mq6vH6ep/XHvqsuO5x0uHhkcxNDwC5zM3Hvc7cL/vIe702G6gp9eGB4/ssD9xUtu9Pmvvqrvb1s9MT0+7lwJrKs8HsbHB02AwhFB4E6ur61haCmB5eeUGLH1lZQ2R7Sji8QMaDm2C599rU1NTTmZ/f99dr2sqABBCKP69Wm90XdfC4XDHsN4yNE2TEkLwt6Btbhk2Gg2N5/m24cXlpWoSAq1ep7phwIJhGGjoVt+E0UGzic59wzDQbLY02jQJNE1rG0bCYXf++FiVqzWUKlUqSjLyooSCKOMonUMmLyKdyaIgycgVisgXRcjlCqRSBZVTxQKtVBXkikVtbm7OyUQiEXc2k1WV2gWqyhm1lr+nTnCSy+M4ncHRjxROsnlIpTKkcgWiXG71lplYKlkzLVcVyOWyFggEnMyHT8LAUSpbK4gSqopiipJMsvkiKUgykeQSKRQlIsoyUc7OSO38vKUpFkslkk6J5Fy9MK+ur3GqKFeLi+sOJhazQmmoncQopdbRGX7F2BZ+00xCoTeMdii63v7D2dnZu9GdnTe7e3sLXwRhfjsqcFEhxnVY2I1xn7fj3LvgLhf6GOeiwgF3sLXFfRVi3LdkkjtMJOYPk4mFRDL5dmZmppdhGOYW8x/rJ1atjSMylRLzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"http2\"\n        title=\"\"\n        src=\"/static/ad174bbe382fec75b8e7446bf09a99f4/2bef9/http2.png\"\n        srcset=\"/static/ad174bbe382fec75b8e7446bf09a99f4/6f3f2/http2.png 256w,\n/static/ad174bbe382fec75b8e7446bf09a99f4/01e7c/http2.png 512w,\n/static/ad174bbe382fec75b8e7446bf09a99f4/2bef9/http2.png 1024w,\n/static/ad174bbe382fec75b8e7446bf09a99f4/71c1d/http2.png 1536w,\n/static/ad174bbe382fec75b8e7446bf09a99f4/7e318/http2.png 1892w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<table>\n<thead>\n<tr>\n<th>protocol</th>\n<th>size</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>http2</td>\n<td>1.0kb</td>\n</tr>\n</tbody>\n</table>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">request \"GET / HTTP/2.0\", 506 bytes received, 1048 bytes sent</code></pre></div>\n<p>and the same curl attempt will give us:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: 2\nbody: 12\nheaders: 1470</code></pre></div>\n<p>and in nginx logs</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">request \"GET / HTTP/2.0\", 701 bytes received, 1047 bytes sent</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>the most important one - http2 does not compress bodies (in both cases response body is 12 bytes), everything we did in <a href=\"/http-compression\">http compression</a> is still applicable and wanted</li>\n<li>http2 compress request and response headers out of the box without the need to do something special from both client and server sides</li>\n<li>curl headers size report seems to be broken (has almost no difference in both examples)</li>\n</ul>\n<p>So if you have bazillion of cookies (all kinds of remarketing, facebook, jwt tokens and so on) enabling http2 may be noticeable</p>\n<h2>HTTP2 sockets usage</h2>\n<p>The second benefit of HTTP2 that it reuses the same socket to transfer files between the client and the server</p>\n<p>In this demo we have small web app with single page that loads ten javascript files and each of them prints its hello message</p>\n<p>The output of html will be something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">demo\nhello /echo/say1\nhello /echo/say2\nhello /echo/say3\nhello /echo/say4\nhello /echo/say5\nhello /echo/say6\nhello /echo/say7\nhello /echo/say8\nhello /echo/say9\nhello /echo/say0</code></pre></div>\n<p>Nothing fancy here, but it will allow us to see what happens underneath</p>\n<p>To calculate incomming connections I used an sample found <a href=\"https://stackoverflow.com/questions/51317122/how-to-get-number-of-idle-and-active-connections-in-go\">here</a></p>\n<p>Here is an app:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"net\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\trouter <span class=\"token operator\">:=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">NewServeMux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s %s\\n\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Proto<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/html\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span><span class=\"token string\">`\n      &lt;!DOCTYPE html>\n      &lt;html>\n      &lt;head>\n          &lt;title>demo&lt;/title>\n      &lt;/head>\n      &lt;body>\n          &lt;h1>demo&lt;/h1>\n          &lt;script src=\"/echo/say1\">&lt;/script>\n          &lt;script src=\"/echo/say2\">&lt;/script>\n          &lt;script src=\"/echo/say3\">&lt;/script>\n          &lt;script src=\"/echo/say4\">&lt;/script>\n          &lt;script src=\"/echo/say5\">&lt;/script>\n          &lt;script src=\"/echo/say6\">&lt;/script>\n          &lt;script src=\"/echo/say7\">&lt;/script>\n          &lt;script src=\"/echo/say8\">&lt;/script>\n          &lt;script src=\"/echo/say9\">&lt;/script>\n          &lt;script src=\"/echo/say0\">&lt;/script>\n      &lt;/body>\n      &lt;/html>\n    `</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/echo/\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s %s\\n\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Proto<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/javascript\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"document.write('hello %s&lt;br>')\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\ts <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>http<span class=\"token punctuation\">.</span>Server<span class=\"token punctuation\">{</span>\n\t\tConnState<span class=\"token punctuation\">:</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>c net<span class=\"token punctuation\">.</span>Conn<span class=\"token punctuation\">,</span> cs http<span class=\"token punctuation\">.</span>ConnState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">if</span> cs <span class=\"token operator\">==</span> http<span class=\"token punctuation\">.</span>StateNew <span class=\"token punctuation\">{</span>\n\t\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GOT NEW TCP CONNECTION\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// https://stackoverflow.com/questions/51317122/how-to-get-number-of-idle-and-active-connections-in-go</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tHandler<span class=\"token punctuation\">:</span> router<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>Args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"http\"</span> <span class=\"token punctuation\">{</span>\n\t\tlistener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">Listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\":80\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open http://localhost/\"</span><span class=\"token punctuation\">)</span>\n\t\ts<span class=\"token punctuation\">.</span><span class=\"token function\">Serve</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>Args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"http2\"</span> <span class=\"token punctuation\">{</span>\n\t\tlistener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">Listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\":443\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open https://localhost.direct/\"</span><span class=\"token punctuation\">)</span>\n\t\ts<span class=\"token punctuation\">.</span><span class=\"token function\">ServeTLS</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost.direct.crt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost.direct.key\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<h3>HTTP</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/main.go:/code/main.go <span class=\"token parameter variable\">-w</span> /code golang go run main.go http</code></pre></div>\n<p>Then open <a href=\"http://localhost/\">http://localhost/</a> (feel free to change ports if needed)</p>\n<p>In the container logs you will see:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION\nGOT NEW TCP CONNECTION</code></pre></div>\n<p>Note: here we can see as well of how browser tries to optimize socket connection used, and limits number of connections to our backend in this example to six connections only</p>\n<h3>HTTP2</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/main.go:/code/main.go <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/localhost.direct.crt:/code/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/localhost.direct.key:/code/localhost.direct.key <span class=\"token parameter variable\">-w</span> /code golang go run main.go http2</code></pre></div>\n<p>Once gain, ports may be changed here</p>\n<p>And in container logs you will see <strong>only one</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GOT NEW TCP CONNECTION</code></pre></div>\n<p>Which is the key difference that we wanted to see/feel/catch</p>\n<h2>HTTP2 behind reverse proxy</h2>\n<p>After few attempts it seems that it is not possible at the moment O_o</p>\n<p>Here is what I have ended up</p>\n<p>Idea was to run previous example in http2 mode being proxied by nginx</p>\n<p><div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n    listen              80;\n    listen              443 ssl http2;\n    server_name         localhost.direct;\n    ssl_certificate     localhost.direct.crt;\n    ssl_certificate_key localhost.direct.key;\n\n    # location / {\n    #     proxy_pass https://http.localhost.direct;\n    # }\n\n    # With such config, even so from client side we see HTTP2, on proxied service logs we see that requests are HTTP1.1\n    location / {\n        proxy_pass https://http2.localhost.direct:443;\n    }\n}</code></pre></div></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># docker run -it --rm --name=http --ip=172.17.0.80 -v ${PWD}/main.go:/code/main.go -w /code golang go run main.go http</span>\n\n<span class=\"token comment\"># docker run -it --rm --name=http2 --ip=172.17.0.43 -v ${PWD}/main.go:/code/main.go -v ${PWD}/localhost.direct.crt:/code/localhost.direct.crt -v ${PWD}/localhost.direct.key:/code/localhost.direct.key -w /code golang go run main.go http2</span>\n\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>http2 <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/main.go:/code/main.go <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/localhost.direct.crt:/code/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/localhost.direct.key:/code/localhost.direct.key <span class=\"token parameter variable\">-w</span> /code golang go run main.go http2</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>we are not exposing container ports by intent, requests will be made via reverse proxy</li>\n<li>i was not able to set fixed ip address in my case <code class=\"language-text\">docker inspect http2</code> did always show <code class=\"language-text\">172.17.0.2</code> so i just hardcoded it instead off passing <code class=\"language-text\">--ip=172.17.0.43</code> to docker run command</li>\n</ul>\n<p>And run our nginx:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token parameter variable\">--link</span><span class=\"token operator\">=</span>http2 --add-host<span class=\"token operator\">=</span>http2.localhost.direct:172.17.0.2 <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.crt:/etc/nginx/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/localhost.direct.key:/etc/nginx/localhost.direct.key <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/proxy.conf:/etc/nginx/conf.d/default.conf <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/nginx.conf:/etc/nginx/nginx.conf nginx</code></pre></div>\n<p>And from the browser we see expected http2 but from the backend service that is sill old protocol</p>\n<p>Can not say if it is good or bat, at the very end in majority of the cases both backend and proxy will be sitting side by side in a private network and all this should not be a real problem</p>\n<p>Later on, when we had our examples of https and http2 in dotnet and nodejs it seems like nodejs will serve only http2 so I did tried following:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>createSecureServer<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http2'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>readFileSync<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token function\">createSecureServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">key</span><span class=\"token operator\">:</span> <span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localhost.direct.key'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">cert</span><span class=\"token operator\">:</span> <span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localhost.direct.crt'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">443</span><span class=\"token punctuation\">)</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">dir</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'request'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hello world\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>http2 <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/main.js:/code/main.js <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/localhost.direct.crt:/code/localhost.direct.crt <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/localhost.direct.key:/code/localhost.direct.key <span class=\"token parameter variable\">-w</span> /code <span class=\"token function\">node</span> <span class=\"token function\">node</span> main.js</code></pre></div>\n<p>Then run the same nginx as previously and retrieved an error in browser</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Missing ALPN Protocol, expected `h2` to be available.\nIf this is a HTTP request: The server was not configured with the `allowHTTP1` option or a listener for the `unknownProtocol` event.</code></pre></div>\n<p>Which makes me believe all this HTTP2 story is good only for edge and if your are sitting somewhere behind Cloudflare who is using(ed) nginx, it would not make much sense</p>\n<p><a href=\"https://serverfault.com/a/875471/255456\">Here</a> is an quotation from nginx</p>\n<h3>HTTPS and HTTP2 in dotnet</h3>\n<p>HTTP2 in dotnet is enabled by default starting from 3.1 or 5.0</p>\n<p>do not remember correct version but at moment of writing actual version is 7.0 so it should just work out of the box</p>\n<p>there is no need to change anything from application side the only thing we need to do is to add to our appsetting.json following:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Kestrel\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Endpoints\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Http\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http://dotnet.localhost.direct\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Https\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://dotnet.localhost.direct\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Certificate\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"Path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"localhost.direct.crt\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"KeyPath\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"localhost.direct.key\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>notes:</p>\n<ul>\n<li>you sill can use ports, e.g.: <code class=\"language-text\">\"Url\": \"https://dotnet.localhost.direct:50001\",</code></li>\n<li>you are not required to add both http and https and can add only one</li>\n<li>you may want to use url like <code class=\"language-text\">\"Url\": \"https://0.0.0.0\",</code></li>\n</ul>\n<h3>HTTPS and HTTP2 in node</h3>\n<p>Here is an example of raw https server without any dependencies</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> https <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hello world\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> https<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">key</span><span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localhost.direct.key'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">cert</span><span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localhost.direct.crt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">443</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>and here is one for expresjs</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> https <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hello World'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// app.listen(4000) // instead of this do following:</span>\n<span class=\"token keyword\">const</span> httpServer <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> httpsServer <span class=\"token operator\">=</span> https<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">key</span><span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localhost.direct.key'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">cert</span><span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localhost.direct.crt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">)</span>\n\nhttpServer<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span>\nhttpsServer<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">443</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>But for HTTP2 we need something else</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>createSecureServer<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http2'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>readFileSync<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token function\">createSecureServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">key</span><span class=\"token operator\">:</span> <span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localhost.direct.key'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">cert</span><span class=\"token operator\">:</span> <span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localhost.direct.crt'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">443</span><span class=\"token punctuation\">)</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">dir</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'request'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hello world\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>the interesting fact for last example here if we will run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> https://localhost.direct/</code></pre></div>\n<p>Everything will work as expected (underneath, both our server and curl will agree to talk http2), but if we wun:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> https://localhost.direct/ <span class=\"token parameter variable\">--http1.1</span></code></pre></div>\n<p>We will receive an error: \"Unknown ALPN Protocol, expected <code class=\"language-text\">h2</code> to be available.\"</p>\n<p>Which was used in previous section to check how it will behave behind proxy</p>\n<h2>HTTP2 Server Push</h2>\n<p>Another interesting concept is HTTP2 Server Push</p>\n<p>Idea was to build an small app that will serve index.html</p>\n<p>Then browser will download style.css which will be served for 2 seconds</p>\n<p>After that, because of styles browser will recognize that it does need an image as well and will download it which will also take 2 seconds</p>\n<p>So in total page load will take aprox 4 seconds</p>\n<p>But with help of push, we should be able to push both styles and image alongside index.html</p>\n<p>Here is sample app:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"log\"</span>\n\t<span class=\"token string\">\"net\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n\t<span class=\"token string\">\"time\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\trouter <span class=\"token operator\">:=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">NewServeMux</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/style.css\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s %s\\n\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Proto<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span>\n\t\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n\t\tb<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"style.css\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/css\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sc2.jpeg\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s %s\\n\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Proto<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span>\n\t\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n\t\tb<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sc2.jpeg\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"image/jpeg\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\trouter<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s %s\\n\"</span><span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>Proto<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">.</span>URL<span class=\"token punctuation\">.</span>Path<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> pusher<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> w<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>Pusher<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ok <span class=\"token punctuation\">{</span>\n\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PUSH IS SUPPORTED\"</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> pusher<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/style.css\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to push: %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> pusher<span class=\"token punctuation\">.</span><span class=\"token function\">Push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sc2.jpeg\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to push: %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tb<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"index.html\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/html\"</span><span class=\"token punctuation\">)</span>\n\t\tw<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\ts <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>http<span class=\"token punctuation\">.</span>Server<span class=\"token punctuation\">{</span>\n\t\tConnState<span class=\"token punctuation\">:</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>c net<span class=\"token punctuation\">.</span>Conn<span class=\"token punctuation\">,</span> cs http<span class=\"token punctuation\">.</span>ConnState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">if</span> cs <span class=\"token operator\">==</span> http<span class=\"token punctuation\">.</span>StateNew <span class=\"token punctuation\">{</span>\n\t\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GOT NEW TCP CONNECTION\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// https://stackoverflow.com/questions/51317122/how-to-get-number-of-idle-and-active-connections-in-go</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tHandler<span class=\"token punctuation\">:</span> router<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>Args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"http\"</span> <span class=\"token punctuation\">{</span>\n\t\tlistener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">Listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\":80\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open http://localhost/\"</span><span class=\"token punctuation\">)</span>\n\t\ts<span class=\"token punctuation\">.</span><span class=\"token function\">Serve</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>Args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"http2\"</span> <span class=\"token punctuation\">{</span>\n\t\tlistener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> net<span class=\"token punctuation\">.</span><span class=\"token function\">Listen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\":443\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open https://localhost.direct/\"</span><span class=\"token punctuation\">)</span>\n\t\ts<span class=\"token punctuation\">.</span><span class=\"token function\">ServeTLS</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost.direct.crt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost.direct.key\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<p>But here we have real strange things</p>\n<p>In Safari it does indeed works, at least overall load time is around 2 seconds (aka both requests for styles and image were made in parallel underneath)</p>\n<p>But in Chrome it does not work anymore, and go complains \"Failed to push: feature not supported\"</p>\n<p>And when I was trying to figure out how to do the same in dotnet found this <a href=\"https://github.com/dotnet/aspnetcore/issues/4249#issuecomment-728363386\">answer</a></p>\n<p>So it seems like HTTP2 Server Push feature is dead</p>\n<h2>Conclusions</h2>\n<p>http2 may reduce traffic even more, also it will utilize less socket connections</p>\n<p>but it does make sence only for publicly available services</p>\n<p>in case if your service is behind nginx/ingress all you need to do is enable http2 in nginx/ingress and there is no need to do anything to your app because nginx will use old http behind the scene, but for client it will serve http2 - at least we will reduce traffic outside our network</p>\n<p>if you are behind reverse proxy like cloudflare then probaly it does not make much sense in general, cloudflare was made on top of nginx (ok, they have rewritten it and created their own proxy but still this rules probably are applied)</p>"}},"pageContext":{"id":"b11c49fc-9f9c-5bdb-b209-3567452d0759"}},"staticQueryHashes":[],"slicesMap":{}}