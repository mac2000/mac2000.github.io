{"componentChunkName":"component---src-templates-note-js","path":"/github-action-matrix-101/","result":{"data":{"remark":{"fields":{"path":"github-action-matrix-101"},"meta":{"title":""},"headings":[{"value":"Github Actions Matrix 101"},{"value":"Как это работает"},{"value":"matrix101"},{"value":"matrix102"},{"value":"matrix103"}],"html":"<h1>Github Actions Matrix 101</h1>\n<p>Матрицы в github action - штука позволяющая описывать эдакие “динамические” workflow, на деле оно не так что бы сложное, но из-за того что оно нужно натурально раз в пятилетку - каждый раз приходиться заново вспоминать с какого боку к нему подходить</p>\n<p>Цель заметки: после просмотра ее по диагонали должно будет быть понятным как скрафтить простенький динамичный workflow за пять минут</p>\n<h1>Как это работает</h1>\n<p>Предположим наша джоба это сборка чего либо или еще лучше, для примера просто вызов команды echo</p>\n<p>Выполнять это дело мы хотим для динамического кол-ва объектов</p>\n<p>Соотв наша джоба будет иметь следующий вид (псевдокод):</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> prepare items array\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span> use results of matrix step <span class=\"token comment\"># &lt;- aka: foreach(item in items) {</span>\n    <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> build $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.item <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Самый гемморой в этом деле это:</p>\n<ul>\n<li>не запутаться в названиях - там натурально в 5 местах разные переменные и если хоть одну перепутать - все пойдет на перекосяк - потому за для удобства и не долго думая в примере обзываю все matrix</li>\n<li>shape матрицы - это объект с 1+ пропертей, содержащей массив примитивов или объектов - это как раз ниже наглядно будет видно в примерах</li>\n</ul>\n<p>Сама матрица при этом - as easy as</p>\n<p><strong>bash</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'matrix={\"user\":[{\"username\":\"mac2000\",\"email\":\"alexandrm@rabota.ua\"},{\"username\":\"vadymkutsenko\",\"email\":\"vadimk@rabota.ua\"},{\"username\":\"TamaraGalaktionova\",\"email\":\"tamaraga@rabota.ua\"}]}'</span> <span class=\"token operator\">>></span> <span class=\"token string\">\"<span class=\"token variable\">$GITHUB_OUTPUT</span>\"</span></code></pre></div>\n<p><strong>powershell</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token variable\">$matrix</span> <span class=\"token operator\">=</span> ConvertTo-Json <span class=\"token parameter variable\">-Compress</span> <span class=\"token parameter variable\">-InputObject</span> @<span class=\"token punctuation\">{</span>\n  user <span class=\"token operator\">=</span> @<span class=\"token punctuation\">(</span>\n    @<span class=\"token punctuation\">{</span>\n      username <span class=\"token operator\">=</span> <span class=\"token string\">\"mac2000\"</span>\n      email <span class=\"token operator\">=</span> <span class=\"token string\">\"alexandrm@rabota.ua\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token string\">\"matrix=<span class=\"token variable\">$matrix</span>\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$env</span>:GITHUB_OUTPUT</code></pre></div>\n<p><strong>github script (javascript)</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">return</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">user</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">username</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mac2000\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">email</span><span class=\"token operator\">:</span> <span class=\"token string\">\"alexandrm@rabota.ua\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>примечание: последний пример не проверялся и требуед доработки напильником, <a href=\"https://github.com/actions/github-script?tab=readme-ov-file#reading-step-results\">дока</a></p>\n</blockquote>\n<h1>matrix101</h1>\n<p>матрица на минималках - массив строк</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> matrix101\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">outputs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.matrix.outputs.matrix <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> matrix\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo 'matrix=<span class=\"token punctuation\">{</span>\"letter\"<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"B\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"C\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>' <span class=\"token punctuation\">></span><span class=\"token punctuation\">></span> \"$GITHUB_OUTPUT\"\n        <span class=\"token comment\"># in simplest case, matrix is an object, with single property holding array of items</span>\n\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> matrix\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> needs.matrix.outputs.matrix <span class=\"token tag\">!=</span> '<span class=\"token punctuation\">{</span>\"letter\"<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>' <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> fromJson(needs.matrix.outputs.matrix) <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo '$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> toJson(matrix) <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>' <span class=\"token comment\"># {\"letter\": \"A\"} - array item is inlined</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.letter <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># A</span></code></pre></div>\n<p>Тут наглядно будет виден общий подход</p>\n<p>Сама матрица - объект с хотя бы одной пропертей содержащей массив элементов</p>\n<p>Элеметны при этом могут быть как примитивами так и объектами (см след демку)</p>\n<p>В основном степе build, пока итерируемся, имеем объект matrix у которого в эту пропертю подставлен конретный элемент массива</p>\n<p>Псевдо код как это в принципе работает:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">letter</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"B\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"C\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">matrix</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>matrix<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// {\"letter\":\"A\"}</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>matrix<span class=\"token punctuation\">.</span>letter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"A\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> matrix <span class=\"token operator\">=</span> <span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> letter <span class=\"token keyword\">of</span> matrix<span class=\"token punctuation\">.</span>letter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">letter</span><span class=\"token operator\">:</span> letter <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1>matrix102</h1>\n<p>то же самое что и предыдущая демка, но на этот раз пользуем объекты за вместо примитивов</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> matrix102\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">outputs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.matrix.outputs.matrix <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> matrix\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo 'matrix=<span class=\"token punctuation\">{</span>\"user\"<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\"username\"<span class=\"token punctuation\">:</span><span class=\"token string\">\"mac2000\"</span><span class=\"token punctuation\">,</span>\"email\"<span class=\"token punctuation\">:</span><span class=\"token string\">\"alexandrm@rabota.ua\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>\"username\"<span class=\"token punctuation\">:</span><span class=\"token string\">\"vadymkutsenko\"</span><span class=\"token punctuation\">,</span>\"email\"<span class=\"token punctuation\">:</span><span class=\"token string\">\"vadimk@rabota.ua\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>\"username\"<span class=\"token punctuation\">:</span><span class=\"token string\">\"TamaraGalaktionova\"</span><span class=\"token punctuation\">,</span>\"email\"<span class=\"token punctuation\">:</span><span class=\"token string\">\"tamaraga@rabota.ua\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>' <span class=\"token punctuation\">></span><span class=\"token punctuation\">></span> \"$GITHUB_OUTPUT\"\n        <span class=\"token comment\"># once again, matrix is an object with at least one property, holding array of items, which can by objects of any shape</span>\n\n  <span class=\"token key atrule\">utilize</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> matrix\n    <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> needs.matrix.outputs.matrix <span class=\"token tag\">!=</span> '<span class=\"token punctuation\">{</span>\"user\"<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>' <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> fromJson(needs.matrix.outputs.matrix) <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo '$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> toJson(matrix) <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>' <span class=\"token comment\"># {\"user\": {\"username\":\"mac2000\",\"email\":\"alexandrm@rabota.ua\"}}</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.user.username <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># mac2000</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.user.email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># alexandrm@rabota.ua</span></code></pre></div>\n<p>Тут механика происходящего один в один такая же как и в предыдущей демке</p>\n<p>Специально на два куска разделено что бы было легче понять\\вспомнить</p>\n<h1>matrix103</h1>\n<p>Комбинаторика - если в матрице есть две проперти - будут пользоваться все комбинации их элементов</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> matrix103\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">outputs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> steps.matrix.outputs.matrix <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> matrix\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo 'matrix=<span class=\"token punctuation\">{</span>\"env\"<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"dev\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"prod\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\"domain\"<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"rabota.ua\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"robota.ua\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>' <span class=\"token punctuation\">></span><span class=\"token punctuation\">></span> \"$GITHUB_OUTPUT\"\n        <span class=\"token comment\"># matrix can hold multiple properties, in this case - all possible combinations of two arrays will be used</span>\n\n  <span class=\"token key atrule\">utilize</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> matrix\n    <span class=\"token comment\"># if: ${{ needs.matrix.outputs.matrix != 'TODO' }}</span>\n    <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> fromJson(needs.matrix.outputs.matrix) <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo '$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> toJson(matrix) <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>' <span class=\"token comment\"># {\"env\":\"test\",\"domain\":\"robota.ua\"}</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.env <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># test</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.domain <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># robota.ua</span></code></pre></div>\n<p>Тут любопытный пример имеет две проперти env и domain, каждая содержит массив примитивов</p>\n<p>На выходе наша матрица будет содержать все возможные комбинации env + domain</p>"}},"pageContext":{"id":"02969f92-673e-5bc7-b3a4-63fee8f17cd3"}},"staticQueryHashes":[],"slicesMap":{}}