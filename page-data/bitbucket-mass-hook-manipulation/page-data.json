{"componentChunkName":"component---src-templates-note-js","path":"/bitbucket-mass-hook-manipulation","result":{"data":{"remark":{"fields":{"path":"bitbucket-mass-hook-manipulation"},"meta":{"title":""},"headings":[{"value":"Bitbucket mass hook addition"}],"html":"<h1>Bitbucket mass hook addition</h1>\n<p>Suppose you have many repositories and wish to ensure that each has slack hook with desired url</p>\n<p>Here is how you can massively update all your repositories with powershell:</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$account</span> = <span class=\"token string\">'rabotaua'</span>\n<span class=\"token variable\">$slackDesiredUrl</span> = <span class=\"token string\">'https://hooks.slack.com/services/*********/*********/************************'</span>\n<span class=\"token variable\">$slackHookName</span> = <span class=\"token string\">'Slack'</span>\n<span class=\"token variable\">$username</span> = <span class=\"token string\">'mac2000'</span>\n<span class=\"token variable\">$password</span> = <span class=\"token string\">'*******************'</span>\n\n<span class=\"token variable\">$authorization</span> = <span class=\"token namespace\">[System.Convert]</span>::ToBase64String<span class=\"token punctuation\">(</span><span class=\"token namespace\">[System.Text.Encoding]</span>::ASCII<span class=\"token punctuation\">.</span>GetBytes<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$username</span><span class=\"token punctuation\">)</span></span>:<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$password</span><span class=\"token punctuation\">)</span></span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token variable\">$headers</span> = @<span class=\"token punctuation\">{</span> Authorization = <span class=\"token string\">\"Basic <span class=\"token variable\">$authorization</span>\"</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$hookBody</span> = @<span class=\"token punctuation\">{</span>\n\tdescription = <span class=\"token variable\">$slackHookName</span>\n\turl = <span class=\"token variable\">$slackDesiredUrl</span>\n\tactive = <span class=\"token boolean\">$true</span>\n\tevents = @<span class=\"token punctuation\">(</span><span class=\"token string\">'repo:push'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$repositories</span> = @<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token variable\">$response</span> = @<span class=\"token punctuation\">{</span> next = <span class=\"token string\">\"https://api.bitbucket.org/2.0/repositories/<span class=\"token variable\">$account</span>\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token variable\">$response</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token operator\">-</span>Uri <span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>next\n\t<span class=\"token variable\">$repositories</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>values\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span>\n<span class=\"token function\">Write-Host</span> <span class=\"token string\">\"Retrieved <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$repositories</span><span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">)</span></span> repositories from `\"<span class=\"token variable\">$account</span>`\" account\"</span> <span class=\"token operator\">-</span>ForegroundColor Cyan\n\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$repository</span> in <span class=\"token variable\">$repositories</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">Write-Host</span> <span class=\"token variable\">$repository</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">-</span>NoNewline\n\t<span class=\"token variable\">$hooks</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token operator\">-</span>Uri <span class=\"token variable\">$repository</span><span class=\"token punctuation\">.</span>links<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span>href\n\t<span class=\"token variable\">$slackHook</span> = <span class=\"token variable\">$hooks</span><span class=\"token punctuation\">.</span>values <span class=\"token punctuation\">|</span>? description <span class=\"token operator\">-EQ</span> <span class=\"token variable\">$slackHookName</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">select</span> <span class=\"token operator\">-</span>First 1\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$slackHook</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$slackHook</span><span class=\"token punctuation\">.</span>url <span class=\"token operator\">-ne</span> <span class=\"token variable\">$slackDesiredUrl</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Put <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token operator\">-</span>Uri <span class=\"token variable\">$slackHook</span><span class=\"token punctuation\">.</span>links<span class=\"token punctuation\">.</span>self<span class=\"token punctuation\">.</span>href <span class=\"token operator\">-</span>ContentType <span class=\"token string\">'application/json'</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span><span class=\"token variable\">$hookBody</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Json</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Out-Null</span>\n\t\t\t<span class=\"token function\">Write-Host</span> <span class=\"token string\">\" existing hook updated\"</span> <span class=\"token operator\">-</span>ForegroundColor Yellow\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">Write-Host</span> <span class=\"token string\">\" nothing to do\"</span> <span class=\"token operator\">-</span>ForegroundColor Cyan\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Post <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token operator\">-</span>Uri <span class=\"token variable\">$repository</span><span class=\"token punctuation\">.</span>links<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span>href <span class=\"token operator\">-</span>ContentType <span class=\"token string\">'application/json'</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span><span class=\"token variable\">$hookBody</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Json</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Out-Null</span>\n\t\t<span class=\"token function\">Write-Host</span> <span class=\"token string\">\" new hook created\"</span> <span class=\"token operator\">-</span>ForegroundColor Green\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>"}},"pageContext":{"id":"9c6145ab-f461-5ea8-bdc9-24112c28f32a"}},"staticQueryHashes":[]}