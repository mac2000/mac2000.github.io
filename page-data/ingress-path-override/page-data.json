{"componentChunkName":"component---src-templates-note-js","path":"/ingress-path-override/","result":{"data":{"remark":{"fields":{"path":"ingress-path-override"},"meta":{"title":""},"headings":[{"value":"Kubernetes Ingress Path Override"},{"value":"Ingress to AWS S3"}],"html":"<h1>Kubernetes Ingress Path Override</h1>\n<p>Suppose we have an old website and page by page rewriting it to something new</p>\n<ul>\n<li>We have some project <code class=\"language-text\">demo.mac-blog.org.ua</code></li>\n<li>It has few endpoints:\n<ul>\n<li><code class=\"language-text\">/</code></li>\n<li><code class=\"language-text\">/about/</code></li>\n<li><code class=\"language-text\">/about/company/</code></li>\n<li><code class=\"language-text\">/contacts/</code></li>\n</ul>\n</li>\n</ul>\n<p>Lets deploy <code class=\"language-text\">old.yml</code> (simple deployment, nothing special)</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">index.html</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"HOME OLD\\n\"</span>\n  <span class=\"token key atrule\">about.html</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ABOUT OLD\\n\"</span>\n  <span class=\"token key atrule\">company.html</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ABOUT COMPANY OLD\\n\"</span>\n  <span class=\"token key atrule\">contacts.html</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"CONTACTS OLD\\n\"</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> old\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> old\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> old\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">kubernetes.io/os</span><span class=\"token punctuation\">:</span> linux\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 500m\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 500Mi\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 50m\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 100Mi\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old<span class=\"token punctuation\">-</span>home\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old<span class=\"token punctuation\">-</span>about\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html/about\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old<span class=\"token punctuation\">-</span>about<span class=\"token punctuation\">-</span>company\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html/about/company\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old<span class=\"token punctuation\">-</span>contacts\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html/contacts\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old<span class=\"token punctuation\">-</span>home\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n            <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> index.html\n                <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> index.html\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old<span class=\"token punctuation\">-</span>about\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n            <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> about.html\n                <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> index.html\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old<span class=\"token punctuation\">-</span>about<span class=\"token punctuation\">-</span>company\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n            <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> company.html\n                <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> index.html\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old<span class=\"token punctuation\">-</span>contacts\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n            <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> contacts.html\n                <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> index.html\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> old\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> demo.mac<span class=\"token punctuation\">-</span>blog.org.ua\n    <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> old\n            <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n        <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific</code></pre></div></p>\n<p>And check it inside our cluster</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> old.yml\n\nkubectl get po <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>old\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/\n<span class=\"token comment\"># HOME OLD</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/about/\n<span class=\"token comment\"># ABOUT OLD</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/about/company/\n<span class=\"token comment\"># ABOUT COMPANY OLD</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/contacts/\n<span class=\"token comment\"># CONTACTS OLD</span></code></pre></div>\n<p>Ingress allows us to override upstream services by url prefix</p>\n<p>Lets imagine that our new version of web site has only \"about\" page ready</p>\n<p>Deploy <code class=\"language-text\">new.yml</code> (once again nothing fancy, usual deployment, BUT, it has the same domain as in <code class=\"language-text\">old.yml</code>, and path is changed from <code class=\"language-text\">/</code> to <code class=\"language-text\">/about</code>)</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">about.html</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ABOUT NEW\\n\"</span>\n  <span class=\"token key atrule\">company.html</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ABOUT COMPANY NEW\\n\"</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> new\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> new\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> new\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">kubernetes.io/os</span><span class=\"token punctuation\">:</span> linux\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 500m\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 500Mi\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 50m\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 100Mi\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new<span class=\"token punctuation\">-</span>about\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html/about\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new<span class=\"token punctuation\">-</span>about<span class=\"token punctuation\">-</span>company\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html/about/company\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new<span class=\"token punctuation\">-</span>about\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n            <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> about.html\n                <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> index.html\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new<span class=\"token punctuation\">-</span>about<span class=\"token punctuation\">-</span>company\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n            <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> company.html\n                <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> index.html\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> new\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># POI: DNS is the same</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> demo.mac<span class=\"token punctuation\">-</span>blog.org.ua\n    <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n            <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n        <span class=\"token comment\"># POI: but path is different</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /about\n        <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific</code></pre></div></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> new.yml\n\nkubectl get po <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>new\n\nkubectl get ing <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-E</span> <span class=\"token string\">\"old|new\"</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/\n<span class=\"token comment\"># HOME OLD &lt;- still served by old service</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/about/\n<span class=\"token comment\"># ABOUT NEW &lt;- served by new service</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/about/company/\n<span class=\"token comment\"># ABOUT COMPANY NEW &lt;- served by new service</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/contacts/\n<span class=\"token comment\"># CONTACTS OLD &lt;- still served by old service</span></code></pre></div>\n<p>If we do not want to serve all about sub routes, but only about page, for that we may change path type to exact, more details about this setting can be found here <a href=\"https://kubernetes.io/docs/concepts/services-networking/ingress/#path-types\">https://kubernetes.io/docs/concepts/services-networking/ingress/#path-types</a></p>\n<p>Lets deploy next variation <code class=\"language-text\">new2.yml</code></p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">about.html</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ABOUT NEW\\n\"</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> new\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> new\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> new\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">nodeSelector</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">kubernetes.io/os</span><span class=\"token punctuation\">:</span> linux\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n        <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 500m\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 500Mi\n          <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 50m\n            <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 100Mi\n        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new<span class=\"token punctuation\">-</span>about\n            <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html/about\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new<span class=\"token punctuation\">-</span>about\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n            <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> about.html\n                <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> index.html\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> new\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># POI: DNS is the same</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> demo.mac<span class=\"token punctuation\">-</span>blog.org.ua\n    <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> new\n            <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n        <span class=\"token comment\"># POI: but path is different</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /about/\n        <span class=\"token comment\"># POI: changed from \"ImplementationSpecific\" to \"Exact\"</span>\n        <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> Exact</code></pre></div></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> new.yml\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/\n<span class=\"token comment\"># HOME OLD &lt;- still served by old service, ok</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/about/\n<span class=\"token comment\"># ABOUT NEW &lt;- served by new service, what we want</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/about/company/\n<span class=\"token comment\"># ABOUT COMPANY OLD &lt;- what we wanted, only concrete endpoint is served by new service</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/contacts/\n<span class=\"token comment\"># CONTACTS OLD &lt;- still served by old service</span></code></pre></div>\n<p>Note that if we delete this new ingress, requests will still work and will be served by old implementation</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl delete ing,svc,deployment new\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> demo.mac-blog.org.ua:80:20.13.179.68 http://demo.mac-blog.org.ua/about/\n<span class=\"token comment\"># ABOUT OLD &lt;- expected, we have removed new.yml which did override that</span></code></pre></div>\n<p>To cleanup everything</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubectl delete ing,svc,deployment old</code></pre></div>\n<h1>Ingress to AWS S3</h1>\n<p>Here is how we can create something similar to AWS S3 static site with help of Ingress, but even more, we are going to serve single file on main domain</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># Note: our service points to another domain instead of pods</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> s3\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ExternalName\n  <span class=\"token key atrule\">externalName</span><span class=\"token punctuation\">:</span> s3.eu<span class=\"token punctuation\">-</span>central<span class=\"token punctuation\">-</span>1.amazonaws.com\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> s3\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># POI: rewrite target, can use regex, simplified for demo</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/rewrite-target</span><span class=\"token punctuation\">:</span> /static.mac<span class=\"token punctuation\">-</span>blog.org.ua/sitemap.xml\n    <span class=\"token comment\"># POI: optional, because of host S3 works we override host as well</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/upstream-vhost</span><span class=\"token punctuation\">:</span> s3.eu<span class=\"token punctuation\">-</span>central<span class=\"token punctuation\">-</span>1.amazonaws.com\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># POI: main website</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> mac<span class=\"token punctuation\">-</span>blog.org.ua\n    <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> s3\n            <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n        <span class=\"token comment\"># POI: we want to serve only this path</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /sitemap.xml\n        <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific</code></pre></div></p>\n<h2>Ingress to external service</h2>\n<p>Also we may configure everything in a such a way so it does not matter if for example our old site is running outside Kubernetes</p>\n<p><a href=\"https://mac-blog.org.ua/ingress-external-ip\">ingress external ip</a></p>\n<p>With all such approaches Ingress may become single entry point for everything which has its benefits, especially after tuning its <a href=\"https://mac-blog.org.ua/http-compression\">compression</a></p>"}},"pageContext":{"id":"0f588551-8fcc-5ca4-8cdf-00faa1ae3e60"}},"staticQueryHashes":[],"slicesMap":{}}