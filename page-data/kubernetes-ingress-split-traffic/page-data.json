{"componentChunkName":"component---src-templates-note-js","path":"/kubernetes-ingress-split-traffic/","result":{"data":{"remark":{"fields":{"path":"kubernetes-ingress-split-traffic"},"meta":{"title":""},"headings":[{"value":"Kubernetes Ingress Split Traffic"},{"value":"Контекст"},{"value":"Как это работает"},{"value":"Клонирование"},{"value":"Пример"},{"value":"Очистка"},{"value":"Метрики"},{"value":"Зачем это может быть полезным"},{"value":"History: employer-api-test"},{"value":"canary-by-cookie"},{"value":"canary-by-header"}],"html":"<h1>Kubernetes Ingress Split Traffic</h1>\n<h1>Контекст</h1>\n<p>Ковыряясь с employer api был момент когда мы выдвинули гипотезу о том что было бы стратежнее переключиться на redis бегущий в нашем кластере</p>\n<p>Было бы круто, если бы мы могли, точечно, для пары под сделать такое переключение, что бы посмотреть что будет</p>\n<p>В текущем сетапе, такое переключение это билет в один конец и переключить можно только все</p>\n<p>Эта заметка, будет на это примере описывать как поднять временное решение которое позволит проверить подобную гипотезу</p>\n<h1>Как это работает</h1>\n<p>Есть несколько способов провернуть такой трюк, в этой заметке мы пойдем пожалуй самым длинным, но в месте с тем и самым гибким</p>\n<p>На деле мы подымем рядом еще одну копию сервиса, назовем ее employer-api-test, подымать будем deployment, service и ingress</p>\n<p>В ingress будет внесено всего пара мелко правок которые и сделают всю магию</p>\n<p>На выходе в Kubernetes у нас будут крутиться х2 deployment, service, ingress для employer api, при этом на новосозданную копию мы будет отправлять N% трафика</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 694px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3a5ee4e5b75ca633e62b762b57d9cb55/31198/image-20240110-144802.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 113.28125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAACj0lEQVR42pWU6XLaQBCE9SQhGCEOHSAECCFxG+zgSlwVv/+zTOYbeykhSCr8mGLZo7d7ulfeUy+RZrWDWJ76I+kOUxmM5tJPZja+rN0548q7mdQD/mAs8WQpo2klw1EuYbqwcZgW0tG1hwC/dyMZKKNIQcbztRzOH7I5/pLRrDJg2LZ1z/8z/KrhOFeQlaT5xsDGOh6q/I624jHJNabI7vRGEkSZRDpu+aF86wxt7SFAGt9TkO3Lu8r9KUE4UVMmki33sj//liQr/wrq1UEoNjpTqIlKBpD5yWIrWbG1y/h/z3HPgRELNg6SuZT7s/Wt5Q9Noh0MEmOWr47Sj6fS0+JMOwAovgbEgGRaXhrv2MXZUrrKDobRpLD1ROecYZwJdVw3yuuGqR4sLcAH7c/29C7F9tXAYgXhAouLMoLd89uHVPs3mVfPBuwudfI9ZwALUVaY1EgDzP9wvLjcTC5hScCRzhoqOFvvpVc3BDOQQW+QUXfSjVECmHsxTWOuXMYAnASQzDU3t3QdM3hBF7OaLjMJG/rBk5uVe2PJ/+BLjrVFgWBHK6aaR8YUTK8kW+ZwThfZSHjNbZzXXmEGF4WWhEpm1cGeI2W91j76tQ+GAbJAVZq/vDrKYnNSWSt7bg4QNrPyIMXmRRbrk7nsjLoCNMk6wYEgzC6sYNyrSe7HM5MNU0B6ES3Ixe+Pb12uO42Dblzf+PksQ7sU4Hum3QVc7n5YkDnQ3Mwcj6DYvN5ceJND3jDskIwkqv6kGDP3+ewqM8M+ts0cMmFvVVml+VrK3dkc5CAXuK8KrClMoYgW6fAH6W0PuZ3NWbGTTIONw0SEfrnNZJJAEy1+nZJ/fmBhiptI8RuBdU/TxYgE3PvA/gEvpL0QCKGXGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20240110-144802.png\"\n        title=\"\"\n        src=\"/static/3a5ee4e5b75ca633e62b762b57d9cb55/31198/image-20240110-144802.png\"\n        srcset=\"/static/3a5ee4e5b75ca633e62b762b57d9cb55/6f3f2/image-20240110-144802.png 256w,\n/static/3a5ee4e5b75ca633e62b762b57d9cb55/01e7c/image-20240110-144802.png 512w,\n/static/3a5ee4e5b75ca633e62b762b57d9cb55/31198/image-20240110-144802.png 694w\"\n        sizes=\"(max-width: 694px) 100vw, 694px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Что важно: ingress нашего клона будет один в один такой же как и оригинальный, НО, в нем будет две дополнительные аннотации, которые и сделают весь трюк:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span> <span class=\"token comment\"># enables traffic split</span>\n<span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-weight</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5\"</span> <span class=\"token comment\"># send 5% of traffic to this ingress</span></code></pre></div>\n<h1>Клонирование</h1>\n<p>Тут никакого ракетостроения</p>\n<p>делаем, условный <code class=\"language-text\">kubectl get deployment employer-api -o yaml > deployment.yml</code>, затем из него удаляем все лишнее (то что мы не добавляли бы, создавая yaml руками)</p>\n<p>выглядит приблизительно вот так:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/35d166f178b68b5502d46145ff989ac2/4ee93/image-20240110-145200.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.96875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAADCElEQVR42o2TS2/VRhiGrS4SJSwj6LnYnhnb4/HM8f2cBM45XMqlWSB10YuUFjVpRAEhqiqxCCwqSlf9hfwEhFforFghj95+DjlU3XXxaCz7m9fvd3NmuXjocvdsPByeemOv8cbjhnlekySmMcY0cRw3RVY0RVE0jLFGCNF49H0wGJwzpHta6zOK+9VxnE1HCPZOaQ0/CK3r+/AEJwLEkwxxmiFINEQYIgwj+IyBMR++78F13XNI3MaxAuf83fb29tAZue5bHUncLvY+LpOsm0dxt5BJtwijbslZd8P3u8IddyyUndRFx3nQ+YzTKdZ8JDCvyrdVpUbOiLF2NxA4STP7YjbD6bTEb0WOZ1mKZ0WGk4nG/YAj0hF2r9dYLEvM93JM6xRlaVBWxpb1BPdvLdqqqkbO2PPaghx+n8/sQVnjMFU4MhI/92iJwzjEDc4gZARTFMjzCeqchDKDIjWocmNzer6ampbSHzlXhsN2KiWO8to+yKcklOExCT01MR6qEE+kwD7n0LXB3W+u4t5+jjvE/G5yzrXbiV3uG9wseLvlbI2cHRKcRyGe55Vtdq+jmS7wcrqHv2Y1XpHb1xHHd8wDo5iMnKxJM73GZuTYyLDd2iLByyR4LYpwQoK/z+Y4raY4yyY4TRKcxBJ/xAG+FayfAiRKQ8UJlPoPNqFJUFHQ7uysBak+z7PCvqxneJEXeEUNeG0i/DmR+DtT+CHkJBjA0E/UBcm/WK2ploFod3qHfQ3rvoblzD6pazzKMxyriOoX4Zga8pjYpy5zmkOdFsiMwUQnoEFeY2OlsBT8k+CXvSClcpCW9kE6oQ73XY7xE7k6ED5+9Mf4imoopEJ/MaZsJJVCys/YXjhZD7bLeTujwKN6bg/rPepyimMZ4BcSO6LaPQoYvqaxCWgbJmmOhLZKUfw6ZXq2/SmC4FNTaDffCME/KJO/DwK5cofDz4wvGA0GK8b5Sup8FatklSi1IlcrcrciwfdaJx9oz99cuuRcoX12XEIS0f9hc7Nn85z1u42NDXmh88U/Fcdwd23YLP0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20240110-145200.png\"\n        title=\"\"\n        src=\"/static/35d166f178b68b5502d46145ff989ac2/2bef9/image-20240110-145200.png\"\n        srcset=\"/static/35d166f178b68b5502d46145ff989ac2/6f3f2/image-20240110-145200.png 256w,\n/static/35d166f178b68b5502d46145ff989ac2/01e7c/image-20240110-145200.png 512w,\n/static/35d166f178b68b5502d46145ff989ac2/2bef9/image-20240110-145200.png 1024w,\n/static/35d166f178b68b5502d46145ff989ac2/71c1d/image-20240110-145200.png 1536w,\n/static/35d166f178b68b5502d46145ff989ac2/a878e/image-20240110-145200.png 2048w,\n/static/35d166f178b68b5502d46145ff989ac2/4ee93/image-20240110-145200.png 2648w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>За для удобства, меняем все <code class=\"language-text\">employer-api</code>, на <code class=\"language-text\">employer-api-test</code></p>\n<p>Перепроверяем <code class=\"language-text\">spec.selector.matchLabels</code> - там нужно будет убрать автобусную лейбу и добавить нашу <code class=\"language-text\">app</code></p>\n<p>Удаляем целиком раздел <code class=\"language-text\">status</code></p>\n<p>Далее нам понадобиться сервис, тут даже не ясно что быстрее вычищать существующий или накалякать свой</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> alexandrm@rabota.ua\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/rabotaua/employerapi\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>test\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>test\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> production\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>test\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP</code></pre></div>\n<p>И сам ingress</p>\n<p>Внимание: тут самый важный сок</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> alexandrm@rabota.ua\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/rabotaua/employerapi\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>test\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>test\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> production\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>test\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/proxy-body-size</span><span class=\"token punctuation\">:</span> 10m\n    <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> alexandrm@rabota.ua\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/rabotaua/employerapi\n    <span class=\"token comment\"># POI: enables traffic split 5%</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-weight</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5\"</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> production\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># POI: DNS is same as in original ingress</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api.rabota.ua\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>test\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api.robota.ua\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> employer<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>test\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> employer<span class=\"token punctuation\">-</span>api.rabota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> wildcard<span class=\"token punctuation\">-</span>tls\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> employer<span class=\"token punctuation\">-</span>api.robota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> robota<span class=\"token punctuation\">-</span>wildcard<span class=\"token punctuation\">-</span>tls</code></pre></div>\n<p>Примечания:</p>\n<ul>\n<li>само DNS имя осталось прежним, то есть оба, оригинальный и клоннированый ingress обслуживают запросы для employer-api.rabota.ua</li>\n<li>в клоннированом ingress добавлены две аннотации включающие сплит трафика и забирающие на себя 5% всех запросов</li>\n</ul>\n<p><strong>Важно:</strong> тут очень легко запутаться, условно забыл поменять имя ингресса, или внутри ингресса забыл поменять селектор для сервиса и оно не работает - нужно пять раз перепроверить что бы везде были новые названия</p>\n<hr>\n<h1>Пример</h1>\n<p>Прикрепляю готовый к использованию пример, с которым можно играться</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">index.html</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    &lt;style>html,body{display:flex;align-items:center;justify-content:center;font-size:25vh}&lt;/style>\n    A</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">index.html</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    &lt;style>html,body{display:flex;align-items:center;justify-content:center;font-size:25vh}&lt;/style>\n    B</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">rollingUpdate</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">maxSurge</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n      <span class=\"token key atrule\">maxUnavailable</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RollingUpdate\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n      <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> alexandrm@rabota.ua\n        <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//hg.nginx.org/nginx/\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n          <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n          <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n          <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 500m\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 500Mi\n            <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 50m\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 100Mi\n          <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n            <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n          <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n              <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n            <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n          <span class=\"token key atrule\">startupProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n              <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n            <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n          <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n              <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html\n      <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">nodeAffinity</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requiredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">nodeSelectorTerms</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> poolDestination\n                    <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                    <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                      <span class=\"token punctuation\">-</span> app\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">rollingUpdate</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">maxSurge</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n      <span class=\"token key atrule\">maxUnavailable</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> RollingUpdate\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n      <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> alexandrm@rabota.ua\n        <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//hg.nginx.org/nginx/\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n          <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n          <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n          <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 500m\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 500Mi\n            <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> 50m\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 100Mi\n          <span class=\"token key atrule\">readinessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n            <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">tcpSocket</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n          <span class=\"token key atrule\">livenessProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n              <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n            <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n          <span class=\"token key atrule\">startupProbe</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">failureThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n            <span class=\"token key atrule\">httpGet</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n              <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n              <span class=\"token key atrule\">scheme</span><span class=\"token punctuation\">:</span> HTTP\n            <span class=\"token key atrule\">periodSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n            <span class=\"token key atrule\">successThreshold</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token key atrule\">timeoutSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n          <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n              <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /usr/share/nginx/html\n      <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">nodeAffinity</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requiredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">nodeSelectorTerms</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> poolDestination\n                    <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                    <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                      <span class=\"token punctuation\">-</span> app\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>ab.rabota.ua\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>ab.robota.ua\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>a\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> nginx<span class=\"token punctuation\">-</span>ab.rabota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> wildcard<span class=\"token punctuation\">-</span>tls\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> nginx<span class=\"token punctuation\">-</span>ab.robota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> robota<span class=\"token punctuation\">-</span>wildcard<span class=\"token punctuation\">-</span>tls\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> alexandrm@rabota.ua\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//hg.nginx.org/nginx/\n    <span class=\"token comment\"># POI: enables traffic split 50%</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-weight</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"50\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># POI: DNS is same as in previous ingress</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>ab.rabota.ua\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>ab.robota.ua\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>b\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> nginx<span class=\"token punctuation\">-</span>ab.rabota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> wildcard<span class=\"token punctuation\">-</span>tls\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> nginx<span class=\"token punctuation\">-</span>ab.robota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> robota<span class=\"token punctuation\">-</span>wildcard<span class=\"token punctuation\">-</span>tls</code></pre></div>\n<p>Пример запроса:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">--resolve</span> nginx-ab.rabota.ua:443:20.101.14.136 https://nginx-ab.rabota.ua/ <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-E</span> <span class=\"token string\">\"A|B\"</span></code></pre></div>\n<p>Если его позапускать, через раз в ответе будет то А то B</p>\n<h1>Очистка</h1>\n<p>Вся прелесть этого подхода, в том что точно так же как и добавляли достаточно удалить deployment, service и ingress</p>\n<p>Или если хотим на время выключить можно удалить только ingress или выставить там 0%</p>\n<h1>Метрики</h1>\n<p>Важный момент, по хорошему мы хотим все это провернуть что бы посмотреть что будет, а куда смотреть и что сравнивать?</p>\n<p>Тут по хорошему нужно что бы у сервиса был прикручен прометей, тогда можно было бы по подам смотреть прямо точечно</p>\n<p>Если метрик никаких нет, то есть вариант посмотреть косвенно через метрики nginx, по типу (тут только кол-во)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sum(rate(nginx_ingress_controller_response_size_count{host=\"employer-api.rabota.ua\",canary=\"\"}[2m]))\n\nsum(rate(nginx_ingress_controller_response_size_count{host=\"employer-api.rabota.ua\",canary!=\"\"}[2m]))</code></pre></div>\n<h1>Зачем это может быть полезным</h1>\n<p>По мимо распределения трафика про процентам, эта штука умеет ориентироваться по заголовкам и печенькам</p>\n<p>Так например, отталкиваясь от заголовка CF-Country мы знаем с какого региона прилетел запрос и могли бы куда то отдельно отправлять всех foreign клиентов, дабы если и будут мучать сервис, то в своей песочнице</p>\n<p>Печенька может быть использована в А/Б тесте, например, мы запускаем новую бета версию и даем пользователям возможность добровольно на нее переключаться, при переключении ему ставиться печенька и все его запросы попадают на новую версию</p>\n<p>И так далее и тому подобное, тут уже на сколько фантазии хватит</p>\n<hr>\n<h1>History: employer-api-test</h1>\n<p>Делалось впервые для копии employer-api-test, соотв в кубере были развернуты deployment, service и ingress</p>\n<p>Отличительная черта копии в том что он ходит в redis внутри кубера, за вместо ажурного</p>\n<p>На этот экземпляр отправлено 5% трафика</p>\n<p>Преследуемая цель: посмотреть будет ли разница, но в виду отсуствия метрик пока это не представляется возможным, потом это дело остается как есть до момента если снова что грохнеться</p>\n<p>Сам yml пока не прикрепляю т.к. там с одной стороны ничего полезного и интересного нет, а с другой, там в env все все секреты продовские</p>\n<hr>\n<h1>canary-by-cookie</h1>\n<p><strong>Передумова</strong>: ми хочемо паралельно розвернути клон-сервісу або нову версію і перевести трафік щоб протестувати ізольовано.</p>\n<p>В нашому випадку це сервіс авторизації і хочемо перевірити флоу як наший фронтовий клієнт буде повноцінно взаємодіяти з ним, а не точково кидати запити на різні ендпоінти</p>\n<p>Нам буде корисною наступна анотація (<a href=\"https://github.com/kubernetes/ingress-nginx/blob/main/docs/user-guide/nginx-configuration/annotations.md#canary\">doc</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">nginx.ingress.kubernetes.io/canary-by-cookie</code></pre></div>\n<p>на прикладі міграції auth-api сервіса з .NET Framework → .NET Core я паралельно задеплоїв новий сервіс з відповідним <strong>deployment</strong> + <strong>service</strong> (тут все тривіально і звичайно)</p>\n<p>Цікавіше далі, у нашому випадку <strong>ingress</strong> виглядає так:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"authapi\"</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"authapi\"</span>\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-by-cookie</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"netcore\"</span>\n    <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"vadimk@rabota.ua\"</span>\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/rabotaua/auth-api\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"auth-api.dev.rabota.ua\"</span>\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"authapi\"</span>\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"auth-api.dev.robota.ua\"</span>\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"authapi\"</span>\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> ImplementationSpecific\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> auth<span class=\"token punctuation\">-</span>api.dev.rabota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> wildcard<span class=\"token punctuation\">-</span>tls\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> auth<span class=\"token punctuation\">-</span>api.dev.robota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> robota<span class=\"token punctuation\">-</span>wildcard<span class=\"token punctuation\">-</span>tls</code></pre></div>\n<p>в загальному нічим не відрізняється від типового, але тут з‘явилось декілька цікавих для нас анотацій:</p>\n<p>перша вмикає власне сам механізм:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span></code></pre></div>\n<p>друга визначає куку, на яку ми будемо орієнтуватись, щоб спрямувати трафік на новий сервіс</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-by-cookie</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"netcore\"</span></code></pre></div>\n<p>на практиці нашого цільового сервісу: <a href=\"https://auth-api.dev.rabota.ua/\">https://auth-api.dev.rabota.ua</a> при переході без куки ми потрапляємо в старий свагер: <a href=\"https://auth-api.dev.rabota.ua/swagger/ui/index\">https://auth-api.dev.rabota.ua/swagger/ui/index</a> і відповідно старий сервіс обслуговує трафік (по замовченню в нас стара поведінка)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2acb41f84d3564c5cc4ee19b83326e34/b325c/image-20240509-155625.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.65625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB3klEQVR42p3S3WvTYBTH8f7FEwRvvPFGxAvxQqYiDMELbwQde3G+jCnqnJRua7e2W7u2Wdq8tWmSJnnapk2afn2WDTc3rzzw4ccJz3M4Ccl9a9zjfek2K3sLrO7fYrmwwFb1PjvKIzZrd8g3ljhU1im1lik2lzlQVmh0Nzlov6HSXuPE2uTIWOFT8SEfy3fJ7emL7BtPKZrPKFnPyatP+NV4QbH9iu/1B+wpr6moG5TVdTlslfLpGnXjMw17A8X5Ssf7gepukW8tUWgvkuNaJdMEvxfi2iF9K8Dp+fRMB7vrnqfl0O95zGYp/6rcfD7jTJom2QNd2HxQdhHRkCidEs2kNGYiBbMRXiwYSN2hiyX6f2hBl3E8vtwwnc+zPHZsHm9/QbVMeSnMmKGf0UMPLRygBx6G8P+iiwGjeHo5cH4x0Bz6vDvJc2jUqPSaVPsKqrAwhja6pF3Qr+iIHpp8s3EyuTrwPLvBhLcFnULD4udRh3zdpKz5VPWAilQzQ0lkeWScCTiWfV32Iopvbnga9HlZ2qaqarRsV34bQcvxaDqDTMcP0K5RPJea6yHi5OaGdjhhp27hygOjaMo0SRGThGAcZwaSf2Z0keOEwTDC0XaZBp2bv83/ldwm6kLs8xsw8+Y+vMpl6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20240509-155625.png\"\n        title=\"\"\n        src=\"/static/2acb41f84d3564c5cc4ee19b83326e34/2bef9/image-20240509-155625.png\"\n        srcset=\"/static/2acb41f84d3564c5cc4ee19b83326e34/6f3f2/image-20240509-155625.png 256w,\n/static/2acb41f84d3564c5cc4ee19b83326e34/01e7c/image-20240509-155625.png 512w,\n/static/2acb41f84d3564c5cc4ee19b83326e34/2bef9/image-20240509-155625.png 1024w,\n/static/2acb41f84d3564c5cc4ee19b83326e34/71c1d/image-20240509-155625.png 1536w,\n/static/2acb41f84d3564c5cc4ee19b83326e34/a878e/image-20240509-155625.png 2048w,\n/static/2acb41f84d3564c5cc4ee19b83326e34/b325c/image-20240509-155625.png 2770w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>для тесту нового сервісу нам потрібно засетити куку <code class=\"language-text\">netcore</code> з значенням <code class=\"language-text\">always</code></p>\n<p>у нашому випадку надійніше сетить куку не на рівні домену <a href=\"http://auth-api.dev.rabota.ua\">auth-api.dev.rabota.ua</a> → а на рівні .dev.rabota.ua &#x26;&#x26; .dev.robota.ua одночасно</p>\n<p>валідними значеннями можуть бути лише 2 значення: <code class=\"language-text\">always</code> і <code class=\"language-text\">newer</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9cd2e452fadcbe935a2036d764a16208/28fe3/image-20240509-155747.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.09375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAoklEQVR42qXOPQ/CIBgEYP7/D3N0cPCjorZV2lJoAVsKtMOJxEQdnBye3OXyhkBKdoDUVzBxTFp1iZmh5HtwdUbd0eiEG8+Qsy2a2CtJIe8FhIl0njxvankCaXgB5xWMbaCHOqUNAlPoMM0dXNLHTcJ6gcG3GFyL8dVH/9kFyIaukLE1tK3Sw1Po4Wf9g0kZFvPelu+N5PUOlaBwSx9/ov72AJATMAQMRxiSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20240509-155747.png\"\n        title=\"\"\n        src=\"/static/9cd2e452fadcbe935a2036d764a16208/2bef9/image-20240509-155747.png\"\n        srcset=\"/static/9cd2e452fadcbe935a2036d764a16208/6f3f2/image-20240509-155747.png 256w,\n/static/9cd2e452fadcbe935a2036d764a16208/01e7c/image-20240509-155747.png 512w,\n/static/9cd2e452fadcbe935a2036d764a16208/2bef9/image-20240509-155747.png 1024w,\n/static/9cd2e452fadcbe935a2036d764a16208/71c1d/image-20240509-155747.png 1536w,\n/static/9cd2e452fadcbe935a2036d764a16208/a878e/image-20240509-155747.png 2048w,\n/static/9cd2e452fadcbe935a2036d764a16208/28fe3/image-20240509-155747.png 3446w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>після перезавантаження сторінки потрапимо в новий сервіс, де свагер урла відрізняється: <a href=\"https://auth-api.dev.rabota.ua/swagger/index.html\">https://auth-api.dev.rabota.ua/swagger/index.html</a></p>\n<p>в нашому випадку навіть візуально видно різницю, якщо не вдаватись в деталі!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e90f90d82a97bdf9b7a8855e4d7320f5/f7171/image-20240509-155934.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.984375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACL0lEQVR42qWRS2/TQBDH/VEQlIKgQLkgREFAoQRVKp8CEK8iPgQPNSRKS5MLEhLfgBMc4BqkQoFDVamCvqLEiR+xd/1cJ37kz9imKVAEB8b6eWZnZmdnZ6Xa8xcoLSzi4dxTPC6VMVepoFKroVyt4vXbN/jweQn1pTqWv3xCffkdXr4qojg/jyel0pBHxSLKz6pYWKxB2j8yhvEzJzExeRFHx05h9PA4Dh46jpHRY5g4N4nC1RlcmprGlcIMCtMFnD5/ApcL13Dz7n3cuDOL67fv4dbsA5y9MIV9B45A4pyh3Wnh67cNrG+tQes2wBkDYwZ0XYOiKFBVgrSu6WCmBSF8AIOfAHzfhWl2IaWLfhiBOwGCfo/CMf4mA/qSJEEURRlhFNL+MPOlIg0GA/yPBAk1E/qIkhhpLSmmU5jnYE1uwLQs2L4HJ0V4uS3+jU3XFb0AIXUqDeIEDa7hfZPmx0yo3ETX4ejaHLrNcpvQLTb07ZLnpXGX5hrR6KQkitFxDKyom+CeDdOxYFBCiulatIEeiPxuz4fzg99tS7jwgp2CcQSZ+fi4YdCVXVheL8P2+7/giJBG0d/jT+FuANcX9EhhXlDlAisNlgW428s0c/byp4NSGOV7frBbUDZ81Fc72Gy0sb7dhqya1K0Hg7uEhy7pFOaI4Q0sL8iwyWaugCd2CtJPtftYlQVaiommwtBSGbZaGrZlnbSerdu6BVnjaKppnOdouVYMhwr2aYYhvgP9clyQqTNOvgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20240509-155934.png\"\n        title=\"\"\n        src=\"/static/e90f90d82a97bdf9b7a8855e4d7320f5/2bef9/image-20240509-155934.png\"\n        srcset=\"/static/e90f90d82a97bdf9b7a8855e4d7320f5/6f3f2/image-20240509-155934.png 256w,\n/static/e90f90d82a97bdf9b7a8855e4d7320f5/01e7c/image-20240509-155934.png 512w,\n/static/e90f90d82a97bdf9b7a8855e4d7320f5/2bef9/image-20240509-155934.png 1024w,\n/static/e90f90d82a97bdf9b7a8855e4d7320f5/71c1d/image-20240509-155934.png 1536w,\n/static/e90f90d82a97bdf9b7a8855e4d7320f5/a878e/image-20240509-155934.png 2048w,\n/static/e90f90d82a97bdf9b7a8855e4d7320f5/f7171/image-20240509-155934.png 3456w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<hr>\n<h1>canary-by-header</h1>\n<p>Еще один пример применения на практике распределения трафика между сервисами, но уже по хедеру.</p>\n<p><strong>Контекст проблемы</strong>, которую нужно было решить asap</p>\n<p>Приложение alliance-deskop обслуживает запросы как от пользователей чисто за “статикой” (скрипты, стили, иконки для SPA-части основного продукта), так и запросы за SEO-значимыми страницами (пресловутый server side rendering), за которыми приходят боты (Google, OpenAI, facebook, telegram, viber, etc).</p>\n<p>При наплыве запросов за ssr-страницами от ботов периодически ловим скейл в полку с выеданием всех отведенных ресурсов, а следом и увеличение времени отклика.</p>\n<p>Поскольку одно приложение обслуживает 2 функции, то такая ситуация цепляет и реальных пользователей - у них также начинает долго грузиться наш сайт, бо запросы за скриптами/стилями идут в “общую очередь”.</p>\n<p><strong>Идея:</strong> а что если эти 2 функции разделить и положить на плечи двух отдельных сервисов? (чтобы снять негативное влияние на пользователей)</p>\n<p>Собственно, идея валидная, квик-вин можно получить, а как сделать?</p>\n<p>Вот тут и пригодилась фишка с canary и сплитом трафика.</p>\n<p><strong>Шаг 1</strong></p>\n<p>Порождаем сервис-копию нашего alliance-desktop-а. Причем буквально - путем ctrl C, ctrl V текущей структуры в <a href=\"https://github.com/rabotaua/kube/tree/main/prod/alliance-desktop\">kube</a>.</p>\n<p>Для иллюстрации yml service-a:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alliance<span class=\"token punctuation\">-</span>desktop<span class=\"token punctuation\">-</span>temp\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> alliance<span class=\"token punctuation\">-</span>desktop<span class=\"token punctuation\">-</span>temp\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> alliance<span class=\"token punctuation\">-</span>desktop<span class=\"token punctuation\">-</span>temp\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alliance<span class=\"token punctuation\">-</span>desktop<span class=\"token punctuation\">-</span>temp\n      <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n      <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n      <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> http</code></pre></div>\n<p><strong>Важно</strong>:</p>\n<ul>\n<li>сделать уникальное имя для копии (иначе просто не сработает kubectl apply)</li>\n<li>пометить уникальной label-ой (нужно ж их как-то различать в метриках / логах / etc)</li>\n</ul>\n<p><strong>Шаг 2</strong></p>\n<p>Заводим рядом свой отдельный ingress с нужной магией для сплита:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alliance<span class=\"token punctuation\">-</span>desktop<span class=\"token punctuation\">-</span>temp\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> production\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> alliance<span class=\"token punctuation\">-</span>desktop<span class=\"token punctuation\">-</span>temp\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-by-header</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"User-Agent\"</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-by-header-pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\".*(mactemp|foo bar|foo-bar|bot|spider|crawl|APIs-Google|AdsBot|Googlebot|mediapartners|Google Favicon|FeedFetcher|Google-Read-Aloud|DuplexWeb-Google|googleweblight|ia_archiver|facebook|instagram|pinterest|reddit|slack|twitter|whatsapp|youtube|telegram|viber|Google-InspectionTool|AhrefsBot|AhrefsSiteAudit).*\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ingressClassName</span><span class=\"token punctuation\">:</span> external\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> robota.ua\n      <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> alliance<span class=\"token punctuation\">-</span>desktop<span class=\"token punctuation\">-</span>temp\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n            <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> Prefix\n  <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> robota.ua\n      <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> robota<span class=\"token punctuation\">-</span>wildcard<span class=\"token punctuation\">-</span>tls</code></pre></div>\n<p>В нем \"говорим\", что хотим обслуживать host: <a href=\"http://robota.ua\">robota.ua</a> нашим новым приложением-копией alliance-desktop-temp, НО не всё, а по условию.</p>\n<p>Здесь важны следующие аннотации:</p>\n<ul>\n<li>опция, которая включает возможность сплитить трафик:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span></code></pre></div>\n<p><strong>Примечание:</strong>  без нее kubectl apply выдаст с ходу ошибку, мол, \"точно такой же host уже обслуживается другим приложением\"</p>\n<ul>\n<li>указываем, что хотим сплитить по хедеру и какому</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-by-header</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"User-Agent\"</span></code></pre></div>\n<p><strong>Примечание:</strong> именно по User-Agent-у умеем отличать ботов, которым нужны ssr-ные страницы</p>\n<ul>\n<li>указываем паттерн значения этого самого хедера</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-by-header-pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\".\\*(foo bar|foo-bar|Google|etc)\\*\"</span></code></pre></div>\n<p><strong>Примечание:</strong> опция позволяет описать регулярным выражением значение хедера.<br>\nТакже есть опция под точное значение:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">nginx.ingress.kubernetes.io/canary-by-header-value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"i_am_batman\"</span></code></pre></div>\n<p><strong>Шаг 3.</strong> Применяем и молимся проводим такой финт сначала на тестовой среде и проверяем, что ничего не сломали, а потом применяем и молимся.</p>\n<p>Когда отпадет нужна в таком финте ушами, будет достаточно удалить добавленный ingress (если быстро и ненадолго) или прям всё (по финализации).<br>\nУдобство отдельного как раз в этом - одним движением можно быстро вернуть всё взад.</p>\n<p>ПР со всеми изменениями <a href=\"https://github.com/rabotaua/kube/pull/9318\">тут</a></p>\n<p>Демонстрация разделения трафика в графиках и цифрах:</p>\n<p>![Screenshot 2025-07-31 at 19.10.00.png](Screenshot 2025-07-31 at 19.10.00.png)</p>\n<p>![Screenshot 2025-07-31 at 19.11.11.png](Screenshot 2025-07-31 at 19.11.11.png)</p>\n<hr>\n<p>Важно: проводя такой эксперимент важно помнить что ингрес нового сервиса, это отдельный ингресс с другим именем. Если по ошибке обозвать его так же само как и оригинальный - он просто перетрет его и все пойдет наперекосяк</p>"}},"pageContext":{"id":"4a772fca-1d03-58ac-be49-2cb5316aec94"}},"staticQueryHashes":[],"slicesMap":{}}