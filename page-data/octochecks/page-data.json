{"componentChunkName":"component---src-templates-note-js","path":"/octochecks/","result":{"data":{"remark":{"fields":{"path":"octochecks"},"meta":{"title":""},"headings":[{"value":"octochecks"}],"html":"<h1>octochecks</h1>\n<p>In our case we do allow engineers to create and edit projects in Octopus Deploy</p>\n<p>But as a result it is hard to maintain some wanted policies (like ensure each project has owner variable or that Kubernetes deployments have resources and so on)</p>\n<p><a href=\"https://help.octopus.com/t/custom-validation-for-projects/29017/8\">Asked</a> community but it seems that at moment there is no built in way to achieve that</p>\n<p>But there is an \"workaround\" which not fully solve the issue but will allow move forward</p>\n<h2>What</h2>\n<p>Here is an idea:</p>\n<ul>\n<li>we will have script template with powershell script that will make sure all checks are green</li>\n<li>external script that will add this script as very first and required step in every project</li>\n<li>subscription pointing to service that will listen for deployments and check if step was disabled, if so - reenable it and post an message to slack</li>\n</ul>\n<p>Notes:</p>\n<ul>\n<li>yes, engineers can still mark step as not required and deploy, but immediatelly it will be marked as required back and sooner or later everyone will be tired of this and will just fix issues</li>\n<li>for external script we may use github action with scheduled workflow or cronjob in Kubernetes</li>\n</ul>\n<h2>Checks</h2>\n<p>Lets start simple with checks script, to make things clear I am going to use example that will check that project has owner variable being set, but technically it can do way more checks</p>\n<p>Also for script to work we need Octopus API Key variable</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3adb29dcd9378528030f7fae3eeaa90e/8adb9/parameter.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 96.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAACuklEQVR42pVUTW8SURSdP+bCrRsXJurOhQsXGq1iKAzzyaA/wYWrunPhWpMGba0JQVNaoMxMqNGYiDBDCy0w3x8ccx+ltqXVOsnJu29y33nn3HtnuCs3l3D19hJW3rzDh8oWypUtVBttbNRMVOttbGzqqNR28Kmmo1JvY33TxNqmiS8NEzvmV6x+rOLWvRxu3M3g2p0MuGeaClUWYZomgjCC7/u4zDOdTtna7/dR0oqQJRElVQGXz+chCgJq9R38sA7xvWOja/cRJAn8KIEfzuDN42gGL4wRp8Cvbg+aVgRfEJDJCTNCSRTR0g2MHA/2/hBWfwS7P8Fw5OBg7J4CvSMMDifwoxRdy0appIEXRDxeFsHJiorlvIBmyyAfCMMQUZAidBMcufqnZU3TIEkSVEUGl13O4knmKRqNJuI4RhTHSJIZKI6i6AizmHIIdDGRWpZ1TCjLMjhFkSFLEgxdRxwnrCkEz/MRBAED7U+uBNd1kSQJbNs+TZgrCMjmeVZDupGS/rfLqqpCEASIogju4VIBDx7l0WzqSBOyE1E6Ax26CGmaMsIFhZIoQeAFtIw2DkLg58BH7zBAZ+gjiKgxKTt8FnMnVMNiscjUESkniAIKBR66YcDzQ0wcB57vw3U9Vkeq23llmFsmhYqioFAoMNscBTzPY3t7m9Wj1+thf28P49Ho2NrfFHa7XUZIHMTFCGm4dV1nozCZTOCQSs87JqTDZ0GjM7e8QEiber2O4XCIwWDASC/b5U6nc75C+jmQGiIjdZclPFdhLpfD7u4uS5iPw19H5sS89iyLjcuCwlarxb6A8XjMVJ5cqaZ/4gl8z4HrOGxcbcteJDxP4UVPkE7hJcC3gz2smGt4XXsPTS0yUacUlstlRkpKDcNgXT8Lw9DxeauJ9aqOV6tvcf1FFvdfPkdRUZE/UvgbyBEo3gkMxgkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"octopus api key parameter\"\n        title=\"\"\n        src=\"/static/3adb29dcd9378528030f7fae3eeaa90e/2bef9/parameter.png\"\n        srcset=\"/static/3adb29dcd9378528030f7fae3eeaa90e/6f3f2/parameter.png 256w,\n/static/3adb29dcd9378528030f7fae3eeaa90e/01e7c/parameter.png 512w,\n/static/3adb29dcd9378528030f7fae3eeaa90e/2bef9/parameter.png 1024w,\n/static/3adb29dcd9378528030f7fae3eeaa90e/71c1d/parameter.png 1536w,\n/static/3adb29dcd9378528030f7fae3eeaa90e/8adb9/parameter.png 1638w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Everything else configured with defaults</p>\n<p>Here is starting point:</p>\n<div class=\"gatsby-highlight\" data-language=\"ps1\"><pre class=\"language-ps1\"><code class=\"language-ps1\">if ($OctopusParameters) {\n  $headers = @{&quot;X-Octopus-ApiKey&quot; = $OCTOPUS_APIKEY}\n  $projectId = $OctopusParameters[&quot;Octopus.Project.Id&quot;]\n} else {\n  $headers = @{&quot;X-Octopus-ApiKey&quot; = $env:OCTOPUS_APIKEY}\n  $projectId = &quot;Projects-1&quot;\n}\n\n$project = Invoke-RestMethod &quot;https://robota.octopus.app/api/projects/$projectId&quot; -Headers $headers\n\nWrite-Host $project.Name</code></pre></div>\n<p>As you can see at very top we have condition, so we can run and test it locally, and here is more complex example</p>\n<p><div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$OctopusParameters</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># we are inside octopus</span>\n  <span class=\"token variable\">$headers</span> = @<span class=\"token punctuation\">{</span><span class=\"token string\">\"X-Octopus-ApiKey\"</span> = <span class=\"token variable\">$OCTOPUS_APIKEY</span><span class=\"token punctuation\">}</span>\n  <span class=\"token variable\">$projectId</span> = <span class=\"token variable\">$OctopusParameters</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"Octopus.Project.Id\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\"># local run</span>\n  <span class=\"token variable\">$headers</span> = @<span class=\"token punctuation\">{</span><span class=\"token string\">\"X-Octopus-ApiKey\"</span> = <span class=\"token variable\">$env</span>:OCTOPUS_APIKEY<span class=\"token punctuation\">}</span>\n  <span class=\"token variable\">$projectId</span> = <span class=\"token string\">\"Projects-1\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$project</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app/api/projects/<span class=\"token variable\">$projectId</span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n<span class=\"token variable\">$failed</span> = 0\n\n<span class=\"token comment\"># VARIABLES</span>\n\n<span class=\"token variable\">$variables</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Links<span class=\"token punctuation\">.</span>Variables<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty Variables\n<span class=\"token variable\">$owner</span> = <span class=\"token variable\">$variables</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> Name <span class=\"token operator\">-EQ</span> <span class=\"token string\">'Owner'</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$owner</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"- 'Owner' variable is missing\"</span>\n  <span class=\"token variable\">$failed</span> <span class=\"token operator\">+=</span> 1\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\"># TODO: check if owner is a valid email</span>\n  <span class=\"token comment\"># TODO: cehck if owner is not deactivated</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$repository</span> = <span class=\"token variable\">$variables</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> Name <span class=\"token operator\">-EQ</span> <span class=\"token string\">'Repository'</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$repository</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"- 'Repository' variable is missing\"</span>\n  <span class=\"token variable\">$failed</span> <span class=\"token operator\">+=</span> 1\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># CHANNELS</span>\n\n<span class=\"token variable\">$channels</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app/api/projects/<span class=\"token variable\">$projectId</span>/channels\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty Items\n<span class=\"token variable\">$process</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Links<span class=\"token punctuation\">.</span>DeploymentProcess<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$step</span> in <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> in <span class=\"token variable\">$step</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span><span class=\"token punctuation\">.</span>IsDisabled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">continue</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$package</span> in <span class=\"token variable\">$action</span><span class=\"token punctuation\">.</span>Packages<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token variable\">$name</span> = <span class=\"token variable\">$package</span><span class=\"token punctuation\">.</span>Name\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$name</span> = <span class=\"token variable\">$package</span><span class=\"token punctuation\">.</span>PackageId\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$channel</span> in <span class=\"token variable\">$channels</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$found</span> = <span class=\"token boolean\">$false</span>\n        <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$rule</span> in <span class=\"token variable\">$channel</span><span class=\"token punctuation\">.</span>Rules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$rule</span><span class=\"token punctuation\">.</span>ActionPackages <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> DeploymentAction <span class=\"token operator\">-EQ</span> <span class=\"token variable\">$action</span><span class=\"token punctuation\">.</span>Name <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">-not</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>PackageReference <span class=\"token operator\">-or</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>PackageReference <span class=\"token operator\">-EQ</span> <span class=\"token variable\">$package</span><span class=\"token punctuation\">.</span>Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$found</span> = <span class=\"token boolean\">$true</span>\n            <span class=\"token keyword\">break</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$found</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"- '<span class=\"token variable\">$name</span>' has no rules for '<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span></span>' channel\"</span>\n          <span class=\"token variable\">$failed</span> <span class=\"token operator\">+=</span> 1\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># KUBERNETES RESOURCES</span>\n\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$step</span> in <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> in <span class=\"token variable\">$step</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span><span class=\"token punctuation\">.</span>IsDisabled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">continue</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span><span class=\"token punctuation\">.</span>ActionType <span class=\"token operator\">-ne</span> <span class=\"token string\">'Octopus.KubernetesDeployContainers'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">continue</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token variable\">$containers</span> = <span class=\"token variable\">$action</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.KubernetesContainers.Containers'</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertFrom-Json</span>\n    <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$container</span> in <span class=\"token variable\">$containers</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>Resources<span class=\"token punctuation\">.</span>limits<span class=\"token punctuation\">.</span>cpu<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"- '<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span></span>' container has no cpu limits defined\"</span>\n        <span class=\"token variable\">$failed</span> <span class=\"token operator\">+=</span> 1\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>Resources<span class=\"token punctuation\">.</span>limits<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"- '<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span></span>' container has no memory limits defined\"</span>\n        <span class=\"token variable\">$failed</span> <span class=\"token operator\">+=</span> 1\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>Resources<span class=\"token punctuation\">.</span>requests<span class=\"token punctuation\">.</span>cpu<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"- '<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span></span>' container has no cpu requests defined\"</span>\n        <span class=\"token variable\">$failed</span> <span class=\"token operator\">+=</span> 1\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>Resources<span class=\"token punctuation\">.</span>requests<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"- '<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$container</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span></span>' container has no memory requests defined\"</span>\n        <span class=\"token variable\">$failed</span> <span class=\"token operator\">+=</span> 1\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$failed</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token variable\">$failed</span> checks failed\"</span>\n  <span class=\"token keyword\">exit</span> 1\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"All checks passed\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<h2>Install</h2>\n<p>Now we need an script that will add this script to all projects</p>\n<p>Here is what I have ended up with:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$headers</span> = @<span class=\"token punctuation\">{</span><span class=\"token string\">\"X-Octopus-ApiKey\"</span> = <span class=\"token variable\">$env</span>:OCTOPUS_APIKEY<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$templates</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app/api/actiontemplates/all\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n<span class=\"token variable\">$template</span>  = <span class=\"token variable\">$templates</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> Name <span class=\"token operator\">-EQ</span> <span class=\"token string\">'octochecks'</span>\n\n<span class=\"token variable\">$step</span> = @<span class=\"token punctuation\">{</span>\n  Name    = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Name\n  Actions = @<span class=\"token punctuation\">(</span>@<span class=\"token punctuation\">{</span>\n    Name               = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Name\n    ActionType         = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>ActionType\n    IsRequired         = <span class=\"token boolean\">$true</span>\n    WorkerPoolVariable = <span class=\"token string\">'octoworker'</span> <span class=\"token comment\"># NOTE: if using default workers remove me</span>\n    Properties = @<span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"Octopus.Action.Script.ScriptSource\"</span> = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Script.ScriptSource'</span>\n      <span class=\"token string\">\"Octopus.Action.Script.Syntax\"</span>       = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Script.Syntax'</span>\n      <span class=\"token string\">\"Octopus.Action.Template.Version\"</span>    = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Version\n      <span class=\"token string\">\"Octopus.Action.Script.ScriptBody\"</span>   = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Script.ScriptBody'</span>\n      <span class=\"token string\">\"Octopus.Action.RunOnServer\"</span>         = <span class=\"token boolean\">$true</span>\n      <span class=\"token string\">\"Octopus.Action.Template.Id\"</span>         = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Id\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$projects</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app/api/projects/all\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span> in <span class=\"token variable\">$projects</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\"># $project = $projects | Where-Object Name -EQ 'Prometheus'</span>\n  <span class=\"token variable\">$process</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Links<span class=\"token punctuation\">.</span>DeploymentProcess<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps<span class=\"token punctuation\">.</span>Count <span class=\"token operator\">-eq</span> 0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">continue</span> <span class=\"token punctuation\">}</span> <span class=\"token comment\"># project without any step</span>\n\n  <span class=\"token variable\">$steps</span> = @<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token variable\">$found</span> = <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Template.Id'</span> <span class=\"token operator\">-eq</span> <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Id <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$found</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$steps</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$found</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$steps</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$step</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span> in <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Template.Id'</span> <span class=\"token operator\">-ne</span> <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token variable\">$steps</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$item</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token variable\">$changed</span> = <span class=\"token boolean\">$false</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$steps</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>IsDisabled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$steps</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>IsDisabled = <span class=\"token boolean\">$false</span>\n    <span class=\"token variable\">$changed</span> = <span class=\"token boolean\">$true</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$steps</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>IsRequired<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$steps</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>IsRequired = <span class=\"token boolean\">$true</span>\n    <span class=\"token variable\">$changed</span> = <span class=\"token boolean\">$true</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">ConvertTo-Json</span> <span class=\"token operator\">-</span>Depth 100 <span class=\"token operator\">-</span>InputObject <span class=\"token variable\">$steps</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-ne</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ConvertTo-Json</span> <span class=\"token operator\">-</span>Depth 100 <span class=\"token operator\">-</span>InputObject <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$changed</span> = <span class=\"token boolean\">$true</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$changed</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps = <span class=\"token variable\">$steps</span>\n      <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Put <span class=\"token string\">\"https://example.octopus.app<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Links<span class=\"token punctuation\">.</span>DeploymentProcess<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span><span class=\"token function\">ConvertTo-Json</span> <span class=\"token operator\">-</span>Depth 100 <span class=\"token operator\">-</span>Compress <span class=\"token operator\">-</span>InputObject <span class=\"token variable\">$process</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Out-Null</span>\n      <span class=\"token function\">Write-Host</span> <span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Name <span class=\"token operator\">-</span>ForegroundColor Green\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">Write-Host</span> <span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Name <span class=\"token operator\">-</span>ForegroundColor Red\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">Write-Host</span> <span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Name <span class=\"token operator\">-</span>ForegroundColor Cyan\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<p>Notes:</p>\n<ul>\n<li>Be sure to manually add step to some project and get its data to make corresponding changes, for example in my case I am using worker pools which may be not needed in your setup</li>\n<li>Be extremely careful when performing the change - you may delete settings</li>\n</ul>\n<h2>Subscription</h2>\n<p>Ok, so from now on we have our custom checks added to all projects</p>\n<p>We can run installation script every day, week or month to make sure all new projects have it as well</p>\n<p>But there is an better way, we are going to subscribe to deployments events, so whenever something is deployed our webhook will be called</p>\n<p>It's job is to ensure that checks script in place, if not make - fix it and notify via Slack</p>\n<p>From Octopus subscriptions there is nothing interesting just select \"Deployment queued\" from \"Select event categories\" menu, give it some name and webhook URL</p>\n<p>For webhook itself we are going to cheat little bit and also will use powershell like in <a href=\"https://mac-blog.org.ua/nginx-powershell/\">previous note</a></p>\n<p>So here are files</p>\n<p><strong>default.conf</strong></p>\n<p><div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n  listen 80;\n  root   /usr/share/nginx/html;\n\n  location /octopus {\n    fastcgi_pass unix:/var/run/fcgiwrap.socket;\n    fastcgi_param REQUEST_BODY $request_body;\n    fastcgi_param SCRIPT_FILENAME /usr/share/nginx/html/webhook.ps1;\n  }\n}</code></pre></div></p>\n<p><strong>entrypoint.sh</strong></p>\n<p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/sh</span>\n\napk <span class=\"token function\">add</span> <span class=\"token parameter variable\">-q</span> fcgiwrap spawn-fcgi powershell\n\n/usr/bin/spawn-fcgi <span class=\"token parameter variable\">-s</span> /var/run/fcgiwrap.socket <span class=\"token parameter variable\">-M</span> <span class=\"token number\">766</span> /usr/bin/fcgiwrap</code></pre></div></p>\n<p><strong>webhook.ps1</strong></p>\n<p><div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\">#!/usr/bin/pwsh</span>\n\n<span class=\"token function\">Write-Host</span> <span class=\"token string\">'content-type: text/plain'</span>\n<span class=\"token function\">Write-Host</span> <span class=\"token string\">'cache-control: no-store'</span>\n<span class=\"token function\">Write-Host</span> <span class=\"token string\">''</span>\n<span class=\"token variable\">$body</span> = <span class=\"token variable\">$env</span>:REQUEST_BODY <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertFrom-Json</span>\n<span class=\"token comment\">&lt;#\n$body = @{\n    Payload = @{\n        Event = @{\n            RelatedDocumentIds = @(\n                \"Deployments-69481\"\n            )\n        }\n    }\n}\n#></span>\n<span class=\"token variable\">$headers</span> = @<span class=\"token punctuation\">{</span><span class=\"token string\">\"X-Octopus-ApiKey\"</span> = <span class=\"token variable\">$env</span>:OCTOPUS_APIKEY<span class=\"token punctuation\">}</span>\n<span class=\"token variable\">$deployment</span> = <span class=\"token variable\">$body</span><span class=\"token punctuation\">.</span>Payload<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">.</span>RelatedDocumentIds <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>StartsWith<span class=\"token punctuation\">(</span><span class=\"token string\">\"Deployments-\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token variable\">$test</span> = <span class=\"token variable\">$body</span><span class=\"token punctuation\">.</span>Payload<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">.</span>RelatedDocumentIds<span class=\"token punctuation\">.</span>Count <span class=\"token operator\">-eq</span> 1\n<span class=\"token variable\">$deployment</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app/api/deployments/<span class=\"token variable\">$deployment</span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n<span class=\"token variable\">$project</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app/api/projects/<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$deployment</span><span class=\"token punctuation\">.</span>ProjectId<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n<span class=\"token variable\">$process</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Links<span class=\"token punctuation\">.</span>DeploymentProcess<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n<span class=\"token variable\">$skipped</span> = <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty Actions <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> Id <span class=\"token operator\">-in</span> <span class=\"token variable\">$deployment</span><span class=\"token punctuation\">.</span>SkipActions <span class=\"token punctuation\">|</span> <span class=\"token function\">Select-Object</span> <span class=\"token operator\">-</span>ExpandProperty Name\n<span class=\"token variable\">$templates</span> = <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token string\">\"https://example.octopus.app/api/actiontemplates/all\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span>\n<span class=\"token variable\">$template</span>  = <span class=\"token variable\">$templates</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> Name <span class=\"token operator\">-EQ</span> <span class=\"token string\">'octochecks'</span>\n\n<span class=\"token variable\">$step</span> = @<span class=\"token punctuation\">{</span>\n  Name    = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Name\n  Actions = @<span class=\"token punctuation\">(</span>@<span class=\"token punctuation\">{</span>\n    Name               = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Name\n    ActionType         = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>ActionType\n    IsRequired         = <span class=\"token boolean\">$true</span>\n    WorkerPoolVariable = <span class=\"token string\">'octoworker'</span> <span class=\"token comment\"># NOTE: if using default workers remove me</span>\n    Properties = @<span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"Octopus.Action.Script.ScriptSource\"</span> = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Script.ScriptSource'</span>\n      <span class=\"token string\">\"Octopus.Action.Script.Syntax\"</span>       = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Script.Syntax'</span>\n      <span class=\"token string\">\"Octopus.Action.Template.Version\"</span>    = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Version\n      <span class=\"token string\">\"Octopus.Action.Script.ScriptBody\"</span>   = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Script.ScriptBody'</span>\n      <span class=\"token string\">\"Octopus.Action.RunOnServer\"</span>         = <span class=\"token boolean\">$true</span>\n      <span class=\"token string\">\"Octopus.Action.Template.Id\"</span>         = <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Id\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token variable\">$steps</span> = @<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token variable\">$found</span> = <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps <span class=\"token punctuation\">|</span> <span class=\"token function\">Where-Object</span> <span class=\"token punctuation\">{</span> <span class=\"token variable\">$_</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Template.Id'</span> <span class=\"token operator\">-eq</span> <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Id <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$found</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$steps</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$found</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$steps</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$step</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span> in <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$item</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token string\">'Octopus.Action.Template.Id'</span> <span class=\"token operator\">-ne</span> <span class=\"token variable\">$template</span><span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$steps</span> <span class=\"token operator\">+=</span> <span class=\"token variable\">$item</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$changed</span> = <span class=\"token boolean\">$false</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$steps</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>IsDisabled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$steps</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>IsDisabled = <span class=\"token boolean\">$false</span>\n  <span class=\"token variable\">$changed</span> = <span class=\"token boolean\">$true</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-not</span> <span class=\"token variable\">$steps</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>IsRequired<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$steps</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Actions<span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>IsRequired = <span class=\"token boolean\">$true</span>\n  <span class=\"token variable\">$changed</span> = <span class=\"token boolean\">$true</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">ConvertTo-Json</span> <span class=\"token operator\">-</span>Depth 100 <span class=\"token operator\">-</span>InputObject <span class=\"token variable\">$steps</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-ne</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ConvertTo-Json</span> <span class=\"token operator\">-</span>Depth 100 <span class=\"token operator\">-</span>InputObject <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$changed</span> = <span class=\"token boolean\">$true</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$changed</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$process</span><span class=\"token punctuation\">.</span>Steps = <span class=\"token variable\">$steps</span>\n    <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Put <span class=\"token string\">\"https://example.octopus.app<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Links<span class=\"token punctuation\">.</span>DeploymentProcess<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token operator\">-</span>Headers <span class=\"token variable\">$headers</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span><span class=\"token function\">ConvertTo-Json</span> <span class=\"token operator\">-</span>Depth 100 <span class=\"token operator\">-</span>Compress <span class=\"token operator\">-</span>InputObject <span class=\"token variable\">$process</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Out-Null</span>\n    <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span></span> - updated\"</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">Write-Host</span> <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span></span> - failed\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$skipped</span> <span class=\"token operator\">-contains</span> <span class=\"token string\">'octochecks'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">Invoke-RestMethod</span> <span class=\"token operator\">-</span>Method Post <span class=\"token string\">\"https://slack.com/api/chat.postMessage\"</span> <span class=\"token operator\">-</span>ContentType <span class=\"token string\">'application/json'</span> <span class=\"token operator\">-</span>Headers @<span class=\"token punctuation\">{</span> Authorization = <span class=\"token string\">\"Bearer <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$env</span>:SLACK_TOKEN<span class=\"token punctuation\">)</span></span>\"</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">-</span>Body <span class=\"token punctuation\">(</span>@<span class=\"token punctuation\">{</span>channel = <span class=\"token string\">'@mac'</span><span class=\"token punctuation\">;</span> text = <span class=\"token string\">\"<span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$project</span><span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span></span> deployed without checks by <span class=\"token function\">$<span class=\"token punctuation\">(</span><span class=\"token variable\">$deployment</span><span class=\"token punctuation\">.</span>DeployedBy<span class=\"token punctuation\">)</span></span>\"</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">ConvertTo-Json</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div></p>\n<p>With this scripts in place we may run our docker like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:80 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">OCTOPUS_APIKEY</span><span class=\"token operator\">=</span><span class=\"token variable\">$OCTOPUS_APIKEY</span> <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/entrypoint.sh:/docker-entrypoint.d/00-init.sh <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/default.conf:/etc/nginx/conf.d/default.conf <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/webhook.ps1:/usr/share/nginx/html/webhook.ps1 nginx:alpine</code></pre></div>\n<p>And optionally (if have nowhere to deploy) expose it:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ngrok http <span class=\"token number\">8080</span> <span class=\"token parameter variable\">--region</span><span class=\"token operator\">=</span>eu</code></pre></div>\n<p>Once again, it does not solves initial goal, but at least better than nothing, plus slack notifications wont allow engineers to skip it often and sooner or later checks will be fixed</p>\n<p>Hopefully in future there will be something similar to Kubernetes admission webhooks</p>"}},"pageContext":{"id":"ebb85950-16e8-53a4-ae1b-eee5f006caef"}},"staticQueryHashes":[],"slicesMap":{}}