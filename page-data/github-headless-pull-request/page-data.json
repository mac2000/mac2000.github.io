{"componentChunkName":"component---src-templates-note-js","path":"/github-headless-pull-request/","result":{"data":{"remark":{"fields":{"path":"github-headless-pull-request"},"meta":{"title":""},"headings":[{"value":"Headless GitHub - create an pull request modifying file"}],"html":"<h1>Headless GitHub - create an pull request modifying file</h1>\n<p>Imagine you have an static site, where each page has corresponding markdown file in GitHub repository.</p>\n<p>You want to somehow allow visitors to propose changes to your site.</p>\n<p>But visitors are not IT nerds and do not know anything about Git and GitHub.</p>\n<p>An alternative approach will be to have some kind of lambda function that will do the work and hide all complexity from the end user.</p>\n<p>For thing to happen we need:</p>\n<ol>\n<li>Retrieve current file sha</li>\n<li>Create new branch</li>\n<li>Push changes to it</li>\n<li>Create an pull request</li>\n</ol>\n<h2><a href=\"https://docs.github.com/en/rest/repos/contents#get-repository-content\">Retrieving file contents</a></h2>\n<p>File \"contents\" can be retrieved as easy as</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/contents/README.md\"</span></code></pre></div>\n<p>From an respond we need two things:</p>\n<ul>\n<li><code class=\"language-text\">content</code> - base64 endocded file content string</li>\n<li><code class=\"language-text\">sha</code> - file sha, we need it when we will call update endpoint, to point out that we are updating exiting file rather than creating new one</li>\n</ul>\n<p>Here is how we may get content</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/contents/README.md\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">\".content\"</span> <span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">-d</span></code></pre></div>\n<h2><a href=\"https://docs.github.com/en/rest/git/refs#create-a-reference\">Creating branch</a></h2>\n<p>This one is pretty straight forward</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/git/refs\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>ref<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>refs/heads/my-awesome-branch<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>sha<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>xxxxxxxxx<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span></code></pre></div>\n<p>where:</p>\n<ul>\n<li><code class=\"language-text\">my-awesome-branch</code> - is our branch name</li>\n<li><code class=\"language-text\">xxxxxxxxx</code> - is an sha of commit from where we are creating branch, usually it will be an main branch last commit</li>\n</ul>\n<h2><a href=\"https://docs.github.com/en/rest/repos/contents#create-or-update-file-contents\">Push changes</a></h2>\n<p>To save updated content we need encode it, aka: <code class=\"language-text\">echo \"My new content\" | base64</code>, pass previous sha (we did saved it when contents were retrieved) and pass branch name created in previous step</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> PUT <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/contents/README.md\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>message<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>Update readme<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>content<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$CONTENT_ENCODED</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>sha<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$CONTENT_SHA</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>branch<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>my-awesome-branch<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>it is important to not mess up with sha of file and branch, otherwise you will receive an error like this: \"README.md does not match xxxxxxxxx\"</li>\n<li>we can pass commiter object to store user email in case we want to notify him after merge or to ask some questions</li>\n</ul>\n<h2><a href=\"https://docs.github.com/en/rest/pulls/pulls#create-a-pull-request\">Create pull request</a></h2>\n<p>And the very last step is to create an pull request, aka</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/pulls\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>title<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>hello<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>head<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>my-awesome-branch<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>base<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>main<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>body<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>world<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span></code></pre></div>\n<p>Note: pull request body is a good place to pass any meta data we want</p>\n<h2>Recap</h2>\n<p>With this in place we can have whole edit page experience or suggest changes on our website, without the need for end user to deal with GitHub at all.</p>\n<p>Here is an snippet I have ended up with:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token comment\"># step 1: retrieve</span>\n<span class=\"token assign-left variable\">CONTENT</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/contents/README.md\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">CONTENT_DECODED</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> $CONTENT <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> .content <span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">-d</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">CONTENT_SHA</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> $CONTENT <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> .sha<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"BEFORE: '<span class=\"token variable\">$CONTENT_DECODED</span>'\"</span>\n<span class=\"token assign-left variable\">CONTENT_DECODED</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CONTENT_DECODED</span> mac was here\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"AFTER: '<span class=\"token variable\">$CONTENT_DECODED</span>'\"</span>\n<span class=\"token assign-left variable\">CONTENT_ENCODED</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$CONTENT_DECODED</span>\"</span> <span class=\"token operator\">|</span> base64<span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># step 2: create branch</span>\n<span class=\"token assign-left variable\">BRANCH_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"update-readme-<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%s<span class=\"token variable\">)</span></span>\"</span>\n<span class=\"token assign-left variable\">MAIN_BRANCH_SHA</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/git/ref/heads/main\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> .object.sha<span class=\"token variable\">)</span></span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/git/refs\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>ref<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>refs/heads/<span class=\"token variable\">$BRANCH_NAME</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>sha<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$MAIN_BRANCH_SHA</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span>\n\n<span class=\"token comment\"># step 3: push changes</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> PUT <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/contents/README.md\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>message<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>Update readme<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>content<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$CONTENT_ENCODED</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>sha<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$CONTENT_SHA</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>branch<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$BRANCH_NAME</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span>\n\n<span class=\"token comment\"># step 4: create pull request</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: token <span class=\"token variable\">$GITHUB_TOKEN</span>\"</span> <span class=\"token string\">\"https://api.github.com/repos/mac2000/demo/pulls\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>title<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>hello<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>head<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$BRANCH_NAME</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>base<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>main<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>body<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>world<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span></code></pre></div></p>"}},"pageContext":{"id":"369c590f-695f-5217-8c65-416cd7dcec9b"}},"staticQueryHashes":[],"slicesMap":{}}