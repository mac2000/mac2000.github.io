{"componentChunkName":"component---src-templates-note-js","path":"/postgres-notes/","result":{"data":{"remark":{"fields":{"path":"postgres-notes"},"meta":{"title":""},"headings":[{"value":"pgbench"},{"value":"Бекап"},{"value":"Репликация"},{"value":"Репликация"},{"value":"Репликация 3"}],"html":"<p>Поставил убунту, next, next, finish</p>\n<p>Добавил себя в sudoers</p>\n<p>echo $USER ALL=NOPASSWD: ALL | sudo tee /etc/sudoers.d/$USER</p>\n<p>Обновил систему</p>\n<p>sudo apt update &#x26;&#x26; sudo apt upgrade -y &#x26;&#x26; sudo reboot</p>\n<p>Поставил postgres</p>\n<p>sudo apt install -y postgres postgres-contrib</p>\n<p>Забыл и уже после выставил часовой пояс</p>\n<p>sudo timedatectl set-timezone Europe/Kiev</p>\n<p>Добавил в <code class=\"language-text\">/etc/postgresql/12/main/pg_hba.conf</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 497px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f62e86ebff5bd8e26ca59d82ff6131d/15d25/image-20210504-072915.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.65625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABO0lEQVR42jWPUU+CUBhAqZVvCmihpKaIIJjmFPLP1KrltDZ1k7lME7NNLfXJf3y6svVw9t3vnIdvVzLLFmXboeK6lEwL03Jwq1U8z6dWu6HZatFu31Gv12h5LeE9fN/nttGg2WxG3fe9qB+9pKV1tHSG1GUaTSArKTIZHdM0cR1xyLa5ymYpFgoUCkUcp8J1PkdZdF3XicfjyLKCoihomoYULr6YfYZMZ3MmHzPeJ1PCcMFut2O/30dsfn74FXwvl6JPmIch2+2WzWbNeiVYr1mJeTgckDrdV+4fHhkMh4zHY56eX3h9e2M4GNDrdel0OgxFG41G9Pt94XoMRAuCIHJH/t9BMEJSkxckEgp2pUK+aHByesZ5LIZhGNiWRTKZjJBlmVw+T6NxS6lkoIhdVdXoq6oglbrAcV3+ABRWsW2We7IiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pg_hba\"\n        title=\"\"\n        src=\"/static/2f62e86ebff5bd8e26ca59d82ff6131d/15d25/image-20210504-072915.png\"\n        srcset=\"/static/2f62e86ebff5bd8e26ca59d82ff6131d/6f3f2/image-20210504-072915.png 256w,\n/static/2f62e86ebff5bd8e26ca59d82ff6131d/15d25/image-20210504-072915.png 497w\"\n        sizes=\"(max-width: 497px) 100vw, 497px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Из нутри базы</p>\n<p>select line_number, error from pg_hba_file_rules where error is not null; -- не сразу получилось, peer может использоваться только для подключения по сокетам, поменял на trust\nselect line_number, type, database, user_name, address, auth_method from pg_hba_file_rules; -- постгрес уже видит мою настройку\nselect pg_reload_conf(); -- применяем</p>\n<p>Подключиться все равно не удалось, пришлось таки идти в <code class=\"language-text\">/etc/postgresql/12/main/postgresql.conf</code> и править <code class=\"language-text\">listen_addresses = '*'</code> и перезапускать сервер, после чего получилось подключиться</p>\n<h1>pgbench</h1>\n<p>по мотивам <a href=\"https://www.youtube.com/watch?v=sE4YDcoONjQ\">видео</a> хотел погонять pgbench</p>\n<p>create database sample;</p>\n<p>инициализация базы (х50 раз больше базовой)</p>\n<p>sudo su - postgres\npgbench -i -s 50 sample</p>\n<p>дальше в отдельном терминале монитор памяти</p>\n<p>watch free -m</p>\n<p>и запуск теста</p>\n<p>pgbench -c 10 -j 2 -t 10000 sample</p>\n<p>где:</p>\n<ul>\n<li><code class=\"language-text\">-с 10</code> - 10 клиентов</li>\n<li><code class=\"language-text\">-j 2</code> - 2 потока</li>\n<li><code class=\"language-text\">-t 10000</code> - каждый клиент выполнит 10К транзакций</li>\n</ul>\n<p>результат</p>\n<p>transaction type: &#x3C;builtin: TPC-B (sort of)>\nscaling factor: 50\nquery mode: simple\nnumber of clients: 10\nnumber of threads: 2\nnumber of transactions per client: 10000\nnumber of transactions actually processed: 100000/100000\nlatency average = 1.946 ms\ntps = 5138.114222 (including connections establishing)\ntps = 5139.000224 (excluding connections establishing)</p>\n<p>память при этом не потреблялась</p>\n<p>тут уже не так важно что менять, менял так же как и он (увеличил в 4 раза)</p>\n<p>shared_buffers = 512MB # 128MB</p>\n<p>после чего рестарт сервера и повторный прогон теста</p>\n<p>на этот раз память начала потребляться, результаты прогона</p>\n<p>tps = 5347.684715</p>\n<p>и еще один тест</p>\n<p>#effective_cache_size = 4GB\neffective_cache_size = 512MB</p>\n<p>и любопытно получилось даже хуже</p>\n<p>tps = 5173.036936</p>\n<p>Нужно дальше смотреть что умеет pgbench - тут прямо непаханное поле</p>\n<h1>Бекап</h1>\n<p>по мотивам <a href=\"https://www.youtube.com/watch?v=4-6ks0UkMYA&#x26;list=PLaFqU3KCWw6KEakTSrRWrekNI-z9U1ypF&#x26;index=3\">видео</a></p>\n<h2>Логический бекап</h2>\n<h3>Формат plain</h3>\n<p>Аля sql файлики с create table foo, insert into foo</p>\n<p>pg_dump -d sample -f sample.sql</p>\n<p>так не вышло, надо переключаться в пользователя postgres и делать каждый раз западло, по аналогии с прошлым разом поменял peer на trust на локальное подключение</p>\n<p>pg_dump -U postgres -d sample -f sample.sql</p>\n<p>файлик вышел на 472мб</p>\n<p>востановление</p>\n<p>psql -f sample.sql</p>\n<h3>Custom формат</h3>\n<p>pg_dump -d sample -F c -f sample\npg_restore -d sample -j 2 sample</p>\n<p>позволяет ресторить выборочные объекты и в несколько потоков, но при этом одну табличку в несколько потоков загрузить нельзя</p>\n<p>файл получился всего 18мб, внутри бинарь</p>\n<h3>Формат directory</h3>\n<p>pg_dump -U postgres -d sample -F d -j 2 -f ./sampledir/\npg_restore -d sample -j 2 ./sampledir/</p>\n<p>Папку создаст сам</p>\n<p>В папке будет серия файлов 1234.dat.gz и файл toc.dat</p>\n<p>Все те же 18мб</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 738px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c87b4d1dc774f89c85c6b66c7569c49e/774b6/image-20210504-075713.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.359375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACvklEQVR42pVUaVPiQBDN//8p+8Fa3SoVWOTGFZQjgBhjTpKQk0sgBwlve0Z3a8tvm6pX3T3T/Xrm9YDQbKi4vX1GtSrj7k5GtSKhd2+hVnlBvSqhcjNFu66g/lPCY3eBwDrDWxQICLaRo/UU4tvNGI1+AEk6Quj1NPQeVIyGFiaijcHAgDT38NRT0X9Q8Kv7CnG4wHhg4mXmYhsU2BCYjbwcupVAfCEy7Qh3mUHAf3zn85nj3/jrvpDnOfK8QFF8gEqQJAm22y2P2f7hcMB+v+fx8cj8dxzI5kXO84/x8aOWEX7twD7P86GqGtI04zAMk8dJksL3A+i6gYVpUaOYiM5wbAcJ5TFf0DSNklU4DluMSZ8Enh7DetuQ8CnH1jtjQ1gtc7j6Aaa8hiFF8M0UoXXCxqUhmRl2UQqBEem6DkYcRgHWfgJLPkCdRUScwtWI1MwJJ4SLHKa0gyx6UKYhb7z2TtTohMjJ8L4mwiAIEMfx55VzrNwYoUmnoecREtHaAZFsoD1H3F/ZNOUls0DoxKRgwVFQbZYRoe/72O12pFVKiwV2m5g6nTh2qxSRfYKrxliqR/hGxk/KLINnHLHfsFy67irD4Z0IZ7MZRFHEfD5HGIYkfEyTPeFESNIEoZ1iIe8JOzicNCX9NnCUA2yCq2d0/Qi2TNcn/YXJZILZbApmLcsCO3EURRzMX9o+XIf0WkZYGC6U5xCvpOHbJMDbs8vX3WX4keMGENrtFjqdDrrdLidVFIUPSdc17r+x2DBgmAZeJQlin35ZzTmeOjLER5melPY5VJVeiwKhVCqhXC5z9Pt9jEYjTswwHo9w3xDRLA/RKD+hVRmiUxXRKA3QLI3QqQ0wmX7kMtlYrXB1dYnLy++4uLgAI2+1Wmi32xzNZpP+HJq4vqzh5qqG2x8NVK5bFN+RX6e9+t/cP3W/AciKBASX2rWQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"formats\"\n        title=\"\"\n        src=\"/static/c87b4d1dc774f89c85c6b66c7569c49e/774b6/image-20210504-075713.png\"\n        srcset=\"/static/c87b4d1dc774f89c85c6b66c7569c49e/6f3f2/image-20210504-075713.png 256w,\n/static/c87b4d1dc774f89c85c6b66c7569c49e/01e7c/image-20210504-075713.png 512w,\n/static/c87b4d1dc774f89c85c6b66c7569c49e/774b6/image-20210504-075713.png 738w\"\n        sizes=\"(max-width: 738px) 100vw, 738px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Выглядит так что формат directory в этом случае наиболее предпочтителен, т.к. умеет все, если будет сильно много нагрузки при бекапе, можно будет уменьшать число потоков</p>\n<h3>pg_dumpall</h3>\n<p>примечание - pg_dump не бекапит пользователей и табличные пространства</p>\n<p>pg_dumpall -U postgres -f db1.sql\npsql -f db1.sql</p>\n<p>эта штука не умеет архивирование, паралельность и т.п.</p>\n<p>обычно используют просто</p>\n<p>pg_dumpall -U postgress - globals only</p>\n<p>тогда оно забекапит только глобавльные объекты, затем средствами pg_dump выгружаем сами данные и накатываем на втором сервере в том же порядке</p>\n<h3>Настройки</h3>\n<ul>\n<li>\n<p>при восстановлении копии на системе с другим набором ролей</p>\n<ul>\n<li><code class=\"language-text\">-O, --no-owner</code> - не генерировать команды для установки владельца объектов</li>\n<li><code class=\"language-text\">-X, --no-acl</code> - не генерировать команды для установки привилегий</li>\n</ul>\n</li>\n<li>\n<p>для выгрузки и загрузки данных частями</p>\n<ul>\n<li><code class=\"language-text\">-s, --schema-only</code> - выгрузить только определения обхектов баз данных</li>\n<li><code class=\"language-text\">-a, --data-only</code> - выгрузить только данные, без создания объектов</li>\n</ul>\n</li>\n<li>\n<p>если восстанавливать копию на системе, в которой уже есть данные (и наоборот, на чистой системе)</p>\n<ul>\n<li><code class=\"language-text\">-c, --clean</code> - генерировать команды DROP для создаваемых объектов</li>\n<li><code class=\"language-text\">-C, --create</code> - генерировать команды создания БД и подключения к ней</li>\n</ul>\n</li>\n<li>\n<p>ключи для выбора объектов которые должны попасть в резервную копию</p>\n<ul>\n<li><code class=\"language-text\">-n, --schema</code> - шаблон для имен схем</li>\n<li><code class=\"language-text\">-t, --table</code> - шабло для имен таблиц</li>\n</ul>\n</li>\n<li>\n<p>инверсия, включить в бекап все кроме</p>\n<ul>\n<li><code class=\"language-text\">-N, --exclude-schema</code> - шаблон для имен схем</li>\n<li><code class=\"language-text\">-T, --exclude-table</code> - шабло для имен таблиц</li>\n</ul>\n</li>\n</ul>\n<h2>Физический бекап</h2>\n<p>Цели и форматы</p>\n<ul>\n<li>\n<p>Немедленное развертывание нового экземпляра</p>\n<ul>\n<li>--format=plain</li>\n<li>удаленный запуск на сервере, где будет развернут экземпляр</li>\n<li>копирует файлы и каталоги кластера (PGDATA) в указанный каталог</li>\n<li>копирует табличные пространства по тем же абсолютным путям, но можно сопоставить и дргие (--tablespace-mapping)</li>\n</ul>\n</li>\n<li>\n<p>резервная копия для последующего использования</p>\n<ul>\n<li>--format=tar</li>\n<li>--gzip или --compress=0..9 для сжатия</li>\n<li>удаленный или локальный запуск</li>\n<li>помещает PGDATA в base.tar, файлы журнала в pg_wal.tar</li>\n<li>помещает каждое табличное пространство в отдельный файл OID.tar, пути могут быть изменены в файле tablespace_map</li>\n</ul>\n</li>\n</ul>\n<p>pg_basebackup -U postgres --pgdata=./db1bak1/</p>\n<p>для рестора просто перенести db1bak1 на второй сервер</p>\n<h1>Репликация</h1>\n<p>по мотивам <a href=\"https://www.youtube.com/watch?v=M9GGeLZTNzY&#x26;list=PLaFqU3KCWw6KEakTSrRWrekNI-z9U1ypF&#x26;index=5\">видео</a></p>\n<ul>\n<li>\n<p>synchronous_commit</p>\n<ul>\n<li>off - асинхронная фиксация и репликация</li>\n<li>local - локальная фиксация</li>\n<li>remote_write - дожидаемся сброса на диск на реплике</li>\n<li>remote_apply - дождемся пока реплика применит (это самое жесткое)</li>\n</ul>\n</li>\n<li>\n<p>synchronous_standby_names</p>\n<ul>\n<li>FIRST N</li>\n<li>ANY N</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 784px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/031359d54be79a9778f39b90ea2f1744/4971b/image-20210504-083856.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.921875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTklEQVR42n1S23LaMBDl/3+lH9CHdpLpQ0MDEyDQTMA4MWCDLRtLvsj3y+lKXNI0k2rmIEusds+es4P5nOP21sT9/R53QxvDoYPhzx1mDz5cu4PnvIERfPsNnt1jNOP48nWG8aOAY9UYvL6muLt7wWhkYTpxMPplUcI1Fo978KBH6HcaQoF1iPz+Cu61MK0c44WP+TqFd2gwwHl1XYe2bTUuq+979XOFOldVpVGW5en/v5Y6D/pzoBAcpmkgiiJ9VgUUyrZE2Z1ANxCRgPmyhh8wXN7qWLVfEqoLEaY4ehKxkKAwXTGtUtzsbvF9+w03+xt4hQsZ5SRBBk7x6t0l6QWDE+0eMa/gbjIkokRVZ8TgN1w2ARMGsiZHVqco64LiMriWBKekXd8SOo13CX3fJzAkSYzj8YggCOg7gJQCVVmgI1nriswJOTgPKSYgHcsP+l0TNk1DwTHpFyPLMn1WS8otmP8I151QwQekqYe6aalIhVCGWIklVnwJMzLRtI1q9NIyMahr3XrX9eRgQskYPG+M7e4HfDanYvSoltrwpm5QUPthfiSEEIW46nl1WbUgMx9x4sJjU2K0oLZ3OIYLxPEWeR4RQ0bFYire6OKftnyaw4ZY2fRogzyz6XzSqCiUnhZSAueGZq666M9mfDBF0y/IvVgZImhPSE+h51EZoHQVQumbXAf531F5NzbKBCEENpsNptMp1msDy+dnrFYrGIahoe6enp5IU0/P6H8TKnZSSj06lmXhcDjAtm0Nx3H0zhjDfr/X33mef8pSGfMH6WEvG6q5w9sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"monitoring\"\n        title=\"\"\n        src=\"/static/031359d54be79a9778f39b90ea2f1744/4971b/image-20210504-083856.png\"\n        srcset=\"/static/031359d54be79a9778f39b90ea2f1744/6f3f2/image-20210504-083856.png 256w,\n/static/031359d54be79a9778f39b90ea2f1744/01e7c/image-20210504-083856.png 512w,\n/static/031359d54be79a9778f39b90ea2f1744/4971b/image-20210504-083856.png 784w\"\n        sizes=\"(max-width: 784px) 100vw, 784px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1>Репликация</h1>\n<p>по мотивам <a href=\"https://www.youtube.com/watch?v=LvDHdgQqaQw\">видео</a></p>\n<p>на обоих серверах поставил postgres плюс repmgr</p>\n<p>sudo apt install -y postgresql postgresql-contrib repmgr</p>\n<p>будет запущенно две службы</p>\n<p>systemctl status postgresql\nsystemctl status repmgrd</p>\n<p>примечание: данные живут тут <code class=\"language-text\">/var/lib/postgresql/12/main/</code></p>\n<p>правим <code class=\"language-text\">/etc/postgresql/12/main/postgresql.conf</code></p>\n<p>listen_addresses = '*'</p>\n<p>для repmgr добавляем</p>\n<p>shared_preload_libraries = 'repmgr'\nmax_wal_sender = 10 # 10 default\nmax_replication_slots = 15 # 10 default\nwal_level = 'replice' # default\nhot_standby = on # default\narchive_mode = on # off by default\narchive_command = '/bin/true' # empty by default</p>\n<p>создаем <code class=\"language-text\">/etc/postgresql/12/main/conf.d/repmgr.conf</code></p>\n<p>shared_preload_libraries = 'repmgr'</p>\n<p>правим <code class=\"language-text\">/etc/postgresql/12/main/pg_hba.conf</code> и по срединке добавляем</p>\n<p>local replication repmgr trust\nhost replication repmgr 127.0.0.1/32 trust\nhost replication repmgr 192.168.106.0/24 trust\nlocal repmgr repmgr trust\nhost repmgr repmgr 127.0.0.1/32 trust\nhost repmgr repmgr 192.168.106.0/24 trust</p>\n<p>Создаем пользователя repmgr</p>\n<p>createuser -U postgres -s repmgr\ncreatedb -U postgres repmgr -O repmgr\npsql -U postgres\n\\c repmgr\nALTER USER repmgr SET search_path TO repmgr, \"$user\", public;</p>\n<h1>Репликация 3</h1>\n<p><a href=\"https://www.digitalocean.com/community/tutorials/how-to-set-up-physical-streaming-replication-with-postgresql-12-on-ubuntu-20-04\">https://www.digitalocean.com/community/tutorials/how-to-set-up-physical-streaming-replication-with-postgresql-12-on-ubuntu-20-04</a></p>\n<p>Поменяли listen_addressess на звездочку</p>\n<p>завели пользователя</p>\n<p>sudo -u postgres psql\nCREATE ROLE test WITH REPLICATION PASSWORD 'testpassword' LOGIN;\n\\q</p>\n<p>добавили строку в pg_hba.conf</p>\n<p>host replication test 192.168.106.0/24 md5</p>\n<p>перезапустились</p>\n<p>sudo systemctl restart postgresql</p>\n<p><strong>на второй машине</strong></p>\n<p>смотрим где лежат данные</p>\n<p>sudo -u postgres psql -c 'SHOW data_directory;'</p>\n<p>стопаем базу</p>\n<p>sudo systemctl stop postgresql</p>\n<p>чистим файлы</p>\n<p>sudo su\nrm -rf /var/lib/postgresql/12/main/*\nexit</p>\n<p>ресторимся с мастера</p>\n<p>sudo -u postgres pg_basebackup -h 192.168.106.195 -p 5432 -U test -D /var/lib/postgresql/12/main/ -Fp -Xs -R</p>\n<p>спросит пароль testpassword</p>\n<p>после рестора папка наполниться файлами</p>\n<p>благодаря опции -R добавиться инфа о подключении и необходимые настройки что бы пометить сервер как реплику</p>\n<p>запускаем сервер</p>\n<p>sudo systemctl start postgresql</p>\n<p>проверяем что как <strong>на первой ноде</strong></p>\n<p>sudo -u postgres psql -c 'SELECT client_addr, state FROM pg_stat_replication;'</p>\n<p>-- client_addr | state\n-- -----------------+-----------\n-- 192.168.106.194 | streaming</p>\n<p>Все заработало, причем благодаря тому что репликация физическая оно синкает всякие DDL</p>\n<p>Пробую файловер из подручных средств <a href=\"https://www.youtube.com/watch?v=lSuDECXKn2A&#x26;list=PLaFqU3KCWw6KEakTSrRWrekNI-z9U1ypF&#x26;index=6\">видео</a> <a href=\"https://edu.postgrespro.ru/dba3/dba3_05_replica_switchover.html\">демо</a></p>\n<p>проверяем что реплика в режиме востановления</p>\n<p>sudo -u postgres psql -c 'SELECT pg_is_in_recovery();'</p>\n<p>промоутим его как мастер</p>\n<p>sudo pg_ctlcluster 12 main promote</p>\n<p>после этого предыдущая команда вернет false, сервер стал мастером, можно вставлять данные, но предыдущий мастер все еще работает и тоже принимает запись - из-за чего могут быть проблемы</p>\n<p>sudo -u postgres psql -d sample -c \"insert into test values ('mac was here');\"\nsudo -u postgres psql -d sample -c \"select * from test;\"</p>\n<p>при этом на первом сервере эти же команды тоже сработают</p>\n<p>на <strong>первом сервере</strong> - стопаем базу</p>\n<p>sudo systemctl stop postgresql</p>\n<p>что бы не ресторить весь сервер, подхачим утилитой pg_rewind</p>\n<p>pg_rewind -D /var/lib/postgresql/12/main --source-server='user=test password=testpassword host=192.168.106.194 port=5432' -P</p>\n<p>якась фигня в системе нет pg_rewind, сделал задом наперед</p>\n<p>чистим файлы</p>\n<p>sudo su\nrm -rf /var/lib/postgresql/12/main/*\nexit</p>\n<p>ресторимся с мастера</p>\n<p>sudo -u postgres pg_basebackup -h 192.168.106.194 -p 5432 -U test -D /var/lib/postgresql/12/main/ -Fp -Xs -R</p>\n<p>спросит пароль testpassword</p>\n<p>понятное дело что нифига не сработало т.к. мы то отресторили базу но не конифиги, поправил на новом мастере pg_hba и сделал поправил listen_addressess из-за чего пришлось ребутать сервер</p>"}},"pageContext":{"id":"d1353df5-2938-5a14-9e3b-3ab8b1604055"}},"staticQueryHashes":[],"slicesMap":{}}