{"componentChunkName":"component---src-templates-note-js","path":"/bigquery-sessions","result":{"data":{"remark":{"fields":{"path":"bigquery-sessions"},"meta":{"title":""},"headings":[{"value":"BigQuery Window Function Calculate User Sessions"}],"html":"<h1>BigQuery Window Function Calculate User Sessions</h1>\n<p>Combine stream of user actions with a timestamps into a windowed sessions example:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">WITH</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token comment\">-- user 1, session 1, morning</span>\n  <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 07:01:00'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token number\">1</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">,</span>\n                                   <span class=\"token string\">'view'</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">action</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 07:02:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'view'</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 07:03:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'view'</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 07:04:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'apply'</span>\n\n  <span class=\"token comment\">-- user 1, session 2, midday</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 12:01:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'view'</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 12:02:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'view'</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 12:03:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'apply'</span>\n\n  <span class=\"token comment\">-- user 1, session 3, evening</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 19:01:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'view'</span>\n\n\n\n  <span class=\"token comment\">-- user 2, session 1, evening</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 07:01:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'view'</span>\n\n  <span class=\"token comment\">-- user 2, session 2, evening</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 18:01:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'view'</span>\n  <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2001-01-01 18:01:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'apply'</span>\n\n<span class=\"token comment\">/*+---------------------+------+--------+\n  |      timestamp      | user | action |\n  +---------------------+------+--------+\n  | 2001-01-01 07:01:00 |    1 | view   |\n  | 2001-01-01 07:02:00 |    1 | view   |\n  | 2001-01-01 07:03:00 |    1 | view   |\n  | 2001-01-01 12:01:00 |    1 | view   |\n  | 2001-01-01 12:02:00 |    1 | view   |\n  | 2001-01-01 19:01:00 |    1 | view   |\n  | 2001-01-01 07:04:00 |    1 | apply  |\n  | 2001-01-01 12:03:00 |    1 | apply  |\n  | 2001-01-01 07:01:00 |    2 | view   |\n  | 2001-01-01 18:01:00 |    2 | view   |\n  | 2001-01-01 18:01:00 |    2 | apply  |\n  +---------------------+------+--------+*/</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> data_with_previous_timestamp <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">SELECT</span>\n  <span class=\"token comment\">-- POI: previous timestamp if any</span>\n  LAG<span class=\"token punctuation\">(</span><span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">PARTITION</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> previous_timestamp<span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> <span class=\"token keyword\">data</span>\n\n<span class=\"token comment\">/*+---------------------+---------------------+------+--------+\n  | previous_timestamp  |      timestamp      | user | action |\n  +---------------------+---------------------+------+--------+\n  |                NULL | 2001-01-01 07:01:00 |    1 | view   | &lt;- I have NO previous action\n  | 2001-01-01 07:01:00 | 2001-01-01 07:02:00 |    1 | view   | &lt;- I HAVE previous timestamp\n  | 2001-01-01 07:02:00 | 2001-01-01 07:03:00 |    1 | view   |\n  | 2001-01-01 07:03:00 | 2001-01-01 07:04:00 |    1 | apply  |\n  | 2001-01-01 07:04:00 | 2001-01-01 12:01:00 |    1 | view   |\n  | 2001-01-01 12:01:00 | 2001-01-01 12:02:00 |    1 | view   |\n  | 2001-01-01 12:02:00 | 2001-01-01 12:03:00 |    1 | apply  |\n  | 2001-01-01 12:03:00 | 2001-01-01 19:01:00 |    1 | view   |\n  |                NULL | 2001-01-01 07:01:00 |    2 | view   | &lt;- I have no previous action\n  | 2001-01-01 07:01:00 | 2001-01-01 18:01:00 |    2 | view   |\n  | 2001-01-01 18:01:00 | 2001-01-01 18:01:00 |    2 | apply  |\n  +---------------------+---------------------+------+--------+*/</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> data_with_is_new_session <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">SELECT</span>\n  <span class=\"token comment\">-- POI: 30 min window</span>\n  <span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> TIMESTAMP_DIFF<span class=\"token punctuation\">(</span><span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span> previous_timestamp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">MINUTE</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">30</span> <span class=\"token operator\">OR</span> previous_timestamp <span class=\"token operator\">IS</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">THEN</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ELSE</span> <span class=\"token number\">0</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> is_new_session<span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> data_with_previous_timestamp\n\n<span class=\"token comment\">/*+----------------+---------------------+---------------------+------+--------+\n  | is_new_session | previous_timestamp  |      timestamp      | user | action |\n  +----------------+---------------------+---------------------+------+--------+\n  |              1 |                NULL | 2001-01-01 07:01:00 |    1 | view   | &lt;- user 1, session 1\n  |              0 | 2001-01-01 07:01:00 | 2001-01-01 07:02:00 |    1 | view   |\n  |              0 | 2001-01-01 07:02:00 | 2001-01-01 07:03:00 |    1 | view   |\n  |              0 | 2001-01-01 07:03:00 | 2001-01-01 07:04:00 |    1 | apply  |\n  |              1 | 2001-01-01 07:04:00 | 2001-01-01 12:01:00 |    1 | view   | &lt;- user 1, session 2\n  |              0 | 2001-01-01 12:01:00 | 2001-01-01 12:02:00 |    1 | view   |\n  |              0 | 2001-01-01 12:02:00 | 2001-01-01 12:03:00 |    1 | apply  |\n  |              1 | 2001-01-01 12:03:00 | 2001-01-01 19:01:00 |    1 | view   | &lt;- user 1, session 3\n  |              1 |                NULL | 2001-01-01 07:01:00 |    2 | view   | &lt;- user 2, session 1\n  |              1 | 2001-01-01 07:01:00 | 2001-01-01 18:01:00 |    2 | view   | &lt;- user 2, session 2\n  |              0 | 2001-01-01 18:01:00 | 2001-01-01 18:01:00 |    2 | apply  |\n  +----------------+---------------------+---------------------+------+--------+*/</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> data_with_sessions <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">SELECT</span>\n  <span class=\"token comment\">-- POI: will be 1, 2, 3, 4, 5 - e.g. overall sessions</span>\n  <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>is_new_session<span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> global_session_id<span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">-- POI: will be 1, 2, 3 for user 1 and 1, 2 for user 2 - e.g. sessions per user</span>\n  <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>is_new_session<span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">PARTITION</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> user_session_id<span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">*</span>\n  <span class=\"token keyword\">FROM</span> data_with_is_new_session\n\n<span class=\"token comment\">/*+-------------------+-----------------+----------------+---------------------+---------------------+------+--------+\n  | global_session_id | user_session_id | is_new_session | previous_timestamp  |      timestamp      | user | action |\n  +-------------------+-----------------+----------------+---------------------+---------------------+------+--------+\n  |                 1 |               1 |              1 |                NULL | 2001-01-01 07:01:00 |    1 | view   |\n  |                 1 |               1 |              0 | 2001-01-01 07:01:00 | 2001-01-01 07:02:00 |    1 | view   |\n  |                 1 |               1 |              0 | 2001-01-01 07:02:00 | 2001-01-01 07:03:00 |    1 | view   |\n  |                 1 |               1 |              0 | 2001-01-01 07:03:00 | 2001-01-01 07:04:00 |    1 | apply  |\n  |                 2 |               2 |              1 | 2001-01-01 07:04:00 | 2001-01-01 12:01:00 |    1 | view   |\n  |                 2 |               2 |              0 | 2001-01-01 12:01:00 | 2001-01-01 12:02:00 |    1 | view   |\n  |                 2 |               2 |              0 | 2001-01-01 12:02:00 | 2001-01-01 12:03:00 |    1 | apply  |\n  |                 3 |               3 |              1 | 2001-01-01 12:03:00 | 2001-01-01 19:01:00 |    1 | view   |\n  |                 4 |               1 |              1 |                NULL | 2001-01-01 07:01:00 |    2 | view   |\n  |                 5 |               2 |              1 | 2001-01-01 07:01:00 | 2001-01-01 18:01:00 |    2 | view   |\n  |                 5 |               2 |              0 | 2001-01-01 18:01:00 | 2001-01-01 18:01:00 |    2 | apply  |\n  +-------------------+-----------------+----------------+---------------------+---------------------+------+--------+*/</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token function\">AVG</span><span class=\"token punctuation\">(</span>views<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> avg_views_per_session <span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">SELECT</span>\n  <span class=\"token comment\">-- user,</span>\n  <span class=\"token comment\">-- user_session_id,</span>\n  <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> views\n  <span class=\"token keyword\">FROM</span> data_with_sessions\n  <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'view'</span>\n  <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">,</span> user_session_id\n<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/*+-----------------------+\n  | avg_views_per_session |\n  +-----------------------+\n  |                   1.6 |\n  +-----------------------+*/</span></code></pre></div>\n<p><a href=\"https://blog.modeanalytics.com/finding-user-sessions-sql/\">Main source</a></p>\n<p>Note: to get ascii art use <code class=\"language-text\">bq query --nouse_legacy_sql \"select * from acme\"</code></p>"}},"pageContext":{"id":"51b87c5a-ce04-55e5-8edc-02d02703f133"}},"staticQueryHashes":[]}