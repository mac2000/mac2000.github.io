{"componentChunkName":"component---src-templates-note-js","path":"/geo-poluchenie-poleznoy-infyi-iz-adressa-ili-koordinat/","result":{"data":{"remark":{"fields":{"path":"geo-poluchenie-poleznoy-infyi-iz-adressa-ili-koordinat"},"meta":{"title":""},"headings":[{"value":"GEO получение полезной инфы из адресса или координат"}],"html":"<h1>GEO получение полезной инфы из адресса или координат</h1>\n<p>Полноценное использование современных сервисов для получения гео данных от пользователя.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b0afcfe61ad66b6615d7c0cc0c034bf7/95e27/map-helper.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.78125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABwElEQVR42o2R204aUQBF+f+P6JM+NGmrEVE7XKQ2VOstMWmhgMzlzDnDjIAwlzNnBjusRu1Lk6ZlJzvZTyvZWbWH0MOEPRL5FcfzCaOIx1VGFCiMaqOn5+jxPlUR85oN/0rtIeijhUUcXOK6No49wnUc5pEg9y1y2UY7R1TllsDIPseoDkZYpPf7JO4J2m6QiC6x+ITxW2Syw9M63xIorjH+MblzRObWSaVFIS2MbJL7bbQ8xfgnPM4UaarRWUaappii+DswlT1yt4FWpxjviGywRzw8RIuPZF4TPXqHURZSTDBFyXw2I9Oaqqr+AG02m5fWqkWP6sFiHbRJ5fNNCyOarIMWxfQM4zZYqxb3o2/MFgs812HQ72PbNkopojBkuVwSxzFaa2qRd4fXvyD0eoxmZ/wIPxN4PVynTai6zKdtVHjGajWn+llh8pw4TkiShDRJXnaWppRl+Xr5+Camfiu4ktfchB1uvT5fxkO6Y5u76XemwXsug2PS0vxW8h8pIurgTA+4D+o48gO+aCDVITLcQ3hvsUc7jJ1dyqfldpZX8oJo0mU+bpHYdSb+AX17j8FzJzuMB28YXu1SFHor4C8elepaqdCX4wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screenshot\"\n        title=\"\"\n        src=\"/static/b0afcfe61ad66b6615d7c0cc0c034bf7/2bef9/map-helper.png\"\n        srcset=\"/static/b0afcfe61ad66b6615d7c0cc0c034bf7/6f3f2/map-helper.png 256w,\n/static/b0afcfe61ad66b6615d7c0cc0c034bf7/01e7c/map-helper.png 512w,\n/static/b0afcfe61ad66b6615d7c0cc0c034bf7/2bef9/map-helper.png 1024w,\n/static/b0afcfe61ad66b6615d7c0cc0c034bf7/95e27/map-helper.png 1199w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Основная идея в том чтобы избавить пользователя от необходимости вручную вбивать такие данные как: Страна, Городо, Район. Достаточно лишь указать адрес или положение на карте все остальные данные получаются у Яндекса, Google и Wikimapia. Так же как дополнительный бонус, благодаря Яндексу можно получить данные о ближайших станциях метро.</p>\n<p>Это упрощает пользователю заполнение информации, все данные разбиты - то есть их можно будет использовать, к примеру, для поиска, скажем - \"выведи мне все записи у которых расстояние для ближайшего метро не больше 1000 метров\" или \"выведи мне все записи которые расположены в неофиц. микрорайоне Троещина\". Плюс ко всему можно будет на отдельных страницах выводить карты с объектами, строить маршруты и т.д. и т.п.</p>\n<p><strong>Как работает:</strong></p>\n<p>Довольно примитивный механизм - за основу взять geocoder Яндекса, в дополнение к нему дергается GoogleGeocoder (для получения координат района адреса) и Wikimapia (для получения микрорайонов адреса).</p>\n<p><strong>index.php</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">// KEYS</span>\n<span class=\"token variable\">$google</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'ABQIAAAALi8oup_hVN3coIirpDRtGBTNj2TnvvsBgOKuWKvD1ZenHSzIvhSH1vUUjJqNcahwBh-WWJjH_yteNg'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$yandex</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'AAyl3E0BAAAAjZLmXAQAfFspVbDVrROagfcue18lh24kJX0AAAAAAAAAAAC2vCPmciciz70C6HfABZKJKsbHZw=='</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span> <span class=\"token name\">PUBLIC</span> <span class=\"token string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span> <span class=\"token string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">xmlns</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://www.w3.org/1999/xhtml<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">http-equiv</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Content-Type<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/html; charset=utf-8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Map Helper<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/css<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n    <span class=\"token selector\">.map-helper-map,\n    .map-helper-overlay</span> <span class=\"token punctuation\">{</span><span class=\"token property\">width</span><span class=\"token punctuation\">:</span>100%<span class=\"token punctuation\">;</span><span class=\"token property\">height</span><span class=\"token punctuation\">:</span>100%<span class=\"token punctuation\">;</span><span class=\"token property\">position</span><span class=\"token punctuation\">:</span>absolute<span class=\"token punctuation\">;</span><span class=\"token property\">top</span><span class=\"token punctuation\">:</span>0<span class=\"token punctuation\">;</span><span class=\"token property\">left</span><span class=\"token punctuation\">:</span>0<span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span>\n    <span class=\"token selector\">.map-helper-overlay</span> <span class=\"token punctuation\">{</span><span class=\"token property\">z-index</span><span class=\"token punctuation\">:</span>2<span class=\"token punctuation\">;</span><span class=\"token property\">background</span><span class=\"token punctuation\">:</span>#fff <span class=\"token url\"><span class=\"token function\">url</span><span class=\"token punctuation\">(</span>http://habrastorage.org/storage/2a669297/3429d7a7/4513bfa8/bcb5be20.gif<span class=\"token punctuation\">)</span></span> no-repeat 50% 50%<span class=\"token punctuation\">;</span><span class=\"token property\">filter</span><span class=\"token punctuation\">:</span><span class=\"token property\">progid</span><span class=\"token punctuation\">:</span>DXImageTransform.Microsoft.<span class=\"token function\">Alpha</span><span class=\"token punctuation\">(</span>opacity=50<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token property\">-moz-opacity</span><span class=\"token punctuation\">:</span> 0.5<span class=\"token punctuation\">;</span><span class=\"token property\">-khtml-opacity</span><span class=\"token punctuation\">:</span> 0.5<span class=\"token punctuation\">;</span><span class=\"token property\">opacity</span><span class=\"token punctuation\">:</span> 0.5<span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://code.jquery.com/jquery-1.5.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://maps.google.com/maps?file=api<span class=\"token entity named-entity\" title=\"&amp;\">&amp;amp;</span>v=2.133d<span class=\"token entity named-entity\" title=\"&amp;\">&amp;amp;</span>key=<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">print</span> <span class=\"token variable\">$google</span><span class=\"token delimiter important\">?></span></span><span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://api-maps.yandex.ru/1.1/index.xml?key=<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">print</span> <span class=\"token variable\">$yandex</span><span class=\"token delimiter important\">?></span></span>&amp;modules=regions~metro~pmap<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n    <span class=\"token keyword\">var</span> map_holder_selector <span class=\"token operator\">=</span> <span class=\"token string\">'#map'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">var</span> map<span class=\"token punctuation\">,</span> placemark<span class=\"token punctuation\">,</span> yandex_geocoder<span class=\"token punctuation\">,</span> metro_geocoder<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> google_geocoder <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">var</span> is_search_done <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">yandex_geocoder</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">google_geocoder</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">metro_geocoder</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">wikimapia_geocoder</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">var</span> current_point_geodata <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">Latitude</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">Longtitude</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">YandexAddressDetails</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">GoogleAddressDetails</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">WikimapiaAddressDetails</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">metroStations</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    YMaps<span class=\"token punctuation\">.</span><span class=\"token function\">jQuery</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        google_geocoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GClientGeocoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        YMaps<span class=\"token punctuation\">.</span><span class=\"token function\">jQuery</span><span class=\"token punctuation\">(</span>map_holder_selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">css</span><span class=\"token punctuation\">(</span><span class=\"token string\">'position'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'relative'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">html</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;div class=\"map-helper-map\">&lt;/div>&lt;div class=\"map-helper-overlay\" style=\"display:none\">&lt;/div>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        map <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>Map</span><span class=\"token punctuation\">(</span>YMaps<span class=\"token punctuation\">.</span><span class=\"token function\">jQuery</span><span class=\"token punctuation\">(</span>map_holder_selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div.map-helper-map:first'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        map<span class=\"token punctuation\">.</span><span class=\"token function\">setCenter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>GeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token number\">30.522301</span><span class=\"token punctuation\">,</span> <span class=\"token number\">50.451118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        map<span class=\"token punctuation\">.</span><span class=\"token function\">addControl</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>Zoom</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> searchControl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>SearchControl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">noPlacemark</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        map<span class=\"token punctuation\">.</span><span class=\"token function\">addControl</span><span class=\"token punctuation\">(</span>searchControl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        placemark <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>Placemark</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">.</span><span class=\"token function\">getCenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">draggable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">style</span><span class=\"token operator\">:</span> <span class=\"token string\">'default#hospitalIcon'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        placemark<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"Москва\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//TODO: change this</span>\n        placemark<span class=\"token punctuation\">.</span>description <span class=\"token operator\">=</span> <span class=\"token string\">\"Столица Российской Федерации\"</span><span class=\"token punctuation\">;</span>\n\n        map<span class=\"token punctuation\">.</span><span class=\"token function\">addOverlay</span><span class=\"token punctuation\">(</span>placemark<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">getgeodata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        YMaps<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>searchControl<span class=\"token punctuation\">,</span> searchControl<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span>Select<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">obj<span class=\"token punctuation\">,</span> geoResult</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            placemark<span class=\"token punctuation\">.</span><span class=\"token function\">setGeoPoint</span><span class=\"token punctuation\">(</span>geoResult<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">getgeodata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        YMaps<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>placemark<span class=\"token punctuation\">,</span> placemark<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span>DragEnd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">getgeodata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">show_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            YMaps<span class=\"token punctuation\">.</span><span class=\"token function\">jQuery</span><span class=\"token punctuation\">(</span>map_holder_selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div.map-helper-overlay:first'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            YMaps<span class=\"token punctuation\">.</span>jQuery<span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span>is_search_done<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">k<span class=\"token punctuation\">,</span> v</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                is_search_done<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">hide_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> res <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n            YMaps<span class=\"token punctuation\">.</span>jQuery<span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span>is_search_done<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">k<span class=\"token punctuation\">,</span> v</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>v <span class=\"token operator\">&amp;&amp;</span> res<span class=\"token punctuation\">)</span> res <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                YMaps<span class=\"token punctuation\">.</span><span class=\"token function\">jQuery</span><span class=\"token punctuation\">(</span>map_holder_selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div.map-helper-overlay:first'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">hide</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                YMaps<span class=\"token punctuation\">.</span><span class=\"token function\">jQuery</span><span class=\"token punctuation\">(</span>map_holder_selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span><span class=\"token string\">'change'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">proccess_geo_data</span><span class=\"token punctuation\">(</span>current_point_geodata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">getgeodata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">show_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            current_point_geodata<span class=\"token punctuation\">.</span>Latitude <span class=\"token operator\">=</span> placemark<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            current_point_geodata<span class=\"token punctuation\">.</span>Longtitude <span class=\"token operator\">=</span> placemark<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLng</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">//get yandex address details</span>\n            yandex_geocoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>Geocoder</span><span class=\"token punctuation\">(</span>placemark<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">results</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            YMaps<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>yandex_geocoder<span class=\"token punctuation\">,</span> yandex_geocoder<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span>Load<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                current_point_geodata<span class=\"token punctuation\">.</span>YandexAddressDetails <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    current_point_geodata<span class=\"token punctuation\">.</span>YandexAddressDetails <span class=\"token operator\">=</span> <span class=\"token function\">getFlatAddressDetails</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>AddressDetails<span class=\"token punctuation\">,</span> current_point_geodata<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                is_search_done<span class=\"token punctuation\">.</span>yandex_geocoder <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">hide_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            YMaps<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>yandex_geocoder<span class=\"token punctuation\">,</span> yandex_geocoder<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span>Fault<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">yandex_geocoder<span class=\"token punctuation\">,</span> error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                current_point_geodata<span class=\"token punctuation\">.</span>YandexAddressDetails <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n                is_search_done<span class=\"token punctuation\">.</span>yandex_geocoder <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">hide_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">//get closes metro stations</span>\n            <span class=\"token keyword\">var</span> metro_geocoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>Metro<span class=\"token punctuation\">.</span>Closest</span><span class=\"token punctuation\">(</span>placemark<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">results</span> <span class=\"token operator\">:</span> <span class=\"token number\">2</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            YMaps<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>metro_geocoder<span class=\"token punctuation\">,</span> metro_geocoder<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span>Load<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">metro_geocoder</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                current_point_geodata<span class=\"token punctuation\">.</span>metroStations <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>metro_geocoder<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> metro_geocoder<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">var</span> metro_station <span class=\"token operator\">=</span> metro_geocoder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">var</span> metroFlatAddressDetails <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n                        metroFlatAddressDetails <span class=\"token operator\">=</span> <span class=\"token function\">getFlatAddressDetails</span><span class=\"token punctuation\">(</span>metro_station<span class=\"token punctuation\">.</span>AddressDetails<span class=\"token punctuation\">,</span> metroFlatAddressDetails<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> metroFlatAddressDetails<span class=\"token punctuation\">.</span>PremiseName <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">var</span> dist <span class=\"token operator\">=</span> <span class=\"token function\">Distance</span><span class=\"token punctuation\">(</span>placemark<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> placemark<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLng</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> metro_station<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> metro_station<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLng</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">var</span> o <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                                <span class=\"token literal-property property\">Name</span><span class=\"token operator\">:</span> metroFlatAddressDetails<span class=\"token punctuation\">.</span>PremiseName<span class=\"token punctuation\">,</span>\n                                <span class=\"token literal-property property\">Distance</span><span class=\"token operator\">:</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>dist<span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n                            current_point_geodata<span class=\"token punctuation\">.</span>metroStations<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                is_search_done<span class=\"token punctuation\">.</span>metro_geocoder <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">hide_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            YMaps<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>metro_geocoder<span class=\"token punctuation\">,</span> metro_geocoder<span class=\"token punctuation\">.</span>Events<span class=\"token punctuation\">.</span>Fault<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">metro_geocoder<span class=\"token punctuation\">,</span> error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                current_point_geodata<span class=\"token punctuation\">.</span>metroStations <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                is_search_done<span class=\"token punctuation\">.</span>metro_geocoder <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">hide_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">//get google address details</span>\n            google_geocoder<span class=\"token punctuation\">.</span><span class=\"token function\">getLocations</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">GLatLng</span><span class=\"token punctuation\">(</span>placemark<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> placemark<span class=\"token punctuation\">.</span><span class=\"token function\">getGeoPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLng</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">addresses</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>addresses<span class=\"token punctuation\">.</span>Status<span class=\"token punctuation\">.</span>code <span class=\"token operator\">!=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    current_point_geodata<span class=\"token punctuation\">.</span>GoogleAddressDetails <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n                    is_search_done<span class=\"token punctuation\">.</span>google_geocoder <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">hide_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    current_point_geodata<span class=\"token punctuation\">.</span>GoogleAddressDetails <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n                    current_point_geodata<span class=\"token punctuation\">.</span>GoogleAddressDetails <span class=\"token operator\">=</span> <span class=\"token function\">getFlatAddressDetails</span><span class=\"token punctuation\">(</span>addresses<span class=\"token punctuation\">.</span>Placemark<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>AddressDetails<span class=\"token punctuation\">,</span> current_point_geodata<span class=\"token punctuation\">.</span>GoogleAddressDetails<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                    <span class=\"token keyword\">var</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token literal-property property\">lon</span> <span class=\"token operator\">:</span> current_point_geodata<span class=\"token punctuation\">.</span>Longtitude<span class=\"token punctuation\">,</span>\n                        <span class=\"token literal-property property\">lat</span> <span class=\"token operator\">:</span> current_point_geodata<span class=\"token punctuation\">.</span>Latitude<span class=\"token punctuation\">,</span>\n                        <span class=\"token literal-property property\">lon_min</span> <span class=\"token operator\">:</span> addresses<span class=\"token punctuation\">.</span>Placemark<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>ExtendedData<span class=\"token punctuation\">.</span>LatLonBox<span class=\"token punctuation\">.</span>west<span class=\"token punctuation\">,</span>\n                        <span class=\"token literal-property property\">lat_min</span> <span class=\"token operator\">:</span> addresses<span class=\"token punctuation\">.</span>Placemark<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>ExtendedData<span class=\"token punctuation\">.</span>LatLonBox<span class=\"token punctuation\">.</span>south<span class=\"token punctuation\">,</span>\n                        <span class=\"token literal-property property\">lon_max</span> <span class=\"token operator\">:</span> addresses<span class=\"token punctuation\">.</span>Placemark<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>ExtendedData<span class=\"token punctuation\">.</span>LatLonBox<span class=\"token punctuation\">.</span>east<span class=\"token punctuation\">,</span>\n                        <span class=\"token literal-property property\">lat_max</span> <span class=\"token operator\">:</span> addresses<span class=\"token punctuation\">.</span>Placemark<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>ExtendedData<span class=\"token punctuation\">.</span>LatLonBox<span class=\"token punctuation\">.</span>north\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n                    current_point_geodata<span class=\"token punctuation\">.</span>WikimapiaAddressDetails <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                    YMaps<span class=\"token punctuation\">.</span>jQuery<span class=\"token punctuation\">.</span><span class=\"token function\">getJSON</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wikimapia.php'</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token punctuation\">,</span> textStatus<span class=\"token punctuation\">,</span> jqXHR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                        YMaps<span class=\"token punctuation\">.</span>jQuery<span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">k<span class=\"token punctuation\">,</span> v</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                            current_point_geodata<span class=\"token punctuation\">.</span>WikimapiaAddressDetails<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        is_search_done<span class=\"token punctuation\">.</span>wikimapia_geocoder <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token function\">hide_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token comment\">//TODO: get wikimapia data here</span>\n\n                    is_search_done<span class=\"token punctuation\">.</span>google_geocoder <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">hide_overlay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">dump</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">/*var res = document.getElementById('res');\n            h = '';\n\n            h += '&lt;b>Latitude&lt;/b> : ' + current_point_geodata.Latitude + '&lt;br />';\n            h += '&lt;b>Longtitude&lt;/b> : ' + current_point_geodata.Longtitude + '&lt;br />';\n\n            h += '&lt;br />&lt;b>Yandex Address Details&lt;/b>&lt;hr />';\n            YMaps.jQuery.each(current_point_geodata.YandexAddressDetails, function(k, v){\n                h += '&lt;b>' + k + '&lt;/b> : ' + v + '&lt;br />';\n            });\n            h += '&lt;br />&lt;b>Google Address Details&lt;/b>&lt;hr />';\n            YMaps.jQuery.each(current_point_geodata.GoogleAddressDetails, function(k, v){\n                h += '&lt;b>' + k + '&lt;/b> : ' + v + '&lt;br />';\n            });\n            h += '&lt;br />&lt;b>Wikimapia Address Details&lt;/b>&lt;hr />';\n            h += current_point_geodata.WikimapiaAddressDetails.join(', ');\n\n            h += '&lt;br />&lt;br />&lt;b>Metro stations&lt;/b>&lt;hr />';\n            YMaps.jQuery.each(current_point_geodata.metroStations, function(k, v){\n                YMaps.jQuery.each(v, function(k, v){\n                    h += '&lt;b>metro ' + k + '&lt;/b> : ' + v + '&lt;br />';\n                });\n            });\n\n            res.innerHTML = h;*/</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">getFlatAddressDetails</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">AddressDetails<span class=\"token punctuation\">,</span> FlatAddressDetails</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            YMaps<span class=\"token punctuation\">.</span>jQuery<span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span>AddressDetails<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">k<span class=\"token punctuation\">,</span> v</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> v <span class=\"token operator\">==</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span> FlatAddressDetails <span class=\"token operator\">=</span> <span class=\"token function\">getFlatAddressDetails</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> FlatAddressDetails<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> v <span class=\"token operator\">==</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> FlatAddressDetails<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> FlatAddressDetails<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">Distance</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">lat1<span class=\"token punctuation\">,</span>lng1<span class=\"token punctuation\">,</span>lat2<span class=\"token punctuation\">,</span>lng2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> plq <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>GeoCoordSystem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Rasto <span class=\"token operator\">=</span> plq<span class=\"token punctuation\">.</span><span class=\"token function\">distance</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>GeoPoint</span><span class=\"token punctuation\">(</span>lat1<span class=\"token punctuation\">,</span>lng1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">YMaps<span class=\"token punctuation\">.</span>GeoPoint</span><span class=\"token punctuation\">(</span>lat2<span class=\"token punctuation\">,</span>lng2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> Rasto<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">get_wikimapia_url</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">LatLonBox</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">'http://api.wikimapia.org/?function=box&amp;key='</span> <span class=\"token operator\">+</span> wikimapia_key <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;language=ru&amp;lon_min='</span> <span class=\"token operator\">+</span> LatLonBox<span class=\"token punctuation\">.</span>west <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;lat_min='</span> <span class=\"token operator\">+</span> LatLonBox<span class=\"token punctuation\">.</span>south <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;lon_max='</span> <span class=\"token operator\">+</span> LatLonBox<span class=\"token punctuation\">.</span>east <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;lat_max='</span> <span class=\"token operator\">+</span> LatLonBox<span class=\"token punctuation\">.</span>north <span class=\"token operator\">+</span> <span class=\"token string\">'&amp;rsaquo&amp;count=100'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">function</span> <span class=\"token function\">proccess_geo_data</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> res <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n            res<span class=\"token punctuation\">.</span>Latitude <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>Latitude<span class=\"token punctuation\">;</span>\n            res<span class=\"token punctuation\">.</span>Longtitude <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>Longtitude<span class=\"token punctuation\">;</span>\n\n            res<span class=\"token punctuation\">.</span>Country <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">.</span>GoogleAddressDetails<span class=\"token punctuation\">.</span>CountryName <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span>Country <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>GoogleAddressDetails<span class=\"token punctuation\">.</span>CountryName<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>CountryName <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span>Country <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>CountryName<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            res<span class=\"token punctuation\">.</span>City <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">.</span>GoogleAddressDetails<span class=\"token punctuation\">.</span>LocalityName <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span>City <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>GoogleAddressDetails<span class=\"token punctuation\">.</span>LocalityName<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>LocalityName <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span>City <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>LocalityName<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            res<span class=\"token punctuation\">.</span>Distinct <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>DependentLocalityName <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span>Distinct <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>DependentLocalityName<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            res<span class=\"token punctuation\">.</span>Street <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">.</span>GoogleAddressDetails<span class=\"token punctuation\">.</span>ThoroughfareName <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span>Street <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>GoogleAddressDetails<span class=\"token punctuation\">.</span>ThoroughfareName<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>ThoroughfareName <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span>Street <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>ThoroughfareName<span class=\"token punctuation\">;</span>\n\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>PremiseNumber <span class=\"token operator\">!=</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    res<span class=\"token punctuation\">.</span>Street <span class=\"token operator\">+=</span> <span class=\"token string\">', '</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>YandexAddressDetails<span class=\"token punctuation\">.</span>PremiseNumber<span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n\n            res<span class=\"token punctuation\">.</span>MetroStations <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>metroStations<span class=\"token punctuation\">;</span>\n\n            res<span class=\"token punctuation\">.</span>MicroDistincts <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            YMaps<span class=\"token punctuation\">.</span>jQuery<span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>WikimapiaAddressDetails<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">k<span class=\"token punctuation\">,</span> v</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>v <span class=\"token operator\">!=</span> res<span class=\"token punctuation\">.</span>Country <span class=\"token operator\">&amp;&amp;</span> v <span class=\"token operator\">!=</span> res<span class=\"token punctuation\">.</span>City <span class=\"token operator\">&amp;&amp;</span> v <span class=\"token operator\">!=</span> res<span class=\"token punctuation\">.</span>Distinct<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    res<span class=\"token punctuation\">.</span>MicroDistincts<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        YMaps<span class=\"token punctuation\">.</span><span class=\"token function\">jQuery</span><span class=\"token punctuation\">(</span>map_holder_selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string\">'change'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> res <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'res'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            h <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;table>'</span><span class=\"token punctuation\">;</span>\n\n            h <span class=\"token operator\">+=</span> <span class=\"token string\">'&lt;tr>&lt;th align=\"left\">Point(lat, lng)&lt;/th>&lt;td>'</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>Latitude <span class=\"token operator\">+</span> <span class=\"token string\">', '</span> <span class=\"token operator\">+</span>  data<span class=\"token punctuation\">.</span>Longtitude <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;/td>&lt;/tr>'</span><span class=\"token punctuation\">;</span>\n            h <span class=\"token operator\">+=</span> <span class=\"token string\">'&lt;tr>&lt;th align=\"left\">Страна&lt;/th>&lt;td>'</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>Country <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;/td>&lt;/tr>'</span><span class=\"token punctuation\">;</span>\n            h <span class=\"token operator\">+=</span> <span class=\"token string\">'&lt;tr>&lt;th align=\"left\">Город&lt;/th>&lt;td>'</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>City <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;/td>&lt;/tr>'</span><span class=\"token punctuation\">;</span>\n            h <span class=\"token operator\">+=</span> <span class=\"token string\">'&lt;tr>&lt;th align=\"left\">Район&lt;/th>&lt;td>'</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>Distinct <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;/td>&lt;/tr>'</span><span class=\"token punctuation\">;</span>\n            h <span class=\"token operator\">+=</span> <span class=\"token string\">'&lt;tr>&lt;th align=\"left\">Район (неофиц.)&lt;/th>&lt;td>'</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>MicroDistincts<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">', '</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;/td>&lt;/tr>'</span><span class=\"token punctuation\">;</span>\n            h <span class=\"token operator\">+=</span> <span class=\"token string\">'&lt;tr>&lt;th align=\"left\">Улица&lt;/th>&lt;td>'</span> <span class=\"token operator\">+</span> data<span class=\"token punctuation\">.</span>Street <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;/td>&lt;/tr>'</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">var</span> m <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            YMaps<span class=\"token punctuation\">.</span>jQuery<span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>MetroStations<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">k<span class=\"token punctuation\">,</span> v</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                m<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">+</span> <span class=\"token string\">' ('</span> <span class=\"token operator\">+</span> v<span class=\"token punctuation\">.</span>Distance <span class=\"token operator\">+</span> <span class=\"token string\">'м.)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            h <span class=\"token operator\">+=</span> <span class=\"token string\">'&lt;tr>&lt;th align=\"left\">Метро&lt;/th>&lt;td>'</span> <span class=\"token operator\">+</span> m<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">', '</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;/td>&lt;/tr>'</span><span class=\"token punctuation\">;</span>\n\n            res<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> h<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>table</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>tr</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>td</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>map<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span>600px<span class=\"token punctuation\">;</span><span class=\"token property\">height</span><span class=\"token punctuation\">:</span>600px<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>td</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>td</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>res<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>td</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>tr</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>table</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p><strong>wikimapia.php</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">//TODO: cache results</span>\n<span class=\"token variable\">$key</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'831889EA-4C4527B7-870F69D2-C37B4C61-46DBC5D8-04493657-73823C37-F7A4545C'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$lat</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">floatval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$lat_max</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat_max'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">floatval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat_max'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$lat_min</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat_min'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">floatval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat_min'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$lon</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lon'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">floatval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lon'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$lon_max</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lon_max'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">floatval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lon_max'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$lon_min</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lon_min'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">floatval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_REQUEST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lon_min'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">false</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token variable\">$lat</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token variable\">$lat_max</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token variable\">$lat_min</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token variable\">$lon</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token variable\">$lon_max</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token variable\">$lon_min</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wrong params'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$places</span> <span class=\"token operator\">=</span> <span class=\"token function\">get_places_from_cache</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_min</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_min</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//echo 'Total: ' . count($places) . '&lt;br />';</span>\n\n<span class=\"token variable\">$tags</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$places</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$place</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$in_poly</span> <span class=\"token operator\">=</span> <span class=\"token function\">is_in_polygon</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$place</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'points'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$in_poly</span><span class=\"token punctuation\">)</span>\n        <span class=\"token variable\">$tags</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$place</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$tags</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_unique</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$tags</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//foreach($tags as $tag) {</span>\n<span class=\"token comment\">//  echo $tag . '&lt;br />';</span>\n<span class=\"token comment\">//}</span>\n\n<span class=\"token keyword\">echo</span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$tags</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/////////////////////////////////////////////////</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">get_cache_key</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$lat_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_min</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_min</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-casting\">string</span><span class=\"token punctuation\">)</span><span class=\"token variable\">$lat_max</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'-'</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-casting\">string</span><span class=\"token punctuation\">)</span><span class=\"token variable\">$lat_min</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'-'</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-casting\">string</span><span class=\"token punctuation\">)</span><span class=\"token variable\">$lon_max</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'-'</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-casting\">string</span><span class=\"token punctuation\">)</span><span class=\"token variable\">$lon_min</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">get_places_from_cache</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_min</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_min</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$cache_key</span> <span class=\"token operator\">=</span> <span class=\"token function\">get_cache_key</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$lat_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_min</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_min</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$cache_file</span> <span class=\"token operator\">=</span> <span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/cache/'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$cache_key</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$places</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$cache_file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$places</span> <span class=\"token operator\">=</span> <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$cache_file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$places</span> <span class=\"token operator\">=</span> <span class=\"token function\">get_places_from_wikimapia</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_min</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_min</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">file_put_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$cache_file</span><span class=\"token punctuation\">,</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$places</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$places</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">get_places_from_wikimapia</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat_min</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_max</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lon_min</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$page</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$results</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$places</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'http://api.wikimapia.org/?function=box&amp;key='</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$key</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&amp;language=ru&amp;lon_min='</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$lon_min</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&amp;lat_min='</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$lat_min</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&amp;lon_max='</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$lon_max</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&amp;lat_max='</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$lat_max</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&amp;rsaquo&amp;count=100&amp;page='</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$page</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$xml</span> <span class=\"token operator\">=</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//TODO: try catch here</span>\n\n        <span class=\"token variable\">$doc</span><span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DOMDocument</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$doc</span><span class=\"token operator\">-></span><span class=\"token function\">loadXML</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$xml</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$found</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$doc</span><span class=\"token operator\">-></span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'folder'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">item</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'found'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$pages</span> <span class=\"token operator\">=</span> <span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$found</span> <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$found</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token variable\">$page</span><span class=\"token operator\">++</span> <span class=\"token operator\">>=</span> <span class=\"token variable\">$pages</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$results</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token variable\">$items</span> <span class=\"token operator\">=</span> <span class=\"token function\">get_places_from_xml</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$doc</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$items</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$item</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$places</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$item</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$results</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$places</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">get_places_from_xml</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">DOMDocument</span> <span class=\"token variable\">$doc</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$places</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$doc</span><span class=\"token operator\">-></span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'place'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$node</span><span class=\"token operator\">-></span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">item</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token property\">nodeValue</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$points</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$node</span><span class=\"token operator\">-></span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'point'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$p</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$lng</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$p</span><span class=\"token operator\">-></span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'x'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$lat</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$p</span><span class=\"token operator\">-></span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'y'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string single-quoted-string\">'lng'</span> <span class=\"token operator\">=></span> <span class=\"token function\">floatval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$lng</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'lat'</span> <span class=\"token operator\">=></span> <span class=\"token function\">floatval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$lat</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token variable\">$places</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string single-quoted-string\">'name'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$name</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'points'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$points</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$places</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">is_in_polygon</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$points</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lat</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$lng</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$j</span><span class=\"token operator\">=</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$points</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$in_poly</span><span class=\"token operator\">=</span><span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">&lt;</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$points</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span><span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lng'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$lng</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$j</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lng'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">>=</span> <span class=\"token variable\">$lng</span> <span class=\"token operator\">||</span>  <span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$j</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lng'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$lng</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lng'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">>=</span> <span class=\"token variable\">$lng</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$lng</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lng'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$j</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lng'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lng'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$j</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token variable\">$points</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'lat'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$lat</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token variable\">$in_poly</span><span class=\"token operator\">=</span><span class=\"token operator\">!</span><span class=\"token variable\">$in_poly</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token variable\">$j</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$i</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$in_poly</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>В факту выбора нового адреса\\положения на карте генерируется событие change на которое можно повесится откуда угодно. В качестве параметров передаются полученные данные.</p>\n<p>TODO: интегрироваться в Drupal</p>\n<p>TODO: research добавление координаты в Google Places, Народные карты Яндекс и Wikimapia</p>"}},"pageContext":{"id":"434c0841-ddbe-53f4-aa42-7da79c1aa7ab"}},"staticQueryHashes":[],"slicesMap":{}}