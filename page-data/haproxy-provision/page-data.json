{"componentChunkName":"component---src-templates-note-js","path":"/haproxy-provision/","result":{"data":{"remark":{"fields":{"path":"haproxy-provision"},"meta":{"title":""},"headings":[{"value":"HAproxy provision sample"}],"html":"<h1>HAproxy provision sample</h1>\n<p>Here is simple example of HAproxy</p>\n<p><strong>Vagrantfile</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">Vagrant<span class=\"token punctuation\">.</span>configure<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"2\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>config<span class=\"token operator\">|</span>\n    config<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>define <span class=\"token string-literal\"><span class=\"token string\">\"web1\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>node<span class=\"token operator\">|</span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"web1\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>box <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"wildetech/hyper-u1404\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>provision <span class=\"token symbol\">:shell</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">path</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Web.sh\"</span></span>\n    <span class=\"token keyword\">end</span>\n\n    config<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>define <span class=\"token string-literal\"><span class=\"token string\">\"web2\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>node<span class=\"token operator\">|</span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"web2\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>box <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"wildetech/hyper-u1404\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>provision <span class=\"token symbol\">:shell</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">path</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"Web.sh\"</span></span>\n    <span class=\"token keyword\">end</span>\n\n    config<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>define <span class=\"token string-literal\"><span class=\"token string\">\"ha\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>node<span class=\"token operator\">|</span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"ha\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>box <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"wildetech/hyper-u1404\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>provision <span class=\"token symbol\">:shell</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">path</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"HA.sh\"</span></span>\n    <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p><strong>Web.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> apache2 php5 libapache2-mod-php5\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">rm</span> /var/www/html/index.html\n<span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /vagrant/index.php /var/www/html/index.php</code></pre></div>\n<p><strong>HA.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> haproxy\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/ENABLED=0/ENABLED=1/'</span> /etc/default/haproxy\n\n<span class=\"token assign-left variable\">WEB1_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">host</span> web1 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'/has address/ { print $4 ; exit }'</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">WEB2_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">host</span> web2 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'/has address/ { print $4 ; exit }'</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">--append</span> /etc/haproxy/haproxy.cfg <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\n\nfrontend www\n        bind *:80\n        mode http\n        default_backend nodes\n\nbackend nodes\n        mode http\n        balance roundrobin\n        option forwardfor\n        server web1 <span class=\"token variable\">$WEB1_IP</span>:80 check\n        server web2 <span class=\"token variable\">$WEB2_IP</span>:80 check\n\nlisten stats *:1936\n        stats enable\n        stats uri /\n        stats auth vagrant:vagrant\nEOF</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> haproxy restart</code></pre></div>\n<p><strong>index.php</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token delimiter important\">?></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">text-align</span><span class=\"token punctuation\">:</span>center</span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token string backtick-quoted-string\">`uname -n`</span> <span class=\"token delimiter important\">?></span></span>\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">echo</span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'h:i:s'</span><span class=\"token punctuation\">)</span> <span class=\"token delimiter important\">?></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Now you will be able to access: <a href=\"http://ha/\">http://ha/</a> which will be balanced with roundrobin between two nodes (take a note that by making one request from browser you probably will always get to same node, use something like <code class=\"language-text\">ab</code>)</p>\n<p><a href=\"http://ha:1936/\">http://ha:1936/</a> - haproxy stats</p>\n<p>And yet another example for memcached servers:</p>\n<p><strong>Vagrantfile</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">Vagrant<span class=\"token punctuation\">.</span>configure<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"2\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>config<span class=\"token operator\">|</span>\n    config<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>define <span class=\"token string-literal\"><span class=\"token string\">\"memcached1\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>node<span class=\"token operator\">|</span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"memcached1\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>box <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"wildetech/hyper-u1404\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>provision <span class=\"token symbol\">:shell</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">path</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"memcached.sh\"</span></span>\n    <span class=\"token keyword\">end</span>\n\n    config<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>define <span class=\"token string-literal\"><span class=\"token string\">\"memcached2\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>node<span class=\"token operator\">|</span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"memcached2\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>box <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"wildetech/hyper-u1404\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>provision <span class=\"token symbol\">:shell</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">path</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"memcached.sh\"</span></span>\n    <span class=\"token keyword\">end</span>\n\n    config<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>define <span class=\"token string-literal\"><span class=\"token string\">\"ha\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>node<span class=\"token operator\">|</span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"ha\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>box <span class=\"token operator\">=</span> <span class=\"token string-literal\"><span class=\"token string\">\"wildetech/hyper-u1404\"</span></span>\n    node<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>provision <span class=\"token symbol\">:shell</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">path</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"ha.sh\"</span></span>\n    <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p><strong>memcached.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> memcached\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/-l 127.0.0.1/-l 0.0.0.0/'</span> /etc/memcached.conf\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> memcached restart</code></pre></div>\n<p><strong>ha.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> haproxy\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/ENABLED=0/ENABLED=1/'</span> /etc/default/haproxy\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/mode\\(\\s*\\)http/mode\\1tcp/'</span> /etc/haproxy/haproxy.cfg\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/option\\(\\s*\\)httplog/option\\1tcplog/'</span> /etc/haproxy/haproxy.cfg\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/contimeout\\(\\s*\\)5000/contimeout\\12000/'</span> /etc/haproxy/haproxy.cfg\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/clitimeout\\(\\s*\\)50000/clitimeout\\12000/'</span> /etc/haproxy/haproxy.cfg\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/srvtimeout\\(\\s*\\)50000/srvtimeout\\12000/'</span> /etc/haproxy/haproxy.cfg\n\n<span class=\"token assign-left variable\">MEMCACHED1_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">host</span> memcached1 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'/has address/ { print $4 ; exit }'</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">MEMCACHED2_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">host</span> memcached2 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'/has address/ { print $4 ; exit }'</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">--append</span> /etc/haproxy/haproxy.cfg <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\n\nlisten memcached\n    bind *:11211\n    balance leastconn\n    server memcached1 <span class=\"token variable\">$MEMCACHED1_IP</span>:11211 check\n    server memcached2 <span class=\"token variable\">$MEMCACHED2_IP</span>:11211 check\n\nlisten stats *:1936\n    mode http\n    stats enable\n    stats uri /\n    stats auth vagrant:vagrant\nEOF</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> haproxy restart</code></pre></div>\n<p>Same thing but with docker containers:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--name</span> mem1 <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">11212</span>:11211 memcached\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--name</span> mem2 <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">11213</span>:11211 memcached\n\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> ha <span class=\"token parameter variable\">-p</span> <span class=\"token number\">1936</span>:1936 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">11211</span>:11211 <span class=\"token parameter variable\">--link</span> mem1:mem1 <span class=\"token parameter variable\">--link</span> mem2:mem2 <span class=\"token parameter variable\">-v</span> /vagrant/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro haproxy</code></pre></div>\n<p>and its haproxy config:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">global\n    maxconn 4096\n    #daemon #must be commented\n\ndefaults\n    mode http\n    timeout connect 2000ms\n    timeout client 2000ms\n    timeout server 2000ms\n\nlisten memcached\n    bind *:11211\n    mode tcp\n    balance leastconn\n    server mem1 ${MEM1_PORT_11211_TCP_ADDR}:${MEM1_PORT_11211_TCP_PORT} check\n    server mem2 ${MEM2_PORT_11211_TCP_ADDR}:${MEM2_PORT_11211_TCP_PORT} check\n\nlisten stats *:1936\n    mode http\n    stats enable\n    stats uri /\n    stats auth vagrant:vagrant</code></pre></div>"}},"pageContext":{"id":"bb0aea75-93aa-5454-9086-2e76e775f370"}},"staticQueryHashes":[],"slicesMap":{}}