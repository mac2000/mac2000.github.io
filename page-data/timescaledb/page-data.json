{"componentChunkName":"component---src-templates-note-js","path":"/timescaledb/","result":{"data":{"remark":{"fields":{"path":"timescaledb"},"meta":{"title":""},"headings":[{"value":"TimescaleDB"}],"html":"<h1>TimescaleDB</h1>\n<p><strong>TimescaleDB:</strong> An open-source database built for analyzing time-series data with the power and convenience of SQL — on premise, at the edge or in the cloud.</p>\n<h2>Demo stand</h2>\n<p>while investigatinve everythin else, to not become a bottle neck created an digital ocean vm with server</p>\n<ul>\n<li><strong>hostname</strong>: 167.172.169.230</li>\n<li><strong>username (ssh)</strong>: ranhcer</li>\n<li><strong>username (sql)</strong>: postgres</li>\n<li><strong>password</strong>: xxxx</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token string\">\"rtB7aYaFF5WBx8cL\"</span> <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/data:/var/lib/postgresql/data timescale/timescaledb:1.7.0-pg12</code></pre></div>\n<p>in case of issues just connect via ssh and restart container</p>\n<p>for convinience pgadmin is also added</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> pgadmin\n<span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> <span class=\"token number\">5050</span>:5050 pgadmin\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>pgadmin <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PGADMIN_DEFAULT_EMAIL</span><span class=\"token operator\">=</span>svc@rabota.ua <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PGADMIN_DEFAULT_PASSWORD</span><span class=\"token operator\">=</span>xxxxx <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/pgadmin:/var/lib/pgadmin dpage/pgadmin4</code></pre></div>\n<h2>Seed database with sample data</h2>\n<p>In oficial docs there are articles with examples - <a href=\"https://docs.timescale.com/latest/tutorials/tutorial-howto-simulate-iot-sensor-data\">Tutorial: How to simulate a basic IoT sensor dataset on PostgreSQL or TimescaleDB</a></p>\n<p>Example with containers:</p>\n<p><strong>003_seed.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\npsql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">--command</span><span class=\"token operator\">=</span><span class=\"token string\">\"CREATE database tutorial\"</span>\npsql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">--dbname</span><span class=\"token operator\">=</span>tutorial <span class=\"token parameter variable\">--command</span><span class=\"token operator\">=</span><span class=\"token string\">\"CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;\"</span>\n\npsql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">--dbname</span><span class=\"token operator\">=</span>tutorial <span class=\"token parameter variable\">--command</span><span class=\"token operator\">=</span><span class=\"token string\">\"\n-- crate conditions table\nCREATE TABLE conditions (\n  time        TIMESTAMPTZ       NOT NULL,\n  location    TEXT              NOT NULL,\n  temperature DOUBLE PRECISION  NULL,\n  humidity    DOUBLE PRECISION  NULL\n);\n\n-- create hypertable\nSELECT create_hypertable('conditions', 'time');\n\n-- seed conditions table with million rows\ninsert into conditions (time, location, temperature, humidity)\nselect\n    now() - INTERVAL '1 min' * (1000000 - i) AS time,\n    (array['office', 'home', 'garage'])[floor(random() * 3 + 1)] AS location,\n    floor(random() * (100 - 1 + 1) + 1) AS temperature,\n    floor(random() * (100 - 1 + 1) + 1) AS humidity\nfrom generate_series(1, 1000000) s(i);\n\"</span>\n\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password <span class=\"token parameter variable\">-v</span> /d/OneDrive/Desktop/timescaledocs/003_seed.sh:/docker-entrypoint-initdb.d/003_seed.sh timescale/timescaledb:1.7.0-pg12</code></pre></div>\n<p>tutorial database will be created in running container with conditions table containing 1M of rows</p>\n<h2>Clients</h2>\n<p><a href=\"https://wiki.postgresql.org/wiki/PostgreSQL_Clients\">List of clients from official wiki</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> pgadmin\n<span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> <span class=\"token number\">5050</span>:5050 pgadmin\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>pgadmin <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-e</span> PGADMIN<span class=\"token punctuation\">\\</span>_DEFAULT<span class=\"token punctuation\">\\</span>_EMAIL<span class=\"token operator\">=</span>svc@rabota.ua <span class=\"token parameter variable\">-e</span> PGADMIN<span class=\"token punctuation\">\\</span>_DEFAULT<span class=\"token punctuation\">\\</span>_PASSWORD<span class=\"token operator\">=</span>xxxxx <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/pgadmin:/var/lib/pgadmin dpage/pgadmin4</code></pre></div>\n<h3>psql, pgcli</h3>\n<p><a href=\"https://www.pgcli.com/\">pgcli</a> - console, open source client</p>\n<h2>Configuration</h2>\n<p>Official docs <a href=\"https://docs.timescale.com/latest/getting-started/configuring#ts-tune\">recommends</a> use built in feature.</p>\n<p>While starting <code class=\"language-text\">timescaledb-tune</code> command is ran, which will configure everything with recommended settings, you can always overridy any of settings by passing them as arguments</p>\n<p>for example <code class=\"language-text\">shared_buffer</code>, by default will be 128mb</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">NO_TS_TUNE</span><span class=\"token operator\">=</span>y timescale/timescaledb:1.7.0-pg12\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"select name, (cast(setting as int) * 8) / 1024 as mb from pg_settings where name = 'shared_buffers';\"</span></code></pre></div>\n<p><code class=\"language-text\">timescaledb-tune</code> on may machine sets it to 1.5gb</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password timescale/timescaledb:1.7.0-pg12\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"select name, (cast(setting as int) * 8) / 1024 as mb from pg_settings where name = 'shared_buffers';\"</span></code></pre></div>\n<p>override example:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password timescale/timescaledb:1.7.0-pg12 postgres <span class=\"token parameter variable\">-cshared_buffers</span><span class=\"token operator\">=</span>100MB\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"select name, (cast(setting as int) * 8) / 1024 as mb from pg_settings where name = 'shared_buffers';\"</span></code></pre></div>\n<p>to see what exactly does <code class=\"language-text\">timescaledb-tune</code> run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password  <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">NO_TS_TUNE</span><span class=\"token operator\">=</span>y timescale/timescaledb:1.7.0-pg12\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db timescaledb-tune</code></pre></div>\n<p>exmple of recommended settings</p>\n<p>Recommendations based on 5.81 GB of available memory and 4 CPUs for PostgreSQL 12</p>\n<table>\n<thead>\n<tr>\n<th>Category</th>\n<th>Setting</th>\n<th>Old</th>\n<th>New</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>memory</td>\n<td>shared_buffers</td>\n<td>128MB</td>\n<td>1487MB</td>\n</tr>\n<tr>\n<td>memory</td>\n<td>effective_cache_size</td>\n<td>N/A</td>\n<td>4462MB</td>\n</tr>\n<tr>\n<td>memory</td>\n<td>maintenance_work_mem</td>\n<td>N/A</td>\n<td>761648kB</td>\n</tr>\n<tr>\n<td>memory</td>\n<td>work_mem</td>\n<td>N/A</td>\n<td>3808kB</td>\n</tr>\n<tr>\n<td>parallelism</td>\n<td>timescaledb.max_background_workers</td>\n<td>N/A</td>\n<td>8</td>\n</tr>\n<tr>\n<td>parallelism</td>\n<td>max_worker_processes</td>\n<td>8</td>\n<td>15</td>\n</tr>\n<tr>\n<td>parallelism</td>\n<td>max_parallel_workers_per_gather</td>\n<td>N/A</td>\n<td>2</td>\n</tr>\n<tr>\n<td>parallelism</td>\n<td>max_parallel_workers</td>\n<td>N/A</td>\n<td>4</td>\n</tr>\n<tr>\n<td>wal</td>\n<td>wal_buffers</td>\n<td>N/A</td>\n<td>16MB</td>\n</tr>\n<tr>\n<td>wal</td>\n<td>min_wal_size</td>\n<td>80MB</td>\n<td>512MB</td>\n</tr>\n<tr>\n<td>miscellaneous</td>\n<td>default_statistics_target</td>\n<td>N/A</td>\n<td>500</td>\n</tr>\n<tr>\n<td>miscellaneous</td>\n<td>random_page_cost</td>\n<td>N/A</td>\n<td>1.1</td>\n</tr>\n<tr>\n<td>miscellaneous</td>\n<td>checkpoint_completion_target</td>\n<td>N/A</td>\n<td>0.9</td>\n</tr>\n<tr>\n<td>miscellaneous</td>\n<td>max_locks_per_transaction</td>\n<td>N/A</td>\n<td>64</td>\n</tr>\n<tr>\n<td>miscellaneous</td>\n<td>autovacuum_max_workers</td>\n<td>N/A</td>\n<td>10</td>\n</tr>\n<tr>\n<td>miscellaneous</td>\n<td>autovacuum_naptime</td>\n<td>N/A</td>\n<td>10</td>\n</tr>\n<tr>\n<td>miscellaneous</td>\n<td>effective_io_concurrency</td>\n<td>N/A</td>\n<td>200</td>\n</tr>\n</tbody>\n</table>\n<h2>Additional settings</h2>\n<p>While starting, there is a check that verifies if data folder exists, and if so - tune is skipped, so we need to rerun tune on each new erver, and settings may be edited in <code class=\"language-text\">$PGDATA/postgresql.conf</code></p>\n<h3>Disk Write Settings</h3>\n<p><code class=\"language-text\">synchronous_commit = 'off'</code> - turn off symc commit, will spead up write, risking to lose uncommited data - in our case makes sense</p>\n<p>with sync commit i was able to get around 7K rps, with it disabled - <strong>39K</strong></p>\n<p>Here is an example of how check was done:</p>\n<p>Пример которым проверял</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># experiment 1: start database with sunchronous commit on</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password timescale/timescaledb:1.7.0-pg12\n\n<span class=\"token comment\"># experiment 2: start database with sunchronous commit off</span>\n<span class=\"token comment\"># docker run -it --rm --name=db -p 5432:5432 -e POSTGRES_PASSWORD=password timescale/timescaledb:1.7.0-pg12 -csynchronous_commit=off</span>\n\n<span class=\"token comment\"># check current setting value</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"select name, setting from pg_settings where name = 'synchronous_commit'\"</span>\n\n<span class=\"token comment\"># create table</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"CREATE TABLE conditions (\n    time        TIMESTAMPTZ       NOT NULL,\n    location    TEXT              NOT NULL,\n    temperature DOUBLE PRECISION  NULL,\n    humidity    DOUBLE PRECISION  NULL\n);\"</span>\n\n<span class=\"token comment\"># create hypertable</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT create_hypertable('conditions', 'time');\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"insert into conditions (time, location, temperature, humidity) values (now(), (array['office', 'home', 'garage'])[floor(random() * 3 + 1)], floor(random() * (100 - 1 + 1) + 1), floor(random() * (100 - 1 + 1) + 1))\"</span> <span class=\"token operator\">></span> bench.sql\n<span class=\"token function\">docker</span> <span class=\"token function\">cp</span> bench.sql db:/var/lib/postgresql/bench.sql\n\n<span class=\"token comment\"># run benchmark</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db pgbench <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">--progress</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token parameter variable\">--client</span><span class=\"token operator\">=</span><span class=\"token number\">10</span> <span class=\"token parameter variable\">--time</span><span class=\"token operator\">=</span><span class=\"token number\">60</span> <span class=\"token parameter variable\">--jobs</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> --no-vacuum <span class=\"token parameter variable\">--file</span><span class=\"token operator\">=</span>/var/lib/postgresql/bench.sql</code></pre></div>\n<h3>Lock Settings</h3>\n<p>Recommended settings is <code class=\"language-text\">max_locks_per_transaction = 2 * num_chunks</code>, where <code class=\"language-text\">num_chunks</code> - max number of chunks in single hypertable, if indexes are used this number should be doubled</p>\n<h3>pgtune</h3>\n<p><a href=\"https://pgtune.leopard.in.ua/\">pgtune</a> - online tool for tuning, gives approximate same results as <code class=\"language-text\">timescaledb-tune</code> (i have set that we are expecting around 500 connections):</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Setting</th>\n<th></th>\n<th>Original</th>\n<th></th>\n<th>Recommended</th>\n<th></th>\n<th>Description</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>max_connections</td>\n<td>100</td>\n<td>500</td>\n<td><a href=\"https://postgrespro.ru/docs/postgrespro/12/runtime-config-connection#GUC-MAX-CONNECTIONS\">docs</a></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>effective_io_concurrency</td>\n<td>200</td>\n<td>200</td>\n<td><a href=\"https://postgrespro.ru/docs/postgrespro/12/runtime-config-resource#GUC-EFFECTIVE-IO-CONCURRENCY\">docs</a></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>min_wal_size</td>\n<td>512MB</td>\n<td>4GB</td>\n<td><a href=\"https://postgrespro.ru/docs/postgrespro/12/wal-configuration\">docs</a></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>max_wal_size</td>\n<td>1024MB</td>\n<td>16GB</td>\n<td><a href=\"https://postgrespro.ru/docs/postgrespro/12/wal-configuration\">docs</a></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>max_parallel_maintenance_workers</td>\n<td>2</td>\n<td>2</td>\n<td><a href=\"https://postgrespro.ru/docs/postgrespro/12/runtime-config-resource#GUC-MAX-PARALLEL-WORKERS-MAINTENANCE\">docs</a></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h2>Backup, restore</h2>\n<p><code class=\"language-text\">pg_dump</code> did not work out of the box, so going to use <code class=\"language-text\">bg_basebackup</code> which does full backup of everything</p>\n<p>Example</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># start database</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/data:/var/lib/postgresql/data <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/backup:/backup timescale/timescaledb:1.7.0-pg12\n\n<span class=\"token comment\"># create table</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"create table demo (id int, value int);\"</span>\n\n<span class=\"token comment\"># insert few rows</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"insert into demo values (1,1), (2,2), (3,3)\"</span>\n\n<span class=\"token comment\"># check</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"select * from demo\"</span>\n\n<span class=\"token comment\"># backup</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db pg_basebackup <span class=\"token parameter variable\">--pgdata</span><span class=\"token operator\">=</span>/backup <span class=\"token parameter variable\">--format</span><span class=\"token operator\">=</span>tar <span class=\"token parameter variable\">--gzip</span>  <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres\n\n<span class=\"token comment\"># kill database</span>\n<span class=\"token function\">docker</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> db\n\n<span class=\"token comment\"># cleanup data</span>\n<span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span> data <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">mkdir</span> data\n\n<span class=\"token comment\"># extract backup into data</span>\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvC</span> data <span class=\"token parameter variable\">-f</span> backup/base.tar.gz\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xvC</span> data/pg_wal <span class=\"token parameter variable\">-f</span> backup/pg_wal.tar.gz\n\n<span class=\"token comment\"># start database</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/data:/var/lib/postgresql/data <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/backup:/backup timescale/timescaledb:1.7.0-pg12\n\n<span class=\"token comment\"># check</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"select * from demo\"</span></code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>before full backup cleanup folder</li>\n<li>in windows had issues with permissions</li>\n</ul>\n<h2>Upgrade</h2>\n<p>It seems like upgrade of timescale itself is quite easy, problems can be while upgrading postgres itself</p>\n<p><a href=\"https://github.com/docker-library/postgres/issues/37\">https://github.com/docker-library/postgres/issues/37</a> - here you can find some useful info</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># start database timescale - 1.5.1, postgres - 11</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/data:/var/lib/postgresql/data timescale/timescaledb:1.5.1-pg11\n\n<span class=\"token comment\"># getting started guide</span>\n\n<span class=\"token comment\"># create table</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"CREATE TABLE conditions (\n    time        TIMESTAMPTZ       NOT NULL,\n    location    TEXT              NOT NULL,\n    temperature DOUBLE PRECISION  NULL,\n    humidity    DOUBLE PRECISION  NULL\n);\"</span>\n\n<span class=\"token comment\"># create hypertable</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT create_hypertable('conditions', 'time');\"</span>\n\n<span class=\"token comment\"># seed 1K rows</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"insert into conditions (time, location, temperature, humidity)\nselect\n    now() - INTERVAL '1 min' * (1000 - i) AS time,\n    (array['office', 'home', 'garage'])[floor(random() * 3 + 1)] AS location,\n    floor(random() * (100 - 1 + 1) + 1) AS temperature,\n    floor(random() * (100 - 1 + 1) + 1) AS humidity\nfrom generate_series(1, 1000) s(i);\"</span>\n\n<span class=\"token comment\"># check number of rows</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"select count(*) from conditions\"</span>\n\n<span class=\"token comment\"># create continuous aggregate</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"CREATE VIEW conditions_summary_hourly\nWITH (timescaledb.continuous) AS\nSELECT location,\n       time_bucket(INTERVAL '1 hour', time) AS bucket,\n       AVG(temperature),\n       MAX(temperature),\n       MIN(temperature)\nFROM conditions\nGROUP BY location, bucket;\"</span>\n\n<span class=\"token comment\"># check continuous aggregate</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT * FROM conditions_summary_hourly limit 3;\"</span>\n\n<span class=\"token comment\"># gracefully stop database</span>\n<span class=\"token function\">docker</span> stop db\n\n<span class=\"token comment\"># start database timescale - 1.6.1, postgres - 11</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/data:/var/lib/postgresql/data timescale/timescaledb:1.6.1-pg11\n\n<span class=\"token comment\"># list extensions \\dx timescaledb</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT extname, extversion FROM pg_catalog.pg_extension\"</span>\n\n<span class=\"token comment\"># update extensions</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"ALTER EXTENSION timescaledb UPDATE\"</span>\n\n<span class=\"token comment\"># check</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"select count(*) from conditions\"</span>\n\n<span class=\"token comment\"># check continuous aggregate</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT * FROM conditions_summary_hourly limit 3;\"</span>\n\n<span class=\"token comment\"># gracefully stop database</span>\n<span class=\"token function\">docker</span> stop db\n\n<span class=\"token comment\"># start database timescale - 1.7.0, postgres - 12</span>\n<span class=\"token comment\"># docker run -it --rm --name=db -p 5432:5432 -e POSTGRES_PASSWORD=password -v $PWD/data:/var/lib/postgresql/data timescale/timescaledb:1.7.0-pg12</span>\n\n<span class=\"token comment\"># FATAL: database files are incompatible with server</span>\n<span class=\"token comment\"># DETAIL: The data directory was initialized by PostgreSQL version 11, which is not compatible with this version 12.2.</span></code></pre></div>\n<h2>Compression</h2>\n<p>We need to figure out how we will distinct categorial from linear metadata in fact, so we can compress them. Also, we need to figure out, after what amount of time data will be compressed, in example it is 7 days, which may be too big</p>\n<p><a href=\"https://docs.timescale.com/latest/using-timescaledb/compression\">compression</a> - something similar to columnar index from sql server, docs describe it very well</p>\n<p>After experiments i was able to compress data 4 times</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># start database</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password timescale/timescaledb:1.7.0-pg12\n\n<span class=\"token comment\"># create table</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"CREATE TABLE conditions (\n    time        TIMESTAMPTZ       NOT NULL,\n    location    TEXT              NOT NULL,\n    temperature DOUBLE PRECISION  NULL,\n    humidity    DOUBLE PRECISION  NULL\n);\"</span>\n\n\n<span class=\"token comment\"># create hypertable</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT create_hypertable('conditions', 'time');\"</span>\n\n<span class=\"token comment\"># seed 1M rows</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"insert into conditions (time, location, temperature, humidity)\nselect\n    now() - INTERVAL '1 min' * (1000000 - i) AS time,\n    (array['office', 'home', 'garage'])[floor(random() * 3 + 1)] AS location,\n    floor(random() * (100 - 1 + 1) + 1) AS temperature,\n    floor(random() * (100 - 1 + 1) + 1) AS humidity\nfrom generate_series(1, 1000000) s(i);\"</span>\n\n<span class=\"token comment\"># get size of whole database - 112MB</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT pg_size_pretty( pg_database_size('postgres') );\"</span>\n<span class=\"token comment\"># get size of conditions table - 16KB</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT pg_size_pretty( pg_total_relation_size('conditions') );\"</span>\n<span class=\"token comment\"># get size of conditions hypertable - 102MB</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT table_name, num_chunks, total_size FROM timescaledb_information.hypertable;\"</span>\n<span class=\"token comment\"># get disk usage - 305MB</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db <span class=\"token function\">du</span> <span class=\"token parameter variable\">-hcs</span> /var/lib/postgresql/data\n\n\n<span class=\"token comment\"># enable compression</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"ALTER TABLE conditions SET ( timescaledb.compress, timescaledb.compress_segmentby = 'location')\"</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT add_compress_chunks_policy('conditions', INTERVAL '7 days');\"</span>\n\n<span class=\"token comment\"># get compression stats (after a while 98 of 100 chunks should be compressed)</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT hypertable_name, chunk_name, compression_status, uncompressed_total_bytes, compressed_total_bytes FROM timescaledb_information.compressed_chunk_stats;\"</span>\n\n<span class=\"token comment\"># get size of whole database - 29MB</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT pg_size_pretty( pg_database_size('postgres') );\"</span>\n<span class=\"token comment\"># get size of conditions hypertable - 17MB</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT table_name, num_chunks, total_size FROM timescaledb_information.hypertable;\"</span>\n<span class=\"token comment\"># get disk usage - 222MB</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db <span class=\"token function\">du</span> <span class=\"token parameter variable\">-hcs</span> /var/lib/postgresql/data</code></pre></div>\n<h2>Data Retention</h2>\n<p>May be useful for product metrics, for example our internal telemetry</p>\n<p><a href=\"https://docs.timescale.com/latest/using-timescaledb/data-retention\">data retention</a> - mechanism of automated cleanup of outdated data, aka we may ask timescaledb to automatically delete data older than X days, example:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 100 chunks</span>\n<span class=\"token keyword\">SELECT</span> show_chunks<span class=\"token punctuation\">(</span><span class=\"token string\">'conditions'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 99 chunks</span>\n<span class=\"token keyword\">SELECT</span> show_chunks<span class=\"token punctuation\">(</span><span class=\"token string\">'conditions'</span><span class=\"token punctuation\">,</span> older_than <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token string\">'24 hours'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- delete manualy</span>\n<span class=\"token comment\">-- SELECT drop_chunks(INTERVAL '24 hours', 'conditions');</span>\n<span class=\"token comment\">-- create job</span>\n<span class=\"token keyword\">SELECT</span> add_drop_chunks_policy<span class=\"token punctuation\">(</span><span class=\"token string\">'conditions'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token string\">'24 hours'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- list jobs</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> timescaledb_information<span class=\"token punctuation\">.</span>drop_chunks_policies<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 1 chunk</span>\n<span class=\"token keyword\">SELECT</span> show_chunks<span class=\"token punctuation\">(</span><span class=\"token string\">'conditions'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- 3.2K rows of 1M left</span>\n<span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> conditions<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Performance test</h2>\n<p>For performance tests there is built in util pgbench, here is example of usage:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># start database</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>db <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5432</span>:5432 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">POSTGRES_PASSWORD</span><span class=\"token operator\">=</span>password timescale/timescaledb:1.7.0-pg12\n\n<span class=\"token comment\"># create table</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"CREATE TABLE conditions (\n    time        TIMESTAMPTZ       NOT NULL,\n    location    TEXT              NOT NULL,\n    temperature DOUBLE PRECISION  NULL,\n    humidity    DOUBLE PRECISION  NULL\n);\"</span>\n\n<span class=\"token comment\"># create hypertable</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db psql <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"SELECT create_hypertable('conditions', 'time');\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"insert into conditions (time, location, temperature, humidity) values (now(), (array['office', 'home', 'garage'])[floor(random() * 3 + 1)], floor(random() * (100 - 1 + 1) + 1), floor(random() * (100 - 1 + 1) + 1))\"</span> <span class=\"token operator\">></span> bench.sql\n<span class=\"token function\">docker</span> <span class=\"token function\">cp</span> bench.sql db:/var/lib/postgresql/bench.sql\n\n<span class=\"token comment\"># initialize pgbench</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db pgbench <span class=\"token parameter variable\">-U</span> postgres <span class=\"token parameter variable\">-i</span>\n\n<span class=\"token comment\"># run write bench for 10 clients over 60 seconds</span>\n<span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> db pgbench <span class=\"token parameter variable\">--username</span><span class=\"token operator\">=</span>postgres <span class=\"token parameter variable\">--progress</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token parameter variable\">--client</span><span class=\"token operator\">=</span><span class=\"token number\">10</span> <span class=\"token parameter variable\">--time</span><span class=\"token operator\">=</span><span class=\"token number\">60</span> <span class=\"token parameter variable\">--jobs</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> --no-vacuum <span class=\"token parameter variable\">--file</span><span class=\"token operator\">=</span>/var/lib/postgresql/bench.sql</code></pre></div>\n<p>Out example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">transaction type: /var/lib/postgresql/bench.sql\nscaling factor: 1\nquery mode: simple\nnumber of clients: 10\nnumber of threads: 2\nduration: 10 s\nnumber of transactions actually processed: 72755\nlatency average = 1.371 ms\nlatency stddev = 0.349 ms\ntps = 7272.065619 (including connections establishing)\ntps = 7273.068218 (excluding connections establishing)</code></pre></div>\n<p>in which we are interested in number of transactions and average latency</p>\n<h2>Monitoring</h2>\n<p>at moment it is not clear what to monitor</p>\n<p>timescaledb on its own does not have anything special for monitofing</p>\n<p>supposedly we will use:</p>\n<ul>\n<li><a href=\"https://github.com/prometheus/node_exporter\">node_exporter</a></li>\n<li><a href=\"https://github.com/wrouesnel/postgres_exporter\">postgres_exporter</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ssh</span> rancher@167.172.169.230\n\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>node_exporter <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">--net</span><span class=\"token operator\">=</span>host <span class=\"token parameter variable\">--pid</span><span class=\"token operator\">=</span>host <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"/:/host:ro,rslave\"</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9100</span>:9100 quay.io/prometheus/node-exporter <span class=\"token parameter variable\">--path.rootfs</span><span class=\"token operator\">=</span>/host\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>postgres_exporter <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">--net</span><span class=\"token operator\">=</span>host <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">DATA_SOURCE_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"postgresql://postgres:rtB7aYaFF5WBx8cL@localhost:5432/postgres?sslmode=disable\"</span> wrouesnel/postgres_exporter\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>cadvisor_exporter <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">--volume</span><span class=\"token operator\">=</span>/:/rootfs:ro <span class=\"token parameter variable\">--volume</span><span class=\"token operator\">=</span>/var/run:/var/run:ro <span class=\"token parameter variable\">--volume</span><span class=\"token operator\">=</span>/sys:/sys:ro <span class=\"token parameter variable\">--volume</span><span class=\"token operator\">=</span>/var/lib/docker/:/var/lib/docker:ro <span class=\"token parameter variable\">--volume</span><span class=\"token operator\">=</span>/dev/disk/:/dev/disk:ro <span class=\"token parameter variable\">--publish</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">--privileged</span> gcr.io/google-containers/cadvisor\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token number\">167.172</span>.169.230:9100/metrics\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token number\">167.172</span>.169.230:9187/metrics\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> <span class=\"token number\">167.172</span>.169.230:8080/metrics\n\n<span class=\"token function\">mkdir</span> prometheus\n<span class=\"token function\">touch</span> prometheus.yml\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>prometheus <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">--net</span><span class=\"token operator\">=</span>host <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/prometheus.yml:/etc/prometheus/prometheus.yml <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/prometheus:/prometheus <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>root prom/prometheus\n\n\n<span class=\"token function\">mkdir</span> grafana\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>grafana <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">-p</span> <span class=\"token number\">3000</span>:3000 <span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/grafana:/var/lib/grafana <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-u</span><span class=\"token variable\">)</span></span> grafana/grafana</code></pre></div>\n<p>and <strong>prometheus.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">global</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">scrape_interval</span><span class=\"token punctuation\">:</span> 15s\n\n<span class=\"token key atrule\">scrape_configs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> node_exporter\n    <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">9100</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> postgres_exporter\n    <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">9187</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> cadvisor_exporter\n    <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span></code></pre></div>\n<h2>Read Only User</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> ROLE mac <span class=\"token keyword\">WITH</span> LOGIN PASSWORD <span class=\"token string\">'1234'</span> NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION VALID UNTIL <span class=\"token string\">'infinity'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">TABLES</span> <span class=\"token operator\">IN</span> <span class=\"token keyword\">SCHEMA</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">TO</span> mac<span class=\"token punctuation\">;</span></code></pre></div>"}},"pageContext":{"id":"671f20a6-d6ff-5743-80e8-2c67f85f2ca7"}},"staticQueryHashes":[],"slicesMap":{}}