{"componentChunkName":"component---src-templates-note-js","path":"/logstash-decode-mime-mail-subject","result":{"data":{"remark":{"fields":{"path":"logstash-decode-mime-mail-subject"},"meta":{"title":""},"headings":[{"value":"Logstash decode mail message subject"}],"html":"<h1>Logstash decode mail message subject</h1>\n<p>We did tried to parse and send logs from MTA to BigQuery</p>\n<p>But inside logs mail message subject was mime encoded and not readable aka something like <code class=\"language-text\">=?UTF-8?B?0K7RgNC40YHRgiAo0JrQuNC10LIpICjQvdC+0LI=?=</code></p>\n<p>Thankfully there is still a way to perform some Ruby code in pipeline</p>\n<p>Ended up with following</p>\n<p><div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">input {\n    stdin {}\n}\nfilter {\n    # extract json from incomming &quot;message&quot;\n    json {\n        source =&gt; &quot;message&quot;\n    }\n    # remove logstash fields\n    mutate {\n        remove_field =&gt; [&quot;@version&quot;,&quot;@timestamp&quot;,&quot;path&quot;,&quot;host&quot;,&quot;type&quot;,&quot;message&quot;,&quot;event&quot;]\n    }\n    # just for demo remove all fields except &quot;timeLogged&quot;, &quot;rcpt&quot;, &quot;totalSecondsQueued&quot; and &quot;header_Subject&quot;\n    mutate {\n        remove_field =&gt; [&quot;type&quot;, &quot;timeQueued&quot;, &quot;orig&quot;, &quot;orcpt&quot;, &quot;dsnAction&quot;, &quot;dsnStatus&quot;, &quot;dsnDiag&quot;, &quot;dsnMta&quot;, &quot;bounceCat&quot;, &quot;srcType&quot;, &quot;srcMta&quot;, &quot;dlvType&quot;, &quot;dlvSourceIp&quot;, &quot;dlvDestinationIp&quot;, &quot;dlvEsmtpAvailable&quot;, &quot;dlvSize&quot;, &quot;vmta&quot;, &quot;jobId&quot;, &quot;envId&quot;, &quot;queue&quot;, &quot;vmtaPool&quot;, &quot;timeFirstAttempt&quot;, &quot;dlvTlsProtocol&quot;, &quot;dlvTlsCipher&quot;, &quot;rcvSmtpUser&quot;]\n    }\n    # decode header\n    ruby {\n        init =&gt; &quot;require &#39;mail&#39;&quot;\n        code =&gt; &quot;event.set(&#39;[subject]&#39;, Mail::Encodings.value_decode(event.get(&#39;[header_Subject]&#39;)))&quot;\n    }\n    # remove encoded header\n    mutate {\n        remove_field =&gt; [&quot;header_Subject&quot;]\n    }\n}\noutput {\n    stdout {}\n}</code></pre></div></p>\n<p>Which gives us desired decoded output and can be further processed and send to bigquery</p>\n<p>Demos were tested with container</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--rm</span> <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">-v</span> <span class=\"token variable\">${<span class=\"token environment constant\">PWD</span>}</span>/bigquery.conf:/usr/share/logstash/pipeline/pipeline.conf docker.elastic.co/logstash/logstash:8.5.0</code></pre></div>\n<p>by pasting to stdin sample log row</p>"}},"pageContext":{"id":"874936c7-2910-5c56-bb29-c67fa669ef75"}},"staticQueryHashes":[]}