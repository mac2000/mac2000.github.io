{"componentChunkName":"component---src-templates-note-js","path":"/c-gdata-analytics/","result":{"data":{"remark":{"fields":{"path":"c-gdata-analytics"},"meta":{"title":""},"headings":[{"value":"c# gdata analytics"}],"html":"<h1>c# gdata analytics</h1>\n<p>В примере ниже, выдираем инфу за последние 6 месяцев, статистика по браузерам</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">slice</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> Browser<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> BrowserVersion<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">double</span></span> PageViews<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        browser <span class=\"token operator\">=</span> Browser<span class=\"token punctuation\">;</span>\n        browserVersion <span class=\"token operator\">=</span> BrowserVersion<span class=\"token punctuation\">;</span>\n        pageViews <span class=\"token operator\">=</span> PageViews<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> browser<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> browserVersion<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">double</span></span> pageViews<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">List<span class=\"token punctuation\">&lt;</span>List<span class=\"token punctuation\">&lt;</span>slice<span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getAnalyticsData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>List<span class=\"token punctuation\">&lt;</span>slice<span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> slices <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>List<span class=\"token punctuation\">&lt;</span>slice<span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> login <span class=\"token operator\">=</span> <span class=\"token string\">\"LOGIN@gmail.com\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> password <span class=\"token operator\">=</span> <span class=\"token string\">\"PASSWORD\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> siteId <span class=\"token operator\">=</span> <span class=\"token string\">\"ga:2266524\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">AnalyticsService</span> service <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AnalyticsService</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mac_test_3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    service<span class=\"token punctuation\">.</span><span class=\"token function\">setUserCredentials</span><span class=\"token punctuation\">(</span>login<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> start_date <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DateTime</span><span class=\"token punctuation\">(</span>DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">.</span>Year<span class=\"token punctuation\">,</span> DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">.</span><span class=\"token function\">AddMonths</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">6</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Month<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yyyy-MM-dd\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> end_date <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DateTime</span><span class=\"token punctuation\">(</span>DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">.</span>Year<span class=\"token punctuation\">,</span> DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">.</span><span class=\"token function\">AddMonths</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">5</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Month<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yyyy-MM-dd\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> queryUri <span class=\"token operator\">=</span> <span class=\"token string\">\"https://www.google.com/analytics/feeds/data\"</span> <span class=\"token operator\">+</span>\n                        <span class=\"token string\">\"?start-date=\"</span> <span class=\"token operator\">+</span> start_date <span class=\"token operator\">+</span>\n                        <span class=\"token string\">\"&amp;end-date=\"</span> <span class=\"token operator\">+</span> end_date <span class=\"token operator\">+</span>\n                        <span class=\"token string\">\"&amp;dimensions=ga:browser,ga:browserVersion\"</span> <span class=\"token operator\">+</span>\n                        <span class=\"token string\">\"&amp;metrics=ga:pageviews\"</span> <span class=\"token operator\">+</span>\n                        <span class=\"token string\">\"&amp;sort=-ga:pageviews\"</span> <span class=\"token operator\">+</span>\n            <span class=\"token comment\">//\"&amp;max-results=20\" +</span>\n                        <span class=\"token string\">\"&amp;filters=ga:browser%3D%3DFirefox,ga:browser%3D%3DOpera,ga:browser%3D%3DChrome,ga:browser%3D%3DInternet Explorer\"</span> <span class=\"token operator\">+</span>\n                        <span class=\"token string\">\"&amp;ids=\"</span> <span class=\"token operator\">+</span> siteId<span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">DataFeed</span> dataFeed <span class=\"token operator\">=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">Query</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DataQuery</span><span class=\"token punctuation\">(</span>queryUri<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>slice<span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>slice<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AtomEntry</span> item <span class=\"token keyword\">in</span> dataFeed<span class=\"token punctuation\">.</span>Entries<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> browser <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DataEntry<span class=\"token punctuation\">)</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Dimensions<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> browserVersion <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DataEntry<span class=\"token punctuation\">)</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Dimensions<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> pageViews <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DataEntry<span class=\"token punctuation\">)</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Metrics<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>browserVersion<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(not set)\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> browserVersion<span class=\"token punctuation\">.</span><span class=\"token function\">StartsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"999\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> browserVersion<span class=\"token punctuation\">.</span><span class=\"token function\">StartsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> browserVersion<span class=\"token punctuation\">.</span><span class=\"token function\">StartsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"99\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\n            browserVersion <span class=\"token operator\">=</span> Regex<span class=\"token punctuation\">.</span><span class=\"token function\">Replace</span><span class=\"token punctuation\">(</span>browserVersion<span class=\"token punctuation\">,</span> <span class=\"token string\">@\"(\\d+).*\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"$1\"</span><span class=\"token punctuation\">,</span> RegexOptions<span class=\"token punctuation\">.</span>IgnoreCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> bv <span class=\"token operator\">=</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span>browserVersion<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">double</span></span> pv <span class=\"token operator\">=</span> <span class=\"token keyword\">double</span><span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span>pageViews<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            list<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">slice</span><span class=\"token punctuation\">(</span>browser<span class=\"token punctuation\">,</span> bv<span class=\"token punctuation\">,</span> pv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">//group results by browser and browserVersion and sum pageViews</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> q <span class=\"token operator\">=</span> <span class=\"token keyword\">from</span> x <span class=\"token keyword\">in</span> list\n                <span class=\"token keyword\">group</span> x <span class=\"token keyword\">by</span> <span class=\"token keyword\">new</span> <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">.</span>browser<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">.</span>browserVersion <span class=\"token punctuation\">}</span> <span class=\"token keyword\">into</span> g\n                <span class=\"token keyword\">select</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">slice</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">.</span>Key<span class=\"token punctuation\">.</span>browser<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">.</span>Key<span class=\"token punctuation\">.</span>browserVersion<span class=\"token punctuation\">,</span> g<span class=\"token punctuation\">.</span><span class=\"token function\">Sum</span><span class=\"token punctuation\">(</span>s <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span>pageViews<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\"><span class=\"token keyword\">double</span></span> totalPageVies <span class=\"token operator\">=</span> q<span class=\"token punctuation\">.</span><span class=\"token function\">Sum</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>pageViews<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//convert pageViews to percents and filter results for min value</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> q2 <span class=\"token operator\">=</span> <span class=\"token keyword\">from</span> x <span class=\"token keyword\">in</span> q\n                    <span class=\"token keyword\">where</span> <span class=\"token class-name\">x</span><span class=\"token punctuation\">.</span>pageViews <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>totalPageVies <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">3</span>\n                    <span class=\"token keyword\">select</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">slice</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>browser<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">.</span>browserVersion<span class=\"token punctuation\">,</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">Round</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>pageViews <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>totalPageVies <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        slices<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>q2<span class=\"token punctuation\">.</span><span class=\"token function\">ToList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> slices<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>"}},"pageContext":{"id":"347fdc9e-06ba-52ae-a5d5-570c2538ecc7"}},"staticQueryHashes":[],"slicesMap":{}}