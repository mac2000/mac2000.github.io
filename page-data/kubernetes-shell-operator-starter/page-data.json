{"componentChunkName":"component---src-templates-note-js","path":"/kubernetes-shell-operator-starter/","result":{"data":{"remark":{"fields":{"path":"kubernetes-shell-operator-starter"},"meta":{"title":""},"headings":[{"value":"Kubernetes Shell Operator by Flant demo"}],"html":"<h1>Kubernetes Shell Operator by Flant demo</h1>\n<p>Flant have anounced pretty cool <a href=\"https://github.com/flant/shell-operator\">shell-operator</a> project</p>\n<h2>How it works</h2>\n<p>Imagine that you have script (any bash, pwsh, python, whatever) that will be called on events you are looking for (aka pod created, namespace deleted, etc)</p>\n<p>To do so, your script should return wanted events when ran with <code class=\"language-text\">--config</code> argument</p>\n<p>And whenever event will occur, script will be called with json passed as an argument</p>\n<h2>PowerShell-Operator</h2>\n<p>Here is full example for RBAC based cluster</p>\n<p>First of all create namespace</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Namespace\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper</code></pre></div></p>\n<p>Create custom resource definition (suppose we want to create our own redis operator)</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apiextensions.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> CustomResourceDefinition\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># name must match the spec fields below, and be in the form: &lt;plural>.&lt;group></span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> redis.redis.io\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> oper\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># group name to use for REST API: /apis/&lt;group>/&lt;version></span>\n  <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> redis.io\n  <span class=\"token comment\"># list of versions supported by this CustomResourceDefinition</span>\n  <span class=\"token key atrule\">versions</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> v1\n      <span class=\"token comment\"># Each version can be enabled/disabled by Served flag.</span>\n      <span class=\"token key atrule\">served</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token comment\"># One and only one version must be marked as the storage version.</span>\n      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">schema</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">openAPIV3Schema</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> object\n          <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> object\n              <span class=\"token key atrule\">properties</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> integer\n                <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> integer\n  <span class=\"token comment\"># either Namespaced or Cluster</span>\n  <span class=\"token key atrule\">scope</span><span class=\"token punctuation\">:</span> Namespaced\n  <span class=\"token key atrule\">names</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># plural name to be used in the URL: /apis/&lt;group>/&lt;version>/&lt;plural></span>\n    <span class=\"token key atrule\">plural</span><span class=\"token punctuation\">:</span> redis\n    <span class=\"token comment\"># singular name to be used as an alias on the CLI and for display</span>\n    <span class=\"token key atrule\">singular</span><span class=\"token punctuation\">:</span> redis\n    <span class=\"token comment\"># kind is normally the CamelCased singular type. Your resource manifests use this.</span>\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Redis</code></pre></div></p>\n<p>Apply all RBAC related stuff</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> oper</code></pre></div></p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> oper\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> redis.io\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> redis\n    <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> get\n      <span class=\"token punctuation\">-</span> watch\n      <span class=\"token punctuation\">-</span> list</code></pre></div></p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRoleBinding\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> oper\n<span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io\n  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n<span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> oper</code></pre></div></p>\n<p>Config map with our script</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> oper\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">entrypoint.sh</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    #!/usr/bin/env bash</span>\n\n    <span class=\"token comment\"># https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-core-on-linux?view=powershell-7.1#installation-via-direct-download---alpine-39-and-310</span>\n    apk add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>cache ca<span class=\"token punctuation\">-</span>certificates less ncurses<span class=\"token punctuation\">-</span>terminfo<span class=\"token punctuation\">-</span>base krb5<span class=\"token punctuation\">-</span>libs libgcc libintl libssl1.1 libstdc++ tzdata userspace<span class=\"token punctuation\">-</span>rcu zlib icu<span class=\"token punctuation\">-</span>libs curl\n    apk <span class=\"token punctuation\">-</span>X https<span class=\"token punctuation\">:</span>//dl<span class=\"token punctuation\">-</span>cdn.alpinelinux.org/alpine/edge/main add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>cache lttng<span class=\"token punctuation\">-</span>ust\n    curl <span class=\"token punctuation\">-</span>s <span class=\"token punctuation\">-</span>L https<span class=\"token punctuation\">:</span>//github.com/PowerShell/PowerShell/releases/download/v7.1.3/powershell<span class=\"token punctuation\">-</span>7.1.3<span class=\"token punctuation\">-</span>linux<span class=\"token punctuation\">-</span>alpine<span class=\"token punctuation\">-</span>x64.tar.gz <span class=\"token punctuation\">-</span>o /tmp/powershell.tar.gz\n    mkdir <span class=\"token punctuation\">-</span>p /opt/microsoft/powershell/7\n    tar zxf /tmp/powershell.tar.gz <span class=\"token punctuation\">-</span>C /opt/microsoft/powershell/7\n    chmod +x /opt/microsoft/powershell/7/pwsh\n    ln <span class=\"token punctuation\">-</span>s /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh\n\n    <span class=\"token comment\"># https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/</span>\n    curl <span class=\"token punctuation\">-</span>LO https<span class=\"token punctuation\">:</span>//storage.googleapis.com/kubernetes<span class=\"token punctuation\">-</span>release/release/`curl <span class=\"token punctuation\">-</span>s https<span class=\"token punctuation\">:</span>//storage.googleapis.com/kubernetes<span class=\"token punctuation\">-</span>release/release/stable.txt`/bin/linux/amd64/kubectl\n    chmod +x kubectl\n    mv kubectl /usr/bin/\n\n\n    <span class=\"token comment\"># https://github.com/flant/shell-operator/blob/master/Dockerfile#L40</span>\n    exec /sbin/tini <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span> /shell<span class=\"token punctuation\">-</span>operator start\n  <span class=\"token key atrule\">oper.ps1</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    #!/usr/bin/env pwsh</span>\n\n    if ($args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">-</span>eq '<span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>config') <span class=\"token punctuation\">{</span>\n      Write<span class=\"token punctuation\">-</span>Host '\n      <span class=\"token key atrule\">configVersion</span><span class=\"token punctuation\">:</span> v1\n      <span class=\"token key atrule\">kubernetes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> redis.io/v1\n        <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Redis\n        <span class=\"token key atrule\">executeHookOnEvent</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> Added\n          <span class=\"token punctuation\">-</span> Modified\n          <span class=\"token punctuation\">-</span> Deleted\n      '\n    <span class=\"token punctuation\">}</span> else <span class=\"token punctuation\">{</span>\n      $items = Get<span class=\"token punctuation\">-</span>Content $env<span class=\"token punctuation\">:</span>BINDING_CONTEXT_PATH <span class=\"token punctuation\">|</span> ConvertFrom<span class=\"token punctuation\">-</span>Json\n      foreach($item in $items) <span class=\"token punctuation\">{</span>\n        $event = $item.watchEvent\n        $kind = $item.object.kind\n        $name = $item.object.metadata.name\n        $namespace = $item.object.metadata.namespace\n        $replicas = $item.object.spec.replicas\n        $memory = $item.object.spec.memory\n        \n        Write<span class=\"token punctuation\">-</span>Host \"$event $kind $name $namespace $replicas $memory\"\n\n        if ($kind <span class=\"token punctuation\">-</span>eq \"Redis\") <span class=\"token punctuation\">{</span>\n          if ($event <span class=\"token punctuation\">-</span>eq \"Deleted\") <span class=\"token punctuation\">{</span>\n            kubectl <span class=\"token punctuation\">-</span>n $namespace delete deployment $name\n          <span class=\"token punctuation\">}</span>\n          \n          if ($event <span class=\"token punctuation\">-</span>eq \"Added\") <span class=\"token punctuation\">{</span>\n            kubectl <span class=\"token punctuation\">-</span>n $namespace create deployment $name <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>image=redis\n          <span class=\"token punctuation\">}</span>\n\n          if ($event <span class=\"token punctuation\">-</span>eq \"Modified\") <span class=\"token punctuation\">{</span>\n            kubectl <span class=\"token punctuation\">-</span>n $namespace scale deployment $name <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>replicas=$replicas\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div></p>\n<blockquote>\n<p>Note that we are replacing entrypoint, installing powershell and using it instead of bash</p>\n</blockquote>\n<p>Deploy shell operator itself</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> oper\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> oper\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> oper\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> oper\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n          <span class=\"token comment\"># image: oper</span>\n          <span class=\"token comment\"># imagePullPolicy: Never</span>\n\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> flant/shell<span class=\"token punctuation\">-</span>operator<span class=\"token punctuation\">:</span>latest\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> /entrypoint.sh\n          <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n\n          <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n              <span class=\"token key atrule\">subPath</span><span class=\"token punctuation\">:</span> oper.ps1\n              <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /hooks/oper.ps1\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n              <span class=\"token key atrule\">subPath</span><span class=\"token punctuation\">:</span> entrypoint.sh\n              <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /entrypoint.sh\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n          <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> oper\n            <span class=\"token key atrule\">defaultMode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0755</span></code></pre></div></p>\n<p>And at the very end try to create our demo</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> redis.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Redis\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> demo\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> oper\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span></code></pre></div></p>\n<p>And if we look at our deployment logs we will see desired messages, all is left is to write the operator itself</p>"}},"pageContext":{"id":"a5133714-edf5-5e06-b715-a2abc847efdc"}},"staticQueryHashes":[],"slicesMap":{}}