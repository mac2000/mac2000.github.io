{"componentChunkName":"component---src-templates-note-js","path":"/esxi-cloud-init-ubuntu/","result":{"data":{"remark":{"fields":{"path":"esxi-cloud-init-ubuntu"},"meta":{"title":""},"headings":[{"value":"ESXi Cloud Init Bootstrap Ubuntu"},{"value":"Second run of cloud init from withing virtual machine"}],"html":"<h1>ESXi Cloud Init Bootstrap Ubuntu</h1>\n<p>How to automatically provision Ubuntu 20.04 in ESXi with help of Cloud Init</p>\n<div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; \" > <iframe src=\"https://www.youtube.com/embed/lhWQBz5oj8o\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen=\"\" style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe> </div>\n<h2>Ubuntu Cloud Image VMDK</h2>\n<p>Ubuntu cloud images are preconfigured distributions to be run as virtual machines and to be bootstraped with cloud init</p>\n<p>Before anything else navigate to:</p>\n<p><a href=\"https://cloud-images.ubuntu.com/\">https://cloud-images.ubuntu.com/</a></p>\n<p>And traverse to desider ubuntu version to download its vmdk file, in my case it is here:</p>\n<p><a href=\"https://cloud-images.ubuntu.com/focal/current/\">https://cloud-images.ubuntu.com/focal/current/</a></p>\n<p><a href=\"https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.vmdk\">vmdk</a> which is only 500mb of size</p>\n<p>After downloading vmdk upload it to esxi server somewhere in storage</p>\n<h2>ESXi Virtual Machine</h2>\n<p>The next step is to create virtual machine as usual, execpt that we do not need any disks to be created, so remove them and after creating vm attach existing disk and choose uploaded vmdk file</p>\n<p>Notes:</p>\n<ul>\n<li>in my case for experiments I am copying to to vm folder, so original vmdk can be reused many times</li>\n<li>note that vmdk size is 500mb, but disk will be 10gb, thats because by default cloud init has all required modules enabled so guest operating system will expand itself to take all disk space</li>\n<li>disk size can be changed after saving vm and reopening its settings</li>\n</ul>\n<p>If you will try to boot VM it will load but you wont be able to login, because there is no users and\\or passwords created, we need to configure at least this to move further</p>\n<h2>ESXi Cloud Init GuestInfo UserData</h2>\n<p>Now the tricky part, go to virtual machine advanced settings and add two properties:</p>\n<table>\n<thead>\n<tr>\n<th>Key</th>\n<th>Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">guestinfo.userdata.encoding</code></td>\n<td><code class=\"language-text\">base64</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">guestinfo.userdata</code></td>\n<td>base64 userdata.yml</td>\n</tr>\n</tbody>\n</table>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 859px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/34719addefb346c14fd298b5217c758f/39a20/esxi_advanced_userdata_cloudinit.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.03125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABT0lEQVR42lWO6U7CQBRGeR5o+adQMPgkRhNcgnWNcUF8QmNMXHBJFBAE0o3SQukCesxMgMQfZ757Z27O3FQ6naG4ViKf18hrmkxN01jN5VhZzVEoFNG0gswFohczCwrFIqXSOulMhpSazbKxucXB4RHHp2ecnJ1Lzi+uuJhzeVmlWq3947p2Q/W6JhEz5XIZVc2SUlWF8s4Ot/d3NFtffH40aHw0aHe69PoGpmljWjaW5cgUGIYl37+7PUzL4empjq7rKKpKSlEUtnf3eHit43o+A8fFc1zsgYvjekyiGH8c4A59gkkkGQchlj2Qd2GU0Gi20PV9hGspfHx+ods3aH51aHW62I5LECWMwxjPH2OKPoznJITxVNbR9Gcu1FHFhuIQwpe3d0zbod83lj8ns1+mM4jiKYZlM/RHclvPD3C9EUNvxCRKaLfbVCoVKfwDJRRdftTzY3IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ESXi Advanced Options - set userdata for cloud-init\"\n        title=\"\"\n        src=\"/static/34719addefb346c14fd298b5217c758f/39a20/esxi_advanced_userdata_cloudinit.png\"\n        srcset=\"/static/34719addefb346c14fd298b5217c758f/6f3f2/esxi_advanced_userdata_cloudinit.png 256w,\n/static/34719addefb346c14fd298b5217c758f/01e7c/esxi_advanced_userdata_cloudinit.png 512w,\n/static/34719addefb346c14fd298b5217c758f/39a20/esxi_advanced_userdata_cloudinit.png 859w\"\n        sizes=\"(max-width: 859px) 100vw, 859px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Note:</p>\n<ul>\n<li>Value is a base64 encoded cloud init file contents</li>\n<li><code class=\"language-text\">#cloudinit</code> <strong>must</strong> be very first line for everything to work</li>\n<li>cloud init applied once, so if you did something wrong just start from scratch</li>\n<li>there is 500kb limit for this fields if your cloud init is bigger there is a way to pass base64 gzip content just google for it</li>\n</ul>\n<p>Here is a starting point:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\">#cloud-config</span>\n<span class=\"token key atrule\">users</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mac\n    <span class=\"token comment\"># passwd: $6$rounds=4096$4Jh2rwf9h2jM9TbQ$.CTSPJPIoIOUwKVo4A2Er19Deu945m/oD.JXVEGNH9g/piK.motblke/kpyPQ0npNKF.jZjzi61ZSBPGNbJyK/</span>\n    <span class=\"token key atrule\">plain_text_passwd</span><span class=\"token punctuation\">:</span> secret\n    <span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span> sudo\n    <span class=\"token key atrule\">sudo</span><span class=\"token punctuation\">:</span> ALL=(ALL) NOPASSWD<span class=\"token punctuation\">:</span>ALL\n    <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> /bin/bash\n    <span class=\"token key atrule\">lock_passwd</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n<span class=\"token comment\"># guestinfo.userdata.encoding: base64</span>\n<span class=\"token comment\"># guestinfo.userdata: I2Nsb3VkLWNvbmZpZwp1c2VyczoKICAtIG5hbWU6IG1hYwogICAgIyBwYXNzd2Q6ICQ2JHJvdW5kcz00MDk2JDRKaDJyd2Y5aDJqTTlUYlEkLkNUU1BKUElvSU9Vd0tWbzRBMkVyMTlEZXU5NDVtL29ELkpYVkVHTkg5Zy9waUsubW90YmxrZS9rcHlQUTBucE5LRi5qWmp6aTYxWlNCUEdOYkp5Sy8KICAgIHBsYWluX3RleHRfcGFzc3dkOiBzZWNyZXQKICAgIGdyb3Vwczogc3VkbwogICAgc3VkbzogQUxMPShBTEwpIE5PUEFTU1dEOkFMTAogICAgc2hlbGw6IC9iaW4vYmFzaAogICAgbG9ja19wYXNzd2Q6IGZhbHNl</span></code></pre></div></p>\n<p>And to grab its base64: <code class=\"language-text\">cat minimal.yml | base64</code></p>\n<p>Now we should be able to at least login to system</p>\n<p>Few useful files:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># general overview</span>\n<span class=\"token function\">cat</span> /var/run/cloud-init/status.json\n\n<span class=\"token comment\"># in my case was empty</span>\n<span class=\"token function\">cat</span> /var/run/cloud-init/result.json\n\n<span class=\"token comment\"># stdout</span>\n<span class=\"token function\">cat</span> /var/log/cloud-init-output.log\n\n<span class=\"token comment\"># debug</span>\n<span class=\"token function\">cat</span> /var/log/cloud-init.log</code></pre></div>\n<h1>Second run of cloud init from withing virtual machine</h1>\n<p><a href=\"https://cloudinit.readthedocs.io/en/latest/topics/debugging.html#running-single-cloud-config-modules\">https://cloudinit.readthedocs.io/en/latest/topics/debugging.html#running-single-cloud-config-modules</a></p>\n<p>While we are inside VM it is a good time to configure cloud init further, there is <code class=\"language-text\">/etc/cloud/cloud.cfg</code> file, where we can append something and after that run something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cloud-init clean <span class=\"token parameter variable\">--logs</span>\n\ncloud-init single <span class=\"token parameter variable\">--name</span> cc_ssh <span class=\"token parameter variable\">--frequency</span> always\ncloud-init single <span class=\"token parameter variable\">--name</span> cc_package_update_upgrade_install\ncloud-init single <span class=\"token parameter variable\">--name</span> cc_ntp\ncloud-init single <span class=\"token parameter variable\">--name</span> cc_timezone</code></pre></div>\n<p>Here you can see that first of all you need to cleanup cloud init state, after that you can rerun concrete module.</p>\n<p>This is how we can prepare our cloud init</p>\n<p>In my case for demo purposes I ended up with:</p>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\">#cloud-config</span>\n\n<span class=\"token comment\"># note that \"#cloud-config\" must be very first line for everything to work</span>\n\n<span class=\"token comment\"># guestinfo.userdata: cat cloudinit.yml | base64 | pbcopy</span>\n<span class=\"token comment\"># guestinfo.userdata.encoding: base64</span>\n\n<span class=\"token comment\"># networking</span>\n<span class=\"token comment\"># this one should be added to:</span>\n<span class=\"token comment\"># guestinfo.metadata:</span>\n<span class=\"token comment\"># guestinfo.metadata.encoding</span>\n<span class=\"token comment\"># ----------</span>\n<span class=\"token comment\"># network:</span>\n<span class=\"token comment\">#   version: 2</span>\n<span class=\"token comment\">#   ethernets:</span>\n<span class=\"token comment\">#     nics:</span>\n<span class=\"token comment\">#       match:</span>\n<span class=\"token comment\">#         name: ens*</span>\n<span class=\"token comment\">#       # DHCP:</span>\n<span class=\"token comment\">#       # ----------</span>\n<span class=\"token comment\">#       # dhcp4: yes</span>\n<span class=\"token comment\">#       # ----------</span>\n<span class=\"token comment\">#       # STATIC:</span>\n<span class=\"token comment\">#       # ----------</span>\n<span class=\"token comment\">#       addresses:</span>\n<span class=\"token comment\">#         - 192.168.106.22/24</span>\n<span class=\"token comment\">#       gateway4: 192.168.106.1</span>\n<span class=\"token comment\">#       nameservers:</span>\n<span class=\"token comment\">#         # search: [lab, home]</span>\n<span class=\"token comment\">#         addresses: [8.8.8.8, 1.1.1.1]</span>\n\n<span class=\"token comment\"># hostname</span>\n<span class=\"token key atrule\">preserve_hostname</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n<span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> ub3.marchenko.net.ua\n<span class=\"token key atrule\">manage_etc_hosts</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token comment\"># enable ntp</span>\n<span class=\"token key atrule\">ntp</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token comment\"># timezone</span>\n<span class=\"token key atrule\">timezone</span><span class=\"token punctuation\">:</span> Europe/Kiev\n\n<span class=\"token comment\"># disable root login via ssh</span>\n<span class=\"token key atrule\">disable_root</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token comment\"># optional, additional groups</span>\n<span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># because we gonna install docker</span>\n  <span class=\"token punctuation\">-</span> docker\n\n<span class=\"token key atrule\">users</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> mac\n    <span class=\"token comment\"># allows password authnetication when set to false, true by default</span>\n    <span class=\"token key atrule\">lock_passwd</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">False</span>\n    <span class=\"token comment\"># password hash, created by `mkpasswd --method=SHA-512 --rounds=4096`, read the docs before complaining security against plain</span>\n    <span class=\"token comment\"># passwd: $6$rounds=4096$4Jh2rwf9h2jM9TbQ$.CTSPJPIoIOUwKVo4A2Er19Deu945m/oD.JXVEGNH9g/piK.motblke/kpyPQ0npNKF.jZjzi61ZSBPGNbJyK/</span>\n    <span class=\"token comment\"># alternative approach with plain text password</span>\n    <span class=\"token key atrule\">plain_text_passwd</span><span class=\"token punctuation\">:</span> secret\n    <span class=\"token key atrule\">ssh_authorized_keys</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ssh<span class=\"token punctuation\">-</span>rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAyfdNzj4mbl0PiOA7VQxeO8cR/U9u2SdRFZaZlRatdJZ1sYYa/Q0jMDOsr7oklftX49yGpuW1sBtWLevaKtcKz3kHkInFvlebFeFB9uPmMfo8gd+QLuLc8LeOQgn4wlSPEuizDxuMd1Sz1frZ7r7QUH8HdhnCO/FXtIg+c8DHsAVQSxapfalVCv4z4EiC3le8SxlZjxf/KaVmIdYOpbLf0GBP/gP5ObFYxvtTx7Rp1lM1ZSXYVGFBpXC15WYMHKq+LfQ8D0WpwiOIXw0723k+CSUb3tHS5a8Hz0GUtjMOizclIeiv503DqZAA8RxtWLfLUFdCeUgEyvIu430s4xBqSw== rsa<span class=\"token punctuation\">-</span>key<span class=\"token punctuation\">-</span><span class=\"token number\">20140409</span>\n    <span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> adm\n      <span class=\"token punctuation\">-</span> cdrom\n      <span class=\"token punctuation\">-</span> sudo\n      <span class=\"token punctuation\">-</span> dip\n      <span class=\"token punctuation\">-</span> plugdev\n      <span class=\"token punctuation\">-</span> lxd\n      <span class=\"token comment\"># add user to docker group</span>\n      <span class=\"token punctuation\">-</span> docker\n    <span class=\"token key atrule\">sudo</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># allow sudo</span>\n      <span class=\"token punctuation\">-</span> ALL=(ALL) NOPASSWD<span class=\"token punctuation\">:</span>ALL\n    <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> /bin/bash\n\n<span class=\"token comment\"># optional, additional apt sources, docker</span>\n<span class=\"token key atrule\">apt</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">sources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">docker.list</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> deb <span class=\"token punctuation\">[</span>arch=amd64<span class=\"token punctuation\">]</span> https<span class=\"token punctuation\">:</span>//download.docker.com/linux/ubuntu $RELEASE stable\n      <span class=\"token key atrule\">keyid</span><span class=\"token punctuation\">:</span> 9DC858229FC7DD38854AE2D88D81803C0EBFCD88\n\n<span class=\"token comment\"># apt update &amp;&amp; apt upgrade, reboot if needed</span>\n<span class=\"token key atrule\">package_update</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">package_upgrade</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">package_reboot_if_required</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n\n<span class=\"token comment\"># install packages</span>\n<span class=\"token key atrule\">packages</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> docker<span class=\"token punctuation\">-</span>ce\n  <span class=\"token punctuation\">-</span> docker<span class=\"token punctuation\">-</span>ce<span class=\"token punctuation\">-</span>cli\n  <span class=\"token punctuation\">-</span> containerd.io\n<span class=\"token comment\"># guestinfo.userdata.encoding: base64</span>\n<span class=\"token comment\"># guestinfo.userdata: I2Nsb3VkLWNvbmZpZwoKIyBub3RlIHRoYXQgIiNjbG91ZC1jb25maWciIG11c3QgYmUgdmVyeSBmaXJzdCBsaW5lIGZvciBldmVyeXRoaW5nIHRvIHdvcmsKCiMgZ3Vlc3RpbmZvLnVzZXJkYXRhOiBjYXQgY2xvdWRpbml0LnltbCB8IGJhc2U2NCB8IHBiY29weQojIGd1ZXN0aW5mby51c2VyZGF0YS5lbmNvZGluZzogYmFzZTY0CgojIG5ldHdvcmtpbmcKIyB0aGlzIG9uZSBzaG91bGQgYmUgYWRkZWQgdG86CiMgZ3Vlc3RpbmZvLm1ldGFkYXRhOgojIGd1ZXN0aW5mby5tZXRhZGF0YS5lbmNvZGluZwojIC0tLS0tLS0tLS0KIyBuZXR3b3JrOgojICAgdmVyc2lvbjogMgojICAgZXRoZXJuZXRzOgojICAgICBuaWNzOgojICAgICAgIG1hdGNoOgojICAgICAgICAgbmFtZTogZW5zKgojICAgICAgICMgREhDUDoKIyAgICAgICAjIC0tLS0tLS0tLS0KIyAgICAgICAjIGRoY3A0OiB5ZXMKIyAgICAgICAjIC0tLS0tLS0tLS0KIyAgICAgICAjIFNUQVRJQzoKIyAgICAgICAjIC0tLS0tLS0tLS0KIyAgICAgICBhZGRyZXNzZXM6CiMgICAgICAgICAtIDE5Mi4xNjguMTA2LjIyLzI0CiMgICAgICAgZ2F0ZXdheTQ6IDE5Mi4xNjguMTA2LjEKIyAgICAgICBuYW1lc2VydmVyczoKIyAgICAgICAgICMgc2VhcmNoOiBbbGFiLCBob21lXQojICAgICAgICAgYWRkcmVzc2VzOiBbOC44LjguOCwgMS4xLjEuMV0KCiMgaG9zdG5hbWUKcHJlc2VydmVfaG9zdG5hbWU6IGZhbHNlCmhvc3RuYW1lOiB1YjMubWFyY2hlbmtvLm5ldC51YQptYW5hZ2VfZXRjX2hvc3RzOiB0cnVlCgojIGVuYWJsZSBudHAKbnRwOgogIGVuYWJsZWQ6IHRydWUKCiMgdGltZXpvbmUKdGltZXpvbmU6IEV1cm9wZS9LaWV2CgojIGRpc2FibGUgcm9vdCBsb2dpbiB2aWEgc3NoCmRpc2FibGVfcm9vdDogdHJ1ZQoKIyBvcHRpb25hbCwgYWRkaXRpb25hbCBncm91cHMKZ3JvdXBzOgogICMgYmVjYXVzZSB3ZSBnb25uYSBpbnN0YWxsIGRvY2tlcgogIC0gZG9ja2VyCgp1c2VyczoKICAtIG5hbWU6IG1hYwogICAgIyBhbGxvd3MgcGFzc3dvcmQgYXV0aG5ldGljYXRpb24gd2hlbiBzZXQgdG8gZmFsc2UsIHRydWUgYnkgZGVmYXVsdAogICAgbG9ja19wYXNzd2Q6IEZhbHNlCiAgICAjIHBhc3N3b3JkIGhhc2gsIGNyZWF0ZWQgYnkgYG1rcGFzc3dkIC0tbWV0aG9kPVNIQS01MTIgLS1yb3VuZHM9NDA5NmAsIHJlYWQgdGhlIGRvY3MgYmVmb3JlIGNvbXBsYWluaW5nIHNlY3VyaXR5IGFnYWluc3QgcGxhaW4KICAgICMgcGFzc3dkOiAkNiRyb3VuZHM9NDA5NiQ0SmgycndmOWgyak05VGJRJC5DVFNQSlBJb0lPVXdLVm80QTJFcjE5RGV1OTQ1bS9vRC5KWFZFR05IOWcvcGlLLm1vdGJsa2Uva3B5UFEwbnBOS0Yualpqemk2MVpTQlBHTmJKeUsvCiAgICAjIGFsdGVybmF0aXZlIGFwcHJvYWNoIHdpdGggcGxhaW4gdGV4dCBwYXNzd29yZAogICAgcGxhaW5fdGV4dF9wYXNzd2Q6IHNlY3JldAogICAgc3NoX2F1dGhvcml6ZWRfa2V5czoKICAgICAgLSBzc2gtcnNhIEFBQUFCM056YUMxeWMyRUFBQUFCSlFBQUFRRUF5ZmROemo0bWJsMFBpT0E3VlF4ZU84Y1IvVTl1MlNkUkZaYVpsUmF0ZEpaMXNZWWEvUTBqTURPc3I3b2tsZnRYNDl5R3B1VzFzQnRXTGV2YUt0Y0t6M2tIa0luRnZsZWJGZUZCOXVQbU1mbzhnZCtRTHVMYzhMZU9RZ240d2xTUEV1aXpEeHVNZDFTejFmclo3cjdRVUg4SGRobkNPL0ZYdElnK2M4REhzQVZRU3hhcGZhbFZDdjR6NEVpQzNsZThTeGxaanhmL0thVm1JZFlPcGJMZjBHQlAvZ1A1T2JGWXh2dFR4N1JwMWxNMVpTWFlWR0ZCcFhDMTVXWU1IS3ErTGZROEQwV3B3aU9JWHcwNzIzaytDU1ViM3RIUzVhOEh6MEdVdGpNT2l6Y2xJZWl2NTAzRHFaQUE4Unh0V0xmTFVGZENlVWdFeXZJdTQzMHM0eEJxU3c9PSByc2Eta2V5LTIwMTQwNDA5CiAgICBncm91cHM6CiAgICAgIC0gYWRtCiAgICAgIC0gY2Ryb20KICAgICAgLSBzdWRvCiAgICAgIC0gZGlwCiAgICAgIC0gcGx1Z2RldgogICAgICAtIGx4ZAogICAgICAjIGFkZCB1c2VyIHRvIGRvY2tlciBncm91cAogICAgICAtIGRvY2tlcgogICAgc3VkbzoKICAgICAgIyBhbGxvdyBzdWRvCiAgICAgIC0gQUxMPShBTEwpIE5PUEFTU1dEOkFMTAogICAgc2hlbGw6IC9iaW4vYmFzaAoKIyBvcHRpb25hbCwgYWRkaXRpb25hbCBhcHQgc291cmNlcywgZG9ja2VyCmFwdDoKICBzb3VyY2VzOgogICAgZG9ja2VyLmxpc3Q6CiAgICAgIHNvdXJjZTogZGViIFthcmNoPWFtZDY0XSBodHRwczovL2Rvd25sb2FkLmRvY2tlci5jb20vbGludXgvdWJ1bnR1ICRSRUxFQVNFIHN0YWJsZQogICAgICBrZXlpZDogOURDODU4MjI5RkM3REQzODg1NEFFMkQ4OEQ4MTgwM0MwRUJGQ0Q4OAoKIyBhcHQgdXBkYXRlICYmIGFwdCB1cGdyYWRlLCByZWJvb3QgaWYgbmVlZGVkCnBhY2thZ2VfdXBkYXRlOiB0cnVlCnBhY2thZ2VfdXBncmFkZTogdHJ1ZQpwYWNrYWdlX3JlYm9vdF9pZl9yZXF1aXJlZDogdHJ1ZQoKIyBpbnN0YWxsIHBhY2thZ2VzCnBhY2thZ2VzOgogIC0gZG9ja2VyLWNlCiAgLSBkb2NrZXItY2UtY2xpCiAgLSBjb250YWluZXJkLmlvCg==</span></code></pre></div></p>\n<h2>ESXi Cloud Init Networking</h2>\n<p>To configure networking we need to do almost same steps but now with <code class=\"language-text\">metadata</code>, so add to VM following:</p>\n<table>\n<thead>\n<tr>\n<th>Key</th>\n<th>Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">guestinfo.metadata.encoding</code></td>\n<td><code class=\"language-text\">base64</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">guestinfo.metadata</code></td>\n<td>base64 metadata.yml</td>\n</tr>\n</tbody>\n</table>\n<p><div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">network</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">ethernets</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nics</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">match</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ens*\n      <span class=\"token key atrule\">dhcp4</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n      <span class=\"token key atrule\">dhcp6</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n      <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> 192.168.106.22/24\n      <span class=\"token key atrule\">gateway4</span><span class=\"token punctuation\">:</span> 192.168.106.1\n      <span class=\"token key atrule\">nameservers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>8.8.8.8<span class=\"token punctuation\">,</span> 1.1.1.1<span class=\"token punctuation\">]</span>\n<span class=\"token comment\"># first ens160, second ens192</span>\n\n<span class=\"token comment\"># guestinfo.metadata: cat metadata.yml | base64 | pbcopy</span>\n<span class=\"token comment\"># guestinfo.metadata.encoding: base64</span>\n\n<span class=\"token comment\"># guestinfo.metadata.encoding: base64</span>\n<span class=\"token comment\"># guestinfo.metadata: bmV0d29yazoKICB2ZXJzaW9uOiAyCiAgZXRoZXJuZXRzOgogICAgbmljczoKICAgICAgbWF0Y2g6CiAgICAgICAgbmFtZTogZW5zKgogICAgICBkaGNwNDogZmFsc2UKICAgICAgZGhjcDY6IGZhbHNlCiAgICAgIGFkZHJlc3NlczoKICAgICAgICAtIDE5Mi4xNjguMTA2LjIyLzI0CiAgICAgIGdhdGV3YXk0OiAxOTIuMTY4LjEwNi4xCiAgICAgIG5hbWVzZXJ2ZXJzOgogICAgICAgIGFkZHJlc3NlczogWzguOC44LjgsIDEuMS4xLjFdCg==</span></code></pre></div></p>\n<p>Notes:</p>\n<ul>\n<li>there is no need for any special first line in this file</li>\n<li>there is same 500kb limit as for user data</li>\n<li>seems like first network card is always <code class=\"language-text\">ens160</code> and second <code class=\"language-text\">ens192</code></li>\n</ul>\n<p>With all this in please we should have bootstraped docker host</p>\n<p>More info about available modules can be found here:</p>\n<p><a href=\"https://cloudinit.readthedocs.io/en/latest/topics/modules.html\">https://cloudinit.readthedocs.io/en/latest/topics/modules.html</a></p>\n<p>And here is <a href=\"/esxi-automate-vm-creation\">how to automate esxi vm</a></p>"}},"pageContext":{"id":"d7c430f7-04c3-5040-81b0-3e7f7d1859bb"}},"staticQueryHashes":[],"slicesMap":{}}