{"componentChunkName":"component---src-templates-note-js","path":"/sql-change-tracking/","result":{"data":{"remark":{"fields":{"path":"sql-change-tracking"},"meta":{"title":""},"headings":[{"value":"SQL Server Change Tracking Example"}],"html":"<h1>SQL Server Change Tracking Example</h1>\n<p>It is not the same as logical replication in PostgreSQL but still good enough to track changes in SQL table</p>\n<p><div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- DROP TABLE Demo2;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> Demo2 <span class=\"token punctuation\">(</span>Id <span class=\"token keyword\">INT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span> Name NVARCHAR<span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> Demo2<span class=\"token punctuation\">(</span>Id<span class=\"token punctuation\">,</span> Name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'one'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'two'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> Id<span class=\"token punctuation\">,</span> Name <span class=\"token keyword\">FROM</span> Demo2<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- prerequisites</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> RabotaUA2 <span class=\"token keyword\">SET</span> ALLOW_SNAPSHOT_ISOLATION <span class=\"token keyword\">ON</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> RabotaUA2 <span class=\"token keyword\">SET</span> CHANGE_TRACKING <span class=\"token operator\">=</span> <span class=\"token keyword\">ON</span> <span class=\"token punctuation\">(</span>CHANGE_RETENTION <span class=\"token operator\">=</span> <span class=\"token number\">2</span> DAYS<span class=\"token punctuation\">,</span> AUTO_CLEANUP <span class=\"token operator\">=</span> <span class=\"token keyword\">ON</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- enable change tracking for concrete table</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">[</span>RabotaUA2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span>dbo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span>Demo2<span class=\"token punctuation\">]</span> <span class=\"token keyword\">ENABLE</span> CHANGE_TRACKING<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- will be empty, because we enabled change tracking after adding records</span>\n<span class=\"token keyword\">SELECT</span> SYS_CHANGE_VERSION <span class=\"token keyword\">AS</span> V<span class=\"token punctuation\">,</span> SYS_CHANGE_OPERATION Op<span class=\"token punctuation\">,</span> Id <span class=\"token keyword\">FROM</span> CHANGETABLE <span class=\"token punctuation\">(</span>CHANGES dbo<span class=\"token punctuation\">.</span>Demo2<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> CT <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> SYS_CHANGE_VERSION <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- demos</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> Demo2<span class=\"token punctuation\">(</span>Id<span class=\"token punctuation\">,</span> Name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'three'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">UPDATE</span> Demo2 <span class=\"token keyword\">SET</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">'two'</span> <span class=\"token keyword\">WHERE</span> Id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> Demo2 <span class=\"token keyword\">WHERE</span> Id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- now we will have desired changes</span>\n<span class=\"token keyword\">SELECT</span> SYS_CHANGE_VERSION <span class=\"token keyword\">AS</span> V<span class=\"token punctuation\">,</span> SYS_CHANGE_OPERATION Op<span class=\"token punctuation\">,</span> Id <span class=\"token keyword\">FROM</span> CHANGETABLE <span class=\"token punctuation\">(</span>CHANGES dbo<span class=\"token punctuation\">.</span>Demo2<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> CT <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> SYS_CHANGE_VERSION <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- V\tOp\tId</span>\n<span class=\"token comment\">-- 16\tI\t3</span>\n<span class=\"token comment\">-- 17\tU\t2</span>\n<span class=\"token comment\">-- 18\tD\t1</span>\n\n<span class=\"token comment\">-- we may start from last V we have processed, aka</span>\n<span class=\"token keyword\">SELECT</span> SYS_CHANGE_VERSION <span class=\"token keyword\">AS</span> V<span class=\"token punctuation\">,</span> SYS_CHANGE_OPERATION Op<span class=\"token punctuation\">,</span> Id <span class=\"token keyword\">FROM</span> CHANGETABLE <span class=\"token punctuation\">(</span>CHANGES dbo<span class=\"token punctuation\">.</span>Demo2<span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span class=\"token punctuation\">)</span> CT <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> SYS_CHANGE_VERSION <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- V\tOp\tId</span>\n<span class=\"token comment\">-- 18\tD\t1</span>\n\n<span class=\"token comment\">-- optionally we may join original data</span>\n<span class=\"token keyword\">SELECT</span> SYS_CHANGE_VERSION <span class=\"token keyword\">AS</span> V<span class=\"token punctuation\">,</span> SYS_CHANGE_OPERATION Op<span class=\"token punctuation\">,</span> T<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> CHANGETABLE <span class=\"token punctuation\">(</span>CHANGES dbo<span class=\"token punctuation\">.</span>Demo2<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> CT <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> dbo<span class=\"token punctuation\">.</span>Demo2 T <span class=\"token keyword\">ON</span> CT<span class=\"token punctuation\">.</span>Id <span class=\"token operator\">=</span> T<span class=\"token punctuation\">.</span>Id <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> SYS_CHANGE_VERSION <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- V\tOp\tId\t\tName</span>\n<span class=\"token comment\">-- 16\tI\t3\t\tthree</span>\n<span class=\"token comment\">-- 17\tU\t2\t\ttwo</span>\n<span class=\"token comment\">-- 18\tD\tNULL\tNULL</span></code></pre></div></p>\n<p>So theoreticaly it might be something like infinite loop with backoff sleep timer tracking last processed version and processing new changes, aka sync to elastic, invalidate redis cache or producting kafka messages</p>"}},"pageContext":{"id":"bcba82f6-91a1-5ded-9deb-92f310dfa4eb"}},"staticQueryHashes":[],"slicesMap":{}}