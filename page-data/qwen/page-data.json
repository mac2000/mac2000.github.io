{"componentChunkName":"component---src-templates-note-js","path":"/qwen/","result":{"data":{"remark":{"fields":{"path":"qwen"},"meta":{"title":""},"headings":[{"value":"Fine-Tune Qwen2.5-Coder for TypeScript-Only Output on Macbook Air M1"}],"html":"<h1>Fine-Tune Qwen2.5-Coder for TypeScript-Only Output on Macbook Air M1</h1>\n<p>Here is my journey of attempts to fine tune model locally on macbook air</p>\n<p>First of all, important thing to understand - fine tuning is about teaching model of desired output format - not learning something new</p>\n<p>In this example, we are going to give it a try and fine tune Qwen model so it will always output typescript only code, no javascript leakage, no markdown, no explanations</p>\n<h2>Trainging Data Samples</h2>\n<p>Technically, fine tuning is quite easy and simple</p>\n<p>We need to prepare samples dataset first which will contain user prompts and generated response aka:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"messages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token property\">\"role\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"system\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"system prompt goes here\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token property\">\"role\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"write me a function to add two numbers\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token property\">\"role\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"assistant\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"expected output goes here\"</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For more or less adequate results we need at minimum ~500 such samples, the more is better</p>\n<p>Obviously we won't create this manually so let's utilize GPT</p>\n<p><div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> writeFileSync <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> system <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\nYou are a TypeScript code generator specialized in React.\nCRITICAL RULES:\n1. Output ONLY valid TypeScript/TSX code\n2. NO markdown code blocks (no \\`\\`\\`)\n3. NO explanations or comments outside the code\n4. NO JavaScript - always use TypeScript with proper types\n5. Include necessary imports\n6. Use functional components with hooks\n7. Export the component/hook as default\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> inputs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">\"Create a Button component with onClick handler\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Counter component with increment and decrement\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a TodoList component that displays items\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a TodoItem component with checkbox\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a SearchInput component with debounce\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Modal component with backdrop\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Dropdown component with options\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Tabs component with panels\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Accordion component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Tooltip component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Badge component with variants\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Avatar component with fallback\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Card component with header and footer\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Alert component with dismiss\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Spinner component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a ProgressBar component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Pagination component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Breadcrumb component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Switch toggle component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Slider component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a DatePicker component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a TimePicker component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a ColorPicker component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a FileUpload component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a ImageGallery component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Carousel component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Table component with sorting\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a DataGrid component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Form component with validation\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Input component with error state\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Select component with search\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Checkbox component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a RadioGroup component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a TextArea component with character count\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a RichTextEditor component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a CodeBlock component with syntax highlighting\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Navbar component with links\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Sidebar component with navigation\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Footer component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Header component with logo\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Layout component with slots\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Container component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Grid component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Stack component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Divider component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Spacer component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useLocalStorage hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useFetch hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useDebounce hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useClickOutside hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useMediaQuery hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useIntersectionObserver hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useKeyPress hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useWindowSize hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useScrollPosition hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a usePrevious hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useToggle hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useAsync hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useInterval hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useTimeout hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useCopyToClipboard hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useOnlineStatus hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useGeolocation hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useDarkMode hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useHover hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a useFocus hook\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Skeleton loading component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a EmptyState component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a ErrorBoundary component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Suspense wrapper component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a LazyLoad component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a InfiniteScroll component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a VirtualList component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Draggable component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Resizable component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a ContextMenu component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Toast notification component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Snackbar component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Dialog component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Drawer component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Popover component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Portal component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Overlay component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Stepper component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Timeline component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Rating component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Tag component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Chip component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a List component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a ListItem component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Menu component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a MenuItem component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a Toolbar component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a IconButton component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a FloatingActionButton component\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Create a ButtonGroup component\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> samples<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> messages<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> role<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> content<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// {\"messages\":[{\"role\":\"system\",\"content\":\"...\"},{\"role\":\"user\",\"content\":\"...\"},{\"role\":\"assistant\",\"content\":\"...\"}]}</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> inputs<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> input <span class=\"token operator\">=</span> inputs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">[</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>inputs<span class=\"token punctuation\">.</span>length<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">] </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>input<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://api.openai.com/v1/responses\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    method<span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n    headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n      Authorization<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OPENAI_API_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      model<span class=\"token operator\">:</span> <span class=\"token string\">\"gpt-5.1-codex-mini\"</span><span class=\"token punctuation\">,</span>\n      input<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span> role<span class=\"token operator\">:</span> <span class=\"token string\">\"system\"</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> system <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span> role<span class=\"token operator\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> input <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> data<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"```\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">  ⚠️  Skipped: contains markdown code blocks</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^(Here|This|The|I |Let me|Sure|Below)</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">i</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">  ⚠️  Skipped: starts with explanation</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>output<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>output<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"interface\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>output<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"type \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">  ⚠️  Skipped: missing TypeScript types</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>output<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"import\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>output<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"React\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">  ⚠️  Skipped: missing imports</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  samples<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    messages<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> role<span class=\"token operator\">:</span> <span class=\"token string\">\"system\"</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> system <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> role<span class=\"token operator\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> input <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> role<span class=\"token operator\">:</span> <span class=\"token string\">\"assistant\"</span><span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> output <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// just in case</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> shuffled <span class=\"token operator\">=</span> samples<span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> split_80_20 <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>shuffled<span class=\"token punctuation\">.</span>length <span class=\"token operator\">*</span> <span class=\"token number\">0.8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> train <span class=\"token operator\">=</span> shuffled<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> split_80_20<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> valid <span class=\"token operator\">=</span> shuffled<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>split_80_20<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"train.jsonl\"</span><span class=\"token punctuation\">,</span> train<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"valid.jsonl\"</span><span class=\"token punctuation\">,</span> valid<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DONE\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div></p>\n<p>This script will prepare something around one hundred of such samples, shufle them and store results in <code class=\"language-text\">train.jsonl</code> and <code class=\"language-text\">valid.jsonl</code></p>\n<p>Bot files contains json lines, where each line is an sample as described above.</p>\n<h2>MLX LM Fine Tune Qwen</h2>\n<p>After data samples are prepared we are ready for fine tuning</p>\n<p>On Mac we do not have CUDA but there is <a href=\"https://github.com/ml-explore/mlx-lm\">mlx-lm</a></p>\n<p>To avoid seven rounds of hell with python and its dependencies we can simply</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">brew <span class=\"token function\">install</span> mlx-lm</code></pre></div>\n<p>From what i understand mlx-lm is like simplified ollama, we can use it not only for fine tuning but to inference as well</p>\n<p>Here is quick example, let's fine tune model with our examples</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mlx_lm.lora <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--model</span> <span class=\"token string\">\"Qwen/Qwen2.5-Coder-0.5B-Instruct\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--train</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--data</span> <span class=\"token builtin class-name\">.</span> <span class=\"token punctuation\">\\</span>\n    --adapter-path ./adapters <span class=\"token punctuation\">\\</span>\n    --batch-size <span class=\"token number\">2</span> <span class=\"token punctuation\">\\</span>\n    --num-layers <span class=\"token number\">8</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--iters</span> <span class=\"token number\">100</span></code></pre></div>\n<p>Where:</p>\n<ul>\n<li><code class=\"language-text\">--model \"Qwen/Qwen2.5-Coder-0.5B-Instruct\"</code> base model that will be fine tuned, note that we using models from Hugging Face not Ollama</li>\n<li><code class=\"language-text\">--data .</code> - path to directory with <code class=\"language-text\">train.jsonl</code> and <code class=\"language-text\">valid.jsonl</code> files</li>\n<li><code class=\"language-text\">--adapter-path ./adapters</code> - path to directory where mlx should store results of fine tune</li>\n<li><code class=\"language-text\">--batch-size 1</code> - samples per training step. Higher - faster but more RAM. Ideally will be somewhere between 2 and 4</li>\n<li><code class=\"language-text\">--num-layers 2</code> - number of layers to apply LoRA. More - better quality but more RAM. Ideally will be somewhere between 8 and 16</li>\n<li><code class=\"language-text\">--iters 10</code> - training iterations. More - better learning but takes longer. Should be between 500 and 1000</li>\n</ul>\n<blockquote>\n<p>Note: by intent in sample we are using such small values, just to prove it works without us waiting forever for training to complete.</p>\n</blockquote>\n<p>Now, when our model is fine tuned we can test it like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mlx_lm.generate <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--model</span> <span class=\"token string\">\"Qwen/Qwen2.5-Coder-0.5B-Instruct\"</span> <span class=\"token punctuation\">\\</span>\n    --adapter-path ./adapters <span class=\"token punctuation\">\\</span>\n    --system-prompt <span class=\"token string\">\"You are a TypeScript code generator. Output only valid TypeScript code, no markdown, no explanations.\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--prompt</span> <span class=\"token string\">\"Create a function that calculates the average of two numbers\"</span></code></pre></div>\n<blockquote>\n<p>Note: here we are still passing prompt - without it model still may output whatever else, for model to trully output only typescript we need more training samples and do real full fine tune step, after which it should be possible to remove systemp prompt and expect desired output, without us asking model to respond with typescript.</p>\n</blockquote>\n<p>With this in place we have our short iteration loop in place and can play with samples until we are fine with results.</p>\n<h2>Ollama</h2>\n<p>Technically we may stop after previous steps, but in my case i wanted to run this model in Ollama which leads to never ending issues and problems</p>\n<p>If we are training llama, mistrel, etc everything works out of the box, as easy as</p>\n<p><a href=\"https://docs.ollama.com/import#importing-a-fine-tuned-adapter-from-safetensors-weights\">import fine tuned adapter</a></p>\n<p>But in our case we are dealing with unsupported model - which leads us to never ending problems and issues</p>\n<p>We need to use MLX Fuse to export our model</p>\n<p>Then, we are going to use llama.cpp to convert it to GGUF</p>\n<p>And only then we will be able to create Ollama model from it</p>\n<p>And each step may broke everything so we gonna need to verify results after every step</p>\n<h2>MLX Fuse</h2>\n<p>From my understanding fuse is a way to expoport model internals into folder</p>\n<p>Ideally if we are working with supported models we can simply run</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mlx_lm.fuse <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--model</span> <span class=\"token string\">\"Qwen/Qwen2.5-Coder-0.5B-Instruct\"</span> <span class=\"token punctuation\">\\</span>\n  --adapter-path ./adapters <span class=\"token punctuation\">\\</span>\n  --export-gguf <span class=\"token punctuation\">\\</span>\n  --gguf-path ./model.gguf</code></pre></div>\n<p>But it will fail with error: <code class=\"language-text\">ValueError: Model type qwen2 not supported for GGUF conversion.</code></p>\n<p>So, we should use:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mlx_lm.fuse <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--model</span> <span class=\"token string\">\"Qwen/Qwen2.5-Coder-0.5B-Instruct\"</span> <span class=\"token punctuation\">\\</span>\n  --adapter-path ./adapters <span class=\"token punctuation\">\\</span>\n  --save-path ./fused</code></pre></div>\n<h2>llama.cpp</h2>\n<p>Now, we want convert our fused model into gguf, and to do it we are going to use <code class=\"language-text\">llama.cpp</code> which can be installed like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">brew <span class=\"token function\">install</span> llama.cpp</code></pre></div>\n<p>it has bunch of helpers, and one of them is a pythong script to perform conversion</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/opt/homebrew/Cellar/llama.cpp/7310/bin/convert_hf_to_gguf.py /Users/mac/Desktop/finetun/fused <span class=\"token parameter variable\">--outtype</span> f16 <span class=\"token parameter variable\">--outfile</span> model.gguf</code></pre></div>\n<p>BUT, there is a catch, now, if we will try to test our model like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">llama-cli <span class=\"token parameter variable\">-m</span> model.gguf --system-prompt <span class=\"token string\">\"You are a TypeScript code generator. Output only valid TypeScript code, no markdown, no explanations.\"</span> <span class=\"token parameter variable\">--prompt</span> <span class=\"token string\">\"Create a function that calculates the average of two numbers\"</span> <span class=\"token parameter variable\">-n</span> <span class=\"token number\">100</span> --no-conversation</code></pre></div>\n<p>it will produce garbage, literally garbage, not even close to code at all, not talking about typescript</p>\n<p>That's becuase of mlx format which is not supported by llama.cpp, so still we need to perform one more conversion before proceeding</p>\n<p><div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#!/usr/bin/env python3</span>\n<span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> mlx<span class=\"token punctuation\">.</span>core <span class=\"token keyword\">as</span> mx\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">from</span> safetensors<span class=\"token punctuation\">.</span>numpy <span class=\"token keyword\">import</span> save_file\n\nweights <span class=\"token operator\">=</span> mx<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span><span class=\"token string\">\"./fused/model.safetensors\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Converting </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>weights<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> tensors...\"</span></span><span class=\"token punctuation\">)</span>\nnp_weights <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> weights<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    arr <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>astype<span class=\"token punctuation\">(</span>mx<span class=\"token punctuation\">.</span>float32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    np_weights<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> arr<span class=\"token punctuation\">.</span>astype<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>float16<span class=\"token punctuation\">)</span>\n\nos<span class=\"token punctuation\">.</span>makedirs<span class=\"token punctuation\">(</span><span class=\"token string\">\"./fused_standard\"</span><span class=\"token punctuation\">,</span> exist_ok<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\nsave_file<span class=\"token punctuation\">(</span>np_weights<span class=\"token punctuation\">,</span> <span class=\"token string\">\"./fused_standard/model.safetensors\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Done!\"</span><span class=\"token punctuation\">)</span></code></pre></div></p>\n<p>if you take closer look - all we are doing is changing type from float 32 to float 16</p>\n<p>Note: as for dependencies we need something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">python3 <span class=\"token parameter variable\">-m</span> venv venv\n<span class=\"token builtin class-name\">source</span> venv/bin/activate\npip <span class=\"token function\">install</span> mlx numpy safetensors torch transformers sentencepiece</code></pre></div>\n<p>So it is unavoidable to do everything without python.</p>\n<p>At the very end we need to do following:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cp</span> <span class=\"token parameter variable\">-r</span> fused fused_standard\npython convert.py</code></pre></div>\n<p>fused standard will have same files, except <code class=\"language-text\">model.safetensors</code> where we are changing types</p>\n<p>Now, we can run converter once again</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/opt/homebrew/Cellar/llama.cpp/7310/bin/convert_hf_to_gguf.py /Users/mac/Desktop/finetun/fused_standard <span class=\"token parameter variable\">--outtype</span> f16 <span class=\"token parameter variable\">--outfile</span> model.gguf</code></pre></div>\n<p>and still it wont work: <code class=\"language-text\">ModuleNotFoundError: No module named 'gguf'</code></p>\n<p>thankfully opus was able to figure out workaround, we are going to clone llama cpp repo and install gguf that was only one possible way for make things working</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/ggml-org/llama.cpp\npython llama.cpp/convert_hf_to_gguf.py /Users/mac/Desktop/finetun/fused_standard <span class=\"token parameter variable\">--outtype</span> f16 <span class=\"token parameter variable\">--outfile</span> model.gguf</code></pre></div>\n<p>and test it</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">llama-cli <span class=\"token parameter variable\">-m</span> model.gguf --system-prompt <span class=\"token string\">\"You are a TypeScript code generator. Output only valid TypeScript code, no markdown, no explanations.\"</span> <span class=\"token parameter variable\">--prompt</span> <span class=\"token string\">\"Create a function that calculates the average of two numbers\"</span> <span class=\"token parameter variable\">-n</span> <span class=\"token number\">100</span> --no-conversation</code></pre></div>\n<p>And it generates something meaningfull</p>\n<h2>Ollama</h2>\n<p>Now, when we have gguf we can play with ollama, actually it is quite easy and simple</p>\n<p>we need to create model like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"FROM ./model.gguf\"</span> <span class=\"token operator\">></span> Modelfile\nollama create typescript-coder <span class=\"token parameter variable\">-f</span> Modelfile</code></pre></div>\n<p>And finally:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ollama run typescript-coder <span class=\"token string\">\"Create a function that calculates the average of two numbers\"</span></code></pre></div>\n<h3>Why is Python required for conversion?</h3>\n<p><strong>Short answer</strong>: MLX uses a proprietary safetensors format that only MLX can read.</p>\n<p>MLX saves model weights with <code class=\"language-text\">{\"format\": \"mlx\"}</code> metadata in the safetensors file. This format:</p>\n<ul>\n<li>Cannot be read by the standard <code class=\"language-text\">safetensors</code> library</li>\n<li>Cannot be read by llama.cpp's <code class=\"language-text\">convert_hf_to_gguf.py</code></li>\n<li>Can only be loaded using <code class=\"language-text\">mlx.core.mx.load()</code></li>\n</ul>\n<p>Additionally, <code class=\"language-text\">mlx_lm.fuse --export-gguf</code> exists but only supports llama/mixtral/mistral models, <strong>not Qwen2</strong>.</p>\n<p>The 17-line <code class=\"language-text\">convert.py</code> script is the minimal solution: it loads weights via MLX, converts to numpy, and saves with the standard safetensors library.</p>"}},"pageContext":{"id":"16e39b86-f466-5ef3-8d57-5005a2361717"}},"staticQueryHashes":[],"slicesMap":{}}