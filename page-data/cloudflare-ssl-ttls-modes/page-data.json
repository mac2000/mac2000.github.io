{"componentChunkName":"component---src-templates-note-js","path":"/cloudflare-ssl-ttls-modes/","result":{"data":{"remark":{"fields":{"path":"cloudflare-ssl-ttls-modes"},"meta":{"title":""},"headings":[{"value":"CloudFlare SSL/TSL Modes and How to Use Them"},{"value":"Flexible"},{"value":"Full"},{"value":"Strict"}],"html":"<h1>CloudFlare SSL/TSL Modes and How to Use Them</h1>\n<p>CloudFlare has following SSL/TSL modes:</p>\n<ul>\n<li><strong>Off</strong> - no encryption</li>\n<li><strong>Flexible</strong> - encrypts traffic between the browser and Cloudflare</li>\n<li><strong>Full</strong> - encrypts end-to-end, using a self signed certificate on the server</li>\n<li><strong>Full (Strict)</strong> - encrypts end-to-end, but requires a trusted CA or Cloudflare Origin CA certificate on the server</li>\n</ul>\n<p>Also this settings can be overriden in page rules section, so for example one subdomain might work in flexible mode and another in full</p>\n<p>For experiments we have dedicated VM with a public network and subdomain</p>\n<ul>\n<li>IP: <code class=\"language-text\">161.35.222.169</code></li>\n<li>DNS: <code class=\"language-text\">cf.mac-blog.org.ua</code></li>\n</ul>\n<p>On server all we did is:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt</span> update\n<span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> nginx\n<span class=\"token function\">curl</span> http://161.35.222.169</code></pre></div>\n<h1>Flexible</h1>\n<p>Is the easiest way to become \"secure\"</p>\n<p>Cloudflare will handle all TLS related things and you do not to do anything at all</p>\n<p>Underneath it will be something like:</p>\n<svg width=\"100pt\" height=\"222pt\" viewBox=\"0.00 0.00 99.99 221.60\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" style=\"max-width: 100%; height: auto;\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 217.6)\">\n<title>G</title>\n<polygon fill=\"#ffffff\" stroke=\"transparent\" points=\"-4,4 -4,-217.6 95.9895,-217.6 95.9895,4 -4,4\"></polygon>\n<!-- user -->\n<g id=\"node1\" class=\"node\">\n<title>user</title>\n<polygon fill=\"none\" stroke=\"#000000\" points=\"63.3731,-213.6 9.3731,-213.6 9.3731,-177.6 63.3731,-177.6 63.3731,-213.6\"></polygon>\n<text text-anchor=\"middle\" x=\"36.3731\" y=\"-191.4\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">user</text>\n</g>\n<!-- cloudflare -->\n<g id=\"node2\" class=\"node\">\n<title>cloudflare</title>\n<polygon fill=\"none\" stroke=\"#000000\" points=\"72.6197,-124.8 .1265,-124.8 .1265,-88.8 72.6197,-88.8 72.6197,-124.8\"></polygon>\n<text text-anchor=\"middle\" x=\"36.3731\" y=\"-102.6\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">cloudflare</text>\n</g>\n<!-- user&#45;&gt;cloudflare -->\n<g id=\"edge1\" class=\"edge\">\n<title>user-&gt;cloudflare</title>\n<path fill=\"none\" stroke=\"#000000\" d=\"M36.3731,-177.2006C36.3731,-165.0949 36.3731,-149.0076 36.3731,-135.2674\"></path>\n<polygon fill=\"#000000\" stroke=\"#000000\" points=\"39.8732,-134.872 36.3731,-124.872 32.8732,-134.8721 39.8732,-134.872\"></polygon>\n<text text-anchor=\"middle\" x=\"64.1813\" y=\"-147\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">:443 https</text>\n</g>\n<!-- server -->\n<g id=\"node3\" class=\"node\">\n<title>server</title>\n<polygon fill=\"none\" stroke=\"#000000\" points=\"63.3731,-36 9.3731,-36 9.3731,0 63.3731,0 63.3731,-36\"></polygon>\n<text text-anchor=\"middle\" x=\"36.3731\" y=\"-13.8\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">server</text>\n</g>\n<!-- cloudflare&#45;&gt;server -->\n<g id=\"edge2\" class=\"edge\">\n<title>cloudflare-&gt;server</title>\n<path fill=\"none\" stroke=\"#000000\" d=\"M36.3731,-88.4006C36.3731,-76.2949 36.3731,-60.2076 36.3731,-46.4674\"></path>\n<polygon fill=\"#000000\" stroke=\"#000000\" points=\"39.8732,-46.072 36.3731,-36.072 32.8732,-46.0721 39.8732,-46.072\"></polygon>\n<text text-anchor=\"middle\" x=\"57.959\" y=\"-58.2\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">:80 http</text>\n</g>\n</g>\n</svg>\n<p>Take a note that if user knows server ip address he can send requests directly to it bypassing cloudflare</p>\n<p>Cloudflare has a <a href=\"https://www.cloudflare.com/ips/\">list of its ip addresses</a> so we can do something like:</p>\n<p><strong>/etc/nginx/cloudflare.conf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">allow <span class=\"token number\">173.245</span>.48.0/20<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">103.21</span>.244.0/22<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">103.22</span>.200.0/22<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">103.31</span>.4.0/22<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">141.101</span>.64.0/18<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">108.162</span>.192.0/18<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">190.93</span>.240.0/20<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">188.114</span>.96.0/20<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">197.234</span>.240.0/22<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">198.41</span>.128.0/17<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">162.158</span>.0.0/15<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">104.16</span>.0.0/13<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">104.24</span>.0.0/14<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">172.64</span>.0.0/13<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">131.0</span>.72.0/22<span class=\"token punctuation\">;</span>\n\nallow <span class=\"token number\">2400</span>:cb00::/32<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">2606</span>:4700::/32<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">2803</span>:f800::/32<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">2405</span>:b500::/32<span class=\"token punctuation\">;</span>\nallow <span class=\"token number\">2405</span>:8100::/32<span class=\"token punctuation\">;</span>\nallow 2a06:98c0::/29<span class=\"token punctuation\">;</span>\nallow 2c0f:f248::/32<span class=\"token punctuation\">;</span>\n\ndeny all<span class=\"token punctuation\">;</span></code></pre></div>\n<p>And inside our site config add somewhere this line:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">include</span> /etc/nginx/cloudflare.conf</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Reload nginx: <code class=\"language-text\">systemctl reload nginx</code></p>\n<p>And test it from outside: <code class=\"language-text\">curl --resolve cf.mac-blog.org.ua:80:161.35.222.169 http://cf.mac-blog.org.ua/</code></p>\n<p>If everything ok you should receive forbidden response, but if you open it in browser, everything will work fine</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 951px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c6504fb73307768e815f1e382c089af6/9b379/flexible.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.84375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB0ElEQVR42pVSa2/bMAz0//9lHdIln4YktpOtme3KkizZkh/yKzeQS4Kue6AjcKBMmSceyahxHm3bwfkW/RDQdj2ErCC0QakNZGVRKvMzRlAGr7czxd8j8t6haRpYW0MqDVFKGFvDec9onEPfDwjjhHGaMYSRfQgjx6mIO+guei1yZFkOJSWUUvCeKvZoyXcdxzebDba7LT4/P+MYx9htd3h6+gRjLMiu1yvuFikloFUBIUoURcGE8zxjGAaEEGCtQZ4XyL5neLm8IMsyPmfZBbW1qOuafVVp9H2PSGuJNEmw3x+x3+8Rx0ecTicIIdB1Hay1OKUJzucz0jTF8XBgfzh8xeUiUBkDJWc4P+N6XamHnl/Js5z7SK81dfOQQd+lIBUKSipui2saNPUC71es64ppApblJtlUhmU65279a/lMg1qWlR/r2hbTNHELqBVve/beIkpUNF1RoixLaK05mUC9JMnk3xoREuefeFkyJUmpWDJhHMfHD3RH5DeqG/5uEckjKTShMYwIw/AgpAqMMZimER81JlyWhWXdQRVZXglah+qXij9ESAlUJfk7+mGA7wKk/k9C2i/aO9qtOI4ZSZIgSU/4ckxx/nb5bSj/IvwBae3nUeqUtfoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"flexible\"\n        title=\"\"\n        src=\"/static/c6504fb73307768e815f1e382c089af6/9b379/flexible.png\"\n        srcset=\"/static/c6504fb73307768e815f1e382c089af6/6f3f2/flexible.png 256w,\n/static/c6504fb73307768e815f1e382c089af6/01e7c/flexible.png 512w,\n/static/c6504fb73307768e815f1e382c089af6/9b379/flexible.png 951w\"\n        sizes=\"(max-width: 951px) 100vw, 951px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1>Full</h1>\n<p>This time our schema will look like</p>\n<svg width=\"173pt\" height=\"222pt\" viewBox=\"0.00 0.00 173.07 221.60\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" style=\"max-width: 100%; height: auto;\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 217.6)\">\n<title>G</title>\n<polygon fill=\"#ffffff\" stroke=\"transparent\" points=\"-4,4 -4,-217.6 169.0709,-217.6 169.0709,4 -4,4\"></polygon>\n<!-- user -->\n<g id=\"node1\" class=\"node\">\n<title>user</title>\n<polygon fill=\"none\" stroke=\"#000000\" points=\"63.3731,-213.6 9.3731,-213.6 9.3731,-177.6 63.3731,-177.6 63.3731,-213.6\"></polygon>\n<text text-anchor=\"middle\" x=\"36.3731\" y=\"-191.4\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">user</text>\n</g>\n<!-- cloudflare -->\n<g id=\"node2\" class=\"node\">\n<title>cloudflare</title>\n<polygon fill=\"none\" stroke=\"#000000\" points=\"72.6197,-124.8 .1265,-124.8 .1265,-88.8 72.6197,-88.8 72.6197,-124.8\"></polygon>\n<text text-anchor=\"middle\" x=\"36.3731\" y=\"-102.6\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">cloudflare</text>\n</g>\n<!-- user&#45;&gt;cloudflare -->\n<g id=\"edge1\" class=\"edge\">\n<title>user-&gt;cloudflare</title>\n<path fill=\"none\" stroke=\"#000000\" d=\"M36.3731,-177.2006C36.3731,-165.0949 36.3731,-149.0076 36.3731,-135.2674\"></path>\n<polygon fill=\"#000000\" stroke=\"#000000\" points=\"39.8732,-134.872 36.3731,-124.872 32.8732,-134.8721 39.8732,-134.872\"></polygon>\n<text text-anchor=\"middle\" x=\"64.1813\" y=\"-147\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">:443 https</text>\n</g>\n<!-- server -->\n<g id=\"node3\" class=\"node\">\n<title>server</title>\n<polygon fill=\"none\" stroke=\"#000000\" points=\"63.3731,-36 9.3731,-36 9.3731,0 63.3731,0 63.3731,-36\"></polygon>\n<text text-anchor=\"middle\" x=\"36.3731\" y=\"-13.8\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">server</text>\n</g>\n<!-- cloudflare&#45;&gt;server -->\n<g id=\"edge2\" class=\"edge\">\n<title>cloudflare-&gt;server</title>\n<path fill=\"none\" stroke=\"#000000\" d=\"M36.3731,-88.4006C36.3731,-76.2949 36.3731,-60.2076 36.3731,-46.4674\"></path>\n<polygon fill=\"#000000\" stroke=\"#000000\" points=\"39.8732,-46.072 36.3731,-36.072 32.8732,-46.0721 39.8732,-46.072\"></polygon>\n<text text-anchor=\"middle\" x=\"100.722\" y=\"-58.2\" font-family=\"Times,serif\" font-size=\"14.00\" fill=\"#000000\">:443 https (self signed)</text>\n</g>\n</g>\n</svg>\n<p>First of all we need self signed certificate:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">openssl req <span class=\"token parameter variable\">-subj</span> <span class=\"token string\">\"/CN=cf.mac-blog.org.ua/\"</span> <span class=\"token parameter variable\">-newkey</span> rsa:2048 <span class=\"token parameter variable\">-nodes</span> <span class=\"token parameter variable\">-keyout</span> tls.key <span class=\"token parameter variable\">-x509</span> <span class=\"token parameter variable\">-days</span> <span class=\"token number\">365</span> <span class=\"token parameter variable\">-out</span> tls.pem</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>this cert without <code class=\"language-text\">SAN</code> so can be used only for a given <code class=\"language-text\">CN</code></li>\n<li><code class=\"language-text\">tls.key</code> will hold private key which should be keept safe</li>\n<li><code class=\"language-text\">tls.pem</code> is a certificate which may be publisheed</li>\n</ul>\n<p>And here is config:</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># for experiment to be sure that cloudflare will not land here</span>\n        <span class=\"token comment\"># listen 80 default_server;</span>\n        <span class=\"token comment\"># listen [::]:80 default_server;</span>\n\n        <span class=\"token comment\"># added</span>\n        <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">443</span> ssl default_server</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">listen</span> [::]:443 ssl default_server</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">ssl_certificate</span> /etc/nginx/tls.pem</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">ssl_certificate_key</span> /etc/nginx/tls.key</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\"># include /etc/nginx/cloudflare.conf;</span>\n\n        <span class=\"token directive\"><span class=\"token keyword\">root</span> /var/www/html</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">index</span> index.html index.htm index.nginx-debian.html</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token directive\"><span class=\"token keyword\">server_name</span> _</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token directive\"><span class=\"token keyword\">try_files</span> <span class=\"token variable\">$uri</span> <span class=\"token variable\">$uri</span>/ =404</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now your server should listen only 433 but not 80, e.g:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> https://cf.mac-blog.org.ua/</code></pre></div>\n<p>Also you can watch for logs:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">tail</span> /var/log/nginx/access.log <span class=\"token parameter variable\">-f</span></code></pre></div>\n<p>You will see your requests, comming from cloudflare ip addresses</p>\n<p>Lets try to bypass cloudflare</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> cf.mac-blog.org.ua:80:161.35.222.169 http://cf.mac-blog.org.ua/\n<span class=\"token comment\"># curl: (7) Failed to connect to cf.mac-blog.org.ua port 80: Connection refused</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">--resolve</span> cf.mac-blog.org.ua:443:161.35.222.169 https://cf.mac-blog.org.ua/\n<span class=\"token comment\"># curl: (77) schannel: next InitializeSecurityContext failed: SEC_E_UNTRUSTED_ROOT (0x80090325) - The certificate chain was issued by an authority that is not trusted.</span>\n\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-k</span> <span class=\"token parameter variable\">--resolve</span> cf.mac-blog.org.ua:443:161.35.222.169 https://cf.mac-blog.org.ua/\n<span class=\"token comment\"># works - but only because we commented out cloudflare ip rules</span></code></pre></div>\n<h1>Strict</h1>\n<p>Is same as Full, the only difference now that CloudFlare wont believe self signed requests and will require valid certificates, or certificates signed by CloudFlare</p>\n<p>If you turn this on, immediatelly you will start receive invalid certifiacte errors</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 921px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c274f72c44beacb526a50ba964fb9d0b/0f67e/invalid_certificate.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.609375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABoElEQVR42p1QTW/TQBD17+fCpaKihUs4ICR+AFIrcSoSXxK0ISEtbv3t3dm1nXhtx44Sv2qndkjh1pGeNPPezpudcZqmQV3XWK/XaNsWZVnCcofR9/3/ed8/4sdwiqIAEUEpBWMMkiThfLPZ8ABrvm4adF3Hdde22HQd1/ZNPxiPcLbb7V606IbHu90OTwlntVqhLFe8al1XjNIYWH7UlssljClRVYbzURtRVxXqoceRUvLKdtXZdIH5bIEkTSAlwWpCCOR5jjBI4N54yLIMQkjWuFdKLFwX17e3XDv2XlmmEfgRLr5+wJcfH+F7IXN2UJ5nuPw5xavJcxy/fobp1Yy58e4y03h/coq3R0cQSj0YKk0gscSn32/w+fodKC0eOCI2/nV5g7NvL3H+/QTzqbsfpuwPjcF8MsHVi2NIYwZDNlUgkTG0HjilQKRQFDk05VCUc245q2mtkaYp/DiCn8R8NudvI8GPXATx3d5shCQJL/wDL3D5ToeaNU38ALHvQ2l9YKgIsfAQCWtI/5gSEuEjFnf87pGmNWQYQkYRG94DOGvuioEKLEsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Error 526: Invalid SSL certificate\"\n        title=\"\"\n        src=\"/static/c274f72c44beacb526a50ba964fb9d0b/0f67e/invalid_certificate.png\"\n        srcset=\"/static/c274f72c44beacb526a50ba964fb9d0b/6f3f2/invalid_certificate.png 256w,\n/static/c274f72c44beacb526a50ba964fb9d0b/01e7c/invalid_certificate.png 512w,\n/static/c274f72c44beacb526a50ba964fb9d0b/0f67e/invalid_certificate.png 921w\"\n        sizes=\"(max-width: 921px) 100vw, 921px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>There are two options, you can let cloudflare to do its work and generate certs for you, or you can create private key and certificate signing request and ask cloudflare to sign it</p>\n<h2>Cloudflare Strict - aka LetsEncrypt for 15 years</h2>\n<p>Easiest way will be to let Cloudflare generate certs, good thing here is that by default they are generated for 15 year, yep it might be not secure but for home lab it is much better than 1 month certs from letsencrypt</p>\n<p>So navigate to SSL/TLS \\ Origin Server \\ Origin Certifiacetes \\ Create Certificate</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/55c1ec4a966bd47519ac929bf1b1a6ff/73caa/create_certificate.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABxElEQVR42o1TW47bMAz0/c/Qk/SvhyiwBfIROPEbiRzraUvWLIax0u0CbVcAYYkWh0MOVa1bgjEGWmvEGJFzhvUbrF8R44Zt+23IGf9blQ1RAAmUj4DH44FpmjCO0/EdMAyDgKaUkNL+d0C/Rnjv5VAAlVK41DW6rsPQ9+j7AX3fS4Ku7Y79KHa73eTLu9YYVIuLcFohb+6VxWiN+/0uzK2lWbGwBqzrihCCkPA+HPvnl4QqvyZYsyDvSRz7vktpBJzn+QDw4stf6eG+JyyHIGURlOyc9+Jn3766KgaTCYXIeDIIPojqy7KI3zkrJZZyS8llv23rS7CKBzaZJTrnhBETNE0jAnRti+v1iqZpcW0anE4n1PVFfOfzGb/e3nCpL5jGSeKrmHZobeCcl1K5KAATlMySPaYXo9JXo5/zW9gzXkThpTI2RRiOAkEZMCslpdNf/pe75VzErMInQC6CDMMoraBxFtu2kyGf1bPfbIuaZ2i9wBgtIhKnethNAIq6NJYgAWoWYXiZxmlgO9wxl9ZYYcUYPmG+IGFYXsprbDKVVwJCkT6O1L9XLqLoP57fxz4V1p8t8SEgi7JsybfvLX78nPEOgldAf8K1asoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Cloudflare Origin Certificate\"\n        title=\"\"\n        src=\"/static/55c1ec4a966bd47519ac929bf1b1a6ff/2bef9/create_certificate.png\"\n        srcset=\"/static/55c1ec4a966bd47519ac929bf1b1a6ff/6f3f2/create_certificate.png 256w,\n/static/55c1ec4a966bd47519ac929bf1b1a6ff/01e7c/create_certificate.png 512w,\n/static/55c1ec4a966bd47519ac929bf1b1a6ff/2bef9/create_certificate.png 1024w,\n/static/55c1ec4a966bd47519ac929bf1b1a6ff/73caa/create_certificate.png 1110w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Leave all settings as is and press Create button</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 924px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9c48ed80408d2d47c2cdfe445301f48f/9a1cf/result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.6875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACHklEQVR42o1Ujc6kIAz0/V9Sxay6/isCAsvOZerqt19yuRxJU6gwtJ3BzIeIZZ4xDAOstXi/33i9XrLu+wFd14kNw4j6UYv/18i0DTicExCC0VJKmKf5A3oBnuDTNEFrjW2jbRIfx1Fi7jiQGReht1UAOQiWXgnjOKBtWwHedwNjDZy1UoUxRgD2XWPTGv7wco7JZJvx8Ie7U74znCfM84LDR4n978hWE3HoGVEPN+A7JWzrKiU4dyCE+P+A2kZYo/GO4afklLCuq/RmnCa4IyDGKG25vqfveUoIIYjPuGndVsRPD6/y1nVBXdd4PB6olEJdP35Y73sMtHEUUmgkyHt/Ai7LInYRw9F3HfI8R1mUKEsloJzneYEiz6HKEkVBK6BKhX3fpYqMqVIKZPM4DgkydWN2YZG3/s24lz74cPoQTpa56IcB8zzDWickEHRdFszLCh8ph/SrX5cSvv1NSnwxGyta8/6HGGqwrht0XY/nszv793yiZ+9E8L3sYYzJ8IwA7i7AGnPfcmbx+gA90bYNmrpB0zRCUtu0EuP8jD3EU7MC6Hw83/CXlgh6PSk+vU1v9wuhJwE0ri9jD28dkoArw0trzjkphYRRk3rTcNbJM+Phb4LYc17EeLbsAXrfkL5KJjhlpJRCUeQoy1JMqQpVVcm8qtRnrWSf3vcTkG+VKf9iDTj/JP2AZ9dJ6ZeAKWYKm/3lN/aSpNnPH+sPhwjTg3rYxZ0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Cloudflare Generated Certificate Result\"\n        title=\"\"\n        src=\"/static/9c48ed80408d2d47c2cdfe445301f48f/9a1cf/result.png\"\n        srcset=\"/static/9c48ed80408d2d47c2cdfe445301f48f/6f3f2/result.png 256w,\n/static/9c48ed80408d2d47c2cdfe445301f48f/01e7c/result.png 512w,\n/static/9c48ed80408d2d47c2cdfe445301f48f/9a1cf/result.png 924w\"\n        sizes=\"(max-width: 924px) 100vw, 924px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Replace contents of <code class=\"language-text\">tls.pem</code> and <code class=\"language-text\">tls.key</code> created earlier by <strong>Origin Certificate</strong> and <strong>Private Key</strong> respecively and reload nginx</p>\n<p>And everything should work again</p>\n<blockquote>\n<p>Note that technically it is same as with self signed certificates, so if you will try to bypass cloudflare it will behave exactly the same, the only difference here is that this certificate is trusted by cloudflare out of the box</p>\n</blockquote>\n<h2>Cloudflare Strict - with Certificate Signing Request</h2>\n<p>Suppose for some reason you can not use given certs, there is another options then</p>\n<p>Firstly create private key</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># cleanup</span>\nsystemctl stop nginx\n<span class=\"token function\">rm</span> tls.*\n\n<span class=\"token comment\"># create private key and certificate signing request (csr)</span>\nopenssl req <span class=\"token parameter variable\">-new</span> <span class=\"token parameter variable\">-newkey</span> rsa:2048 <span class=\"token parameter variable\">-nodes</span> <span class=\"token parameter variable\">-keyout</span> tls.key <span class=\"token parameter variable\">-out</span> tls.csr\n<span class=\"token comment\"># Country Name (2 letter code) [AU]:UA</span>\n<span class=\"token comment\"># State or Province Name (full name) [Some-State]:Kiev</span>\n<span class=\"token comment\"># Locality Name (eg, city) []:Kiev</span>\n<span class=\"token comment\"># Organization Name (eg, company) [Internet Widgits Pty Ltd]:mac-blog.org.ua</span>\n<span class=\"token comment\"># Organizational Unit Name (eg, section) []:cf</span>\n<span class=\"token comment\"># Common Name (e.g. server FQDN or YOUR name) []:cf.mac-blog.org.ua</span>\n<span class=\"token comment\"># Email Address []:marchenko.alexandr@gmail.com</span>\n\n<span class=\"token comment\"># Please enter the following 'extra' attributes</span>\n<span class=\"token comment\"># to be sent with your certificate request</span>\n<span class=\"token comment\"># A challenge password []:</span>\n<span class=\"token comment\"># An optional company name []:</span>\n\n<span class=\"token comment\"># you can check what is inside our tls.csr like so</span>\nopenssl req <span class=\"token parameter variable\">-noout</span> <span class=\"token parameter variable\">-text</span> <span class=\"token parameter variable\">-in</span> tls.csr</code></pre></div>\n<p>Once again navigate to SSL/TLS \\ Origin Server \\ Origin Certifiacetes \\ Create Certificate</p>\n<p>But now choose \"Use my private key and CSR\" and paste contents of <code class=\"language-text\">tls.csr</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5c04cbcac29159f50408d17b0daf3182/f0811/csr.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.84375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABrElEQVR42o1T266bMBD0/39U+wtH6jvJSbgbSMzFNxKmmuWYk1aR2hUjGxnPzs4uyocIYwyCD2A451CWFcqiRF1VuF6vGMcR3nt4H/B4PA6s63rg+Xxi2zaoxQXEuJMxeNj3Pbqug9Y7uO+0hu46GHPHvMyY5lkSEdM0IQTyRKjFBqzBH4TMxEMq4kpQDYMK/hVqth6rNfyaj1w2ZoTWGsMwiAVUzewJr0mwyfNNGGKED+FQQAx9jyIvkOc5qqoSC0ierOCevr9TrYL34k+I4SBsmgZZluF0OuF8PuP8+bm/Z5kkWRYr3r0lpFfMbK2V0hgstygKAQkIdjvPC/Rdifp+xWRdqvhvwgjvnDSDQY9YVtu0qOtGyPeO72vfa7RdA3M3WJZFhHAl6LdyIeLxpSyNTV3XuFwu4t8w3HC77bB2v5TA6hzx8q7M7BC+xiZ1bjRGCOhT6jTPXjv9R9dj+J5D6+Ph3VGyZsmNDDX9bdtWyHlpV+LgvJO/i6Ayax1iXKGmxR1/SvKRk0+sMYqy1P3/CRXXVbxJZIk4kbzu3+G5bfB2xM+PBj9+3fEb5XTwuThidt8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Cloudflare creating certificate from certificate signing request\"\n        title=\"\"\n        src=\"/static/5c04cbcac29159f50408d17b0daf3182/2bef9/csr.png\"\n        srcset=\"/static/5c04cbcac29159f50408d17b0daf3182/6f3f2/csr.png 256w,\n/static/5c04cbcac29159f50408d17b0daf3182/01e7c/csr.png 512w,\n/static/5c04cbcac29159f50408d17b0daf3182/2bef9/csr.png 1024w,\n/static/5c04cbcac29159f50408d17b0daf3182/f0811/csr.png 1367w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Press create and you will get your certificate which should be saved to <code class=\"language-text\">tls.pem</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/23510f49c8ae1081d497f51599d98bf8/b5a09/result2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.109375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA+ElEQVR42pVRW26EMBDj/ufqGXoECISghbxm8nI1s6jbVvvTkawBS7EdZyKuSCmi1gqZUhjO7bCbxW53rOuKGCN672itobam+xdq0/NjDExXJDCRiglRSsG+O/gQlWdm5bgUFObv/5/gmxfTKXNFryxyKipO53UiJcJ4Uv+a6QwEjg+JpwnFxVqLeZ5hjIFzDs4dOI4XUs4YeO82SdTLexWSkU4WY7CtK+y2YZ4XmGVRcYF0ysRvxbp0KB2c5wNEpAnlyt57pJRAlJX7CzHvul8Ydz+aUK6Rc9Z0vTWEEBCC1/0snFSc7vL1mxgxNyRqyCyvP/DxeeIL6Ecix7i3w54AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"screensho\"\n        title=\"\"\n        src=\"/static/23510f49c8ae1081d497f51599d98bf8/2bef9/result2.png\"\n        srcset=\"/static/23510f49c8ae1081d497f51599d98bf8/6f3f2/result2.png 256w,\n/static/23510f49c8ae1081d497f51599d98bf8/01e7c/result2.png 512w,\n/static/23510f49c8ae1081d497f51599d98bf8/2bef9/result2.png 1024w,\n/static/23510f49c8ae1081d497f51599d98bf8/b5a09/result2.png 1360w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now you can start nginx and everything should work</p>\n<h2>CloudFlare Access or get rid of VPN</h2>\n<p>Technicaly, because of wildcard and 15 years this approach can be used for a home lab without dealing with LetsEncrypt</p>\n<p>Also we can put this certificates for Kubernetes instead of its self signed ones</p>\n<p>And even more, because of CloudFlare Access project we can restrict access without dealing with VPN, it is free up to 50 users</p>\n<p>At the very minimum all you need to do:</p>\n<ul>\n<li>restrict access only to cloudflare</li>\n<li>inside cloudflare enable access</li>\n<li>add single rule</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f95810e5b5363541e9659740747b9a21/f793b/access_rule.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.796875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACT0lEQVR42m1SzW7aQBjM41Tqqeq1SlAC7PqHHguNUSDP1EPvPfQVKvUFciUoqhSKKqVRMGBir3/Wxsb2VN/nEqU0K43sb60dz87MkRRdGKINaRg4Pz/HZDLBdDrFzc0NZrPZi7i9vcV8Psf19TWGjgMpBSzLYhwZpgXTtCCFwHA4hO8/Ik0z5HmOoigYu92OsZ/pW1mWUErhw8DBu+NTCCEbQiEN2LYFwzDgOA4eHh4QqBBhFCNJEsRJwgeDQCGKIsRxzMiyFKvVGuL9AK/fttDuGrCJUBombMuElJIVuss1Eq35sE40k242G6zXHgKlmCyJY6RaY7lcod/v4+TkGGdnZyzqyDggvL+/x3K5hOu68DYbPPo+K6S9q6srhGGIKM2QVjU8pTAYfESr1UKn02kIu0LCNE10u91/rqx1oy7RSfNMEoRKId1ucff9G2afP+HH1y8YjUYQQqDX68G2bVJosJm0SYQL14V+RrL3jMA/0RqBu4D6fYfF/CcuLi5YDHEwIYVCw/7KQRAgzbKnZIEaVVUhyzJOlt53FVCUJXw/wOV4DNOUTGYRIVWGhj0h+UXVICIi9H2fQ/E8j7/VdY2yqkCL5v5giONWm/1rUj5QGMcJirJGXjRqKAQ6qP4mXNUV79MKwwgdu49Xb05w2hZcP67Nc0Lqn95WiNICWV7ipUUqaVG1LscjWKZEr2c3xT4kVGGIPC+g04yx3W7/A/kZ6wzuyuNQKFCyzd57SLV5KrbrsmeB7yMKQ77yIej6Gz/Er7sFHGeIdrvxkBT+AZ9SF6b0HHDaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"CloudFlare example of Access Rule\"\n        title=\"\"\n        src=\"/static/f95810e5b5363541e9659740747b9a21/2bef9/access_rule.png\"\n        srcset=\"/static/f95810e5b5363541e9659740747b9a21/6f3f2/access_rule.png 256w,\n/static/f95810e5b5363541e9659740747b9a21/01e7c/access_rule.png 512w,\n/static/f95810e5b5363541e9659740747b9a21/2bef9/access_rule.png 1024w,\n/static/f95810e5b5363541e9659740747b9a21/f793b/access_rule.png 1404w\"\n        sizes=\"(max-width: 1024px) 100vw, 1024px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>And from now on if you will try to connect to your app you will see something like:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d14581ebb608ddfdcc0e86ac89b9cad6/d9199/access_in_action.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.09375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABSElEQVR42pWTy27CMBBF+b2q2wqp2/5Qu+lj1S9BakHqPkBXqQSSEZFCsENsx3k45FZjKAqohGDpKp7MzBl75OkJIfCf4jjGahVhOBrBG4/heR7CMHT/z+WQem1Ozjkmkwl838d0+o0gCK4HEqQppRSSJHFfgjV9rUAKkFKiKArkee6UZRm01geR/eejOCpyCj4CpmmK5qrrGlVVueTKWmc3FxXoDLS2bJwoc3uStfYQY4zpDqRkupImaQ2ZSGdTgauBdDWTatTbLRk7HTdjX7QrEACLEvjLNX4Cjnm4AeMajCsshIattt1OqPfA3FZ4eP/CzeMA/dch7t9G6L984vZpgLvnD6xV3g1IPaKmF2WJWBlwmUIo4/Y720BIg6IoXRz19izw9GFvYnFWnR522/jRhFwauYtAAkRRhNl8BsYYGFs4+9Is/wL6VSSsEbtSiAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"CloudFlare Acccess in action\"\n        title=\"\"\n        src=\"/static/d14581ebb608ddfdcc0e86ac89b9cad6/d9199/access_in_action.png\"\n        srcset=\"/static/d14581ebb608ddfdcc0e86ac89b9cad6/6f3f2/access_in_action.png 256w,\n/static/d14581ebb608ddfdcc0e86ac89b9cad6/01e7c/access_in_action.png 512w,\n/static/d14581ebb608ddfdcc0e86ac89b9cad6/d9199/access_in_action.png 960w\"\n        sizes=\"(max-width: 960px) 100vw, 960px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Just submit your email and you will get your TOTP token to login</p>"}},"pageContext":{"id":"ba7256ef-a501-5e1e-8adc-f1c5bb582b4e"}},"staticQueryHashes":[],"slicesMap":{}}